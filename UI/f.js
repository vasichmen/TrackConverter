window.Modernizr = function (t, e, i) {
    function a(t) {
        g.cssText = t
    }

    function o(t, e) {
        return a(W.join(t + ";") + (e || ""))
    }

    function n(t, e) {
        return typeof t === e
    }

    function s(t, e) {
        return !!~("" + t)
            .indexOf(e)
    }

    function r(t, e) {
        for (var a in t) {
            var o = t[a];
            if (!s(o, "-") && g[o] !== i) return e == "pfx" ? o : !0
        }
        return !1
    }

    function p(t, e, a) {
        for (var o in t) {
            var s = e[t[o]];
            if (s !== i) return a === !1 ? t[o] : n(s, "function") ? s.bind(a || e) : s
        }
        return !1
    }

    function l(t, e, i) {
        var a = t.charAt(0)
            .toUpperCase() + t.slice(1),
            o = (t + " " + w.join(a + " ") + a)
            .split(" ");
        return n(e, "string") || n(e, "undefined") ? r(o, e) : (o = (t + " " + C.join(a + " ") + a)
            .split(" "), p(o, e, i))
    }
    var c = "2.8.2",
        h = {},
        u = !0,
        m = e.documentElement,
        d = "modernizr",
        f = e.createElement(d),
        g = f.style,
        y, k = ":)",
        v = {}.toString,
        W = " -webkit- -moz- -o- -ms- ".split(" "),
        b = "Webkit Moz O ms",
        w = b.split(" "),
        C = b.toLowerCase()
        .split(" "),
        L = {
            svg: "http://www.w3.org/2000/svg"
        },
        S = {},
        T = {},
        E = {},
        x = [],
        I = x.slice,
        U, P = function (t, i, a, o) {
            var n, s, r, p, l = e.createElement("div"),
                c = e.body,
                h = c || e.createElement("body");
            if (parseInt(a, 10))
                while (a--) r = e.createElement("div"), r.id = o ? o[a] : d + (a + 1), l.appendChild(r);
            return n = ["&#173;", '<style id="s', d, '">', t, "</style>"].join(""), l.id = d, (c ? l : h)
                .innerHTML += n, h.appendChild(l), c || (h.style.background = "", h.style.overflow = "hidden", p = m.style.overflow, m.style.overflow = "hidden", m.appendChild(h)), s = i(l, t), c ? l.parentNode.removeChild(l) : (h.parentNode.removeChild(h), m.style.overflow = p), !!s
        },
        M = function (e) {
            var i = t.matchMedia || t.msMatchMedia;
            if (i) return i(e) && i(e)
                .matches || !1;
            var a;
            return P("@media " + e + " { #" + d + " { position: absolute; } }", function (e) {
                a = (t.getComputedStyle ? getComputedStyle(e, null) : e.currentStyle)["position"] == "absolute"
            }), a
        },
        D = function () {
            function t(t, o) {
                o = o || e.createElement(a[t] || "div"), t = "on" + t;
                var s = t in o;
                return s || (o.setAttribute || (o = e.createElement("div")), o.setAttribute && o.removeAttribute && (o.setAttribute(t, ""), s = n(o[t], "function"), n(o[t], "undefined") || (o[t] = i), o.removeAttribute(t))), o = null, s
            }
            var a = {
                select: "input",
                change: "input",
                submit: "form",
                reset: "form",
                error: "img",
                load: "img",
                abort: "img"
            };
            return t
        }(),
        O = {}.hasOwnProperty,
        _;
    !n(O, "undefined") && !n(O.call, "undefined") ? _ = function (t, e) {
        return O.call(t, e)
    } : _ = function (t, e) {
        return e in t && n(t.constructor.prototype[e], "undefined")
    }, Function.prototype.bind || (Function.prototype.bind = function (t) {
        var e = this;
        if (typeof e != "function") throw new TypeError;
        var i = I.call(arguments, 1),
            a = function () {
                if (this instanceof a) {
                    var o = function () { };
                    o.prototype = e.prototype;
                    var n = new o,
                        s = e.apply(n, i.concat(I.call(arguments)));
                    return Object(s) === s ? s : n
                }
                return e.apply(t, i.concat(I.call(arguments)))
            };
        return a
    }), S.canvas = function () {
        var t = e.createElement("canvas");
        return !!t.getContext && !!t.getContext("2d")
    }, S.touch = function () {
        var i;
        return "ontouchstart" in t || t.DocumentTouch && e instanceof DocumentTouch ? i = !0 : P(["@media (", W.join("touch-enabled),("), d, ")", "{#modernizr{top:9px;position:absolute}}"].join(""), function (t) {
            i = t.offsetTop === 9
        }), i
    }, S.geolocation = function () {
        return "geolocation" in navigator
    }, S.postmessage = function () {
        return !!t.postMessage
    }, S.hashchange = function () {
        return D("hashchange", t) && (e.documentMode === i || e.documentMode > 7)
    }, S.history = function () {
        return !!t.history && !!history.pushState
    }, S.draganddrop = function () {
        var t = e.createElement("div");
        return "draggable" in t || "ondragstart" in t && "ondrop" in t
    }, S.websockets = function () {
        return "WebSocket" in t || "MozWebSocket" in t
    }, S.rgba = function () {
        return a("background-color:rgba(150,255,150,.5)"), s(g.backgroundColor, "rgba")
    }, S.backgroundsize = function () {
        return l("backgroundSize")
    }, S.borderradius = function () {
        return l("borderRadius")
    }, S.cssanimations = function () {
        return l("animationName")
    }, S.csstransforms = function () {
        return !!l("transform")
    }, S.csstransforms3d = function () {
        var t = !!l("perspective");
        return t && "webkitPerspective" in m.style && P("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}", function (e, i) {
            t = e.offsetLeft === 9 && e.offsetHeight === 3
        }), t
    }, S.csstransitions = function () {
        return l("transition")
    }, S.fontface = function () {
        var t;
        return P('@font-face {font-family:"font";src:url("https://")}', function (i, a) {
            var o = e.getElementById("smodernizr"),
                n = o.sheet || o.styleSheet,
                s = n ? n.cssRules && n.cssRules[0] ? n.cssRules[0].cssText : n.cssText || "" : "";
            t = /src/i.test(s) && s.indexOf(a.split(" ")[0]) === 0
        }), t
    }, S.generatedcontent = function () {
        var t;
        return P(["#", d, "{font:0/0 a}#", d, ':after{content:"', k, '";visibility:hidden;font:3px/1 a}'].join(""), function (e) {
            t = e.offsetHeight >= 3
        }), t
    }, S.localstorage = function () {
        try {
            return localStorage.setItem(d, d), localStorage.removeItem(d), !0
        } catch (t) {
            return !1
        }
    }, S.sessionstorage = function () {
        try {
            return sessionStorage.setItem(d, d), sessionStorage.removeItem(d), !0
        } catch (t) {
            return !1
        }
    }, S.webworkers = function () {
        return !!t.Worker
    }, S.applicationcache = function () {
        return !!t.applicationCache
    }, S.svg = function () {
        return !!e.createElementNS && !!e.createElementNS(L.svg, "svg")
            .createSVGRect
    }, S.inlinesvg = function () {
        var t = e.createElement("div");
        return t.innerHTML = "<svg/>", (t.firstChild && t.firstChild.namespaceURI) == L.svg
    };
    for (var j in S) _(S, j) && (U = j.toLowerCase(), h[U] = S[j](), x.push((h[U] ? "" : "no-") + U));
    return h.addTest = function (t, e) {
        if (typeof t == "object")
            for (var a in t) _(t, a) && h.addTest(a, t[a]);
        else {
            t = t.toLowerCase();
            if (h[t] !== i) return h;
            e = typeof e == "function" ? e() : e, typeof u != "undefined" && u && (m.className += " wm-" + (e ? "" : "no-") + t), h[t] = e
        }
        return h
    }, a(""), f = y = null, h._version = c, h._prefixes = W, h._domPrefixes = C, h._cssomPrefixes = w, h.mq = M, h.hasEvent = D, h.testProp = function (t) {
        return r([t])
    }, h.testAllProps = l, h.testStyles = P, m.className = m.className.replace(/(^|\s)no-js(\s|$)/, "$1$2") + (u ? " wm-js wm-" + x.join(" wm-") : ""), h
}(this, this.document), Modernizr.addTest("cors", !!(window.XMLHttpRequest && "withCredentials" in new XMLHttpRequest)), Modernizr.addTest("pointerevents", function () {
    var t = document.createElement("x"),
        e = document.documentElement,
        i = window.getComputedStyle,
        a;
    return "pointerEvents" in t.style ? (t.style.pointerEvents = "auto", t.style.pointerEvents = "x", e.appendChild(t), a = i && i(t, "")
        .pointerEvents === "auto", e.removeChild(t), !!a) : !1
}), Modernizr.addTest("classlist", "classList" in document.documentElement), Modernizr.addTest("dataset", function () {
    var t = document.createElement("div");
    return t.setAttribute("data-a-b", "c"), !!t.dataset && t.dataset.aB === "c"
}), Modernizr.addTest("fullscreen", function () {
    for (var t = 0; t < Modernizr._domPrefixes.length; t++)
        if (document[Modernizr._domPrefixes[t].toLowerCase() + "CancelFullScreen"]) return !0;
    return !!document.cancelFullScreen || !1
}), Modernizr.addTest("json", !!window.JSON && !!JSON.parse),
    function () {
        var t = new Image;
        t.onerror = function () {
            Modernizr.addTest("datauri", function () {
                return !1
            })
        }, t.onload = function () {
            Modernizr.addTest("datauri", function () {
                return t.width == 1 && t.height == 1
            })
        }, t.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
    }();
if (typeof JSON !== "object") {
    JSON = {}
} (function () {
    "use strict";

    function f(t) {
        return t < 10 ? "0" + t : t
    }
    if (typeof Date.prototype.toJSON !== "function") {
        Date.prototype.toJSON = function () {
            return isFinite(this.valueOf()) ? this.getUTCFullYear() + "-" + f(this.getUTCMonth() + 1) + "-" + f(this.getUTCDate()) + "T" + f(this.getUTCHours()) + ":" + f(this.getUTCMinutes()) + ":" + f(this.getUTCSeconds()) + "Z" : null
        };
        String.prototype.toJSON = Number.prototype.toJSON = Boolean.prototype.toJSON = function () {
            return this.valueOf()
        }
    }
    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        gap, indent, meta = {
            "\b": "\\b",
            "	": "\\t",
            "\n": "\\n",
            "\f": "\\f",
            "\r": "\\r",
            '"': '\\"',
            "\\": "\\\\"
        },
        rep;

    function quote(t) {
        escapable.lastIndex = 0;
        return escapable.test(t) ? '"' + t.replace(escapable, function (t) {
            var e = meta[t];
            return typeof e === "string" ? e : "\\u" + ("0000" + t.charCodeAt(0)
                    .toString(16))
                .slice(-4)
        }) + '"' : '"' + t + '"'
    }

    function str(t, e) {
        var i, a, o, n, s = gap,
            r, p = e[t];
        if (p && typeof p === "object" && typeof p.toJSON === "function") {
            p = p.toJSON(t)
        }
        if (typeof rep === "function") {
            p = rep.call(e, t, p)
        }
        switch (typeof p) {
            case "string":
                return quote(p);
            case "number":
                return isFinite(p) ? String(p) : "null";
            case "boolean":
            case "null":
                return String(p);
            case "object":
                if (!p) {
                    return "null"
                }
                gap += indent;
                r = [];
                if (Object.prototype.toString.apply(p) === "[object Array]") {
                    n = p.length;
                    for (i = 0; i < n; i += 1) {
                        r[i] = str(i, p) || "null"
                    }
                    o = r.length === 0 ? "[]" : gap ? "[\n" + gap + r.join(",\n" + gap) + "\n" + s + "]" : "[" + r.join(",") + "]";
                    gap = s;
                    return o
                }
                if (rep && typeof rep === "object") {
                    n = rep.length;
                    for (i = 0; i < n; i += 1) {
                        if (typeof rep[i] === "string") {
                            a = rep[i];
                            o = str(a, p);
                            if (o) {
                                r.push(quote(a) + (gap ? ": " : ":") + o)
                            }
                        }
                    }
                } else {
                    for (a in p) {
                        if (Object.prototype.hasOwnProperty.call(p, a)) {
                            o = str(a, p);
                            if (o) {
                                r.push(quote(a) + (gap ? ": " : ":") + o)
                            }
                        }
                    }
                }
                o = r.length === 0 ? "{}" : gap ? "{\n" + gap + r.join(",\n" + gap) + "\n" + s + "}" : "{" + r.join(",") + "}";
                gap = s;
                return o
        }
    }
    if (typeof JSON.stringify !== "function") {
        JSON.stringify = function (t, e, i) {
            var a;
            gap = "";
            indent = "";
            if (typeof i === "number") {
                for (a = 0; a < i; a += 1) {
                    indent += " "
                }
            } else if (typeof i === "string") {
                indent = i
            }
            rep = e;
            if (e && typeof e !== "function" && (typeof e !== "object" || typeof e.length !== "number")) {
                throw new Error("JSON.stringify")
            }
            return str("", {
                "": t
            })
        }
    }
    if (typeof JSON.parse !== "function") {
        JSON.parse = function (text, reviver) {
            var j;

            function walk(t, e) {
                var i, a, o = t[e];
                if (o && typeof o === "object") {
                    for (i in o) {
                        if (Object.prototype.hasOwnProperty.call(o, i)) {
                            a = walk(o, i);
                            if (a !== undefined) {
                                o[i] = a
                            } else {
                                delete o[i]
                            }
                        }
                    }
                }
                return reviver.call(t, e, o)
            }
            text = String(text);
            cx.lastIndex = 0;
            if (cx.test(text)) {
                text = text.replace(cx, function (t) {
                    return "\\u" + ("0000" + t.charCodeAt(0)
                            .toString(16))
                        .slice(-4)
                })
            }
            if (/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, "@")
                    .replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, "]")
                    .replace(/(?:^|:|,)(?:\s*\[)+/g, ""))) {
                j = eval("(" + text + ")");
                return typeof reviver === "function" ? walk({
                    "": j
                }, "") : j
            }
            throw new SyntaxError("JSON.parse")
        }
    }
})();
(function (t, e, i) {
    var a = function () {
        var t, i, a;
        i = function () {
            this.on = function (t, e, i) {
                t.addEventListener(e, i, false)
            };
            this.off = function (t, e, i) {
                t.removeEventListener(e, i, false)
            }
        };
        a = function () {
            this.on = function (t, e, i) {
                t.attachEvent("on" + e, i)
            };
            this.off = function (t, e, i) {
                t.detachEvent("on" + e, i)
            }
        };
        t = {
            _version: "0.4.0",
            _prefix: "alertify",
            get: function (t) {
                return e.getElementById(t)
            },
            on: function (t, e, o) {
                if (typeof t.addEventListener === "function") {
                    t.addEventListener(e, o, false);
                    i.call(this)
                } else if (t.attachEvent) {
                    t.attachEvent("on" + e, o);
                    a.call(this)
                }
            },
            off: function (t, e, o) {
                if (typeof t.removeEventListener === "function") {
                    t.removeEventListener(e, o, false);
                    i.call(this)
                } else if (t.detachEvent) {
                    t.detachEvent("on" + e, o);
                    a.call(this)
                }
            }
        };
        return t
    }();
    var o = function () {
        var t = function () { };
        t.prototype = a;
        t = new t;
        return t
    }();
    var n = function () {
        var t, e;
        t = function (t, e, i) {
            var a = false;
            if (i && typeof e === "undefined") {
                a = true
            } else {
                if (t === "object") {
                    a = typeof e === "object" && !(e instanceof Array)
                } else {
                    a = typeof e === t
                }
            }
            return a
        };
        e = {
            messages: {
                invalidArguments: "Invalid arguments"
            },
            isFunction: function (e, i) {
                return t("function", e, i)
            },
            isNumber: function (e, i) {
                return t("number", e, i)
            },
            isObject: function (e, i) {
                return t("object", e, i)
            },
            isString: function (e, i) {
                return t("string", e, i)
            }
        };
        return e
    }();
    var s = function () {
        var t = {},
            i;
        i = function (t, e) {
            var i;
            if (!n.isObject(t) || !n.isObject(e, true)) {
                throw new Error(n.messages.invalidArguments)
            }
            if (typeof e !== "undefined") {
                if (e.attributes) {
                    for (i in e.attributes) {
                        if (e.attributes.hasOwnProperty(i)) {
                            t.setAttribute(i, e.attributes[i])
                        }
                    }
                }
                if (e.classes) {
                    t.className = e.classes
                }
            }
            return t
        };
        t = {
            create: function (t, a) {
                var o;
                if (!n.isString(t) || !n.isObject(a, true)) {
                    throw new Error(n.messages.invalidArguments)
                }
                o = e.createElement(t);
                o = i(o, a);
                return o
            },
            ready: function (t) {
                if (!n.isObject(t)) {
                    throw new Error(n.messages.invalidArguments)
                }
                if (t && t.scrollTop !== null) {
                    return
                } else {
                    this.ready()
                }
            }
        };
        return t
    }();
    var r = function () {
        var t;
        t = function () {
            var t, e, a = false,
                o = s.create("fakeelement"),
                n = {
                    WebkitTransition: "webkitTransitionEnd",
                    MozTransition: "transitionend",
                    OTransition: "otransitionend",
                    transition: "transitionend"
                };
            for (t in n) {
                if (o.style[t] !== i) {
                    e = n[t];
                    a = true;
                    break
                }
            }
            return {
                type: e,
                supported: a
            }
        };
        return t()
    }();
    var p = function () {
        var t = {
            ENTER: 13,
            ESC: 27,
            SPACE: 32
        };
        return t
    }();
    var l = function () {
        var t, a = {};
        var l = function () {
            var t = {},
                a = {},
                l = false,
                c = [],
                h = {},
                u = o._prefix + "-dialog",
                m = o._prefix + "-cover",
                d = u + " is-" + u + "-showing",
                f = u + " is-" + u + "-hidden",
                g = m + " is-" + m + "-showing",
                y = m + " is-" + m + "-hidden",
                k, v, W, b, w, C, L, S, T, E, x, I, U, P, M, D;
            h = {
                buttons: {
                    holder: '<nav class="alertify-buttons">{{buttons}}</nav>',
                    submit: '<button role="button" type="submit" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</button>',
                    ok: '<button role="button" type="button" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</button>',
                    cancel: '<button role="button" type="button" class="alertify-button alertify-button-cancel" id="alertify-cancel">{{cancel}}</button>'
                },
                input: '<div class="alertify-text-wrapper"><input type="text" class="alertify-text" id="alertify-text"></div>',
                message: '<p class="alertify-message">{{message}}</p>',
                log: '<article class="alertify-log{{class}}">{{message}}</article>'
            };
            b = function (i) {
                T = function (e) {
                    var a = "";
                    if (typeof e.preventDefault !== "undefined") {
                        e.preventDefault()
                    }
                    P();
                    C();
                    if (t.input) {
                        a = t.input.value
                    }
                    if (typeof i.accept === "function") {
                        if (t.input) {
                            i.accept(a)
                        } else {
                            i.accept()
                        }
                    }
                    return false
                };
                S = function (t) {
                    if (typeof t.preventDefault !== "undefined") {
                        t.preventDefault()
                    }
                    P();
                    C();
                    if (typeof i.deny === "function") {
                        i.deny()
                    }
                    return false
                };
                I = function (e) {
                    var i = e.keyCode;
                    if (i === p.SPACE && !t.input) {
                        T(e)
                    }
                    if (i === p.ESC && t.cancel) {
                        S(e)
                    }
                };
                E = function (e) {
                    if (t.input) {
                        t.input.focus()
                    } else if (t.cancel) {
                        t.cancel.focus()
                    } else {
                        t.ok.focus()
                    }
                };
                o.on(t.reset, "focus", E);
                if (t.ok) {
                    o.on(t.ok, "click", T)
                }
                if (t.cancel) {
                    o.on(t.cancel, "click", S)
                }
                o.on(e.body, "keyup", I);
                if (t.form) {
                    o.on(t.form, "submit", T)
                }
                if (!r.supported) {
                    M()
                }
            };
            W = function (t, e) {
                return a.buttonReverse ? e + t : t + e
            };
            w = function (t) {
                var e = "",
                    i = t.type,
                    o = t.message;
                e += '<div class="alertify-dialog-inner">';
                if (a.buttonFocus === "none") {
                    e += '<a href="#" id="alertify-noneFocus" class="alertify-hidden"></a>'
                }
                if (i === "prompt") {
                    e += '<form id="alertify-form">'
                }
                e += '<article class="alertify-inner">';
                e += h.message.replace("{{message}}", o);
                if (i === "prompt") {
                    e += h.input
                }
                e += h.buttons.holder;
                e += "</article>";
                if (i === "prompt") {
                    e += "</form>"
                }
                e += '<a id="alertify-resetFocus" class="alertify-resetFocus" href="#">Reset Focus</a>';
                e += "</div>";
                switch (i) {
                    case "confirm":
                        e = e.replace("{{buttons}}", W(h.buttons.cancel, h.buttons.ok));
                        e = e.replace("{{ok}}", a.labels.ok)
                            .replace("{{cancel}}", a.labels.cancel);
                        break;
                    case "prompt":
                        e = e.replace("{{buttons}}", W(h.buttons.cancel, h.buttons.submit));
                        e = e.replace("{{ok}}", a.labels.ok)
                            .replace("{{cancel}}", a.labels.cancel);
                        break;
                    case "alert":
                        e = e.replace("{{buttons}}", h.buttons.ok);
                        e = e.replace("{{ok}}", a.labels.ok);
                        break
                }
                return e
            };
            C = function () {
                var t;
                c.splice(0, 1);
                if (c.length > 0) {
                    U(true)
                } else {
                    l = false;
                    t = function (e) {
                        e.stopPropagation();
                        o.off(this, r.type, t)
                    };
                    if (r.supported) {
                        o.on(a.el, r.type, t);
                        a.el.className = f
                    } else {
                        a.el.className = f
                    }
                    a.cover.className = y;
                    k.focus()
                }
            };
            L = function () {
                var t = s.create("div", {
                    classes: y
                }),
                    i = s.create("section", {
                        classes: f
                    });
                e.body.appendChild(t);
                e.body.appendChild(i);
                s.ready(t);
                s.ready(i);
                a.cover = t;
                return i
            };
            U = function (e) {
                var n = c[0],
                    s;
                l = true;
                s = function (t) {
                    t.stopPropagation();
                    M();
                    o.off(this, r.type, s)
                };
                if (r.supported && !e) {
                    o.on(a.el, r.type, s)
                }
                a.el.innerHTML = w(n);
                a.cover.className = g;
                a.el.className = d;
                t.reset = o.get("alertify-resetFocus");
                t.ok = o.get("alertify-ok") || i;
                t.cancel = o.get("alertify-cancel") || i;
                t.focus = a.buttonFocus === "cancel" && t.cancel ? t.cancel : a.buttonFocus === "none" ? o.get("alertify-noneFocus") : t.ok, t.input = o.get("alertify-text") || i;
                t.form = o.get("alertify-form") || i;
                if (typeof n.placeholder === "string" && n.placeholder !== "") {
                    t.input.value = n.placeholder
                }
                if (e) {
                    M()
                }
                b(n)
            };
            P = function () {
                o.off(e.body, "keyup", I);
                o.off(t.reset, "focus", E);
                if (t.input) {
                    o.off(t.form, "submit", x)
                }
                if (t.ok) {
                    o.off(t.ok, "click", T)
                }
                if (t.cancel) {
                    o.off(t.cancel, "click", S)
                }
            };
            M = function () {
                if (t.input) {
                    t.input.focus();
                    t.input.select()
                } else {
                    t.focus.focus()
                }
            };
            D = function (t, i, o, s, r) {
                if (!n.isString(t) || !n.isString(i) || !n.isFunction(o, true) || !n.isFunction(s, true) || !n.isString(r, true)) {
                    throw new Error(n.messages.invalidArguments)
                }
                a.el = a.el || L();
                k = e.activeElement;
                c.push({
                    type: t,
                    message: i,
                    accept: o,
                    deny: s,
                    placeholder: r
                });
                if (!l) {
                    U()
                }
            };
            return {
                buttonFocus: "ok",
                buttonReverse: false,
                cover: i,
                el: i,
                labels: {
                    ok: "OK",
                    cancel: "Cancel"
                },
                dialogs: h,
                alert: function (t, e) {
                    a = this;
                    D("alert", t, e);
                    return this
                },
                confirm: function (t, e, i) {
                    a = this;
                    D("confirm", t, e, i);
                    return this
                },
                prompt: function (t, e, i, o) {
                    a = this;
                    D("prompt", t, e, i, o);
                    return this
                },
                hide: C,
                open: U
            }
        };
        return new l
    }();
    var c = function () {
        var t, e, i, a, p = o._prefix + "-log",
            l = p + " is-" + p + "-showing",
            c = p + " is-" + p + "-hidden";
        t = function (t, e, i, a) {
            if (!n.isObject(t) || !n.isString(e) || !n.isString(i) || !n.isNumber(a, true)) {
                throw new Error(n.messages.invalidArguments)
            }
            this.delay = typeof a !== "undefined" ? a : 5e3;
            this.msg = i;
            this.parent = t;
            this.type = e;
            this.create();
            this.show()
        };
        e = function (t) {
            t.stopPropagation();
            if (typeof this.el !== "undefined") {
                o.off(this.el, r.type, this.fn);
                i.call(this)
            }
        };
        i = function () {
            this.parent.removeChild(this.el);
            delete this.el
        };
        a = function () {
            var t = this;
            if (this.delay !== 0) {
                setTimeout(function () {
                    t.close()
                }, this.delay)
            }
        };
        t.prototype.close = function () {
            var t = this;
            if (typeof this.el !== "undefined" && this.el.parentNode === this.parent) {
                if (r.supported) {
                    this.fn = function (i) {
                        e.call(t, i)
                    };
                    o.on(this.el, r.type, this.fn);
                    this.el.className = c + " " + p + "-" + this.type
                } else {
                    i.call(this)
                }
            }
        };
        t.prototype.create = function () {
            if (typeof this.el === "undefined") {
                var t = s.create("article", {
                    classes: c + " " + p + "-" + this.type
                });
                t.innerHTML = '<span class="close">&times;</span>' + this.msg;
                this.parent.appendChild(t);
                s.ready(t);
                this.el = t
            }
        };
        t.prototype.show = function () {
            var t = this;
            if (typeof this.el === "undefined") {
                return
            }
            o.on(this.el, "click", function () {
                t.close()
            });
            this.el.className = l + " " + p + "-" + this.type;
            a.call(this)
        };
        return t
    }();
    var h = function () {
        var t, a, r, p;
        t = function () {
            var t = e.getElementById("alertify-logs-container");
            if (!t) {
                t = s.create("section", {
                    classes: o._prefix + "-logs"
                });
                e.body.appendChild(t)
            }
            s.ready(t);
            return t
        };
        a = function (e, i, a) {
            r(e, i, a);
            this.el = this.el || t();
            return new c(this.el, e, i, a)
        };
        r = function (t, e, i) {
            if (!n.isString(t) || !n.isString(e) || !n.isNumber(i, true)) {
                throw new Error(n.messages.invalidArguments)
            }
        };
        p = {
            delay: 5e3,
            el: i,
            create: function (t, e, i) {
                return a.call(this, t, e, i)
            },
            error: function (t, e) {
                return a.call(this, "error", t, e)
            },
            info: function (t, e) {
                return a.call(this, "info", t, e)
            },
            success: function (t, e) {
                return a.call(this, "success", t, e)
            }
        };
        return p
    }();
    o.dialog = l;
    o.log = h;
    window.Alertify = o
})(this, document);
(function (t, e) {
    if (typeof exports == "object") module.exports = e();
    else if (typeof define == "function" && define.amd) define(e);
    else t.Spinner = e()
})(this, function () {
    "use strict";
    var t = ["webkit", "Moz", "ms", "O"],
        e = {},
        i;

    function a(t, e) {
        var i = document.createElement(t || "div"),
            a;
        for (a in e) i[a] = e[a];
        return i
    }

    function o(t) {
        for (var e = 1, i = arguments.length; e < i; e++) t.appendChild(arguments[e]);
        return t
    }
    var n = function () {
        var t = a("style", {
            type: "text/css"
        });
        o(document.getElementsByTagName("head")[0], t);
        return t.sheet || t.styleSheet
    }();

    function s(t, a, o, s) {
        var r = ["opacity", a, ~~(t * 100), o, s].join("-"),
            p = .01 + o / s * 100,
            l = Math.max(1 - (1 - t) / a * (100 - p), t),
            c = i.substring(0, i.indexOf("Animation"))
            .toLowerCase(),
            h = c && "-" + c + "-" || "";
        if (!e[r]) {
            n.insertRule("@" + h + "keyframes " + r + "{" + "0%{opacity:" + l + "}" + p + "%{opacity:" + t + "}" + (p + .01) + "%{opacity:1}" + (p + a) % 100 + "%{opacity:" + t + "}" + "100%{opacity:" + l + "}" + "}", n.cssRules.length);
            e[r] = 1
        }
        return r
    }

    function r(e, i) {
        var a = e.style,
            o, n;
        i = i.charAt(0)
            .toUpperCase() + i.slice(1);
        for (n = 0; n < t.length; n++) {
            o = t[n] + i;
            if (a[o] !== undefined) return o
        }
        if (a[i] !== undefined) return i
    }

    function p(t, e) {
        for (var i in e) t.style[r(t, i) || i] = e[i];
        return t
    }

    function l(t) {
        for (var e = 1; e < arguments.length; e++) {
            var i = arguments[e];
            for (var a in i)
                if (t[a] === undefined) t[a] = i[a]
        }
        return t
    }

    function c(t) {
        var e = {
            x: t.offsetLeft,
            y: t.offsetTop
        };
        while (t = t.offsetParent) e.x += t.offsetLeft, e.y += t.offsetTop;
        return e
    }

    function h(t, e) {
        return typeof t == "string" ? t : t[e % t.length]
    }
    var u = {
        lines: 12,
        length: 7,
        width: 5,
        radius: 10,
        rotate: 0,
        corners: 1,
        color: "#000",
        direction: 1,
        speed: 1,
        trail: 100,
        opacity: 1 / 4,
        fps: 20,
        zIndex: 2e9,
        className: "spinner",
        top: "50%",
        left: "50%",
        position: "absolute"
    };

    function m(t) {
        this.opts = l(t || {}, m.defaults, u)
    }
    m.defaults = {};
    l(m.prototype, {
        spin: function (t) {
            this.stop();
            var e = this,
                o = e.opts,
                n = e.el = p(a(0, {
                    className: o.className
                }), {
                    position: o.position,
                    width: 0,
                    zIndex: o.zIndex
                }),
                s = o.radius + o.length + o.width;
            if (t) {
                t.insertBefore(n, t.firstChild || null);
                p(n, {
                    left: o.left,
                    top: o.top
                })
            }
            n.setAttribute("role", "progressbar");
            e.lines(n, e.opts);
            if (!i) {
                var r = 0,
                    l = (o.lines - 1) * (1 - o.direction) / 2,
                    c, h = o.fps,
                    u = h / o.speed,
                    m = (1 - o.opacity) / (u * o.trail / 100),
                    d = u / o.lines;
                (function f() {
                    r++;
                    for (var t = 0; t < o.lines; t++) {
                        c = Math.max(1 - (r + (o.lines - t) * d) % u * m, o.opacity);
                        e.opacity(n, t * o.direction + l, c, o)
                    }
                    e.timeout = e.el && setTimeout(f, ~~(1e3 / h))
                })()
            }
            return e
        },
        stop: function () {
            var t = this.el;
            if (t) {
                clearTimeout(this.timeout);
                if (t.parentNode) t.parentNode.removeChild(t);
                this.el = undefined
            }
            return this
        },
        lines: function (t, e) {
            var n = 0,
                r = (e.lines - 1) * (1 - e.direction) / 2,
                l;

            function c(t, i) {
                return p(a(), {
                    position: "absolute",
                    width: e.length + e.width + "px",
                    height: e.width + "px",
                    background: t,
                    boxShadow: i,
                    transformOrigin: "left",
                    transform: "rotate(" + ~~(360 / e.lines * n + e.rotate) + "deg) translate(" + e.radius + "px" + ",0)",
                    borderRadius: (e.corners * e.width >> 1) + "px"
                })
            }
            for (; n < e.lines; n++) {
                l = p(a(), {
                    position: "absolute",
                    top: 1 + ~(e.width / 2) + "px",
                    transform: e.hwaccel ? "translate3d(0,0,0)" : "",
                    opacity: e.opacity,
                    animation: i && s(e.opacity, e.trail, r + n * e.direction, e.lines) + " " + 1 / e.speed + "s linear infinite"
                });
                if (e.shadow) o(l, p(c("#000", "0 0 4px " + "#000"), {
                    top: 2 + "px"
                }));
                o(t, o(l, c(h(e.color, n), "0 0 1px rgba(0,0,0,.1)")))
            }
            return t
        },
        opacity: function (t, e, i) {
            if (e < t.childNodes.length) t.childNodes[e].style.opacity = i
        }
    });

    function d() {
        function t(t, e) {
            return a("<" + t + ' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">', e)
        }
        n.addRule(".spin-vml", "behavior:url(#default#VML)");
        m.prototype.lines = function (e, i) {
            var a = i.length + i.width,
                n = 2 * a;

            function s() {
                return p(t("group", {
                    coordsize: n + " " + n,
                    coordorigin: -a + " " + -a
                }), {
                    width: n,
                    height: n
                })
            }
            var r = -(i.width + i.length) * 2 + "px",
                l = p(s(), {
                    position: "absolute",
                    top: r,
                    left: r
                }),
                c;

            function u(e, n, r) {
                o(l, o(p(s(), {
                    rotation: 360 / i.lines * e + "deg",
                    left: ~~n
                }), o(p(t("roundrect", {
                    arcsize: i.corners
                }), {
                    width: a,
                    height: i.width,
                    left: i.radius,
                    top: -i.width >> 1,
                    filter: r
                }), t("fill", {
                    color: h(i.color, e),
                    opacity: i.opacity
                }), t("stroke", {
                    opacity: 0
                }))))
            }
            if (i.shadow)
                for (c = 1; c <= i.lines; c++) u(c, -2, "progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");
            for (c = 1; c <= i.lines; c++) u(c);
            return o(e, l)
        };
        m.prototype.opacity = function (t, e, i, a) {
            var o = t.firstChild;
            a = a.shadow && a.lines || 0;
            if (o && e + a < o.childNodes.length) {
                o = o.childNodes[e + a];
                o = o && o.firstChild;
                o = o && o.firstChild;
                if (o) o.opacity = i
            }
        }
    }
    var f = p(a("group"), {
        behavior: "url(#default#VML)"
    });
    if (!r(f, "transform") && f.adj) d();
    else i = r(f, "animation");
    return m
});
(function (t, e) {
    if (typeof define == "function") define(e);
    else if (typeof module != "undefined") module.exports = e();
    else this[t] = e()
})("morpheus", function () {
    var t = document,
        e = window,
        i = e.performance,
        a = i && (i.now || i.webkitNow || i.msNow || i.mozNow),
        o = a ? function () {
            return a.call(i)
        } : function () {
            return +new Date
        },
        n = false,
        s = t.documentElement,
        r = 1e3,
        p = /^rgb\(|#/,
        l = /^([+\-])=([\d\.]+)/,
        c = /^(?:[\+\-]=?)?\d+(?:\.\d+)?(%|in|cm|mm|em|ex|pt|pc|px)$/,
        h = /rotate\(((?:[+\-]=)?([\-\d\.]+))deg\)/,
        u = /scale\(((?:[+\-]=)?([\d\.]+))\)/,
        m = /skew\(((?:[+\-]=)?([\-\d\.]+))deg, ?((?:[+\-]=)?([\-\d\.]+))deg\)/,
        d = /translate\(((?:[+\-]=)?([\-\d\.]+))px, ?((?:[+\-]=)?([\-\d\.]+))px\)/,
        f = {
            lineHeight: 1,
            zoom: 1,
            zIndex: 1,
            opacity: 1,
            transform: 1
        };
    var g = function () {
        var e = t.createElement("a")
            .style,
            i = ["webkitTransform", "MozTransform", "OTransform", "msTransform", "Transform"],
            a;
        for (a = 0; a < i.length; a++) {
            if (i[a] in e) return i[a]
        }
    }();
    var y = function () {
        return typeof t.createElement("a")
            .style.opacity !== "undefined"
    }();
    var k = t.defaultView && t.defaultView.getComputedStyle ? function (e, i) {
        i = i == "transform" ? g : i;
        i = I(i);
        var a = null,
            o = t.defaultView.getComputedStyle(e, "");
        o && (a = o[i]);
        return e.style[i] || a
    } : s.currentStyle ? function (t, e) {
        e = I(e);
        if (e == "opacity") {
            var i = 100;
            try {
                i = t.filters["DXImageTransform.Microsoft.Alpha"].opacity
            } catch (a) {
                try {
                    i = t.filters("alpha")
                        .opacity
                } catch (o) { }
            }
            return i / 100
        }
        var n = t.currentStyle ? t.currentStyle[e] : null;
        return t.style[e] || n
    } : function (t, e) {
        return t.style[I(e)]
    };
    var v = function () {
        return e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.msRequestAnimationFrame || e.oRequestAnimationFrame || function (t) {
            e.setTimeout(function () {
                t(+new Date)
            }, 17)
        }
    }();
    v(function (t) {
        n = t > 1e12 != o() > 1e12
    });
    var W = [];

    function b(t, e, i) {
        if (Array.prototype.indexOf) return t.indexOf(e);
        for (i = 0; i < t.length; ++i) {
            if (t[i] === e) return i
        }
    }

    function w(t) {
        var e, i = W.length;
        if (n) t = o();
        for (e = i; e--;) {
            W[e](t)
        }
        W.length && v(w)
    }

    function C(t) {
        if (W.push(t) === 1) v(w)
    }

    function L(t) {
        var e, i = b(W, t);
        if (i >= 0) {
            e = W.slice(i + 1);
            W.length = i;
            W = W.concat(e)
        }
    }

    function S(t, e) {
        var i = {},
            a;
        if (a = t.match(h)) i.rotate = j(a[1], e ? e.rotate : null);
        if (a = t.match(u)) i.scale = j(a[1], e ? e.scale : null);
        if (a = t.match(m)) {
            i.skewx = j(a[1], e ? e.skewx : null);
            i.skewy = j(a[3], e ? e.skewy : null)
        }
        if (a = t.match(d)) {
            i.translatex = j(a[1], e ? e.translatex : null);
            i.translatey = j(a[3], e ? e.translatey : null)
        }
        return i
    }

    function T(t) {
        var e = "";
        if ("rotate" in t) e += "rotate(" + t.rotate + "deg) ";
        if ("scale" in t) e += "scale(" + t.scale + ") ";
        if ("translatex" in t) e += "translate(" + t.translatex + "px," + t.translatey + "px) ";
        if ("skewx" in t) e += "skew(" + t.skewx + "deg," + t.skewy + "deg)";
        return e
    }

    function E(t, e, i) {
        return "#" + (1 << 24 | t << 16 | e << 8 | i)
            .toString(16)
            .slice(1)
    }

    function x(t) {
        var e = t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        return (e ? E(e[1], e[2], e[3]) : t)
            .replace(/#(\w)(\w)(\w)$/, "#$1$1$2$2$3$3")
    }

    function I(t) {
        return t.replace(/-(.)/g, function (t, e) {
            return e.toUpperCase()
        })
    }

    function U(t) {
        return typeof t == "function"
    }

    function P(t) {
        return Math.sin(t * Math.PI / 2)
    }

    function M(t, e, i, a, n, s) {
        a = U(a) ? a : A.easings[a] || P;
        var p = t || r,
            l = this,
            c = s - n,
            h = o(),
            u = 0,
            m = 0;

        function d(t) {
            var o = t - h;
            if (o > p || u) {
                s = isFinite(s) ? s : 1;
                u ? m && e(s) : e(s);
                L(d);
                return i && i.apply(l)
            }
            isFinite(s) ? e(c * a(o / p) + n) : e(a(o / p))
        }
        C(d);
        return {
            stop: function (t) {
                u = 1;
                m = t;
                if (!t) i = null
            }
        }
    }

    function D(t, e) {
        var i = t.length,
            a = [],
            o, n;
        for (o = 0; o < i; ++o) {
            a[o] = [t[o][0], t[o][1]]
        }
        for (n = 1; n < i; ++n) {
            for (o = 0; o < i - n; ++o) {
                a[o][0] = (1 - e) * a[o][0] + e * a[parseInt(o + 1, 10)][0];
                a[o][1] = (1 - e) * a[o][1] + e * a[parseInt(o + 1, 10)][1]
            }
        }
        return [a[0][0], a[0][1]]
    }

    function O(t, e, i) {
        var a = [],
            o, n, s, r;
        for (o = 0; o < 6; o++) {
            s = Math.min(15, parseInt(e.charAt(o), 16));
            r = Math.min(15, parseInt(i.charAt(o), 16));
            n = Math.floor((r - s) * t + s);
            n = n > 15 ? 15 : n < 0 ? 0 : n;
            a[o] = n.toString(16)
        }
        return "#" + a.join("")
    }

    function _(t, e, i, a, o, n, s) {
        if (o == "transform") {
            s = {};
            for (var p in i[n][o]) {
                s[p] = p in a[n][o] ? Math.round(((a[n][o][p] - i[n][o][p]) * t + i[n][o][p]) * r) / r : i[n][o][p]
            }
            return s
        } else if (typeof i[n][o] == "string") {
            return O(t, i[n][o], a[n][o])
        } else {
            s = Math.round(((a[n][o] - i[n][o]) * t + i[n][o]) * r) / r;
            if (!(o in f)) s += e[n][o] || "px";
            return s
        }
    }

    function j(t, e, i, a, o) {
        return (i = l.exec(t)) ? (o = parseFloat(i[2])) && e + (i[1] == "+" ? 1 : -1) * o : parseFloat(t)
    }

    function A(t, e) {
        var i = t ? i = isFinite(t.length) ? t : [t] : [],
            a, o = e.complete,
            n = e.duration,
            s = e.easing,
            r = e.bezier,
            l = [],
            h = [],
            u = [],
            m = [],
            d, f;
        if (r) {
            d = e.left;
            f = e.top;
            delete e.right;
            delete e.bottom;
            delete e.left;
            delete e.top
        }
        for (a = i.length; a--;) {
            l[a] = {};
            h[a] = {};
            u[a] = {};
            if (r) {
                var v = k(i[a], "left"),
                    W = k(i[a], "top"),
                    b = [j(U(d) ? d(i[a]) : d || 0, parseFloat(v)), j(U(f) ? f(i[a]) : f || 0, parseFloat(W))];
                m[a] = U(r) ? r(i[a], b) : r;
                m[a].push(b);
                m[a].unshift([parseInt(v, 10), parseInt(W, 10)])
            }
            for (var w in e) {
                switch (w) {
                    case "complete":
                    case "duration":
                    case "easing":
                    case "bezier":
                        continue
                }
                var C = k(i[a], w),
                    L, E = U(e[w]) ? e[w](i[a]) : e[w];
                if (typeof E == "string" && p.test(E) && !p.test(C)) {
                    delete e[w];
                    continue
                }
                l[a][w] = w == "transform" ? S(C) : typeof E == "string" && p.test(E) ? x(C)
                    .slice(1) : parseFloat(C);
                h[a][w] = w == "transform" ? S(E, l[a][w]) : typeof E == "string" && E.charAt(0) == "#" ? x(E)
                    .slice(1) : j(E, parseFloat(C));
                typeof E == "string" && (L = E.match(c)) && (u[a][w] = L[1])
            }
        }
        return M.apply(i, [n, function (t, o, n) {
            for (a = i.length; a--;) {
                if (r) {
                    n = D(m[a], t);
                    i[a].style.left = n[0] + "px";
                    i[a].style.top = n[1] + "px"
                }
                for (var s in e) {
                    o = _(t, u, l, h, s, a);
                    s == "transform" ? i[a].style[g] = T(o) : s == "opacity" && !y ? i[a].style.filter = "alpha(opacity=" + o * 100 + ")" : i[a].style[I(s)] = o
                }
            }
        }, o, s])
    }
    A.tween = M;
    A.getStyle = k;
    A.bezier = D;
    A.transform = g;
    A.parseTransform = S;
    A.formatTransform = T;
    A.easings = {};
    return A
});
var io = "undefined" === typeof module ? {} : module.exports;
(function () {
    (function (t, e) {
        var i = t;
        i.version = "0.9.16";
        i.protocol = 1;
        i.transports = [];
        i.j = [];
        i.sockets = {};
        i.connect = function (t, a) {
            var o = i.util.parseUri(t),
                n, s;
            if (e && e.location) {
                o.protocol = o.protocol || e.location.protocol.slice(0, -1);
                o.host = o.host || (e.document ? e.document.domain : e.location.hostname);
                o.port = o.port || e.location.port
            }
            n = i.util.uniqueUri(o);
            var r = {
                host: o.host,
                secure: "https" == o.protocol,
                port: o.port || ("https" == o.protocol ? 443 : 80),
                query: o.query || ""
            };
            i.util.merge(r, a);
            if (r["force new connection"] || !i.sockets[n]) {
                s = new i.Socket(r)
            }
            if (!r["force new connection"] && s) {
                i.sockets[n] = s
            }
            s = s || i.sockets[n];
            return s.of(o.path.length > 1 ? o.path : "")
        }
    })("object" === typeof module ? module.exports : this.io = {}, this);
    (function (t, e) {
        var i = t.util = {};
        var a = /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;
        var o = ["source", "protocol", "authority", "userInfo", "user", "password", "host", "port", "relative", "path", "directory", "file", "query", "anchor"];
        i.parseUri = function (t) {
            var e = a.exec(t || ""),
                i = {},
                n = 14;
            while (n--) {
                i[o[n]] = e[n] || ""
            }
            return i
        };
        i.uniqueUri = function (t) {
            var i = t.protocol,
                a = t.host,
                o = t.port;
            if ("document" in e) {
                a = a || document.domain;
                o = o || (i == "https" && document.location.protocol !== "https:" ? 443 : document.location.port)
            } else {
                a = a || "localhost";
                if (!o && i == "https") {
                    o = 443
                }
            }
            return (i || "http") + "://" + a + ":" + (o || 80)
        };
        i.query = function (t, e) {
            var a = i.chunkQuery(t || ""),
                o = [];
            i.merge(a, i.chunkQuery(e || ""));
            for (var n in a) {
                if (a.hasOwnProperty(n)) {
                    o.push(n + "=" + a[n])
                }
            }
            return o.length ? "?" + o.join("&") : ""
        };
        i.chunkQuery = function (t) {
            var e = {},
                i = t.split("&"),
                a = 0,
                o = i.length,
                n;
            for (; a < o; ++a) {
                n = i[a].split("=");
                if (n[0]) {
                    e[n[0]] = n[1]
                }
            }
            return e
        };
        var n = false;
        i.load = function (t) {
            if ("document" in e && document.readyState === "complete" || n) {
                return t()
            }
            i.on(e, "load", t, false)
        };
        i.on = function (t, e, i, a) {
            if (t.attachEvent) {
                t.attachEvent("on" + e, i)
            } else if (t.addEventListener) {
                t.addEventListener(e, i, a)
            }
        };
        i.request = function (t) {
            if (t && "undefined" != typeof XDomainRequest && !i.ua.hasCORS) {
                return new XDomainRequest
            }
            if ("undefined" != typeof XMLHttpRequest && (!t || i.ua.hasCORS)) {
                return new XMLHttpRequest
            }
            if (!t) {
                try {
                    return new (window[["Active"].concat("Object")
                        .join("X")])("Microsoft.XMLHTTP")
                } catch (e) { }
            }
            return null
        };
        if ("undefined" != typeof window) {
            i.load(function () {
                n = true
            })
        }
        i.defer = function (t) {
            if (!i.ua.webkit || "undefined" != typeof importScripts) {
                return t()
            }
            i.load(function () {
                setTimeout(t, 100)
            })
        };
        i.merge = function s(t, e, a, o) {
            var n = o || [],
                s = typeof a == "undefined" ? 2 : a,
                r;
            for (r in e) {
                if (e.hasOwnProperty(r) && i.indexOf(n, r) < 0) {
                    if (typeof t[r] !== "object" || !s) {
                        t[r] = e[r];
                        n.push(e[r])
                    } else {
                        i.merge(t[r], e[r], s - 1, n)
                    }
                }
            }
            return t
        };
        i.mixin = function (t, e) {
            i.merge(t.prototype, e.prototype)
        };
        i.inherit = function (t, e) {
            function i() { }
            i.prototype = e.prototype;
            t.prototype = new i
        };
        i.isArray = Array.isArray || function (t) {
            return Object.prototype.toString.call(t) === "[object Array]"
        };
        i.intersect = function (t, e) {
            var a = [],
                o = t.length > e.length ? t : e,
                n = t.length > e.length ? e : t;
            for (var s = 0, r = n.length; s < r; s++) {
                if (~i.indexOf(o, n[s])) a.push(n[s])
            }
            return a
        };
        i.indexOf = function (t, e, i) {
            for (var a = t.length, i = i < 0 ? i + a < 0 ? 0 : i + a : i || 0; i < a && t[i] !== e; i++) { }
            return a <= i ? -1 : i
        };
        i.toArray = function (t) {
            var e = [];
            for (var i = 0, a = t.length; i < a; i++) e.push(t[i]);
            return e
        };
        i.ua = {};
        i.ua.hasCORS = "undefined" != typeof XMLHttpRequest && function () {
            try {
                var t = new XMLHttpRequest
            } catch (e) {
                return false
            }
            return t.withCredentials != undefined
        }();
        i.ua.webkit = "undefined" != typeof navigator && /webkit/i.test(navigator.userAgent);
        i.ua.iDevice = "undefined" != typeof navigator && /iPad|iPhone|iPod/i.test(navigator.userAgent)
    })("undefined" != typeof io ? io : module.exports, this);
    (function (t, e) {
        t.EventEmitter = i;

        function i() { }
        i.prototype.on = function (t, i) {
            if (!this.$events) {
                this.$events = {}
            }
            if (!this.$events[t]) {
                this.$events[t] = i
            } else if (e.util.isArray(this.$events[t])) {
                this.$events[t].push(i)
            } else {
                this.$events[t] = [this.$events[t], i]
            }
            return this
        };
        i.prototype.addListener = i.prototype.on;
        i.prototype.once = function (t, e) {
            var i = this;

            function a() {
                i.removeListener(t, a);
                e.apply(this, arguments)
            }
            a.listener = e;
            this.on(t, a);
            return this
        };
        i.prototype.removeListener = function (t, i) {
            if (this.$events && this.$events[t]) {
                var a = this.$events[t];
                if (e.util.isArray(a)) {
                    var o = -1;
                    for (var n = 0, s = a.length; n < s; n++) {
                        if (a[n] === i || a[n].listener && a[n].listener === i) {
                            o = n;
                            break
                        }
                    }
                    if (o < 0) {
                        return this
                    }
                    a.splice(o, 1);
                    if (!a.length) {
                        delete this.$events[t]
                    }
                } else if (a === i || a.listener && a.listener === i) {
                    delete this.$events[t]
                }
            }
            return this
        };
        i.prototype.removeAllListeners = function (t) {
            if (t === undefined) {
                this.$events = {};
                return this
            }
            if (this.$events && this.$events[t]) {
                this.$events[t] = null
            }
            return this
        };
        i.prototype.listeners = function (t) {
            if (!this.$events) {
                this.$events = {}
            }
            if (!this.$events[t]) {
                this.$events[t] = []
            }
            if (!e.util.isArray(this.$events[t])) {
                this.$events[t] = [this.$events[t]]
            }
            return this.$events[t]
        };
        i.prototype.emit = function (t) {
            if (!this.$events) {
                return false
            }
            var i = this.$events[t];
            if (!i) {
                return false
            }
            var a = Array.prototype.slice.call(arguments, 1);
            if ("function" == typeof i) {
                i.apply(this, a)
            } else if (e.util.isArray(i)) {
                var o = i.slice();
                for (var n = 0, s = o.length; n < s; n++) {
                    o[n].apply(this, a)
                }
            } else {
                return false
            }
            return true
        }
    })("undefined" != typeof io ? io : module.exports, "undefined" != typeof io ? io : module.parent.exports);
    (function (exports, nativeJSON) {
        "use strict";
        if (nativeJSON && nativeJSON.parse) {
            return exports.JSON = {
                parse: nativeJSON.parse,
                stringify: nativeJSON.stringify
            }
        }
        var JSON = exports.JSON = {};

        function f(t) {
            return t < 10 ? "0" + t : t
        }

        function date(t, e) {
            return isFinite(t.valueOf()) ? t.getUTCFullYear() + "-" + f(t.getUTCMonth() + 1) + "-" + f(t.getUTCDate()) + "T" + f(t.getUTCHours()) + ":" + f(t.getUTCMinutes()) + ":" + f(t.getUTCSeconds()) + "Z" : null
        }
        var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
            escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
            gap, indent, meta = {
                "\b": "\\b",
                "	": "\\t",
                "\n": "\\n",
                "\f": "\\f",
                "\r": "\\r",
                '"': '\\"',
                "\\": "\\\\"
            },
            rep;

        function quote(t) {
            escapable.lastIndex = 0;
            return escapable.test(t) ? '"' + t.replace(escapable, function (t) {
                var e = meta[t];
                return typeof e === "string" ? e : "\\u" + ("0000" + t.charCodeAt(0)
                        .toString(16))
                    .slice(-4)
            }) + '"' : '"' + t + '"'
        }

        function str(t, e) {
            var i, a, o, n, s = gap,
                r, p = e[t];
            if (p instanceof Date) {
                p = date(t)
            }
            if (typeof rep === "function") {
                p = rep.call(e, t, p)
            }
            switch (typeof p) {
                case "string":
                    return quote(p);
                case "number":
                    return isFinite(p) ? String(p) : "null";
                case "boolean":
                case "null":
                    return String(p);
                case "object":
                    if (!p) {
                        return "null"
                    }
                    gap += indent;
                    r = [];
                    if (Object.prototype.toString.apply(p) === "[object Array]") {
                        n = p.length;
                        for (i = 0; i < n; i += 1) {
                            r[i] = str(i, p) || "null"
                        }
                        o = r.length === 0 ? "[]" : gap ? "[\n" + gap + r.join(",\n" + gap) + "\n" + s + "]" : "[" + r.join(",") + "]";
                        gap = s;
                        return o
                    }
                    if (rep && typeof rep === "object") {
                        n = rep.length;
                        for (i = 0; i < n; i += 1) {
                            if (typeof rep[i] === "string") {
                                a = rep[i];
                                o = str(a, p);
                                if (o) {
                                    r.push(quote(a) + (gap ? ": " : ":") + o)
                                }
                            }
                        }
                    } else {
                        for (a in p) {
                            if (Object.prototype.hasOwnProperty.call(p, a)) {
                                o = str(a, p);
                                if (o) {
                                    r.push(quote(a) + (gap ? ": " : ":") + o)
                                }
                            }
                        }
                    }
                    o = r.length === 0 ? "{}" : gap ? "{\n" + gap + r.join(",\n" + gap) + "\n" + s + "}" : "{" + r.join(",") + "}";
                    gap = s;
                    return o
            }
        }
        JSON.stringify = function (t, e, i) {
            var a;
            gap = "";
            indent = "";
            if (typeof i === "number") {
                for (a = 0; a < i; a += 1) {
                    indent += " "
                }
            } else if (typeof i === "string") {
                indent = i
            }
            rep = e;
            if (e && typeof e !== "function" && (typeof e !== "object" || typeof e.length !== "number")) {
                throw new Error("JSON.stringify")
            }
            return str("", {
                "": t
            })
        };
        JSON.parse = function (text, reviver) {
            var j;

            function walk(t, e) {
                var i, a, o = t[e];
                if (o && typeof o === "object") {
                    for (i in o) {
                        if (Object.prototype.hasOwnProperty.call(o, i)) {
                            a = walk(o, i);
                            if (a !== undefined) {
                                o[i] = a
                            } else {
                                delete o[i]
                            }
                        }
                    }
                }
                return reviver.call(t, e, o)
            }
            text = String(text);
            cx.lastIndex = 0;
            if (cx.test(text)) {
                text = text.replace(cx, function (t) {
                    return "\\u" + ("0000" + t.charCodeAt(0)
                            .toString(16))
                        .slice(-4)
                })
            }
            if (/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, "@")
                    .replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, "]")
                    .replace(/(?:^|:|,)(?:\s*\[)+/g, ""))) {
                j = eval("(" + text + ")");
                return typeof reviver === "function" ? walk({
                    "": j
                }, "") : j
            }
            throw new SyntaxError("JSON.parse")
        }
    })("undefined" != typeof io ? io : module.exports, typeof JSON !== "undefined" ? JSON : undefined);
    (function (t, e) {
        var i = t.parser = {};
        var a = i.packets = ["disconnect", "connect", "heartbeat", "message", "json", "event", "ack", "error", "noop"];
        var o = i.reasons = ["transport not supported", "client not handshaken", "unauthorized"];
        var n = i.advice = ["reconnect"];
        var s = e.JSON,
            r = e.util.indexOf;
        i.encodePacket = function (t) {
            var e = r(a, t.type),
                i = t.id || "",
                p = t.endpoint || "",
                l = t.ack,
                c = null;
            switch (t.type) {
                case "error":
                    var h = t.reason ? r(o, t.reason) : "",
                        u = t.advice ? r(n, t.advice) : "";
                    if (h !== "" || u !== "") c = h + (u !== "" ? "+" + u : "");
                    break;
                case "message":
                    if (t.data !== "") c = t.data;
                    break;
                case "event":
                    var m = {
                        name: t.name
                    };
                    if (t.args && t.args.length) {
                        m.args = t.args
                    }
                    c = s.stringify(m);
                    break;
                case "json":
                    c = s.stringify(t.data);
                    break;
                case "connect":
                    if (t.qs) c = t.qs;
                    break;
                case "ack":
                    c = t.ackId + (t.args && t.args.length ? "+" + s.stringify(t.args) : "");
                    break
            }
            var d = [e, i + (l == "data" ? "+" : ""), p];
            if (c !== null && c !== undefined) d.push(c);
            return d.join(":")
        };
        i.encodePayload = function (t) {
            var e = "";
            if (t.length == 1) return t[0];
            for (var i = 0, a = t.length; i < a; i++) {
                var o = t[i];
                e += "�" + o.length + "�" + t[i]
            }
            return e
        };
        var p = /([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;
        i.decodePacket = function (t) {
            var e = t.match(p);
            if (!e) return {};
            var i = e[2] || "",
                t = e[5] || "",
                r = {
                    type: a[e[1]],
                    endpoint: e[4] || ""
                };
            if (i) {
                r.id = i;
                if (e[3]) r.ack = "data";
                else r.ack = true
            }
            switch (r.type) {
                case "error":
                    var e = t.split("+");
                    r.reason = o[e[0]] || "";
                    r.advice = n[e[1]] || "";
                    break;
                case "message":
                    r.data = t || "";
                    break;
                case "event":
                    try {
                        var l = s.parse(t);
                        r.name = l.name;
                        r.args = l.args
                    } catch (c) { }
                    r.args = r.args || [];
                    break;
                case "json":
                    try {
                        r.data = s.parse(t)
                    } catch (c) { }
                    break;
                case "connect":
                    r.qs = t || "";
                    break;
                case "ack":
                    var e = t.match(/^([0-9]+)(\+)?(.*)/);
                    if (e) {
                        r.ackId = e[1];
                        r.args = [];
                        if (e[3]) {
                            try {
                                r.args = e[3] ? s.parse(e[3]) : []
                            } catch (c) { }
                        }
                    }
                    break;
                case "disconnect":
                case "heartbeat":
                    break
            }
            return r
        };
        i.decodePayload = function (t) {
            if (t.charAt(0) == "�") {
                var e = [];
                for (var a = 1, o = ""; a < t.length; a++) {
                    if (t.charAt(a) == "�") {
                        e.push(i.decodePacket(t.substr(a + 1)
                            .substr(0, o)));
                        a += Number(o) + 1;
                        o = ""
                    } else {
                        o += t.charAt(a)
                    }
                }
                return e
            } else {
                return [i.decodePacket(t)]
            }
        }
    })("undefined" != typeof io ? io : module.exports, "undefined" != typeof io ? io : module.parent.exports);
    (function (t, e) {
        t.Transport = i;

        function i(t, e) {
            this.socket = t;
            this.sessid = e
        }
        e.util.mixin(i, e.EventEmitter);
        i.prototype.heartbeats = function () {
            return true
        };
        i.prototype.onData = function (t) {
            this.clearCloseTimeout();
            if (this.socket.connected || this.socket.connecting || this.socket.reconnecting) {
                this.setCloseTimeout()
            }
            if (t !== "") {
                var i = e.parser.decodePayload(t);
                if (i && i.length) {
                    for (var a = 0, o = i.length; a < o; a++) {
                        this.onPacket(i[a])
                    }
                }
            }
            return this
        };
        i.prototype.onPacket = function (t) {
            this.socket.setHeartbeatTimeout();
            if (t.type == "heartbeat") {
                return this.onHeartbeat()
            }
            if (t.type == "connect" && t.endpoint == "") {
                this.onConnect()
            }
            if (t.type == "error" && t.advice == "reconnect") {
                this.isOpen = false
            }
            this.socket.onPacket(t);
            return this
        };
        i.prototype.setCloseTimeout = function () {
            if (!this.closeTimeout) {
                var t = this;
                this.closeTimeout = setTimeout(function () {
                    t.onDisconnect()
                }, this.socket.closeTimeout)
            }
        };
        i.prototype.onDisconnect = function () {
            if (this.isOpen) this.close();
            this.clearTimeouts();
            this.socket.onDisconnect();
            return this
        };
        i.prototype.onConnect = function () {
            this.socket.onConnect();
            return this
        };
        i.prototype.clearCloseTimeout = function () {
            if (this.closeTimeout) {
                clearTimeout(this.closeTimeout);
                this.closeTimeout = null
            }
        };
        i.prototype.clearTimeouts = function () {
            this.clearCloseTimeout();
            if (this.reopenTimeout) {
                clearTimeout(this.reopenTimeout)
            }
        };
        i.prototype.packet = function (t) {
            this.send(e.parser.encodePacket(t))
        };
        i.prototype.onHeartbeat = function (t) {
            this.packet({
                type: "heartbeat"
            })
        };
        i.prototype.onOpen = function () {
            this.isOpen = true;
            this.clearCloseTimeout();
            this.socket.onOpen()
        };
        i.prototype.onClose = function () {
            var t = this;
            this.isOpen = false;
            this.socket.onClose();
            this.onDisconnect()
        };
        i.prototype.prepareUrl = function () {
            var t = this.socket.options;
            return this.scheme() + "://" + t.host + ":" + t.port + "/" + t.resource + "/" + e.protocol + "/" + this.name + "/" + this.sessid
        };
        i.prototype.ready = function (t, e) {
            e.call(this)
        }
    })("undefined" != typeof io ? io : module.exports, "undefined" != typeof io ? io : module.parent.exports);
    (function (t, e, i) {
        t.Socket = a;

        function a(t) {
            this.options = {
                port: 80,
                secure: false,
                document: "document" in i ? document : false,
                resource: "socket.io",
                transports: e.transports,
                "connect timeout": 1e4,
                "try multiple transports": true,
                reconnect: true,
                "reconnection delay": 500,
                "reconnection limit": Infinity,
                "reopen delay": 3e3,
                "max reconnection attempts": 10,
                "sync disconnect on unload": false,
                "auto connect": true,
                "flash policy port": 10843,
                manualFlush: false
            };
            e.util.merge(this.options, t);
            this.connected = false;
            this.open = false;
            this.connecting = false;
            this.reconnecting = false;
            this.namespaces = {};
            this.buffer = [];
            this.doBuffer = false;
            if (this.options["sync disconnect on unload"] && (!this.isXDomain() || e.util.ua.hasCORS)) {
                var a = this;
                e.util.on(i, "beforeunload", function () {
                    a.disconnectSync()
                }, false)
            }
            if (this.options["auto connect"]) {
                this.connect()
            }
        }
        e.util.mixin(a, e.EventEmitter);
        a.prototype.of = function (t) {
            if (!this.namespaces[t]) {
                this.namespaces[t] = new e.SocketNamespace(this, t);
                if (t !== "") {
                    this.namespaces[t].packet({
                        type: "connect"
                    })
                }
            }
            return this.namespaces[t]
        };
        a.prototype.publish = function () {
            this.emit.apply(this, arguments);
            var t;
            for (var e in this.namespaces) {
                if (this.namespaces.hasOwnProperty(e)) {
                    t = this.of(e);
                    t.$emit.apply(t, arguments)
                }
            }
        };

        function o() { }
        a.prototype.handshake = function (t) {
            var i = this,
                a = this.options;

            function n(e) {
                if (e instanceof Error) {
                    i.connecting = false;
                    i.onError(e.message)
                } else {
                    t.apply(null, e.split(":"))
                }
            }
            var s = ["http" + (a.secure ? "s" : "") + ":/", a.host + ":" + a.port, a.resource, e.protocol, e.util.query(this.options.query, "t=" + +new Date)].join("/");
            if (this.isXDomain() && !e.util.ua.hasCORS) {
                var r = document.getElementsByTagName("script")[0],
                    p = document.createElement("script");
                p.src = s + "&jsonp=" + e.j.length;
                r.parentNode.insertBefore(p, r);
                e.j.push(function (t) {
                    n(t);
                    p.parentNode.removeChild(p)
                })
            } else {
                var l = e.util.request();
                l.open("GET", s, true);
                if (this.isXDomain()) {
                    l.withCredentials = true
                }
                l.onreadystatechange = function () {
                    if (l.readyState == 4) {
                        l.onreadystatechange = o;
                        if (l.status == 200) {
                            n(l.responseText)
                        } else if (l.status == 403) {
                            i.onError(l.responseText)
                        } else {
                            i.connecting = false;
                            !i.reconnecting && i.onError(l.responseText)
                        }
                    }
                };
                l.send(null)
            }
        };
        a.prototype.getTransport = function (t) {
            var i = t || this.transports,
                a;
            for (var o = 0, n; n = i[o]; o++) {
                if (e.Transport[n] && e.Transport[n].check(this) && (!this.isXDomain() || e.Transport[n].xdomainCheck(this))) {
                    return new e.Transport[n](this, this.sessionid)
                }
            }
            return null
        };
        a.prototype.connect = function (t) {
            if (this.connecting) {
                return this
            }
            var i = this;
            i.connecting = true;
            this.handshake(function (a, o, n, s) {
                i.sessionid = a;
                i.closeTimeout = n * 1e3;
                i.heartbeatTimeout = o * 1e3;
                if (!i.transports) i.transports = i.origTransports = s ? e.util.intersect(s.split(","), i.options.transports) : i.options.transports;
                i.setHeartbeatTimeout();

                function r(t) {
                    if (i.transport) i.transport.clearTimeouts();
                    i.transport = i.getTransport(t);
                    if (!i.transport) return i.publish("connect_failed");
                    i.transport.ready(i, function () {
                        i.connecting = true;
                        i.publish("connecting", i.transport.name);
                        i.transport.open();
                        if (i.options["connect timeout"]) {
                            i.connectTimeoutTimer = setTimeout(function () {
                                if (!i.connected) {
                                    i.connecting = false;
                                    if (i.options["try multiple transports"]) {
                                        var t = i.transports;
                                        while (t.length > 0 && t.splice(0, 1)[0] != i.transport.name) { }
                                        if (t.length) {
                                            r(t)
                                        } else {
                                            i.publish("connect_failed")
                                        }
                                    }
                                }
                            }, i.options["connect timeout"])
                        }
                    })
                }
                r(i.transports);
                i.once("connect", function () {
                    clearTimeout(i.connectTimeoutTimer);
                    t && typeof t == "function" && t()
                })
            });
            return this
        };
        a.prototype.setHeartbeatTimeout = function () {
            clearTimeout(this.heartbeatTimeoutTimer);
            if (this.transport && !this.transport.heartbeats()) return;
            var t = this;
            this.heartbeatTimeoutTimer = setTimeout(function () {
                t.transport.onClose()
            }, this.heartbeatTimeout)
        };
        a.prototype.packet = function (t) {
            if (this.connected && !this.doBuffer) {
                this.transport.packet(t)
            } else {
                this.buffer.push(t)
            }
            return this
        };
        a.prototype.setBuffer = function (t) {
            this.doBuffer = t;
            if (!t && this.connected && this.buffer.length) {
                if (!this.options["manualFlush"]) {
                    this.flushBuffer()
                }
            }
        };
        a.prototype.flushBuffer = function () {
            this.transport.payload(this.buffer);
            this.buffer = []
        };
        a.prototype.disconnect = function () {
            if (this.connected || this.connecting) {
                if (this.open) {
                    this.of("")
                        .packet({
                            type: "disconnect"
                        })
                }
                this.onDisconnect("booted")
            }
            return this
        };
        a.prototype.disconnectSync = function () {
            var t = e.util.request();
            var i = ["http" + (this.options.secure ? "s" : "") + ":/", this.options.host + ":" + this.options.port, this.options.resource, e.protocol, "", this.sessionid].join("/") + "/?disconnect=1";
            t.open("GET", i, false);
            t.send(null);
            this.onDisconnect("booted")
        };
        a.prototype.isXDomain = function () {
            var t = i.location.port || ("https:" == i.location.protocol ? 443 : 80);
            return this.options.host !== i.location.hostname || this.options.port != t
        };
        a.prototype.onConnect = function () {
            if (!this.connected) {
                this.connected = true;
                this.connecting = false;
                if (!this.doBuffer) {
                    this.setBuffer(false)
                }
                this.emit("connect")
            }
        };
        a.prototype.onOpen = function () {
            this.open = true
        };
        a.prototype.onClose = function () {
            this.open = false;
            clearTimeout(this.heartbeatTimeoutTimer)
        };
        a.prototype.onPacket = function (t) {
            this.of(t.endpoint)
                .onPacket(t)
        };
        a.prototype.onError = function (t) {
            if (t && t.advice) {
                if (t.advice === "reconnect" && (this.connected || this.connecting)) {
                    this.disconnect();
                    if (this.options.reconnect) {
                        this.reconnect()
                    }
                }
            }
            this.publish("error", t && t.reason ? t.reason : t)
        };
        a.prototype.onDisconnect = function (t) {
            var e = this.connected,
                i = this.connecting;
            this.connected = false;
            this.connecting = false;
            this.open = false;
            if (e || i) {
                this.transport.close();
                this.transport.clearTimeouts();
                if (e) {
                    this.publish("disconnect", t);
                    if ("booted" != t && this.options.reconnect && !this.reconnecting) {
                        this.reconnect()
                    }
                }
            }
        };
        a.prototype.reconnect = function () {
            this.reconnecting = true;
            this.reconnectionAttempts = 0;
            this.reconnectionDelay = this.options["reconnection delay"];
            var t = this,
                e = this.options["max reconnection attempts"],
                i = this.options["try multiple transports"],
                a = this.options["reconnection limit"];

            function o() {
                if (t.connected) {
                    for (var e in t.namespaces) {
                        if (t.namespaces.hasOwnProperty(e) && "" !== e) {
                            t.namespaces[e].packet({
                                type: "connect"
                            })
                        }
                    }
                    t.publish("reconnect", t.transport.name, t.reconnectionAttempts)
                }
                clearTimeout(t.reconnectionTimer);
                t.removeListener("connect_failed", n);
                t.removeListener("connect", n);
                t.reconnecting = false;
                delete t.reconnectionAttempts;
                delete t.reconnectionDelay;
                delete t.reconnectionTimer;
                delete t.redoTransports;
                t.options["try multiple transports"] = i
            }

            function n() {
                if (!t.reconnecting) {
                    return
                }
                if (t.connected) {
                    return o()
                }
                if (t.connecting && t.reconnecting) {
                    return t.reconnectionTimer = setTimeout(n, 1e3)
                }
                if (t.reconnectionAttempts++ >= e) {
                    if (!t.redoTransports) {
                        t.on("connect_failed", n);
                        t.options["try multiple transports"] = true;
                        t.transports = t.origTransports;
                        t.transport = t.getTransport();
                        t.redoTransports = true;
                        t.connect()
                    } else {
                        t.publish("reconnect_failed");
                        o()
                    }
                } else {
                    if (t.reconnectionDelay < a) {
                        t.reconnectionDelay *= 2
                    }
                    t.connect();
                    t.publish("reconnecting", t.reconnectionDelay, t.reconnectionAttempts);
                    t.reconnectionTimer = setTimeout(n, t.reconnectionDelay)
                }
            }
            this.options["try multiple transports"] = false;
            this.reconnectionTimer = setTimeout(n, this.reconnectionDelay);
            this.on("connect", n)
        }
    })("undefined" != typeof io ? io : module.exports, "undefined" != typeof io ? io : module.parent.exports, this);
    (function (t, e) {
        t.SocketNamespace = i;

        function i(t, e) {
            this.socket = t;
            this.name = e || "";
            this.flags = {};
            this.json = new a(this, "json");
            this.ackPackets = 0;
            this.acks = {}
        }
        e.util.mixin(i, e.EventEmitter);
        i.prototype.$emit = e.EventEmitter.prototype.emit;
        i.prototype.of = function () {
            return this.socket.of.apply(this.socket, arguments)
        };
        i.prototype.packet = function (t) {
            t.endpoint = this.name;
            this.socket.packet(t);
            this.flags = {};
            return this
        };
        i.prototype.send = function (t, e) {
            var i = {
                type: this.flags.json ? "json" : "message",
                data: t
            };
            if ("function" == typeof e) {
                i.id = ++this.ackPackets;
                i.ack = true;
                this.acks[i.id] = e
            }
            return this.packet(i)
        };
        i.prototype.emit = function (t) {
            var e = Array.prototype.slice.call(arguments, 1),
                i = e[e.length - 1],
                a = {
                    type: "event",
                    name: t
                };
            if ("function" == typeof i) {
                a.id = ++this.ackPackets;
                a.ack = "data";
                this.acks[a.id] = i;
                e = e.slice(0, e.length - 1)
            }
            a.args = e;
            return this.packet(a)
        };
        i.prototype.disconnect = function () {
            if (this.name === "") {
                this.socket.disconnect()
            } else {
                this.packet({
                    type: "disconnect"
                });
                this.$emit("disconnect")
            }
            return this
        };
        i.prototype.onPacket = function (t) {
            var i = this;

            function a() {
                i.packet({
                    type: "ack",
                    args: e.util.toArray(arguments),
                    ackId: t.id
                })
            }
            switch (t.type) {
                case "connect":
                    this.$emit("connect");
                    break;
                case "disconnect":
                    if (this.name === "") {
                        this.socket.onDisconnect(t.reason || "booted")
                    } else {
                        this.$emit("disconnect", t.reason)
                    }
                    break;
                case "message":
                case "json":
                    var o = ["message", t.data];
                    if (t.ack == "data") {
                        o.push(a)
                    } else if (t.ack) {
                        this.packet({
                            type: "ack",
                            ackId: t.id
                        })
                    }
                    this.$emit.apply(this, o);
                    break;
                case "event":
                    var o = [t.name].concat(t.args);
                    if (t.ack == "data") o.push(a);
                    this.$emit.apply(this, o);
                    break;
                case "ack":
                    if (this.acks[t.ackId]) {
                        this.acks[t.ackId].apply(this, t.args);
                        delete this.acks[t.ackId]
                    }
                    break;
                case "error":
                    if (t.advice) {
                        this.socket.onError(t)
                    } else {
                        if (t.reason == "unauthorized") {
                            this.$emit("connect_failed", t.reason)
                        } else {
                            this.$emit("error", t.reason)
                        }
                    }
                    break
            }
        };

        function a(t, e) {
            this.namespace = t;
            this.name = e
        }
        a.prototype.send = function () {
            this.namespace.flags[this.name] = true;
            this.namespace.send.apply(this.namespace, arguments)
        };
        a.prototype.emit = function () {
            this.namespace.flags[this.name] = true;
            this.namespace.emit.apply(this.namespace, arguments)
        }
    })("undefined" != typeof io ? io : module.exports, "undefined" != typeof io ? io : module.parent.exports);
    (function (t, e, i) {
        t.websocket = a;

        function a(t) {
            e.Transport.apply(this, arguments)
        }
        e.util.inherit(a, e.Transport);
        a.prototype.name = "websocket";
        a.prototype.open = function () {
            var t = e.util.query(this.socket.options.query),
                a = this,
                o;
            if (!o) {
                o = i.MozWebSocket || i.WebSocket
            }
            this.websocket = new o(this.prepareUrl() + t);
            this.websocket.onopen = function () {
                a.onOpen();
                a.socket.setBuffer(false)
            };
            this.websocket.onmessage = function (t) {
                a.onData(t.data)
            };
            this.websocket.onclose = function () {
                a.onClose();
                a.socket.setBuffer(true)
            };
            this.websocket.onerror = function (t) {
                a.onError(t)
            };
            return this
        };
        if (e.util.ua.iDevice) {
            a.prototype.send = function (t) {
                var e = this;
                setTimeout(function () {
                    e.websocket.send(t)
                }, 0);
                return this
            }
        } else {
            a.prototype.send = function (t) {
                this.websocket.send(t);
                return this
            }
        }
        a.prototype.payload = function (t) {
            for (var e = 0, i = t.length; e < i; e++) {
                this.packet(t[e])
            }
            return this
        };
        a.prototype.close = function () {
            this.websocket.close();
            return this
        };
        a.prototype.onError = function (t) {
            this.socket.onError(t)
        };
        a.prototype.scheme = function () {
            return this.socket.options.secure ? "wss" : "ws"
        };
        a.check = function () {
            return "WebSocket" in i && !("__addTask" in WebSocket) || "MozWebSocket" in i
        };
        a.xdomainCheck = function () {
            return true
        };
        e.transports.push("websocket")
    })("undefined" != typeof io ? io.Transport : module.exports, "undefined" != typeof io ? io : module.parent.exports, this);
    (function (t, e) {
        t.flashsocket = i;

        function i() {
            e.Transport.websocket.apply(this, arguments)
        }
        e.util.inherit(i, e.Transport.websocket);
        i.prototype.name = "flashsocket";
        i.prototype.open = function () {
            var t = this,
                i = arguments;
            WebSocket.__addTask(function () {
                e.Transport.websocket.prototype.open.apply(t, i)
            });
            return this
        };
        i.prototype.send = function () {
            var t = this,
                i = arguments;
            WebSocket.__addTask(function () {
                e.Transport.websocket.prototype.send.apply(t, i)
            });
            return this
        };
        i.prototype.close = function () {
            WebSocket.__tasks.length = 0;
            e.Transport.websocket.prototype.close.call(this);
            return this
        };
        i.prototype.ready = function (t, a) {
            function o() {
                var e = t.options,
                    o = e["flash policy port"],
                    s = ["http" + (e.secure ? "s" : "") + ":/", e.host + ":" + e.port, e.resource, "static/flashsocket", "WebSocketMain" + (t.isXDomain() ? "Insecure" : "") + ".swf"];
                if (!i.loaded) {
                    if (typeof WEB_SOCKET_SWF_LOCATION === "undefined") {
                        WEB_SOCKET_SWF_LOCATION = s.join("/")
                    }
                    if (o !== 843) {
                        WebSocket.loadFlashPolicyFile("xmlsocket://" + e.host + ":" + o)
                    }
                    WebSocket.__initialize();
                    i.loaded = true
                }
                a.call(n)
            }
            var n = this;
            if (document.body) return o();
            e.util.load(o)
        };
        i.check = function () {
            if (typeof WebSocket == "undefined" || !("__initialize" in WebSocket) || !swfobject) return false;
            return swfobject.getFlashPlayerVersion()
                .major >= 10
        };
        i.xdomainCheck = function () {
            return true
        };
        if (typeof window != "undefined") {
            WEB_SOCKET_DISABLE_AUTO_INITIALIZATION = true
        }
        e.transports.push("flashsocket")
    })("undefined" != typeof io ? io.Transport : module.exports, "undefined" != typeof io ? io : module.parent.exports);
    if ("undefined" != typeof window) {
        var swfobject = function () {
            var t = "undefined",
                e = "object",
                i = "Shockwave Flash",
                a = "ShockwaveFlash.ShockwaveFlash",
                o = "application/x-shockwave-flash",
                n = "SWFObjectExprInst",
                s = "onreadystatechange",
                r = window,
                p = document,
                l = navigator,
                c = false,
                h = [I],
                u = [],
                m = [],
                d = [],
                f, g, y, k, v = false,
                W = false,
                b, w, C = true,
                L = function () {
                    var n = typeof p.getElementById != t && typeof p.getElementsByTagName != t && typeof p.createElement != t,
                        s = l.userAgent.toLowerCase(),
                        h = l.platform.toLowerCase(),
                        u = h ? /win/.test(h) : /win/.test(s),
                        m = h ? /mac/.test(h) : /mac/.test(s),
                        d = /webkit/.test(s) ? parseFloat(s.replace(/^.*webkit\/(\d+(\.\d+)?).*$/, "$1")) : false,
                        f = !+"1",
                        g = [0, 0, 0],
                        y = null;
                    if (typeof l.plugins != t && typeof l.plugins[i] == e) {
                        y = l.plugins[i].description;
                        if (y && !(typeof l.mimeTypes != t && l.mimeTypes[o] && !l.mimeTypes[o].enabledPlugin)) {
                            c = true;
                            f = false;
                            y = y.replace(/^.*\s+(\S+\s+\S+$)/, "$1");
                            g[0] = parseInt(y.replace(/^(.*)\..*$/, "$1"), 10);
                            g[1] = parseInt(y.replace(/^.*\.(.*)\s.*$/, "$1"), 10);
                            g[2] = /[a-zA-Z]/.test(y) ? parseInt(y.replace(/^.*[a-zA-Z]+(.*)$/, "$1"), 10) : 0
                        }
                    } else {
                        if (typeof r[["Active"].concat("Object")
                                .join("X")] != t) {
                            try {
                                var k = new (window[["Active"].concat("Object")
                                    .join("X")])(a);
                                if (k) {
                                    y = k.GetVariable("$version");
                                    if (y) {
                                        f = true;
                                        y = y.split(" ")[1].split(",");
                                        g = [parseInt(y[0], 10), parseInt(y[1], 10), parseInt(y[2], 10)]
                                    }
                                }
                            } catch (v) { }
                        }
                    }
                    return {
                        w3: n,
                        pv: g,
                        wk: d,
                        ie: f,
                        win: u,
                        mac: m
                    }
                }(),
                S = function () {
                    if (!L.w3) {
                        return
                    }
                    if (typeof p.readyState != t && p.readyState == "complete" || typeof p.readyState == t && (p.getElementsByTagName("body")[0] || p.body)) {
                        T()
                    }
                    if (!v) {
                        if (typeof p.addEventListener != t) {
                            p.addEventListener("DOMContentLoaded", T, false)
                        }
                        if (L.ie && L.win) {
                            p.attachEvent(s, function () {
                                if (p.readyState == "complete") {
                                    p.detachEvent(s, arguments.callee);
                                    T()
                                }
                            });
                            if (r == top) {
                                (function () {
                                    if (v) {
                                        return
                                    }
                                    try {
                                        p.documentElement.doScroll("left")
                                    } catch (t) {
                                        setTimeout(arguments.callee, 0);
                                        return
                                    }
                                    T()
                                })()
                            }
                        }
                        if (L.wk) {
                            (function () {
                                if (v) {
                                    return
                                }
                                if (!/loaded|complete/.test(p.readyState)) {
                                    setTimeout(arguments.callee, 0);
                                    return
                                }
                                T()
                            })()
                        }
                        x(T)
                    }
                }();

            function T() {
                if (v) {
                    return
                }
                try {
                    var t = p.getElementsByTagName("body")[0].appendChild(z("span"));
                    t.parentNode.removeChild(t)
                } catch (e) {
                    return
                }
                v = true;
                var i = h.length;
                for (var a = 0; a < i; a++) {
                    h[a]()
                }
            }

            function E(t) {
                if (v) {
                    t()
                } else {
                    h[h.length] = t
                }
            }

            function x(e) {
                if (typeof r.addEventListener != t) {
                    r.addEventListener("load", e, false)
                } else {
                    if (typeof p.addEventListener != t) {
                        p.addEventListener("load", e, false)
                    } else {
                        if (typeof r.attachEvent != t) {
                            H(r, "onload", e)
                        } else {
                            if (typeof r.onload == "function") {
                                var i = r.onload;
                                r.onload = function () {
                                    i();
                                    e()
                                }
                            } else {
                                r.onload = e
                            }
                        }
                    }
                }
            }

            function I() {
                if (c) {
                    U()
                } else {
                    P()
                }
            }

            function U() {
                var i = p.getElementsByTagName("body")[0];
                var a = z(e);
                a.setAttribute("type", o);
                var n = i.appendChild(a);
                if (n) {
                    var s = 0;
                    (function () {
                        if (typeof n.GetVariable != t) {
                            var e = n.GetVariable("$version");
                            if (e) {
                                e = e.split(" ")[1].split(",");
                                L.pv = [parseInt(e[0], 10), parseInt(e[1], 10), parseInt(e[2], 10)]
                            }
                        } else {
                            if (s < 10) {
                                s++;
                                setTimeout(arguments.callee, 10);
                                return
                            }
                        }
                        i.removeChild(a);
                        n = null;
                        P()
                    })()
                } else {
                    P()
                }
            }

            function P() {
                var e = u.length;
                if (e > 0) {
                    for (var i = 0; i < e; i++) {
                        var a = u[i].id;
                        var o = u[i].callbackFn;
                        var n = {
                            success: false,
                            id: a
                        };
                        if (L.pv[0] > 0) {
                            var s = F(a);
                            if (s) {
                                if (G(u[i].swfVersion) && !(L.wk && L.wk < 312)) {
                                    V(a, true);
                                    if (o) {
                                        n.success = true;
                                        n.ref = M(a);
                                        o(n)
                                    }
                                } else {
                                    if (u[i].expressInstall && D()) {
                                        var r = {};
                                        r.data = u[i].expressInstall;
                                        r.width = s.getAttribute("width") || "0";
                                        r.height = s.getAttribute("height") || "0";
                                        if (s.getAttribute("class")) {
                                            r.styleclass = s.getAttribute("class")
                                        }
                                        if (s.getAttribute("align")) {
                                            r.align = s.getAttribute("align")
                                        }
                                        var p = {};
                                        var l = s.getElementsByTagName("param");
                                        var c = l.length;
                                        for (var h = 0; h < c; h++) {
                                            if (l[h].getAttribute("name")
                                                .toLowerCase() != "movie") {
                                                p[l[h].getAttribute("name")] = l[h].getAttribute("value")
                                            }
                                        }
                                        O(r, p, a, o)
                                    } else {
                                        _(s);
                                        if (o) {
                                            o(n)
                                        }
                                    }
                                }
                            }
                        } else {
                            V(a, true);
                            if (o) {
                                var m = M(a);
                                if (m && typeof m.SetVariable != t) {
                                    n.success = true;
                                    n.ref = m
                                }
                                o(n)
                            }
                        }
                    }
                }
            }

            function M(i) {
                var a = null;
                var o = F(i);
                if (o && o.nodeName == "OBJECT") {
                    if (typeof o.SetVariable != t) {
                        a = o
                    } else {
                        var n = o.getElementsByTagName(e)[0];
                        if (n) {
                            a = n
                        }
                    }
                }
                return a
            }

            function D() {
                return !W && G("6.0.65") && (L.win || L.mac) && !(L.wk && L.wk < 312)
            }

            function O(e, i, a, o) {
                W = true;
                y = o || null;
                k = {
                    success: false,
                    id: a
                };
                var s = F(a);
                if (s) {
                    if (s.nodeName == "OBJECT") {
                        f = j(s);
                        g = null
                    } else {
                        f = s;
                        g = a
                    }
                    e.id = n;
                    if (typeof e.width == t || !/%$/.test(e.width) && parseInt(e.width, 10) < 310) {
                        e.width = "310"
                    }
                    if (typeof e.height == t || !/%$/.test(e.height) && parseInt(e.height, 10) < 137) {
                        e.height = "137"
                    }
                    p.title = p.title.slice(0, 47) + " - Flash Player Installation";
                    var l = L.ie && L.win ? ["Active"].concat("")
                        .join("X") : "PlugIn",
                        c = "MMredirectURL=" + r.location.toString()
                        .replace(/&/g, "%26") + "&MMplayerType=" + l + "&MMdoctitle=" + p.title;
                    if (typeof i.flashvars != t) {
                        i.flashvars += "&" + c
                    } else {
                        i.flashvars = c
                    }
                    if (L.ie && L.win && s.readyState != 4) {
                        var h = z("div");
                        a += "SWFObjectNew";
                        h.setAttribute("id", a);
                        s.parentNode.insertBefore(h, s);
                        s.style.display = "none";
                        (function () {
                            if (s.readyState == 4) {
                                s.parentNode.removeChild(s)
                            } else {
                                setTimeout(arguments.callee, 10)
                            }
                        })()
                    }
                    A(e, i, a)
                }
            }

            function _(t) {
                if (L.ie && L.win && t.readyState != 4) {
                    var e = z("div");
                    t.parentNode.insertBefore(e, t);
                    e.parentNode.replaceChild(j(t), e);
                    t.style.display = "none";
                    (function () {
                        if (t.readyState == 4) {
                            t.parentNode.removeChild(t)
                        } else {
                            setTimeout(arguments.callee, 10)
                        }
                    })()
                } else {
                    t.parentNode.replaceChild(j(t), t)
                }
            }

            function j(t) {
                var i = z("div");
                if (L.win && L.ie) {
                    i.innerHTML = t.innerHTML
                } else {
                    var a = t.getElementsByTagName(e)[0];
                    if (a) {
                        var o = a.childNodes;
                        if (o) {
                            var n = o.length;
                            for (var s = 0; s < n; s++) {
                                if (!(o[s].nodeType == 1 && o[s].nodeName == "PARAM") && !(o[s].nodeType == 8)) {
                                    i.appendChild(o[s].cloneNode(true))
                                }
                            }
                        }
                    }
                }
                return i
            }

            function A(i, a, n) {
                var s, r = F(n);
                if (L.wk && L.wk < 312) {
                    return s
                }
                if (r) {
                    if (typeof i.id == t) {
                        i.id = n
                    }
                    if (L.ie && L.win) {
                        var p = "";
                        for (var l in i) {
                            if (i[l] != Object.prototype[l]) {
                                if (l.toLowerCase() == "data") {
                                    a.movie = i[l]
                                } else {
                                    if (l.toLowerCase() == "styleclass") {
                                        p += ' class="' + i[l] + '"'
                                    } else {
                                        if (l.toLowerCase() != "classid") {
                                            p += " " + l + '="' + i[l] + '"'
                                        }
                                    }
                                }
                            }
                        }
                        var c = "";
                        for (var h in a) {
                            if (a[h] != Object.prototype[h]) {
                                c += '<param name="' + h + '" value="' + a[h] + '" />'
                            }
                        }
                        r.outerHTML = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"' + p + ">" + c + "</object>";
                        m[m.length] = i.id;
                        s = F(i.id)
                    } else {
                        var u = z(e);
                        u.setAttribute("type", o);
                        for (var d in i) {
                            if (i[d] != Object.prototype[d]) {
                                if (d.toLowerCase() == "styleclass") {
                                    u.setAttribute("class", i[d])
                                } else {
                                    if (d.toLowerCase() != "classid") {
                                        u.setAttribute(d, i[d])
                                    }
                                }
                            }
                        }
                        for (var f in a) {
                            if (a[f] != Object.prototype[f] && f.toLowerCase() != "movie") {
                                N(u, f, a[f])
                            }
                        }
                        r.parentNode.replaceChild(u, r);
                        s = u
                    }
                }
                return s
            }

            function N(t, e, i) {
                var a = z("param");
                a.setAttribute("name", e);
                a.setAttribute("value", i);
                t.appendChild(a)
            }

            function B(t) {
                var e = F(t);
                if (e && e.nodeName == "OBJECT") {
                    if (L.ie && L.win) {
                        e.style.display = "none";
                        (function () {
                            if (e.readyState == 4) {
                                R(t)
                            } else {
                                setTimeout(arguments.callee, 10)
                            }
                        })()
                    } else {
                        e.parentNode.removeChild(e)
                    }
                }
            }

            function R(t) {
                var e = F(t);
                if (e) {
                    for (var i in e) {
                        if (typeof e[i] == "function") {
                            e[i] = null
                        }
                    }
                    e.parentNode.removeChild(e)
                }
            }

            function F(t) {
                var e = null;
                try {
                    e = p.getElementById(t)
                } catch (i) { }
                return e
            }

            function z(t) {
                return p.createElement(t)
            }

            function H(t, e, i) {
                t.attachEvent(e, i);
                d[d.length] = [t, e, i]
            }

            function G(t) {
                var e = L.pv,
                    i = t.split(".");
                i[0] = parseInt(i[0], 10);
                i[1] = parseInt(i[1], 10) || 0;
                i[2] = parseInt(i[2], 10) || 0;
                return e[0] > i[0] || e[0] == i[0] && e[1] > i[1] || e[0] == i[0] && e[1] == i[1] && e[2] >= i[2] ? true : false
            }

            function q(i, a, o, n) {
                if (L.ie && L.mac) {
                    return
                }
                var s = p.getElementsByTagName("head")[0];
                if (!s) {
                    return
                }
                var r = o && typeof o == "string" ? o : "screen";
                if (n) {
                    b = null;
                    w = null
                }
                if (!b || w != r) {
                    var l = z("style");
                    l.setAttribute("type", "text/css");
                    l.setAttribute("media", r);
                    b = s.appendChild(l);
                    if (L.ie && L.win && typeof p.styleSheets != t && p.styleSheets.length > 0) {
                        b = p.styleSheets[p.styleSheets.length - 1]
                    }
                    w = r
                }
                if (L.ie && L.win) {
                    if (b && typeof b.addRule == e) {
                        b.addRule(i, a)
                    }
                } else {
                    if (b && typeof p.createTextNode != t) {
                        b.appendChild(p.createTextNode(i + " {" + a + "}"))
                    }
                }
            }

            function V(t, e) {
                if (!C) {
                    return
                }
                var i = e ? "visible" : "hidden";
                if (v && F(t)) {
                    F(t)
                        .style.visibility = i
                } else {
                    q("#" + t, "visibility:" + i)
                }
            }

            function Z(e) {
                var i = /[\\\"<>\.;]/;
                var a = i.exec(e) != null;
                return a && typeof encodeURIComponent != t ? encodeURIComponent(e) : e
            }
            var $ = function () {
                if (L.ie && L.win) {
                    window.attachEvent("onunload", function () {
                        var t = d.length;
                        for (var e = 0; e < t; e++) {
                            d[e][0].detachEvent(d[e][1], d[e][2])
                        }
                        var i = m.length;
                        for (var a = 0; a < i; a++) {
                            B(m[a])
                        }
                        for (var o in L) {
                            L[o] = null
                        }
                        L = null;
                        for (var n in swfobject) {
                            swfobject[n] = null
                        }
                        swfobject = null
                    })
                }
            }();
            return {
                registerObject: function (t, e, i, a) {
                    if (L.w3 && t && e) {
                        var o = {};
                        o.id = t;
                        o.swfVersion = e;
                        o.expressInstall = i;
                        o.callbackFn = a;
                        u[u.length] = o;
                        V(t, false)
                    } else {
                        if (a) {
                            a({
                                success: false,
                                id: t
                            })
                        }
                    }
                },
                getObjectById: function (t) {
                    if (L.w3) {
                        return M(t)
                    }
                },
                embedSWF: function (i, a, o, n, s, r, p, l, c, h) {
                    var u = {
                        success: false,
                        id: a
                    };
                    if (L.w3 && !(L.wk && L.wk < 312) && i && a && o && n && s) {
                        V(a, false);
                        E(function () {
                            o += "";
                            n += "";
                            var m = {};
                            if (c && typeof c === e) {
                                for (var d in c) {
                                    m[d] = c[d]
                                }
                            }
                            m.data = i;
                            m.width = o;
                            m.height = n;
                            var f = {};
                            if (l && typeof l === e) {
                                for (var g in l) {
                                    f[g] = l[g]
                                }
                            }
                            if (p && typeof p === e) {
                                for (var y in p) {
                                    if (typeof f.flashvars != t) {
                                        f.flashvars += "&" + y + "=" + p[y]
                                    } else {
                                        f.flashvars = y + "=" + p[y]
                                    }
                                }
                            }
                            if (G(s)) {
                                var k = A(m, f, a);
                                if (m.id == a) {
                                    V(a, true)
                                }
                                u.success = true;
                                u.ref = k
                            } else {
                                if (r && D()) {
                                    m.data = r;
                                    O(m, f, a, h);
                                    return
                                } else {
                                    V(a, true)
                                }
                            }
                            if (h) {
                                h(u)
                            }
                        })
                    } else {
                        if (h) {
                            h(u)
                        }
                    }
                },
                switchOffAutoHideShow: function () {
                    C = false
                },
                ua: L,
                getFlashPlayerVersion: function () {
                    return {
                        major: L.pv[0],
                        minor: L.pv[1],
                        release: L.pv[2]
                    }
                },
                hasFlashPlayerVersion: G,
                createSWF: function (t, e, i) {
                    if (L.w3) {
                        return A(t, e, i)
                    } else {
                        return undefined
                    }
                },
                showExpressInstall: function (t, e, i, a) {
                    if (L.w3 && D()) {
                        O(t, e, i, a)
                    }
                },
                removeSWF: function (t) {
                    if (L.w3) {
                        B(t)
                    }
                },
                createCSS: function (t, e, i, a) {
                    if (L.w3) {
                        q(t, e, i, a)
                    }
                },
                addDomLoadEvent: E,
                addLoadEvent: x,
                getQueryParamValue: function (t) {
                    var e = p.location.search || p.location.hash;
                    if (e) {
                        if (/\?/.test(e)) {
                            e = e.split("?")[1]
                        }
                        if (t == null) {
                            return Z(e)
                        }
                        var i = e.split("&");
                        for (var a = 0; a < i.length; a++) {
                            if (i[a].substring(0, i[a].indexOf("=")) == t) {
                                return Z(i[a].substring(i[a].indexOf("=") + 1))
                            }
                        }
                    }
                    return ""
                },
                expressInstallCallback: function () {
                    if (W) {
                        var t = F(n);
                        if (t && f) {
                            t.parentNode.replaceChild(f, t);
                            if (g) {
                                V(g, true);
                                if (L.ie && L.win) {
                                    f.style.display = "block"
                                }
                            }
                            if (y) {
                                y(k)
                            }
                        }
                        W = false
                    }
                }
            }
        }()
    } (function () {
        if ("undefined" == typeof window || window.WebSocket) return;
        var t = window.console;
        if (!t || !t.log || !t.error) {
            t = {
                log: function () { },
                error: function () { }
            }
        }
        if (!swfobject.hasFlashPlayerVersion("10.0.0")) {
            t.error("Flash Player >= 10.0.0 is required.");
            return
        }
        if (location.protocol == "file:") {
            t.error("WARNING: web-socket-js doesn't work in file:///... URL " + "unless you set Flash Security Settings properly. " + "Open the page via Web server i.e. http://...")
        }
        WebSocket = function (t, e, i, a, o) {
            var n = this;
            n.__id = WebSocket.__nextId++;
            WebSocket.__instances[n.__id] = n;
            n.readyState = WebSocket.CONNECTING;
            n.bufferedAmount = 0;
            n.__events = {};
            if (!e) {
                e = []
            } else if (typeof e == "string") {
                e = [e]
            }
            setTimeout(function () {
                WebSocket.__addTask(function () {
                    WebSocket.__flash.create(n.__id, t, e, i || null, a || 0, o || null)
                })
            }, 0)
        };
        WebSocket.prototype.send = function (t) {
            if (this.readyState == WebSocket.CONNECTING) {
                throw "INVALID_STATE_ERR: Web Socket connection has not been established"
            }
            var e = WebSocket.__flash.send(this.__id, encodeURIComponent(t));
            if (e < 0) {
                return true
            } else {
                this.bufferedAmount += e;
                return false
            }
        };
        WebSocket.prototype.close = function () {
            if (this.readyState == WebSocket.CLOSED || this.readyState == WebSocket.CLOSING) {
                return
            }
            this.readyState = WebSocket.CLOSING;
            WebSocket.__flash.close(this.__id)
        };
        WebSocket.prototype.addEventListener = function (t, e, i) {
            if (!(t in this.__events)) {
                this.__events[t] = []
            }
            this.__events[t].push(e)
        };
        WebSocket.prototype.removeEventListener = function (t, e, i) {
            if (!(t in this.__events)) return;
            var a = this.__events[t];
            for (var o = a.length - 1; o >= 0; --o) {
                if (a[o] === e) {
                    a.splice(o, 1);
                    break
                }
            }
        };
        WebSocket.prototype.dispatchEvent = function (t) {
            var e = this.__events[t.type] || [];
            for (var i = 0; i < e.length; ++i) {
                e[i](t)
            }
            var a = this["on" + t.type];
            if (a) a(t)
        };
        WebSocket.prototype.__handleEvent = function (t) {
            if ("readyState" in t) {
                this.readyState = t.readyState
            }
            if ("protocol" in t) {
                this.protocol = t.protocol
            }
            var e;
            if (t.type == "open" || t.type == "error") {
                e = this.__createSimpleEvent(t.type)
            } else if (t.type == "close") {
                e = this.__createSimpleEvent("close")
            } else if (t.type == "message") {
                var i = decodeURIComponent(t.message);
                e = this.__createMessageEvent("message", i)
            } else {
                throw "unknown event type: " + t.type
            }
            this.dispatchEvent(e)
        };
        WebSocket.prototype.__createSimpleEvent = function (t) {
            if (document.createEvent && window.Event) {
                var e = document.createEvent("Event");
                e.initEvent(t, false, false);
                return e
            } else {
                return {
                    type: t,
                    bubbles: false,
                    cancelable: false
                }
            }
        };
        WebSocket.prototype.__createMessageEvent = function (t, e) {
            if (document.createEvent && window.MessageEvent && !window.opera) {
                var i = document.createEvent("MessageEvent");
                i.initMessageEvent("message", false, false, e, null, null, window, null);
                return i
            } else {
                return {
                    type: t,
                    data: e,
                    bubbles: false,
                    cancelable: false
                }
            }
        };
        WebSocket.CONNECTING = 0;
        WebSocket.OPEN = 1;
        WebSocket.CLOSING = 2;
        WebSocket.CLOSED = 3;
        WebSocket.__flash = null;
        WebSocket.__instances = {};
        WebSocket.__tasks = [];
        WebSocket.__nextId = 0;
        WebSocket.loadFlashPolicyFile = function (t) {
            WebSocket.__addTask(function () {
                WebSocket.__flash.loadManualPolicyFile(t)
            })
        };
        WebSocket.__initialize = function () {
            if (WebSocket.__flash) return;
            if (WebSocket.__swfLocation) {
                window.WEB_SOCKET_SWF_LOCATION = WebSocket.__swfLocation
            }
            if (!window.WEB_SOCKET_SWF_LOCATION) {
                t.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");
                return
            }
            var e = document.createElement("div");
            e.id = "webSocketContainer";
            e.style.position = "absolute";
            if (WebSocket.__isFlashLite()) {
                e.style.left = "0px";
                e.style.top = "0px"
            } else {
                e.style.left = "-100px";
                e.style.top = "-100px"
            }
            var i = document.createElement("div");
            i.id = "webSocketFlash";
            e.appendChild(i);
            document.body.appendChild(e);
            swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION, "webSocketFlash", "1", "1", "10.0.0", null, null, {
                hasPriority: true,
                swliveconnect: true,
                allowScriptAccess: "always"
            }, null, function (e) {
                if (!e.success) {
                    t.error("[WebSocket] swfobject.embedSWF failed")
                }
            })
        };
        WebSocket.__onFlashInitialized = function () {
            setTimeout(function () {
                WebSocket.__flash = document.getElementById("webSocketFlash");
                WebSocket.__flash.setCallerUrl(location.href);
                WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);
                for (var t = 0; t < WebSocket.__tasks.length; ++t) {
                    WebSocket.__tasks[t]()
                }
                WebSocket.__tasks = []
            }, 0)
        };
        WebSocket.__onFlashEvent = function () {
            setTimeout(function () {
                try {
                    var e = WebSocket.__flash.receiveEvents();
                    for (var i = 0; i < e.length; ++i) {
                        WebSocket.__instances[e[i].webSocketId].__handleEvent(e[i])
                    }
                } catch (a) {
                    t.error(a)
                }
            }, 0);
            return true
        };
        WebSocket.__log = function (e) {
            t.log(decodeURIComponent(e))
        };
        WebSocket.__error = function (e) {
            t.error(decodeURIComponent(e))
        };
        WebSocket.__addTask = function (t) {
            if (WebSocket.__flash) {
                t()
            } else {
                WebSocket.__tasks.push(t)
            }
        };
        WebSocket.__isFlashLite = function () {
            if (!window.navigator || !window.navigator.mimeTypes) {
                return false
            }
            var t = window.navigator.mimeTypes["application/x-shockwave-flash"];
            if (!t || !t.enabledPlugin || !t.enabledPlugin.filename) {
                return false
            }
            return t.enabledPlugin.filename.match(/flashlite/i) ? true : false
        };
        if (!window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION) {
            if (window.addEventListener) {
                window.addEventListener("load", function () {
                    WebSocket.__initialize()
                }, false)
            } else {
                window.attachEvent("onload", function () {
                    WebSocket.__initialize()
                })
            }
        }
    })();
    (function (t, e, i) {
        t.XHR = a;

        function a(t) {
            if (!t) return;
            e.Transport.apply(this, arguments);
            this.sendBuffer = []
        }
        e.util.inherit(a, e.Transport);
        a.prototype.open = function () {
            this.socket.setBuffer(false);
            this.onOpen();
            this.get();
            this.setCloseTimeout();
            return this
        };
        a.prototype.payload = function (t) {
            var i = [];
            for (var a = 0, o = t.length; a < o; a++) {
                i.push(e.parser.encodePacket(t[a]))
            }
            this.send(e.parser.encodePayload(i))
        };
        a.prototype.send = function (t) {
            this.post(t);
            return this
        };

        function o() { }
        a.prototype.post = function (t) {
            var e = this;
            this.socket.setBuffer(true);

            function a() {
                if (this.readyState == 4) {
                    this.onreadystatechange = o;
                    e.posting = false;
                    if (this.status == 200) {
                        e.socket.setBuffer(false)
                    } else {
                        e.onClose()
                    }
                }
            }

            function n() {
                this.onload = o;
                e.socket.setBuffer(false)
            }
            this.sendXHR = this.request("POST");
            if (i.XDomainRequest && this.sendXHR instanceof XDomainRequest) {
                this.sendXHR.onload = this.sendXHR.onerror = n
            } else {
                this.sendXHR.onreadystatechange = a
            }
            this.sendXHR.send(t)
        };
        a.prototype.close = function () {
            this.onClose();
            return this
        };
        a.prototype.request = function (t) {
            var i = e.util.request(this.socket.isXDomain()),
                a = e.util.query(this.socket.options.query, "t=" + +new Date);
            i.open(t || "GET", this.prepareUrl() + a, true);
            if (t == "POST") {
                try {
                    if (i.setRequestHeader) {
                        i.setRequestHeader("Content-type", "text/plain;charset=UTF-8")
                    } else {
                        i.contentType = "text/plain"
                    }
                } catch (o) { }
            }
            return i
        };
        a.prototype.scheme = function () {
            return this.socket.options.secure ? "https" : "http"
        };
        a.check = function (t, a) {
            try {
                var o = e.util.request(a),
                    n = i.XDomainRequest && o instanceof XDomainRequest,
                    s = t && t.options && t.options.secure ? "https:" : "http:",
                    r = i.location && s != i.location.protocol;
                if (o && !(n && r)) {
                    return true
                }
            } catch (p) { }
            return false
        };
        a.xdomainCheck = function (t) {
            return a.check(t, true)
        }
    })("undefined" != typeof io ? io.Transport : module.exports, "undefined" != typeof io ? io : module.parent.exports, this);
    (function (t, e) {
        t.htmlfile = i;

        function i(t) {
            e.Transport.XHR.apply(this, arguments)
        }
        e.util.inherit(i, e.Transport.XHR);
        i.prototype.name = "htmlfile";
        i.prototype.get = function () {
            this.doc = new (window[["Active"].concat("Object")
                .join("X")])("htmlfile");
            this.doc.open();
            this.doc.write("<html></html>");
            this.doc.close();
            this.doc.parentWindow.s = this;
            var t = this.doc.createElement("div");
            t.className = "socketio";
            this.doc.body.appendChild(t);
            this.iframe = this.doc.createElement("iframe");
            t.appendChild(this.iframe);
            var i = this,
                a = e.util.query(this.socket.options.query, "t=" + +new Date);
            this.iframe.src = this.prepareUrl() + a;
            e.util.on(window, "unload", function () {
                i.destroy()
            })
        };
        i.prototype._ = function (t, e) {
            t = t.replace(/\\\//g, "/");
            this.onData(t);
            try {
                var i = e.getElementsByTagName("script")[0];
                i.parentNode.removeChild(i)
            } catch (a) { }
        };
        i.prototype.destroy = function () {
            if (this.iframe) {
                try {
                    this.iframe.src = "about:blank"
                } catch (t) { }
                this.doc = null;
                this.iframe.parentNode.removeChild(this.iframe);
                this.iframe = null;
                CollectGarbage()
            }
        };
        i.prototype.close = function () {
            this.destroy();
            return e.Transport.XHR.prototype.close.call(this)
        };
        i.check = function (t) {
            if (typeof window != "undefined" && ["Active"].concat("Object")
                .join("X") in window) {
                try {
                    var i = new (window[["Active"].concat("Object")
                        .join("X")])("htmlfile");
                    return i && e.Transport.XHR.check(t)
                } catch (a) { }
            }
            return false
        };
        i.xdomainCheck = function () {
            return false
        };
        e.transports.push("htmlfile")
    })("undefined" != typeof io ? io.Transport : module.exports, "undefined" != typeof io ? io : module.parent.exports);
    (function (t, e, i) {
        t["xhr-polling"] = a;

        function a() {
            e.Transport.XHR.apply(this, arguments)
        }
        e.util.inherit(a, e.Transport.XHR);
        e.util.merge(a, e.Transport.XHR);
        a.prototype.name = "xhr-polling";
        a.prototype.heartbeats = function () {
            return false
        };
        a.prototype.open = function () {
            var t = this;
            e.Transport.XHR.prototype.open.call(t);
            return false
        };

        function o() { }
        a.prototype.get = function () {
            if (!this.isOpen) return;
            var t = this;

            function e() {
                if (this.readyState == 4) {
                    this.onreadystatechange = o;
                    if (this.status == 200) {
                        t.onData(this.responseText);
                        t.get()
                    } else {
                        t.onClose()
                    }
                }
            }

            function a() {
                this.onload = o;
                this.onerror = o;
                t.retryCounter = 1;
                t.onData(this.responseText);
                t.get()
            }

            function n() {
                t.retryCounter++;
                if (!t.retryCounter || t.retryCounter > 3) {
                    t.onClose()
                } else {
                    t.get()
                }
            }
            this.xhr = this.request();
            if (i.XDomainRequest && this.xhr instanceof XDomainRequest) {
                this.xhr.onload = a;
                this.xhr.onerror = n
            } else {
                this.xhr.onreadystatechange = e
            }
            this.xhr.send(null)
        };
        a.prototype.onClose = function () {
            e.Transport.XHR.prototype.onClose.call(this);
            if (this.xhr) {
                this.xhr.onreadystatechange = this.xhr.onload = this.xhr.onerror = o;
                try {
                    this.xhr.abort()
                } catch (t) { }
                this.xhr = null
            }
        };
        a.prototype.ready = function (t, i) {
            var a = this;
            e.util.defer(function () {
                i.call(a)
            })
        };
        e.transports.push("xhr-polling")
    })("undefined" != typeof io ? io.Transport : module.exports, "undefined" != typeof io ? io : module.parent.exports, this);
    (function (t, e, i) {
        var a = i.document && "MozAppearance" in i.document.documentElement.style;
        t["jsonp-polling"] = o;

        function o(t) {
            e.Transport["xhr-polling"].apply(this, arguments);
            this.index = e.j.length;
            var i = this;
            e.j.push(function (t) {
                i._(t)
            })
        }
        e.util.inherit(o, e.Transport["xhr-polling"]);
        o.prototype.name = "jsonp-polling";
        o.prototype.post = function (t) {
            var i = this,
                a = e.util.query(this.socket.options.query, "t=" + +new Date + "&i=" + this.index);
            if (!this.form) {
                var o = document.createElement("form"),
                    n = document.createElement("textarea"),
                    s = this.iframeId = "socketio_iframe_" + this.index,
                    r;
                o.className = "socketio";
                o.style.position = "absolute";
                o.style.top = "0px";
                o.style.left = "0px";
                o.style.display = "none";
                o.target = s;
                o.method = "POST";
                o.setAttribute("accept-charset", "utf-8");
                n.name = "d";
                o.appendChild(n);
                document.body.appendChild(o);
                this.form = o;
                this.area = n
            }
            this.form.action = this.prepareUrl() + a;

            function p() {
                l();
                i.socket.setBuffer(false)
            }

            function l() {
                if (i.iframe) {
                    i.form.removeChild(i.iframe)
                }
                try {
                    r = document.createElement('<iframe name="' + i.iframeId + '">')
                } catch (t) {
                    r = document.createElement("iframe");
                    r.name = i.iframeId
                }
                r.id = i.iframeId;
                i.form.appendChild(r);
                i.iframe = r
            }
            l();
            this.area.value = e.JSON.stringify(t);
            try {
                this.form.submit()
            } catch (c) { }
            if (this.iframe.attachEvent) {
                r.onreadystatechange = function () {
                    if (i.iframe.readyState == "complete") {
                        p()
                    }
                }
            } else {
                this.iframe.onload = p
            }
            this.socket.setBuffer(true)
        };
        o.prototype.get = function () {
            var t = this,
                i = document.createElement("script"),
                o = e.util.query(this.socket.options.query, "t=" + +new Date + "&i=" + this.index);
            if (this.script) {
                this.script.parentNode.removeChild(this.script);
                this.script = null
            }
            i.async = true;
            i.src = this.prepareUrl() + o;
            i.onerror = function () {
                t.onClose()
            };
            var n = document.getElementsByTagName("script")[0];
            n.parentNode.insertBefore(i, n);
            this.script = i;
            if (a) {
                setTimeout(function () {
                    var t = document.createElement("iframe");
                    document.body.appendChild(t);
                    document.body.removeChild(t)
                }, 100)
            }
        };
        o.prototype._ = function (t) {
            this.onData(t);
            if (this.isOpen) {
                this.get()
            }
            return this
        };
        o.prototype.ready = function (t, i) {
            var o = this;
            if (!a) return i.call(this);
            e.util.load(function () {
                i.call(o)
            })
        };
        o.check = function () {
            return "document" in i
        };
        o.xdomainCheck = function () {
            return true
        };
        e.transports.push("jsonp-polling")
    })("undefined" != typeof io ? io.Transport : module.exports, "undefined" != typeof io ? io : module.parent.exports, this);
    if (typeof define === "function" && define.amd) {
        define([], function () {
            return io
        })
    }
})();
(function (t) {
    if (typeof t.fn.each2 == "undefined") {
        t.extend(t.fn, {
            each2: function (e) {
                var i = t([0]),
                    a = -1,
                    o = this.length;
                while (++a < o && (i.context = i[0] = this[a]) && e.call(i[0], a, i) !== false);
                return this
            }
        })
    }
})(jQuery);
(function (t, e) {
    "use strict";
    if (window.Select2 !== e) {
        return
    }
    var i, a, o, n, s, r, p = {
        x: 0,
        y: 0
    },
        l, c, i = {
            TAB: 9,
            ENTER: 13,
            ESC: 27,
            SPACE: 32,
            LEFT: 37,
            UP: 38,
            RIGHT: 39,
            DOWN: 40,
            SHIFT: 16,
            CTRL: 17,
            ALT: 18,
            PAGE_UP: 33,
            PAGE_DOWN: 34,
            HOME: 36,
            END: 35,
            BACKSPACE: 8,
            DELETE: 46,
            isArrow: function (t) {
                t = t.which ? t.which : t;
                switch (t) {
                    case i.LEFT:
                    case i.RIGHT:
                    case i.UP:
                    case i.DOWN:
                        return true
                }
                return false
            },
            isControl: function (t) {
                var e = t.which;
                switch (e) {
                    case i.SHIFT:
                    case i.CTRL:
                    case i.ALT:
                        return true
                }
                if (t.metaKey) return true;
                return false
            },
            isFunctionKey: function (t) {
                t = t.which ? t.which : t;
                return t >= 112 && t <= 123
            }
        },
        h = "<div class='select2-measure-scrollbar'></div>",
        u = {
            "Ⓐ": "A",
            Ａ: "A",
            À: "A",
            Á: "A",
            Â: "A",
            Ầ: "A",
            Ấ: "A",
            Ẫ: "A",
            Ẩ: "A",
            Ã: "A",
            Ā: "A",
            Ă: "A",
            Ằ: "A",
            Ắ: "A",
            Ẵ: "A",
            Ẳ: "A",
            Ȧ: "A",
            Ǡ: "A",
            Ä: "A",
            Ǟ: "A",
            Ả: "A",
            Å: "A",
            Ǻ: "A",
            Ǎ: "A",
            Ȁ: "A",
            Ȃ: "A",
            Ạ: "A",
            Ậ: "A",
            Ặ: "A",
            Ḁ: "A",
            Ą: "A",
            Ⱥ: "A",
            Ɐ: "A",
            Ꜳ: "AA",
            Æ: "AE",
            Ǽ: "AE",
            Ǣ: "AE",
            Ꜵ: "AO",
            Ꜷ: "AU",
            Ꜹ: "AV",
            Ꜻ: "AV",
            Ꜽ: "AY",
            "Ⓑ": "B",
            Ｂ: "B",
            Ḃ: "B",
            Ḅ: "B",
            Ḇ: "B",
            Ƀ: "B",
            Ƃ: "B",
            Ɓ: "B",
            "Ⓒ": "C",
            Ｃ: "C",
            Ć: "C",
            Ĉ: "C",
            Ċ: "C",
            Č: "C",
            Ç: "C",
            Ḉ: "C",
            Ƈ: "C",
            Ȼ: "C",
            Ꜿ: "C",
            "Ⓓ": "D",
            Ｄ: "D",
            Ḋ: "D",
            Ď: "D",
            Ḍ: "D",
            Ḑ: "D",
            Ḓ: "D",
            Ḏ: "D",
            Đ: "D",
            Ƌ: "D",
            Ɗ: "D",
            Ɖ: "D",
            Ꝺ: "D",
            Ǳ: "DZ",
            Ǆ: "DZ",
            ǲ: "Dz",
            ǅ: "Dz",
            "Ⓔ": "E",
            Ｅ: "E",
            È: "E",
            É: "E",
            Ê: "E",
            Ề: "E",
            Ế: "E",
            Ễ: "E",
            Ể: "E",
            Ẽ: "E",
            Ē: "E",
            Ḕ: "E",
            Ḗ: "E",
            Ĕ: "E",
            Ė: "E",
            Ë: "E",
            Ẻ: "E",
            Ě: "E",
            Ȅ: "E",
            Ȇ: "E",
            Ẹ: "E",
            Ệ: "E",
            Ȩ: "E",
            Ḝ: "E",
            Ę: "E",
            Ḙ: "E",
            Ḛ: "E",
            Ɛ: "E",
            Ǝ: "E",
            "Ⓕ": "F",
            Ｆ: "F",
            Ḟ: "F",
            Ƒ: "F",
            Ꝼ: "F",
            "Ⓖ": "G",
            Ｇ: "G",
            Ǵ: "G",
            Ĝ: "G",
            Ḡ: "G",
            Ğ: "G",
            Ġ: "G",
            Ǧ: "G",
            Ģ: "G",
            Ǥ: "G",
            Ɠ: "G",
            "Ꞡ": "G",
            Ᵹ: "G",
            Ꝿ: "G",
            "Ⓗ": "H",
            Ｈ: "H",
            Ĥ: "H",
            Ḣ: "H",
            Ḧ: "H",
            Ȟ: "H",
            Ḥ: "H",
            Ḩ: "H",
            Ḫ: "H",
            Ħ: "H",
            Ⱨ: "H",
            Ⱶ: "H",
            "Ɥ": "H",
            "Ⓘ": "I",
            Ｉ: "I",
            Ì: "I",
            Í: "I",
            Î: "I",
            Ĩ: "I",
            Ī: "I",
            Ĭ: "I",
            İ: "I",
            Ï: "I",
            Ḯ: "I",
            Ỉ: "I",
            Ǐ: "I",
            Ȉ: "I",
            Ȋ: "I",
            Ị: "I",
            Į: "I",
            Ḭ: "I",
            Ɨ: "I",
            "Ⓙ": "J",
            Ｊ: "J",
            Ĵ: "J",
            Ɉ: "J",
            "Ⓚ": "K",
            Ｋ: "K",
            Ḱ: "K",
            Ǩ: "K",
            Ḳ: "K",
            Ķ: "K",
            Ḵ: "K",
            Ƙ: "K",
            Ⱪ: "K",
            Ꝁ: "K",
            Ꝃ: "K",
            Ꝅ: "K",
            "Ꞣ": "K",
            "Ⓛ": "L",
            Ｌ: "L",
            Ŀ: "L",
            Ĺ: "L",
            Ľ: "L",
            Ḷ: "L",
            Ḹ: "L",
            Ļ: "L",
            Ḽ: "L",
            Ḻ: "L",
            Ł: "L",
            Ƚ: "L",
            Ɫ: "L",
            Ⱡ: "L",
            Ꝉ: "L",
            Ꝇ: "L",
            Ꞁ: "L",
            Ǉ: "LJ",
            ǈ: "Lj",
            "Ⓜ": "M",
            Ｍ: "M",
            Ḿ: "M",
            Ṁ: "M",
            Ṃ: "M",
            Ɱ: "M",
            Ɯ: "M",
            "Ⓝ": "N",
            Ｎ: "N",
            Ǹ: "N",
            Ń: "N",
            Ñ: "N",
            Ṅ: "N",
            Ň: "N",
            Ṇ: "N",
            Ņ: "N",
            Ṋ: "N",
            Ṉ: "N",
            Ƞ: "N",
            Ɲ: "N",
            "Ꞑ": "N",
            "Ꞥ": "N",
            Ǌ: "NJ",
            ǋ: "Nj",
            "Ⓞ": "O",
            Ｏ: "O",
            Ò: "O",
            Ó: "O",
            Ô: "O",
            Ồ: "O",
            Ố: "O",
            Ỗ: "O",
            Ổ: "O",
            Õ: "O",
            Ṍ: "O",
            Ȭ: "O",
            Ṏ: "O",
            Ō: "O",
            Ṑ: "O",
            Ṓ: "O",
            Ŏ: "O",
            Ȯ: "O",
            Ȱ: "O",
            Ö: "O",
            Ȫ: "O",
            Ỏ: "O",
            Ő: "O",
            Ǒ: "O",
            Ȍ: "O",
            Ȏ: "O",
            Ơ: "O",
            Ờ: "O",
            Ớ: "O",
            Ỡ: "O",
            Ở: "O",
            Ợ: "O",
            Ọ: "O",
            Ộ: "O",
            Ǫ: "O",
            Ǭ: "O",
            Ø: "O",
            Ǿ: "O",
            Ɔ: "O",
            Ɵ: "O",
            Ꝋ: "O",
            Ꝍ: "O",
            Ƣ: "OI",
            Ꝏ: "OO",
            Ȣ: "OU",
            "Ⓟ": "P",
            Ｐ: "P",
            Ṕ: "P",
            Ṗ: "P",
            Ƥ: "P",
            Ᵽ: "P",
            Ꝑ: "P",
            Ꝓ: "P",
            Ꝕ: "P",
            "Ⓠ": "Q",
            Ｑ: "Q",
            Ꝗ: "Q",
            Ꝙ: "Q",
            Ɋ: "Q",
            "Ⓡ": "R",
            Ｒ: "R",
            Ŕ: "R",
            Ṙ: "R",
            Ř: "R",
            Ȑ: "R",
            Ȓ: "R",
            Ṛ: "R",
            Ṝ: "R",
            Ŗ: "R",
            Ṟ: "R",
            Ɍ: "R",
            Ɽ: "R",
            Ꝛ: "R",
            "Ꞧ": "R",
            Ꞃ: "R",
            "Ⓢ": "S",
            Ｓ: "S",
            ẞ: "S",
            Ś: "S",
            Ṥ: "S",
            Ŝ: "S",
            Ṡ: "S",
            Š: "S",
            Ṧ: "S",
            Ṣ: "S",
            Ṩ: "S",
            Ș: "S",
            Ş: "S",
            "Ȿ": "S",
            "Ꞩ": "S",
            Ꞅ: "S",
            "Ⓣ": "T",
            Ｔ: "T",
            Ṫ: "T",
            Ť: "T",
            Ṭ: "T",
            Ț: "T",
            Ţ: "T",
            Ṱ: "T",
            Ṯ: "T",
            Ŧ: "T",
            Ƭ: "T",
            Ʈ: "T",
            Ⱦ: "T",
            Ꞇ: "T",
            Ꜩ: "TZ",
            "Ⓤ": "U",
            Ｕ: "U",
            Ù: "U",
            Ú: "U",
            Û: "U",
            Ũ: "U",
            Ṹ: "U",
            Ū: "U",
            Ṻ: "U",
            Ŭ: "U",
            Ü: "U",
            Ǜ: "U",
            Ǘ: "U",
            Ǖ: "U",
            Ǚ: "U",
            Ủ: "U",
            Ů: "U",
            Ű: "U",
            Ǔ: "U",
            Ȕ: "U",
            Ȗ: "U",
            Ư: "U",
            Ừ: "U",
            Ứ: "U",
            Ữ: "U",
            Ử: "U",
            Ự: "U",
            Ụ: "U",
            Ṳ: "U",
            Ų: "U",
            Ṷ: "U",
            Ṵ: "U",
            Ʉ: "U",
            "Ⓥ": "V",
            Ｖ: "V",
            Ṽ: "V",
            Ṿ: "V",
            Ʋ: "V",
            Ꝟ: "V",
            Ʌ: "V",
            Ꝡ: "VY",
            "Ⓦ": "W",
            Ｗ: "W",
            Ẁ: "W",
            Ẃ: "W",
            Ŵ: "W",
            Ẇ: "W",
            Ẅ: "W",
            Ẉ: "W",
            Ⱳ: "W",
            "Ⓧ": "X",
            Ｘ: "X",
            Ẋ: "X",
            Ẍ: "X",
            "Ⓨ": "Y",
            Ｙ: "Y",
            Ỳ: "Y",
            Ý: "Y",
            Ŷ: "Y",
            Ỹ: "Y",
            Ȳ: "Y",
            Ẏ: "Y",
            Ÿ: "Y",
            Ỷ: "Y",
            Ỵ: "Y",
            Ƴ: "Y",
            Ɏ: "Y",
            Ỿ: "Y",
            "Ⓩ": "Z",
            Ｚ: "Z",
            Ź: "Z",
            Ẑ: "Z",
            Ż: "Z",
            Ž: "Z",
            Ẓ: "Z",
            Ẕ: "Z",
            Ƶ: "Z",
            Ȥ: "Z",
            "Ɀ": "Z",
            Ⱬ: "Z",
            Ꝣ: "Z",
            "ⓐ": "a",
            ａ: "a",
            ẚ: "a",
            à: "a",
            á: "a",
            â: "a",
            ầ: "a",
            ấ: "a",
            ẫ: "a",
            ẩ: "a",
            ã: "a",
            ā: "a",
            ă: "a",
            ằ: "a",
            ắ: "a",
            ẵ: "a",
            ẳ: "a",
            ȧ: "a",
            ǡ: "a",
            ä: "a",
            ǟ: "a",
            ả: "a",
            å: "a",
            ǻ: "a",
            ǎ: "a",
            ȁ: "a",
            ȃ: "a",
            ạ: "a",
            ậ: "a",
            ặ: "a",
            ḁ: "a",
            ą: "a",
            ⱥ: "a",
            ɐ: "a",
            ꜳ: "aa",
            æ: "ae",
            ǽ: "ae",
            ǣ: "ae",
            ꜵ: "ao",
            ꜷ: "au",
            ꜹ: "av",
            ꜻ: "av",
            ꜽ: "ay",
            "ⓑ": "b",
            ｂ: "b",
            ḃ: "b",
            ḅ: "b",
            ḇ: "b",
            ƀ: "b",
            ƃ: "b",
            ɓ: "b",
            "ⓒ": "c",
            ｃ: "c",
            ć: "c",
            ĉ: "c",
            ċ: "c",
            č: "c",
            ç: "c",
            ḉ: "c",
            ƈ: "c",
            ȼ: "c",
            ꜿ: "c",
            ↄ: "c",
            "ⓓ": "d",
            ｄ: "d",
            ḋ: "d",
            ď: "d",
            ḍ: "d",
            ḑ: "d",
            ḓ: "d",
            ḏ: "d",
            đ: "d",
            ƌ: "d",
            ɖ: "d",
            ɗ: "d",
            ꝺ: "d",
            ǳ: "dz",
            ǆ: "dz",
            "ⓔ": "e",
            ｅ: "e",
            è: "e",
            é: "e",
            ê: "e",
            ề: "e",
            ế: "e",
            ễ: "e",
            ể: "e",
            ẽ: "e",
            ē: "e",
            ḕ: "e",
            ḗ: "e",
            ĕ: "e",
            ė: "e",
            ë: "e",
            ẻ: "e",
            ě: "e",
            ȅ: "e",
            ȇ: "e",
            ẹ: "e",
            ệ: "e",
            ȩ: "e",
            ḝ: "e",
            ę: "e",
            ḙ: "e",
            ḛ: "e",
            ɇ: "e",
            ɛ: "e",
            ǝ: "e",
            "ⓕ": "f",
            ｆ: "f",
            ḟ: "f",
            ƒ: "f",
            ꝼ: "f",
            "ⓖ": "g",
            ｇ: "g",
            ǵ: "g",
            ĝ: "g",
            ḡ: "g",
            ğ: "g",
            ġ: "g",
            ǧ: "g",
            ģ: "g",
            ǥ: "g",
            ɠ: "g",
            "ꞡ": "g",
            ᵹ: "g",
            ꝿ: "g",
            "ⓗ": "h",
            ｈ: "h",
            ĥ: "h",
            ḣ: "h",
            ḧ: "h",
            ȟ: "h",
            ḥ: "h",
            ḩ: "h",
            ḫ: "h",
            ẖ: "h",
            ħ: "h",
            ⱨ: "h",
            ⱶ: "h",
            ɥ: "h",
            ƕ: "hv",
            "ⓘ": "i",
            ｉ: "i",
            ì: "i",
            í: "i",
            î: "i",
            ĩ: "i",
            ī: "i",
            ĭ: "i",
            ï: "i",
            ḯ: "i",
            ỉ: "i",
            ǐ: "i",
            ȉ: "i",
            ȋ: "i",
            ị: "i",
            į: "i",
            ḭ: "i",
            ɨ: "i",
            ı: "i",
            "ⓙ": "j",
            ｊ: "j",
            ĵ: "j",
            ǰ: "j",
            ɉ: "j",
            "ⓚ": "k",
            ｋ: "k",
            ḱ: "k",
            ǩ: "k",
            ḳ: "k",
            ķ: "k",
            ḵ: "k",
            ƙ: "k",
            ⱪ: "k",
            ꝁ: "k",
            ꝃ: "k",
            ꝅ: "k",
            "ꞣ": "k",
            "ⓛ": "l",
            ｌ: "l",
            ŀ: "l",
            ĺ: "l",
            ľ: "l",
            ḷ: "l",
            ḹ: "l",
            ļ: "l",
            ḽ: "l",
            ḻ: "l",
            ſ: "l",
            ł: "l",
            ƚ: "l",
            ɫ: "l",
            ⱡ: "l",
            ꝉ: "l",
            ꞁ: "l",
            ꝇ: "l",
            ǉ: "lj",
            "ⓜ": "m",
            ｍ: "m",
            ḿ: "m",
            ṁ: "m",
            ṃ: "m",
            ɱ: "m",
            ɯ: "m",
            "ⓝ": "n",
            ｎ: "n",
            ǹ: "n",
            ń: "n",
            ñ: "n",
            ṅ: "n",
            ň: "n",
            ṇ: "n",
            ņ: "n",
            ṋ: "n",
            ṉ: "n",
            ƞ: "n",
            ɲ: "n",
            ŉ: "n",
            "ꞑ": "n",
            "ꞥ": "n",
            ǌ: "nj",
            "ⓞ": "o",
            ｏ: "o",
            ò: "o",
            ó: "o",
            ô: "o",
            ồ: "o",
            ố: "o",
            ỗ: "o",
            ổ: "o",
            õ: "o",
            ṍ: "o",
            ȭ: "o",
            ṏ: "o",
            ō: "o",
            ṑ: "o",
            ṓ: "o",
            ŏ: "o",
            ȯ: "o",
            ȱ: "o",
            ö: "o",
            ȫ: "o",
            ỏ: "o",
            ő: "o",
            ǒ: "o",
            ȍ: "o",
            ȏ: "o",
            ơ: "o",
            ờ: "o",
            ớ: "o",
            ỡ: "o",
            ở: "o",
            ợ: "o",
            ọ: "o",
            ộ: "o",
            ǫ: "o",
            ǭ: "o",
            ø: "o",
            ǿ: "o",
            ɔ: "o",
            ꝋ: "o",
            ꝍ: "o",
            ɵ: "o",
            ƣ: "oi",
            ȣ: "ou",
            ꝏ: "oo",
            "ⓟ": "p",
            ｐ: "p",
            ṕ: "p",
            ṗ: "p",
            ƥ: "p",
            ᵽ: "p",
            ꝑ: "p",
            ꝓ: "p",
            ꝕ: "p",
            "ⓠ": "q",
            ｑ: "q",
            ɋ: "q",
            ꝗ: "q",
            ꝙ: "q",
            "ⓡ": "r",
            ｒ: "r",
            ŕ: "r",
            ṙ: "r",
            ř: "r",
            ȑ: "r",
            ȓ: "r",
            ṛ: "r",
            ṝ: "r",
            ŗ: "r",
            ṟ: "r",
            ɍ: "r",
            ɽ: "r",
            ꝛ: "r",
            "ꞧ": "r",
            ꞃ: "r",
            "ⓢ": "s",
            ｓ: "s",
            ß: "s",
            ś: "s",
            ṥ: "s",
            ŝ: "s",
            ṡ: "s",
            š: "s",
            ṧ: "s",
            ṣ: "s",
            ṩ: "s",
            ș: "s",
            ş: "s",
            ȿ: "s",
            "ꞩ": "s",
            ꞅ: "s",
            ẛ: "s",
            "ⓣ": "t",
            ｔ: "t",
            ṫ: "t",
            ẗ: "t",
            ť: "t",
            ṭ: "t",
            ț: "t",
            ţ: "t",
            ṱ: "t",
            ṯ: "t",
            ŧ: "t",
            ƭ: "t",
            ʈ: "t",
            ⱦ: "t",
            ꞇ: "t",
            ꜩ: "tz",
            "ⓤ": "u",
            ｕ: "u",
            ù: "u",
            ú: "u",
            û: "u",
            ũ: "u",
            ṹ: "u",
            ū: "u",
            ṻ: "u",
            ŭ: "u",
            ü: "u",
            ǜ: "u",
            ǘ: "u",
            ǖ: "u",
            ǚ: "u",
            ủ: "u",
            ů: "u",
            ű: "u",
            ǔ: "u",
            ȕ: "u",
            ȗ: "u",
            ư: "u",
            ừ: "u",
            ứ: "u",
            ữ: "u",
            ử: "u",
            ự: "u",
            ụ: "u",
            ṳ: "u",
            ų: "u",
            ṷ: "u",
            ṵ: "u",
            ʉ: "u",
            "ⓥ": "v",
            ｖ: "v",
            ṽ: "v",
            ṿ: "v",
            ʋ: "v",
            ꝟ: "v",
            ʌ: "v",
            ꝡ: "vy",
            "ⓦ": "w",
            ｗ: "w",
            ẁ: "w",
            ẃ: "w",
            ŵ: "w",
            ẇ: "w",
            ẅ: "w",
            ẘ: "w",
            ẉ: "w",
            ⱳ: "w",
            "ⓧ": "x",
            ｘ: "x",
            ẋ: "x",
            ẍ: "x",
            "ⓨ": "y",
            ｙ: "y",
            ỳ: "y",
            ý: "y",
            ŷ: "y",
            ỹ: "y",
            ȳ: "y",
            ẏ: "y",
            ÿ: "y",
            ỷ: "y",
            ẙ: "y",
            ỵ: "y",
            ƴ: "y",
            ɏ: "y",
            ỿ: "y",
            "ⓩ": "z",
            ｚ: "z",
            ź: "z",
            ẑ: "z",
            ż: "z",
            ž: "z",
            ẓ: "z",
            ẕ: "z",
            ƶ: "z",
            ȥ: "z",
            ɀ: "z",
            ⱬ: "z",
            ꝣ: "z"
        };
    l = t(document);
    s = function () {
        var t = 1;
        return function () {
            return t++
        }
    }();

    function m(e) {
        var i = t(document.createTextNode(""));
        e.before(i);
        i.before(e);
        i.remove()
    }

    function d(t) {
        var e, i, a, o;
        if (!t || t.length < 1) return t;
        e = "";
        for (i = 0, a = t.length; i < a; i++) {
            o = t.charAt(i);
            e += u[o] || o
        }
        return e
    }

    function f(t, e) {
        var i = 0,
            a = e.length;
        for (; i < a; i = i + 1) {
            if (y(t, e[i])) return i
        }
        return -1
    }

    function g() {
        var e = t(h);
        e.appendTo("body");
        var i = {
            width: e.width() - e[0].clientWidth,
            height: e.height() - e[0].clientHeight
        };
        e.remove();
        return i
    }

    function y(t, i) {
        if (t === i) return true;
        if (t === e || i === e) return false;
        if (t === null || i === null) return false;
        if (t.constructor === String) return t + "" === i + "";
        if (i.constructor === String) return i + "" === t + "";
        return false
    }

    function k(e, i) {
        var a, o, n;
        if (e === null || e.length < 1) return [];
        a = e.split(i);
        for (o = 0, n = a.length; o < n; o = o + 1) a[o] = t.trim(a[o]);
        return a
    }

    function v(t) {
        return t.outerWidth(false) - t.width()
    }

    function W(i) {
        var a = "keyup-change-value";
        i.on("keydown", function () {
            if (t.data(i, a) === e) {
                t.data(i, a, i.val())
            }
        });
        i.on("keyup", function () {
            var o = t.data(i, a);
            if (o !== e && i.val() !== o) {
                t.removeData(i, a);
                i.trigger("keyup-change")
            }
        })
    }
    l.on("mousemove", function (t) {
        p.x = t.pageX;
        p.y = t.pageY
    });

    function b(i) {
        i.on("mousemove", function (i) {
            var a = p;
            if (a === e || a.x !== i.pageX || a.y !== i.pageY) {
                t(i.target)
                    .trigger("mousemove-filtered", i)
            }
        })
    }

    function w(t, i, a) {
        a = a || e;
        var o;
        return function () {
            var e = arguments;
            window.clearTimeout(o);
            o = window.setTimeout(function () {
                i.apply(a, e)
            }, t)
        }
    }

    function C(t) {
        var e = false,
            i;
        return function () {
            if (e === false) {
                i = t();
                e = true
            }
            return i
        }
    }

    function L(t, e) {
        var i = w(t, function (t) {
            e.trigger("scroll-debounced", t)
        });
        e.on("scroll", function (t) {
            if (f(t.target, e.get()) >= 0) i(t)
        })
    }

    function S(t) {
        if (t[0] === document.activeElement) return;
        window.setTimeout(function () {
            var e = t[0],
                i = t.val()
                .length,
                a;
            t.focus();
            var o = e.offsetWidth > 0 || e.offsetHeight > 0;
            if (o && e === document.activeElement) {
                if (e.setSelectionRange) {
                    e.setSelectionRange(i, i)
                } else if (e.createTextRange) {
                    a = e.createTextRange();
                    a.collapse(false);
                    a.select()
                }
            }
        }, 0)
    }

    function T(e) {
        e = t(e)[0];
        var i = 0;
        var a = 0;
        if ("selectionStart" in e) {
            i = e.selectionStart;
            a = e.selectionEnd - i
        } else if ("selection" in document) {
            e.focus();
            var o = document.selection.createRange();
            a = document.selection.createRange()
                .text.length;
            o.moveStart("character", -e.value.length);
            i = o.text.length - a
        }
        return {
            offset: i,
            length: a
        }
    }

    function E(t) {
        t.preventDefault();
        t.stopPropagation()
    }

    function x(t) {
        t.preventDefault();
        t.stopImmediatePropagation()
    }

    function I(e) {
        if (!r) {
            var i = e[0].currentStyle || window.getComputedStyle(e[0], null);
            r = t(document.createElement("div"))
                .css({
                    position: "absolute",
                    left: "-10000px",
                    top: "-10000px",
                    display: "none",
                    fontSize: i.fontSize,
                    fontFamily: i.fontFamily,
                    fontStyle: i.fontStyle,
                    fontWeight: i.fontWeight,
                    letterSpacing: i.letterSpacing,
                    textTransform: i.textTransform,
                    whiteSpace: "nowrap"
                });
            r.attr("class", "select2-sizer");
            t("body")
                .append(r)
        }
        r.text(e.val());
        return r.width()
    }

    function U(e, i, a) {
        var o, n = [],
            s;
        o = e.attr("class");
        if (o) {
            o = "" + o;
            t(o.split(" "))
                .each2(function () {
                    if (this.indexOf("select2-") === 0) {
                        n.push(this)
                    }
                })
        }
        o = i.attr("class");
        if (o) {
            o = "" + o;
            t(o.split(" "))
                .each2(function () {
                    if (this.indexOf("select2-") !== 0) {
                        s = a(this);
                        if (s) {
                            n.push(s)
                        }
                    }
                })
        }
        e.attr("class", n.join(" "))
    }

    function P(t, e, i, a) {
        var o = d(t.toUpperCase())
            .indexOf(d(e.toUpperCase())),
            n = e.length;
        if (o < 0) {
            i.push(a(t));
            return
        }
        i.push(a(t.substring(0, o)));
        i.push("<span class='select2-match'>");
        i.push(a(t.substring(o, o + n)));
        i.push("</span>");
        i.push(a(t.substring(o + n, t.length)))
    }

    function M(t) {
        var e = {
            "\\": "&#92;",
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
            "/": "&#47;"
        };
        return String(t)
            .replace(/[&<>"'\/\\]/g, function (t) {
                return e[t]
            })
    }

    function D(i) {
        var a, o = null,
            n = i.quietMillis || 100,
            s = i.url,
            r = this;
        return function (p) {
            window.clearTimeout(a);
            a = window.setTimeout(function () {
                var a = i.data,
                    n = s,
                    l = i.transport || t.fn.select2.ajaxDefaults.transport,
                    c = {
                        type: i.type || "GET",
                        cache: i.cache || false,
                        jsonpCallback: i.jsonpCallback || e,
                        dataType: i.dataType || "json"
                    },
                    h = t.extend({}, t.fn.select2.ajaxDefaults.params, c);
                a = a ? a.call(r, p.term, p.page, p.context) : null;
                n = typeof n === "function" ? n.call(r, p.term, p.page, p.context) : n;
                if (o && typeof o.abort === "function") {
                    o.abort()
                }
                if (i.params) {
                    if (t.isFunction(i.params)) {
                        t.extend(h, i.params.call(r))
                    } else {
                        t.extend(h, i.params)
                    }
                }
                t.extend(h, {
                    url: n,
                    dataType: i.dataType,
                    data: a,
                    success: function (t) {
                        var e = i.results(t, p.page);
                        p.callback(e)
                    }
                });
                o = l.call(r, h)
            }, n)
        }
    }

    function O(e) {
        var i = e,
            a, o, n = function (t) {
                return "" + t.text
            };
        if (t.isArray(i)) {
            o = i;
            i = {
                results: o
            }
        }
        if (t.isFunction(i) === false) {
            o = i;
            i = function () {
                return o
            }
        }
        var s = i();
        if (s.text) {
            n = s.text;
            if (!t.isFunction(n)) {
                a = s.text;
                n = function (t) {
                    return t[a]
                }
            }
        }
        return function (e) {
            var a = e.term,
                o = {
                    results: []
                },
                s;
            if (a === "") {
                e.callback(i());
                return
            }
            s = function (i, o) {
                var r, p;
                i = i[0];
                if (i.children) {
                    r = {};
                    for (p in i) {
                        if (i.hasOwnProperty(p)) r[p] = i[p]
                    }
                    r.children = [];
                    t(i.children)
                        .each2(function (t, e) {
                            s(e, r.children)
                        });
                    if (r.children.length || e.matcher(a, n(r), i)) {
                        o.push(r)
                    }
                } else {
                    if (e.matcher(a, n(i), i)) {
                        o.push(i)
                    }
                }
            };
            t(i()
                    .results)
                .each2(function (t, e) {
                    s(e, o.results)
                });
            e.callback(o)
        }
    }

    function _(i) {
        var a = t.isFunction(i);
        return function (o) {
            var n = o.term,
                s = {
                    results: []
                };
            t(a ? i() : i)
                .each(function () {
                    var t = this.text !== e,
                        i = t ? this.text : this;
                    if (n === "" || o.matcher(n, i)) {
                        s.results.push(t ? this : {
                            id: this,
                            text: this
                        })
                    }
                });
            o.callback(s)
        }
    }

    function j(e, i) {
        if (t.isFunction(e)) return true;
        if (!e) return false;
        if (typeof e === "string") return true;
        throw new Error(i + " must be a string, function, or falsy value")
    }

    function A(e) {
        if (t.isFunction(e)) {
            var i = Array.prototype.slice.call(arguments, 1);
            return e.apply(null, i)
        }
        return e
    }

    function N(e) {
        var i = 0;
        t.each(e, function (t, e) {
            if (e.children) {
                i += N(e.children)
            } else {
                i++
            }
        });
        return i
    }

    function B(t, i, a, o) {
        var n = t,
            s = false,
            r, p, l, c, h;
        if (!o.createSearchChoice || !o.tokenSeparators || o.tokenSeparators.length < 1) return e;
        while (true) {
            p = -1;
            for (l = 0, c = o.tokenSeparators.length; l < c; l++) {
                h = o.tokenSeparators[l];
                p = t.indexOf(h);
                if (p >= 0) break
            }
            if (p < 0) break;
            r = t.substring(0, p);
            t = t.substring(p + h.length);
            if (r.length > 0) {
                r = o.createSearchChoice.call(this, r, i);
                if (r !== e && r !== null && o.id(r) !== e && o.id(r) !== null) {
                    s = false;
                    for (l = 0, c = i.length; l < c; l++) {
                        if (y(o.id(r), o.id(i[l]))) {
                            s = true;
                            break
                        }
                    }
                    if (!s) a(r)
                }
            }
        }
        if (n !== t) return t
    }

    function R(e, i) {
        var a = function () { };
        a.prototype = new e;
        a.prototype.constructor = a;
        a.prototype.parent = e.prototype;
        a.prototype = t.extend(a.prototype, i);
        return a
    }
    a = R(Object, {
        bind: function (t) {
            var e = this;
            return function () {
                t.apply(e, arguments)
            }
        },
        init: function (i) {
            var a, o, n = ".select2-results";
            this.opts = i = this.prepareOpts(i);
            this.id = i.id;
            if (i.element.data("select2") !== e && i.element.data("select2") !== null) {
                i.element.data("select2")
                    .destroy()
            }
            this.container = this.createContainer();
            this.liveRegion = t("<span>", {
                role: "status",
                "aria-live": "polite"
            })
                .addClass("select2-hidden-accessible")
                .appendTo(document.body);
            this.containerId = "s2id_" + (i.element.attr("id") || "autogen" + s())
                .replace(/([;&,\-\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, "\\$1");
            this.containerSelector = "#" + this.containerId;
            this.container.attr("id", this.containerId);
            this.body = C(function () {
                return i.element.closest("body")
            });
            U(this.container, this.opts.element, this.opts.adaptContainerCssClass);
            this.container.attr("style", i.element.attr("style"));
            this.container.css(A(i.containerCss));
            this.container.addClass(A(i.containerCssClass));
            this.elementTabIndex = this.opts.element.attr("tabindex");
            this.opts.element.data("select2", this)
                .attr("tabindex", "-1")
                .before(this.container)
                .on("click.select2", E);
            this.container.data("select2", this);
            this.dropdown = this.container.find(".select2-drop");
            U(this.dropdown, this.opts.element, this.opts.adaptDropdownCssClass);
            this.dropdown.addClass(A(i.dropdownCssClass));
            this.dropdown.data("select2", this);
            this.dropdown.on("click", E);
            this.results = a = this.container.find(n);
            this.search = o = this.container.find("input.select2-input");
            this.queryCount = 0;
            this.resultsPage = 0;
            this.context = null;
            this.initContainer();
            this.container.on("click", E);
            b(this.results);
            this.dropdown.on("mousemove-filtered", n, this.bind(this.highlightUnderEvent));
            this.dropdown.on("touchstart touchmove touchend", n, this.bind(function (t) {
                this._touchEvent = true;
                this.highlightUnderEvent(t)
            }));
            this.dropdown.on("touchmove", n, this.bind(this.touchMoved));
            this.dropdown.on("touchstart touchend", n, this.bind(this.clearTouchMoved));
            this.dropdown.on("click", this.bind(function (t) {
                if (this._touchEvent) {
                    this._touchEvent = false;
                    this.selectHighlighted()
                }
            }));
            L(80, this.results);
            this.dropdown.on("scroll-debounced", n, this.bind(this.loadMoreIfNeeded));
            t(this.container)
                .on("change", ".select2-input", function (t) {
                    t.stopPropagation()
                });
            t(this.dropdown)
                .on("change", ".select2-input", function (t) {
                    t.stopPropagation()
                });
            if (t.fn.mousewheel) {
                a.mousewheel(function (t, e, i, o) {
                    var n = a.scrollTop();
                    if (o > 0 && n - o <= 0) {
                        a.scrollTop(0);
                        E(t)
                    } else if (o < 0 && a.get(0)
                        .scrollHeight - a.scrollTop() + o <= a.height()) {
                        a.scrollTop(a.get(0)
                            .scrollHeight - a.height());
                        E(t)
                    }
                })
            }
            W(o);
            o.on("keyup-change input paste", this.bind(this.updateResults));
            o.on("focus", function () {
                o.addClass("select2-focused")
            });
            o.on("blur", function () {
                o.removeClass("select2-focused")
            });
            this.dropdown.on("mouseup", n, this.bind(function (e) {
                if (t(e.target)
                    .closest(".select2-result-selectable")
                    .length > 0) {
                    this.highlightUnderEvent(e);
                    this.selectHighlighted(e)
                }
            }));
            this.dropdown.on("click mouseup mousedown focusin", function (t) {
                t.stopPropagation()
            });
            this.nextSearchTerm = e;
            if (t.isFunction(this.opts.initSelection)) {
                this.initSelection();
                this.monitorSource()
            }
            if (i.maximumInputLength !== null) {
                this.search.attr("maxlength", i.maximumInputLength)
            }
            var r = i.element.prop("disabled");
            if (r === e) r = false;
            this.enable(!r);
            var p = i.element.prop("readonly");
            if (p === e) p = false;
            this.readonly(p);
            c = c || g();
            this.autofocus = i.element.prop("autofocus");
            i.element.prop("autofocus", false);
            if (this.autofocus) this.focus();
            this.search.attr("placeholder", i.searchInputPlaceholder)
        },
        destroy: function () {
            var t = this.opts.element,
                i = t.data("select2");
            this.close();
            if (this.propertyObserver) {
                delete this.propertyObserver;
                this.propertyObserver = null
            }
            if (i !== e) {
                i.container.remove();
                i.liveRegion.remove();
                i.dropdown.remove();
                t.removeClass("select2-offscreen")
                    .removeData("select2")
                    .off(".select2")
                    .prop("autofocus", this.autofocus || false);
                if (this.elementTabIndex) {
                    t.attr({
                        tabindex: this.elementTabIndex
                    })
                } else {
                    t.removeAttr("tabindex")
                }
                t.show()
            }
        },
        optionToData: function (t) {
            if (t.is("option")) {
                return {
                    id: t.prop("value"),
                    text: t.text(),
                    element: t.get(),
                    css: t.attr("class"),
                    disabled: t.prop("disabled"),
                    locked: y(t.attr("locked"), "locked") || y(t.data("locked"), true)
                }
            } else if (t.is("optgroup")) {
                return {
                    text: t.attr("label"),
                    children: [],
                    element: t.get(),
                    css: t.attr("class")
                }
            }
        },
        prepareOpts: function (i) {
            var a, o, n, r, p = this;
            a = i.element;
            if (a.get(0)
                .tagName.toLowerCase() === "select") {
                this.select = o = i.element
            }
            if (o) {
                t.each(["id", "multiple", "ajax", "query", "createSearchChoice", "initSelection", "data", "tags"], function () {
                    if (this in i) {
                        throw new Error("Option '" + this + "' is not allowed for Select2 when attached to a <select> element.")
                    }
                })
            }
            i = t.extend({}, {
                populateResults: function (a, o, n) {
                    var r, l = this.opts.id,
                        c = this.liveRegion;
                    r = function (a, o, h) {
                        var u, m, d, f, g, y, k, v, W, b;
                        a = i.sortResults(a, o, n);
                        for (u = 0, m = a.length; u < m; u = u + 1) {
                            d = a[u];
                            g = d.disabled === true;
                            f = !g && l(d) !== e;
                            y = d.children && d.children.length > 0;
                            k = t("<li></li>");
                            k.addClass("select2-results-dept-" + h);
                            k.addClass("select2-result");
                            k.addClass(f ? "select2-result-selectable" : "select2-result-unselectable");
                            if (g) {
                                k.addClass("select2-disabled")
                            }
                            if (y) {
                                k.addClass("select2-result-with-children")
                            }
                            k.addClass(p.opts.formatResultCssClass(d));
                            k.attr("role", "presentation");
                            v = t(document.createElement("div"));
                            v.addClass("select2-result-label");
                            v.attr("id", "select2-result-label-" + s());
                            v.attr("role", "option");
                            b = i.formatResult(d, v, n, p.opts.escapeMarkup);
                            if (b !== e) {
                                v.html(b);
                                k.append(v)
                            }
                            if (y) {
                                W = t("<ul></ul>");
                                W.addClass("select2-result-sub");
                                r(d.children, W, h + 1);
                                k.append(W)
                            }
                            k.data("select2-data", d);
                            o.append(k)
                        }
                        c.text(i.formatMatches(a.length))
                    };
                    r(o, a, 0)
                }
            }, t.fn.select2.defaults, i);
            if (typeof i.id !== "function") {
                n = i.id;
                i.id = function (t) {
                    return t[n]
                }
            }
            if (t.isArray(i.element.data("select2Tags"))) {
                if ("tags" in i) {
                    throw "tags specified as both an attribute 'data-select2-tags' and in options of Select2 " + i.element.attr("id")
                }
                i.tags = i.element.data("select2Tags")
            }
            if (o) {
                i.query = this.bind(function (t) {
                    var i = {
                        results: [],
                        more: false
                    },
                        o = t.term,
                        n, s, r;
                    r = function (e, i) {
                        var a;
                        if (e.is("option")) {
                            if (t.matcher(o, e.text(), e)) {
                                i.push(p.optionToData(e))
                            }
                        } else if (e.is("optgroup")) {
                            a = p.optionToData(e);
                            e.children()
                                .each2(function (t, e) {
                                    r(e, a.children)
                                });
                            if (a.children.length > 0) {
                                i.push(a)
                            }
                        }
                    };
                    n = a.children();
                    if (this.getPlaceholder() !== e && n.length > 0) {
                        s = this.getPlaceholderOption();
                        if (s) {
                            n = n.not(s)
                        }
                    }
                    n.each2(function (t, e) {
                        r(e, i.results)
                    });
                    t.callback(i)
                });
                i.id = function (t) {
                    return t.id
                }
            } else {
                if (!("query" in i)) {
                    if ("ajax" in i) {
                        r = i.element.data("ajax-url");
                        if (r && r.length > 0) {
                            i.ajax.url = r
                        }
                        i.query = D.call(i.element, i.ajax)
                    } else if ("data" in i) {
                        i.query = O(i.data)
                    } else if ("tags" in i) {
                        i.query = _(i.tags);
                        if (i.createSearchChoice === e) {
                            i.createSearchChoice = function (e) {
                                return {
                                    id: t.trim(e),
                                    text: t.trim(e)
                                }
                            }
                        }
                        if (i.initSelection === e) {
                            i.initSelection = function (e, a) {
                                var o = [];
                                t(k(e.val(), i.separator))
                                    .each(function () {
                                        var e = {
                                            id: this,
                                            text: this
                                        },
                                            a = i.tags;
                                        if (t.isFunction(a)) a = a();
                                        t(a)
                                            .each(function () {
                                                if (y(this.id, e.id)) {
                                                    e = this;
                                                    return false
                                                }
                                            });
                                        o.push(e)
                                    });
                                a(o)
                            }
                        }
                    }
                }
            }
            if (typeof i.query !== "function") {
                throw "query function not defined for Select2 " + i.element.attr("id")
            }
            if (i.createSearchChoicePosition === "top") {
                i.createSearchChoicePosition = function (t, e) {
                    t.unshift(e)
                }
            } else if (i.createSearchChoicePosition === "bottom") {
                i.createSearchChoicePosition = function (t, e) {
                    t.push(e)
                }
            } else if (typeof i.createSearchChoicePosition !== "function") {
                throw "invalid createSearchChoicePosition option must be 'top', 'bottom' or a custom function"
            }
            return i
        },
        monitorSource: function () {
            var t = this.opts.element,
                i, a;
            t.on("change.select2", this.bind(function (t) {
                if (this.opts.element.data("select2-change-triggered") !== true) {
                    this.initSelection()
                }
            }));
            i = this.bind(function () {
                var i = t.prop("disabled");
                if (i === e) i = false;
                this.enable(!i);
                var a = t.prop("readonly");
                if (a === e) a = false;
                this.readonly(a);
                U(this.container, this.opts.element, this.opts.adaptContainerCssClass);
                this.container.addClass(A(this.opts.containerCssClass));
                U(this.dropdown, this.opts.element, this.opts.adaptDropdownCssClass);
                this.dropdown.addClass(A(this.opts.dropdownCssClass))
            });
            t.on("propertychange.select2", i);
            if (this.mutationCallback === e) {
                this.mutationCallback = function (t) {
                    t.forEach(i)
                }
            }
            a = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver;
            if (a !== e) {
                if (this.propertyObserver) {
                    delete this.propertyObserver;
                    this.propertyObserver = null
                }
                this.propertyObserver = new a(this.mutationCallback);
                this.propertyObserver.observe(t.get(0), {
                    attributes: true,
                    subtree: false
                })
            }
        },
        triggerSelect: function (e) {
            var i = t.Event("select2-selecting", {
                val: this.id(e),
                object: e
            });
            this.opts.element.trigger(i);
            return !i.isDefaultPrevented()
        },
        triggerChange: function (e) {
            e = e || {};
            e = t.extend({}, e, {
                type: "change",
                val: this.val()
            });
            this.opts.element.data("select2-change-triggered", true);
            this.opts.element.trigger(e);
            this.opts.element.data("select2-change-triggered", false);
            this.opts.element.click();
            if (this.opts.blurOnChange) this.opts.element.blur()
        },
        isInterfaceEnabled: function () {
            return this.enabledInterface === true
        },
        enableInterface: function () {
            var t = this._enabled && !this._readonly,
                e = !t;
            if (t === this.enabledInterface) return false;
            this.container.toggleClass("select2-container-disabled", e);
            this.close();
            this.enabledInterface = t;
            return true
        },
        enable: function (t) {
            if (t === e) t = true;
            if (this._enabled === t) return;
            this._enabled = t;
            this.opts.element.prop("disabled", !t);
            this.enableInterface()
        },
        disable: function () {
            this.enable(false)
        },
        readonly: function (t) {
            if (t === e) t = false;
            if (this._readonly === t) return;
            this._readonly = t;
            this.opts.element.prop("readonly", t);
            this.enableInterface()
        },
        opened: function () {
            return this.container.hasClass("select2-dropdown-open")
        },
        positionDropdown: function () {
            var e = this.dropdown,
                i = this.container.offset(),
                a = this.container.outerHeight(false),
                o = this.container.outerWidth(false),
                n = e.outerHeight(false),
                s = t(window),
                r = s.width(),
                p = s.height(),
                l = s.scrollLeft() + r,
                h = s.scrollTop() + p,
                u = i.top + a,
                m = i.left,
                d = u + n <= h,
                f = i.top - n >= s.scrollTop(),
                g = e.outerWidth(false),
                y = m + g <= l,
                k = e.hasClass("select2-drop-above"),
                v, W, b, w, C;
            if (k) {
                W = true;
                if (!f && d) {
                    b = true;
                    W = false
                }
            } else {
                W = false;
                if (!d && f) {
                    b = true;
                    W = true
                }
            }
            if (b) {
                e.hide();
                i = this.container.offset();
                a = this.container.outerHeight(false);
                o = this.container.outerWidth(false);
                n = e.outerHeight(false);
                l = s.scrollLeft() + r;
                h = s.scrollTop() + p;
                u = i.top + a;
                m = i.left;
                g = e.outerWidth(false);
                y = m + g <= l;
                e.show();
                this.focusSearch()
            }
            if (this.opts.dropdownAutoWidth) {
                C = t(".select2-results", e)[0];
                e.addClass("select2-drop-auto-width");
                e.css("width", "");
                g = e.outerWidth(false) + (C.scrollHeight === C.clientHeight ? 0 : c.width);
                g > o ? o = g : g = o;
                y = m + g <= l
            } else {
                this.container.removeClass("select2-drop-auto-width")
            }
            if (this.body()
                .css("position") !== "static") {
                v = this.body()
                    .offset();
                u -= v.top;
                m -= v.left
            }
            if (!y) {
                m = i.left + this.container.outerWidth(false) - g
            }
            w = {
                left: m,
                width: o
            };
            if (W) {
                w.top = i.top - n;
                w.bottom = "auto";
                this.container.addClass("select2-drop-above");
                e.addClass("select2-drop-above")
            } else {
                w.top = u;
                w.bottom = "auto";
                this.container.removeClass("select2-drop-above");
                e.removeClass("select2-drop-above")
            }
            w = t.extend(w, A(this.opts.dropdownCss));
            e.css(w)
        },
        shouldOpen: function () {
            var e;
            if (this.opened()) return false;
            if (this._enabled === false || this._readonly === true) return false;
            e = t.Event("select2-opening");
            this.opts.element.trigger(e);
            return !e.isDefaultPrevented()
        },
        clearDropdownAlignmentPreference: function () {
            this.container.removeClass("select2-drop-above");
            this.dropdown.removeClass("select2-drop-above")
        },
        open: function () {
            if (!this.shouldOpen()) return false;
            this.opening();
            return true
        },
        opening: function () {
            var e = this.containerId,
                i = "scroll." + e,
                a = "resize." + e,
                o = "orientationchange." + e,
                n;
            this.container.addClass("select2-dropdown-open")
                .addClass("select2-container-active");
            this.clearDropdownAlignmentPreference();
            if (this.dropdown[0] !== this.body()
                .children()
                .last()[0]) {
                this.dropdown.detach()
                    .appendTo(this.body())
            }
            n = t("#select2-drop-mask");
            if (n.length == 0) {
                n = t(document.createElement("div"));
                n.attr("id", "select2-drop-mask")
                    .attr("class", "select2-drop-mask");
                n.hide();
                n.appendTo(this.body());
                n.on("mousedown touchstart click", function (e) {
                    m(n);
                    var i = t("#select2-drop"),
                        a;
                    if (i.length > 0) {
                        a = i.data("select2");
                        if (a.opts.selectOnBlur) {
                            a.selectHighlighted({
                                noFocus: true
                            })
                        }
                        a.close();
                        e.preventDefault();
                        e.stopPropagation()
                    }
                })
            }
            if (this.dropdown.prev()[0] !== n[0]) {
                this.dropdown.before(n)
            }
            t("#select2-drop")
                .removeAttr("id");
            this.dropdown.attr("id", "select2-drop");
            n.show();
            this.positionDropdown();
            this.dropdown.show();
            this.positionDropdown();
            this.dropdown.addClass("select2-drop-active");
            var s = this;
            this.container.parents()
                .add(window)
                .each(function () {
                    t(this)
                        .on(a + " " + i + " " + o, function (t) {
                            s.positionDropdown()
                        })
                })
        },
        close: function () {
            if (!this.opened()) return;
            var e = this.containerId,
                i = "scroll." + e,
                a = "resize." + e,
                o = "orientationchange." + e;
            this.container.parents()
                .add(window)
                .each(function () {
                    t(this)
                        .off(i)
                        .off(a)
                        .off(o)
                });
            this.clearDropdownAlignmentPreference();
            t("#select2-drop-mask")
                .hide();
            this.dropdown.removeAttr("id");
            this.dropdown.hide();
            this.container.removeClass("select2-dropdown-open")
                .removeClass("select2-container-active");
            this.results.empty();
            this.clearSearch();
            this.search.removeClass("select2-active");
            this.opts.element.trigger(t.Event("select2-close"))
        },
        externalSearch: function (t) {
            this.open();
            this.search.val(t);
            this.updateResults(false)
        },
        clearSearch: function () { },
        getMaximumSelectionSize: function () {
            return A(this.opts.maximumSelectionSize)
        },
        ensureHighlightVisible: function () {
            var e = this.results,
                i, a, o, n, s, r, p;
            a = this.highlight();
            if (a < 0) return;
            if (a == 0) {
                e.scrollTop(0);
                return
            }
            i = this.findHighlightableChoices()
                .find(".select2-result-label");
            o = t(i[a]);
            n = o.offset()
                .top + o.outerHeight(true);
            if (a === i.length - 1) {
                p = e.find("li.select2-more-results");
                if (p.length > 0) {
                    n = p.offset()
                        .top + p.outerHeight(true)
                }
            }
            s = e.offset()
                .top + e.outerHeight(true);
            if (n > s) {
                e.scrollTop(e.scrollTop() + (n - s))
            }
            r = o.offset()
                .top - e.offset()
                .top;
            if (r < 0 && o.css("display") != "none") {
                e.scrollTop(e.scrollTop() + r)
            }
        },
        findHighlightableChoices: function () {
            return this.results.find(".select2-result-selectable:not(.select2-disabled):not(.select2-selected)")
        },
        moveHighlight: function (e) {
            var i = this.findHighlightableChoices(),
                a = this.highlight();
            while (a > -1 && a < i.length) {
                a += e;
                var o = t(i[a]);
                if (o.hasClass("select2-result-selectable") && !o.hasClass("select2-disabled") && !o.hasClass("select2-selected")) {
                    this.highlight(a);
                    break
                }
            }
        },
        highlight: function (e) {
            var i = this.findHighlightableChoices(),
                a, o;
            if (arguments.length === 0) {
                return f(i.filter(".select2-highlighted")[0], i.get())
            }
            if (e >= i.length) e = i.length - 1;
            if (e < 0) e = 0;
            this.removeHighlight();
            a = t(i[e]);
            a.addClass("select2-highlighted");
            this.search.attr("aria-activedescendant", a.find(".select2-result-label")
                .attr("id"));
            this.ensureHighlightVisible();
            this.liveRegion.text(a.text());
            o = a.data("select2-data");
            if (o) {
                this.opts.element.trigger({
                    type: "select2-highlight",
                    val: this.id(o),
                    choice: o
                })
            }
        },
        removeHighlight: function () {
            this.results.find(".select2-highlighted")
                .removeClass("select2-highlighted")
        },
        touchMoved: function () {
            this._touchMoved = true
        },
        clearTouchMoved: function () {
            this._touchMoved = false
        },
        countSelectableResults: function () {
            return this.findHighlightableChoices()
                .length
        },
        highlightUnderEvent: function (e) {
            var i = t(e.target)
                .closest(".select2-result-selectable");
            if (i.length > 0 && !i.is(".select2-highlighted")) {
                var a = this.findHighlightableChoices();
                this.highlight(a.index(i))
            } else if (i.length == 0) {
                this.removeHighlight()
            }
        },
        loadMoreIfNeeded: function () {
            var t = this.results,
                e = t.find("li.select2-more-results"),
                i, a = this.resultsPage + 1,
                o = this,
                n = this.search.val(),
                s = this.context;
            if (e.length === 0) return;
            i = e.offset()
                .top - t.offset()
                .top - t.height();
            if (i <= this.opts.loadMorePadding) {
                e.addClass("select2-active");
                this.opts.query({
                    element: this.opts.element,
                    term: n,
                    page: a,
                    context: s,
                    matcher: this.opts.matcher,
                    callback: this.bind(function (i) {
                        if (!o.opened()) return;
                        o.opts.populateResults.call(this, t, i.results, {
                            term: n,
                            page: a,
                            context: s
                        });
                        o.postprocessResults(i, false, false);
                        if (i.more === true) {
                            e.detach()
                                .appendTo(t)
                                .text(A(o.opts.formatLoadMore, a + 1));
                            window.setTimeout(function () {
                                o.loadMoreIfNeeded()
                            }, 10)
                        } else {
                            e.remove()
                        }
                        o.positionDropdown();
                        o.resultsPage = a;
                        o.context = i.context;
                        this.opts.element.trigger({
                            type: "select2-loaded",
                            items: i
                        })
                    })
                })
            }
        },
        tokenize: function () { },
        updateResults: function (i) {
            var a = this.search,
                o = this.results,
                n = this.opts,
                s, r = this,
                p, l = a.val(),
                c = t.data(this.container, "select2-last-term"),
                h;
            if (i !== true && c && y(l, c)) return;
            t.data(this.container, "select2-last-term", l);
            if (i !== true && (this.showSearchInput === false || !this.opened())) {
                return
            }

            function u() {
                a.removeClass("select2-active");
                r.positionDropdown();
                if (o.find(".select2-no-results,.select2-selection-limit,.select2-searching")
                    .length) {
                    r.liveRegion.text(o.text())
                } else {
                    r.liveRegion.text(r.opts.formatMatches(o.find(".select2-result-selectable")
                        .length))
                }
            }

            function m(t) {
                o.html(t);
                u()
            }
            h = ++this.queryCount;
            var d = this.getMaximumSelectionSize();
            if (d >= 1) {
                s = this.data();
                if (t.isArray(s) && s.length >= d && j(n.formatSelectionTooBig, "formatSelectionTooBig")) {
                    m("<li class='select2-selection-limit'>" + A(n.formatSelectionTooBig, d) + "</li>");
                    return
                }
            }
            if (a.val()
                .length < n.minimumInputLength) {
                if (j(n.formatInputTooShort, "formatInputTooShort")) {
                    m("<li class='select2-no-results'>" + A(n.formatInputTooShort, a.val(), n.minimumInputLength) + "</li>")
                } else {
                    m("")
                }
                if (i && this.showSearch) this.showSearch(true);
                return
            }
            if (n.maximumInputLength && a.val()
                .length > n.maximumInputLength) {
                if (j(n.formatInputTooLong, "formatInputTooLong")) {
                    m("<li class='select2-no-results'>" + A(n.formatInputTooLong, a.val(), n.maximumInputLength) + "</li>")
                } else {
                    m("")
                }
                return
            }
            if (n.formatSearching && this.findHighlightableChoices()
                .length === 0) {
                m("<li class='select2-searching'>" + A(n.formatSearching) + "</li>")
            }
            a.addClass("select2-active");
            this.removeHighlight();
            p = this.tokenize();
            if (p != e && p != null) {
                a.val(p)
            }
            this.resultsPage = 1;
            n.query({
                element: n.element,
                term: a.val(),
                page: this.resultsPage,
                context: null,
                matcher: n.matcher,
                callback: this.bind(function (s) {
                    var p;
                    if (h != this.queryCount) {
                        return
                    }
                    if (!this.opened()) {
                        this.search.removeClass("select2-active");
                        return
                    }
                    this.context = s.context === e ? null : s.context;
                    if (this.opts.createSearchChoice && a.val() !== "") {
                        p = this.opts.createSearchChoice.call(r, a.val(), s.results);
                        if (p !== e && p !== null && r.id(p) !== e && r.id(p) !== null) {
                            if (t(s.results)
                                .filter(function () {
                                    return y(r.id(this), r.id(p))
                            })
                                .length === 0) {
                                this.opts.createSearchChoicePosition(s.results, p)
                            }
                        }
                    }
                    if (s.results.length === 0 && j(n.formatNoMatches, "formatNoMatches")) {
                        m("<li class='select2-no-results'>" + A(n.formatNoMatches, a.val()) + "</li>");
                        return
                    }
                    o.empty();
                    r.opts.populateResults.call(this, o, s.results, {
                        term: a.val(),
                        page: this.resultsPage,
                        context: null
                    });
                    if (s.more === true && j(n.formatLoadMore, "formatLoadMore")) {
                        o.append("<li class='select2-more-results'>" + r.opts.escapeMarkup(A(n.formatLoadMore, this.resultsPage)) + "</li>");
                        window.setTimeout(function () {
                            r.loadMoreIfNeeded()
                        }, 10)
                    }
                    this.postprocessResults(s, i);
                    u();
                    this.opts.element.trigger({
                        type: "select2-loaded",
                        items: s
                    })
                })
            })
        },
        cancel: function () {
            this.close()
        },
        blur: function () {
            if (this.opts.selectOnBlur) this.selectHighlighted({
                noFocus: true
            });
            this.close();
            this.container.removeClass("select2-container-active");
            if (this.search[0] === document.activeElement) {
                this.search.blur()
            }
            this.clearSearch();
            this.selection.find(".select2-search-choice-focus")
                .removeClass("select2-search-choice-focus")
        },
        focusSearch: function () {
            S(this.search)
        },
        selectHighlighted: function (t) {
            if (this._touchMoved) {
                this.clearTouchMoved();
                return
            }
            var e = this.highlight(),
                i = this.results.find(".select2-highlighted"),
                a = i.closest(".select2-result")
                .data("select2-data");
            if (a) {
                this.highlight(e);
                this.onSelect(a, t)
            } else if (t && t.noFocus) {
                this.close()
            }
        },
        getPlaceholder: function () {
            var t;
            return this.opts.element.attr("placeholder") || this.opts.element.attr("data-placeholder") || this.opts.element.data("placeholder") || this.opts.placeholder || ((t = this.getPlaceholderOption()) !== e ? t.text() : e)
        },
        getPlaceholderOption: function () {
            if (this.select) {
                var i = this.select.children("option")
                    .first();
                if (this.opts.placeholderOption !== e) {
                    return this.opts.placeholderOption === "first" && i || typeof this.opts.placeholderOption === "function" && this.opts.placeholderOption(this.select)
                } else if (t.trim(i.text()) === "" && i.val() === "") {
                    return i
                }
            }
        },
        initContainerWidth: function () {
            function i() {
                var i, a, o, n, s, r;
                if (this.opts.width === "off") {
                    return null
                } else if (this.opts.width === "element") {
                    return this.opts.element.outerWidth(false) === 0 ? "auto" : this.opts.element.outerWidth(false) + "px"
                } else if (this.opts.width === "copy" || this.opts.width === "resolve") {
                    i = this.opts.element.attr("style");
                    if (i !== e) {
                        a = i.split(";");
                        for (n = 0, s = a.length; n < s; n = n + 1) {
                            r = a[n].replace(/\s/g, "");
                            o = r.match(/^width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/i);
                            if (o !== null && o.length >= 1) return o[1]
                        }
                    }
                    if (this.opts.width === "resolve") {
                        i = this.opts.element.css("width");
                        if (i.indexOf("%") > 0) return i;
                        return this.opts.element.outerWidth(false) === 0 ? "auto" : this.opts.element.outerWidth(false) + "px"
                    }
                    return null
                } else if (t.isFunction(this.opts.width)) {
                    return this.opts.width()
                } else {
                    return this.opts.width
                }
            }
            var a = i.call(this);
            if (a !== null) {
                this.container.css("width", a)
            }
        }
    });
    o = R(a, {
        createContainer: function () {
            var e = t(document.createElement("div"))
                .attr({
                    "class": "select2-container"
                })
                .html(["<a href='javascript:void(0)' class='select2-choice' tabindex='-1'>", "   <span class='select2-chosen'>&#160;</span><abbr class='select2-search-choice-close'></abbr>", "   <span class='select2-arrow' role='presentation'><b role='presentation'></b></span>", "</a>", "<label for='' class='select2-offscreen'></label>", "<input class='select2-focusser select2-offscreen' type='text' aria-haspopup='true' role='button' />", "<div class='select2-drop select2-display-none'>", "   <div class='select2-search'>", "       <label for='' class='select2-offscreen'></label>", "       <input type='text' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' class='select2-input' role='combobox' aria-expanded='true'", "       aria-autocomplete='list' />", "   </div>", "   <ul class='select2-results' role='listbox'>", "   </ul>", "</div>"].join(""));
            return e
        },
        enableInterface: function () {
            if (this.parent.enableInterface.apply(this, arguments)) {
                this.focusser.prop("disabled", !this.isInterfaceEnabled())
            }
        },
        opening: function () {
            var i, a, o;
            if (this.opts.minimumResultsForSearch >= 0) {
                this.showSearch(true)
            }
            this.parent.opening.apply(this, arguments);
            if (this.showSearchInput !== false) {
                this.search.val(this.focusser.val())
            }
            if (this.opts.shouldFocusInput(this)) {
                this.search.focus();
                i = this.search.get(0);
                if (i.createTextRange) {
                    a = i.createTextRange();
                    a.collapse(false);
                    a.select()
                } else if (i.setSelectionRange) {
                    o = this.search.val()
                        .length;
                    i.setSelectionRange(o, o)
                }
            }
            if (this.search.val() === "") {
                if (this.nextSearchTerm != e) {
                    this.search.val(this.nextSearchTerm);
                    this.search.select()
                }
            }
            this.focusser.prop("disabled", true)
                .val("");
            this.updateResults(true);
            this.opts.element.trigger(t.Event("select2-open"))
        },
        close: function () {
            if (!this.opened()) return;
            this.parent.close.apply(this, arguments);
            this.focusser.prop("disabled", false);
            if (this.opts.shouldFocusInput(this)) {
                this.focusser.focus()
            }
        },
        focus: function () {
            if (this.opened()) {
                this.close()
            } else {
                this.focusser.prop("disabled", false);
                if (this.opts.shouldFocusInput(this)) {
                    this.focusser.focus()
                }
            }
        },
        isFocused: function () {
            return this.container.hasClass("select2-container-active")
        },
        cancel: function () {
            this.parent.cancel.apply(this, arguments);
            this.focusser.prop("disabled", false);
            if (this.opts.shouldFocusInput(this)) {
                this.focusser.focus()
            }
        },
        destroy: function () {
            t("label[for='" + this.focusser.attr("id") + "']")
                .attr("for", this.opts.element.attr("id"));
            this.parent.destroy.apply(this, arguments)
        },
        initContainer: function () {
            var e, a = this.container,
                o = this.dropdown,
                n = s(),
                r;
            if (this.opts.minimumResultsForSearch < 0) {
                this.showSearch(false)
            } else {
                this.showSearch(true)
            }
            this.selection = e = a.find(".select2-choice");
            this.focusser = a.find(".select2-focusser");
            e.find(".select2-chosen")
                .attr("id", "select2-chosen-" + n);
            this.focusser.attr("aria-labelledby", "select2-chosen-" + n);
            this.results.attr("id", "select2-results-" + n);
            this.search.attr("aria-owns", "select2-results-" + n);
            this.focusser.attr("id", "s2id_autogen" + n);
            r = t("label[for='" + this.opts.element.attr("id") + "']");
            this.focusser.prev()
                .text(r.text())
                .attr("for", this.focusser.attr("id"));
            var p = this.opts.element.attr("title");
            this.opts.element.attr("title", p || r.text());
            this.focusser.attr("tabindex", this.elementTabIndex);
            this.search.attr("id", this.focusser.attr("id") + "_search");
            this.search.prev()
                .text(t("label[for='" + this.focusser.attr("id") + "']")
                    .text())
                .attr("for", this.search.attr("id"));
            this.search.on("keydown", this.bind(function (t) {
                if (!this.isInterfaceEnabled()) return;
                if (t.which === i.PAGE_UP || t.which === i.PAGE_DOWN) {
                    E(t);
                    return
                }
                switch (t.which) {
                    case i.UP:
                    case i.DOWN:
                        this.moveHighlight(t.which === i.UP ? -1 : 1);
                        E(t);
                        return;
                    case i.ENTER:
                        this.selectHighlighted();
                        E(t);
                        return;
                    case i.TAB:
                        this.selectHighlighted({
                            noFocus: true
                        });
                        return;
                    case i.ESC:
                        this.cancel(t);
                        E(t);
                        return
                }
            }));
            this.search.on("blur", this.bind(function (t) {
                if (document.activeElement === this.body()
                    .get(0)) {
                    window.setTimeout(this.bind(function () {
                        if (this.opened()) {
                            this.search.focus()
                        }
                    }), 0)
                }
            }));
            this.focusser.on("keydown", this.bind(function (t) {
                if (!this.isInterfaceEnabled()) return;
                if (t.which === i.TAB || i.isControl(t) || i.isFunctionKey(t) || t.which === i.ESC) {
                    return
                }
                if (this.opts.openOnEnter === false && t.which === i.ENTER) {
                    E(t);
                    return
                }
                if (t.which == i.DOWN || t.which == i.UP || t.which == i.ENTER && this.opts.openOnEnter) {
                    if (t.altKey || t.ctrlKey || t.shiftKey || t.metaKey) return;
                    this.open();
                    E(t);
                    return
                }
                if (t.which == i.DELETE || t.which == i.BACKSPACE) {
                    if (this.opts.allowClear) {
                        this.clear()
                    }
                    E(t);
                    return
                }
            }));
            W(this.focusser);
            this.focusser.on("keyup-change input", this.bind(function (t) {
                if (this.opts.minimumResultsForSearch >= 0) {
                    t.stopPropagation();
                    if (this.opened()) return;
                    this.open()
                }
            }));
            e.on("mousedown touchstart", "abbr", this.bind(function (t) {
                if (!this.isInterfaceEnabled()) return;
                this.clear();
                x(t);
                this.close();
                this.selection.focus()
            }));
            e.on("mousedown touchstart", this.bind(function (i) {
                m(e);
                if (!this.container.hasClass("select2-container-active")) {
                    this.opts.element.trigger(t.Event("select2-focus"))
                }
                if (this.opened()) {
                    this.close()
                } else if (this.isInterfaceEnabled()) {
                    this.open()
                }
                E(i)
            }));
            o.on("mousedown touchstart", this.bind(function () {
                if (this.opts.shouldFocusInput(this)) {
                    this.search.focus()
                }
            }));
            e.on("focus", this.bind(function (t) {
                E(t)
            }));
            this.focusser.on("focus", this.bind(function () {
                if (!this.container.hasClass("select2-container-active")) {
                    this.opts.element.trigger(t.Event("select2-focus"))
                }
                this.container.addClass("select2-container-active")
            }))
                .on("blur", this.bind(function () {
                    if (!this.opened()) {
                        this.container.removeClass("select2-container-active");
                        this.opts.element.trigger(t.Event("select2-blur"))
                    }
                }));
            this.search.on("focus", this.bind(function () {
                if (!this.container.hasClass("select2-container-active")) {
                    this.opts.element.trigger(t.Event("select2-focus"))
                }
                this.container.addClass("select2-container-active")
            }));
            this.initContainerWidth();
            this.opts.element.addClass("select2-offscreen");
            this.setPlaceholder()
        },
        clear: function (e) {
            var i = this.selection.data("select2-data");
            if (i) {
                var a = t.Event("select2-clearing");
                this.opts.element.trigger(a);
                if (a.isDefaultPrevented()) {
                    return
                }
                var o = this.getPlaceholderOption();
                this.opts.element.val(o ? o.val() : "");
                this.selection.find(".select2-chosen")
                    .empty();
                this.selection.removeData("select2-data");
                this.setPlaceholder();
                if (e !== false) {
                    this.opts.element.trigger({
                        type: "select2-removed",
                        val: this.id(i),
                        choice: i
                    });
                    this.triggerChange({
                        removed: i
                    })
                }
            }
        },
        initSelection: function () {
            var t;
            if (this.isPlaceholderOptionSelected()) {
                this.updateSelection(null);
                this.close();
                this.setPlaceholder()
            } else {
                var i = this;
                this.opts.initSelection.call(null, this.opts.element, function (t) {
                    if (t !== e && t !== null) {
                        i.updateSelection(t);
                        i.close();
                        i.setPlaceholder();
                        i.nextSearchTerm = i.opts.nextSearchTerm(t, i.search.val())
                    }
                })
            }
        },
        isPlaceholderOptionSelected: function () {
            var t;
            if (this.getPlaceholder() === e) return false;
            return (t = this.getPlaceholderOption()) !== e && t.prop("selected") || this.opts.element.val() === "" || this.opts.element.val() === e || this.opts.element.val() === null
        },
        prepareOpts: function () {
            var e = this.parent.prepareOpts.apply(this, arguments),
                i = this;
            if (e.element.get(0)
                .tagName.toLowerCase() === "select") {
                e.initSelection = function (t, e) {
                    var a = t.find("option")
                        .filter(function () {
                            return this.selected && !this.disabled
                        });
                    e(i.optionToData(a))
                }
            } else if ("data" in e) {
                e.initSelection = e.initSelection || function (i, a) {
                    var o = i.val();
                    var n = null;
                    e.query({
                        matcher: function (t, i, a) {
                            var s = y(o, e.id(a));
                            if (s) {
                                n = a
                            }
                            return s
                        },
                        callback: !t.isFunction(a) ? t.noop : function () {
                            a(n)
                        }
                    })
                }
            }
            return e
        },
        getPlaceholder: function () {
            if (this.select) {
                if (this.getPlaceholderOption() === e) {
                    return e
                }
            }
            return this.parent.getPlaceholder.apply(this, arguments)
        },
        setPlaceholder: function () {
            var t = this.getPlaceholder();
            if (this.isPlaceholderOptionSelected() && t !== e) {
                if (this.select && this.getPlaceholderOption() === e) return;
                this.selection.find(".select2-chosen")
                    .html(this.opts.escapeMarkup(t));
                this.selection.addClass("select2-default");
                this.container.removeClass("select2-allowclear")
            }
        },
        postprocessResults: function (t, e, i) {
            var a = 0,
                o = this,
                n = true;
            this.findHighlightableChoices()
                .each2(function (t, e) {
                    if (y(o.id(e.data("select2-data")), o.opts.element.val())) {
                        a = t;
                        return false
                    }
                });
            if (i !== false) {
                if (e === true && a >= 0) {
                    this.highlight(a)
                } else {
                    this.highlight(0)
                }
            }
            if (e === true) {
                var s = this.opts.minimumResultsForSearch;
                if (s >= 0) {
                    this.showSearch(N(t.results) >= s)
                }
            }
        },
        showSearch: function (e) {
            if (this.showSearchInput === e) return;
            this.showSearchInput = e;
            this.dropdown.find(".select2-search")
                .toggleClass("select2-search-hidden", !e);
            this.dropdown.find(".select2-search")
                .toggleClass("select2-offscreen", !e);
            t(this.dropdown, this.container)
                .toggleClass("select2-with-searchbox", e)
        },
        onSelect: function (t, e) {
            if (!this.triggerSelect(t)) {
                return
            }
            var i = this.opts.element.val(),
                a = this.data();
            this.opts.element.val(this.id(t));
            this.updateSelection(t);
            this.opts.element.trigger({
                type: "select2-selected",
                val: this.id(t),
                choice: t
            });
            this.nextSearchTerm = this.opts.nextSearchTerm(t, this.search.val());
            this.close();
            if ((!e || !e.noFocus) && this.opts.shouldFocusInput(this)) {
                this.focusser.focus()
            }
            if (!y(i, this.id(t))) {
                this.triggerChange({
                    added: t,
                    removed: a
                })
            }
        },
        updateSelection: function (t) {
            var i = this.selection.find(".select2-chosen"),
                a, o;
            this.selection.data("select2-data", t);
            i.empty();
            if (t !== null) {
                a = this.opts.formatSelection(t, i, this.opts.escapeMarkup)
            }
            if (a !== e) {
                i.append(a)
            }
            o = this.opts.formatSelectionCssClass(t, i);
            if (o !== e) {
                i.addClass(o)
            }
            this.selection.removeClass("select2-default");
            if (this.opts.allowClear && this.getPlaceholder() !== e) {
                this.container.addClass("select2-allowclear")
            }
        },
        val: function () {
            var t, i = false,
                a = null,
                o = this,
                n = this.data();
            if (arguments.length === 0) {
                return this.opts.element.val()
            }
            t = arguments[0];
            if (arguments.length > 1) {
                i = arguments[1]
            }
            if (this.select) {
                this.select.val(t)
                    .find("option")
                    .filter(function () {
                        return this.selected
                    })
                    .each2(function (t, e) {
                        a = o.optionToData(e);
                        return false
                    });
                this.updateSelection(a);
                this.setPlaceholder();
                if (i) {
                    this.triggerChange({
                        added: a,
                        removed: n
                    })
                }
            } else {
                if (!t && t !== 0) {
                    this.clear(i);
                    return
                }
                if (this.opts.initSelection === e) {
                    throw new Error("cannot call val() if initSelection() is not defined")
                }
                this.opts.element.val(t);
                this.opts.initSelection(this.opts.element, function (t) {
                    o.opts.element.val(!t ? "" : o.id(t));
                    o.updateSelection(t);
                    o.setPlaceholder();
                    if (i) {
                        o.triggerChange({
                            added: t,
                            removed: n
                        })
                    }
                })
            }
        },
        clearSearch: function () {
            this.search.val("");
            this.focusser.val("")
        },
        data: function (t) {
            var i, a = false;
            if (arguments.length === 0) {
                i = this.selection.data("select2-data");
                if (i == e) i = null;
                return i
            } else {
                if (arguments.length > 1) {
                    a = arguments[1]
                }
                if (!t) {
                    this.clear(a)
                } else {
                    i = this.data();
                    this.opts.element.val(!t ? "" : this.id(t));
                    this.updateSelection(t);
                    if (a) {
                        this.triggerChange({
                            added: t,
                            removed: i
                        })
                    }
                }
            }
        }
    });
    n = R(a, {
        createContainer: function () {
            var e = t(document.createElement("div"))
                .attr({
                    "class": "select2-container select2-container-multi"
                })
                .html(["<ul class='select2-choices'>", "  <li class='select2-search-field'>", "    <label for='' class='select2-offscreen'></label>", "    <input type='text' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' class='select2-input'>", "  </li>", "</ul>", "<div class='select2-drop select2-drop-multi select2-display-none'>", "   <ul class='select2-results'>", "   </ul>", "</div>"].join(""));
            return e
        },
        prepareOpts: function () {
            var e = this.parent.prepareOpts.apply(this, arguments),
                i = this;
            if (e.element.get(0)
                .tagName.toLowerCase() === "select") {
                e.initSelection = function (t, e) {
                    var a = [];
                    t.find("option")
                        .filter(function () {
                            return this.selected && !this.disabled
                        })
                        .each2(function (t, e) {
                            a.push(i.optionToData(e))
                        });
                    e(a)
                }
            } else if ("data" in e) {
                e.initSelection = e.initSelection || function (i, a) {
                    var o = k(i.val(), e.separator);
                    var n = [];
                    e.query({
                        matcher: function (i, a, s) {
                            var r = t.grep(o, function (t) {
                                return y(t, e.id(s))
                            })
                                .length;
                            if (r) {
                                n.push(s)
                            }
                            return r
                        },
                        callback: !t.isFunction(a) ? t.noop : function () {
                            var t = [];
                            for (var i = 0; i < o.length; i++) {
                                var s = o[i];
                                for (var r = 0; r < n.length; r++) {
                                    var p = n[r];
                                    if (y(s, e.id(p))) {
                                        t.push(p);
                                        n.splice(r, 1);
                                        break
                                    }
                                }
                            }
                            a(t)
                        }
                    })
                }
            }
            return e
        },
        selectChoice: function (t) {
            var e = this.container.find(".select2-search-choice-focus");
            if (e.length && t && t[0] == e[0]) { } else {
                if (e.length) {
                    this.opts.element.trigger("choice-deselected", e)
                }
                e.removeClass("select2-search-choice-focus");
                if (t && t.length) {
                    this.close();
                    t.addClass("select2-search-choice-focus");
                    this.opts.element.trigger("choice-selected", t)
                }
            }
        },
        destroy: function () {
            t("label[for='" + this.search.attr("id") + "']")
                .attr("for", this.opts.element.attr("id"));
            this.parent.destroy.apply(this, arguments)
        },
        initContainer: function () {
            var e = ".select2-choices",
                a;
            this.searchContainer = this.container.find(".select2-search-field");
            this.selection = a = this.container.find(e);
            var o = this;
            this.selection.on("click", ".select2-search-choice:not(.select2-locked)", function (e) {
                o.search[0].focus();
                o.selectChoice(t(this))
            });
            this.search.attr("id", "s2id_autogen" + s());
            this.search.prev()
                .text(t("label[for='" + this.opts.element.attr("id") + "']")
                    .text())
                .attr("for", this.search.attr("id"));
            this.search.on("input paste", this.bind(function () {
                if (!this.isInterfaceEnabled()) return;
                if (!this.opened()) {
                    this.open()
                }
            }));
            this.search.attr("tabindex", this.elementTabIndex);
            this.keydowns = 0;
            this.search.on("keydown", this.bind(function (t) {
                if (!this.isInterfaceEnabled()) return;
                ++this.keydowns;
                var e = a.find(".select2-search-choice-focus");
                var o = e.prev(".select2-search-choice:not(.select2-locked)");
                var n = e.next(".select2-search-choice:not(.select2-locked)");
                var s = T(this.search);
                if (e.length && (t.which == i.LEFT || t.which == i.RIGHT || t.which == i.BACKSPACE || t.which == i.DELETE || t.which == i.ENTER)) {
                    var r = e;
                    if (t.which == i.LEFT && o.length) {
                        r = o
                    } else if (t.which == i.RIGHT) {
                        r = n.length ? n : null
                    } else if (t.which === i.BACKSPACE) {
                        if (this.unselect(e.first())) {
                            this.search.width(10);
                            r = o.length ? o : n
                        }
                    } else if (t.which == i.DELETE) {
                        if (this.unselect(e.first())) {
                            this.search.width(10);
                            r = n.length ? n : null
                        }
                    } else if (t.which == i.ENTER) {
                        r = null
                    }
                    this.selectChoice(r);
                    E(t);
                    if (!r || !r.length) {
                        this.open()
                    }
                    return
                } else if ((t.which === i.BACKSPACE && this.keydowns == 1 || t.which == i.LEFT) && (s.offset == 0 && !s.length)) {
                    this.selectChoice(a.find(".select2-search-choice:not(.select2-locked)")
                        .last());
                    E(t);
                    return
                } else {
                    this.selectChoice(null)
                }
                if (this.opened()) {
                    switch (t.which) {
                        case i.UP:
                        case i.DOWN:
                            this.moveHighlight(t.which === i.UP ? -1 : 1);
                            E(t);
                            return;
                        case i.ENTER:
                            this.selectHighlighted();
                            E(t);
                            return;
                        case i.TAB:
                            this.selectHighlighted({
                                noFocus: true
                            });
                            this.close();
                            return;
                        case i.ESC:
                            this.cancel(t);
                            E(t);
                            return
                    }
                }
                if (t.which === i.TAB || i.isControl(t) || i.isFunctionKey(t) || t.which === i.BACKSPACE || t.which === i.ESC) {
                    return
                }
                if (t.which === i.ENTER) {
                    if (this.opts.openOnEnter === false) {
                        return
                    } else if (t.altKey || t.ctrlKey || t.shiftKey || t.metaKey) {
                        return
                    }
                }
                this.open();
                if (t.which === i.PAGE_UP || t.which === i.PAGE_DOWN) {
                    E(t)
                }
                if (t.which === i.ENTER) {
                    E(t)
                }
            }));
            this.search.on("keyup", this.bind(function (t) {
                this.keydowns = 0;
                this.resizeSearch()
            }));
            this.search.on("blur", this.bind(function (e) {
                this.container.removeClass("select2-container-active");
                this.search.removeClass("select2-focused");
                this.selectChoice(null);
                if (!this.opened()) this.clearSearch();
                e.stopImmediatePropagation();
                this.opts.element.trigger(t.Event("select2-blur"))
            }));
            this.container.on("click", e, this.bind(function (e) {
                if (!this.isInterfaceEnabled()) return;
                if (t(e.target)
                    .closest(".select2-search-choice")
                    .length > 0) {
                    return
                }
                this.selectChoice(null);
                this.clearPlaceholder();
                if (!this.container.hasClass("select2-container-active")) {
                    this.opts.element.trigger(t.Event("select2-focus"))
                }
                this.open();
                this.focusSearch();
                e.preventDefault()
            }));
            this.container.on("focus", e, this.bind(function () {
                if (!this.isInterfaceEnabled()) return;
                if (!this.container.hasClass("select2-container-active")) {
                    this.opts.element.trigger(t.Event("select2-focus"))
                }
                this.container.addClass("select2-container-active");
                this.dropdown.addClass("select2-drop-active");
                this.clearPlaceholder()
            }));
            this.initContainerWidth();
            this.opts.element.addClass("select2-offscreen");
            this.clearSearch()
        },
        enableInterface: function () {
            if (this.parent.enableInterface.apply(this, arguments)) {
                this.search.prop("disabled", !this.isInterfaceEnabled())
            }
        },
        initSelection: function () {
            var t;
            if (this.opts.element.val() === "" && this.opts.element.text() === "") {
                this.updateSelection([]);
                this.close();
                this.clearSearch()
            }
            if (this.select || this.opts.element.val() !== "") {
                var i = this;
                this.opts.initSelection.call(null, this.opts.element, function (t) {
                    if (t !== e && t !== null) {
                        i.updateSelection(t);
                        i.close();
                        i.clearSearch()
                    }
                })
            }
        },
        clearSearch: function () {
            var t = this.getPlaceholder(),
                i = this.getMaxSearchWidth();
            if (t !== e && this.getVal()
                .length === 0 && this.search.hasClass("select2-focused") === false) {
                this.search.val(t)
                    .addClass("select2-default");
                this.search.width(i > 0 ? i : this.container.css("width"))
            } else {
                this.search.val("")
                    .width(10)
            }
        },
        clearPlaceholder: function () {
            if (this.search.hasClass("select2-default")) {
                this.search.val("")
                    .removeClass("select2-default")
            }
        },
        opening: function () {
            this.clearPlaceholder();
            this.resizeSearch();
            this.parent.opening.apply(this, arguments);
            this.focusSearch();
            if (this.search.val() === "") {
                if (this.nextSearchTerm != e) {
                    this.search.val(this.nextSearchTerm);
                    this.search.select()
                }
            }
            this.updateResults(true);
            if (this.opts.shouldFocusInput(this)) {
                this.search.focus()
            }
            this.opts.element.trigger(t.Event("select2-open"))
        },
        close: function () {
            if (!this.opened()) return;
            this.parent.close.apply(this, arguments)
        },
        focus: function () {
            this.close();
            this.search.focus()
        },
        isFocused: function () {
            return this.search.hasClass("select2-focused")
        },
        updateSelection: function (e) {
            var i = [],
                a = [],
                o = this;
            t(e)
                .each(function () {
                    if (f(o.id(this), i) < 0) {
                        i.push(o.id(this));
                        a.push(this)
                    }
                });
            e = a;
            this.selection.find(".select2-search-choice")
                .remove();
            t(e)
                .each(function () {
                    o.addSelectedChoice(this)
                });
            o.postprocessResults()
        },
        tokenize: function () {
            var t = this.search.val();
            t = this.opts.tokenizer.call(this, t, this.data(), this.bind(this.onSelect), this.opts);
            if (t != null && t != e) {
                this.search.val(t);
                if (t.length > 0) {
                    this.open()
                }
            }
        },
        onSelect: function (t, i) {
            if (!this.triggerSelect(t)) {
                return
            }
            this.addSelectedChoice(t);
            this.opts.element.trigger({
                type: "selected",
                val: this.id(t),
                choice: t
            });
            this.nextSearchTerm = this.opts.nextSearchTerm(t, this.search.val());
            this.clearSearch();
            this.updateResults();
            if (this.select || !this.opts.closeOnSelect) this.postprocessResults(t, false, this.opts.closeOnSelect === true);
            if (this.opts.closeOnSelect) {
                this.close();
                this.search.width(10)
            } else {
                if (this.countSelectableResults() > 0) {
                    this.search.width(10);
                    this.resizeSearch();
                    if (this.getMaximumSelectionSize() > 0 && this.val()
                        .length >= this.getMaximumSelectionSize()) {
                        this.updateResults(true)
                    } else {
                        if (this.nextSearchTerm != e) {
                            this.search.val(this.nextSearchTerm);
                            this.updateResults();
                            this.search.select()
                        }
                    }
                    this.positionDropdown()
                } else {
                    this.close();
                    this.search.width(10)
                }
            }
            this.triggerChange({
                added: t
            });
            if (!i || !i.noFocus) this.focusSearch()
        },
        cancel: function () {
            this.close();
            this.focusSearch()
        },
        addSelectedChoice: function (i) {
            var a = !i.locked,
                o = t("<li class='select2-search-choice'>" + "    <div></div>" + "    <a href='#' class='select2-search-choice-close' tabindex='-1'></a>" + "</li>"),
                n = t("<li class='select2-search-choice select2-locked'>" + "<div></div>" + "</li>");
            var s = a ? o : n,
                r = this.id(i),
                p = this.getVal(),
                l, c;
            l = this.opts.formatSelection(i, s.find("div"), this.opts.escapeMarkup);
            if (l != e) {
                s.find("div")
                    .replaceWith("<div>" + l + "</div>")
            }
            c = this.opts.formatSelectionCssClass(i, s.find("div"));
            if (c != e) {
                s.addClass(c)
            }
            if (a) {
                s.find(".select2-search-choice-close")
                    .on("mousedown", E)
                    .on("click dblclick", this.bind(function (e) {
                        if (!this.isInterfaceEnabled()) return;
                        this.unselect(t(e.target));
                        this.selection.find(".select2-search-choice-focus")
                            .removeClass("select2-search-choice-focus");
                        E(e);
                        this.close();
                        this.focusSearch()
                    }))
                    .on("focus", this.bind(function () {
                        if (!this.isInterfaceEnabled()) return;
                        this.container.addClass("select2-container-active");
                        this.dropdown.addClass("select2-drop-active")
                    }))
            }
            s.data("select2-data", i);
            s.insertBefore(this.searchContainer);
            p.push(r);
            this.setVal(p)
        },
        unselect: function (e) {
            var i = this.getVal(),
                a, o;
            e = e.closest(".select2-search-choice");
            if (e.length === 0) {
                throw "Invalid argument: " + e + ". Must be .select2-search-choice"
            }
            a = e.data("select2-data");
            if (!a) {
                return
            }
            var n = t.Event("select2-removing");
            n.val = this.id(a);
            n.choice = a;
            this.opts.element.trigger(n);
            if (n.isDefaultPrevented()) {
                return false
            }
            while ((o = f(this.id(a), i)) >= 0) {
                i.splice(o, 1);
                this.setVal(i);
                if (this.select) this.postprocessResults()
            }
            e.remove();
            this.opts.element.trigger({
                type: "select2-removed",
                val: this.id(a),
                choice: a
            });
            this.triggerChange({
                removed: a
            });
            return true
        },
        postprocessResults: function (t, e, i) {
            var a = this.getVal(),
                o = this.results.find(".select2-result"),
                n = this.results.find(".select2-result-with-children"),
                s = this;
            o.each2(function (t, e) {
                var i = s.id(e.data("select2-data"));
                if (f(i, a) >= 0) {
                    e.addClass("select2-selected");
                    e.find(".select2-result-selectable")
                        .addClass("select2-selected")
                }
            });
            n.each2(function (t, e) {
                if (!e.is(".select2-result-selectable") && e.find(".select2-result-selectable:not(.select2-selected)")
                    .length === 0) {
                    e.addClass("select2-selected")
                }
            });
            if (this.highlight() == -1 && i !== false) {
                s.highlight(0)
            }
            if (!this.opts.createSearchChoice && !o.filter(".select2-result:not(.select2-selected)")
                .length > 0) {
                if (!t || t && !t.more && this.results.find(".select2-no-results")
                    .length === 0) {
                    if (j(s.opts.formatNoMatches, "formatNoMatches")) {
                        this.results.append("<li class='select2-no-results'>" + A(s.opts.formatNoMatches, s.search.val()) + "</li>")
                    }
                }
            }
        },
        getMaxSearchWidth: function () {
            return this.selection.width() - v(this.search)
        },
        resizeSearch: function () {
            var t, e, i, a, o, n = v(this.search);
            t = I(this.search) + 10;
            e = this.search.offset()
                .left;
            i = this.selection.width();
            a = this.selection.offset()
                .left;
            o = i - (e - a) - n;
            if (o < t) {
                o = i - n
            }
            if (o < 40) {
                o = i - n
            }
            if (o <= 0) {
                o = t
            }
            this.search.width(Math.floor(o))
        },
        getVal: function () {
            var t;
            if (this.select) {
                t = this.select.val();
                return t === null ? [] : t
            } else {
                t = this.opts.element.val();
                return k(t, this.opts.separator)
            }
        },
        setVal: function (e) {
            var i;
            if (this.select) {
                this.select.val(e)
            } else {
                i = [];
                t(e)
                    .each(function () {
                        if (f(this, i) < 0) i.push(this)
                    });
                this.opts.element.val(i.length === 0 ? "" : i.join(this.opts.separator))
            }
        },
        buildChangeDetails: function (t, e) {
            var e = e.slice(0),
                t = t.slice(0);
            for (var i = 0; i < e.length; i++) {
                for (var a = 0; a < t.length; a++) {
                    if (y(this.opts.id(e[i]), this.opts.id(t[a]))) {
                        e.splice(i, 1);
                        if (i > 0) {
                            i--
                        }
                        t.splice(a, 1);
                        a--
                    }
                }
            }
            return {
                added: e,
                removed: t
            }
        },
        val: function (i, a) {
            var o, n = this;
            if (arguments.length === 0) {
                return this.getVal()
            }
            o = this.data();
            if (!o.length) o = [];
            if (!i && i !== 0) {
                this.opts.element.val("");
                this.updateSelection([]);
                this.clearSearch();
                if (a) {
                    this.triggerChange({
                        added: this.data(),
                        removed: o
                    })
                }
                return
            }
            this.setVal(i);
            if (this.select) {
                this.opts.initSelection(this.select, this.bind(this.updateSelection));
                if (a) {
                    this.triggerChange(this.buildChangeDetails(o, this.data()))
                }
            } else {
                if (this.opts.initSelection === e) {
                    throw new Error("val() cannot be called if initSelection() is not defined")
                }
                this.opts.initSelection(this.opts.element, function (e) {
                    var i = t.map(e, n.id);
                    n.setVal(i);
                    n.updateSelection(e);
                    n.clearSearch();
                    if (a) {
                        n.triggerChange(n.buildChangeDetails(o, n.data()))
                    }
                })
            }
            this.clearSearch()
        },
        onSortStart: function () {
            if (this.select) {
                throw new Error("Sorting of elements is not supported when attached to <select>. Attach to <input type='hidden'/> instead.")
            }
            this.search.width(0);
            this.searchContainer.hide()
        },
        onSortEnd: function () {
            var e = [],
                i = this;
            this.searchContainer.show();
            this.searchContainer.appendTo(this.searchContainer.parent());
            this.resizeSearch();
            this.selection.find(".select2-search-choice")
                .each(function () {
                    e.push(i.opts.id(t(this)
                        .data("select2-data")))
                });
            this.setVal(e);
            this.triggerChange()
        },
        data: function (e, i) {
            var a = this,
                o, n;
            if (arguments.length === 0) {
                return this.selection.children(".select2-search-choice")
                    .map(function () {
                        return t(this)
                            .data("select2-data")
                    })
                    .get()
            } else {
                n = this.data();
                if (!e) {
                    e = []
                }
                o = t.map(e, function (t) {
                    return a.opts.id(t)
                });
                this.setVal(o);
                this.updateSelection(e);
                this.clearSearch();
                if (i) {
                    this.triggerChange(this.buildChangeDetails(n, this.data()))
                }
            }
        }
    });
    t.fn.select2 = function () {
        var i = Array.prototype.slice.call(arguments, 0),
            a, o, n, s, r, p = ["val", "destroy", "opened", "open", "close", "focus", "isFocused", "container", "dropdown", "onSortStart", "onSortEnd", "enable", "disable", "readonly", "positionDropdown", "data", "search"],
            l = ["opened", "isFocused", "container", "dropdown"],
            c = ["val", "data"],
            h = {
                search: "externalSearch"
            };
        this.each(function () {
            if (i.length === 0 || typeof i[0] === "object") {
                a = i.length === 0 ? {} : t.extend({}, i[0]);
                a.element = t(this);
                if (a.element.get(0)
                    .tagName.toLowerCase() === "select") {
                    r = a.element.prop("multiple")
                } else {
                    r = a.multiple || false;
                    if ("tags" in a) {
                        a.multiple = r = true
                    }
                }
                o = r ? new window.Select2["class"].multi : new window.Select2["class"].single;
                o.init(a)
            } else if (typeof i[0] === "string") {
                if (f(i[0], p) < 0) {
                    throw "Unknown method: " + i[0]
                }
                s = e;
                o = t(this)
                    .data("select2");
                if (o === e) return;
                n = i[0];
                if (n === "container") {
                    s = o.container
                } else if (n === "dropdown") {
                    s = o.dropdown
                } else {
                    if (h[n]) n = h[n];
                    s = o[n].apply(o, i.slice(1))
                }
                if (f(i[0], l) >= 0 || f(i[0], c) >= 0 && i.length == 1) {
                    return false
                }
            } else {
                throw "Invalid arguments to select2 plugin: " + i
            }
        });
        return s === e ? this : s
    };
    t.fn.select2.defaults = {
        width: "copy",
        loadMorePadding: 0,
        closeOnSelect: true,
        openOnEnter: true,
        containerCss: {},
        dropdownCss: {},
        containerCssClass: "",
        dropdownCssClass: "",
        formatResult: function (t, e, i, a) {
            var o = [];
            P(t.text, i.term, o, a);
            return o.join("")
        },
        formatSelection: function (t, i, a) {
            return t ? a(t.text) : e
        },
        sortResults: function (t, e, i) {
            return t
        },
        formatResultCssClass: function (t) {
            return t.css
        },
        formatSelectionCssClass: function (t, i) {
            return e
        },
        formatMatches: function (t) {
            return t + " results are available, use up and down arrow keys to navigate."
        },
        formatNoMatches: function () {
            return "No matches found"
        },
        formatInputTooShort: function (t, e) {
            var i = e - t.length;
            return "Please enter " + i + " or more character" + (i == 1 ? "" : "s")
        },
        formatInputTooLong: function (t, e) {
            var i = t.length - e;
            return "Please delete " + i + " character" + (i == 1 ? "" : "s")
        },
        formatSelectionTooBig: function (t) {
            return "You can only select " + t + " item" + (t == 1 ? "" : "s")
        },
        formatLoadMore: function (t) {
            return "Loading more results…"
        },
        formatSearching: function () {
            return "Searching…"
        },
        minimumResultsForSearch: 0,
        minimumInputLength: 0,
        maximumInputLength: null,
        maximumSelectionSize: 0,
        id: function (t) {
            return t == e ? null : t.id
        },
        matcher: function (t, e) {
            return d("" + e)
                .toUpperCase()
                .indexOf(d("" + t)
                    .toUpperCase()) >= 0
        },
        separator: ",",
        tokenSeparators: [],
        tokenizer: B,
        escapeMarkup: M,
        blurOnChange: false,
        selectOnBlur: false,
        adaptContainerCssClass: function (t) {
            return t
        },
        adaptDropdownCssClass: function (t) {
            return null
        },
        nextSearchTerm: function (t, i) {
            return e
        },
        searchInputPlaceholder: "",
        createSearchChoicePosition: "top",
        shouldFocusInput: function (t) {
            if (t.opts.minimumResultsForSearch < 0) {
                return false
            }
            return true
        }
    };
    t.fn.select2.ajaxDefaults = {
        transport: t.ajax,
        params: {
            type: "GET",
            cache: false,
            dataType: "json"
        }
    };
    window.Select2 = {
        query: {
            ajax: D,
            local: O,
            tags: _
        },
        util: {
            debounce: w,
            markMatch: P,
            escapeMarkup: M,
            stripDiacritics: d
        },
        "class": {
            "abstract": a,
            single: o,
            multi: n
        }
    }
})(jQuery);
(function (t) {
    t.fn.addEvent = t.fn.addEvents = t.fn.on;
    t.fn.addEventOnce = t.fn.once;
    t.fn.removeEvent = t.fn.removeEvents = t.fn.off;
    t.fn.fireEvent = t.fn.trigger;
    t.fn.setProperty = t.fn.setProperties = t.fn.getProperty = t.fn.getProperties = t.fn.setAttribute = t.fn.getAttribute = t.fn.attr;
    t.fn.removeProperty = t.fn.removeProp;
    t.fn.getValue = t.fn.setValue = t.fn.val;
    t.fn.getText = t.fn.setText = t.fn.text;
    t.fn.setStyle = t.fn.setStyles = t.fn.getStyle = t.fn.css;
    t.fn.getElement = t.fn.getElements = t.fn.find;
    t.fn.getParent = function (t) {
        return t ? this.closest(t) : this.parent()
    };
    t.fn.destroy = t.fn.remove;
    t.fn.getFirst = function (t) {
        return this.find(t ? t + ":first-child" : ">:first-child")
    };
    t.fn.getLast = function (t) {
        return this.find(t ? t + ":last-child" : ">:last-child")
    };
    t.fn.indexOf = t.fn.index;
    t.fn.forEach = function (t) {
        var e = this,
            i = function (i, a) {
                t(a, i, e)
            };
        this.each(i)
    };
    t.fn.toQueryString = t.fn.serialize;
    t.toQueryString = t.param;
    t.fn.inject = function (t, e) {
        switch (e) {
            case "before":
                this.insertBefore(t);
                break;
            case "top":
                this.prependTo(t);
                break;
            case "after":
                this.insertAfter(t);
                break;
            case "bottom":
            default:
                this.appendTo(t);
                break
        }
        return this
    };
    t.fn.getSize = function () {
        return {
            x: this.width(),
            y: this.height()
        }
    };
    t.fn.getPosition = function () {
        var t = this.offset();
        return {
            x: t.left,
            y: t.top
        }
    };
    t.Event.prototype.stop = function () {
        this.preventDefault();
        this.stopPropagation();
        return this
    }
})(window.$);
Function.prototype.bind = Function.prototype.bind || function (t) {
    if (typeof this !== "function") {
        throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")
    }
    var e = Array.prototype.slice,
        i = e.call(arguments, 1),
        a = this,
        o = function () { },
        n = function () {
            return a.apply(this instanceof o ? this : t || window, i.concat(e.call(arguments)))
        };
    o.prototype = this.prototype;
    n.prototype = new o;
    return n
};
String.prototype.capitalize = function () {
    return this.replace(/\b[a-z]/g, function (t) {
        return t.toUpperCase()
    })
};
String.prototype.trim = function () {
    return this.replace(/^\s+|\s+$/g, "")
};
String.prototype.clean = function () {
    return this.replace(/\s+/g, " ")
        .trim()
};
String.prototype.substitute = function (t, e) {
    return this.replace(e || /\\?\{([^{}]+)\}/g, function (e, i) {
        if (e.charAt(0) == "\\") {
            return e.slice(1)
        }
        return t[i] != null ? t[i] : ""
    })
};
String.contains = function (t, e, i) {
    return i ? (i + t + i)
        .indexOf(i + e + i) > -1 : t.indexOf(e) > -1
};
String.hyphenate = function (t) {
    return t.replace(/[A-Z]/g, function (t) {
        return "-" + t.charAt(0)
            .toLowerCase()
    })
};
String.escapeHTML = function (t) {
    if (!/[&<>"']/.test(t)) return t;
    if (t.indexOf("&") != -1) {
        t = t.replace(/&/g, "&amp;")
    }
    if (t.indexOf("<") != -1) {
        t = t.replace(/</g, "&lt;")
    }
    if (t.indexOf(">") != -1) {
        t = t.replace(/>/g, "&gt;")
    }
    if (t.indexOf('"') != -1) {
        t = t.replace(/"/g, "&quot;")
    }
    if (t.indexOf("'") != -1) {
        t = t.replace(/'/g, "&#39;")
    }
    return t
};
Array.prototype.forEach = Array.prototype.forEach || function (t, e) {
    for (var i = 0, a = this.length; i < a; i++) {
        if (i in this) t.call(e, this[i], i, this)
    }
};
Array.prototype.filter = Array.prototype.filter || function (t, e) {
    var i = [];
    for (var a = 0, o = this.length; a < o; a++) {
        if (a in this && t.call(e, this[a], a, this)) {
            i.push(this[a])
        }
    }
    return i
}, Array.prototype.indexOf = Array.prototype.indexOf || function (t, e) {
    var i = this.length;
    for (var a = e < 0 ? Math.max(0, i + e) : e || 0; a < i; a++) {
        if (this[a] === t) return a
    }
    return -1
};
Array.prototype.map = Array.prototype.map || function (t, e) {
    var i = [];
    for (var a = 0, o = this.length; a < o; a++) {
        if (a in this) i[a] = t.call(e, this[a], a, this)
    }
    return i
};
Array.isArray = Array.isArray || function (t) {
    return Object.prototype.toString.call(t) === "[object Array]"
};
(function () {
    var t = this.document,
        e = t.window = this;
    var i = navigator.userAgent.toLowerCase(),
        a = navigator.platform.toLowerCase(),
        o = i.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/) || [null, "unknown", 0],
        n = o[1] == "ie" && t.documentMode;
    if (/[Tt]rident.*rv[ :]*11\./.test(i)) {
        o = [null, "ie", 11]
    }
    var s = this.Browser = {
        name: o[1] == "version" ? o[3] : o[1],
        version: n || parseFloat(o[1] == "opera" && o[4] ? o[4] : o[2]),
        Platform: {
            name: i.match(/ip(?:ad|od|hone)/) ? "ios" : (i.match(/(?:webos|android)/) || a.match(/mac|win|linux/) || ["other"])[0]
        },
        Features: {
            svg: Modernizr.svg,
            geolocation: !!("geolocation" in navigator),
            transform: Modernizr.csstransforms
        },
        transformProperty: function () {
            var e = t.documentElement.style;
            for (var i = 0, a = arguments.length; i < a; i++) {
                if (arguments[i] in e) {
                    return arguments[i]
                }
            }
            return false
        }("transform", "WebkitTransform", "OTransform", "MozTransform", "msTransform"),
        Plugins: {}
    };
    s[s.name] = true;
    s[s.name + parseInt(s.version, 10)] = true;
    s.Platform[s.Platform.name] = true;
    s.exec = function (i) {
        if (!i) return i;
        if (e.execScript) {
            e.execScript(i)
        } else {
            var a = t.createElement("script");
            a.setAttribute("type", "text/javascript");
            a.text = i;
            t.head.appendChild(a);
            t.head.removeChild(a)
        }
        return i
    };
    if (!t.head) {
        t.head = t.getElementsByTagName("head")[0]
    }
    if (t.execCommand) try {
        t.execCommand("BackgroundImageCache", false, true)
    } catch (r) { }
    s.setHash = function (t, i) {
        var a = e.location;
        if (t.charAt(0) !== "#") {
            t = "#" + t
        }
        if (s.ie && s.version < 8) {
            var o = a.toString(),
                n = o.match(/#.+?$/);
            n = n && n[0] ? n[0] : "";
            if (n !== "") {
                if (!!i) {
                    a.replace(o.replace(n, t))
                } else {
                    a = o.replace(n, t)
                }
            } else {
                if (!!i) {
                    a += t
                } else {
                    a.replace(a.href += t)
                }
            }
        } else {
            if (!!i) {
                var o = a.href.split("#"),
                    n = o[1] || "";
                a.replace(o[0] + "#" + t.replace("#", ""))
            } else {
                a.hash = t
            }
        }
    };
    s.Request = e.XMLHttpRequest ? function () {
        return new e.XMLHttpRequest
    } : function () {
        try {
            return new ActiveXObject("MSXML2.XMLHTTP.3.0")
        } catch (t) {
            return null
        }
    }
})();
(function (t) {
    var e;
    if (t) {
        e = function () {
            window.onpopstate = this.onHistoryEvent.bind(this)
        };
        e.prototype.pushState = function (t, e, i) {
            window.history.pushState(t, e, window.location.href.replace(window.location.hash, "") + i)
        };
        e.prototype.replaceState = function (t, e, i) {
            window.history.replaceState(t, e, i)
        }
    } else {
        var i = document.documentMode && document.documentMode <= 7,
            a = "sessionStorage" in window && window.JSON && !i;
        e = function () {
            if ("onhashchange" in window && !i) {
                if (window.attachEvent) {
                    window.attachEvent("onhashchange", this.onHashChange.bind(this))
                } else {
                    window.addEventListener("hashchange", this.onHashChange.bind(this), false)
                }
            } else {
                if (Browser.ie && Browser.version < 10) {
                    this.createIframe()
                }
                this.hashTimer = setInterval(this.hashObserver.bind(this), this.hashInterval)
            }
            if (this.normalizeHash()) {
                this.onHashChange()
            }
            window.onpopstate = this.onHistoryEvent.bind(this)
        };
        e.prototype.hashObserver = function () {
            var t = this.normalizeHash();
            if (t !== this.hash) {
                this.onHashChange()
            }
        };
        e.prototype.delimiter = "-";
        e.prototype.iframe = null;
        e.prototype.hashInterval = 100;
        e.prototype.cleanFragment = function (t) {
            return t.charAt(0) === "#" ? t.substring(1) : t
        };
        if (a) {
            e.prototype.persist = true;
            e.prototype.setStorage = function (t, e) {
                window.sessionStorage[t] = JSON.stringify(e)
            };
            e.prototype.getStorage = function (t) {
                return JSON.parse(window.sessionStorage[t] || null)
            }
        } else {
            e.prototype.persist = false;
            var o = {};
            e.prototype.setStorage = function (t, e) {
                o[t] = e
            };
            e.prototype.getStorage = function (t) {
                return o[t]
            }
        }
        e.prototype.createIframe = function () {
            var t = document.createElement("iframe");
            t.setAttribute("id", "history-frame");
            t.src = window.location.protocol == "https" ? "https:///" : 'javascript:""';
            document.body.appendChild(t);
            this.iframe = t
        };
        e.prototype.updateIframe = function (t, e) {
            if (this.iframe && t !== this.iframe.contentWindow.location.hash) {
                if (!e) {
                    this.reloadIframe()
                }
                this.updateFrameHash(t, e)
            }
        };
        e.prototype.reloadIframe = function () {
            if (this.iframe) {
                this.iframe.contentWindow.document.open()
                    .close()
            }
        };
        e.prototype.updateFrameHash = function (t, e) {
            if (this.iframe) {
                var i = this.iframe.contentWindow.location;
                if (e) {
                    i.replace(i.toString()
                        .replace(/(javascript:|#).*$/, "") + "#" + t)
                } else {
                    i.hash = t
                }
            }
        };
        e.prototype.changeState = function (t, e, i, a) {
            i = this.cleanFragment(i);
            this.setStorage(i, {
                state: t,
                title: e
            });
            this.hash = i;
            if (a) {
                var o = window.location.toString(),
                    n = o.match(/#.+?$/);
                n = n && n[0] ? n[0] : "";
                if (n === "") {
                    window.location.replace(o + "#" + i)
                } else {
                    window.location.replace(o.replace(n, "#" + i))
                }
            } else {
                window.location.hash = "#" + i
            }
            this.updateIframe(i, a)
        };
        e.prototype.pushState = function (t, e, i) {
            this.changeState(t, e, i, false)
        };
        e.prototype.replaceState = function (t, e, i) {
            this.changeState(t, e, i, true)
        };
        e.prototype.normalizeHash = function () {
            return this.cleanFragment(window.location.hash)
        };
        e.prototype.onHashChange = function () {
            var t = this.normalizeHash(),
                e;
            if (t !== this.hash) {
                this.hash = t;
                e = this.hash ? this.getStorage(this.hash) : {};
                if ("onpopstate" in window && typeof window.onpopstate === "function") {
                    window.onpopstate.apply(window, [{
                        state: e ? e.state : null
                    }])
                }
            }
        }
    }
    e.prototype.back = function () {
        window.history.back()
    };
    e.prototype.forward = function () {
        window.history.forward()
    };
    e.prototype.onHistoryEvent = function (t) { };
    this.History = e
})("pushState" in window.history);
(function () {
    Element.prototype.hide = function () {
        var t;
        try {
            t = $(this)
                .getStyle("display")
        } catch (e) { }
        this["originalDisplay"] = t || "";
        this.style.display = "none";
        return this
    };
    Element.prototype.show = function (t) {
        t = t || this["originalDisplay"] || "block";
        this.style.display = ("display", t == "none" ? "block" : t);
        return this
    };
    Element.prototype.inject = function (t, e) {
        var i;
        switch (e) {
            case "before":
                i = this.parentNode;
                if (i) i.insertBefore(t, this);
                break;
            case "after":
                i = this.parentNode;
                if (i) i.insertBefore(this, t.nextSibling);
                break;
            case "top":
                t.insertBefore(this, t.firstChild);
                break;
            case "bottom":
            default:
                t.appendChild(this);
                break
        }
        return this
    }
})();
var Wikimapia = window.Wikimapia || {
    version: "1.9.0"
};
Wikimapia.Console = function (t, e, i) {
    if (t) return t;
    var a = t || {},
        o = function () { };
    for (var n = 0, s = i.length; n < s; n++) {
        var r = i[n];
        e[r] = o;
        if (!(r in a)) {
            a[r] = o
        }
    }
    if (!t) {
        window.console = a
    }
    return e
}(window.console, {}, ["log", "debug", "info", "warn", "error", "userError", "assert", "dir", "dirxml", "trace", "group", "groupEnd", "time", "timeEnd", "profile", "profileEnd", "count"]);
(function (t) {
    var e = document.getElementsByTagName("script");
    for (var i = 0, a = e.length; i < a; ++i) {
        if (/firebug\.js/.test(e[i].src)) {
            if (t.console) {
                Wikimapia.Console = console;
                break
            }
        }
    }
})(window);
Wikimapia.Net = {
    usesCDN: function () {
        if (typeof Wikimapia.Net._usesCDN === "undefined") {
            var t = window;
            Wikimapia.Net._usesCDN = !Wikimapia.Utils.alphaImageHackNeeded && "cdn" in t && t.cdn && t.cdn.host && t.cdn.host !== t.location.protocol + "//" + t.location.host
        }
        return Wikimapia.Net._usesCDN
    },
    loadModule: function (t, e, i, a, o) {
        i = i || t.replace(/\/\//g, "")
            .trim()
            .split(/\//)
            .join("-")
            .toLowerCase()
            .replace(/\./g, "-");
        e = e || Wikimapia.Utils.Empty;
        if (document.getElementById(i)) {
            e()
        } else {
            Wikimapia.Net.Asset.javascript(a ? t : Wikimapia.Utils.appendFileVersion(t), {
                id: i,
                onLoad: e,
                onError: o
            })
        }
    },
    loadModules: function () {
        var t = arguments,
            e = Array.prototype.slice.apply(t, [0, t.length - 1]),
            i;
        if (t.length == 2 && Array.isArray(t[0])) {
            e = t[0]
        }
        i = function (t, e, a, o, n) {
            e(t[o], o === n - 1 ? function () {
                a(t)
            } : function () {
                i(t, e, a, o + 1, n)
            })
        };
        i(e, Wikimapia.Net.loadModule, t[t.length - 1], 0, e.length)
    },
    loadCss: function (t) {
        var e = t.split(/\//)
            .pop()
            .toLowerCase()
            .replace(/\./g, "-");
        if (document.getElementById(e) === null) {
            Wikimapia.Net.Asset.css(Wikimapia.Utils.appendFileVersion(t), {
                id: e
            })
        }
    },
    stripCSS: function (t) {
        var e = Array.prototype.join.call($("head link[href]")
                .map(function (t, e) {
                    return e.getAttribute("href")
                }), "|")
            .replace(/\/src\//g, "/");
        return t.replace(/<link[^>]*>/gi, function (t) {
            var i = t.match(/href\=[\"\']([\s\S]*)[\"\']/i)[1];
            if (i && e.indexOf(i) !== -1 || Wikimapia.Utils.debug && /app.css/i.test(t)) t = "";
            return t
        })
    },
    execAllScriptsFromXHR: function (t) {
        var e = "",
            i = [],
            a = Array.prototype.join.call(Wikimapia.Utils.Dom.getElements("head script[src]")
                .map(function (t, e) {
                    return e.src
                }), "|");
        t = t.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, function (t, a) {
            if (a) {
                e += a + "\n"
            } else if (!/data-usage\=\"frame\"/i.test(t)) {
                i.push(t.match(/src\=[\"\']([\s\S]*)[\"\']/i)[1])
            }
            return ""
        });
        for (var o = 0, n = i.length; o < n; o++) {
            var s = i[o];
            if (a.indexOf(s) === -1) {
                var r = document.createElement("script");
                r.setAttribute("type", "text/javascript");
                r.src = s;
                var p = r.id = s.toLowerCase()
                    .replace(/[\/\.]/g, "");
                document.head.appendChild(r);
                if (Browser.opera) {
                    setTimeout(function () {
                        var t = document.getElementById(p);
                        if (t) {
                            t.parentNode.removeChild(t)
                        }
                    }, 1e3)
                } else {
                    document.head.removeChild(r)
                }
            }
        }
        Browser.exec(e);
        return t
    },
    preloadImages: function () {
        if (arguments.length > 0) {
            for (var t = 0, e = arguments.length; t < e; t++) {
                if (typeof arguments[t] === "string") {
                    Wikimapia.Net.Asset.image(arguments[t])
                }
            }
        }
    },
    dataCheckSum: function (t) {
        var e = 0;
        for (var i = 0, a = t.length; i < a; i++) {
            e += t.charCodeAt(i) | 10
        }
        return e
    },
    securePost: function (t) {
        return t + "&_time=" + Wikimapia.Net.dataCheckSum(t)
    },
    parseQueryString: function (t, e, i) {
        if (e == null) e = true;
        if (i == null) i = true;
        var a = t.split(/[&;]/),
            o = {};
        if (!a.length) return o;
        a.forEach(function (t) {
            var a = t.indexOf("=") + 1,
                n = a ? t.substr(a) : "",
                s = a ? t.substr(0, a - 1)
                .match(/([^\]\[]+|(\B)(?=\]))/g) : [t],
                r = o;
            if (!s) return;
            if (i) n = decodeURIComponent(n);
            s.forEach(function (t, i) {
                if (e) t = decodeURIComponent(t);
                var a = r[t];
                if (i < s.length - 1) r = r[t] = a || {};
                else if (Array.isArray(a)) a.push(n);
                else r[t] = a != null ? [a, n] : n
            })
        });
        return o
    }
};
Wikimapia.Net.Asset = {
    javascript: function (t, e) {
        e = e || {};
        var i = e.onload || e.onLoad,
            a = i ? i : function () { },
            o = e.onError ? e.onError : function () { };
        return new Wikimapia.Net.Xhr({
            onSuccess: a,
            dataType: "script",
            onError: o
        })
            .send({
                url: t
            })
    },
    css: function (t, e) {
        e = e || {};
        var i = Wikimapia.Utils.Dom.create("link", {
            rel: "stylesheet",
            media: "screen",
            type: "text/css",
            href: t
        }),
            a = e.onload || e.onLoad,
            o = e.document || document;
        delete e.onload;
        delete e.onLoad;
        delete e.document;
        if (a) {
            $(i)
                .addEvent("load", a)
        }
        return $(i)
            .setProperties(e)
            .appendTo(o.head)
    },
    image: function (t, e) {
        e = e || {};
        var i = new Image,
            a = i || Wikimapia.Utils.Dom.create("img");
        ["load", "abort", "error"].forEach(function (t) {
            var o = "on" + t,
                n = "on" + t.capitalize(),
                s = e[o] || e[n] || function () { };
            delete e[n];
            delete e[o];
            i[o] = function () {
                if (!i) {
                    return
                }
                if (!a.parentNode) {
                    a.width = i.width;
                    a.height = i.height
                }
                i = i.onload = i.onabort = i.onerror = null;
                setTimeout(function () {
                    s(a)
                }.bind(a), 1);
                Wikimapia.Utils.Dom.fireEvent(a, t, a)
            }
        });
        i.src = a.src = t;
        if (i && i.complete) {
            setTimeout(function () {
                if (i) {
                    i.onload()
                }
            }, 1)
        }
        return Wikimapia.Utils.Dom.setProperties(a, e)
    },
    images: function (t, e) {
        t = Array.isArray(t) ? t : [t];
        var i = function () { },
            a = 0;
        e = Wikimapia.Utils.extend({
            onSuccess: i,
            onProgress: i,
            onError: i,
            properties: {}
        }, e);
        return $(t.map(function (i, o) {
            return Wikimapia.Net.Asset.image(i, Wikimapia.Utils.extend({}, e.properties, {
                onload: function () {
                    a++;
                    e.onProgress.call(this, a, o, i);
                    if (a === t.length) {
                        e.onSuccess()
                    }
                },
                onerror: function () {
                    a++;
                    e.onError.call(this, a, o, i);
                    if (a === t.length) {
                        e.onSuccess()
                    }
                }
            }))
        }))
    }
};
Wikimapia.Net.Cookie = function () {
    var t = function () { };
    t.MAX_LENGTH = 3950;
    t.SPLIT_RE = /\s*;\s*/;
    t.prototype = {
        constructor: t,
        isEnabled: function () {
            return navigator.cookieEnabled
        },
        isValidName: function (t) {
            return !/[;=\s]/.test(t)
        },
        isValidValue: function (t) {
            return !/[;\r\n]/.test(t)
        },
        write: function (t, e, i, a, o, n) {
            if (!this.isValidName(t)) {
                throw Error('Invalid cookie name "' + t + '"')
            }
            if (!this.isValidValue(e)) {
                throw Error('Invalid cookie value "' + e + '"')
            }
            i = i || -1;
            var s = ";domain=" + (o ? o : Wikimapia.Utils.cookieDomain),
                r = a ? ";path=" + a : "",
                p = n ? ";secure" : "",
                l;
            if (i < 0) {
                l = ""
            } else if (i === 0) {
                var c = new Date(1970, 1, 1);
                expiresStr = ";expires=" + c.toUTCString()
            } else {
                l = ";expires=" + new Date(+new Date + i * 1e3)
                    .toUTCString()
            }
            this._setCookie(t + "=" + e + s + r + l + p)
        },
        read: function (t, e) {
            var i = t + "=",
                a = this._getParts();
            for (var o = 0, n; n = a[o]; o++) {
                if (n.lastIndexOf(i, 0) == 0) {
                    return n.substr(i.length)
                }
                if (n == t) {
                    return ""
                }
            }
            return e
        },
        remove: function (t, e, i) {
            var a = this.containsKey(t);
            this.write(t, "", 0, e, i);
            return a
        },
        getKeys: function () {
            return this._getKeyValues()
                .keys
        },
        getValues: function () {
            return this._getKeyValues()
                .values
        },
        isEmpty: function () {
            return !this._getCookie()
        },
        getCount: function () {
            var t = this._getCookie();
            if (!t) {
                return 0
            }
            return this._getParts()
                .length
        },
        containsKey: function (t) {
            return this.read(t) !== undefined
        },
        containsValue: function (t) {
            var e = this._getKeyValues()
                .values;
            for (var i = 0; i < e.length; i++) {
                if (e[i] == t) {
                    return true
                }
            }
            return false
        },
        clear: function () {
            var t = this._getKeyValues()
                .keys;
            for (var e = t.length - 1; e >= 0; e--) {
                this.remove(t[e])
            }
        },
        _setCookie: function (t) {
            document.cookie = t
        },
        _getCookie: function () {
            return document.cookie
        },
        _getParts: function () {
            return (this._getCookie() || "")
                .split(t.SPLIT_RE)
        },
        _getKeyValues: function () {
            var t = this.getParts_(),
                e = [],
                i = [],
                a, o;
            for (var n = 0; o = t[n]; n++) {
                a = o.indexOf("=");
                if (a == -1) {
                    e.push("");
                    i.push(o)
                } else {
                    e.push(o.substring(0, a));
                    i.push(o.substring(a + 1))
                }
            }
            return {
                keys: e,
                values: i
            }
        }
    };
    return new t
}();
Wikimapia.Utils = {
    idCounter: 0,
    debug: false,
    isTouch: !!(document.createTouch !== undefined || "ontouchstart" in window || navigator.msMaxTouchPoints),
    uniqueId: function (t, e) {
        this.idCounter++;
        if (arguments.length <= 1) {
            e = "-"
        }
        return (t || "id") + e + this.idCounter
    },
    unique: function () {
        return (Wikimapia.Utils.idCounter++)
            .toString(36)
    },
    defaultImagesUrl: "/img/",
    defaultMarkersUrl: "/img/markers/",
    defaultControlsUrl: "/img/controls/",
    defaultLayersDir: "/js/Wikimapia/Layer/",
    defaultInterfacesDir: "/js/Wikimapia/Interface/",
    defaultControlsDir: "/js/Wikimapia/Control/",
    defaultStylesheetsDir: "/css/",
    defaultScriptsDir: "/js/Wikimapia/",
    blankImage: "/img/blank.gif",
    defaultIconsDir: "/img/icons/",
    defaultMapIconsDir: "/img/map-icons/",
    photoServerURL: "http://photos.wikimapia.org",
    resolveLayerPath: function (t) {
        var e = Wikimapia.Utils.defaultLayersDir;
        if (/^wikimapia/i.test(t)) {
            e += t.replace(/[.-]/g, "/")
                .replace(/\/(\w)|^(\w)/g, function (t) {
                    return t.toUpperCase()
                })
                .replace("Wikimapia/", "")
        } else {
            e += t.split(".")
                .shift()
                .capitalize()
        }
        return e + ".js"
    },
    appendFileVersion: function (t) {
        return t + (t.indexOf("?") === -1 ? "?" : "&") + (Wikimapia.Utils.debug ? (new Date)
            .getTime() : Wikimapia.Utils.cssJsVersion)
    },
    isEmbedded: function () {
        return self !== top
    },
    isElement: function (t) {
        return t.nodeType === 1
    },
    processQueue: function (t, e, i, a, o, n) {
        n = n || t.length;
        o = o || 0;
        var s;
        if (o === n - 1) {
            s = function () {
                i(t)
            }
        } else {
            s = function () {
                Wikimapia.Utils.processQueue(t, e, i, a, o + 1, n)
            }
        }
        e(t[o], s, a, t, o)
    },
    addCSSRules: function (t) {
        var e = "wm-appended-stylesheet",
            i = document.getElementById(e);
        if (!i) {
            i = document.createElement("style");
            i.type = "text/css";
            i.id = e;
            document.getElementsByTagName("head")[0].appendChild(i)
        }
        if (i.styleSheet) {
            i.styleSheet.cssText = t
        } else {
            i.appendChild(document.createTextNode(t))
        }
    },
    appUrl: "/",
    MetersPerInch: .0254000508001016,
    MaxMercatorLat: 85.05112877980662,
    metersPerKm: 1e3,
    sqMetersPerHectare: 1e4,
    feetPerMeter: 3.2808399,
    feetPerMile: 5280,
    acresPerSqMile: 640,
    kmPerMile: 1.609344,
    alphaImageHackNeeded: Browser.ie && Browser.version < 9,
    alphaImageHack: function (t, e) {
        var i = "progid:DXImageTransform.Microsoft.AlphaImageLoader(src='" + t + (e ? "',sizingMethod='" + e : "") + "')";
        return i
    },
    fixAlphaImageSprite: function (t) {
        var e = $(t),
            i = Wikimapia.Utils.Dom.getStyle(t, "background-image"),
            a = Wikimapia.Utils.Dom.getStyle(t, "background-position");
        if (i.indexOf(".png") !== -1) {
            i = i.substr(4, i.length - 5)
                .replace(/['"]/g, "");
            a = a || "0px 0px";
            a = a.match(/-?\d+(,\d{3})*(\.\d{1,20})?/g);
            a = new Wikimapia.Point(a[0], a[1]);
            t.style.overflow = "hidden";
            var o = Math.max(Math.ceil(Math.abs(a.x) / 1e3), Math.ceil(Math.abs(a.y) / 1e3), 1) * 1e3,
                n = t.__sprite || Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
                    id: t.id + "-sprite"
                }), t, "top");
            Wikimapia.Utils.Dom.setStyles(n, {
                width: o + "px",
                height: o + "px",
                "margin-right": -o + "px",
                "margin-bottom": -o + "px",
                position: "relative",
                top: a.y + "px",
                left: a.x + "px",
                filter: Wikimapia.Utils.alphaImageHack(i, "crop")
            });
            Wikimapia.Utils.Dom.setStyles(t, {
                "background-image": "url(" + Wikimapia.Utils.blankImage + ")",
                display: "block"
            });
            t.__sprite = n
        }
    },
    moveAlphaImageSprite: function (t, e) {
        if (t.__sprite) {
            if (typeof e == "string") {
                e = Wikimapia.Utils.pxStringToNumbers(e);
                e = new Wikimapia.Point(e[0], e[1])
            }
            t.__sprite.style.top = e.y + "px";
            t.__sprite.style.left = e.x + "px"
        }
    },
    pxStringToNumbers: function (t) {
        return t.match(/-?\d+(,\d{3})*(\.\d{1,20})?/g)
    },
    drawShadowedText: function (t) {
        var e = '<span class="overlay {className}">{text}</span>';
        if (Wikimapia.Utils.alphaImageHackNeeded) {
            e = '<span class="underlay underlay-{className}">{text}' + '</span><span class="overlay {className}">{text}</span>'
        }
        if (!("className" in t)) {
            e = e.replace(/[\-\s]?{className}/g, "")
        }
        return e.substitute(t)
    },
    isImageLoaded: function (t) {
        console.log(t, t.complete, t.naturalWidth);
        return t && (t.complete || typeof t.naturalWidth !== "undefined")
    },
    picServerFunction: function (t, e) {
        return t % 4 + e % 4 * 4
    },
    distanceVincenty: function (t, e, i, a) {
        var o = 6378137,
            n = 6356752.3142,
            s = 1 / 298.257223563;
        var r = Math.degreesToRadians(a - e);
        var p = Math.atan((1 - s) * Math.tan(Math.degreesToRadians(t)));
        var l = Math.atan((1 - s) * Math.tan(Math.degreesToRadians(i)));
        var c = Math.sin(p),
            h = Math.cos(p);
        var u = Math.sin(l),
            m = Math.cos(l);
        var d = r,
            f, g = 100;
        do {
            var y = Math.sin(d),
                k = Math.cos(d);
            var v = Math.sqrt(m * y * (m * y) + (h * u - c * m * k) * (h * u - c * m * k));
            if (v === 0) {
                return 0
            }
            var W = c * u + h * m * k;
            var b = Math.atan2(v, W);
            var w = h * m * y / v;
            var C = 1 - w * w;
            var L = W - 2 * c * u / C;
            if (isNaN(L)) {
                L = 0
            }
            var S = s / 16 * C * (4 + s * (4 - 3 * C));
            f = d;
            d = r + (1 - S) * s * w * (b + S * v * (L + S * W * (-1 + 2 * L * L)))
        } while (Math.abs(d - f) > 1e-12 && --g > 0);
        if (g === 0) {
            return NaN
        }
        var T = C * (o * o - n * n) / (n * n);
        var E = 1 + T / 16384 * (4096 + T * (-768 + T * (320 - 175 * T)));
        var x = T / 1024 * (256 + T * (-128 + T * (74 - 47 * T)));
        var I = x * v * (L + x / 4 * (W * (-1 + 2 * L * L) - x / 6 * L * (-3 + 4 * v * v) * (-3 + 4 * L * L)));
        var U = n * E * (b - I);
        return U.toFixed(3)
    },
    measureText: function (t, e, i, a) {
        var o = "wikimapia-text-measurer",
            n = document.getElementById(o);
        if (!n) {
            n = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("span", {
                id: o,
                styles: {
                    visibility: "hidden",
                    whiteSpace: "nowrap",
                    position: "absolute",
                    left: "-5000px",
                    top: "-5000px"
                }
            }), document.getElementById("wikimapia"))
        }
        n.innerHTML = t;
        Wikimapia.Utils.Dom.setStyles(n, {
            "font-weight": a || "normal",
            "font-family": i || "Helvetica, Arial, Verdana, sans-serif",
            "font-size": e || "12px"
        });
        return n.offsetWidth
    },
    getScrollbarWidth: function () {
        var t = Wikimapia.Utils._scrollbarWidth;
        if (!t) {
            var e = document.createElement("div"),
                i = document.createElement("div"),
                a = 0,
                o = 0;
            e.style.position = "absolute";
            e.style.top = "-5000px";
            e.style.left = "-5000px";
            e.style.width = "100px";
            e.style.height = "50px";
            e.style.overflow = "hidden";
            i.style.width = "100%";
            i.style.height = "200px";
            e.appendChild(i);
            document.body.appendChild(e);
            a = i.offsetWidth;
            e.style.overflow = "scroll";
            o = i.offsetWidth;
            document.body.removeChild(e);
            Wikimapia.Utils._scrollbarWidth = t = a - o
        }
        return t
    },
    getLocationOrigin: function (t) {
        t = t || window;
        return window.location.protocol + "//" + window.location.host
    },
    trimText: function (t, e, i) {
        var a = Wikimapia.Utils.measureText,
            o = a(t, e.fontSize, e.fontFamily, e.fontWeight),
            n = t.length;
        while (o >= i) {
            t = t.substring(0, --n) + String.fromCharCode(8230);
            o = a(t, e.fontSize, e.fontFamily, e.fontWeight)
        }
        return t
    },
    stripScripts: function (t, e) {
        var i = "",
            a = t.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, function (t, e) {
                i += e + "\n";
                return ""
            });
        if (e === true) {
            Browser.exec(i)
        } else if (typeof e === "function") {
            e(i, a)
        }
        return a
    },
    isPointInPolygon: function (t, e) {
        for (var i = false, a = -1, o = t.length, n = o - 1; ++a < o; n = a) {
            var s = t[a],
                r = t[n];
            if ((s.lat <= e.lat && e.lat < r.lat || r.lat <= e.lat && e.lat < s.lat) && e.lng < (r.lng - s.lng) * (e.lat - s.lat) / (r.lat - s.lat) + s.lng) {
                i = !i
            }
        }
        return i
    },
    validateWikipediaLink: function (t) {
        return /^https?\:\/\/[\w\-]+\.wikipedia\.org\/[\w\-]+\/[^@]+$/.test(t)
    },
    linearSegmentWidth: function (t, e) {
        e -= 15;
        var i = [6, 3.15, 7.8, 11.4, 4.6, 1.4, 2.6][t],
            a = e < 0 ? Math.pow(1.25, e) : e > 0 ? 1 / Math.pow(1.2, -e) : 1;
        return Math.abs(Math.round(i * a))
    },
    getQuadKey: function (t, e, i, a) {
        var o = [
                [-2, 1],
                [0, 2],
                [2, 3]
        ][a - 8],
            n = "0",
            s;
        t = Math.round(t);
        e = Math.round((1 << i - o[0]) - e - 1);
        i -= o[1];
        while (i >= 0) {
            s = 1 << i;
            n += ((t & s) > 0 ? 1 : 0) + ((e & s) > 0 ? 2 : 0);
            i--
        }
        return n
    },
    quadKeyToBounds: function (t) {
        function e(t) {
            var e = Math,
                i = e.exp(2 * t);
            return 180 / e.PI * e.asin((i - 1) / (i + 1))
        }
        var i = 180,
            a = -i,
            o = Math.PI,
            n = -o,
            s = t.length,
            r = 1,
            p;
        while (r < s) {
            var l = parseInt(t.charAt(r), 10),
                c = (a + i) * .5,
                h = (n + o) * .5;
            switch (l) {
                case 0:
                    i = c;
                    o = h;
                    break;
                case 1:
                    a = c;
                    o = h;
                    break;
                case 2:
                    i = c;
                    n = h;
                    break;
                case 3:
                    a = c;
                    n = h;
                    break
            }
            r++
        }
        p = new Wikimapia.Bounds({
            left: a,
            right: i,
            bottom: e(n),
            top: e(o)
        });
        return p
    },
    getCategoryIconSprite: function (t) {
        var e = t.icon;
        if (parseInt(e, 10)) {
            e = new Array(4 - e.length)
                .concat(e)
                .join("0");
            e = "spt-" + e.replace(/(\d{2})(?!$)/g, "$1-")
        } else {
            e = null
        }
        return e
    },
    formatCategoryTitle: function (t, e, i) {
        var a = t.name;
        if (typeof e === "undefined") {
            e = Wikimapia.Lang.getCurrentLanguage()
        }
        if (t.lang && t.lang !== e) {
            a += "&nbsp;(" + t.lang + ")"
        }
        if (!i) {
            a += '&nbsp;<sup class="category-count">' + t.count + "</sup>"
        }
        return a
    },
    _throttledFunctions: {},
    _throttledCallCounters: {},
    throttle: function (t, e, i, a, o, n) {
        if (e === undefined) {
            e = 50
        }
        if (a === undefined) {
            a = 6
        }
        n = t.name || n;
        var s = Wikimapia.Utils,
            r = s._throttledFunctions,
            p = s._throttledCallCounters,
            l = r[n];
        if (l) {
            clearTimeout(l)
        }
        if (!p[n]) {
            p[n] = 0
        }
        p[n]++;
        if (!l || !a || p[n] % a !== 0) {
            r[n] = setTimeout(t.bind(o, i), e)
        } else {
            delete p[n];
            delete r[n];
            t.apply(o, i)
        }
    },
    dethrottle: function (t, e) {
        var i = Wikimapia.Utils;
        if (!e) {
            clearTimeout(i._throttledFunctions[t])
        }
        delete i._throttledCallCounters[t];
        delete i._throttledFunctions[t]
    },
    executeOnce: function (t) {
        var e = false,
            i;
        return function () {
            if (e) {
                return i
            }
            e = true;
            return i = t.apply(this, arguments)
        }
    },
    now: Date.now || function () {
        return (new Date)
            .getTime()
    },
    _throttle: function (t, e, i) {
        var a, o, n, s = null,
            r = 0;
        i || (i = {});
        var p = function () {
            r = i.leading === false ? 0 : Wikimapia.Utils.now();
            s = null;
            n = t.apply(a, o);
            a = o = null
        };
        return function () {
            var l = Wikimapia.Utils.now();
            if (!r && i.leading === false) r = l;
            var c = e - (l - r);
            a = this;
            o = arguments;
            if (c <= 0) {
                clearTimeout(s);
                s = null;
                r = l;
                n = t.apply(a, o);
                a = o = null
            } else if (!s && i.trailing !== false) {
                s = setTimeout(p, c)
            }
            return n
        }
    },
    _debounce: function (t, e, i) {
        var a;
        return function () {
            var o = this,
                n = arguments;
            var s = function () {
                a = null;
                if (!i) t.apply(o, n)
            };
            if (i && !a) t.apply(o, n);
            clearTimeout(a);
            a = setTimeout(s, e)
        }
    },
    timedProcessItems: function (t, e, i, a, o) {
        var n = t.concat(),
            s;
        o = o || 25;
        a = a || 100;
        s = setTimeout(function () {
            var r = +new Date;
            do {
                e(n.shift())
            } while (n.length > 0 && +new Date - r < a);
            if (n.length > 0) {
                s = setTimeout(arguments.callee, o)
            } else {
                i(t)
            }
        }, o);
        return s
    },
    bindHandlers: function () {
        var t = arguments[0],
            e = t.handlers || {},
            i;
        if (arguments.length > 1) {
            for (var a = 1, o = arguments.length; a < o; a++) {
                i = arguments[a];
                e[i] = t[i].bind(t)
            }
        }
        t.handlers = e;
        return e
    },
    getFormattedCoords: function (t, e) {
        return Wikimapia.Utils.getFormattedLonLat(t.lat, "lat", e) + " " + Wikimapia.Utils.getFormattedLonLat(t.lng, "lon", e)
    },
    getFormattedLonLat: function (t, e, i) {
        i = i || "dms";
        t = (t + 540) % 360 - 180;
        var a = Math.abs(t),
            o = Math.floor(a),
            n = (a - o) / (1 / 60),
            s = n,
            n = Math.floor(n),
            r = Math.round((s - n) / (1 / 60) * 10) / 10;
        if (r >= 60) {
            r -= 60;
            n += 1;
            if (n >= 60) {
                n -= 60;
                o += 1
            }
        }
        if (o < 10) {
            o = "0" + o
        }
        var p = o + "°";
        if (i.indexOf("dm") >= 0) {
            if (n < 10) {
                n = "0" + n
            }
            p += n + "′";
            if (i.indexOf("dms") >= 0) {
                if (r < 10) {
                    r = "0" + r
                }
                p += r + "″"
            }
        }
        if (e == "lon") {
            p += t < 0 ? "W" : "E"
        } else {
            p += t < 0 ? "S" : "N"
        }
        return p
    },
    offsetLatLngByMeters: function (t, e, i) {
        var a = 6378137,
            o = Math.PI;
        e = e || 0;
        i = i || 0;
        var n = e / a,
            s = i / (a * Math.cos(o * t.lat / 180));
        return new Wikimapia.LatLng(t.lat + n * 180 / o, t.lng + s * 180 / o)
    },
    encodePolygon: function (t) {
        var e = [],
            i = t.getBounds(),
            a = new Wikimapia.LatLng(i.bottom, i.left);
        for (var o = 0, n = t.getVertexCount() ; o < n; o++) {
            e.push(~~((t.points[o].lng - a.lng) * 1e7), ~~((t.points[o].lat - a.lat) * 1e7))
        }
        return {
            x: parseInt(a.lng * 1e7, 10),
            y: parseInt(a.lat * 1e7, 10),
            x2: parseInt(i.right * 1e7, 10),
            y2: parseInt(i.top * 1e7, 10),
            poly: e.join(";")
        }
    },
    getObjectURL: function (t) {
        var e = t.currentLanguage || "",
            i = t.id,
            a = t.type = t.type || 1,
            o;
        if (!isNaN(t.type)) {
            a = Wikimapia.objectTypes.prefixes[a]
        }
        if (typeof a === "string" && /street|river|railroad|ferry/.test(a)) {
            o = ["", a, i]
        } else {
            o = ["", i]
        }
        if (e) {
            if (!isNaN(e)) e = Wikimapia.Lang.codeToLng(e);
            if (e !== "en") o.push(e)
        }
        return o.join("/") + "/"
    },
    getUTFStringSize: function (t) {
        return encodeURI(t)
            .split(/%..|./)
            .length - 1
    },
    getCallback: function (t) {
        return typeof t === "function" ? t : Wikimapia.Utils.noop
    },
    inherits: function (t, e) {
        var i = function () { };
        i.prototype = e.prototype;
        t.prototype = new i;
        t.superProto = e.prototype;
        t._super = e;
        t.prototype.constructor = t
    },
    mixin: function (t, e) {
        var i = t.prototype,
            a = e.prototype;
        for (var o in a) {
            i[o] = a[o]
        }
        return t
    },
    extend: function (t, e) {
        var i, a;
        for (var o = 1; o < arguments.length; o++) {
            a = arguments[o];
            for (i in a) {
                t[i] = a[i]
            }
        }
        return t
    },
    merge: function (t, e) {
        var i, a;
        for (var o = 1; o < arguments.length; o++) {
            a = arguments[o];
            for (i in a) {
                if (typeof t[i] === "object") {
                    Wikimapia.Utils.extend(t[i], a[i])
                } else {
                    t[i] = a[i]
                }
            }
        }
        return t
    },
    arrayInclude: function (t, e) {
        if (t.indexOf(e) === -1) {
            t.push(e)
        }
        return t
    },
    arrayCombine: function (t, e) {
        for (var i = 0, a = e.length; i < a; i++) {
            Wikimapia.Utils.arrayInclude(t, e[i])
        }
        return t
    },
    arrayPick: function (t) {
        for (var e = 0, i = t.length; e < i; e++) {
            if (t[e] != null) return t[e]
        }
        return null
    },
    cloneObject: function (t) {
        var e = typeof t,
            i = Array.isArray(t);
        if (e == "object" || i) {
            if (t.clone) {
                return t.clone()
            }
            var a = i ? [] : {};
            for (var o in t) {
                a[o] = Wikimapia.Utils.cloneObject(t[o])
            }
            return a
        }
        return t
    },
    getObjectKeys: function (t) {
        var e = [];
        for (var i in t) {
            if (t.hasOwnProperty(i)) {
                e.push(i)
            }
        }
        return e
    },
    getObjectValues: function (t) {
        var e = [];
        for (var i in t) {
            if (t.hasOwnProperty(i)) e.push(t[i])
        }
        return e
    },
    getObjectLength: function (t) {
        return Wikimapia.Utils.getObjectKeys(t)
            .length
    },
    objectToQueryString: function (t) {
        return $.toQueryString(t)
    },
    objectForEach: function (t, e) {
        for (var i in t) {
            if (t.hasOwnProperty(i)) {
                e(t[i], i, t)
            }
        }
        return t
    },
    objectSubset: function (t, e) {
        var i = {};
        for (var a = 0, o = e.length; a < o; a++) {
            var n = e[a];
            if (n in t) {
                i[n] = t[n]
            }
        }
        return i
    },
    True: function () {
        return true
    },
    False: function () {
        return false
    },
    Empty: function () { },
    noop: function () { },
    isArray: function (t) {
        return t || function (t) {
            return Object.prototype.toString.call(t) === "[object Array]"
        }
    }(Array.isArray)
};
Wikimapia.layerAccessModes = {
    VIEW: 2,
    EDIT: 4,
    CREATE: 8,
    DELETE: 16,
    SAVE: 32,
    ALL: 62
};
(function (t) {
    var e = Wikimapia.Utils,
        i = window.location.hostname.split(".");
    e.cssJsVersion = this.cssJsVersion;
    var a = parseInt(Wikimapia.Net.Cookie.read("place_adding_test"));
    e.useMixPanel = a === 1 || a === 2;
    if (i.indexOf("testoffice") !== -1) e.photoServerURL = "";
    e.cookieDomain = "." + i.slice(i.length - 4, i.length)
        .join(".");
    if (/nopack/i.test(window.location.href)) {
        e.debug = true;
        for (var o in e) {
            var n = e[o];
            if (/Dir$/.test(o) && typeof n === "string") {
                e[o] = n.replace(/\/(js|css)\//, "/$1/src/")
            }
        }
    }
    if ("cdn" in t && t.cdn && t.cdn.host && t.cdn.host !== t.location.protocol + "//" + t.location.host) {
        for (var o in e) {
            var n = e[o];
            if (/Dir$/.test(o) && typeof n === "string") {
                e[o] = t.cdn.host + n
            }
        }
    }
})(window);
Wikimapia.Utils.Math = {
    calculateAngle: function (t, e, i, a, o, n) {
        var s = Math.sqrt,
            r = Math.pow;
        var p = s(r(i - t, 2) + r(a - e, 2)),
            l = s(r(i - o, 2) + r(a - n, 2)),
            c = s(r(o - t, 2) + r(n - e, 2));
        return Math.acos((l * l + p * p - c * c) / (2 * l * p))
    },
    normalize: function (t, e, i) {
        return Math.min(Math.max(t, e), i)
    },
    median: function (t) {
        t = t.slice(0);
        var e = (t.length + 1) / 2,
            i = t.sort(Wikimapia.Utils.Math.sortAsc);
        return i.length % 2 ? i[e - 1] : (i[e - 1.5] + i[e - .5]) / 2
    },
    sortAsc: function (t, e) {
        return t - e
    },
    sortDesc: function (t, e) {
        return e - t
    }
};
Math.degreesToRadians = function (t) {
    return t * (Math.PI / 180)
};
Math.radiansToDegrees = function (t) {
    return t / (Math.PI / 180)
};
Math.pointsDistance = function (t, e, i, a) {
    return Math.sqrt(Math.pow(t - i, 2) + Math.pow(e - a, 2))
};
Math.pointToLineDistance = function (t, e, i, a, o, n, s) {
    function r(t, e, i, a) {
        return Math.sqrt((t -= i) * t + (e -= a) * e)
    }
    var p = function m(t, e, i, a, o, n) {
        if (!(o - i)) {
            return {
                x: i,
                y: e
            }
        } else {
            if (!(n - a)) {
                return {
                    x: t,
                    y: a
                }
            }
        }
        var s, r = -1 / ((n - a) / (o - i));
        return {
            x: s = (o * (t * r - e + a) + i * (t * -r + e - n)) / (r * (o - i) + a - n),
            y: r * s - r * t + e
        }
    }(t, e, i, a, o, n);
    if (s && !(p.x >= Math.min(i, o) && p.x <= Math.max(i, o) && p.y >= Math.min(a, n) && p.y <= Math.max(a, n))) {
        var l = r(t, e, i, a),
            c = r(t, e, o, n);
        return l > c ? c : l
    } else {
        var h = a - n,
            u = o - i;
        p = i * n - a * o;
        return Math.abs(h * t + u * e + p) / Math.sqrt(h * h + u * u)
    }
};
Wikimapia.Utils.Url = {
    append: function (t, e, i) {
        var a, o;
        if (arguments.length === 2 && e && typeof e !== "string") {
            a = e;
            o = Wikimapia.Utils.objectToQueryString(a)
        } else {
            o = e + "=" + encodeURIComponent(i)
        }
        return t + (t.indexOf("?") === -1 ? "?" : "&") + o
    },
    parseURLParams: function (t, e) {
        e = e || {};
        var i = t.split(/\/?\?/)[1];
        if (i) {
            i = i.split(/[&\=]/);
            for (var a = 0, o = i.length; a < o; a += 2) {
                e[i[a]] = i[a + 1]
            }
        }
        return e
    },
    getLocationOrigin: function (t) {
        t = t || window;
        return t.location.origin || t.location.protocol + "//" + t.location.host
    }
};
Wikimapia.Utils = Wikimapia.Utils || {};
Wikimapia.Utils.Dom = {
    create: function (t, e) {
        var i = document.createElement(t),
            a;
        if (e) {
            if (e.events) {
                Wikimapia.Utils.Dom.addEvents(i, e.events);
                delete e.events
            }
            if (e.styles) {
                a = e.styles;
                delete e.styles
            }
            if (e["class"]) {
                i.className = e["class"];
                delete e["class"]
            }
            if (e.html) {
                i.innerHTML = e.html;
                delete e.html
            }
            Wikimapia.Utils.Dom.setProperties(i, e);
            if (a) {
                Wikimapia.Utils.Dom.setStyles(i, a)
            }
        }
        return i
    },
    inject: function (t, e, i) {
        var a;
        switch (i) {
            case "before":
                a = e.parentNode;
                if (a) a.insertBefore(t, e);
                break;
            case "after":
                a = e.parentNode;
                if (a) a.insertBefore(t, e.nextSibling);
                break;
            case "top":
                e.insertBefore(t, e.firstChild);
                break;
            case "bottom":
            default:
                e.appendChild(t);
                break
        }
        return t
    },
    wrapNodeList: function (t) {
        return $(t)
    },
    getElements: function (t, e) {
        return typeof t === "string" ? $(t) : $(t)
            .getElements(e)
    },
    getElement: function (t, e) {
        return Wikimapia.Utils.Dom.getElements(t, e)[0]
    },
    getNext: function (t, e) {
        return $(t)
            .next(e)
    },
    getAllPrevious: function (t, e) {
        return $(t)
            .prevAll(e)
    },
    getParent: function (t, e) {
        if (e) {
            return $(t)
                .getParent(e)
        } else {
            return t.parentNode
        }
    },
    getSize: function (t) {
        return $(t)
            .getSize()
    },
    setStyle: function (t, e, i) {
        $(t)
            .setStyle(e, i);
        return t
    },
    setStyles: function (t, e) {
        $(t)
            .setStyles(e);
        return t
    },
    getStyle: function (t, e) {
        return $(t)
            .getStyle(e)
    },
    setProperty: function (t, e, i) {
        $(t)
            .setProperty(e, i);
        return t
    },
    setProperties: function (t, e) {
        if (e.styles) {
            Wikimapia.Utils.Dom.setStyles(t, e.styles);
            delete e.styles
        }
        $(t)
            .setProperties(e);
        return t
    },
    addClass: function (t, e) {
        $(t)
            .addClass(e);
        return t
    },
    toggleClass: function (t, e, i) {
        var a = $(t);
        if (i) {
            a.removeClass(e)
                .addClass(i)
        } else {
            a[a.hasClass(e) ? "removeClass" : "addClass"](e)
        }
        return t
    },
    removeClass: function (t, e) {
        $(t)
            .removeClass(e);
        return t
    },
    switchClass: function (t, e, i) {
        return $(t)
            .removeClass(e)
            .addClass(i)
    },
    hasClass: function (t, e) {
        return $(t)
            .hasClass(e)
    },
    data: function (t, e, i) {
        if (arguments.length < 3) {
            return $(t)
                .data(e)
        } else {
            $(t)
                .data(e, i);
            return t
        }
    },
    toQueryString: function (t) {
        return $(t)
            .toQueryString()
    },
    clone: function (t, e) {
        return $(t)
            .clone(e)[0]
    },
    addEvent: function (t, e, i, a) {
        $(t)
            .addEvent(e, i, a);
        return t
    },
    addEventOnce: function (t, e, i) {
        $(t)
            .one(e, i);
        return t
    },
    addEvents: function (t, e) {
        $(t)
            .addEvents(e);
        return t
    },
    removeEvent: function (t, e, i) {
        $(t)
            .removeEvent(e, i);
        return t
    },
    removeEvents: function (t, e) {
        $(t)
            .removeEvents(e);
        return t
    },
    destroy: function (t) {
        $(t)
            .detach();
        return t
    },
    fireEvent: function (t, e, i) {
        $(t)
            .trigger(e, i);
        return t
    },
    getPosition: function (t, e) {
        if (e) {
            var i = $(t)
                .getPosition();
            e = $(e)
                .getPosition();
            i.y -= e.y;
            i.x -= e.x;
            return i
        } else {
            return $(t)
                .getPosition()
        }
    },
    nodeListToArray: function (t) {
        var e = [];
        for (var i = 0, a = t.length; i < a; i++) {
            e.push(t[i])
        }
        return e
    },
    htmlToDocumentFragment: function (t) {
        var e = doc.createElement("div");
        e.innerHTML = t;
        if (e.childNodes.length == 1) {
            return e.removeChild(e.firstChild)
        } else {
            var i = document.createDocumentFragment();
            while (e.firstChild) {
                i.appendChild(e.firstChild)
            }
            return i
        }
    },
    animate: function (t, e) {
        return morpheus(t, e)
    }
};
(function () {
    if ("morpheus" in this) {
        easings = morpheus.easings = {
            easeOut: function (t) {
                return Math.sin(t * Math.PI / 2)
            },
            easeOutStrong: function (t) {
                return t == 1 ? 1 : 1 - Math.pow(2, -10 * t)
            },
            easeIn: function (t) {
                return t * t
            },
            easeInStrong: function (t) {
                return t == 0 ? 0 : Math.pow(2, 10 * (t - 1))
            },
            bounce: function (t) {
                if (t < 1 / 2.75) {
                    return 7.5625 * t * t
                }
                if (t < 2 / 2.75) {
                    return 7.5625 * (t -= 1.5 / 2.75) * t + .75
                }
                if (t < 2.5 / 2.75) {
                    return 7.5625 * (t -= 2.25 / 2.75) * t + .9375
                }
                return 7.5625 * (t -= 2.625 / 2.75) * t + .984375
            },
            elastic: function (t) {
                return -1 * Math.pow(4, -8 * t) * Math.sin((t * 6 - 1) * (2 * Math.PI) / 2) + 1
            },
            wobble: function (t) {
                return -Math.cos(t * Math.PI * (3 * t)) / 2 + .5
            },
            sinusoidal: function (t) {
                return -Math.cos(t * Math.PI) / 2 + .5
            }
        }
    }
    this.getElement = $
})();
Wikimapia.Utils.Color = {
    rgbToHex: function (t) {
        var e = t.match(/\d{1,3}/g);
        if (e) {
            if (e.length < 3) {
                return null
            }
            if (e.length == 4 && e[3] == 0) {
                return "transparent"
            }
            var i = [];
            for (var a = 0; a < 3; a++) {
                var o = (e[a] - 0)
                    .toString(16);
                i.push(o.length == 1 ? "0" + o : o)
            }
            return "#" + i.join("")
        } else {
            return null
        }
    }
};
Wikimapia.Utils.Event = {
    keyCodes: {
        ESC: 27,
        ENTER: 13,
        TAB: 9,
        UP: 38,
        DOWN: 40,
        RIGHT: 39,
        LEFT: 37,
        META: 91,
        MAC_FF_META: 224,
        MAC_WK_CMD_LEFT: 91,
        MAC_WK_CMD_RIGHT: 93,
        Z: 90
    },
    fix: function (t) {
        return $.event.fix(t)
    },
    create: function (t, e) {
        return new $.Event(t, e)
    },
    _metaKeyPressed: false,
    storeLastEvent: function (t) {
        Wikimapia.Utils.Dom.addEvent()
    },
    isMetaKey: function (t) {
        var e = t.keyCode,
            i = Wikimapia.Utils.Event.keyCodes;
        return e === i.META || e === i.MAC_FF_META || e === i.MAC_WK_CMD_RIGHT
    },
    isUndoHotkey: function (t) {
        if (t.keyCode === Wikimapia.Utils.Event.keyCodes.Z) {
            if (Browser.Platform.mac) {
                return Wikimapia.Utils.Event._metaKeyPressed
            } else {
                return t.ctrlKey
            }
        }
        return false
    }
};
(function () {
    Wikimapia.Utils.Dom.addEvent(document, "keydown", function (t) {
        if (Wikimapia.Utils.Event.isMetaKey(t)) {
            Wikimapia.Utils.Event._metaKeyPressed = true;
            Wikimapia.Utils.Dom.addEventOnce(document, "keyup", function (t) {
                if (Wikimapia.Utils.Event.isMetaKey(t)) {
                    Wikimapia.Utils.Event._metaKeyPressed = false
                }
            })
        }
    })
})();
Wikimapia.Utils.Logger = function () {
    this._incomingTilesBandwidth = 0;
    this._incomingTilesTime = 0;
    this._campaign = null;
    this._entryPoint = null;
    var t = Wikimapia.Net.Cookie.read("test_group");
    if (t !== null) {
        this._campaign = t === "_test" ? "progressbar" : "progressbar_off"
    }
};
Wikimapia.Utils.Logger.prototype.constructor = Wikimapia.Utils.Logger;
Wikimapia.Utils.Logger.prototype.setEntryPoint = function (t) {
    if (t) {
        this._entryPoint = t;
        this.log("entry_point_" + t)
    }
};
Wikimapia.Utils.Logger.prototype.logPlaceAction = function (t, e) {
    var i = [t];
    if (e) {
        i.push(t + "_" + e)
    }
    if (this._entryPoint) {
        i.push(t + "_from_" + this._entryPoint)
    }
    if (this._campaign) {
        if (e) {
            i.push(t + "_" + e + "_" + this._campaign)
        } else {
            i.push(t + "_" + this._campaign)
        }
    }
    if (!app.map.access.userIsAuthorized()) {
        i.push(t + "_guest");
        if (this._entryPoint) {
            i.push(t + "_guest_from_" + this._entryPoint)
        }
        if (e) {
            i.push(t + "_" + e + "_guest")
        }
        if (this._campaign) {
            i.push(t + "_guest_" + this._campaign)
        }
    }
    if (i.length !== 0) {
        this.log(i.join(","))
    }
    if (t === "add_place_attempt") {
        this.addGoogleAnalyticsEvent("Place", "Add", "Pressed")
    }
    if (t === "place_new_data_save") {
        this.addGoogleAnalyticsEvent("Place", "Add", "Done")
    }
};
Wikimapia.Utils.Logger.prototype.logAuth = function (t, e) {
    this.log(t + "_" + e)
};
Wikimapia.Utils.Logger.prototype.logUnfinishedPolygon = function (t) {
    if (t && t.unSaved) {
        var e = Wikimapia.Utils.encodePolygon(t.geometry),
            i = [0, parseInt(e.x), parseInt(e.y), e.poly].join(";");
        this.log(i, Logger.urls.POLYGON)
    }
};
Wikimapia.Utils.Logger.prototype.log = function (t, e) { };
Wikimapia.Utils.Logger.prototype.addGoogleAnalyticsEvent = function (t, e, i) {
    window.pageTracker && window.pageTracker._trackEvent(t, e, i)
};
Wikimapia.Utils.Logger.prototype.trackAnalytics = function (t) {
    if (window.pageTracker && t) {
        window.pageTracker._trackPageview(t)
    }
};
Wikimapia.Utils.Logger.prototype.logIncomingTilesBandwidth = function (t, e) {
    this._incomingTilesTime += e;
    this._incomingTilesBandwidth += t
};
Wikimapia.Utils.Logger.prototype.logTotalXYTilesBandwidth = function () {
    if (this._incomingTilesBandwidth && this._incomingTilesTime) {
        this.log("?s=" + this._incomingTilesBandwidth + "&t=" + this._incomingTilesTime, Logger.urls.BANDWIDTH)
    }
};
Wikimapia.Utils.Logger = new Wikimapia.Utils.Logger;
Wikimapia.Utils.Logger.urls = {
    EVENTS: "http://192.69.208.130/stats/collect/?event=",
    BANDWIDTH: "http://192.69.208.130/stats/collect/speed.php",
    POLYGON: "http://192.69.208.130/stats/collect/poly.php?poly="
};
(function () {
    var t = Math,
        e = t.round,
        i = t.floor,
        a = t.ceil;
    Wikimapia.Point = function (t, e) {
        this.x = +t;
        this.y = +e
    };
    var o = Wikimapia.Point;
    Wikimapia.Point.prototype = {
        clone: function () {
            return new o(this.x, this.y)
        },
        equals: function (t) {
            var e = false;
            if (t) {
                e = this.x == t.x && this.y == t.y || isNaN(this.x) && isNaN(this.y) && isNaN(t.x) && isNaN(t.y)
            }
            return e
        },
        add: function (t, e) {
            return new o(this.x + t, this.y + e)
        },
        subtract: function (t, e) {
            if (t === null || e === null) {
                var i = "pointAddError";
                Wikimapia.Console.error(i);
                return null
            }
            return new o(this.x - t, this.y - e)
        },
        offset: function (t) {
            return t ? this.add(t.x, t.y) : this.clone()
        },
        changeSign: function () {
            return new o(-this.x, -this.y)
        },
        floor: function () {
            return new o(i(this.x), i(this.y))
        },
        ceil: function () {
            return new o(a(this.x), a(this.y))
        },
        round: function () {
            return new o(e(this.x), e(this.y))
        },
        toString: function () {
            return this.x + "," + this.y
        },
        constructor: Wikimapia.Point
    };
    o.fromString = function (t) {
        t = t.split(",");
        return new o(parseInt(t[0]), parseInt(t[1]))
    };
    o.toDomPosition = function (t) {
        return {
            top: t.y,
            left: t.x
        }
    }
})();
(function () {
    var t = Math,
        e = t.round,
        i = t.floor,
        a = t.ceil,
        o = Wikimapia.Utils.distanceVincenty;
    Wikimapia.LatLng = function (t, e) {
        this.lat = +t;
        this.lng = +e;
        return this
    };
    var n = Wikimapia.LatLng;
    Wikimapia.LatLng.prototype = {
        equals: function (t) {
            var e = false;
            if (t) {
                e = this.lng == t.lng && this.lat == t.lat || isNaN(this.lng) && isNaN(this.lat) && isNaN(t.lng) && isNaN(t.lat)
            }
            return e
        },
        shift: function (t, e) {
            return new n(this.lat + t, this.lng + e)
        },
        clone: function () {
            return new n(this.lat, this.lng)
        },
        subtract: function (t) {
            return this.shift(-t.lat, -t.lng)
        },
        add: function (t) {
            return this.shift(t.lat, t.lng)
        },
        distanceTo: function (t) {
            return o(this.lat, this.lng, t.lat, t.lng)
        },
        wrapDateLine: function (t) {
            var e = this.clone();
            if (t) {
                var i = t.getWidth();
                while (e.lng < t.left) {
                    e.lng += i
                }
                while (e.lng > t.right) {
                    e.lng -= i
                }
            }
            return e
        },
        toString: function () {
            return this.lat + "," + this.lng
        },
        constructor: Wikimapia.LatLng
    }
})();
(function () {
    Wikimapia.Size = function (t, e) {
        this.w = parseFloat(t);
        this.h = parseFloat(e)
    };
    var t = Wikimapia.Size;
    Wikimapia.Size.prototype = {
        equals: function (t) {
            var e = false;
            if (t !== null) {
                e = this.w == t.w && this.h == t.h || isNaN(this.w) && isNaN(this.h) && isNaN(t.w) && isNaN(t.h)
            }
            return e
        },
        clone: function () {
            return new t(this.w, this.h)
        },
        scale: function (e) {
            return new t(this.w * e, this.h * e)
        },
        width: function () {
            return +this.w
        },
        height: function () {
            return +this.h
        },
        toString: function () {
            return this.w + "x" + this.h
        },
        constructor: t
    }
})();
(function () {
    var t = Math,
        e = t.round,
        i = t.floor,
        a = t.ceil,
        o = t.pow,
        n = Wikimapia.Point,
        s = Wikimapia.LatLng,
        r = Wikimapia.Size;
    Wikimapia.Bounds = function (t) {
        t = t || {};
        this.left = !!t.left ? parseFloat(t.left) : 0;
        this.bottom = !!t.bottom ? parseFloat(t.bottom) : 0;
        this.right = !!t.right ? parseFloat(t.right) : 0;
        this.top = !!t.top ? parseFloat(t.top) : 0;
        return this
    };
    Wikimapia.Bounds.prototype = {
        clone: function () {
            return new Wikimapia.Bounds({
                left: this.left,
                bottom: this.bottom,
                right: this.right,
                top: this.top
            })
        },
        equals: function (t) {
            var e = false;
            if (t !== null) {
                e = this.left == t.left && this.right == t.right && this.top == t.top && this.bottom == t.bottom
            }
            return e
        },
        toArray: function () {
            return [this.left, this.bottom, this.right, this.top]
        },
        toBBOX: function (t) {
            if (!t) {
                t = 6
            }
            var i = o(10, t);
            return [e(this.left * i) / i, e(this.bottom * i) / i, e(this.right * i) / i, e(this.top * i) / i].join(",")
        },
        getWidth: function () {
            return this.right - this.left
        },
        getHeight: function () {
            return this.top - this.bottom
        },
        getSize: function () {
            return new r(this.getWidth(), this.getHeight())
        },
        getCenterPixel: function () {
            return new n((this.left + this.right) / 2, (this.bottom + this.top) / 2)
        },
        getCenterLatLng: function () {
            this.centerLatLng = new s((this.bottom + this.top) / 2, (this.left + this.right) / 2);
            return this.centerLatLng
        },
        scale: function (t, e) {
            if (!e) {
                e = this.getCenterLatLng()
            }
            var i, a;
            if (e instanceof s) {
                i = e.lng;
                a = e.lat
            } else {
                i = e.x;
                a = e.y
            }
            var o = (this.left - i) * t + i,
                n = (this.bottom - a) * t + a,
                r = (this.right - i) * t + i,
                p = (this.top - a) * t + a;
            return new Wikimapia.Bounds({
                left: o,
                bottom: n,
                right: r,
                top: p
            })
        },
        add: function (t, e) {
            return new Wikimapia.Bounds({
                left: this.left + t,
                bottom: this.bottom + e,
                right: this.right + t,
                top: this.top + e
            })
        },
        extend: function (t) {
            var e = null;
            if (t) {
                if (t instanceof s) {
                    e = new Wikimapia.Bounds({
                        left: t.lng,
                        bottom: t.lat,
                        right: t.lng,
                        top: t.lat
                    })
                }
                if (t instanceof n) {
                    e = new Wikimapia.Bounds({
                        left: t.x,
                        bottom: t.y,
                        right: t.x,
                        top: t.y
                    })
                }
                if (t instanceof Wikimapia.Bounds) {
                    e = t
                }
                if (e) {
                    this.centerLatLng = null;
                    if (!this.left || e.left < this.left) {
                        this.left = e.left
                    }
                    if (!this.bottom || e.bottom < this.bottom) {
                        this.bottom = e.bottom
                    }
                    if (!this.right || e.right > this.right) {
                        this.right = e.right
                    }
                    if (!this.top || e.top > this.top) {
                        this.top = e.top
                    }
                }
            }
            return this
        },
        containsLatLng: function (t, e) {
            var i = t.lng,
                a = t.lat,
                o = this.right,
                n = this.left;
            if (o < n) {
                o = 180 - this.right
            }
            return i > n && i < o && a > this.bottom && a < this.top
        },
        containsPixel: function (t, e) {
            return this.contains(t.x, t.y, e)
        },
        contains: function (t, e, i) {
            if (i == "undefined") {
                i = true
            }
            if (!t || !e) {
                return false
            }
            var a = false;
            if (i) {
                a = t >= this.left && t <= this.right && e >= this.bottom && e <= this.top
            } else {
                a = t > this.left && t < this.right && e > this.bottom && e < this.top
            }
            return a
        },
        intersectsBounds: function (t, e) {
            if (typeof e === "undefined") {
                e = true
            }
            var i = false,
                a = this.left === t.right || this.right === t.left || this.top === t.bottom || this.bottom === t.top;
            if (e || !a) {
                var o = t.bottom >= this.bottom && t.bottom <= this.top || this.bottom >= t.bottom && this.bottom <= t.top,
                    n = t.top >= this.bottom && t.top <= this.top || this.top > t.bottom && this.top < t.top,
                    s = t.left >= this.left && t.left <= this.right || this.left >= t.left && this.left <= t.right,
                    r = t.right >= this.left && t.right <= this.right || this.right >= t.left && this.right <= t.right;
                i = (o || n) && (s || r)
            }
            return i
        },
        containsBounds: function (t, e) {
            e = typeof e == "undefined" ? true : e;
            var i = this.contains(t.left, t.bottom, e),
                a = this.contains(t.right, t.bottom, e),
                o = this.contains(t.left, t.top, e),
                n = this.contains(t.right, t.top, e);
            return i && a && o && n
        },
        determineQuadrant: function (t) {
            var e = "",
                i = this.getCenterLatLng();
            e += coords.lat < i.lat ? "b" : "t";
            e += coords.lng < i.lng ? "l" : "r";
            return e
        },
        wrapDateLine: function (t, e) {
            e = e || {};
            var i = e.leftTolerance || 0,
                a = e.rightTolerance || 0,
                o = this.clone();
            if (t) {
                while (o.left < t.left && o.right - a <= t.left) {
                    o = o.add(t.getWidth(), 0)
                }
                while (o.left + i >= t.right && o.right > t.right) {
                    o = o.add(-t.getWidth(), 0)
                }
            }
            return o
        },
        toString: function () {
            return "{b:" + this.bottom + ",l:" + this.left + ",t:" + this.top + ",r:" + this.right + "}"
        },
        constructor: Wikimapia.Bounds
    };
    Wikimapia.Bounds.fromString = function (t) {
        return b.fromArray(t.split(","))
    };
    Wikimapia.Bounds.fromArray = function (t) {
        return new Wikimapia.Bounds({
            left: parseFloat(t[0]),
            bottom: parseFloat(t[1]),
            right: parseFloat(t[2]),
            top: parseFloat(t[3])
        })
    };
    Wikimapia.Bounds.fromSize = function (t) {
        return new Wikimapia.Bounds({
            left: 0,
            bottom: t.h,
            right: t.w,
            top: 0
        })
    };
    Wikimapia.Bounds.fromPoint = function (t) {
        return new Wikimapia.Bounds({
            left: t.x,
            bottom: t.y,
            right: t.x,
            top: t.y
        })
    };
    Wikimapia.Bounds.extendByPxGap = function (t, e, i) {
        var a = i.fromLatLngToPixel(new Wikimapia.LatLng(t.top, t.left)),
            o = i.fromLatLngToPixel(new Wikimapia.LatLng(t.bottom, t.right)),
            n, s;
        if (typeof e == "number") {
            n = s = e
        } else {
            n = e.w;
            s = e.h
        }
        return (new Wikimapia.Bounds)
            .extend(i.fromPixelToLatLng(a.subtract(n, s)))
            .extend(i.fromPixelToLatLng(o.add(n, s)))
    }
})();
(function () {
    Wikimapia.EventTarget = function () { };
    var t = function (t) {
        return t.replace(/^on([A-Z])/, function (t, e) {
            return e.toLowerCase()
        })
    },
        e = Object.prototype.toString;
    Wikimapia.EventTarget.cleanEventType = t;
    Wikimapia.EventTarget.prototype = {
        constructor: Wikimapia.EventTarget,
        addEventsFromOptions: function (t) {
            for (var e in t) {
                if (/^on[A-Z]/.test(e) || typeof t[e] === "function") {
                    this.addEvent(e, t[e]);
                    delete t[e]
                }
            }
        },
        addEvent: function (e, i) {
            e = t(e);
            this._events = this._events || {};
            var a = this._events[e] = this._events[e] || [];
            if (i && a.indexOf(i) === -1) {
                a.push(i)
            }
            return this
        },
        addEventOnce: function (t, e) {
            var i = this,
                a = function () {
                    e.apply(i, Array.prototype.slice.call(arguments, 0));
                    i.removeEvent(t, arguments.callee)
                };
            this.addEvent(t, a);
            return this
        },
        removeEvent: function (e, i) {
            var a;
            e = t(e);
            this._events = this._events || {};
            if (!this._events[e]) return this;
            a = this._events[e].indexOf(i);
            if (a !== -1) {
                this._events[e].splice(a, 1);
                if (this._events[e].length === 0) {
                    this._events[e] = null
                }
            }
            return this
        },
        addEvents: function (t) {
            for (var e in t) {
                this.addEvent(e, t[e])
            }
            return this
        },
        removeEvents: function (t) {
            if (typeof t === "string") {
                for (var e = this._events[t] || [], i = 0, a = e.length; i < a; i++) {
                    this.removeEvent(t, e[i])
                }
                delete this._events[t]
            } else {
                if (!t) {
                    t = this._events
                }
                for (var o in t) {
                    this.removeEvent(o, t[o])
                }
            }
            return this
        },
        fireEvent: function (t, i) {
            this._events = this._events || {};
            if (!this._events[t]) return this;
            if (i != null) {
                if (typeof i === "string" || typeof i.length !== "number" || e.call(i) == "[object Function]") {
                    i = [i]
                }
            } else {
                i = []
            }
            for (var a = this._events[t], o = 0, n = a.length; o < n; o++) {
                var s = a[o];
                if (typeof s === "function") {
                    s.apply(this, i)
                }
            }
            return this
        },
        destroy: function () {
            this.removeEvents()
        }
    }
})();
Wikimapia.Net.Xhr = function (t) {
    this.options = Wikimapia.Utils.extend({}, this.options, this.formatOptions(t || {}))
};
Wikimapia.Net.Xhr.textStatus = {
    PARSE_ERROR: "parseerror",
    SUCCESS: "success",
    NOT_MODIFIED: "notmodified",
    ERROR: "error",
    TIMEOUT: "timeout",
    ABORT: "abort"
};
Wikimapia.Net.Xhr.prototype = {
    constructor: Wikimapia.Net.Xhr,
    options: {
        dataType: "html"
    },
    formatOptions: function (t) {
        if (t.onSuccess) {
            t.success = t.onSuccess;
            delete t.onSuccess
        }
        if (t.onRequest) {
            t.beforeSend = t.onRequest;
            delete t.onRequest
        }
        if (t.onError) {
            t.error = t.onError;
            delete t.onError
        }
        if (t.onComplete) {
            t.complete = t.onComplete;
            delete t.onComplete
        }
        if (t.type) {
            t.dataType = t.type;
            delete t.type
        }
        return t
    },
    _xhr: null,
    _isXhrRunning: false,
    send: function (t) {
        Wikimapia.Utils.extend(this, this.options, this.formatOptions(t || {}));
        var e = this.url.toString();
        if (this.noCache) {
            this.url += (this.url.indexOf("?") !== -1 ? "&" : "?") + Wikimapia.Utils.unique()
        }
        if (this._xhr) {
            this._xhr = null
        }
        if (this.dataType === "script") {
            this.type = "script";
            delete this.type
        }
        this._isXhrRunning = true;
        this._xhr = $.ajax(this)
            .always(this._onComplete.bind(this));
        this.url = e;
        return this
    },
    _onComplete: function () {
        this._isXhrRunning = false
    },
    isRunning: function () {
        return this._xhr && this._isXhrRunning
    },
    getResponseHeader: function (t) {
        return this._xhr.getResponseHeader(t)
    },
    getStatus: function () {
        return this._xhr.status
    },
    cancel: function () {
        if (this._xhr) {
            this._xhr.abort()
        }
        return this
    }
};
Wikimapia.Net.XhrBase = function (t) {
    this.xhr = new Browser.Request;
    this.options = Wikimapia.Utils.extend({}, Wikimapia.Net.XhrBase._options, t);
    this.addEventsFromOptions(this.options);
    this.headers = this.options.headers
};
Wikimapia.Utils.inherits(Wikimapia.Net.XhrBase, Wikimapia.EventTarget);
Wikimapia.Net.XhrBase.progressSupport = "onprogress" in new Browser.Request;
Wikimapia.Net.XhrBase._options = {
    onRequest: Wikimapia.Utils.noop,
    onLoadstart: Wikimapia.Utils.noop,
    onProgress: function (t, e) { },
    onComplete: Wikimapia.Utils.noop,
    onCancel: Wikimapia.Utils.noop,
    onSuccess: Wikimapia.Utils.noop,
    onFailure: Wikimapia.Utils.noop,
    onException: Wikimapia.Utils.noop,
    onTimeout: Wikimapia.Utils.noop,
    url: "",
    data: "",
    headers: {
        "X-Requested-With": "XMLHttpRequest",
        Accept: "text/javascript, text/html, application/xml, text/xml, */*"
    },
    async: true,
    format: false,
    method: "post",
    link: "ignore",
    isSuccess: null,
    emulation: true,
    urlEncoded: true,
    encoding: "utf-8",
    evalScripts: false,
    evalResponse: false,
    timeout: 0,
    noCache: false
};
Wikimapia.Net.XhrBase.prototype.onStateChange = function () {
    var t = this.xhr;
    if (t.readyState != 4 || !this.running) return;
    this.running = false;
    this.status = 0;
    try {
        var e = t.status;
        this.status = e == 1223 ? 204 : e
    } catch (i) { }
    t.onreadystatechange = Wikimapia.Utils.noop;
    if (Wikimapia.Net.XhrBase.progressSupport) {
        t.onprogress = t.onloadstart = Wikimapia.Utils.noop
    }
    clearTimeout(this.timer);
    this.response = {
        text: this.xhr.responseText || "",
        xml: this.xhr.responseXML
    };
    if (this.options.isSuccess.call(this, this.status)) {
        this.success(this.response.text, this.response.xml)
    } else {
        this.failure()
    }
};
Wikimapia.Net.XhrBase.prototype.isSuccess = function () {
    var t = this.status;
    return t >= 200 && t < 300
};
Wikimapia.Net.XhrBase.prototype.isRunning = function () {
    return !!this.running
};
Wikimapia.Net.XhrBase.prototype.getStatus = function () {
    return this.status
};
Wikimapia.Net.XhrBase.prototype.processScripts = function (t) {
    if (this.options.evalResponse || /(ecma|java)script/.test(this.getHeader("Content-type"))) {
        return Browser.exec(t)
    }
    return Wikimapia.Utils.stripScripts(t, this.options.evalScripts)
};
Wikimapia.Net.XhrBase.prototype.success = function (t, e) {
    this.onSuccess(this.processScripts(t), e)
};
Wikimapia.Net.XhrBase.prototype.onSuccess = function () {
    this.fireEvent("complete", arguments)
        .fireEvent("success", arguments)
};
Wikimapia.Net.XhrBase.prototype.failure = function () {
    this.onFailure()
};
Wikimapia.Net.XhrBase.prototype.onFailure = function () {
    this.fireEvent("complete")
        .fireEvent("failure", this.xhr)
};
Wikimapia.Net.XhrBase.prototype.loadstart = function (t) {
    this.fireEvent("loadstart", [t, this.xhr])
};
Wikimapia.Net.XhrBase.prototype.progress = function (t) {
    this.fireEvent("progress", [t, this.xhr])
};
Wikimapia.Net.XhrBase.prototype.timeout = function () {
    this.fireEvent("timeout", this.xhr)
};
Wikimapia.Net.XhrBase.prototype.setHeader = function (t, e) {
    this.headers[t] = e;
    return this
};
Wikimapia.Net.XhrBase.prototype.getHeader = function (t) {
    var e = "";
    try {
        e = this.xhr.getResponseHeader(t)
    } catch (i) { }
    return e
};
Wikimapia.Net.XhrBase.prototype.check = function () {
    if (!this.running) {
        return true
    }
    return false
};
Wikimapia.Net.XhrBase.prototype.send = function (t) {
    if (!this.check(t)) {
        return this
    }
    this.options.isSuccess = this.options.isSuccess || this.isSuccess;
    this.running = true;
    if (typeof t === "string") {
        t = {
            data: t
        }
    }
    var e = this.options;
    t = Wikimapia.Utils.extend({
        data: e.data,
        url: e.url,
        method: e.method
    }, t);
    var i = t.data,
        a = String(t.url),
        o = t.method.toLowerCase();
    if (typeof i === "object") {
        i = Wikimapia.Utils.objectToQueryString(i)
    }
    if (this.options.format) {
        var n = "format=" + this.options.format;
        i = i ? n + "&" + i : n
    }
    if (this.options.emulation && ["get", "post"].indexOf(o) === -1) {
        var s = "_method=" + o;
        i = i ? s + "&" + i : s;
        o = "post"
    }
    if (this.options.urlEncoded && ["post", "put"].indexOf(o) !== -1) {
        var r = this.options.encoding ? "; charset=" + this.options.encoding : "";
        this.headers["Content-type"] = "application/x-www-form-urlencoded" + r
    }
    if (!a) {
        a = document.location.pathname
    }
    var p = a.lastIndexOf("/");
    if (p > -1 && (p = a.indexOf("#")) > -1) {
        a = a.substr(0, p)
    }
    if (this.options.noCache) {
        a += (a.indexOf("?") !== -1 ? "&" : "?") + Wikimapia.Utils.unique()
    }
    if (i && o === "get") {
        a += (a.indexOf("?") !== -1 ? "&" : "?") + i;
        i = null
    }
    var l = this.xhr;
    if (Wikimapia.Net.XhrBase.progressSupport) {
        l.onloadstart = this.loadstart.bind(this);
        l.onprogress = this.progress.bind(this)
    }
    l.open(o.toUpperCase(), a, this.options.async, this.options.user, this.options.password);
    if (this.options.user && "withCredentials" in l) {
        l.withCredentials = true
    }
    l.onreadystatechange = this.onStateChange.bind(this);
    for (var c in this.headers) {
        var h = this.headers[c];
        try {
            l.setRequestHeader(c, h)
        } catch (u) {
            this.fireEvent("exception", [c, h])
        }
    }
    this.fireEvent("request");
    l.send(i);
    if (!this.options.async) {
        this.onStateChange()
    }
    if (this.options.timeout) {
        this.timer = window.setTimeout(this.timeout.bind(this), this.options.timeout)
    }
    return this
};
Wikimapia.Net.XhrBase.prototype.cancel = function () {
    if (!this.running) {
        return this
    }
    this.running = false;
    var t = this.xhr;
    t.abort();
    clearTimeout(this.timer);
    t.onreadystatechange = Wikimapia.Utils.noop;
    if (Wikimapia.Net.XhrBase.progressSupport) {
        t.onprogress = t.onloadstart = Wikimapia.Utils.noop
    }
    this.xhr = new Browser.Request;
    this.fireEvent("cancel");
    return this
};
["get", "post", "put", "delete", "GET", "POST", "PUT", "DELETE"].forEach(function (t) {
    Wikimapia.Net.XhrBase.prototype[t] = function (e) {
        var i = {
            method: t
        };
        if (e != null) i.data = e;
        return this.send(i)
    }
});
Wikimapia.Lang = function () {
    var t = null,
        e = {},
        i = {};
    var a = ["en", "ru", "fr", "es", "it", "de", "cn", "ja", "ko", "pt", "ar", "bg", "cs", "da", "el", "et", "fa", "fi", "he", "hi", "hr", "hu", "hy", "be", "lt", "lv", "nl", "no", "pl", "ro", "sk", "sl", "sr", "sv", "sw", "th", "tr", "uk", "vi", "bn", "te", "mr", "ta", "pa", "ur", "gu", "ne", "ml", "kn", "az", "or", "su", "ms", "ca", "id", "gl", "bs", "sq", "eu", "is", "af", "mk", "tl", "my", "mn", "ka", "zh", "ku", "gd", "ga", "co", "am", "si", "gn", "ht", "jv", "kg", "kk", "km", "ks", "ky", "lo", "mg", "ny", "om", "ps", "qu", "sd", "so", "st", "tw", "uz", "--", "zu", "pn", "kp", "bc", "cb", "ww", "hl", "ic", "ma"],
        o = [0, 3, 2, 5, 4, 9, 28, 17, 27, 1];
    var n = function (t) {
        return t instanceof s.Set ? t : e[t]
    };
    var s = function () {
        this.langs = a;
        this.popLanguages = o;
        this.langNames = {}
    };
    Wikimapia.Utils.inherits(s, Wikimapia.EventTarget);
    s.prototype.define = function (i, a, o, n) {
        var r;
        if (i instanceof s.Set) {
            r = i.name;
            if (r) {
                e[r] = i
            }
        } else {
            r = i;
            if (!(r in e)) {
                e[r] = new s.Set(r)
            }
            i = e[r]
        }
        if (a) {
            i.define(a, o, n)
        }
        if (!t) {
            t = i
        }
        return i
    };
    s.prototype.languageLoaded = function (t) {
        return !!e[t]
    };
    s.prototype.use = function (e) {
        e = n(e);
        if (e) {
            t = e;
            this.fireEvent("langChanged", e.name)
        }
        return this
    };
    s.prototype.getCurrent = function () {
        return t
    };
    s.prototype.getCurrentLanguage = function () {
        if (this.getCurrent()) {
            return this.getCurrent()
                .name
        } else {
            return ""
        }
    };
    s.prototype.get = function (e, i) {
        return t ? t.get(e, i) : ""
    };
    s.prototype.inherit = function (t, e, i) {
        t = n(t);
        if (t) {
            t.inherit(e, i)
        }
        return this
    };
    s.prototype.list = function () {
        return Wikimapia.Utils.getObjectKeys(e)
    };
    s.prototype.selectUserLanguage = function (t, e) {
        t = window.languageIso = typeof t === "number" ? this.codeToLng(t) : t;
        e = window.forceUserLanguage = typeof e === "number" ? this.codeToLng(e) : e;
        if (t !== e) {
            t = window.languageIso = e
        }
        return t
    };
    s.prototype.setLanguage = function (t, e) {
        t = t || "en";
        if (top !== self) {
            e = true
        }
        if (!this.languageLoaded(t)) {
            this.requestLanguageFile(t);
            this.requestTags(t)
        } else {
            this._lang = t;
            this._code = this.lngToCode(this._lang);
            this.use(t);
            this.requestTags(t)
        }
        if (!e) {
            Wikimapia.Net.Cookie.remove("lng");
            Wikimapia.Net.Cookie.write("lng", this.getCurrentLanguageCode())
        }
    };
    s.prototype.requestUrlMask = "localization/{lang}.json";
    s.prototype.requestTagsUrlMask = "localization/tags/{lang}.json";
    s.prototype.requestTagsTopUrlMask = "localization/tags_top/{lang}.json";
    s.prototype.correctLang = function (t) {
        if (typeof t == "number") {
            t = this.codeToLng(t)
        }
        if (!t || this.langs.indexOf(t) < 0) {
            t = t == "br" ? "pt" : this.codeToLng(0)
        }
        return t
    };
    s.prototype.requestLanguageFile = function (t) {
        t = this.correctLang(t);
        var e = new Wikimapia.Net.Xhr({
            type: "json",
            async: false,
            method: "get",
            onSuccess: function (e) {
                this.defineLocalization(e);
                this.setLanguage(t)
            }.bind(this),
            onFailure: function (t) {
                this.requestLanguageFile(this.codeToLng(0))
            }.bind(this)
        })
            .send({
                url: this.requestUrlMask.substitute({
                    lang: t
                })
            });
        this.requestTags(t)
    };
    s.prototype.defineLanguageName = function (t, e) {
        if (!(t in this.langNames)) {
            this.langNames[t] = e
        }
    };
    s.prototype.defineLocalization = function (t) {
        for (var e in t.sets) {
            if (t.sets.hasOwnProperty(e)) {
                Wikimapia.Lang.define(t.lang, e, t.sets[e])
            }
        }
    };
    s.prototype.requestTags = function (t) {
        if (Wikimapia.Utils.isEmbedded()) return;
        t = this.correctLang(t);
        if (!(this.tagsCacheRequest && this.tagsCacheRequest.running) && t != this.tagsLoaded) {
            this.tagsCacheRequest = new Wikimapia.Net.Xhr({
                async: false,
                method: "get",
                type: "json",
                onSuccess: function (e) {
                    var i = new Wikimapia.Cache;
                    e.topFilter = Wikimapia.Utils.getObjectKeys(e.categories);
                    i.store("categoriesCache", e);
                    this.tagsLoaded = t;
                    this.fireEvent("tagsLoaded")
                }.bind(this),
                onFailure: function (t) {
                    this.requestLanguageFile(this.codeToLng(0))
                }.bind(this)
            })
                .send({
                    url: this.requestTagsUrlMask.substitute({
                        lang: t
                    })
                })
        }
    };
    s.prototype.lngToCode = function (t) {
        return this.langs.indexOf(t)
    };
    s.prototype.codeToLng = function (t) {
        return this.langs[t]
    };
    s.prototype.getLanguageName = function (t) {
        return this.langNames[t] || "Unknown"
    };
    s.prototype.localize = function (t, e) {
        var i = this;
        if (typeof t == "string") {
            t = t.substitute(this.get(e || "all"))
        } else if (Wikimapia.Utils.isElement(t)) {
            Wikimapia.Utils.Dom.getElements(t, "[l10n]")
                .forEach(function (t) {
                    var a = t.getAttribute("l10n"),
                        o = i.get((e || "all") + "." + a);
                    if (t.tagName.toLowerCase() === "input") {
                        t.setAttribute("value", o || a)
                    } else {
                        t.innerHTML = o || a
                    }
                })
        }
        return t
    };
    s.prototype.getCurrentLanguageCode = function () {
        return this._code
    };
    s.prototype.getAcceptedLanguagesList = function () {
        return Wikimapia.Utils.getObjectKeys(window.languagesNative || [])
            .concat(Wikimapia.Lang.getCurrentLanguage())
    };
    s.prototype.checkCISByLanguage = function () {
        var t = Wikimapia.Lang.getAcceptedLanguagesList()
            .join(",");
        return t && /am|az|be|kz|kg|md|ru|tj|tm|uk|uz/g.test(t)
    };
    s.Set = function (t) {
        this.name = t || "";
        this.sets = {};
        this.inherits = {
            locales: [],
            sets: {}
        }
    };
    s.Set.prototype = {
        sets: null,
        inherits: null,
        define: function (t, e, i) {
            var a = this.sets[t];
            if (!a) {
                a = {}
            }
            if (e) {
                if (typeof e == "object") {
                    a = Wikimapia.Utils.extend({}, a, e)
                } else {
                    a[e] = i
                }
            }
            this.sets[t] = a;
            return this
        },
        getFromPath: function (t, e) {
            var i = Object.prototype.hasOwnProperty;
            if (typeof e == "string") {
                e = e.split(".")
            }
            for (var a = 0, o = e.length; a < o; a++) {
                if (i.call(t, e[a])) {
                    t = t[e[a]]
                } else {
                    return null
                }
            }
            return t
        },
        get: function (t, i, a) {
            var o = this.getFromPath(this.sets, t);
            if (o != null) {
                var n = typeof o;
                if (n == "function") {
                    o = o.apply(null, Array.isArray(i) ? i : [i])
                } else if (n == "object") {
                    o = Wikimapia.Utils.cloneObject(o)
                }
                return o
            }
            var s = t.indexOf("."),
                r = s < 0 ? t : t.substr(0, s),
                p = Wikimapia.Utils.arrayInclude(Wikimapia.Utils.arrayCombine(this.inherits.sets[r] || [], this.inherits.locales), "en");
            if (!a) {
                a = []
            }
            for (var l = 0, c = p.length; l < c; l++) {
                var h = p[l];
                if (a.indexOf(h) !== -1) {
                    continue
                }
                Wikimapia.Utils.arrayInclude(a, h);
                var u = e[h];
                if (!u) {
                    continue
                }
                o = u.get(t, i, a);
                if (o != null) {
                    return o
                }
            }
            return ""
        },
        inherit: function (t, e) {
            t = Array.isArray(t) ? t : [t];
            if (e && !this.inherits.sets[e]) {
                this.inherits.sets[e] = []
            }
            var i = t.length;
            while (i--) {
                (e ? this.inherits.sets[e] : this.inherits.locales)
                .unshift(t[i])
            }
            return this
        }
    };
    return new s
}();
Wikimapia.History = function () {
    History.call(this)
};
Wikimapia.Utils.inherits(Wikimapia.History, History);
Wikimapia.Utils.mixin(Wikimapia.History, Wikimapia.EventTarget);
Wikimapia.History.prototype.onHistoryEvent = function (t) {
    History.prototype.onHistoryEvent.call(this, t);
    this.fireEvent("popstate", t)
};
Wikimapia.History = new Wikimapia.History;
(function () {
    var t = {},
        e = null;
    Wikimapia.Cache = function () {
        if (e !== null) {
            return e
        }
        this.localStorage = window.localStorage || null;
        e = this
    };
    Wikimapia.Cache.prototype = {
        store: function (e, i) {
            var a = t;
            if (arguments.length > 2) {
                for (var o = 0, n = arguments.length - 2; o < n; o++) {
                    if (!a.hasOwnProperty(arguments[o])) {
                        a[arguments[o]] = {}
                    }
                    a = a[arguments[o]]
                }
                e = arguments[arguments.length - 2];
                i = arguments[arguments.length - 1]
            }
            a[e] = i
        },
        retrieve: function (e) {
            var i = t,
                a = null;
            if (arguments.length > 1) {
                for (var o = 0, n = arguments.length - 1; o < n; o++) {
                    if (i.hasOwnProperty(arguments[o])) {
                        i = i[arguments[o]]
                    } else {
                        break
                    }
                }
                e = arguments[arguments.length - 1]
            }
            if (i.hasOwnProperty(e)) {
                a = i[e]
            }
            return a
        },
        clear: function (e) {
            if (e) {
                var i = t;
                if (arguments.length > 1) {
                    for (var a = 0, o = arguments.length - 1; a < o; a++) {
                        if (i.hasOwnProperty(arguments[a])) {
                            i = i[arguments[a]]
                        } else {
                            break
                        }
                    }
                    e = arguments[arguments.length - 1]
                }
                if (i.hasOwnProperty(e)) {
                    delete i[e]
                }
            } else {
                for (var n in t) {
                    delete t[n]
                }
            }
        },
        has: function (e) {
            var i = t,
                a = false;
            if (arguments.length > 1) {
                for (var o = 0, n = arguments.length - 1; o < n; o++) {
                    if (i.hasOwnProperty(arguments[o])) {
                        i = i[arguments[o]]
                    } else {
                        return false
                    }
                }
                e = arguments[arguments.length - 1]
            }
            return i.hasOwnProperty(e)
        },
        getLength: function () {
            var t = this.retrieve.apply(this, arguments),
                e, i = 0;
            if (t) {
                for (e in t) {
                    i++
                }
            }
            return i
        },
        getRaw: function () {
            return t
        },
        setItem: function (t, e) {
            if (this.localStorage) {
                if (typeof e !== "string") {
                    e = JSON.stringify(e)
                }
                this.localStorage.setItem(t, e)
            }
        },
        setItemJSON: function (t, e) {
            this.setItem(t, JSON.stringify(e))
        },
        getItem: function (t) {
            if (this.localStorage) {
                return this.localStorage.getItem(t)
            }
            return null
        },
        getItemJSON: function (t) {
            var e = this.getItem(t);
            if (e) {
                return JSON.parse(e)
            }
            return null
        },
        constructor: Wikimapia.Cache
    }
})();
Wikimapia.Cache.Pool = function () {
    this._pool = [];
    this.acquiredCount = 0
};
Wikimapia.Cache.Pool.prototype.get = function () {
    this.acquiredCount++;
    return this._pool.pop() || {}
};
Wikimapia.Cache.Pool.prototype.release = function (t) {
    if (t) {
        this.acquiredCount--;
        this._pool.push(t)
    }
};
Wikimapia.Cache.Pool.prototype.clear = function () {
    this._pool.length = 0;
    this._pool = null
};
Wikimapia.Cache.Pool = new Wikimapia.Cache.Pool;
(function (t) {
    var e = null;
    Wikimapia.Router = function (i, a) {
        if (e === null) {
            this.map = i;
            this.app = a;
            e = t.router = this
        }
        return e
    };
    Wikimapia.Router.prototype = {
        expressions: {
            objectPage: /(^\/\d+(\/\w+)?)|(^\/(street|river|railroad|ferry|street)\/\d+)/,
            countriesPage: /(^\/(country)\/)/,
            editObject: /^\/(object|street|river|railroad|ferry)\/edit\//,
            history: /^\/(object|street|river|ferry|railroad)\/history|before_delete/,
            linearRevision: /^\/(linear|road|railroad|ferry|river)\/history\/show/,
            linearRevisionMatcher: /\/history\/show\/\?type=(\d+)\&rev=(\d+)/,
            toolsCommon: /^\/user\/tools/,
            watchlist: /^\/user\/tools\/watchlist/,
            editLocation: /^\/user\/editlocation/,
            mapshift: /^\/user\/tools\/mapshift/,
            login: /^\/user\/login/,
            register: /^\/user\/register/,
            forgot: /^\/user\/forgot/,
            stats: /^\/stats\//,
            showphoto: /^\/showphoto\//,
            other: /(^\/photo\/)|^\/user\/tools\/|^\/country\/|terms_reference|maintenance|before_(un)?delete|^\/(user|guest)\/(\?uid\=\d+)?/,
            userPages: /^\/user\/(?!forgot|controls|register)\/?/,
            photomanager: /\/photo\/\?((object_type\=\d)|(id\=\d+)|(lng\=\d{1,2})?)/,
            category: /^\/object\/category/,
            editAccount: /^\/user\/editaccount/,
            userControls: /^\/user\/controls/,
            userDenied: /^\/user\/denied/,
            adsHelp: /^\/promote\/start/,
            adsCreate: /^\/promote\/create/,
            popOut: /^\/(user\/tools\/user_reports)|(ads)|(about\/)/
        },
        map: null,
        app: null,
        route: function (t) {
            if (t === "") {
                if (this.map.windowObject) {
                    this.map.getWindow()
                        .close()
                } else {
                    this.map.closePanel()
                }
                return false
            }
            if (!t || Wikimapia.Utils.isEmbedded()) return false;
            var e, i, a, o, n, s = true,
                r = {},
                p = 0,
                l = "",
                c = null,
                h = Wikimapia.Utils.noop;
            if (this.expressions.objectPage.test(t)) {
                return this.map.fireEvent("show", Wikimapia.Object.fromCanonicalUrl(t))
            } else {
                i = Wikimapia.Utils.Url.parseURLParams(t);
                if (this.expressions.editObject.test(t)) {
                    return this.map.fireEvent("edit", [Wikimapia.Object.fromURL(t), t])
                }
                if (this.expressions.linearRevision.test(t)) {
                    t = t.match(this.expressions.linearRevisionMatcher);
                    if (t.length == 3 && !isNaN(t[1]) && !isNaN(t[2])) {
                        this.app.openLinearRevision(t[1], t[2])
                    }
                    return
                }
                if (this.expressions.countriesPage.test(t)) {
                    size = new Wikimapia.Size(Math.max(this.map.getCurrentSize()
                        .w * .4, 800), 100);
                    return this.map.createPanel({
                        url: t,
                        onLoad: function () {
                            this.map.updateShowHash(t, true)
                        }.bind(this),
                        onClose: function () {
                            this.map.updateShowHash("", true)
                        }.bind(this),
                        iframe: true,
                        menu: null,
                        position: "left",
                        size: size
                    })
                }
                if (this.expressions.history.test(t)) {
                    return this.map.fireEvent("historyRevision", [Wikimapia.Object.fromURL(t), t])
                }
                if (this.expressions.login.test(t)) {
                    return this.app.login(i.backurl)
                }
                if (this.expressions.register.test(t)) {
                    return this.app.register(i.backurl)
                }
                if (this.expressions.forgot.test(t)) {
                    return this.app.forgot(i.uid, i.code)
                }
                if (this.expressions.category.test(t)) {
                    return this.map.openCategory(i.type, i.tab, i.id, i.lng, i.rev, i.rev2)
                }
                if (this.expressions.stats.test(t)) {
                    return this.app.map.showStats()
                }
                if (this.expressions.editAccount.test(t)) {
                    return this.app.editAccount()
                }
                if (this.expressions.userControls.test(t)) {
                    return this.map.createWindow({
                        url: t,
                        iframe: false
                    })
                }
                if (this.expressions.editLocation.test(t)) {
                    return this.app.editUserLocation()
                }
                if (this.expressions.watchlist.test(t)) {
                    return this.app.openWatchlist(t)
                }
                if (this.expressions.mapshift.test(t)) {
                    return this.app.openMapShift(t)
                }
                if (this.expressions.showphoto.test(t)) {
                    r = this.extractObjectData(t.split("/")
                        .pop());
                    return this.map.fireEvent("showphoto", [Wikimapia.Object.fromURL(t), t])
                }
                if (this.expressions.photomanager.test(t)) {
                    return this.map.fireEvent("photomanager", [Wikimapia.Object.fromURL(t), t])
                }
                if (this.expressions.userDenied.test(t)) {
                    i = Wikimapia.Utils.Url.getAccessDeniedParams(t);
                    return this.app.showAccessDenied({
                        state: i.type
                    }, i.backurl)
                }
                if (this.expressions.adsHelp.test(t)) {
                    return this.app.helpPanel(t)
                }
                if (this.expressions.adsCreate.test(t)) {
                    r = this.extractObjectData(t.split("/")
                        .pop());
                    return this.map.fireEvent("promote", [r, t])
                }
                if (this.expressions.popOut.test(t)) {
                    return window.location.replace(t)
                }
                if (this.expressions.userPages.test(t)) {
                    s = true
                }
                this.map.createWindow({
                    url: t,
                    iframe: s,
                    menu: c
                })
            }
        },
        extractObjectData: function (t, e) {
            var i = e || {};
            Wikimapia.Utils.Url.parseURLParams(t, i);
            if (i.object_type) {
                i.type = i.object_type = parseInt(i.object_type, 10)
            }
            if (i.placeId) {
                i.id = i.placeId;
                i.lng = i.lngId;
                i.type = i.object_type = 1
            }
            return i
        },
        checkObjectPageRedirect: function (t, e) {
            var i = this.expressions.objectPage;
            return e.indexOf(t) === 0 && i.test(e) && i.test(t)
        },
        constructor: Wikimapia.Router
    };
    this.routeLinks = function (t) {
        if (!t) return;
        var e = t.getElementsByTagName("a"),
            i = function (t) {
                this.className += " visited";
                parent.router.route(this.getAttribute("href"));
                t.stop()
            },
            a, o;
        for (var n = 0, s = e.length; n < s; n++) {
            a = e[n];
            o = a.getAttribute("href");
            if (a.getAttribute("data-action") === null && o !== "" && o !== "#" && a.getAttribute("target") === null) {
                Wikimapia.Utils.Dom.addEvent(a, "click", i)
            }
        }
    }
})(window);
(function (t) {
    var e = null;
    Wikimapia.Socket = function (i, a, o) {
        if (e === null) {
            var n = this.getUserInfo();
            if (t.io && t.socketParams && t.socketParams.enable && n.uid) {
                this.socket = t.io.connect(i + ":" + a) || {};
                this.start(n)
            }
            e = t.socket = this
        }
        this.app = o;
        return e
    };
    Wikimapia.Socket.prototype = {
        constructor: Wikimapia.Socket,
        socket: null,
        getUserInfo: function () {
            return {
                uid: Wikimapia.Net.Cookie.read("uid"),
                cookie: Wikimapia.Net.Cookie.read("pwh")
            }
        },
        start: function (e) {
            var i = this.socket,
                a = this;
            if (!i) {
                return
            }
            i.on("connect", function () {
                i.emit("wikimapiaAuth", e);
                console.log(a)
            });
            i.on("clientWikimapiaAuthSuccess", function (t) {
                console.log("Wikimapia auth success. Uid: " + t)
            });
            i.on("clientWikimapiaAuthFail", function () {
                console.log("Not authorized")
            });
            i.on("clientDisplayCurrentUsers", function (t) {
                console.log(t)
            });
            i.on("clientMessageRecieve", function (t) {
                console.log(t)
            });
            i.on("clientAwardMessageRecieve", this.onAwardReceived);
            i.on("clientUpdateUserInfo", function (e) {
                t.app.userStatusHandler(e)
            });
            i.on("clientUpdateUserExp", function (e) {
                t.app.userExperienceChanged(JSON.parse(e))
            })
        },
        onAwardReceived: function (t) {
            app.map.fireEvent("awardReceived", t)
        }
    }
})(window);
Wikimapia.Icon = function (t) {
    t = t || {};
    this.options = {};
    this.image = null;
    this.shadow = null;
    for (var e in Wikimapia.Icon.defaultOptions) {
        this.options[e] = t[e] ? t[e] : Wikimapia.Icon.defaultOptions[e]
    }
};
Wikimapia.Icon.defaultOptions = {
    image: null,
    cursor: "pointer",
    imageSpritePos: "0px 0px",
    imageSpriteClass: null,
    shadow: null,
    size: null,
    shadowSize: null,
    shadowSpritePos: "0px 0px",
    shadowOffset: null,
    position: null
};
Wikimapia.Icon.prototype = {
    constructor: Wikimapia.Icon,
    create: function () {
        if (typeof this.options.image !== "undefined") {
            this.id = Wikimapia.Utils.uniqueId("wm-icn");
            var t, e, i = this,
                a, o = this.options;
            if (!o.size) {
                o.size = new Wikimapia.Size(16, 16)
            }
            if (!(o.size instanceof Wikimapia.Size)) {
                o.size = new Wikimapia.Size(o.size.w, o.size.h)
            }
            var n = o.size;
            this.image = Wikimapia.Utils.Dom.create("span", {
                id: this.id,
                styles: {
                    "background-image": o.image ? "url(" + o.image + ")" : "",
                    display: "block",
                    width: n.w + "px",
                    height: n.h + "px",
                    cursor: this.options.cursor || "pointer",
                    overflow: "hidden",
                    "background-repeat": "no-repeat"
                }
            });
            if (!o.imageSpritePos && !o.imageSpriteClass) {
                o.imageSpritePos = "0px 0px"
            }
            if (o.imageSpriteClass) {
                if (!o.image) this.image.style.backgroundPosition = "";
                Wikimapia.Utils.Dom.addClass(this.image, o.imageSpriteClass)
            } else {
                this.image.style.backgroundPosition = typeof o.imageSpritePos == "string" ? o.imageSpritePos : o.imageSpritePos.x + "px " + o.imageSpritePos.y + "px"
            }
            if (o.shadow) {
                var s = o.shadowSize,
                    r = o.shadowSpritePos;
                this.shadow = Wikimapia.Utils.Dom.create("span", {
                    id: this.id + "-shadow",
                    styles: {
                        display: "block",
                        "background-image": "url(" + this.options.shadow + ")",
                        width: s.w + "px",
                        height: s.h + "px",
                        overflow: "hidden",
                        "background-repeat": "no-repeat",
                        "pointer-events": "none",
                        "background-position": typeof r === "string" ? r : r.x + "px " + r.y + "px"
                    }
                });
                if (Wikimapia.Utils.alphaImageHackNeeded) {
                    Wikimapia.Utils.fixAlphaImageSprite(this.shadow)
                }
            }
        }
    },
    setImage: function (t) {
        if (this.image) {
            if (t.imageSpritePos) {
                this.setImageSpritePos(t.imageSpritePos)
            }
            if (Wikimapia.Utils.alphaImageHackNeeded) {
                Wikimapia.Utils.fixAlphaImageSprite(this.image)
            }
        }
    },
    setImageSpritePos: function (t) {
        this.image.style.backgroundPosition = typeof t === "string" ? t : t.x + "px " + t.y + "px"
    },
    setSize: function (t) {
        this.image.style.width = t.w + "px";
        this.image.style.height = t.h + "px"
    },
    draw: function (t) {
        if (t) {
            this.options.position = t;
            if (this.image) {
                Wikimapia.Utils.Dom.setStyles(this.image, {
                    position: "absolute",
                    top: t.y + "px",
                    left: t.x + "px"
                })
            }
            if (this.shadow) {
                var e = this.options.shadowOffset;
                Wikimapia.Utils.Dom.setStyles(this.shadow, {
                    position: "absolute",
                    top: t.y + e.h + "px",
                    left: t.x + e.w + "px"
                })
            }
        }
    },
    moveTo: function (t) {
        this.draw(t)
    },
    destroy: function () {
        if (this.image) {
            Wikimapia.Utils.Dom.destroy(this.image);
            delete this.image
        }
        if (this.shadow) {
            Wikimapia.Utils.Dom.destroy(this.shadow);
            delete this.shadow
        }
    },
    getPosition: function () {
        return this.options.position.clone()
    },
    getElement: function () {
        if (!this.image && !this.shadow) {
            this.create()
        }
        if (this.shadow) {
            return $([this.image, this.shadow])
        } else {
            return this.image
        }
    },
    inject: function (t, e) {
        if (this.shadow) {
            Wikimapia.Utils.Dom.inject(this.shadow, t, e)
        }
        Wikimapia.Utils.Dom.inject(this.image, t, e)
    },
    getSize: function () {
        return this.options.size.clone()
    },
    show: function () {
        var t = this.getElement();
        if (t.length) {
            t[0].show();
            t[1].show()
        } else {
            t.show()
        }
        return this
    },
    hide: function () {
        var t = this.getElement();
        if (t.length) {
            t[0].hide();
            t[1].hide()
        } else {
            t.hide()
        }
        return this
    },
    clone: function () {
        return new Wikimapia.Icon(this.options)
    }
};
Wikimapia.Object = function (t) {
    t = t || {};
    for (var e in t) {
        if (t.hasOwnProperty(e) && typeof t[e] !== "undefined") {
            this[e] = t[e]
        }
    }
    this.id = parseInt(this.id)
};
Wikimapia.Object.objectTypes = {
    PLACE: 1,
    LINEAR: 2
};
Wikimapia.Object.linearTypes = {
    STREET: 0,
    FERRY: 2,
    RAILROAD: 1,
    RIVER: 10
};
Wikimapia.Object.objectTypeNames = {
    OBJECT: "object",
    PLACE: "place",
    LINEAR: "linear",
    STREET: "street",
    RIVER: "river",
    FERRY: "ferry",
    RAILROAD: "railroad"
};
Wikimapia.Object.objectState = {
    EXISTS: -2,
    CHILD_OBJECT_EXISTS: 9,
    LINEAR_EXISTS: 18,
    CHILD_OBJECT_CANT_UNBIND: 0,
    IN_UNDELETION_QUEUE: 1,
    DELETED: 2,
    IN_DELETION_QUEUE: 3,
    PARENT_EXISTS: 8,
    EXISTS_FROM_MAP: -1
};
Wikimapia.Object.protectionStatus = {
    PROTECTED: -1,
    NOT_PROTECTED: 1
};
Wikimapia.Object.objectTypePrefixes = ["", "", "street", "road", "railroad", "ferry", "river"];
Wikimapia.Object.prototype = {
    constructor: Wikimapia.Object,
    id: 0,
    type: 0,
    typeName: Wikimapia.Object.objectTypeNames.OBJECT,
    currentLanguage: "en",
    availableLanguages: null,
    typeName: null,
    mbr: null,
    geometry: null,
    protectionStatus: Wikimapia.Object.protectionStatus.NOT_PROTECTED,
    deletionState: Wikimapia.Object.objectState.EXISTS,
    toJSON: function () {
        var t = {};
        for (var e in this) {
            if (typeof this[e] !== "function") {
                t[e] = this[e]
            }
        }
        return t
    },
    isNew: function () {
        return this.id === 0
    },
    getUrl: function (t) {
        var e = [this.id],
            i;
        t = t || this.currentLanguage;
        if (t !== "en") {
            e.push(t)
        }
        if (t === this.currentLanguage) {
            i = this.title
        } else if (this.titles) {
            i = this.titles[Wikimapia.Lang.lngToCode(t)]
        }
        if (i) {
            i = i.replace(/[^\w\-\(\)\u00A1-\uFFFF]+/g, "-")
                .replace(/\-+/g, "-");
            if (Browser.safari) {
                i = encodeURIComponent(i)
            }
            e.push(i)
        }
        if (this.type >= Wikimapia.Object.objectTypes.LINEAR) {
            e.unshift(this.typeName)
        }
        return "/" + e.join("/")
    },
    getEditUrl: function () {
        return "/object/edit/?" + Wikimapia.Utils.objectToQueryString(this.toJSON())
    },
    getPhotoUrl: function (t) {
        return [this.getUrl(), "photo", t].join("/")
    },
    getBounds: function () {
        var t = this.mbr;
        if (this.geometry) {
            t = this.geometry.getBounds()
        }
        return t
    },
    getProtectionStatus: function () {
        return this.protectionStatus
    },
    setProtectionStatus: function (t, e, i) {
        console.log("protect", t, this)
    },
    canBeProtected: function () {
        return !("deletionState" in this) || this.deletionState !== Wikimapia.Object.objectState.IN_UNDELETION_QUEUE && this.deletionState !== Wikimapia.Object.objectState.DELETED && this.deletionState !== Wikimapia.Object.objectState.IN_DELETION_QUEUE
    },
    isProtected: function () {
        return this.protectionStatus === Wikimapia.Object.protectionStatus.PROTECTED
    },
    _delete: function (t) {
        console.log("delete", this)
    },
    getStatus: function () {
        return this.deletionState
    },
    cancelDeletion: function (t) {
        console.log("cancel deletion", this)
    },
    restore: function (t) {
        console.log("restore", this)
    },
    cancelRestoration: function (t) {
        console.log("cancel restoration", this)
    },
    isEditable: function () {
        return !("deletionState" in this) || this.deletionState !== Wikimapia.objectStates.IN_UNDELETION_QUEUE && this.deletionState !== Wikimapia.objectStates.DELETED && this.deletionState !== Wikimapia.objectStates.IN_DELETION_QUEUE
    },
    equals: function (t) {
        return t.id === this.id && t.type === this.type
    }
};
Wikimapia.Object.getSupportedInternalDataProperties = function (t, e) {
    return Wikimapia.Utils.objectSubset(e, ["id", "mbr", "zoom", "type", "quickDel", "currentLanguage", "deletionState", "protectionStatus", "custom"])
};
Wikimapia.Object.applyInternalData = function (t, e, i) {
    Wikimapia.Utils.extend(t, Wikimapia.Object.getSupportedInternalDataProperties(t, e));
    if (i && i.length) {
        Wikimapia.Object.addAvailableLanguages(t, i)
    }
    if (!isNaN(t.currentLanguage)) {
        t.currentLanguage = Wikimapia.Lang.codeToLng(t.currentLanguage)
    }
    return t
};
Wikimapia.Object.merge = function (t, e) {
    var i = ["title", "currentLanguage", "old_lng", "quickDel", "reqedit", "newr", "newRoad", "mbr", "zoom", "protectionStatus", "deletionState"],
        a;
    for (var o = 0, n = i.length; o < n; o++) {
        a = i[o];
        if (t[a] != null) {
            e[a] = t[a]
        }
    }
    return e
};
Wikimapia.Object.processRequest = function (t, e, i) {
    e = Wikimapia.Net.securePost(Wikimapia.Utils.objectToQueryString(e));
    new Wikimapia.Net.Xhr({
        type: "json",
        url: t,
        data: e,
        method: "post",
        onSuccess: i
    })
        .send()
};
Wikimapia.Object.fromCanonicalUrl = function (t) {
    var e = "",
        i = {},
        a, o;
    t = t.split("/");
    if (t[0] === "") {
        t.shift()
    }
    if (Wikimapia.Object.objectTypePrefixes.indexOf(t[0]) !== -1) {
        e = t.shift()
    }
    i.id = parseInt(t.shift());
    if (t.length) {
        a = t.shift();
        if (Wikimapia.Lang.lngToCode(a) !== -1) {
            i.currentLanguage = a
        } else {
            i.currentLanguage = "en";
            t.unshift(a)
        }
    }
    if (t.length) {
        if (t.length > 1) {
            if (t[t.length - 2] === "photo" && !isNaN(t[t.length - 1])) {
                i.currentPhoto = t[t.length - 1];
                t = t.slice(0, t.length - 2)
            }
        }
        if (t.length) {
            t = t.pop();
            if (t) {
                i.title = decodeURIComponent(t)
            }
        }
    }
    if (e === "") {
        o = new Wikimapia.Place(i)
    } else {
        o = new Wikimapia.Linear.createLinearObject(i, e)
    }
    return o
};
Wikimapia.Object.createObject = function (t, e) {
    return new Wikimapia[e === Wikimapia.Object.objectTypes.LINEAR ? "Linear" : "Place"](t)
};
Wikimapia.Object.addAvailableLanguages = function (t, e) {
    var i = {},
        a, o;
    if (!t.titles) {
        t.titles = {}
    }
    for (var n = 0, s = e.length; n < s; n++) {
        a = e[n];
        o = Wikimapia.Lang.lngToCode(a.iso);
        Wikimapia.Lang.defineLanguageName(a.iso, a.name);
        i[o] = t.titles[o] || decodeURIComponent(a.dataurl.split("/")
                .pop())
            .replace(/-/g, " ")
    }
    t.titles = i;
    return t
};
Wikimapia.Object.fromURL = function (t) {
    var e = Wikimapia.Utils.Url.parseURLParams(t),
        i = parseInt(e.object_type) || Wikimapia.Object.objectTypes.PLACE,
        a = e.lng,
        o;
    delete e.lng;
    delete e.object_type;
    if (typeof Wikimapia.Lang.codeToLng(parseInt(a)) !== "undefined") {
        e.currentLanguage = Wikimapia.Lang.codeToLng(parseInt(a))
    } else {
        e.currentLanguage = a
    }
    if (i > Wikimapia.Object.objectTypes.LINEAR) {
        e.ltype = Wikimapia.Object.fixInternalObjectTypes(i);
        i = Wikimapia.Object.objectTypes.LINEAR
    }
    if (i === Wikimapia.Object.objectTypes.LINEAR) {
        o = Wikimapia.Linear.createLinearObject(e, parseInt(e.ltype))
    } else {
        o = new Wikimapia.Place(e)
    }
    return o
};
Wikimapia.Object.internalObjectTypes = {
    PLACE: 1,
    STREET: 2,
    RAILROAD: 3,
    FERRY: 4,
    RIVER: 5
};
Wikimapia.Object.fixInternalObjectTypes = function (t) {
    switch (t) {
        case Wikimapia.Object.internalObjectTypes.RAILROAD:
            t = Wikimapia.Object.linearTypes.RAILROAD;
            break;
        case Wikimapia.Object.internalObjectTypes.FERRY:
            t = Wikimapia.Object.linearTypes.FERRY;
            break;
        case Wikimapia.Object.internalObjectTypes.RIVER:
            t = Wikimapia.Object.linearTypes.RIVER;
            break;
        default:
            t = Wikimapia.Object.linearTypes.STREET;
            break
    }
    return t
};
Wikimapia.Place = function (t) {
    t = t || {};
    if (t.polygon) {
        t.geometry = t.polygon
    }
    if (t.titles) {
        if (typeof t.titles === "string") {
            t.titles = Wikimapia.Parser.Itiles.decodeTitles(t.titles)
        }
        if (t.currentLanguage) {
            t.title = t.titles[Wikimapia.Lang.lngToCode(t.currentLanguage)]
        }
    }
    if (t.parent) {
        t.parent = parseInt(t.parent)
    }
    if ("currentLanguage" in t && !isNaN(t.currentLanguage)) {
        t.currentLanguage = Wikimapia.Lang.codeToLng(t.currentLanguage)
    }
    Wikimapia.Object.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Place, Wikimapia.Object);
Wikimapia.Place.prototype.getEditUrl = function () {
    var t = "/object/edit/?lng={currentLanguage}&object_type={type}",
        e = this.toJSON();
    e.currentLanguage = Wikimapia.Lang.lngToCode(e.currentLanguage);
    if (!this.isNew()) {
        t += "&id={id}"
    }
    if (e.old_lng) {
        t += "&old_lng={old_lng}"
    }
    if (e.parent) {
        t += "&parent={parent}"
    }
    if (e.reqedit) {
        t += "&reqedit=1";
        delete this.reqedit
    }
    return t.substitute(e)
};
Wikimapia.Place.prototype.hasParent = function () {
    return this.parent || this.deletionState === Wikimapia.Object.objectState.CHILD_OBJECT_EXISTS || this.deletionState === Wikimapia.Object.objectState.CHILD_OBJECT_CANT_UNBIND
};
Wikimapia.Place.prototype.getParentPlace = function () {
    return new Wikimapia.Place({
        id: this.parent,
        currentLanguage: this.currentLanguage
    })
};
Wikimapia.Place.prototype.isDetachable = function () {
    return !(this.deletionState === Wikimapia.Object.objectState.CHILD_OBJECT_CANT_UNBIND)
};
Wikimapia.Place.prototype.type = Wikimapia.Object.objectTypes.PLACE;
Wikimapia.Place.prototype.typeName = Wikimapia.Object.objectTypeNames.PLACE;
Wikimapia.Place.prototype.geometry = null;
Wikimapia.Linear = function (t) {
    t = t || {};
    if (t.titles && typeof t.titles === "string") {
        t.titles = Wikimapia.Parser.Linear.decodeTitles(t.titles)
    }
    Wikimapia.Object.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Linear, Wikimapia.Object);
Wikimapia.Linear.prototype.type = Wikimapia.Object.objectTypes.LINEAR;
Wikimapia.Linear.prototype.linearType = null;
Wikimapia.Linear.prototype.geometry = null;
Wikimapia.Linear.prototype.getEditUrl = function () {
    var t = "/object/edit/?lng={currentLanguage}&object_type={type}&ltype={linearType}",
        e = this.toJSON();
    e.currentLanguage = Wikimapia.Lang.lngToCode(e.currentLanguage);
    if (!this.isNew()) {
        t += "&id={id}"
    } else {
        t += "&newr=1"
    }
    if (e.old_lng) {
        t += "&old_lng={old_lng}"
    } else {
        t += "&old_lng={currentLanguage}"
    }
    if (e.reqedit) {
        t += "&reqedit=1";
        delete this.reqedit
    }
    return t.substitute(e)
};
Wikimapia.Linear.createLinearObject = function (t, e) {
    var i = typeof e === "number" ? Wikimapia.Object.linearTypes : Wikimapia.Object.objectTypeNames;
    switch (e) {
        case i.RIVER:
            return new Wikimapia.Linear.River(t);
        case i.RAILROAD:
            return new Wikimapia.Linear.Railroad(t);
        case i.FERRY:
            return new Wikimapia.Linear.Ferry(t);
        case i.STREET:
        default:
            return new Wikimapia.Linear.Street(t)
    }
};
Wikimapia.Linear.Street = function (t) {
    Wikimapia.Linear.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Linear.Street, Wikimapia.Linear);
Wikimapia.Linear.Street.prototype.typeName = Wikimapia.Object.objectTypeNames.STREET;
Wikimapia.Linear.Street.prototype.linearType = Wikimapia.Object.linearTypes.STREET;
Wikimapia.Linear.Street.prototype.type = Wikimapia.Object.internalObjectTypes.STREET;
Wikimapia.Linear.Ferry = function (t) {
    Wikimapia.Linear.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Linear.Ferry, Wikimapia.Linear);
Wikimapia.Linear.Ferry.prototype.typeName = Wikimapia.Object.objectTypeNames.FERRY;
Wikimapia.Linear.Ferry.prototype.linearType = Wikimapia.Object.linearTypes.FERRY;
Wikimapia.Linear.Ferry.prototype.type = Wikimapia.Object.internalObjectTypes.FERRY;
Wikimapia.Linear.Railroad = function (t) {
    Wikimapia.Linear.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Linear.Railroad, Wikimapia.Linear);
Wikimapia.Linear.Railroad.prototype.typeName = Wikimapia.Object.objectTypeNames.RAILROAD;
Wikimapia.Linear.Railroad.prototype.linearType = Wikimapia.Object.linearTypes.RAILROAD;
Wikimapia.Linear.Railroad.prototype.type = Wikimapia.Object.internalObjectTypes.RAILROAD;
Wikimapia.Linear.River = function (t) {
    Wikimapia.Linear.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Linear.River, Wikimapia.Linear);
Wikimapia.Linear.River.prototype.typeName = Wikimapia.Object.objectTypeNames.RIVER;
Wikimapia.Linear.River.prototype.linearType = Wikimapia.Object.linearTypes.RIVER;
Wikimapia.Linear.River.prototype.type = Wikimapia.Object.internalObjectTypes.RIVER;
Wikimapia.Control = function (t) {
    t = t || {};
    if (t.element) {
        this.div = t.element;
        delete t.element;
        t.view = false
    }
    this.options = Wikimapia.Utils.extend({}, this.options, t);
    if (this.options.view) {
        this.div = Wikimapia.Utils.Dom.create("div", {
            id: "wm-" + this.options.name,
            "class": this.options.printable ? "wm-printable" : "wm-noprint",
            styles: {
                position: "absolute",
                display: "block"
            }
        })
    }
    this.handlers = {}
};
Wikimapia.Utils.inherits(Wikimapia.Control, Wikimapia.EventTarget);
Wikimapia.Control.prototype.options = {
    name: "Control",
    position: null,
    printable: false,
    selectable: false,
    view: true
};
Wikimapia.Control.prototype.handlers = {};
Wikimapia.Control.prototype._enabled = false;
Wikimapia.Control.prototype.div = null;
Wikimapia.Control.prototype.id = null;
Wikimapia.Control.prototype.map = null;
Wikimapia.Control.prototype.setMap = function (t) {
    this.map = t;
    if (!this.options.zIndex) {
        this.options.zIndex = this.map.zIndexBase.controls
    }
    if (this.div) {
        this.div.style.zIndex = this.options.zIndex;
        this.setPosition();
        this.render()
    }
    this.handlers.langChange = this.onLanguageChange.bind(this);
    Wikimapia.Lang.addEvent("langChanged", this.handlers.langChange)
};
Wikimapia.Control.prototype.isDisposed = function () {
    return !this.map
};
Wikimapia.Control.prototype.render = function () { };
Wikimapia.Control.prototype.getElement = function (t) {
    return t ? this.div : $(this.div)
};
Wikimapia.Control.prototype.moveTo = function (t) { };
Wikimapia.Control.prototype.setPosition = function (t) {
    if (t) {
        this.options.position = t
    }
    if (this.options.position) {
        if (this.options.position instanceof Wikimapia.Point) {
            this.options.position = Wikimapia.Point.toDomPosition(this.options.position)
        }
        this.getElement()
            .setStyles(this.options.position)
    }
};
Wikimapia.Control.prototype.onLanguageChange = function (t) { };
Wikimapia.Control.prototype.enable = function () {
    this._enabled = true
};
Wikimapia.Control.prototype.disable = function () {
    this._enabled = false
};
Wikimapia.Control.prototype.isEnabled = function () {
    return !!this._enabled
};
Wikimapia.Control.prototype.destroy = function () {
    if (this.handlers.langChange) {
        Wikimapia.Lang.removeEvent("langChanged", this.handlers.langChange)
    }
    if (this.div) {
        Wikimapia.Utils.Dom.destroy(this.div);
        delete this.div
    }
    delete this.handlers;
    delete this.map
};
(function () {
    Wikimapia.userLevels = {
        ADVANCED: 3,
        REGISTERED: 1,
        GUEST: 0
    };
    var t = Wikimapia.layerAccessModes.ALL,
        e = {
            id: parseInt(Wikimapia.Net.Cookie.read("uid")) || 0,
            name: "",
            level: 0,
            maxPoints: 750
        };
    Wikimapia.Control.Access = function (t) {
        Wikimapia.Control.prototype.constructor.call(this, t)
    };
    Wikimapia.Utils.inherits(Wikimapia.Control.Access, Wikimapia.Control);
    Wikimapia.Control.Access.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
        name: "access",
        view: false
    });
    Wikimapia.Control.Access.prototype.awards = null;
    Wikimapia.Control.Access.prototype.setMap = function (t) {
        Wikimapia.Control.prototype.setMap.call(this, t);
        this.handlers.accessModeChanged = this.initAccess.bind(this);
        this.map.addEvent("accessModeChanged", this.handlers.accessModeChanged);
        this.map.access = this;
        this.defineGetters();
        this.awards = new Wikimapia.Control.User.Awards(t)
    };
    Wikimapia.Control.Access.prototype.initAccess = function () {
        t = this.map.layers[0].getAccessMode()
    };
    Wikimapia.Control.Access.prototype.defineGetters = function () {
        var i, a;
        for (i in e) {
            if (e.hasOwnProperty(i)) {
                this["getUser" + i.capitalize()] = function (t) {
                    return function () {
                        return e[t]
                    }
                }(i)
            }
        }
        for (i in Wikimapia.layerAccessModes) {
            if (Wikimapia.layerAccessModes.hasOwnProperty(i)) {
                a = Wikimapia.layerAccessModes[i];
                this["allowsFeature" + i.toLowerCase()
                    .capitalize()] = function (e, i) {
                        return function () {
                            return !!(t & e)
                        }
                    }(a, this.map)
            }
        }
    };
    Wikimapia.Control.Access.prototype.setUser = function (t, i, a) {
        if (e.id === 0 || e.id === t || t === 0) {
            var o = +e.id;
            if (t === 0) {
                e.name = "";
                Wikimapia.Net.Cookie.remove("uid");
                Wikimapia.Net.Cookie.remove("pwh")
            }
            e.id = t;
            e.name = i || "";
            if (e.name === "" && e.id !== 0) {
                e.id = 0;
                return this.setUser(0)
            }
            e.level = a || 0;
            if (e.id === 0) {
                e.level = 0
            }
            if (o !== t) {
                this.map.fireEvent("authorization", t !== 0)
            }
        }
        this[(e.id === 0 ? "restrict" : "grant") + "Access"](Wikimapia.layerAccessModes.DELETE)
    };
    Wikimapia.Control.Access.prototype.getUserLevel = function () {
        return +e.level
    };
    Wikimapia.Control.Access.prototype.getUserPolygonPointsLimit = function () {
        return e.maxPoints
    };
    Wikimapia.Control.Access.prototype.getUserId = function () {
        return e.id
    };
    Wikimapia.Control.Access.prototype.userIsAuthorized = function () {
        return e.id !== 0
    };
    Wikimapia.Control.Access.prototype.userIsRegistered = function () {
        return e.level >= Wikimapia.userLevels.REGISTERED
    };
    Wikimapia.Control.Access.prototype.userIsAdvanced = function () {
        return e.level === Wikimapia.userLevels.ADVANCED
    };
    Wikimapia.Control.Access.prototype.accessCheck = function (t, e, i) {
        e = Wikimapia.Utils.getCallback(e);
        i = Wikimapia.Utils.getCallback(i);
        new Wikimapia.Net.Xhr({
            type: "json",
            method: "get",
            noCache: true,
            onSuccess: function (t) {
                if (t.code) {
                    this.map.fireEvent("responseError", [t, i]);
                    return false
                } else {
                    e(t);
                    return true
                }
            }.bind(this)
        })
            .send({
                url: "/ajax/check/?function=" + t
            })
    };
    Wikimapia.Control.Access.prototype.restrictAccess = function (e) {
        t &= ~e;
        return this
    };
    Wikimapia.Control.Access.prototype.grantAccess = function (e) {
        if (!this.map.baseLayer.isBaseLayer || this.map.baseLayer.getAccessMode() & e) {
            t |= e
        }
        return this
    };
    Wikimapia.Control.Access.prototype.showAccessMode = function () {
        Wikimapia.Console.info("Access control", " access mode: Edit: ", this.allowsFeatureEdit(), " Create: ", this.allowsFeatureCreate(), " View: ", this.allowsFeatureView(), " Delete: ", this.allowsFeatureDelete(), " Save: ", this.allowsFeatureSave())
    };
    Wikimapia.Control.Access.prototype.getAccessMode = function () {
        return t
    };
    Wikimapia.Control.Access.prototype.destroy = function () {
        delete this.map.access;
        this.map.removeEvent("accessModeChanged", this.handlers.accessModeChanged);
        this.awards.destroy();
        this.awards = null;
        Wikimapia.Control.prototype.destroy.call(this)
    };
    Wikimapia.Control.Access.states = {
        BANNED: 2,
        TIMEOUT: 1,
        UNAUTHORIZED: 3,
        DENIED: 5,
        PENDING_ACTIVATION: 6,
        LOW_EXP: 4
    }
})();
Wikimapia.Control.User = Wikimapia.Control.User || {};
Wikimapia.Control.User.Awards = function (t) {
    this.map = t;
    this.onAwardRecieved = this.onAwardRecieved.bind(this);
    this.onAwardShare = this.onAwardShare.bind(this);
    this.map.addEvents({
        awardReceived: this.onAwardRecieved,
        shareAward: this.onAwardShare
    })
};
Wikimapia.Utils.inherits(Wikimapia.Control.User.Awards, Wikimapia.EventTarget);
Wikimapia.Control.User.Awards.detailsUrl = "/user/awards/get_info/";
Wikimapia.Control.User.Awards.prototype.onAwardShare = function (t) {
    this.requestAwardData(t, this.onAwardRecieved)
};
Wikimapia.Control.User.Awards.prototype.requestAwardData = function (t, e) {
    t.uid = this.map.access.getUserId();
    new Wikimapia.Net.Xhr({
        method: "get",
        type: "json",
        data: t,
        onSuccess: e
    })
        .send({
            url: Wikimapia.Control.User.Awards.detailsUrl
        })
};
Wikimapia.Control.User.Awards.prototype.onAwardRecieved = function (t) {
    var e = "/img/awards/{award_type}/140/{award_id}.png".substitute(t);
    Wikimapia.Net.Asset.image(e, {
        onLoad: function () {
            var e = '<div class="award-notification">' + '<span class="close" id="alertify-cancel">&times;</span>' + '<img class="award-img" src="/img/awards/{award_type}/140/{award_id}.png" ' + 'alt="{title}" /><p class="alertify-message">{message}</p>' + '<input type="hidden" value="{share_text}" class="award-share-text" />' + '<input type="hidden" value="{share_text}" class="award-share-title" />' + '<input type="hidden" value="{award_type}" class="award-type" />' + '<input type="hidden" value="{award_id}" class="award-id" />' + "</div>",
                i = '<div class="alertify-buttons social-buttons award-share-buttons">' + '<span class="award-share-buttons-label">' + Wikimapia.Lang.get("all.awards-tell-friends") + "</span><br>" + '<span class="share-button award-facebook-share" data-provider="facebook">' + '<i class="icon icon-fb"></i>&nbsp;Facebook</span>' + '<span class="share-button award-twitter-share" data-provider="twitter">' + '<i class="icon icon-twitter"></i>&nbsp;Twitter</span>' + '<span class="share-button award-vkontakte-share" data-provider="vkontakte">' + '<i class="icon icon-vk"></i>&nbsp;VK</span>' + '<span class="share-button award-google-share" data-provider="google">' + '<i class="icon icon-google"></i>&nbsp;Google+</span>' + '<div class="hide">{{buttons}}</div></div>';
            Wikimapia.Interface.Dialog.custom(e.substitute(t), undefined, {
                buttons: {
                    holder: i
                }
            });
            this.onAwardDialogDisplayed()
        }.bind(this)
    })
};
Wikimapia.Control.User.Awards.prototype.onAwardDialogDisplayed = function () {
    var t = Wikimapia.Interface.Dialog.getElement();
    if (!t.getAttribute("data-awards-activated")) {
        Wikimapia.Utils.Dom.addEvent(t, "click", ".award-share-buttons .share-button", this.onShareAwardClick.bind(this));
        t.setAttribute("data-awards-activated", true)
    }
};
Wikimapia.Control.User.Awards.prototype.onShareAwardClick = function (t) {
    var e = t.currentTarget,
        i = Wikimapia.Interface.Dialog.getElement(),
        a = Wikimapia.Utils.Dom.getElement(i, ".award-share-text")
        .value,
        o = Wikimapia.Utils.Dom.getElement(i, ".award-share-title")
        .value,
        n = parseInt(Wikimapia.Utils.Dom.getElement(i, ".award-type")
            .value),
        s = parseInt(Wikimapia.Utils.Dom.getElement(i, ".award-id")
            .value),
        r = Wikimapia.Utils.Dom.getElement(".award-img")
        .src,
        p = this.getUserAwardsUrl(n, s),
        l = e.getAttribute("data-provider"),
        c = function () {
            Wikimapia.Utils.Dom.addClass(e, "complete");
            e.blur()
        };
    switch (l) {
        case Wikimapia.Social.providerNames.FACEBOOK:
            Wikimapia.Social.Facebook.shareAward(o, a, p, r, c);
            break;
        case Wikimapia.Social.providerNames.TWITTER:
            Wikimapia.Social.Twitter.shareAward(o, a, p, r, c);
            break;
        case Wikimapia.Social.providerNames.GOOGLE:
            Wikimapia.Social.Google.shareAward(o, a, p, r, c);
            break;
        case Wikimapia.Social.providerNames.VKONTAKTE:
            Wikimapia.Social.Vkontakte.shareAward(o, a, p, r, c);
            break;
        default:
            break
    }
};
Wikimapia.Control.User.Awards.prototype.getUserAwardsUrl = function (t, e) {
    var i = Wikimapia.Utils.Url.getLocationOrigin();
    return i + "/user/awards/share/?" + Wikimapia.Utils.objectToQueryString({
        id: e,
        type: t,
        uid: this.map.access.getUserId(),
        lng: Wikimapia.Lang.getCurrentLanguage()
    })
};
Wikimapia.Control.User.Awards.prototype.destroy = function () {
    this.map.removeEvents({
        awardReceived: this.onAwardRecieved,
        shareAward: this.onAwardShare
    });
    this.map = null
};
Wikimapia.Control.WindowManager = function (t) {
    this.map = t;
    this.map.windowManager = this;
    Wikimapia.EventTarget.prototype.constructor.call(this)
};
Wikimapia.Utils.inherits(Wikimapia.Control.WindowManager, Wikimapia.Control);
Wikimapia.Control.WindowManager.prototype.map = null;
Wikimapia.Control.WindowManager.prototype.destroy = function () {
    delete this.map
};
Wikimapia.responseCodes = {
    BIND_SUCCESS: 41,
    UNBIND_SUCCESS: 46,
    UNBIND_ERROR_NO_GEOMETRY: 44,
    DELETED: 27,
    DELETE_HAS_NESTED: 25,
    DELETION_CANCELLED: 28,
    UNDELETED: 30,
    UNDELETION_CANCELLED: 31,
    PLACE_UPDATED: 20,
    LINEAR_UPDATED: 50,
    COMMENT_SEND_OK: 0,
    COMMENT_SEND_OK_CAPTCHA: 1,
    COMMENT_WRONG_CAPTCHA: 5
};
Wikimapia.Control.Object = function (t) {
    Wikimapia.Control.prototype.constructor.call(this, t);
    this.onShow = this.onShow.bind(this)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object, Wikimapia.Control);
Wikimapia.Control.Object.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "Object",
    tilesRedrawTimeout: 1500
});
Wikimapia.Control.Object.prototype.editing = false;
Wikimapia.Control.Object.prototype.currentObject = null;
Wikimapia.Control.Object.prototype._place = null;
Wikimapia.Control.Object.prototype._linear = null;
Wikimapia.Control.Object.prototype._photos = null;
Wikimapia.Control.Object.prototype._nested = null;
Wikimapia.Control.Object.prototype._protect = null;
Wikimapia.Control.Object.prototype._delete = null;
Wikimapia.Control.Object.prototype._ads = null;
Wikimapia.Control.Object.prototype._comments = null;
Wikimapia.Control.Object.prototype.urls = {
    promote: "/promote/?event=social&data={obj}"
};
Wikimapia.Control.Object.prototype.initComponents = function () {
    this._place = new Wikimapia.Control.Object.Place(this);
    this._linear = new Wikimapia.Control.Object.Linear(this);
    this._nested = new Wikimapia.Control.Object.Nested(this);
    this._protect = new Wikimapia.Control.Object.Protect(this);
    this._delete = new Wikimapia.Control.Object.Delete(this);
    this._history = new Wikimapia.Control.Object.History(this);
    this._comments = new Wikimapia.Control.Object.Comments(this);
    this._photos = new Wikimapia.Control.Object.Photos(this);
    this._ads = new Wikimapia.Control.Object.Ads(this)
};
Wikimapia.Control.Object.prototype.setMap = function (t) {
    Wikimapia.Control.prototype.setMap.call(this, t);
    this.initComponents();
    Wikimapia.Utils.extend(this.handlers, {
        edit: this.editObject.bind(this),
        show: this.showObject.bind(this),
        historyRevision: this._history.viewRevision.bind(this._history),
        deleteObject: this._delete.beforeDelete.bind(this._delete),
        processDelete: this._delete.processObjectDeletion.bind(this._delete),
        processObjectBind: this._nested.bindTo.bind(this._nested),
        showPhoto: this._photos.show.bind(this._photos),
        editPhotos: this._photos.edit.bind(this._photos),
        onPhotoShown: this._photos.onShow.bind(this._photos),
        onPhotoClose: this._photos.onClose.bind(this._photos),
        promoteAds: this._ads.promote.bind(this._ads),
        processComment: this._comments.processComment.bind(this._comments),
        scrollToElement: false,
        setUserIdLeftPanel: this.setUserIdLeftPanel.bind(this)
    });
    this.map.addEvents({
        edit: this.handlers.edit,
        show: this.handlers.show,
        historyRevision: this.handlers.historyRevision,
        showphoto: this.handlers.showPhoto,
        photo_shown: this.handlers.onPhotoShown,
        photo_close: this.handlers.onPhotoClose,
        photomanager: this.handlers.editPhotos,
        "delete": this.handlers.deleteObject,
        process_delete: this.handlers.processDelete,
        process_child_object_bind: this.handlers.processObjectBind,
        promote: this.handlers.promoteAds,
        comment_sent: this.handlers.processComment,
        authorization: this.handlers.setUserIdLeftPanel
    })
};
Wikimapia.Control.Object.prototype.paramsRequireEdit = function (t) {
    if (t) {
        return "old_lng" in t
    } else {
        return false
    }
};
Wikimapia.Control.Object.prototype.editObject = function (t, e) {
    if (!this.map.access.userIsAuthorized() && !t.isNew()) {
        return app.showAccessDenied({
            state: Wikimapia.Control.Access.states.UNAUTHORIZED
        }, t.getEditUrl())
    }
    var i = e ? Wikimapia.Utils.Url.parseURLParams(e) : null;
    if (this.currentObject && !this.paramsRequireEdit(i) && this.currentObject.equals(t) && !t.isNew()) {
        Wikimapia.Utils.extend(t, this.currentObject);
        t = this.currentObject
    } else {
        this.currentObject = t
    }
    if (t.type === Wikimapia.Object.objectTypes.PLACE) {
        if (i && i.select_child) {
            this._nested.selectChildPlace(t, e, i)
        } else {
            this._place.edit(t, i)
        }
    } else {
        this._linear.edit(t, i)
    }
};
Wikimapia.Control.Object.prototype.showObject = function (t) {
    var e = t.getUrl();
    if (t.currentComment) {
        this.options.scrollToElement = "comment-" + t.currentComment
    }
    if (t.currentPhoto) {
        e += "#/photo/" + t.currentPhoto
    }
    this.currentObject = t;
    this.objectWindow = this.map.createPanel({
        url: e,
        iframe: true,
        position: "left",
        size: this.getPanelSizeForObject(),
        menu: this.getMenuForObject(t, t.type, true),
        onClose: function () {
            this.map.updateShowHash("", true)
        }.bind(this)
    });
    this.objectWindow.removeEvent("load", this.onShow);
    this.objectWindow.addEvent("load", this.onShow);
    if (t.currentPhoto) {
        this.objectWindow.focus()
    }
};
Wikimapia.Control.Object.prototype.getObjectWindow = function (t) {
    if (!this.objectWindow || this.objectWindow.isDisposed()) {
        if (t) {
            this.objectWindow = this.map.createPanel({
                url: t.getUrl(),
                iframe: true,
                position: "left",
                size: this.getPanelSizeForObject(),
                menu: this.getMenuForObject(t, t.type),
                onLoad: this.onShow.bind(this),
                onClose: function () {
                    delete this.objectWindow;
                    this.map.updateShowHash("", true)
                }.bind(this)
            })
        } else {
            this.objectWindow = this.map.createPanel({
                content: "",
                iframe: false,
                position: "left",
                size: this.getPanelSizeForObject()
            })
        }
    }
    return this.objectWindow
};
Wikimapia.Control.Object.prototype.onShow = function () {
    app.processCommand(null, flphoar[20]);
    flphoar[20] = null;
    this.fakeObjectUrl(this.currentObject, true);
    if (this.options.scrollToElement) {
        setTimeout(function () {
            this.objectWindow.scrollToElement(this.options.scrollToElement, 200)
        }.bind(this), 1e3)
    }
    this.objectWindow.removeEvent("load", this.onShow)
};
Wikimapia.Control.Object.prototype.fakeObjectUrl = function (t, e) {
    if (!t.isNew() && this.map.panelUrl !== t.getUrl()) {
        this.map.updateShowHash(t.getUrl(), true, e)
    }
};
Wikimapia.Control.Object.prototype.getPanelSizeForObject = function () {
    var t = Wikimapia.Utils.Dom.getSize(window)
        .x,
        e = 800;
    if (t < 1200) {
        e = 600
    } else {
        e = Math.max(t * .4, 800)
    }
    return new Wikimapia.Size(e, 100)
};
Wikimapia.Control.Object.prototype.getPanelSizeForObjectEdit = function () {
    return this.getPanelSizeForObject()
};
Wikimapia.Control.Object.prototype.getEditorComponent = function (t) {
    if (t.type === Wikimapia.Object.objectTypes.PLACE) {
        return this._place
    } else {
        return this._linear
    }
};
Wikimapia.Control.Object.prototype.zoomIntoView = function (t) {
    var e = this.currentObject.mbr,
        i, a = 0;
    this.objectWindow.hide(function () {
        var t = this.map.getPanel("right");
        if (t && t.isDisplayed && this.map.getCurrentSize()
            .w < 800) {
            t.hide(function () {
                this.map.zoomToBounds(e)
            }.bind(this))
        } else {
            this.map.zoomToBounds(e)
        }
    }.bind(this))
};
Wikimapia.Control.Object.prototype.getMenuForObject = function (t, e, i) {
    var a = this.map,
        o = [],
        n = t.id === 0;
    if (i) {
        return [{
            text: "loading",
            disabled: true
        }]
    }
    if (n) return [];
    o.push({
        text: "show-menu-history",
        icon: {
            spritePos: "-18px -90px"
        },
        action: function () {
            this._history.view(t, "", t.type)
        }.bind(this)
    });
    if (t.isEditable()) {
        o.push({
            text: "show-menu-edit-page",
            icon: {
                spritePos: "-18px -144px"
            },
            action: function () {
                Wikimapia.Utils.Logger.logPlaceAction("place_edit_menu_click");
                this.editObject(t)
            }.bind(this)
        })
    } else {
        o.push(this._delete.getDeletionMenuItem(t))
    }
    o.unshift({
        title: "show-menu-on-map",
        text: "&thinsp;",
        icon: {
            spritePos: "-18px -1345px"
        },
        action: function () {
            this.zoomIntoView(t)
        }.bind(this)
    });
    return o.reverse()
};
Wikimapia.Control.Object.prototype.processData = function (t) {
    var e = this,
        i = function (t) {
            if (typeof t === "function") {
                return function () {
                    t.apply(this, arguments);
                    window.is_changed = 0;
                    e.editing = true
                }
            }
            return t
        };
    t.onFailure = i(t.onFailure);
    t.onSuccess = i(t.onSuccess);
    t.onRequest = t.onRequest || function () {
        if (this.objectWindow) {
            this.objectWindow.setLoading()
        }
    }.bind(this);
    t.type = "json";
    if (t.keepContext) {
        t.onRequest = Wikimapia.Utils.noop
    }
    return new Wikimapia.Net.Xhr(t)
        .send()
};
Wikimapia.Control.Object.prototype.promoteSocial = function (t) {
    router.route(this.urls.promote.substitute({
        obj: t
    }))
};
Wikimapia.Control.Object.prototype.setUserIdLeftPanel = function () {
    if (this.map.getPanel("left") && this.map.getPanel("left")
        .getContext() && typeof this.map.getPanel("left")
        .getContext()
        .userId !== "undefined") {
        this.map.getPanel("left")
            .getContext()
            .userId = this.map.access.getUserId()
    }
};
Wikimapia.Control.Object.prototype.destroy = function () {
    this.map.removeEvents({
        edit: this.handlers.edit,
        show: this.handlers.show,
        historyRevision: this.handlers.historyRevision,
        showphoto: this.handlers.showPhoto,
        photo_shown: this.handlers.onPhotoShown,
        photo_close: this.handlers.onPhotoClose,
        photomanager: this.handlers.editPhotos,
        "delete": this.handlers.deleteObject,
        process_delete: this.handlers.processDelete,
        process_child_object_bind: this.handlers.processObjectBind,
        promote: this.handlers.promoteAds,
        comment_sent: this.handlers.processComment
    });
    this._place.destroy();
    this._linear.destroy();
    this._nested.destroy();
    this._protect.destroy();
    this._delete.destroy();
    this._history.destroy();
    this._comments.destroy();
    this._photos.destroy();
    this._ads.destroy();
    delete this._place;
    delete this._linear;
    delete this._nested;
    delete this._protect;
    delete this._delete;
    delete this._history;
    delete this._comments;
    delete this._photos;
    delete this._ads;
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.Object.AddButton = function (t) {
    Wikimapia.Control.prototype.constructor.call(this);
    t.addControl(this)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.AddButton, Wikimapia.Control);
Wikimapia.Control.Object.AddButton.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    view: true,
    name: "Add",
    position: {
        left: 60,
        top: 40
    }
});
Wikimapia.Control.Object.AddButton.prototype.button = null;
Wikimapia.Control.Object.AddButton.prototype.render = function () {
    Wikimapia.Control.prototype.render.call(this);
    this.button = new Wikimapia.Interface.Button({
        icon: new Wikimapia.Icon({
            image: Wikimapia.Control.Object.AddButton.SPRITE_PATH,
            imageSpritePos: "-18px -900px"
        }),
        text: "add-place"
    });
    this.bindEvents();
    this.button.inject(this.div);
    Wikimapia.Utils.Dom.addClass(this.div, "add-place")
};
Wikimapia.Control.Object.AddButton.prototype.bindEvents = function () {
    Wikimapia.Utils.bindHandlers(this, "onClick");
    this.button.addEvent("click", this.handlers.onClick)
};
Wikimapia.Control.Object.AddButton.prototype.onClick = function () {
    if (!this.button.disabled) {
        this.button.setLoading();
        this.map.addPlace("btn", this.onActionComplete.bind(this))
    }
};
Wikimapia.Control.Object.AddButton.prototype.onActionComplete = function () {
    this.button.stopLoading()
};
Wikimapia.Control.Object.AddButton.prototype.destroy = function () {
    this.button.removeEvent("click", this.handlers.onClick);
    this.button.destroy();
    delete this.button;
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.Object.AddButton.SPRITE_PATH = Wikimapia.Utils.defaultImagesUrl + "menu-spt.png";
Wikimapia.Control.Object.Component = function (t) {
    if (t) {
        this.control = t;
        this.map = t.map
    }
};
Wikimapia.Control.Object.Component.prototype = {
    constructor: Wikimapia.Control.Object.Component,
    control: null,
    map: null,
    setObject: function (t) {
        if (!this.control.currentObject || !this.control.currentObject.equals(t)) {
            this.control.currentObject = t
        }
    },
    destroy: function () {
        this.map = null;
        this.control = null
    }
};
Wikimapia.Control.Object.Data = function (t) {
    Wikimapia.Control.Object.Component.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Data, Wikimapia.Control.Object.Component);
Wikimapia.Control.Object.Data.focusFields = {
    CATEGORY: "category",
    DESCRIPTION: "description",
    WIKIPEDIA: "wikipedia",
    ADDRESS: "address",
    BUILDING_FLAG: "building"
};
Wikimapia.Control.Object.Data.prototype.form = null;
Wikimapia.Control.Object.Data.prototype.collapsible = null;
Wikimapia.Control.Object.Data.addLanguageUrl = "/object/edit/?id={id}&object_type={type}&old_lng={currentLanguage}&reqedit=1";
Wikimapia.Control.Object.Data.prototype.editGeometry = function (t) { };
Wikimapia.Control.Object.Data.prototype.appendGeometryData = function (t) { };
Wikimapia.Control.Object.Data.prototype.getFormLoadHandler = function (t, e) {
    return function () {
        this.initForm(t, e);
        this.updateUrl(t)
    }.bind(this)
};
Wikimapia.Control.Object.Data.prototype.updateUrl = function (t) {
    this.map.panelUrl = this.map.getPanel("left")
        .getUrl();
    this.map.fireEvent("contentChanged")
};
Wikimapia.Control.Object.Data.prototype.initFormInternal = function (t) {
    window.is_changed = 0;
    this.editing = true;
    this.form = t;
    if (!this.control.map.access.userIsAuthorized()) {
        Wikimapia.Utils.Dom.removeClass(Wikimapia.Utils.Dom.getElements(t, "#optional-fields .in"), "in")
    }
    var e = Wikimapia.Utils.Dom.getElement(t, "#optional-fields");
    if (e && !this.collapsible) {
        this.collapsible = new Wikimapia.Interface.Collapsible(e)
    }
    this.control.objectWindow.addEventOnce("unload", function () {
        Wikimapia.Utils.Dom.removeEvents(t);
        if (this.collapsible) {
            this.collapsible.destroy();
            delete this.collapsible
        }
        window.is_changed = 0;
        this.editing = false;
        this.control.map.fireEvent("editorStopped", this)
    }.bind(this));
    this.initActions(t);
    this.initTogglers(t);
    this.control.map.fireEvent("editorStart", this)
};
Wikimapia.Control.Object.Data.prototype.initActions = function (t) {
    var e = $(t)
        .getElements(".object-actions .action"),
        i = this.control,
        a = this.control.currentObject;
    e.addEvent("click", function () {
        var t = this.getAttribute("data-action");
        switch (t) {
            case "manage-photos":
                i._photos.edit(a, Wikimapia.Control.Object.Photos.url.substitute(a));
                break;
            case "edit-polygon":
                i._place.editGeometry(a);
                break;
            case "promote":
                i._ads.promote(a);
                break;
            case "delete":
                i._delete.beforeDelete(a, Wikimapia.Object.objectState.EXISTS);
                break;
            case "cancel-deletion":
                i._delete.beforeDelete(a, Wikimapia.Object.objectState.IN_DELETION_QUEUE);
                break;
            case "undelete":
                i._delete.beforeDelete(a, Wikimapia.Object.objectState.DELETED);
                break;
            case "cancel-undeletion":
                i._delete.beforeDelete(a, Wikimapia.Object.objectState.IN_UNDELETION_QUEUE);
                break;
            case "protect":
                i._protect.processObjectProtection(a, 1);
                break;
            case "unprotect":
                i._protect.processObjectProtection(a, 0);
                break;
            case "detach":
                i._nested.unbind(a);
                break;
            default:
                break
        }
    })
};
Wikimapia.Control.Object.Data.prototype.addLanguage = function (t) {
    var e = t.toJSON();
    e.currentLanguage = Wikimapia.Lang.lngToCode(e.currentLanguage);
    this.control.getObjectWindow(t)
        .open({
            url: Wikimapia.Control.Object.Data.addLanguageUrl.substitute(e),
            iframe: false
        })
};
Wikimapia.Control.Object.Data.prototype.getPlaceLanguageMenuItems = function (t) {
    var e = [],
        i = function (t) {
            var e = t.target.tagName.toLowerCase() === "a" ? $(t.target) : $(t.target)
                .getParent("a"),
                i = e.getElement(".place-lang-iso-name")
                .getAttribute("data-url");
            router.route(i);
            t.stop()
        },
        a;
    if (t.titles) {
        for (var o in t.titles) {
            a = Wikimapia.Lang.codeToLng(o);
            if (a && a !== t.currentLanguage) {
                e.push({
                    text: '<span class="place-lang-iso-name" data-url="' + t.getUrl(a) + '">' + a.toUpperCase() + "</span>" + Wikimapia.Lang.getLanguageName(a),
                    action: i
                })
            }
        }
    }
    if (e.length) {
        e = {
            items: e
        }
    } else {
        e = {
            disabled: true
        }
    }
    e.text = t.currentLanguage.toUpperCase();
    return e
};
Wikimapia.Control.Object.Data.prototype.initTogglers = function (t) {
    var e = Wikimapia.Utils.Dom.getElement(t, ".form-actions");
    if (e) {
        e.style.display = "block"
    }
};
Wikimapia.Control.Object.Data.prototype.addNearestStreetsSelect = function (t) {
    var e = this.control.map.getBounds(),
        i = t.form["langid"],
        a = i.type === "hidden" ? i.value : i.options[i.selectedIndex].value;
    new Wikimapia.Net.Xhr({
        method: "get",
        type: "json",
        url: "/ajax/getNearestLinear/?" + Wikimapia.Utils.objectToQueryString({
            action: "near_streets",
            x1: e.left,
            y1: e.bottom,
            x2: e.right,
            y2: e.top,
            ltype: (new Wikimapia.Cache)
                .retrieve("linearTypeId") || 0,
            lng: a
        }),
        onSuccess: function (e) {
            var i = e;
            new Wikimapia.Interface.Select({
                el: t.input.parentNode,
                input: t.input,
                linkTemplate: '<a href="#" data-id="{id}" class="{cls}">{value}{state}</a>',
                defaultValue: t.input.value,
                items: i.map(function (t) {
                    if (t.is_deleted) {
                        t.state = " &ndash; " + (Wikimapia.Lang.get("all.save-del-marked") || "marked for deletion");
                        t.cls = "muted"
                    } else {
                        delete t.is_deleted
                    }
                    return t
                }),
                onSelect: t.onSelect || Wikimapia.Utils.noop,
                onNewoption: t.onNewoption || Wikimapia.Utils.noop
            });
            (t.onInit || Wikimapia.Utils.noop)(i)
        }
    })
        .send()
};
Wikimapia.Control.Object.Data.prototype.destroy = function () {
    Wikimapia.Control.Object.Component.prototype.destroy.call(this);
    this.form = null
};
Wikimapia.Control.Object.Place = function (t) {
    Wikimapia.Control.Object.Data.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Place, Wikimapia.Control.Object.Data);
Wikimapia.Control.Object.Place.url = "/object/edit/?do=saveinfo";
Wikimapia.Control.Object.Place.prototype.edit = function (t, e) {
    var i = t.getEditUrl();
    Wikimapia.Utils.Logger.logPlaceAction(t.isNew() ? "place_new_data_start" : "place_edit_data_start");
    if (t.isNew() || this.map.access.userIsAuthorized()) {
        (new Wikimapia.Cache)
        .clear("currentCategories");
        this.control.objectWindow = this.map.createPanel({
            url: i,
            onClose: function () {
                this.map.updateShowHash("", true)
            }.bind(this),
            menu: this.control.getMenuForObject(t, t.type),
            iframe: false,
            position: "left",
            size: this.control.getPanelSizeForObjectEdit()
        });
        this.control.objectWindow.addEventOnce("error", function () {
            Wikimapia.Utils.Logger.logPlaceAction(t.isNew() ? "place_new_data_load_error" : "place_edit_data_load_error")
        }.bind(this));
        this.control.objectWindow.addEventOnce("load", this.getFormLoadHandler(t, e))
    } else {
        this.map.fireEvent("accessError", [{
            state: 3
        }, i])
    }
};
Wikimapia.Control.Object.Place.prototype.editGeometry = function (t) {
    var e = this.map.getLayerByName("wikimapia.interactive.*"),
        i;
    if (e && !(this.map.vectorLayer.polygonEditor && this.map.vectorLayer.polygonEditor.inProgress)) {
        this.map.fireEvent("show", t);
        e.edit("polygon", t);
        this.map.closeWindow();
        delete app.objectWindow;
        i = this.map.getPanel("left");
        if (i) {
            i.hide()
        }
    }
};
Wikimapia.Control.Object.Place.prototype.initForm = function (t, e) {
    Wikimapia.Utils.Logger.logPlaceAction(t.isNew() ? "place_new_data_form" : "place_edit_data_form");
    var i = document.getElementById("wikiedit"),
        a = document.getElementById("street_name");
    if (!i && this.control.currentObject && this.control.currentObject.parent) {
        this.map.getPanel("left")
            .history.back()
    }
    if (!i || i.getAttribute("data-inited")) {
        return
    }
    Wikimapia.Utils.Dom.addEvents(i, {
        submit: function (e) {
            try {
                this.save(t, i)
            } catch (a) {
                Wikimapia.Console.error(a)
            }
            e.stop();
            return false
        }.bind(this),
        reset: function (e) {
            e.stop();
            var i = this.map,
                a = i.getLayerByName("wikimapia.interactive.*"),
                o = i.getPanel("left"),
                n = a.editedPoly && a.editedPoly.unSaved;
            if (a.editedObject && !t.equals(a.editedObject)) {
                n = true
            }
            if (a.editedPoly && !n) {
                if (!this.map.vectorLayer.polygonEditor.isInProgress()) {
                    a.editedPoly.destroy();
                    i.removeVectorFeature(a.editedPoly);
                    delete a.editedPoly
                }
            }
            if (n) {
                i.closePanel("left")
            } else {
                if (t.isNew() && t.hasParent()) {
                    t = t.getParentPlace()
                }
                i.fireEvent("show", t)
            }
            delete a.objectWindow;
            this.editing = false;
            return false
        }.bind(this)
    });
    if (a) {
        this.addNearestStreetsSelect({
            input: a,
            form: i,
            onInit: Wikimapia.Utils.noop,
            onSelect: function (t) {
                i["street_id"].value = t.id;
                window.is_changed++
            },
            onNewoption: function () {
                i["street_id"].value = 0;
                window.is_changed++
            }
        })
    }
    i.setAttribute("data-inited", "true");
    this.initFormInternal(i);
    this.initCategoriesController(t.isNew() ? null : (new Wikimapia.Cache)
        .retrieve("currentCategories"), i);
    this.setFocus(e)
};
Wikimapia.Control.Object.Place.prototype.setFocus = function (t) {
    if (t && t.focus) {
        var e, i = this.control.objectWindow.container;
        switch (t.focus) {
            case Wikimapia.Control.Object.Data.focusFields.CATEGORY:
                e = document.getElementById("categories-block");
                break;
            case Wikimapia.Control.Object.Data.focusFields.ADDRESS:
                e = document.getElementById("address-block");
                break;
            case Wikimapia.Control.Object.Data.focusFields.BUILDING_FLAG:
                e = document.getElementById("building-block");
                break;
            case Wikimapia.Control.Object.Data.focusFields.WIKIPEDIA:
                e = document.getElementById("wikipedia-block");
                break;
            default:
                break
        }
        if (e) {
            e.show();
            i.scrollTop = Wikimapia.Utils.Dom.getPosition(e, i)
                .y - 100
        }
    }
};
Wikimapia.Control.Object.Place.prototype.appendGeometryData = function (t) {
    var e = ["x", "y", "x2", "y2", "poly", "new", "zoom"],
        i = this.control.currentObject.toJSON(),
        a;
    for (var o = 0, n = e.length; o < n; o++) {
        a = e[o];
        if (t[a]) {
            t[a].value = i[a]
        }
    }
};
Wikimapia.Control.Object.Place.prototype.save = function (t, e) {
    if (this.validateForm(e) && window.is_changed) {
        this.correctBuildingFlagValue(e["is_building"]);
        if (t.isNew()) {
            this.appendGeometryData(e)
        }
        var i = Wikimapia.Utils.Dom.toQueryString(e),
            a = this.map.getLayerByName("wikimapia.interactive.*"),
            o = e["id"].value;
        this.control.currentObject.currentLanguage = Wikimapia.Lang.codeToLng(parseInt(e["langid"].value));
        this.control.processData({
            url: Wikimapia.Control.Object.Place.url,
            method: "post",
            data: Wikimapia.Net.securePost(i),
            onRequest: this.onRequest(t),
            onFailure: function () {
                this.map.fireEvent("responseError", Wikimapia.Lang.get("all.something-wrong"))
            }.bind(this),
            onSuccess: this.onComplete.bind(this)
        })
    }
};
Wikimapia.Control.Object.Place.prototype.onRequest = function (t) {
    return function () {
        var e = this.map.getPanel("left"),
            i = Wikimapia.Utils.Logger;
        e && e.setLoading();
        if (t.isNew()) {
            i.logPlaceAction("place_new_data_save");
            i.trackAnalytics("/add.new.place.save.info.request")
        } else {
            i.logPlaceAction("place_edit_data_save");
            i.trackAnalytics("/place.edit.request")
        }
    }.bind(this)
};
Wikimapia.Control.Object.Place.prototype.onComplete = function (t) {
    if (!t) {
        return
    }
    if (t.code == Wikimapia.responseCodes.PLACE_UPDATED) {
        Wikimapia.Utils.Logger.logPlaceAction("place_data_save_complete");
        if (t.action) {
            if (t.action.trackAction) {
                Wikimapia.Utils.Logger.trackAnalytics(t.action.trackAction)
            }
            if (t.action.objectId) {
                var e = this.map.getLayerByName("wikimapia.interactive.*");
                if (this.map.vectorLayer.polygonEditor) {
                    this.map.vectorLayer.polygonEditor.cancel()
                }
                setTimeout(e.redraw.bind(e), this.control.options.tilesRedrawTimeout);
                if (e.editedPoly) {
                    this.map.removeVectorFeature(e.editedPoly);
                    this.map.statusbar.hide();
                    delete e.editedPoly
                }
                if (t.action.promote == true) {
                    this.promoteSocial(t.action.objectId)
                } else {
                    this.map.fireEvent("show", new Wikimapia.Place({
                        id: t.action.objectId,
                        currentLanguage: this.control.currentObject.currentLanguage
                    }))
                }
            }
        } else if (t.url) {
            router.route(t.url)
        }
    } else {
        this.map.fireEvent("responseError", t)
    }
};
Wikimapia.Control.Object.Place.prototype.correctBuildingFlagValue = function (t) {
    if (t && t.value == 0) {
        try {
            t.setAttribute("type", "text");
            t.value = 0
        } catch (e) {
            var i = document.createElement("input");
            i.type = "text", i.value = 0;
            i.name = t.name;
            t.parentNode.replaceChild(i, t)
        }
    }
};
Wikimapia.Control.Object.Place.prototype.validateForm = function (t) {
    var e = window.is_changed,
        i = window.is_t_changed,
        a = t["langid"],
        o;
    if (a.type !== "hidden") {
        if (a.options[a.selectedIndex].value == "") {
            Wikimapia.Interface.Dialog.alert(Wikimapia.Lang.get("all.chooselang") || "You have to chose language");
            a.focus();
            return false
        }
    }
    o = t["parent"] || t["parent_id"];
    if (o && o.value != 0) {
        o = t["title"];
        if (o.value.replace(/(^\s+)|(\s+$)/g, "") == "") {
            Wikimapia.Interface.Dialog.alert(Wikimapia.Lang.get("all.filltitle") || "You must enter name of the place");
            o.focus();
            return false
        }
    }
    var n = t["wikipedia"];
    if (n && n.value !== "" && !Wikimapia.Utils.validateWikipediaLink(n.value)) {
        Wikimapia.Interface.Dialog.alert(Wikimapia.Lang.get("all.wiki-incor"));
        n.focus();
        return false
    }
    o = t["street_id"];
    if (o) {
        if (t["street_name"] && !t["street_name"].value) {
            o.value = 0
        }
    }
    o = t["is_building"];
    if (o && !o.checked) {
        o.value = 0
    }
    var s = t["id"].value;
    if (s == 0) {
        window.is_changed++;
        window.is_t_changed++
    }
    return true
};
Wikimapia.Control.Object.Place.prototype.initCategoriesController = function (t, e) {
    t = t || {
        categories: {}
    };
    var i = $("#categories-select-list"),
        a = this;
    i.addClass("clearfix");
    this.categoriesController = new Wikimapia.Control.Object.Place.Categories(this, t)
};
Wikimapia.Control.Object.Place.Categories = function (t, e) {
    this.control = t;
    this.cache = new Wikimapia.Cache;
    this.select = null;
    this.currentCategories = e;
    this.currentCategoriesInput = document.getElementById("current-categories");
    this.addedCategoriesInput = document.getElementById("added-categories");
    this.removedCategoresInput = document.getElementById("deleted-categories");
    this.defaultSet = null;
    this.currentCategory = null;
    this.initSelect(e)
};
Wikimapia.Control.Object.Place.Categories.prototype.onUpdate = function () {
    this.control.collapsible.update();
    var t = this.select.value.split(","),
        e = " ",
        i = e + this.currentCategoriesInput.value + e,
        a = e + this.addedCategoriesInput.value + e,
        o = e + this.removedCategoresInput.value + e,
        n = e + this.select.value + e,
        s, r, p, l;
    for (s = 0, r = t.length; s < r; s++) {
        p = t[s];
        l = new RegExp("[^0-9]" + p + "[^0-9]", "g");
        if (!l.test(i)) {
            i += e + p;
            if (!l.test(a)) {
                this.updateMostUsedCategories(p, this.cache.retrieve("categoriesCache", "categories", p));
                a += e + p
            }
            window.is_changed++
        }
    }
    t = this.currentCategoriesInput.value.trim()
        .split(" ");
    for (s = 0, r = t.length; s < r; s++) {
        p = t[s];
        l = new RegExp("[^0-9]" + p + "[^0-9]", "g");
        if (!l.test(n)) {
            i = i.replace(l, e);
            if (l.test(a)) {
                a = a.replace(l, e)
            } else {
                o += e + p
            }
            window.is_changed++
        }
    }
    this.currentCategoriesInput.value = e + i.clean() + e;
    this.addedCategoriesInput.value = e + a.clean() + e;
    this.removedCategoresInput.value = e + o.clean() + e
};
Wikimapia.Control.Object.Place.Categories.prototype.initSelect = function (t, e) {
    this.currentCategories = t || {
        categories: {}
    };
    var i = document.getElementById("edit-categories-search"),
        a = Wikimapia.Utils.Dom.create("input", {
            "class": "input-block-level",
            value: 1
        }),
        o = [];
    this.select = a;
    Wikimapia.Utils.Dom.inject(a, i, "after");
    $(a)
        .select2({
            multiple: true,
            query: this.onQuery.bind(this),
            initSelection: this.initSelection.bind(this),
            formatResult: this.formatResult.bind(this),
            formatSelection: this.formatSelection.bind(this),
            formatNoMatches: this.onNoMatches.bind(this),
            dropdownCssClass: "bigdrop"
        });
    Wikimapia.Utils.Dom.addEvent(Wikimapia.Utils.Dom.getElement(".select2-drop"), "click", ".create-new-category", this.onNewCategoryPressed.bind(this));
    this.onUpdate = this.onUpdate.bind(this);
    Wikimapia.Utils.Dom.addEvent(this.select, "change", this.onUpdate);
    $(a)
        .select2("data", this.getCurrentCategoriesData());
    this.onUpdate();
    Wikimapia.Utils.getCallback(e)()
};
Wikimapia.Control.Object.Place.Categories.prototype.initCategoriesTooltips = function () {
    Wikimapia.Utils.Dom.addEvent(Wikimapia.Utils.Dom.getElement(".select2-drop"), "mousemove", function (t) {
        var e, i;
        if (/icon-info/.test(t.target.className)) {
            i = t.target.parentNode;
            if (i !== this.currentCategory && i.getAttribute("data-tooltip") === "true") {
                this.currentCategory = i;
                e = Wikimapia.Utils.Dom.getElement(this.currentCategory, ".tooltip");
                Wikimapia.Utils.Dom.addClass(e, "in")
            } else {
                clearTimeout(this.descriptionRequestTimer);
                this.descriptionRequestTimer = setTimeout(function () {
                    if (i !== this.currentCategory) {
                        if (this.currentCategory) {
                            e = Wikimapia.Utils.Dom.getElement(this.currentCategory, ".tooltip");
                            Wikimapia.Utils.Dom.removeClass(e, "in")
                        }
                        this.currentCategory = i;
                        if (this.descriptionRequest && this.descriptionRequest.isRunning()) {
                            this.descriptionRequest.cancel()
                        }
                        if (this.currentCategory.getAttribute("data-tooltip") === "true") {
                            e = Wikimapia.Utils.Dom.getElement(this.currentCategory, ".tooltip");
                            Wikimapia.Utils.Dom.addClass(e, "in")
                        } else {
                            this.descriptionRequest = new Wikimapia.Net.Xhr({
                                dataType: "json",
                                onSuccess: this.onCategoryDescriptionRecieved.bind(this)
                            })
                                .send({
                                    url: "/ajax/get_category/?search_cat_by_id=" + this.currentCategory.getAttribute("data-id")
                                })
                        }
                    }
                }.bind(this), 1e3)
            }
        } else if (this.currentCategory) {
            e = Wikimapia.Utils.Dom.getElement(this.currentCategory, ".tooltip");
            Wikimapia.Utils.Dom.removeClass(e, "in");
            this.currentCategory = null
        }
    }.bind(this))
};
Wikimapia.Control.Object.Place.Categories.prototype.onCategoryDescriptionRecieved = function (t) {
    var e;
    t.description = t.description || t.name;
    if (t.description && this.currentCategory && this.currentCategory.getAttribute("data-id") === t.id) {
        this.cache.store("categoriesCache", "categories", t.id, "description", t.description);
        this.currentCategory.setAttribute("data-tooltip", true);
        e = Wikimapia.Utils.Dom.create("div", {
            "class": "tooltip fade right in",
            html: '<div class="tooltip-arrow"></div>' + '<div class="tooltip-inner">' + String.escapeHTML(t.description) + "</div>"
        });
        Wikimapia.Utils.Dom.inject(e, this.currentCategory)
    } else {
        e = Wikimapia.Utils.Dom.getElement(this.currentCategory, ".tooltip");
        if (e) {
            Wikimapia.Utils.Dom.removeClass(e, "in")
        }
    }
};
Wikimapia.Control.Object.Place.Categories.prototype.addCategory = function (t) {
    var e = $(this.select)
        .select2("data");
    t.text = t.name;
    e.push(t);
    $(this.select)
        .select2("data", e);
    this.onUpdate()
};
Wikimapia.Control.Object.Place.Categories.prototype.onNoMatches = function (t) {
    t = (t || "")
        .clean();
    if (t && this.allowCreate) {
        t = String.escapeHTML(t);
        return "<span>" + Wikimapia.Lang.get("all.no-matches") + '&nbsp;<span class="btn btn-danger create-new-category" data-category-name="' + t + '">' + Wikimapia.Lang.get("all.categories-system-create-new") + "&nbsp;<strong>" + t + "</strong></span></span>"
    } else {
        return "<span>" + Wikimapia.Lang.get("all.no-matches") + "</span>"
    }
};
Wikimapia.Control.Object.Place.Categories.prototype.onNewCategoryPressed = function (t) {
    var e = t.currentTarget,
        i = e.getAttribute("data-category-name");
    $(this.select)
        .select2("close");
    this.createNewCategory(i)
};
Wikimapia.Control.Object.Place.Categories.prototype.getCurrentCategoriesData = function () {
    var t = [],
        e = this.currentCategories.categories;
    for (var i in e) {
        var a = e[i];
        a.text = a.name;
        t.push(a)
    }
    return t
};
Wikimapia.Control.Object.Place.Categories.prototype.onQuery = function (t) {
    if (t.term === "") {
        t.callback({
            results: this.getDefaultCategoriesSet()
        });
        this.matcherRE = null
    } else {
        this.matcherRE = new RegExp("(" + t.term + ")", "i");
        new Wikimapia.Net.Xhr({
            dataType: "json",
            onSuccess: function (e) {
                t.callback(this.formatResponse(e))
            }.bind(this)
        })
            .send({
                url: "/ajax/get_category/",
                data: this.formatQuery(t.term)
            })
    }
};
Wikimapia.Control.Object.Place.Categories.prototype.formatResponse = function (t, e) {
    this.allowCreate = t.allowCreate;
    return {
        results: t.categories || []
    }
};
Wikimapia.Control.Object.Place.Categories.prototype.formatQuery = function (t) {
    return {
        search_tcat: t,
        lng: Wikimapia.Lang.getCurrentLanguageCode(),
        format: "json",
        fs: 1,
        v: 1
    }
};
Wikimapia.Control.Object.Place.Categories.prototype.initSelection = function (t, e) {
    e();
    this.requestDefaultCategories(function (t) {
        this.cache.store("categoriesCache", Wikimapia.Utils.extend({}, this.currentCategories, t))
    }.bind(this))
};
Wikimapia.Control.Object.Place.Categories.prototype.formatSelection = function (t) {
    return '<span class="category-name">' + t.name + "</span>"
};
Wikimapia.Control.Object.Place.Categories.prototype.formatResult = function (t, e, i) {
    var a = Wikimapia.Utils.getCategoryIconSprite(t),
        o = t.name,
        n = "";
    if (i.term && this.matcherRE) {
        o = o.replace(this.matcherRE, '<span class="select2-match">$1</span>')
    }
    a = '<span class="' + (a ? "menu-spt " + a : "menu-spt spt-empty-category") + ' s16x16"></span> ';
    return '<span class="category-name" data-id="' + t.id + '" data-tooltip="' + (t.description ? true : false) + '">' + a + o + n + "</span>"
};
Wikimapia.Control.Object.Place.Categories.prototype.getDefaultCategoriesSet = function () {
    if (!this.defaultSet) {
        var t = this.cache.retrieve("categoriesCache", "popular"),
            e = this.cache.retrieve("categoriesCache", "categories"),
            i = [];
        for (var a = 0, o = t.length; a < o; a++) {
            i.push(e[t[a]])
        }
        i.sort(function (t, e) {
            return (e.useCount || 0) - (t.useCount || 0)
        });
        this.defaultSet = i
    }
    return this.defaultSet
};
Wikimapia.Control.Object.Place.Categories.prototype.requestDefaultCategories = function (t) {
    var e = this.cache.retrieve("categoriesCache"),
        i = new Date;
    if (e.popular) return t(e);
    e = this.cache.getItemJSON("wikimapia_mostUsedCategories");
    if (e) return t(e);
    new Wikimapia.Net.Xhr({
        type: "json",
        url: Wikimapia.Lang.requestTagsTopUrlMask.substitute({
            lang: Wikimapia.Lang.getCurrentLanguage()
        }) + "?nc=" + [i.getFullYear(), i.getMonth(), i.getDate()].join(""),
        method: "get",
        onSuccess: function (e) {
            e.popular = Wikimapia.Utils.getObjectKeys(e.categories);
            t(e)
        },
        onFailure: function (e) {
            var i = this.cache.retrieve("categoriesCache"),
                a = {
                    categories: {},
                    icons: {},
                    popular: []
                };
            for (var o in i) {
                if (o[o.length - 1] === "i") {
                    a.icons[parseInt(o)] = i[o]
                } else {
                    a.categories[o] = i[o];
                    a.popular.push(o)
                }
            }
            t(a)
        }.bind(this)
    })
        .send()
};
Wikimapia.Control.Object.Place.Categories.prototype.updateMostUsedCategories = function (t, e) {
    var i = this.cache,
        a = i.retrieve("categoriesCache", "categories"),
        o = i.retrieve("categoriesCache", "popular");
    if (!e) return;
    e.useCount = e.useCount || 0;
    e.useCount++;
    a[t] = e;
    if (o.indexOf(t) === -1) {
        o.push(t)
    }
    var n = {};
    o.sort(function (t, e) {
        t = n[t] = a[t];
        e = n[e] = a[e];
        if (t.useCount === undefined) t.useCount = 0;
        if (e.useCount === undefined) e.useCount = 0;
        return e.useCount - t.useCount
    });
    o = o.slice(0, 45);
    i.store("categoriesCache", "categories", a);
    i.store("categoriesCache", "popular", o);
    this.defaultSet = null;
    i.setItemJSON("wikimapia_mostUsedCategories", {
        popular: o,
        categories: n,
        icons: i.retrieve("categoriesCache", "icons")
    })
};
Wikimapia.Control.Object.Place.Categories.prototype.getMostUsed = function (t) {
    return this.cache.getItemJSON("wikimapia_mostUsedCategories")
};
Wikimapia.Control.Object.Place.Categories.prototype.getFormLanguageId = function () {
    return this.control.form["langid"].value
};
Wikimapia.Control.Object.Place.Categories.prototype.createNewCategory = function (t) {
    var e = Wikimapia.Lang.getCurrentLanguage();
    if (t === "") return;
    Wikimapia.Interface.Dialog.confirm(Wikimapia.Lang.get("all.categories-system-create-new-alert") + " \n" + t + " (" + e + ") ?", function () {
        var e = Wikimapia.Utils.objectToQueryString({
            action: "create",
            name: t,
            lng: this.getFormLanguageId()
        });
        this.control.control.processData({
            url: "/ajax/categories/",
            method: "post",
            data: Wikimapia.Net.securePost(e),
            keepContext: true,
            onSuccess: function (e) {
                if (!isNaN(e)) {
                    var i = new Wikimapia.Cache,
                        a = e,
                        o = {
                            id: a,
                            name: t,
                            category_id: a,
                            lang: Wikimapia.Lang.getCurrentLanguage(),
                            count: 1,
                            icon: 0
                        };
                    i.store("categoriesCache", "categories", a, o);
                    this.addCategory(o);
                    setTimeout(function () {
                        window.is_changed++
                    }, 300)
                }
            }.bind(this)
        })
    }.bind(this))
};
Wikimapia.Control.Object.Linear = function (t) {
    Wikimapia.Control.Object.Data.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Linear, Wikimapia.Control.Object.Data);
Wikimapia.Control.Object.Linear.url = "/object/edit/?do=save&object_type={type}&noheader=1&ltype={linearType}";
Wikimapia.Control.Object.Linear.prototype.edit = function (t, e) {
    Wikimapia.Utils.Logger.log("linear_edit_data_start");
    this.control.objectWindow = this.map.createPanel({
        url: t.getEditUrl(),
        onLoad: this.getFormLoadHandler(t, e),
        onClose: function () {
            this.map.updateShowHash("", true)
        }.bind(this),
        menu: this.control.getMenuForObject(t, t.type),
        iframe: false,
        position: "left",
        size: this.control.getPanelSizeForObjectEdit()
    })
};
Wikimapia.Control.Object.Linear.prototype.initForm = function (t, e) {
    var i = document.getElementById("wikiedit");
    if (!i) return;
    this.initFormInternal(i);
    Wikimapia.Utils.Dom.addEvents(i, {
        submit: function (e) {
            e.stop();
            this.save(t, i);
            return false
        }.bind(this),
        reset: function (e) {
            e.stop();
            var i = this.control.map,
                a = i.getLayerByName("wikimapia.interactive.*"),
                o = i.getPanel("left");
            if (a && a.editedPoly && !a.editedPoly.unSaved) {
                a.editedPoly.destroy();
                i.removeVectorFeature(a.editedPoly);
                delete a.editedPoly
            }
            if (t.isNew()) {
                this.control.objectWindow.close()
            } else {
                this.control.showObject(t)
            }
            if (a) {
                delete a.objectWindow
            }
            this.editing = false;
            return false
        }.bind(this)
    });
    var a = i["title"],
        o;
    if (parseInt(i["id"].value) === 0) {
        this.addNearestStreetsSelect({
            input: a,
            form: i,
            onInit: function (t) {
                a.focus()
            },
            onSelect: function (t) {
                $("#autocomplete_message")
                    .hide();
                $("#attach_message")
                    .show();
                i["id"].value = t.id;
                i.num.value = "quick";
                $(i["description"])
                    .setProperty("disabled", true)
                    .addClass("disabled");
                clearTimeout(o);
                window.is_changed++
            },
            onNewoption: function () {
                var t = this;
                clearTimeout(o);
                o = setTimeout(function () {
                    $("#autocomplete_message")
                        .show();
                    $("#attach_message")
                        .hide();
                    $(i["description"])
                        .setProperty("disabled", false)
                        .removeClass("disabled");
                    i["id"].value = 0;
                    i.num.value = "0"
                }, 300);
                window.is_changed++
            }
        })
    }
};
Wikimapia.Control.Object.Linear.prototype.validateForm = function (t) {
    var e = window.is_changed,
        i = window.is_t_changed;
    if (t["title"].value.replace(/(^\s+)|(\s+$)/g, "") === "") {
        Wikimapia.Interface.Dialog.alert(Wikimapia.Lang.get("all.filltitle") || "You must enter name");
        t["title"].focus();
        return false
    }
    var a = t["wikipedia"];
    value = a.value;
    if (a && value !== "" && !Wikimapia.Utils.validateWikipediaLink(value)) {
        Wikimapia.Interface.Dialog.alert(Wikimapia.Lang.get("all.wiki-incor"));
        a.focus();
        return false
    }
    return !!e
};
Wikimapia.Control.Object.Linear.prototype.appendGeometryData = function (t) {
    var e = this.map.getLayerByName("wikimapia.linear.*"),
        i;
    if (e && t["segsname"]) {
        i = Wikimapia.Utils.getObjectKeys(e.temp.affectedSegments);
        if (i.length === 0) {
            i.push(e.temp.currentSegment)
        }
        t["segsname"].value = i.join(",")
            .replace(/[A-Za-z]/g, "")
    }
};
Wikimapia.Control.Object.Linear.prototype.onRequest = function () {
    var t = this.map.getPanel("left");
    if (t) t.setLoading();
    Wikimapia.Utils.Logger.log("linear_edit_data_save")
};
Wikimapia.Control.Object.Linear.prototype.onComplete = function (t) {
    if (t.action) {
        if (t.action.trackAction) {
            Wikimapia.Utils.Logger.trackAnalytics(t.action.trackAction)
        }
        if (t.action.objectId) {
            var e = new Wikimapia.Cache,
                i = e.retrieve("linearTypeId") || 0,
                a = e.retrieve("linearTypeName") || "wikimapia.linear.*",
                o = this.map.getLayerByName("wikimapia.linear.*");
            if (o) {
                o.cancelSelection()
            } else {
                o = this.map.getLayerByName("wikimapia.interactive.*")
            }
            this.control.showObject(Wikimapia.Linear.createLinearObject({
                id: t.action.objectId,
                currentLanguage: Wikimapia.Lang.codeToLng(t.action.lngId)
            }, t.action.objectType));
            o.redraw()
        }
    } else if (t.url) {
        router.route(t.url)
    }
}, Wikimapia.Control.Object.Linear.prototype.save = function (t, e) {
    var i = this.map,
        a = new Wikimapia.Cache,
        o = a.retrieve("linearTypeId") || 0,
        n = a.retrieve("linearTypeName") || "wikimapia.linear.*",
        s, r, p = [],
        l = i.getLayerByName(n);
    if (this.validateForm(e)) {
        e["uid"].value = i.access.getUserId();
        this.appendGeometryData(e);
        s = Wikimapia.Utils.Dom.toQueryString(e);
        this.control.processData({
            url: Wikimapia.Control.Object.Linear.url.substitute(t),
            method: "post",
            data: Wikimapia.Net.securePost(s),
            onRequest: this.onRequest.bind(this),
            onFailure: i.closeWindow.bind(i),
            onSuccess: this.onComplete.bind(this)
        })
    }
};
Wikimapia.Control.Object.Comments = function (t) {
    Wikimapia.Control.Object.Component.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Comments, Wikimapia.Control.Object.Component);
Wikimapia.Control.Object.Comments.prototype.processComment = function (t) {
    if (typeof t === "string") {
        t = JSON.parse(t)
    }
    if (t) {
        if (t.code === Wikimapia.responseCodes.COMMENT_SEND_OK || t.code === Wikimapia.responseCodes.COMMENT_SEND_OK_CAPTCHA) {
            if (t.action && t.action.objectId) {
                var e = {
                    id: t.action.objectId,
                    currentLanguage: t.action.lngId
                };
                if (t.action.objectType >= Wikimapia.Object.objectTypes.LINEAR) {
                    e = Wikimapia.Linear.createLinearObject(e, t.action.ltype)
                } else {
                    e = new Wikimapia.Place(e)
                }
                e.currentComment = t.action.commentNum;
                this.map.fireEvent("show", e)
            } else if (t.url) {
                router.route(t.url)
            }
        } else {
            if (t.code === Wikimapia.responseCodes.COMMENT_WRONG_CAPTCHA) {
                if (this.control.objectWindow && "captcha" in this.control.objectWindow.getContext()) {
                    this.control.objectWindow.getContext()
                        .captcha.reload();
                    Wikimapia.Interface.Dialog.alert(t.message)
                }
            } else {
                this.map.fireEvent("responseError", t)
            }
        }
    }
};
Wikimapia.Control.Object.Photos = function (t) {
    Wikimapia.Control.Object.Component.prototype.constructor.call(this, t);
    this.onLoad = this.onLoad.bind(this)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Photos, Wikimapia.Control.Object.Component);
Wikimapia.Control.Object.Photos.url = "/photo/?object_type={type}&id={id}&lng={currentLanguage}";
Wikimapia.Control.Object.Photos.prototype.show = function (t, e) {
    t.id = t.obj;
    delete t.obj;
    this.control.objectWindow = this.map.createPanel({
        url: e,
        iframe: true,
        onLoad: function () {
            this.map.updateShowHash(e.replace(Wikimapia.Utils.photoServerURL, ""))
        }.bind(this),
        onClose: function () {
            this.map.updateShowHash("", true)
        }.bind(this),
        size: this.control.getPanelSizeForObject(),
        position: "left",
        menu: this.control.getMenuForObject(t)
    })
};
Wikimapia.Control.Object.Photos.prototype.fakePhotoUrl = function (t, e) {
    this.map.updateShowHash(t.getPhotoUrl(e), true)
};
Wikimapia.Control.Object.Photos.prototype.edit = function (t, e) {
    if (e.indexOf(Wikimapia.Utils.photoServerURL) !== 0) {
        e = Wikimapia.Utils.photoServerURL + e
    }
    this.control.objectWindow = this.map.createPanel({
        url: e,
        iframe: true,
        onClose: function () {
            this.map.updateShowHash("", true)
        }.bind(this),
        size: this.control.getPanelSizeForObject(),
        position: "left",
        menu: this.control.getMenuForObject(t)
    });
    this.control.objectWindow.addEventOnce("load", this.onLoad)
};
Wikimapia.Control.Object.Photos.prototype.onLoad = function () {
    this.map.updateShowHash(this.control.objectWindow.getUrl()
        .replace(Wikimapia.Utils.photoServerURL, ""), true, true)
};
Wikimapia.Control.Object.Photos.prototype.onShow = function (t, e) {
    var i = Wikimapia.Object.createObject(e);
    if (this.control.currentObject) {
        this.control.currentObject.currentPhoto = t;
        if (i.equals(this.control.currentObject)) {
            i = this.control.currentObject
        }
    }
    this.fakePhotoUrl(i, t)
};
Wikimapia.Control.Object.Photos.prototype.onClose = function (t) {
    var e = Wikimapia.Object.createObject(t);
    if (this.control.currentObject) {
        this.control.currentObject.currentPhoto = null;
        if (e.equals(this.control.currentObject)) {
            e = this.control.currentObject
        }
    }
    this.control.fakeObjectUrl(e)
};
Wikimapia.Control.Object.Protect = function (t) {
    Wikimapia.Control.Object.Component.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Protect, Wikimapia.Control.Object.Component);
Wikimapia.Control.Object.Protect.url = "/ajax/placeProtect/?id={id}&object_type={type}&lng={lng}&semiprotect={protection}&revision_comment={comment}";
Wikimapia.Control.Object.Protect.prototype.processObjectProtection = function (t, e) {
    var i, a = "",
        o;
    if (e) {
        i = "edit-ask-protection";
        o = "on"
    } else {
        i = "edit-ask-unprotection";
        o = "off"
    }
    Wikimapia.Interface.Dialog.prompt(Wikimapia.Lang.get("all." + i)
        .replace(/\%break\%/g, "\n"),
        function (e) {
            console.log(e);
            if (e) {
                this.control.processData({
                    url: Wikimapia.Control.Object.Protect.url.substitute(Wikimapia.Utils.extend(t.toJSON(), {
                        protection: o,
                        comment: encodeURIComponent(e)
                    })),
                    method: "get",
                    onSuccess: this.onProtectionSet.bind(this)
                })
            }
        }.bind(this), Wikimapia.Utils.noop, " ")
};
Wikimapia.Control.Object.Protect.prototype.getMenuItem = function (t) {
    var e;
    if (t.isProtected()) {
        e = {
            text: "edit-unset-protection",
            icon: {
                image: false,
                imageSpriteClass: "spt-lock"
            },
            action: function () {
                this.processObjectProtection(t, 0)
            }.bind(this)
        }
    } else {
        e = {
            text: "edit-set-protection",
            icon: {
                image: false,
                imageSpriteClass: "spt-lock"
            },
            action: function () {
                this.processObjectProtection(t, 1)
            }.bind(this)
        }
    }
    return e
};
Wikimapia.Control.Object.Protect.prototype.onProtectionSet = function (t) {
    if (!t) {
        console.error("Protection setting failed - no response");
        return
    }
    if (t.code == Wikimapia.responseCodes.PLACE_UPDATED || t.code == Wikimapia.responseCodes.LINEAR_UPDATED) {
        if (t.action && t.action.objectId) {
            if (t.action.promote == true) {
                this.control.promoteSocial(t.action.objectId)
            } else {
                this.control.showObject(this.control.currentObject)
            }
        } else if (t.url) {
            router.route(t.url)
        }
    } else {
        this.map.fireEvent("responseError", t)
    }
};
Wikimapia.Control.Object.Delete = function (t) {
    Wikimapia.Control.Object.Component.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Delete, Wikimapia.Control.Object.Component);
Wikimapia.Control.Object.Delete.CANCEL_UNDELETION_FLAG = 2;
Wikimapia.Control.Object.Delete.deleteObjectUrl = "/object/edit/?id={id}&do=del&reason={reason}&revision_comment={comment}";
Wikimapia.Control.Object.Delete.cancelObjectDeletionUrl = "/object/edit/?id={id}&do=del&cancel=1&revision_comment={comment}";
Wikimapia.Control.Object.Delete.cancelObjectUndeletionUrl = "/object/edit/?id={id}&do=undel&cancel=1&revision_comment={comment}";
Wikimapia.Control.Object.Delete.restoreObjectUrl = "/object/edit/?id={id}&do=undel&revision_comment={comment}";
Wikimapia.Control.Object.Delete.defineReasons = function (t, e) {
    var i = app.map.getControlByName("Object"),
        a;
    if (i) {
        a = i._delete;
        if (a) {
            a.reasons = t;
            a.currentReason = e
        }
    }
};
Wikimapia.Control.Object.Delete.repairAction = {
    EDIT: "edit",
    EDIT_POLYGON: "edit_polygon"
};
Wikimapia.Control.Object.Delete.prototype.reasons = null;
Wikimapia.Control.Object.Delete.prototype.currentReason = 0;
Wikimapia.Control.Object.Delete.prototype.form = null;
Wikimapia.Control.Object.Delete.prototype.processObjectDeletion = function (t, e, i, a) {
    var a, o = "",
        n, s = new Wikimapia.Place({
            id: parseInt(t)
        });
    if (e == null) {
        n = Wikimapia.Control.Object.Delete.deleteObjectUrl
    } else {
        if (e) {
            if (e === Wikimapia.Control.Object.Delete.CANCEL_UNDELETION_FLAG) {
                n = Wikimapia.Control.Object.Delete.cancelObjectUndeletionUrl
            } else {
                n = Wikimapia.Control.Object.Delete.cancelObjectDeletionUrl
            }
        } else {
            n = Wikimapia.Control.Object.Delete.restoreObjectUrl
        }
    }
    this.control.processData({
        url: n.substitute({
            id: s.id,
            reason: i,
            comment: a
        }),
        method: "get",
        onSuccess: this.onComplete.bind(this)
    })
};
Wikimapia.Control.Object.Delete.prototype.onComplete = function (t) {
    if (t) {
        this.tearDown();
        this.control.showObject(this.control.currentObject);
        if ([Wikimapia.responseCodes.DELETED, Wikimapia.responseCodes.DELETION_CANCELLED, Wikimapia.responseCodes.UNDELETED, Wikimapia.responseCodes.UNDELETION_CANCELLED].indexOf(t.code) !== -1) { } else if (t.code === Wikimapia.responseCodes.DELETE_HAS_NESTED) {
            Wikimapia.Interface.Dialog.alert(t.message)
        } else {
            this.map.fireEvent("responseError", t)
        }
    } else {
        this.map.closeWindow()
    }
};
Wikimapia.Control.Object.Delete.prototype.beforeDelete = function (t, e) {
    var i = "/object/before_delete/?id=" + t.id,
        a = true,
        o = false,
        n = true;
    if (!this.control.currentObject || !this.control.currentObject.equals(t)) {
        this.control.currentObject = t;
        this.control.fakeObjectUrl(t)
    }
    switch (e) {
        case Wikimapia.Object.objectState.DELETED:
            i = i.replace("_delete", "_undelete") + "&undelete=1";
            o = true;
            break;
        case Wikimapia.Object.objectState.IN_DELETION_QUEUE:
            i = i.replace("_delete", "_undelete") + "&canceldeletion=1";
            a = true;
            o = true;
            break;
        case Wikimapia.Object.objectState.IN_UNDELETION_QUEUE:
            this.processObjectDeletion(t.id, Wikimapia.Control.Object.Delete.CANCEL_UNDELETION_FLAG);
            a = true;
            n = false;
            break;
        case Wikimapia.Object.objectState.EXISTS:
        default:
            break
    }
    if (!n) {
        return
    } else if (a) {
        this.showForm(t, i, o)
    } else {
        Wikimapia.Interface.Dialog.confirm(Wikimapia.Lang.get("all.ask-sure"), function () {
            this.showForm(t, i, o)
        }.bind(this))
    }
};
Wikimapia.Control.Object.Delete.prototype.showForm = function (t, e, i) {
    this.control.objectWindow = this.map.createPanel({
        url: e,
        position: "left",
        size: this.control.getPanelSizeForObjectEdit(),
        onLoad: i ? this.onCancellationFormLoad.bind(this) : this.onDeletionFormLoad.bind(this),
        iframe: false,
        menu: this.control.getMenuForObject(t)
    })
};
Wikimapia.Control.Object.Delete.prototype.onDeletionFormLoad = function () {
    var t = document.getElementById("deletion-form"),
        e = document.getElementById("delete-object-note");
    if (t) {
        this.form = t[0];
        if (t["quickDeletionAllowed"] && t["quickDeletionAllowed"].value === "true") {
            this.processObjectDeletion(this.control.currentObject.id, null, 0)
        } else {
            var i = Wikimapia.Utils.Dom.getElements(t, ".del-reasons-list input"),
                a = this;
            Wikimapia.Utils.Dom.addEvent(i, "change", function () {
                a.selectReason(parseInt(this.value))
            });
            Wikimapia.Utils.Dom.addEvents(t, {
                sumbit: this.onDeleteSubmit.bind(this),
                reset: this.onCancel.bind(this)
            });
            t.onsubmit = this.onDeleteSubmit.bind(this);
            if (e) {
                Wikimapia.Utils.Dom.addEvent(e, "click", this.getNoteClickHandler())
            }
        }
    }
};
Wikimapia.Control.Object.Delete.prototype.onCancellationFormLoad = function () {
    var t = document.getElementById("cancel-deletion-form");
    if (t) {
        this.form = t;
        Wikimapia.Utils.Dom.addEvents(t, {
            submit: this.onCancelSubmit.bind(this),
            reset: this.onCancel.bind(this)
        })
    }
};
Wikimapia.Control.Object.Delete.prototype.onCancelSubmit = function (t) {
    t.preventDefault();
    var e = parseInt(this.form["cancel"].value);
    this.processObjectDeletion(this.control.currentObject.id, e, "", document.getElementById("revision_comment")
        .value);
    return false
};
Wikimapia.Control.Object.Delete.prototype.getNoteClickHandler = function () {
    var t = this;
    return function (e) {
        e.stop();
        if (e.target.tagName.toLowerCase() === "button") {
            var i = e.target.getAttribute("data-repair");
            t.getRepairAction(i)()
        }
    }
};
Wikimapia.Control.Object.Delete.prototype.onDeleteSubmit = function (t) {
    t.preventDefault();
    if (this.currentReason === 0) {
        Wikimapia.Interface.Dialog.alert(Wikimapia.Lang.get("all.delete-select-reason"))
    } else {
        Wikimapia.Interface.Dialog.confirm(Wikimapia.Lang.get("all.delete-ask"), function () {
            var t = this.getReasonById(this.currentReason);
            if (t.deletion_allowed) {
                this.processObjectDeletion(this.control.currentObject.id, null, t.id)
            } else {
                this.selectReason(t.id)
            }
        }.bind(this), Wikimapia.Utils.Empty, "all.show-menu-delete")
    }
};
Wikimapia.Control.Object.Delete.prototype.onCancel = function () {
    this.tearDown();
    this.control.showObject(this.control.currentObject)
};
Wikimapia.Control.Object.Delete.prototype.tearDown = function () {
    if (this.form) {
        Wikimapia.Utils.Dom.removeEvents(this.form);
        var t = Wikimapia.Utils.Dom.getElements(this.form, ".del-reasons-list input"),
            e = document.getElementById("delete-object-note");
        if (t.length !== 0) {
            Wikimapia.Utils.Dom.removeEvents(t)
        }
        if (e) {
            Wikimapia.Utils.Dom.removeEvents(e)
        }
        this.form = null
    }
};
Wikimapia.Control.Object.Delete.prototype.getReasonById = function (t) {
    var e = null;
    for (var i = 0, a = this.reasons.length; i < a; i++) {
        if (t === this.reasons[i].id) {
            e = this.reasons[i];
            break
        }
    }
    return e
};
Wikimapia.Control.Object.Delete.prototype.selectReason = function (t) {
    this.currentReason = t;
    if (this.reasons) {
        var e = this.getReasonById(t),
            i = document.getElementById("delete-object-submit"),
            a = document.getElementById("delete-object-note"),
            o = this.control.currentObject;
        if (e && e.deletion_allowed) {
            i.className = "btn btn-primary";
            i.disabled = "";
            a.innerHTML = Wikimapia.Lang.get("all.reason-for-deletion-is")
                .replace(/%1/, "<strong>" + e.title + "</strong>");
            a.show()
        } else {
            i.className = "btn btn-primary disabled";
            i.disabled = "disabled";
            var n = this.getRepairAction(e.reaction),
                s = e.note.replace(/%1/, '<button class="btn btn-primary" data-repair="' + e.reaction + '">')
                .replace(/%2/, "</button>");
            a.innerHTML = s;
            a.style.display = ""
        }
    }
};
Wikimapia.Control.Object.Delete.prototype.getRepairAction = function (t) {
    var e = function () { };
    switch (t) {
        case Wikimapia.Control.Object.Delete.repairAction.EDIT:
            e = function () {
                this.control._place.edit(this.control.currentObject)
            }.bind(this);
            break;
        case Wikimapia.Control.Object.Delete.repairAction.EDIT_POLYGON:
            e = function () {
                this.control._place.editGeometry(this.control.currentObject)
            }.bind(this);
            break;
        default:
            break
    }
    return e
};
Wikimapia.Control.Object.Delete.prototype.getDeletionMenuItem = function (t) {
    var e = {
        icon: {
            spritePos: "0 -1488px"
        },
        action: function () {
            this.beforeDelete(t, t.deletionState)
        }.bind(this)
    };
    switch (t.deletionState) {
        case Wikimapia.Object.objectState.IN_DELETION_QUEUE:
            e.text = "show-menu-cancel-deletion";
            break;
        case Wikimapia.Object.objectState.DELETED:
            e.text = "show-menu-undelete";
            break;
        case Wikimapia.Object.objectState.IN_UNDELETION_QUEUE:
            e.text = "show-menu-cancel-undeletion";
            break;
        case Wikimapia.Object.objectState.EXISTS:
        default:
            e.text = "show-menu-delete";
            break
    }
    return e
};
Wikimapia.Control.Object.History = function (t) {
    Wikimapia.Control.Object.Component.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.History, Wikimapia.Control.Object.Component);
Wikimapia.Control.Object.History.urls = {
    VIEW: "/object/history/list/?object_type={type}&id={id}&lng={currentLanguage}",
    POLYGON_DIFF: "/object/history/polygon/?id={objectId}&rev={beforeRevision}&rev2={afterRevision}",
    REVERT_BY_FIELDS: "/object/history/list/?id={objectId}&revert={revisionId}&byfields={fields}&revision_comment={comment}",
    REVERT: "/object/history/list/?id={objectId}&revert={revisionId}&revision_comment={comment}"
};
Wikimapia.Control.Object.History.prototype.preloader = null;
Wikimapia.Control.Object.History.prototype.diffPolygon = null;
Wikimapia.Control.Object.History.prototype.viewRevision = function (t, e) {
    var i = this.control.getMenuForObject(t, t.type);
    this.setObject(t);
    if (e[0] !== "/") e = "/" + e;
    this.map.createPanel({
        url: e,
        position: "left",
        onLoad: function () {
            this.map.updateShowHash(e, true);
            this.initRevisionDom();
            if (/revert=(\d+)/.test(e)) {
                this.updateMap()
            }
        }.bind(this),
        iframe: false,
        menu: i,
        size: this.control.getPanelSizeForObject()
    })
};
Wikimapia.Control.Object.History.prototype.initRevisionDom = function () {
    var t = this.map.getPanel("left");
    if (t) {
        this.preloader = null;
        t.addEventOnce("unload", this.onRevisionUnload.bind(this));
        Wikimapia.Utils.Dom.addEvent(t.container, "click", "[data-action=show-polygon]", this.onPolygonDiffClick.bind(this));
        Wikimapia.Utils.Dom.addEvent(t.container, "click", "#by-fields-view", this.onByFieldsView.bind(this));
        Wikimapia.Utils.Dom.addEvent(t.container, "click", "#by-fields-view-off", this.onByFieldsViewOff.bind(this));
        Wikimapia.Utils.Dom.addEvent(t.container, "click", "#revision-revert-button", this.onRevisionRevertClick.bind(this));
        Wikimapia.Utils.Dom.addEvent(t.container, "click", ".apply-selected-fields", this.onApplySelectedFieldsClick.bind(this));
        Wikimapia.Utils.Dom.addEvent(Wikimapia.Utils.Dom.getElements("#history-table input[type=checkbox]"), "change", this.onRevisionFieldSelected.bind(this));
        this.onRevisionFieldSelected()
    }
};
Wikimapia.Control.Object.History.prototype.onRevisionFieldSelected = function () {
    var t = Wikimapia.Utils.Dom.getElements("#history-table input[type=checkbox]"),
        e = Wikimapia.Utils.Dom.getElement(".historyinfo .apply-selected-fields"),
        i = false;
    for (var a = 0, o = t.length; a < o; a++) {
        if (t[a].checked) {
            i = true;
            break
        }
    }
    if (e) {
        if (i) {
            e.removeAttribute("disabled")
        } else {
            e.setAttribute("disabled", "disabled")
        }
    }
};
Wikimapia.Control.Object.History.prototype.onRevisionUnload = function () {
    this.preloader = null;
    this.showPolygon(null)
};
Wikimapia.Control.Object.History.prototype.onByFieldsView = function () {
    this.displayByFields();
    this.showByFieldsLikeAfterApply()
};
Wikimapia.Control.Object.History.prototype.onByFieldsViewOff = function () {
    this.displayNormal();
    this.showByFieldsNormally()
};
Wikimapia.Control.Object.History.prototype.onRevisionRevertClick = function (t) {
    t.stop();
    var e = t.currentTarget,
        i = e.getAttribute("data-object-id"),
        a = e.getAttribute("data-revision-id");
    Wikimapia.Interface.Dialog.prompt(Wikimapia.Lang.get("all.history-revert-ask") + "<br/><em>" + Wikimapia.Lang.get("all.history-revision-comment-title-confirm") + "</em>", function (t) {
        if (t == " ") {
            t = ""
        }
        this.revertRevision(i, a, t)
    }.bind(this))
};
Wikimapia.Control.Object.History.prototype.revertRevision = function (t, e, i) {
    new Wikimapia.Net.Xhr({
        onSuccess: this.onRevisionApplied.bind(this)
    })
        .send({
            url: Wikimapia.Control.Object.History.urls.REVERT.substitute({
                objectId: t,
                revisionId: e,
                comment: encodeURIComponent(i)
            })
        })
};
Wikimapia.Control.Object.History.prototype.onRevisionApplied = function () {
    this.view(this.control.currentObject);
    this.updateMap()
};
Wikimapia.Control.Object.History.prototype.onPolygonDiffClick = function (t) {
    t.stop();
    if (!this.preloader) {
        this.preloader = Wikimapia.Interface.Spinner.setLoading(t.currentTarget, {
            color: "#468847",
            length: 4,
            width: 2,
            radius: 3,
            lines: 10,
            position: "relative",
            left: "50%",
            top: "8px"
        });
        this.loadPolygonDiff(t.currentTarget.getAttribute("data-id"), t.currentTarget.getAttribute("data-rev-before"), t.currentTarget.getAttribute("data-rev-after"))
    }
};
Wikimapia.Control.Object.History.prototype.loadPolygonDiff = function (t, e, i) {
    new Wikimapia.Net.Xhr({
        type: "json",
        onSuccess: this.onPolygonDiffReceived.bind(this)
    })
        .send({
            url: Wikimapia.Control.Object.History.urls.POLYGON_DIFF.substitute({
                objectId: t,
                beforeRevision: e,
                afterRevision: i
            })
        })
};
Wikimapia.Control.Object.History.prototype.onPolygonDiffReceived = function (t) {
    var e = Wikimapia.Utils.Dom.getElement("#history-polychanged .polygon-diff"),
        i = Wikimapia.Utils.Dom.getElement("#history-polychanged .likelink-dashed"),
        a = new Wikimapia.Parser.Itiles,
        o, n;
    if (this.preloader) {
        this.preloader.stop()
    }
    Wikimapia.Utils.Dom.removeClass(i, "likelink-dashed");
    t.polygon.before = a.decodePolygon(t.polygon.before);
    t.polygon.after = a.decodePolygon(t.polygon.after);
    n = t.polygon.before.getBounds()
        .extend(t.polygon.after.getBounds());
    this.map.zoomToBounds(n);
    Wikimapia.Utils.Dom.addClass(Wikimapia.Utils.Dom.getElement(e, ".after"), "active");
    this.showPolygon(t.polygon.after);
    Wikimapia.Utils.Dom.removeClass(e, "hide");
    Wikimapia.Utils.Dom.addEvent(e, "click", "button", function (i) {
        var a = i.currentTarget;
        Wikimapia.Utils.Dom.removeClass(Wikimapia.Utils.Dom.getElements(e, "button"), "active");
        Wikimapia.Utils.Dom.addClass(a, "active");
        if (Wikimapia.Utils.Dom.hasClass(a, "before")) {
            this.showPolygon(t.polygon.before)
        } else {
            this.showPolygon(t.polygon.after)
        }
    }.bind(this))
};
Wikimapia.Control.Object.History.prototype.showPolygon = function (t) {
    var e = this.map,
        i = this.diffPolygon;
    if (t && t.getVertexCount() > 1) {
        if (i) {
            i.setGeometry(t)
        } else {
            i = new Wikimapia.Feature.Polygon({
                geometry: t,
                map: e
            });
            this.diffPolygon = i
        }
    } else {
        if (i) {
            e.removeVectorFeature(i);
            delete this.diffPolygon
        }
    }
};
Wikimapia.Control.Object.History.prototype.displayByFields = function () {
    Wikimapia.Utils.Dom.removeClass(document.getElementById("by-fields-view-off"), "hide");
    Wikimapia.Utils.Dom.addClass(document.getElementById("by-fields-view"), "hide");
    Wikimapia.Utils.Dom.removeClass(Wikimapia.Utils.Dom.getElements("#by-fields-view-off,#by-fields-view-help,#byFieldsButtonBlock"), "hide");
    Wikimapia.Utils.Dom.toggleClass(document.getElementById("history-table"), "normal-view", "fields-view")
};
Wikimapia.Control.Object.History.prototype.displayNormal = function () {
    Wikimapia.Utils.Dom.addClass(Wikimapia.Utils.Dom.getElements("#by-fields-view-off,#by-fields-view-help,#byFieldsButtonBlock"), "hide");
    Wikimapia.Utils.Dom.removeClass(document.getElementById("by-fields-view"), "hide");
    Wikimapia.Utils.Dom.toggleClass(document.getElementById("history-table"), "fields-view", "normal-view")
};
Wikimapia.Control.Object.History.prototype.showByFieldsLikeAfterApply = function () {
    var t = Wikimapia.Utils.Dom.getElements("ins"),
        e = Wikimapia.Utils.Dom.getElements("del");
    Wikimapia.Utils.Dom.addClass(t, "applied");
    Wikimapia.Utils.Dom.addClass(e, "hide")
};
Wikimapia.Control.Object.History.prototype.showByFieldsNormally = function () {
    var t = Wikimapia.Utils.Dom.getElements("ins"),
        e = Wikimapia.Utils.Dom.getElements("del");
    Wikimapia.Utils.Dom.removeClass(t, "applied");
    Wikimapia.Utils.Dom.removeClass(e, "hide")
};
Wikimapia.Control.Object.History.prototype.onApplySelectedFieldsClick = function (t) {
    var e = t.currentTarget,
        i = e.getAttribute("data-object-id"),
        a = e.getAttribute("data-revision-id"),
        o = this.getCheckedFields();
    if (o.length !== 0) {
        Wikimapia.Interface.Dialog.prompt(Wikimapia.Lang.get("all.ask-sure") + "<br/><em>" + Wikimapia.Lang.get("all.history-revision-comment-title-confirm") + "</em>", function (t) {
            if (t !== null) {
                t = encodeURIComponent(t);
                this.applySelectedFields(i, a, o, t)
            }
        }.bind(this))
    }
};
Wikimapia.Control.Object.History.prototype.updateMap = function () {
    var t = this.map.getLayerByName("wikimapia.interactive.*");
    if (t) t.redraw()
};
Wikimapia.Control.Object.History.prototype.getCheckedFields = function () {
    var t = Wikimapia.Utils.Dom.getElements(document.forms["form1"] || document.getElementById("history-table"), "input[type=checkbox]"),
        e = [],
        i;
    for (var a = 0, o = t.length; a < o; a++) {
        i = t[a];
        if (i.checked) {
            e.push(i.id)
        }
    }
    return e
};
Wikimapia.Control.Object.History.prototype.applySelectedFields = function (t, e, i, a) {
    new Wikimapia.Net.Xhr({
        onSuccess: this.onRevisionApplied.bind(this)
    })
        .send({
            url: Wikimapia.Control.Object.History.urls.REVERT_BY_FIELDS.substitute({
                objectId: t,
                revisionId: e,
                fields: Wikimapia.Control.Object.History.serializeFields(i),
                comment: encodeURIComponent(a)
            })
        });
    return false
};
Wikimapia.Control.Object.History.serializeFields = function (t) {
    var e = "",
        i;
    for (var a = 0, o = t.length; a < o; a++) {
        i = t[a];
        e += "s:" + String(a)
            .length + ':"' + a + '";s:' + i.length + ':"' + i + '";'
    }
    e = "a:" + t.length + ":{" + e + "}";
    return escape(e)
};
Wikimapia.Control.Object.History.prototype.view = function (t, e) {
    var i = Wikimapia.Control.Object.History.urls.VIEW.substitute(t);
    this.setObject(t);
    this.objectWindow = this.map.createPanel({
        url: i + e,
        menu: this.control.getMenuForObject(t, t.type),
        iframe: false,
        position: "left",
        size: this.control.getPanelSizeForObject(),
        onLoad: function () {
            this.map.updateShowHash(i, true)
        }.bind(this),
        onClose: function () {
            this.map.updateShowHash("", true)
        }.bind(this)
    })
};
Wikimapia.Control.Object.Ads = function (t) {
    Wikimapia.Control.Object.Component.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Ads, Wikimapia.Control.Object.Component);
Wikimapia.Control.Object.Ads.url = "/promote/create?placeId={id}&lngId={currentLanguage}";
Wikimapia.Control.Object.Ads.prototype.promote = function (t, e) {
    var i = t.toJSON();
    i.currentLanguage = Wikimapia.Lang.lngToCode(i.currentLanguage);
    this.map.createPanel({
        url: Wikimapia.Control.Object.Ads.url.substitute(i),
        position: "left",
        iframe: true,
        menu: this.control.getMenuForObject(t),
        size: this.control.getPanelSizeForObject()
    })
};
Wikimapia.Control.Object.Nested = function (t) {
    Wikimapia.Control.Object.Data.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Object.Nested, Wikimapia.Control.Object.Data);
Wikimapia.Control.Object.Nested.url = "/object/edit/?id={id}&child={childId}&lng={currentLanguage}&do={action}&revision_comment={comment}";
Wikimapia.Control.Object.Nested.prototype.unbind = function (t) {
    if (t.isDetachable()) {
        this.bindTo(t, null)
    } else {
        t.unbindAfterGeometryEdit = true;
        this.control._place.editGeometry(t)
    }
};
Wikimapia.Control.Object.Nested.prototype.bindTo = function (t, e) {
    var i = e ? "bind" : "unbind";
    this.control.processData({
        url: Wikimapia.Control.Object.Nested.url.substitute({
            id: t.id,
            childId: e,
            currentLanguage: t.currentLanguage,
            action: i
        }),
        method: "get",
        onRequest: function () {
            this.control.objectWindow.setLoading()
        }.bind(this),
        onSuccess: this.onComplete.bind(this)
    })
};
Wikimapia.Control.Object.Nested.prototype.onComplete = function (t) {
    if (!t) {
        console.error("Bind error - no response");
        return
    }
    var e = this.map.getLayerByName("wikimapia.interactive.*");
    if (e) e.redraw();
    if (t.code === Wikimapia.responseCodes.BIND_SUCCESS || t.code === Wikimapia.responseCodes.UNBIND_SUCCESS) {
        if (t.action && t.action.objectId) {
            if (t.action.promote == true) {
                this.control.promoteSocial(t.action.objectId)
            } else {
                this.control.showObject(new Wikimapia.Place({
                    id: t.action.objectId
                }))
            }
        } else if (t.url) {
            router.route(t.url)
        }
    } else if (t.code === Wikimapia.responseCodes.UNBIND_ERROR_NO_GEOMETRY) {
        this.control.currentObject.deletionState = Wikimapia.Object.objectState.CHILD_OBJECT_CANT_UNBIND;
        this.unbind(this.control.currentObject)
    } else {
        this.map.fireEvent("responseError", t)
    }
};
Wikimapia.Control.Object.Nested.prototype.selectChildPlace = function (t, e, i) {
    this.objectWindow = this.map.createPanel({
        position: "left",
        url: e,
        onLoad: function () {
            this.onChildSelectLoad(t)
        }.bind(this),
        iframe: false
    })
};
Wikimapia.Control.Object.Nested.prototype.onChildSelected = function () {
    var t = Wikimapia.Utils.Dom.getElement(this.form, ".nested-object-select"),
        e = Wikimapia.Utils.Dom.getElement(this.form, ".nested-object-submit");
    if (t.selectedIndex === 0) {
        e.setAttribute("disabled", "disabled")
    } else {
        e.removeAttribute("disabled")
    }
};
Wikimapia.Control.Object.Nested.prototype.onChildSelectLoad = function (t) {
    var e = document.getElementById("child-bind-form");
    if (!e) return;
    this.initFormInternal(e);
    Wikimapia.Utils.Dom.addEvent(Wikimapia.Utils.Dom.getElement(e, ".nested-object-select"), "change", this.onChildSelected.bind(this));
    Wikimapia.Utils.Dom.addEvents(e, {
        submit: function (i) {
            i.stop();
            var a = parseInt(e["child"].value),
                o = document.getElementById("error-block");
            if (a) {
                o.hide();
                this.bindTo(t, a)
            } else {
                o.show()
            }
        }.bind(this),
        reset: function (i) {
            i.stop();
            Wikimapia.Utils.Dom.removeEvents(e);
            this.control.showObject(t)
        }.bind(this)
    })
};
Wikimapia.Control.Category = function (t) {
    Wikimapia.Control.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Category, Wikimapia.Control);
Wikimapia.Control.Category.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "Category",
    view: false
});
Wikimapia.Control.Category.prototype.setMap = function (t) {
    Wikimapia.Control.prototype.setMap.call(this, t)
};
Wikimapia.Control.Coords = function (t) {
    Wikimapia.Control.prototype.constructor.call(this, t);
    this.div.innerHTML = '<div id="coords-container"></div>'
};
Wikimapia.Utils.inherits(Wikimapia.Control.Coords, Wikimapia.Control);
Wikimapia.Control.Coords.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "coords"
});
Wikimapia.Control.Coords.prototype.setMap = function (t) {
    Wikimapia.Control.prototype.setMap.call(this, t);
    Wikimapia.Utils.bindHandlers(this, "onMapMove", "onAttributionSet", "onCoordsClick", "openConverter");
    this.map.addEvents({
        moveend: this.handlers.onMapMove,
        showCoordsConverter: this.handlers.openConverter,
        attributionSet: this.handlers.onAttributionSet
    });
    this.coordsContainer = document.getElementById("coords-container");
    Wikimapia.Utils.Dom.addEvent(this.coordsContainer, "click", this.handlers.onCoordsClick)
};
Wikimapia.Control.Coords.prototype.onMapMove = function () {
    this.render(this.map.getCenter())
};
Wikimapia.Control.Coords.prototype.setPosition = function () {
    Wikimapia.Utils.Dom.setStyles(this.div, {
        position: "",
        display: ""
    })
};
Wikimapia.Control.Coords.prototype.render = function (t) {
    t = t || this.map.getCenter();
    this.coordsContainer = this.coordsContainer || document.getElementById("coords-container");
    var e = Wikimapia.Utils.getFormattedLonLat,
        i = Wikimapia.Utils.drawShadowedText({
            text: e(t.lat, "lat", "dms") + "&nbsp;" + e(t.lng, "lon", "dms"),
            className: "coords"
        });
    this.coordsContainer.innerHTML = i
};
Wikimapia.Control.Coords.prototype.openConverter = function (t) {
    if (document.getElementById("coordtable")) {
        this.showConverter(t)
    } else {
        new Wikimapia.Net.Xhr({
            method: "get",
            type: "html",
            onSuccess: function (e) {
                document.getElementById("coordtable-wrap")
                    .innerHTML = e;
                this.showConverter(t)
            }.bind(this)
        })
            .send({
                url: "/ajax/coordinates/"
            })
    }
};
Wikimapia.Control.Coords.prototype.showConverter = function (t) {
    t = t || this.map.getCenter();
    var e = t,
        i = Math.round(e.lat * 1e7) / 1e7,
        a = Math.round(e.lng * 1e7) / 1e7,
        o = Wikimapia.Utils.getFormattedLonLat,
        n = Wikimapia.Utils.alphaImageHackNeeded ? function (t) {
            return '"' + t + '"'
        } : function (t) {
            return t
        };
    this.map.createWindow({
        iframe: false,
        size: new Wikimapia.Size(500, 230),
        content: document.getElementById("coordtable-wrap")
            .innerHTML.substitute({
                ll: n(i + ", " + a),
                lld: n(i + (i < 0 ? "S" : "N") + " " + (a + (a < 0 ? "W" : "E"))),
                lldms: n([o(i, "lat", "dms"), o(a, "lon", "dms")].join(" ")),
                hash: window.location.hash
            })
    })
};
Wikimapia.Control.Coords.prototype.onAttributionSet = function () {
    if (this.map.baseLayer) {
        var t = this.map.baseLayer.getName(),
            e = /bing/.test(t) ? 45 : 32,
            i = /here/.test(t) ? 40 : 6;
        Wikimapia.Utils.Dom.setStyles(this.coordsContainer, {
            bottom: e,
            left: i
        })
    }
};
Wikimapia.Control.Coords.prototype.onCoordsClick = function (t) {
    this.openConverter()
};
Wikimapia.Control.Coords.prototype.destroy = function () {
    this.map.removeEvents({
        moveend: this.handlers.onMapMove,
        showCoordsConverter: this.handlers.openConverter,
        attributionSet: this.handlers.onAttributionSet
    });
    Wikimapia.Utils.Dom.removeEvent(this.coordsContainer, "click", this.handlers.onCoordsClick);
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.ObjectCount = function (t) {
    Wikimapia.Control.prototype.constructor.call(this, t);
    this.div.setAttribute("id", this.name);
    Wikimapia.Utils.bindHandlers(this, "onAttributionSet", "onObjectCountUpdate", "onClick")
};
Wikimapia.Utils.inherits(Wikimapia.Control.ObjectCount, Wikimapia.Control);
Wikimapia.Control.ObjectCount.prototype.name = "wm-objectcount";
Wikimapia.Control.ObjectCount.prototype.placeCount = 0;
Wikimapia.Control.ObjectCount.prototype.setMap = function (t) {
    Wikimapia.Control.prototype.setMap.call(this, t);
    this.map.addEvent("attributionSet", this.handlers.onAttributionSet);
    Wikimapia.Utils.Dom.addEvent(window, "updatePlaceCount", this.handlers.onObjectCountUpdate);
    Wikimapia.Utils.Dom.addEvent(this.div, "click", this.handlers.onClick)
};
Wikimapia.Control.ObjectCount.prototype.render = function (t) {
    if (!isNaN(t) && t !== 0) {
        this.div.innerHTML = Wikimapia.Utils.drawShadowedText({
            text: Wikimapia.Lang.get("all.places-count")
                .replace("%1", t)
                .replace(/\s/, "&nbsp;"),
            className: "placecount"
        })
    }
};
Wikimapia.Control.ObjectCount.prototype.onClick = function () {
    Wikimapia.Utils.Logger.log("place_count_click");
    this.map.showStats()
};
Wikimapia.Control.ObjectCount.prototype.onObjectCountUpdate = function (t, e) {
    e = e || this.placeCount;
    var i = [0, 1, 1, 2, 3],
        a;
    if (e < this.placeCount) {
        (i = i.slice(0, 2))
        .unshift(0);
        e = this.placeCount
    }
    a = i[Math.floor(Math.random() * i.length)];
    if (e) {
        e += a
    }
    if (e !== this.placeCount) {
        this.render(e)
    }
    this.placeCount = e;
    this.render()
};
Wikimapia.Control.ObjectCount.prototype.onAttributionSet = function () {
    if (this.map.baseLayer) {
        var t = this.map.baseLayer.getName(),
            e = 20,
            i = 10,
            a;
        if (/osm|yahoo/.test(t)) {
            e = 28
        } else if (/yandex/.test(t)) {
            e = 18;
            i += 60
        } else if (/ovi|bing|wikimapia/.test(t)) {
            e = 10
        }
        Wikimapia.Utils.Dom.setStyles(this.div, {
            bottom: e,
            right: i
        });
        a = Wikimapia.Utils.Dom.getElement(".wikimapia-attribution");
        if (a) {
            if (a.nextSibling !== this.div) {
                Wikimapia.Utils.Dom.inject(a, this.div, "before")
            }
            Wikimapia.Utils.Dom.setStyles(a, {
                bottom: /osm|yahoo/.test(t) ? e - 20 : e + 6,
                right: 130
            })
        }
    }
};
Wikimapia.Control.ObjectCount.prototype.destroy = function () {
    this.map.removeEvent("attributionSet", this.handlers.onAttributionSet);
    Wikimapia.Utils.Dom.removeEvent(window, "updatePlaceCount", this.handlers.onObjectCountUpdate);
    Wikimapia.Utils.Dom.removeEvent(this.div, "click", this.handlers.onClick);
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.Geolocation = function (t) {
    Wikimapia.Control.prototype.constructor.call(this);
    this.marker = null;
    t.addControl(this)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Geolocation, Wikimapia.Control);
Wikimapia.Control.Geolocation.MARKER_IMAGE = Wikimapia.Utils.appendFileVersion(Wikimapia.Utils.defaultImagesUrl + "mobile/icons/position-marker.png");
Wikimapia.Control.Geolocation.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "Geolocation",
    view: true,
    position: {
        left: 28,
        top: 40
    },
    locationRequestTimeout: 5e3,
    tooltip: "geoloc"
});
Wikimapia.Control.Geolocation.prototype.button = null;
Wikimapia.Control.Geolocation.prototype.render = function () {
    Wikimapia.Control.prototype.render.call(this);
    this.button = new Wikimapia.Interface.Button({
        icon: new Wikimapia.Icon({
            image: Wikimapia.Control.Geolocation.SPRITE_PATH,
            imageSpritePos: "-18px -1280px"
        }),
        tooltip: this.options.tooltip
    });
    this.bindEvents();
    this.button.inject(this.div);
    Wikimapia.Utils.Dom.addClass(this.div, "geolocation");
    this.decorate()
};
Wikimapia.Control.Geolocation.prototype.decorate = function () {
    var t = this.map.getControlByName("zoomControl");
    if (t) {
        t.setPosition({
            top: 74,
            left: t.options.position.left
        })
    }
    Wikimapia.Utils.Dom.setStyles(document.getElementById(this.button.div.id + "-tooltip"), {
        top: 30,
        left: 34
    })
};
Wikimapia.Control.Geolocation.prototype.bindEvents = function () {
    Wikimapia.Utils.bindHandlers(this, "onClick", "onMouseEnter", "onMouseLeave");
    this.button.addEvents({
        click: this.handlers.onClick,
        mouseenter: this.handlers.onMouseEnter,
        mouseleave: this.handlers.onMouseLeave
    })
};
Wikimapia.Control.Geolocation.prototype.onClick = function () {
    if (!this.button.disabled && navigator.geolocation) {
        var t = this;
        this.button.setLoading();
        Wikimapia.Utils.Logger.log("geoloc_btn");
        var e = setTimeout(function () {
            t.enableButton()
        }, this.options.locationRequestTimeout);
        navigator.geolocation.getCurrentPosition(function (i) {
            clearTimeout(e);
            t.onGeopositionReceived(i)
        }, function (i) {
            clearTimeout(e);
            t.enableButton()
        }, {
            enableHighAccuracy: true,
            timeout: this.options.locationRequestTimeout
        })
    }
};
Wikimapia.Control.Geolocation.prototype.onMouseEnter = function () {
    if (!this.button.disabled) {
        this.button.setIcon(new Wikimapia.Icon({
            image: Wikimapia.Control.Geolocation.SPRITE_PATH,
            imageSpritePos: "-18px -1296px"
        }))
    }
};
Wikimapia.Control.Geolocation.prototype.onMouseLeave = function () {
    if (!this.button.disabled) {
        this.button.setIcon(new Wikimapia.Icon({
            image: Wikimapia.Control.Geolocation.SPRITE_PATH,
            imageSpritePos: "-18px -1280px"
        }))
    }
};
Wikimapia.Control.Geolocation.prototype.onGeopositionReceived = function (t) {
    var e = new Wikimapia.LatLng(t.coords.latitude, t.coords.longitude),
        i = t.coords.accuracy * 1.5,
        a = Wikimapia.Utils.offsetLatLngByMeters(e, -i, -i),
        o = Wikimapia.Utils.offsetLatLngByMeters(e, i, i),
        n = new Wikimapia.Bounds({
            top: a.lat,
            left: a.lng,
            right: o.lng,
            bottom: o.lat
        }),
        s = this.zoomToBounds.bind(this, n),
        r = this.map.getBestZoomForBounds(n, true);
    this.map.setCenter(e);
    if (r > this.map.options.maxZoomLevel) {
        if (r - this.map.options.maxZoomLevel <= 3) {
            s()
        } else {
            this.map.addEventOnce("zoomLimitsChanged", s)
        }
    } else {
        setTimeout(s, 400)
    }
};
Wikimapia.Control.Geolocation.prototype.zoomToBounds = function (t) {
    Wikimapia.Net.Asset.image(Wikimapia.Control.Geolocation.MARKER_IMAGE, {
        onLoad: this.addMarker.bind(this, t.getCenterLatLng())
    });
    this.map.zoomToBounds(t);
    this.enableButton()
};
Wikimapia.Control.Geolocation.prototype.addMarker = function (t) {
    this.removeMarker();
    this.marker = new Wikimapia.Marker({
        map: this.map,
        coords: t,
        icon: new Wikimapia.Icon({
            size: new Wikimapia.Size(21, 21),
            image: Wikimapia.Control.Geolocation.MARKER_IMAGE
        }),
        offset: new Wikimapia.Size(-10, -10)
    });
    this.marker.addEvent("contextmenu", this.onMarkerClick.bind(this))
};
Wikimapia.Control.Geolocation.prototype.removeMarker = function () {
    if (this.marker) {
        this.marker.setMap(null);
        this.marker = null
    }
};
Wikimapia.Control.Geolocation.prototype.onMarkerClick = function (t) {
    t.stop();
    this.map.contextMenu([{
        text: "rd-delpoi",
        action: this.removeMarker.bind(this),
        icon: {
            imageSpriteClass: "spt-cancel"
        }
    }], {}, "marker-context-menu", this.marker.getContainerPosition())
};
Wikimapia.Control.Geolocation.prototype.enableButton = function () {
    if (this.button.disabled) {
        this.button.stopLoading()
    }
    this.onMouseLeave()
};
Wikimapia.Control.Geolocation.prototype.destroy = function () {
    this.removeMarker();
    this.button.removeEvents({
        click: this.handlers.onClick,
        mouseenter: this.handlers.onMouseEnter,
        mouseleave: this.handlers.onMouseLeave
    });
    this.button.destroy();
    delete this.button;
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.Geolocation.SPRITE_PATH = Wikimapia.Utils.defaultImagesUrl + "menu-spt.png";
Wikimapia.Control.DistanceMeasurerButton = function (t) {
    this.map = t;
    Wikimapia.Control.prototype.constructor.call(this);
    this.map.addControl(this)
};
Wikimapia.Utils.inherits(Wikimapia.Control.DistanceMeasurerButton, Wikimapia.Control);
Wikimapia.Control.DistanceMeasurerButton.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "DistanceMeasurerButton",
    position: {
        left: 28,
        top: 255
    },
    tooltip: "dismeas",
    view: true
});
Wikimapia.Control.DistanceMeasurerButton.prototype.button = null;
Wikimapia.Control.DistanceMeasurerButton.prototype.render = function () {
    Wikimapia.Control.prototype.render.call(this);
    this.button = new Wikimapia.Interface.Button({
        icon: new Wikimapia.Icon({
            image: Wikimapia.Control.DistanceMeasurerButton.SPRITE_PATH,
            imageSpritePos: "-17px -35px"
        }),
        tooltip: this.options.tooltip
    });
    this.bindEvents();
    this.button.inject(this.div);
    this.onZoomLimitsChanged();
    Wikimapia.Utils.Dom.addClass(this.div, "distance-measure");
    this.div.setAttribute("id", "distance-measure-button")
};
Wikimapia.Control.DistanceMeasurerButton.prototype.bindEvents = function () {
    Wikimapia.Utils.bindHandlers(this, "onClick", "onZoomLimitsChanged");
    this.button.addEvent("click", this.handlers.onClick);
    this.map.addEvent("zoomLimitsChanged", this.handlers.onZoomLimitsChanged)
};
Wikimapia.Control.DistanceMeasurerButton.prototype.onZoomLimitsChanged = function () {
    var t = this.map.getControlByName("zoomControl"),
        e = this.button;
    if (t) {
        setTimeout(function () {
            var i = t.getElement(),
                a = new Wikimapia.Point(this.options.position.left, i.getPosition()
                    .y + i.getSize()
                    .y);
            this.setPosition(a);
            e.setTooltipPosition(new Wikimapia.Point(0, 0))
        }.bind(this), 100)
    }
};
Wikimapia.Control.DistanceMeasurerButton.prototype.onClick = function () {
    if (!this.button.distabled) {
        this.button.setLoading();
        Wikimapia.Utils.Logger.log("measure_tool_btn");
        this.map.launchDistanceMeasurer(null, this.onComplete.bind(this))
    }
};
Wikimapia.Control.DistanceMeasurerButton.prototype.onComplete = function () {
    Wikimapia.Utils.Logger.log("measure_tool_launched");
    this.button.stopLoading()
};
Wikimapia.Control.DistanceMeasurerButton.prototype.destroy = function () {
    this.button.removeEvent("click", this.handlers.onClick);
    this.map.removeEvent("zoomLimitsChanged", this.handlers.onZoomLimitsChanged);
    this.button.destroy();
    delete this.button;
    Wikimapia.Control.prototype.destroy()
};
Wikimapia.Control.DistanceMeasurerButton.SPRITE_PATH = Wikimapia.Utils.defaultImagesUrl + "menu-spt.png";
(function () {
    Wikimapia.Net.Asset.images([Wikimapia.Utils.appendFileVersion(Wikimapia.Utils.defaultControlsUrl + "switch-map.png"), Wikimapia.Utils.appendFileVersion(Wikimapia.Utils.defaultMapIconsDir + "provider-icons.png"), Wikimapia.Utils.appendFileVersion(Wikimapia.Utils.defaultMapIconsDir + "provider-examples.jpg")]);
    var t = {
        "wikimapia.imagetiles.hybrid": {
            name: "mtype-woverlay"
        },
        "wikimapia.imagetiles.map": {
            name: "mtype-wmap",
            hashTag: "w"
        },
        "google.satellite": {
            name: "g-sat",
            hashTag: "b"
        },
        "google.hybrid": {
            name: "g-hyb",
            hashTag: "h"
        },
        "google.map": {
            name: "g-map",
            hashTag: "m"
        },
        "bing.satellite": {
            name: "b-sat",
            hashTag: "bs"
        },
        "bing.hybrid": {
            name: "b-hyb",
            hashTag: "bh"
        },
        "bing.map": {
            name: "b-map",
            hashTag: "bm"
        },
        "here.satellite": {
            name: "h-sat",
            hashTag: "os",
            omit: true
        },
        "here.hybrid": {
            name: "h-hyb",
            hashTag: "oh",
            omit: true
        },
        "here.map": {
            name: "h-map",
            hashTag: "om",
            omit: true
        },
        "yandex.satellite": {
            name: "y-sat",
            hashTag: "ys"
        },
        "yandex.hybrid": {
            name: "y-hyb",
            hashTag: "yh"
        },
        "yandex.map": {
            name: "y-map",
            hashTag: "ym"
        },
        OSM: {
            name: "OpenStreetMap",
            hashTag: "o"
        },
        "google.terrain": {
            name: "g-ter",
            hashTag: "t"
        },
        "yahoo.satellite": {
            name: "yh-sat",
            hashTag: "yhs"
        },
        "wikimapia.interactive.classic": {
            name: "wikimapia-classic",
            hashTag: "s",
            omit: true
        }
    };
    Wikimapia.Control.MapSwitcher = function (t) {
        Wikimapia.Control.prototype.constructor.call(this, t)
    };
    Wikimapia.Utils.inherits(Wikimapia.Control.MapSwitcher, Wikimapia.Control);
    Wikimapia.Control.MapSwitcher.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
        name: "MapSwitcher",
        position: {
            top: "40px",
            right: "185px"
        },
        floatTo: "right",
        hideDelay: 1e3
    });
    Wikimapia.Control.MapSwitcher.prototype.isExpanded = false;
    Wikimapia.Control.MapSwitcher.prototype.switchers = {};
    Wikimapia.Control.MapSwitcher.prototype.currentMap = null;
    Wikimapia.Control.MapSwitcher.prototype.list = null;
    Wikimapia.Control.MapSwitcher.prototype.button = null;
    Wikimapia.Control.MapSwitcher.prototype.hideTimeout = null, Wikimapia.Control.MapSwitcher.prototype.filterProviders = function () {
        var e = Wikimapia.Utils.cloneObject(t);
        if (!Wikimapia.Utils.debug) {
            if (!Wikimapia.Lang.checkCISByLanguage()) {
                delete e["yandex.map"];
                delete e["yandex.hybrid"];
                delete e["yandex.satellite"]
            }
        }
        return e
    };
    Wikimapia.Control.MapSwitcher.prototype.setMap = function (t) {
        Wikimapia.Control.prototype.setMap.call(this, t);
        Wikimapia.Utils.bindHandlers(this, "onBaseLayerChange", "onLayerRemoved");
        this.map.addEvents({
            baseLayerSet: this.handlers.onBaseLayerChange,
            layerRemoved: this.handlers.onLayerRemoved
        })
    };
    Wikimapia.Control.MapSwitcher.prototype.onLayerRemoved = function (t) {
        if (/classic$/.test(t.getName())) {
            var e = this.map.baseLayer.getName();
            if (Wikimapia.Control.MapSwitcher.getLayerDependencies(e, e)
                .allowOverlay) {
                this.turnCustomLayers("on")
            }
            this.checkInteractive()
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.onBaseLayerChange = function (e) {
        e = (e || this.map.baseLayer.getName())
            .replace(/-/g, ".");
        if (!this.drawn) {
            this.render()
        }
        var i = t[e];
        if (i) {
            this.map.options.base = i.hashTag;
            this.map.fireEvent("baseLayerChanged")
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.getIcon = function (t) {
        var e = new Wikimapia.Icon({
            image: Wikimapia.Utils.appendFileVersion("/img/map-icons/provider-icons.png"),
            imageSpriteClass: "list-icon " + t.split(/\./)[0] + "-icon"
        });
        return e
    };
    Wikimapia.Control.MapSwitcher.prototype.render = function () {
        if (!this.map.baseLayer) {
            return
        }
        var t = this.map.baseLayer.getName()
            .replace(/-/g, "."),
            e = this.options,
            i = this.getMapTypeName(t);
        this.currentMap = t;
        this.button = new Wikimapia.Interface.Button({
            text: i,
            icon: this.getIcon(t),
            position: new Wikimapia.Point(0, 0)
        });
        this.button.inject(this.div, "bottom");
        this.adjustButtonPosition(this.button);
        this.list = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
            "class": "list",
            html: '<div class="map-switchers"></div><div class="bottom"></div>'
        }), this.div, "bottom");
        Wikimapia.Utils.Dom.addEvents(this.div, {
            mouseleave: this.onMouseMove.bind(this),
            mouseenter: this.onMouseEnter.bind(this)
        });
        this.list.hide();
        this.updateContent();
        this.button.addEvents({
            mouseenter: function () {
                clearTimeout(this.showTimeout);
                this.showTimeout = setTimeout(function () {
                    this.expand();
                    this.isExpanded = false
                }.bind(this), 700)
            }.bind(this),
            mouseleave: function () {
                clearTimeout(this.showTimeout)
            }.bind(this),
            click: function () {
                clearTimeout(this.showTimeout);
                if (this.isExpanded) this.constrict();
                else this.expand()
            }.bind(this)
        });
        this.map.addEvent("mousedown", this.onDocumentMouseDown.bind(this));
        this.drawn = true;
        if (this.currentMap === "google.satellite") {
            this.currentMap = "wikimapia.imagetiles.hybrid";
            this.updateButton()
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.updateButton = function () {
        var t = this.getMapTypeName(this.currentMap || this.map.baseLayer.getName()
            .replace(/-/g, "."));
        this.button.setIcon(this.getIcon(this.currentMap));
        this.button.options.text = t;
        this.button.setText(t);
        this.highlightCurrentType();
        this.adjustButtonPosition(this.button)
    };
    Wikimapia.Control.MapSwitcher.prototype.onMouseMove = function (t) {
        clearTimeout(this.hideTimeout);
        this.hideTimeout = setTimeout(this.constrict.bind(this), this.options.hideDelay);
        return false
    };
    Wikimapia.Control.MapSwitcher.prototype.onMouseEnter = function (t) {
        clearTimeout(this.hideTimeout)
    };
    Wikimapia.Control.MapSwitcher.prototype.adjustButtonPosition = function (t) {
        if (this.options.floatTo == "right") {
            var e = t.options,
                i = Wikimapia.Utils.measureText(e.text, e.font.size, e.font.family, e.font.weight),
                a = t.options.size.w,
                o = a < 185 ? 185 - 25 - a : -(a - 185 + 25);
            Wikimapia.Utils.Dom.setStyle(t.div, "left", o)
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.clearExpandDelays = function () {
        clearTimeout(this.hideTimeout);
        clearTimeout(this.showTimeout)
    };
    Wikimapia.Control.MapSwitcher.prototype.expand = function () {
        this.clearExpandDelays();
        this.updateContent();
        this.list.show();
        this.isExpanded = true
    }, Wikimapia.Control.MapSwitcher.prototype.constrict = function () {
        this.clearExpandDelays();
        this.list.hide();
        this.updateContent();
        this.isExpanded = false
    };
    Wikimapia.Control.MapSwitcher.prototype.updateContent = function () {
        var t = Wikimapia.Utils.Dom.getElement(this.list, ".map-switchers"),
            e = this;
        if (this.switchers) {
            Wikimapia.Utils.objectForEach(this.switchers, function (t) {
                Wikimapia.Utils.Dom.destroy(t)
            })
        }
        if (this.statusbar) {
            Wikimapia.Utils.Dom.destroy(this.statusbar)
        }
        this.switchers = {};
        var i = this.filterProviders();
        Wikimapia.Utils.objectForEach(i, function (e, i) {
            if (e.omit) {
                return
            }
            var a = i.split(/[\.-]/g)[0];
            this.switchers[i] = Wikimapia.Utils.Dom.create("div", {
                "class": "switcher-preview " + a + " " + i.clean()
                    .replace(/\./g, "-") + "-preview",
                title: this.getMapTypeName(i),
                html: '<div class="map-icon"></div>',
                events: {
                    click: function (t) {
                        Wikimapia.Utils.Logger.log("map_type_" + i);
                        this.onMapSwitcherClick(t, i)
                    }.bind(this),
                    mouseover: function (t) {
                        this.setStatusText(this.getMapTypeName(i))
                    }.bind(this),
                    mouseout: function (t) {
                        this.setStatusText(this.getMapTypeName(this.currentMap || this.map.baseLayer.getName()
                            .replace(/-/, ".")))
                    }.bind(this)
                }
            });
            Wikimapia.Utils.Dom.inject(this.switchers[i], t)
        }.bind(this));
        this.addStatusBar();
        Wikimapia.Utils.Dom.setStyle(t, "height", Math.ceil(Wikimapia.Utils.getObjectLength(i) / 3) * 42 - 10 + "px");
        this.highlightCurrentType()
    };
    Wikimapia.Control.MapSwitcher.prototype.highlightCurrentType = function (t) {
        t = t || this.currentMap;
        if (t) {
            var e = Wikimapia.Utils.Dom.getElements(this.div, ".switcher-preview"),
                i = /satellite/.test(t);
            e.forEach(function (e, i) {
                if (Wikimapia.Utils.Dom.hasClass(e, t.replace(/\./g, "-") + "-preview")) {
                    Wikimapia.Utils.Dom.addClass(e, "selected")
                } else {
                    Wikimapia.Utils.Dom.removeClass(e, "selected")
                }
            })
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.addStatusBar = function () {
        this.statusbar = Wikimapia.Utils.Dom.create("div", {
            id: "wm-" + this.options.name + "-statusBar"
        });
        Wikimapia.Utils.Dom.inject(this.statusbar, Wikimapia.Utils.Dom.getElement(this.list, ".bottom"), "before")
    };
    Wikimapia.Control.MapSwitcher.prototype.onDocumentMouseDown = function () {
        if (this.isExpanded) {
            this.constrict()
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.onMapSwitcherClick = function (t, e) {
        t.stop();
        if (this.options.floatTo == "right") {
            Wikimapia.Utils.Dom.setStyle(this.button.div, "left", 162 - this.button.getTextWidth() - 40 + "px")
        }
        this.changeMapType(e)
    };
    Wikimapia.Control.MapSwitcher.prototype.checkLayerSupport = function (t, e) {
        if (t in Wikimapia.supportedLayers) {
            e()
        } else {
            var i = this.map,
                a = t.split(".")
                .shift(),
                o = this;
            Wikimapia.Net.loadModule(Wikimapia.Utils.resolveLayerPath(t), e)
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.changeMapType = function (t) {
        this.checkLayerSupport(t, function () {
            if (t in Wikimapia.supportedLayers) {
                this.change(t)
            }
        }.bind(this))
    };
    Wikimapia.Control.MapSwitcher.prototype.turnCustomLayers = function (t) {
        var e = ["wikimapia.imagetiles.hybrid"],
            i = e.map(function (t) {
                return this.map.getLayerByName(t)
            }.bind(this));
        for (var a = 0, o = i.length; a < o; a++) {
            if (t == "on") {
                if (!i[a]) {
                    this.map.addLayer(this.map.parseLayer(e[a]))
                }
            } else {
                if (i[a]) {
                    this.map.removeLayer(i[a])
                }
            }
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.changeToWikimapiaOverlay = function () {
        var e = this.map,
            i = "wikimapia.imagetiles.hybrid",
            a = "google.satellite",
            o = this.map.getLayerByName(i);
        if (!/^google/.test(e.baseLayer.getName())) {
            e.removeLayer(e.baseLayer);
            e.addBaseLayer(e.parseLayer(a))
        } else {
            e.baseLayer.setMapType(Wikimapia.supportedLayers[a].defaultOptions.type, i)
        }
        this.map.options.base = t[i].hashTag;
        this.map.fireEvent("baseLayerChanged");
        if (!o) {
            e.addLayer(e.parseLayer(i))
        }
        this.currentMap = i
    };
    Wikimapia.Control.MapSwitcher.prototype.change = function (t) {
        var e = this.map,
            i = Wikimapia.Control.MapSwitcher.getLayerDependencies(t, e.baseLayer.getName());
        if (t === "wikimapia.imagetiles.hybrid") {
            this.changeToWikimapiaOverlay()
        } else if (e.getLayerByName(t)) {
            this.constrict();
            this.currentMap = t
        } else {
            this.map.closeWindow();
            if (e.getLayerByName("wikimapia.interactive.classic")) {
                i.allowOverlay = false
            }
            if (i.baseOnly) {
                if (i.sameProvider) {
                    e.baseLayer.setMapType(Wikimapia.supportedLayers[t].defaultOptions.type, t)
                } else {
                    e.removeLayer(e.baseLayer);
                    e.addBaseLayer(e.parseLayer(t))
                }
                this.onBaseLayerChange(t);
                this.currentMap = t
            } else {
                var a = Wikimapia.Control.MapSwitcher.getLayerDependencies(e.baseLayer.getName(), e.baseLayer.getName()),
                    o = e.getLayerByName(t);
                if (!a.allowOverlay) {
                    var n = null;
                    if (/google|yandex|bing|yahoo|here/.test(this.map.baseLayer.getName())) {
                        n = this.map.baseLayer.getName()
                            .split(/[.-]/)
                            .shift() + ".satellite";
                        n = Wikimapia.supportedLayers[n].defaultOptions.type;
                        e.baseLayer.setMapType(n);
                        a.allowOverlay = true
                    } else {
                        if (/OSM|wikimapia[\.-]imagetiles/.test(e.baseLayer.getName())) {
                            n = "google.satellite";
                            e.removeLayer(e.baseLayer);
                            e.addBaseLayer(e.parseLayer(n))
                        }
                    }
                    if (n) {
                        i.allowOverlay = a.allowOverlay = true
                    }
                    this.currentMap = this.map.baseLayer.getName()
                        .replace("-", ".")
                }
                if (!o && a.allowOverlay) {
                    e.addLayer(e.parseLayer(t))
                }
            }
            this.turnCustomLayers(i.allowOverlay ? "on" : "off")
        }
        this.checkInteractive(t);
        this.button.setIcon(this.getIcon(this.currentMap));
        var s = this.getMapTypeName(this.currentMap);
        this.button.options.text = s;
        this.button.setText(s);
        this.highlightCurrentType();
        this.adjustButtonPosition(this.button);
        this.constrict()
    };
    Wikimapia.Control.MapSwitcher.prototype.setStatusText = function (t) {
        clearTimeout(this.statusTimer);
        this.statusTimer = setTimeout(function () {
            this.statusbar.innerHTML = t;
            Wikimapia.Utils.Dom[t.length > 19 ? "addClass" : "removeClass"](this.statusbar, "two-lines")
        }.bind(this), 50)
    };
    Wikimapia.Control.MapSwitcher.prototype.getMapTypeName = function (e) {
        return Wikimapia.Lang.get("all." + t[e].name) || e
    };
    Wikimapia.Control.MapSwitcher.prototype.onLanguageChange = function (t) {
        this.updateButton();
        this.updateContent()
    };
    Wikimapia.Control.MapSwitcher.prototype.checkInteractive = function (t) {
        var e = this.map.getLayersByName("wikimapia.interactive.*"),
            i = this.map;
        if (/classic$/.test(t)) {
            e.forEach(function (e) {
                if (e.getName() !== t.replace(/\./g, "-")) {
                    i.removeLayer(e)
                }
            })
        } else {
            var a = this.map.getLayersByName("wikimapia.linear.*");
            if (e.length === 0 && a.length === 0) {
                this.map.addLayer(this.map.parseLayer("wikimapia.interactive.basic"))
            }
        }
    };
    Wikimapia.Control.MapSwitcher.prototype.destroy = function () {
        this.map.removeEvents({
            baseLayerSet: this.handlers.onBaseLayerChange,
            layerRemoved: this.handlers.onLayerRemoved
        });
        Wikimapia.Control.prototype.destroy.call(this)
    };
    Wikimapia.Control.MapSwitcher.getLayerDependencies = function (t, e) {
        var i = /yahoo|google|yandex|osm|bing|here|(imagetiles\.map)/i.test(t),
            a = /(satellite)$/i.test(t),
            o = e ? t.split(/[\.-]/)[0] == e.split(/[\.-]/)[0] : undefined;
        return {
            baseOnly: i,
            allowOverlay: a,
            sameProvider: o
        }
    };
    Wikimapia.Control.MapSwitcher.getLayerSet = function (e, i, a) {
        var o = ["google.satellite", "wikimapia.imagetiles.hybrid", "wikimapia.interactive.basic"],
            n = e === "s" ? 2 : 0,
            s;
        if (e === "os") {
            e = "b"
        } else if (e === "om") {
            e = "m"
        } else if (e === "oh") {
            e = "h"
        }
        if (typeof e === "string") {
            for (var r in t) {
                if (t[r].hashTag === e) {
                    o[n] = r;
                    break
                }
            }
        }
        s = Wikimapia.Control.MapSwitcher.getLayerDependencies(o[n], o[0]);
        if (!s.allowOverlay) {
            o.splice(1, 1)
        }
        if (i || a) {
            if (i === "o") {
                o.push("wikimapia.interactive.hotels")
            } else {
                i = parseInt(i);
                if (i === 4 || !isNaN(a)) {
                    o.pop()
                }
            }
        }
        return o
    }
})();
Wikimapia.Control.Pan = function (t) {
    Wikimapia.Control.prototype.constructor.call(this, t);
    var e = Wikimapia.Utils.alphaImageHackNeeded ? Wikimapia.Utils.blankImage : this.options.background;
    Wikimapia.Utils.Dom.setStyles(this.div, {
        width: "53px",
        height: "53px",
        position: "absolute",
        "background-image": "url(" + e + ")",
        display: "none"
    });
    if (Wikimapia.Utils.alphaImageHackNeeded) {
        var i = Wikimapia.Utils.Dom.create("div", {
            id: "pan-control-wrapper",
            style: this.styles.bg
        });
        Wikimapia.Utils.Dom.inject(i, this.div);
        i.style.filter = Wikimapia.Utils.alphaImageHack(this.options.background, "crop")
    }
    Wikimapia.Utils.bindHandlers(this, "keyboard", "disable", "enable")
};
Wikimapia.Utils.inherits(Wikimapia.Control.Pan, Wikimapia.Control);
Wikimapia.Control.Pan.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "pan",
    position: {
        top: "40px",
        left: "10px"
    },
    background: Wikimapia.Utils.defaultControlsUrl + "pan-control.png",
    kx: .03,
    ky: .05
});
Wikimapia.Control.Pan.prototype.dirs = {
    WEST: 0,
    EAST: 1,
    NORTH: 2,
    SOUTH: 3
};
Wikimapia.Control.Pan.prototype.styles = {
    vertical: "display: block; width:22px; height: 20px; position: absolute; padding: 0; cursor:pointer;",
    horizontal: "display: block; width:20px; height: 22px; position: absolute; padding: 0; cursor:pointer;",
    bg: "width: 53px; height: 53px; position: absolute; top: 0px; left: 0px;"
};
Wikimapia.Control.Pan.prototype._enabled = true;
Wikimapia.Control.Pan.prototype.getPanner = function (t) {
    var e = this.dirs,
        i = t === e.WEST ? 1 : t === e.EAST ? -1 : 0,
        a = t === e.NORTH ? 1 : t === e.SOUTH ? -1 : 0;
    return function (t) {
        t.stop();
        if (this.map && this._enabled) {
            var e = this.map.getSize();
            this.map.panBy(i * (e.w * this.options.kx), a * (e.h * this.options.ky))
        }
        return false
    }.bind(this)
};
Wikimapia.Control.Pan.prototype.render = function () {
    Wikimapia.Utils.Dom.addEvent(this.div, "mousemove", function (t) {
        t.stop();
        return false
    });
    var t = ["north", "south", "west", "east"],
        e = this.options.name;
    for (var i = 0; i < 4; i++) {
        var a = t[i],
            o = Wikimapia.Utils.Dom.create("div", {
                id: ["wm", e, a].join("-"),
                events: {
                    click: this.getPanner(this.dirs[a.toUpperCase()])
                },
                style: i < 2 ? this.styles.vertical : this.styles.horizontal,
                title: Wikimapia.Lang.get("all.slidecontrol-" + a),
                l10n: "slidecontrol-" + a
            });
        Wikimapia.Utils.Dom.setStyles(o, {
            top: (i > 1 ? 16 : i ? 0 : 32) + "px",
            left: (i < 2 ? 16 : i == 2 ? 0 : 32) + "px"
        });
        Wikimapia.Utils.Dom.inject(o, this.div, "bottom");
        this["pan" + a.capitalize() + "El"] = o
    }
    Wikimapia.Utils.Dom.addEvent(document, "keydown", this.handlers.keyboard);
    this.map.addEvents({
        windowOpened: this.handlers.disable,
        windowClosed: this.handlers.enable,
        panelOpened: this.handlers.disable,
        panelClosed: this.handlers.enable
    })
};
Wikimapia.Control.Pan.prototype.keyboard = function (t) {
    if (this.map && this._enabled) {
        var e = t.keyCode,
            i = e === Wikimapia.Utils.Event.keyCodes.LEFT ? 1 : e === Wikimapia.Utils.Event.keyCodes.RIGHT ? -1 : 0,
            a = e === Wikimapia.Utils.Event.keyCodes.UP ? 1 : e === Wikimapia.Utils.Event.keyCodes.DOWN ? -1 : 0,
            o;
        if (i || a) {
            t.stop();
            o = this.map.getSize();
            this.map.panBy(Math.round(i * (o.w * this.options.kx)), Math.round(a * (o.h * this.options.ky)));
            return false
        }
    }
};
Wikimapia.Control.Pan.prototype.onLanguageChange = function (t) {
    [this.panSouthEl, this.panNorthEl, this.panEastEl, this.panWestEl].forEach(function (t) {
        t.setAttribute("title", Wikimapia.Lang.get("all." + t.getAttribute("l10n")))
    })
};
Wikimapia.Control.Pan.prototype.disable = function () {
    Wikimapia.Control.prototype.disable.call(this);
    Wikimapia.Utils.Dom.removeEvent(document, "keydown", this.handlers.keyboard)
};
Wikimapia.Control.Pan.prototype.enable = function () {
    Wikimapia.Control.prototype.enable.call(this);
    Wikimapia.Utils.Dom.addEvent(document, "keydown", this.handlers.keyboard)
};
Wikimapia.Control.Pan.prototype.destroy = function () {
    this.disable();
    this.map.removeEvents({
        windowOpened: this.handlers.disable,
        windowClosed: this.handlers.enable,
        panelOpened: this.handlers.disable,
        panelClosed: this.handlers.enable
    });
    [this.panSouthEl, this.panNorthEl, this.panEastEl, this.panWestEl].forEach(function (t) {
        Wikimapia.Utils.Dom.removeEvents(t);
        Wikimapia.Utils.Dom.destroy(t)
    });
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.Zoom = function (t) {
    Wikimapia.Control.prototype.constructor.call(this, t);
    Wikimapia.Utils.Dom.setStyles(this.div, {
        width: "25px",
        height: "50px",
        overflow: "hidden"
    })
};
Wikimapia.Utils.inherits(Wikimapia.Control.Zoom, Wikimapia.Control);
Wikimapia.Control.Zoom.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "zoom",
    position: {
        top: "16px",
        left: "16px"
    },
    sprite: Wikimapia.Utils.defaultControlsUrl + "zoom-control-sprite.png"
});
Wikimapia.Control.Zoom.prototype.styles = {
    button: "overflow:hidden;height:25px;width:25px;display:block;" + "cursor:pointer;color:#333;text-align:center;float:left;" + "font-size:2px",
    sprite: "display: block; width: 41px; height:69px;position:relative;",
    spriteShift: "-298px"
};
Wikimapia.Control.Zoom.prototype.zoomInButton = null;
Wikimapia.Control.Zoom.prototype.zoomOutButton = null;
Wikimapia.Control.Zoom.prototype.spritePos = {
    mouseover: "-25px",
    mouseout: "0px",
    mousedown: "-50px"
};
Wikimapia.Control.Zoom.prototype.mouseHandler = function (t) {
    var e = this.spritePos,
        i = t === "out" ? this.styles.spriteShift : "0px";
    if (Wikimapia.Utils.AlphaImagesHackNeeded) {
        return function (t) {
            Wikimapia.Utils.Dom.setStyles(this.firstChild, {
                left: e[t.type],
                top: "0px"
            })
        }
    } else {
        return function (t) {
            Wikimapia.Utils.Dom.setStyle(this, "background-position", e[t.type] + " " + i)
        }
    }
};
Wikimapia.Control.Zoom.prototype.render = function () {
    Wikimapia.Control.prototype.render.call(this);
    var t = this.mouseHandler("in"),
        e = this.mouseHandler("out");
    this.zoomInButton = Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + this.options.name + "-zoom-in",
        events: {
            click: this.zoomIn.bind(this),
            mouseover: t,
            mouseout: t,
            mousedown: t
        },
        style: this.styles.button,
        styles: {
            "background-image": "url(" + this.options.sprite + ")",
            "background-position": "0px 0px"
        }
    });
    Wikimapia.Utils.Dom.inject(this.zoomInButton, this.div);
    this.zoomOutButton = Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + this.options.name + "-zoom-out",
        events: {
            click: this.zoomOut.bind(this),
            mouseover: e,
            mouseout: e,
            mousedown: e
        },
        style: this.styles.button,
        styles: {
            "background-image": "url(" + this.options.sprite + ")",
            "background-position": "0px " + this.styles.spriteShift
        }
    });
    Wikimapia.Utils.Dom.inject(this.zoomOutButton, this.div);
    if (Wikimapia.Utils.AlphaHackIsNeeded) {
        Wikimapia.Utils.fixAlphaImageSprite(this.zoomOutButton);
        Wikimaia.Utils.fixAlphaImageSprite(this.zoomInButton)
    }
};
Wikimapia.Control.Zoom.prototype.zoomIn = function (t) {
    t.stop();
    this.map.zoomIn()
};
Wikimapia.Control.Zoom.prototype.zoomOut = function (t) {
    t.stop();
    this.map.zoomOut()
};
Wikimapia.Control.Zoom.prototype.destroy = function () {
    Wikimapia.Utils.Dom.destroy(this.zoomInButton);
    Wikimapia.Utils.Dom.destroy(this.zoomOutButton);
    delete this.zoomInButton;
    delete this.zoomOutButton;
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.ZoomControl = function (t) {
    Wikimapia.Control.prototype.constructor.call(this, t);
    this.initAnimations()
};
Wikimapia.Utils.inherits(Wikimapia.Control.ZoomControl, Wikimapia.Control);
Wikimapia.Control.ZoomControl.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "zoomControl",
    position: {
        top: "40px",
        left: "30px"
    },
    sprite: Wikimapia.Utils.defaultControlsUrl + "zoom-control-sprite.png",
    zoomSteps: {
        house: 17,
        street: 14,
        city: 11,
        country: 6,
        world: 3
    },
    hideDuration: 500
});
Wikimapia.Control.ZoomControl.prototype.styles = {
    button: "overflow: hidden; height: 25px; width: 25px; position: absolute; display: block; cursor: pointer; color: #333; text-align: center; float: left; font-size: 2px",
    sprite: "display: block; width: 1000px; height: 1000px; position: relative;",
    slideBody: "display: block; position: absolute; width: 25px; height: 170px; top: 0px; left: 0px; overflow: hidden; cursor: pointer;",
    slideTrack: "display: block; position: absolute; top: 25px; left: 0px; height: 165px; width: 25px; cursor: pointer;",
    slider: "display: block; position: absolute; width: 25px; height: 9px; cursor: pointer;",
    hintsContainer: "position: absolute; top: 0px; left: 25px; float: left; opacity: 0; filter: alpha(opacity=0);",
    hint: "display: block; position: absolute; float: left; padding: 3px 0 2px 10px; height: 13px; color: #fff; font: bold 11px Helvetica, Arial, sans-serif; cursor: pointer;",
    rhint: "display:block;float:right;margin: -3px -3px 0 0; height:18px; padding-left:3px;"
};
Wikimapia.Control.ZoomControl.prototype.animation = null;
Wikimapia.Control.ZoomControl.prototype.zoomInButton = null;
Wikimapia.Control.ZoomControl.prototype.zoomOutButton = null;
Wikimapia.Control.ZoomControl.prototype.slider = null;
Wikimapia.Control.ZoomControl.prototype.slideBody = null;
Wikimapia.Control.ZoomControl.prototype.slideTrack = null;
Wikimapia.Control.ZoomControl.prototype.hideHintsTimeout = null;
Wikimapia.Control.ZoomControl.prototype.hintsContainer = null;
Wikimapia.Control.ZoomControl.prototype.render = function () {
    Wikimapia.Control.prototype.render.call(this);
    var t = this.calculateSlideTrackHeight(),
        e = Wikimapia.Utils.Dom.create("div", {
            id: "wm-" + this.options.name + "-slider-body",
            style: this.styles.slideBody,
            styles: {
                height: t,
                "background-image": "url(" + this.options.sprite + ")",
                "background-position": "0px 0px"
            }
        });
    this.div.appendChild(e);
    this.createSlideTrack(t);
    this.zoomOutButton = Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + this.options.name + "-zoom-out",
        events: {
            click: function (t) {
                t.stop();
                if (this.map && !this.map.locked) {
                    this.map.zoomOut()
                }
            }.bind(this),
            mouseover: function (t) {
                if (Wikimapia.Utils.AlphaImagesHackNeeded) {
                    Wikimapia.Utils.Dom.setStyle(this.firstChild, "left", "-25px")
                } else {
                    Wikimapia.Utils.Dom.setStyle(this, "background-position", "-25px -298px")
                }
            },
            mouseout: function (t) {
                if (Wikimapia.Utils.AlphaImagesHackNeeded) {
                    Wikimapia.Utils.Dom.setStyle(this.firstChild, "left", "0px")
                } else {
                    Wikimapia.Utils.Dom.setStyle(this, "background-position", "0px -298px")
                }
            }
        },
        style: this.styles.button,
        styles: {
            top: t,
            "background-image": "url(" + this.options.sprite + ")",
            "background-position": "0px -298px"
        }
    });
    this.div.appendChild(this.zoomOutButton);
    this.zoomInButton = Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + this.options.name + "-zoom-in",
        events: {
            click: function (t) {
                t && t.stop();
                if (this.map && !this.map.locked) {
                    this.map.zoomIn()
                }
            }.bind(this),
            mouseover: function (t) {
                if (Wikimapia.Utils.AlphaImagesHackNeeded) {
                    Wikimapia.Utils.Dom.setStyles(this.firstChild, {
                        left: "-25px",
                        top: "-25px"
                    })
                } else {
                    Wikimapia.Utils.Dom.setStyle(this, "background-position", "-25px -25px")
                }
            },
            mouseout: function (t) {
                if (Wikimapia.Utils.AlphaImagesHackNeeded) {
                    Wikimapia.Utils.Dom.setStyles(this.firstChild, {
                        left: "-25px",
                        top: "-50px"
                    })
                } else {
                    Wikimapia.Utils.Dom.setStyle(this, "background-position", "-25px -50px")
                }
            }
        },
        style: this.styles.button,
        styles: {
            top: 0,
            left: 0,
            "background-image": "url(" + this.options.sprite + ")",
            "background-position": "-25px -50px"
        }
    });
    this.div.appendChild(this.zoomInButton);
    if (Wikimapia.Utils.AlphaHackIsNeeded) {
        Wikimapia.Utils.fixAlphaImageSprite(e);
        Wikimapia.Utils.fixAlphaImageSprite(this.zoomOutButton);
        Wikimapia.Utils.fixAlphaImageSprite(this.zoomInButton)
    }
    this.createSlider();
    this.createHints();
    Wikimapia.Lang.addEvent("langChanged", this.onLanguageChange.bind(this))
}, Wikimapia.Control.ZoomControl.prototype.adjustByZoomLimits = function () {
    var t = this.calculateSlideTrackHeight(),
        e;
    Wikimapia.Utils.Dom.setStyle(Wikimapia.Utils.Dom.getElement(this.div, "#wm-" + this.options.name + "-slider-body"), "height", t);
    Wikimapia.Utils.Dom.setStyle(this.slideTrack, "height", t - 25);
    Wikimapia.Utils.Dom.setStyle(this.zoomOutButton, "top", t);
    for (var i in this.options.zoomSteps) {
        e = this.options.zoomSteps[i];
        Wikimapia.Utils.Dom.setStyles(document.getElementById("wm-" + this.options.name + "zoom-step-" + i), {
            top: this.hintPos(e),
            visibility: e <= this.map.options.maxZoomLevel ? "visible" : "hidden"
        })
    }
    Wikimapia.Utils.Dom.setStyle(this.slider, "top", this.sliderPos(this.map.getZoom()));
    Wikimapia.Utils.Dom.setStyle(this.div, "height", t + 35)
}, Wikimapia.Control.ZoomControl.prototype.initAnimations = function () {
    if (Wikimapia.Utils.alphaImageHackNeeded) {
        this.styles.hintsContainer += "display:none;"
    }
    this.hintFader = (Wikimapia.Utils.alphaImageHackNeeded ? function () {
        Wikimapia.Utils.Dom.setStyle(this.hintsContainer, "display", "none")
    } : function () {
        if (this.animation) this.animation.stop();
        this.animation = Wikimapia.Utils.Dom.animate(this.hintsContainer, {
            duration: this.options.hideDuration,
            opacity: 0,
            complete: function () {
                Wikimapia.Utils.Dom.setStyle(this.hintsContainer, "display", "none")
            }.bind(this)
        })
    })
        .bind(this);
    this.hintShower = (Wikimapia.Utils.alphaImageHackNeeded ? function () {
        Wikimapia.Utils.Dom.setStyle(this.hintsContainer, "display", "block")
    } : function () {
        if (this.animation) this.animation.stop();
        Wikimapia.Utils.Dom.setStyle(this.hintsContainer, "display", "block");
        this.animation = Wikimapia.Utils.Dom.animate(this.hintsContainer, {
            duration: this.options.hideDuration,
            opacity: 100
        })
    })
        .bind(this)
}, Wikimapia.Control.ZoomControl.prototype.hideHints = function () {
    clearTimeout(this.hideHintsTimeout);
    this.hideHintsTimeout = setTimeout(this.hintFader, 500)
}, Wikimapia.Control.ZoomControl.prototype.showHints = function () {
    if (this.map.locked) return;
    clearTimeout(this.hideHintsTimeout);
    this.hintShower()
}, Wikimapia.Control.ZoomControl.prototype.createHints = function () {
    var t, e, i, a, o = this,
        n = this.map;
    this.hintsContainer = Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + this.options.name + "-hints-container",
        style: this.styles.hintsContainer
    });
    this.div.appendChild(this.hintsContainer);
    Wikimapia.Utils.Dom.addEvents(this.div, {
        mouseenter: this.showHints.bind(this),
        mouseover: this.showHints.bind(this),
        mouseleave: this.hideHints.bind(this)
    });
    i = {
        click: function (t) {
            if (this.level !== o.map.getZoom()) {
                Wikimapia.Utils.Dom.setStyle(o.slider, "top", o.sliderPos(this.level));
                o.map.setZoom(this.level)
            }
            return false
        },
        mouseover: function () {
            clearTimeout(o.hideHintsTimeout);
            Wikimapia.Utils.Dom.setStyle(this, "color", "#f00");
            return false
        },
        mouseout: function (t) {
            o.hideHints();
            Wikimapia.Utils.Dom.setStyle(this, "color", "#fff");
            return false
        }
    };
    a = this.styles.rhint + "background:url(" + this.options.sprite + ") no-repeat -87px -333px";
    for (var s in this.options.zoomSteps) {
        var r = this.options.zoomSteps[s],
            p = Wikimapia.Lang.get("all.zoomcontrol-" + s);
        e = Wikimapia.Utils.Dom.create("div", {
            id: "wm-" + this.options.name + "zoom-step-" + s,
            "class": "zoomcontrol-hint",
            style: this.styles.hint,
            styles: {
                "background-image": "url(" + this.options.sprite + ")",
                "background-position": "0px -333px",
                top: this.hintPos(r),
                width: Wikimapia.Utils.measureText(p, 11, null, "bold") + 3 + "px"
            },
            html: '<span l10n="zoomcontrol-' + s + '">' + p + '</span><span style="' + a + '"></span>'
        });
        this.hintsContainer.appendChild(e);
        e.level = r;
        Wikimapia.Utils.Dom.addEvents(e, i)
    }
};
Wikimapia.Control.ZoomControl.prototype.createSlideTrack = function (t) {
    this.slideTrack = Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + this.options.name + "-slide-track",
        style: this.styles.slideTrack,
        styles: {
            height: t - 25
        },
        html: "&nbsp;",
        events: {
            click: this.onSlideTrackClick.bind(this)
        }
    });
    this.div.appendChild(this.slideTrack)
};
Wikimapia.Control.ZoomControl.prototype.onSlideTrackClick = function (t) {
    var e = this.map;
    if (!e.locked) {
        var i = $(t.target),
            a = e.options.minZoomLevel,
            o = e.options.maxZoomLevel,
            n = t.clientY - i.getPosition()
            .y,
            s = i.getSize()
            .y / (o + 1 - a),
            r = Wikimapia.Utils.Math.normalize(Math.round(o - 1 - (n - n % s) / s), a, o);
        Wikimapia.Utils.Dom.setStyle(this.slider, "top", this.sliderPos(r));
        e.setZoom(r)
    }
};
Wikimapia.Control.ZoomControl.prototype.calculateSlideTrackHeight = function () {
    var t = this.map.options;
    return 25 + (t.maxZoomLevel + 1 - t.minZoomLevel) * 9 - 3
};
Wikimapia.Control.ZoomControl.prototype.sliderPos = function (t) {
    var e = this.map.options,
        i = e.maxZoomLevel + 1 - e.minZoomLevel,
        a = i * 9;
    return 46 + a - t * (a / i) - 5 + "px"
};
Wikimapia.Control.ZoomControl.prototype.hintPos = function (t) {
    var e = this.map.options,
        i = e.maxZoomLevel + 1 - e.minZoomLevel,
        a = i * 9;
    return 47 + a - t * (a / i) - 10 + "px"
};
Wikimapia.Control.ZoomControl.prototype.sliderPosToLevel = function (t) {
    var e = Wikimapia.Utils.Dom.getPosition(this.slideTrack)
        .y,
        i = this.map.options,
        a = Wikimapia.Utils.Dom.getSize(this.slideTrack)
        .y,
        o = a / (i.maxZoomLevel + 1),
        n;
    t -= 25;
    return Wikimapia.Utils.Math.normalize(Math.round(i.maxZoomLevel - (t - t % o) / o), i.minZoomLevel, i.maxZoomLevel)
};
Wikimapia.Control.ZoomControl.prototype.createSlider = function () {
    var t = this;
    this.slider = Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + this.options.name + "-slider",
        style: this.styles.slider,
        styles: {
            "background-image": "url(" + this.options.sprite + ")",
            "background-position": "0px -324px",
            cursor: "-moz-grab",
            top: this.sliderPos(this.map.getZoom())
        },
        events: {
            mousedown: function (e) {
                if (!t.map.locked) {
                    Wikimapia.Utils.Dom.setStyle(this, "cursor", "-moz-grabbing");
                    this.dragHandler = t.sliderDragHandler.bind(t);
                    var i = $(this);
                    this.dragStopHandler = function () {
                        i.fireEvent("mouseup")
                    };
                    Wikimapia.Utils.Dom.addEvents(document, {
                        mousemove: this.dragHandler,
                        mouseup: this.dragStopHandler
                    })
                }
                return false
            },
            mouseup: function (e) {
                Wikimapia.Utils.Dom.setStyle(this, "cursor", "-moz-grab");
                Wikimapia.Utils.Dom.removeEvents(document, {
                    mousemove: this.dragHandler,
                    mouseup: this.dragStopHandler
                });
                var i = parseInt(t.slider.style.top) + 5,
                    a;
                a = t.sliderPosToLevel(i);
                Wikimapia.Utils.Dom.setStyle(t.slider, "top", t.sliderPos(a));
                t.setZoom(a)
            }
        }
    });
    this.div.appendChild(this.slider);
    if (Wikimapia.Utils.AlphaHackIsNeeded) {
        Wikimapia.Utils.fixAlphaImageSprite(this.slider)
    }
};
Wikimapia.Control.ZoomControl.prototype.sliderDragHandler = function (t) {
    var e = t.clientY,
        i = Wikimapia.Utils.Dom.getPosition(this.slideTrack)
        .y;
    if (e > i && e < i + Wikimapia.Utils.Dom.getSize(this.slideTrack)
        .y - 10) {
        Wikimapia.Utils.Dom.setStyle(this.slider, "top", e - i + 25 + "px")
    }
    return false
};
Wikimapia.Control.ZoomControl.prototype.setZoom = function (t) {
    if (!this.map.locked) {
        this.map.setZoom(t)
    }
};
Wikimapia.Control.ZoomControl.prototype.setMap = function (t) {
    Wikimapia.Control.prototype.setMap.call(this, t);
    this.handlers.zoomChanged = function () {
        Wikimapia.Utils.Dom.setStyle(this.slider, "top", this.sliderPos(this.map.getZoom()))
    }.bind(this);
    this.handlers.zoomLimitsChanged = this.adjustByZoomLimits.bind(this);
    this.map.addEvents({
        zoomChanged: this.handlers.zoomChanged,
        zoomLimitsChanged: this.handlers.zoomLimitsChanged
    });
    this.adjustByZoomLimits()
};
Wikimapia.Control.ZoomControl.prototype.onLanguageChange = function (t) {
    Wikimapia.Lang.localize(this.hintsContainer, "all");
    for (var e in this.options.zoomSteps) {
        var i = document.getElementById("wm-" + this.options.name + "zoom-step-" + e),
            a = i.innerHTML;
        Wikimapia.Utils.Dom.setStyle(i, "width", Wikimapia.Utils.measureText(a, 11, null, "bold") + 3 + "px")
    }
};
Wikimapia.Control.ZoomControl.prototype.destroy = function () {
    this.map.removeEvents({
        zoomChanged: this.handlers.zoomChanged,
        zoomLimitsChanged: this.handlers.zoomLimitsChanged
    });
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.URLHash = function (t) {
    this.map = t.map;
    delete t.map;
    Wikimapia.Utils.extend(this.options, t);
    Wikimapia.Utils.bindHandlers(this, "observe", "onPopState", "updateHash");
    Wikimapia.History.addEvents({
        popstate: this.handlers.onPopState,
        hashchange: this.handlers.observe
    });
    this.state = {};
    this.updateHash(t)
};
Wikimapia.Utils.inherits(Wikimapia.Control.URLHash, Wikimapia.Control);
Wikimapia.Control.URLHash.prefix = "#";
Wikimapia.Control.URLHash.parseHash = function (t, e) {
    t = (t || Wikimapia.Control.URLHash.getHash())
        .replace("#", "")
        .split("show=");
    var i = null,
        a, o;
    if (t) {
        var i = {},
            a = t[1],
            o = {
                lang: /l$|l(a)?ng/,
                lat: /lat/,
                lon: /lon/,
                z: /^z(oom)?/,
                base: /^m(ap)?/,
                view: /^v$/,
                o: /^o$/,
                gz: /^gz/,
                tag: /^tag/,
                search: /^search/,
                stgr: /^st(atus)?gr(id)?/,
                o: /^o$/
            };
        if (e) {
            o.id = /^id$/;
            o.x = /^x$/;
            o.y = /^y$/;
            o.poly = /permpoly/;
            o.road = /permroad/;
            o.action = /^action/
        }
        t = t[0].split(/[\&=\/]/);
        for (var n = 0, s = t.length; n < s; n += 2) {
            var r = t[n],
                p = t[n + 1];
            if (typeof p !== "undefined") {
                for (var l in o) {
                    if (o[l].test(r)) {
                        i[l] = p;
                        break
                    }
                }
            }
        }
        if (!isNaN(i.language)) {
            i.language = Wikimapia.Lang.codeToLng(parseInt(i.language))
        }
        if (i.z) {
            i.z = i.zoom = parseInt(i.z, 10)
        }
        if (a) {
            if (/&search/.test(a)) {
                a = a.split("&search=");
                i.search = a[1];
                a = a[0]
            }
            i.show = a
        } else {
            i.show = ""
        }
        if (e) {
            if (i.x && i.y) {
                i.lon = parseFloat(i.x) / (i.x.indexOf(".") === -1 ? 1e6 : 1);
                i.lat = parseFloat(i.y) / (i.y.indexOf(".") === -1 ? 1e6 : 1);
                delete i.x;
                delete i.y
            }
            if (i.id) {
                i.show = "/" + i.id + "/";
                delete i.id
            }
            if (!isNaN(i.lat) && !isNaN(i.lon)) {
                i.lon = Wikimapia.Utils.Math.normalize(i.lon, -180, 180);
                i.lat = Wikimapia.Utils.Math.normalize(i.lat, -Wikimapia.Utils.MaxMercatorLat, Wikimapia.Utils.MaxMercatorLat)
            } else {
                delete i.lat;
                delete i.lon
            }
        }
    }
    return i
};
Wikimapia.Control.URLHash.getHash = function () {
    return window.location.href.split("#")[1] || ""
};
Wikimapia.Control.URLHash.excludeUrlsRE = /(user\/(denied|chooselanguage|logout))|before_(un)?delete|revert|(user\/update)/;
Wikimapia.Control.URLHash.prototype.options = {
    lng: null,
    name: "URLObserver",
    view: false
};
Wikimapia.Control.URLHash.prototype.delim = "&";
Wikimapia.Control.URLHash.prototype.map = null;
Wikimapia.Control.URLHash.prototype.omitNext = false;
Wikimapia.Control.URLHash.prototype.avoidHistoryChange = false;
Wikimapia.Control.URLHash.prototype.listen = function (t, e) {
    if (typeof t == "string") {
        e.addEvent(t, this.handlers.updateHash)
    } else {
        var i = t;
        for (var a in i) {
            i[a].addEvent(a, this.handlers.updateHash)
        }
    }
};
Wikimapia.Control.URLHash.prototype.getSupportedOptions = function () {
    var t = this.map,
        e = t.options,
        i = e.center;
    var a = {
        lang: Wikimapia.Lang.getCurrentLanguage(),
        lat: i.lat.toFixed(6),
        lon: i.lng.toFixed(6),
        z: e.zoom,
        m: e.base || "",
        v: e.view || "",
        tag: t.selectedTagId || "",
        permpoly: e.poly || "",
        permroad: e.road || "",
        stgr: t.statusGrid || "",
        gz: e.route || "",
        show: this.getShowValue(),
        search: t.searchString || ""
    };
    if (a.show && Wikimapia.Control.URLHash.excludeUrlsRE.test(a.show)) {
        a.show = this.opts.show
    }
    this.avoidHistoryChange = this.opts && this.opts.show === a.show;
    return a
};
Wikimapia.Control.URLHash.prototype.getShowValue = function () {
    var t = this.map;
    return (t.windowObject ? t.windowObject.getUrl() : t.revisionUrl || t.panelUrl || "")
        .replace(Wikimapia.Utils.photoServerURL, "")
};
Wikimapia.Control.URLHash.prototype.updateHash = function (t, e) {
    this.opts = this.getSupportedOptions();
    if (t) {
        for (var i in t) {
            if (i in this.opts && typeof t[i] !== "function") {
                this.opts[i] = t[i]
            }
        }
    }
    if (e !== undefined) {
        this.avoidHistoryChange = !e
    }
    this.omitNext = true;
    var a = this.getMask(this.opts)
        .substitute(this.opts),
        o = this.getState();
    if (a.charAt(0) !== Wikimapia.Control.URLHash.prefix) {
        a = Wikimapia.Control.URLHash.prefix + a
    }
    if (this.avoidHistoryChange) {
        Wikimapia.History.replaceState(o, document.title, a)
    } else {
        Wikimapia.History.pushState(o, document.title, a)
    }
};
Wikimapia.Control.URLHash.prototype.getState = function () {
    this.state.popup = map.windowObject ? map.windowObject.getUrl() : undefined;
    this.state.panel = this.map.panelUrl;
    this.state.search = this.map.searchString;
    return this.opts
};
Wikimapia.Control.URLHash.prototype.getMask = function (t) {
    var e = "";
    if (t["show"] == "") { } else { }
    for (var i in t) {
        if (t[i] !== "") {
            e += i + "={" + i + "}" + this.delim
        }
    }
    return e.substring(0, e.length - 1)
};
Wikimapia.Control.URLHash.prototype.observe = function () {
    if (!this.omitNext) this.parse(Wikimapia.Control.URLHash.getHash());
    this.omitNext = false
};
Wikimapia.Control.URLHash.prototype.onPopState = function (t) {
    this.parse(Wikimapia.Control.URLHash.getHash());
    if (t.state && t.state.show) {
        this.fireEvent("contentChanged", t.state.show)
    }
    this.omitNext = false
};
Wikimapia.Control.URLHash.prototype.parse = function (t) {
    t = t.replace("#", "");
    var e = Wikimapia.Control.URLHash.parseHash(t);
    if (e) {
        for (var i in e) {
            var a = e[i];
            if (i in this.opts && this.opts[i] != a) {
                this.opts[i] = a;
                this.fireChangeEvent(i, a)
            }
        }
    }
};
Wikimapia.Control.URLHash.prototype.fireChangeEvent = function (t, e) {
    switch (t) {
        case "show":
            this.fireEvent("contentChanged", e);
            break;
        case "z":
            this.fireEvent("zoomChanged", this.opts[t]);
            break;
        case "lang":
            this.fireEvent("langChanged", this.opts[t]);
            break;
        case "lat":
        case "lon":
            this.fireEvent("centerChanged", new Wikimapia.LatLng(this.opts.lat, this.opts.lon));
            break;
        default:
            this.fireEvent(t + "Changed", this.opts[t]);
            break
    }
};
Wikimapia.Control.URLHash.prototype.destroy = function () {
    Wikimapia.Utils.Dom.removeEvents(Wikimapia.History, {
        popstate: this.handlers.onPopState,
        hashchange: this.handlers.observe
    })
};
Wikimapia.Renderer = function (t) {
    if (t) {
        this.map = t.map;
        delete t.map;
        this.options = Wikimapia.Utils.extend({}, this.options, t)
    }
};
Wikimapia.Renderer.prototype = {
    constructor: Wikimapia.Renderer,
    options: {
        map: null
    },
    offset: new Wikimapia.Point(0, 0),
    makeRoot: function (t, e) { },
    draw: function (t, e) {
        var i = {
            line: "drawLine",
            polyline: "drawPolyline",
            polygon: "drawPolygon",
            point: "drawPoint"
        }[t.typeName];
        return this[i](t, e)
    },
    drawLine: function (t, e) { },
    drawPoint: function (t, e) { },
    drawPolygon: function (t, e) { },
    redraw: function (t, e, i) { },
    getShortString: function (t, e) {
        if (!t.coordString || e) {
            var i = this.offset,
                a = this.map.fromLatLngToContainerPixel(t)
                .subtract(i.x, i.y);
            t.coordString = a.x + "," + a.y
        }
        return t.coordString
    },
    getVertexRenderedCoords: function (t, e, i) {
        var a = null;
        if (t.points && t.points.length > e) {
            e = this.getShortString(t.points[e])
                .split(",");
            a = new Wikimapia.Point(parseFloat(e[0]), parseFloat(e[1]));
            if (i) {
                a.x += this.offset.x;
                a.y += this.offset.y
            }
        }
        return a
    },
    setClass: function (t, e) {
        t.className = e
    },
    getClass: function (t) {
        return t.className
    }
};
Wikimapia.Renderer.SVG = function (t) {
    Wikimapia.Renderer.prototype.constructor.call(this, t);
    if (Wikimapia.Renderer.SVG.isSupported()) {
        return this
    } else {
        return null
    }
};
Wikimapia.Utils.inherits(Wikimapia.Renderer.SVG, Wikimapia.Renderer);
Wikimapia.Renderer.SVG.prototype.xmlns = "http://www.w3.org/2000/svg";
Wikimapia.Renderer.SVG.prototype.xlinkns = "http://www.w3.org/1999/xlink";
Wikimapia.Renderer.SVG.prototype.createNode = function (t, e) {
    var i = document.createElementNS(this.xmlns, t);
    if (e) {
        i.id = e
    }
    return i
};
Wikimapia.Renderer.SVG.prototype.createRoot = function (t) {
    var e = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    e.setAttributeNS(null, "version", "1.1");
    e.setAttributeNS(null, "baseProfile", "full");
    return e
};
Wikimapia.Renderer.SVG.prototype.drawPolygon = function (t) {
    return this.setPath(this.createNode("path", Wikimapia.Utils.uniqueId(t.typeName), t.getBounds()), t, true)
};
Wikimapia.Renderer.SVG.prototype.drawPolyline = function (t) {
    return this.setPath(this.createNode("path", Wikimapia.Utils.uniqueId(t.typeName), t.getBounds()), t, false)
};
Wikimapia.Renderer.SVG.prototype.drawLine = function (t) {
    return this.setPath(this.createNode("path", Wikimapia.Utils.uniqueId(t.typeName), t.getBounds()), t, false)
};
Wikimapia.Renderer.SVG.prototype.setStyle = function (t, e) {
    if (e.isFilled) {
        "fillColor" in e && t.setAttributeNS(null, "fill", e.fillColor);
        "fillOpacity" in e && t.setAttributeNS(null, "fill-opacity", e.fillOpacity)
    } else {
        t.setAttributeNS(null, "fill", "none")
    }
    if (e.isStroked) {
        if ("strokeColor" in e) t.setAttributeNS(null, "stroke", e.strokeColor);
        if ("strokeOpacity" in e) t.setAttributeNS(null, "stroke-opacity", e.strokeOpacity);
        if ("strokeWidth" in e) t.setAttributeNS(null, "stroke-width", e.strokeWidth);
        if ("strokeLinecap" in e) t.setAttributeNS(null, "stroke-linecap", e.strokeLinecap);
        t.setAttributeNS(null, "stroke-linejoin", "round")
    } else {
        t.setAttributeNS(null, "stroke", "none")
    }
    if (e.cursor) t.setAttributeNS(null, "cursor", e.cursor);
    if (e.pointerEvents) t.setAttributeNS(null, "pointer-events", e.pointerEvents);
    if (e.zIndex) t.style.zIndex = e.zIndex;
    return t
};
Wikimapia.Renderer.SVG.prototype.setFill = function (t, e) {
    t.setAttributeNS(null, "fill", e);
    return t
};
Wikimapia.Renderer.SVG.prototype.setStroke = function (t, e) {
    t.setAttributeNS(null, "stroke", e);
    return t
};
Wikimapia.Renderer.SVG.prototype.redraw = function (t, e) {
    var i = t.nextSibling,
        a = t.parentNode;
    if (e) {
        switch (e.typeName) {
            case "polygon":
                this.setPath(t, e, true);
                break;
            case "polyline":
                this.setPath(t, e, false);
                break;
            case "point":
                break;
            case "line":
                break;
            default:
                break
        }
    }
    return t
};
Wikimapia.Renderer.SVG.prototype.setRootBounds = function (t, e) {
    var i = this.map.fromLatLngToContainerPixel(new Wikimapia.LatLng(e.top, e.left))
        .subtract(this.offset.x, this.offset.y),
        a = this.map.fromLatLngToContainerPixel(new Wikimapia.LatLng(e.bottom, e.right))
        .subtract(this.offset.x, this.offset.y),
        o = new Wikimapia.Size(Math.abs(a.x - i.x), Math.abs(a.y - i.y)),
        n = t.style;
    n.position = "absolute";
    n.left = i.x + "px";
    n.top = i.y + "px";
    t.setAttributeNS(null, "width", o.w);
    t.setAttributeNS(null, "height", o.h);
    t.setAttributeNS(null, "viewBox", [i.x, i.y, o.w, o.h].join(" "));
    return t
};
Wikimapia.Renderer.SVG.prototype.setPath = function (t, e, i) {
    var a = "M " + this.getShortString(e.points[0]) + " L";
    for (var o = 1, n = e.points.length; o < n; o++) {
        a += " " + this.getShortString(e.points[o])
    }
    if (i) {
        a += " Z"
    }
    t.setAttributeNS(null, "d", a);
    return t
};
Wikimapia.Renderer.SVG.prototype.setClass = function (t, e) {
    t.setAttributeNS(null, "class", e)
};
Wikimapia.Renderer.SVG.prototype.getClass = function (t) {
    return t.getAttributeNS(null, "class")
};
Wikimapia.Renderer.SVG.isSupported = function () {
    var t = "http://www.w3.org/TR/SVG11/feature#";
    return document.implementation && (document.implementation.hasFeature("org.w3c.svg", "1.0") || document.implementation.hasFeature(t + "SVG", "1.1") || document.implementation.hasFeature(t + "BasicStructure", "1.1"))
};
if (Wikimapia.Renderer.SVG.isSupported()) {
    SVGElement.prototype.hasClass = function (t) {
        return new RegExp("(\\s|^)" + t + "(\\s|$)")
            .test(this.getAttributeNS(null, "class"))
    };
    SVGElement.prototype.addClass = function (t) {
        if (!this.hasClass(t)) {
            this.setAttributeNS(null, "class", this.getAttributeNS(null, "class") + " " + t)
        }
    };
    SVGElement.prototype.removeClass = function (t) {
        var e = this.getAttribute("class")
            .replace(new RegExp("(\\s|^)" + t + "(\\s|$)", "g"), "$2");
        if (this.hasClass(t)) {
            this.setAttributeNS(null, "class", e)
        }
    }
}
Wikimapia.Renderer.VML = function (t) {
    Wikimapia.Renderer.prototype.constructor.call(this, t);
    if (this.supported()) {
        if (!document.namespaces.wmv) {
            document.namespaces.add("wmv", this.xmlns);
            var e = document.createStyleSheet(),
                i = ["shape", "rect", "oval", "fill", "stroke", "imagedata", "group", "textbox"];
            for (var a = 0, o = i.length; a < o; a++) {
                e.addRule("wmv\\:" + i[a], "behavior: url(#default#VML); " + "position: absolute; display: block;")
            }
        }
        return this
    } else {
        return null
    }
};
Wikimapia.Utils.inherits(Wikimapia.Renderer.VML, Wikimapia.Renderer);
Wikimapia.Renderer.VML.prototype.xmlns = "urn:schemas-microsoft-com:vml";
Wikimapia.Renderer.VML.prototype.supported = function () {
    return !!document.namespaces
};
Wikimapia.Renderer.VML.prototype.createNode = function (t, e) {
    var i = document.createElement("wmv:" + t);
    if (e) {
        i.setAttribute("id", e)
    }
    i.unselectable = "on";
    i.onselectstart = Wikimapia.Utils.False;
    return i
};
Wikimapia.Renderer.VML.prototype.drawPolygon = function (t) {
    var e = this.createNode("shape", Wikimapia.Utils.uniqueId(t.typeName));
    this.setCoordSystem(e, t.getBounds());
    this.setPath(e, t, true);
    return e
};
Wikimapia.Renderer.VML.prototype.drawPolyline = function (t) {
    var e = this.createNode("shape", Wikimapia.Utils.uniqueId(t.typeName));
    this.setCoordSystem(e, t.getBounds());
    this.setPath(e, t, false);
    return e
};
Wikimapia.Renderer.VML.prototype.pointToShortString = function (t) {
    return t.x + "," + t.y
};
Wikimapia.Renderer.VML.prototype.setStyle = function (t, e) {
    var i = t.getElementsByTagName("fill"),
        a = i.length == 0 ? null : i[0];
    if (e.isFilled) {
        if ("fillColor" in e) {
            t.fillcolor = e.fillColor
        }
        if (!a) {
            a = document.createElement("wmv:fill", t.id + "-fill");
            t.appendChild(a)
        }
        if ("fillOpacity" in e) {
            a.opacity = e.fillOpacity
        }
        a.type = "frame"
    } else {
        t.filled = false;
        if (a) {
            t.removeChild(a)
        }
    }
    var o = t.getElementsByTagName("stroke"),
        n = o.length === 0 ? null : o[0];
    if (e.isStroked) {
        if (!n) {
            n = document.createElement("wmv:stroke", t.id + "-stroke");
            t.appendChild(n)
        }
        if ("strokeOpacity" in e) {
            n.opacity = e.strokeOpacity
        }
        if ("strokeWidth" in e) {
            t.strokeweight = e.strokeWidth + "px";
            n.weight = e.strokeWidth + "px"
        }
        if ("strokeLineCap" in e) {
            n.endcap = !e.strokeLinecap || e.strokeLinecap == "butt" ? "flat" : e.strokeLinecap
        }
        if ("strokeColor" in e) {
            t.strokecolor = e.strokeColor;
            n.color = e.strokeColor
        }
    } else {
        t.stroked = false;
        if (n) {
            t.removeChild(n)
        }
    }
    if (e.cursor != "inherit" && e.cursor != null) {
        t.style.cursor = e.cursor
    }
    if (e.zIndex) {
        t.style.zIndex = e.zIndex
    }
    return t
};
Wikimapia.Renderer.VML.prototype.setFill = function (t, e) {
    return this.setStyle(t, {
        fillColor: e
    })
};
Wikimapia.Renderer.VML.prototype.setStroke = function (t, e) {
    return this.setStyle(t, {
        strokeColor: e
    })
};
Wikimapia.Renderer.VML.prototype.redraw = function (t, e) {
    if (e) {
        switch (e.typeName) {
            case "polygon":
                this.setPath(t, e, true);
                break;
            case "polyline":
                this.setPath(t, e, false);
                break;
            case "point":
            case "line":
            default:
                break
        }
    }
    this.setCoordSystem(t, e.getBounds());
    return t
};
Wikimapia.Renderer.VML.prototype.setCoordSystem = function (t, e) {
    var i = this.map,
        a = this.offset.x,
        o = this.offset.y,
        n = i.fromLatLngToContainerPixel(new Wikimapia.LatLng(e.top, e.left))
        .subtract(a, o),
        s = i.fromLatLngToContainerPixel(new Wikimapia.LatLng(e.bottom, e.right))
        .subtract(a, o),
        r = Math.abs(s.x - n.x),
        p = Math.abs(s.y - n.y);
    t.coordsize = "1,1";
    t.coordorigin = n.x + ", " + n.y;
    t.coordsize = r + ", " + p;
    Wikimapia.Utils.Dom.setStyles(t, {
        width: r + "px",
        height: p + "px",
        position: "absolute",
        top: n.y + "px",
        left: n.x + "px"
    });
    return t
};
Wikimapia.Renderer.VML.prototype.getShortString = function (t, e) {
    if (!t.coordString || e) {
        var i = this.offset,
            a = this.map.fromLatLngToContainerPixel(t)
            .subtract(i.x, i.y);
        t.coordString = Math.round(a.x) + "," + Math.round(a.y)
    }
    return t.coordString
};
Wikimapia.Renderer.VML.prototype.setPath = function (t, e, i) {
    var a = "";
    a += "m " + this.getShortString(e.points[0]) + " l";
    for (var o = 1, n = e.points.length; o < n; o++) {
        a += " " + this.getShortString(e.points[o])
    }
    if (i) {
        a += " x"
    }
    a += " e";
    t.path = a;
    return t
};
Wikimapia.Feature = function (t) {
    var e = t.map;
    delete t.map;
    this.options = Wikimapia.Utils.extend({}, this.options, t);
    this.addEventsFromOptions(this.options);
    this.setDelegate()
};
Wikimapia.Utils.inherits(Wikimapia.Feature, Wikimapia.EventTarget);
Wikimapia.Feature.doubleClickDelay = 200;
Wikimapia.Feature.prototype.options = {};
Wikimapia.Feature.prototype.map = null;
Wikimapia.Feature.prototype.layer = null;
Wikimapia.Feature.prototype.element = null;
Wikimapia.Feature.prototype.setDelegate = function () {
    this.eventHandler = this.eventHandler.bind(this);
    this.clickHandler = this.clickHandler.bind(this)
};
Wikimapia.Feature.prototype.eventHandler = function (t) {
    t.stopPropagation();
    t.feature = this;
    this.fireEvent(t.type, t)
};
Wikimapia.Feature.prototype.clickHandler = function (t) {
    t.feature = this;
    clearTimeout(this.__clickDelay);
    if (this._omitClick || this.map && this.map.locked) {
        delete this._omitClick;
        t.stop();
        return false
    } else {
        if (this.__clicked) {
            delete this.__clickDelay;
            delete this.__clicked
        } else {
            this.__clicked = true;
            t.stopPropagation();
            this.__clickDelay = setTimeout(function () {
                delete this.__clicked;
                this.fireEvent(t.type, t)
            }.bind(this), Wikimapia.Feature.doubleClickDelay)
        }
    }
};
Wikimapia.Feature.prototype.addEvent = function (t, e) {
    if (this.element) {
        var i = this._events || {};
        if (!(t in i)) {
            Wikimapia.Utils.Dom.addEvent(this.element, t, t === "click" ? this.clickHandler : this.eventHandler)
        }
    }
    Wikimapia.EventTarget.prototype.addEvent.call(this, t, e);
    return this
};
Wikimapia.Feature.prototype.removeEvent = function (t, e) {
    Wikimapia.EventTarget.prototype.removeEvent.call(this, t, e);
    if (this.element && !(t in this._events)) {
        Wikimapia.Utils.Dom.removeEvents(this.element, t)
    }
    return this
};
Wikimapia.Feature.prototype.getElement = function (t) {
    return t ? this.element : $(this.element)
};
Wikimapia.Feature.prototype.inject = function (t, e) {
    Wikimapia.Utils.Dom.inject(this.element, t, e);
    return this
};
Wikimapia.Feature.prototype.create = function () { };
Wikimapia.Feature.prototype.draw = function () { };
Wikimapia.Feature.prototype.afterRender = function () {
    var t = this.element;
    Wikimapia.Utils.Dom.removeEvents(this.element);
    if (t) {
        for (var e in this._events) {
            Wikimapia.Utils.Dom.addEvent(t, e, e === "click" ? this.clickHandler : this.eventHandler)
        }
    }
};
Wikimapia.Feature.prototype.destroyDom = function () {
    if (this.element) {
        Wikimapia.Utils.Dom.removeEvents(this.element);
        if (this.element.parentNode) {
            this.element.parentNode.removeChild(this.element)
        }
        this.element = null
    }
};
Wikimapia.Feature.prototype.show = function () {
    if (this.element && this.hidden) {
        this.element.style.display = "";
        this.hidden = null
    }
    return this
};
Wikimapia.Feature.prototype.hide = function () {
    if (this.element && !this.hidden) {
        this.element.style.display = "none";
        this.hidden = true
    }
    return this
};
Wikimapia.Feature.prototype.destroy = function () {
    Wikimapia.EventTarget.prototype.destroy.call(this);
    delete this.map
};
Wikimapia.Feature.prototype.setMap = function (t) {
    this.map = t
};
Wikimapia.Feature.Overlay = function (t) {
    var e = t.map;
    t.id = t.id || Wikimapia.Utils.uniqueId("overlay");
    Wikimapia.Feature.call(this, t);
    if (e) {
        e.overlaysLayer.addFeature(this)
    }
};
Wikimapia.Utils.inherits(Wikimapia.Feature.Overlay, Wikimapia.Feature);
Wikimapia.Feature.Overlay.prototype.draw = function () {
    this.element = Wikimapia.Utils.Dom.create("div", {
        "class": this.getClassString(),
        id: this.options.id,
        html: this.renderContents()
    })
};
Wikimapia.Feature.Overlay.prototype.afterRender = function () {
    Wikimapia.Feature.prototype.afterRender.call(this);
    this.setPosition()
};
Wikimapia.Feature.Overlay.prototype.getSize = function () {
    return new Wikimapia.Size(this.element.offsetWidth, this.element.offsetHeight)
};
Wikimapia.Feature.Overlay.prototype.getClassString = function () {
    var t = "wikimapia-overlay";
    if (this.options.className) {
        t += " " + this.options.className
    }
    return t
};
Wikimapia.Feature.Overlay.prototype.renderContents = function () {
    return this.options.content
};
Wikimapia.Feature.Overlay.prototype.setPosition = function (t) {
    t = t || this.getPosition();
    this.setContainerPosition(t);
    return this
};
Wikimapia.Feature.Overlay.prototype.setContent = function (t) {
    this.options.content = t;
    this.element.innerHTML = this.renderContents();
    return this.setPosition()
};
Wikimapia.Feature.Overlay.prototype.getPosition = function () {
    var t = this.map.dragObject.position,
        e = this.map.fromLatLngToContainerPixel(this.options.coords)
        .add(-t.x, -t.y);
    return e
};
Wikimapia.Feature.Overlay.prototype.setContainerPosition = function (t) {
    Wikimapia.Utils.Dom.setStyles(this.element, {
        top: t.y,
        left: t.x
    })
};
Wikimapia.Feature.Overlay.prototype.setLatLng = function (t) {
    this.options.coords = t;
    this.setPosition()
};
Wikimapia.Feature.Overlay.prototype.setMap = function (t) {
    if (t === null) {
        if (this.map) {
            this.layer.removeFeature(this);
            this.map = null
        }
    } else {
        Wikimapia.Feature.prototype.setMap.call(this, t)
    }
    return this
};
Wikimapia.Feature.Overlay.prototype.getLatLng = function () {
    return this.options.coords.clone()
};
Wikimapia.Feature.Overlay.prototype.setOpacity = function (t) {
    Wikimapia.Utils.Dom.setStyle(this.element, "opacity", t);
    return this
};
Wikimapia.Feature.Overlay.prototype.destroy = function () {
    Wikimapia.Utils.Dom.destroy(this.element);
    this.element = null;
    Wikimapia.Feature.prototype.destroy.call(this)
};
Wikimapia.Feature.Tooltip = function (t) {
    Wikimapia.Feature.Overlay.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Feature.Tooltip, Wikimapia.Feature.Overlay);
Wikimapia.Feature.Tooltip.position = {
    TOP: "top",
    LEFT: "left",
    RIGHT: "right",
    BOTTOM: "bottom",
    CENTER: "center"
};
Wikimapia.Feature.Tooltip.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Feature.Overlay.prototype.options, {
    className: "fade tooltip",
    offset: 0,
    position: Wikimapia.Feature.Tooltip.position.TOP
});
Wikimapia.Feature.Tooltip.prototype.getClassString = function () {
    return Wikimapia.Feature.Overlay.prototype.getClassString.call(this) + " " + this.options.position
};
Wikimapia.Feature.Tooltip.prototype.renderContents = function () {
    return '<div class="tooltip-arrow"></div><div class="tooltip-inner">' + Wikimapia.Feature.Overlay.prototype.renderContents.call(this) + "</div>"
};
Wikimapia.Feature.Tooltip.prototype.setPosition = function (t, e) {
    if (e) {
        this.options.position = e;
        this.element.className = this.getClassString()
    }
    return Wikimapia.Feature.Overlay.prototype.setPosition.call(this, t)
};
Wikimapia.Feature.Tooltip.prototype.setContainerPosition = function (t) {
    var e = this.getSize(),
        i = this.options.offset;
    switch (this.options.position) {
        case Wikimapia.Feature.Tooltip.position.BOTTOM:
            t.x -= e.w / 2 + i;
            break;
        case Wikimapia.Feature.Tooltip.position.RIGHT:
            t.y -= e.h / 2;
            t.x += i;
            break;
        case Wikimapia.Feature.Tooltip.position.LEFT:
            t.y -= e.h / 2;
            t.x -= e.w + i;
            break;
        case Wikimapia.Feature.Tooltip.position.CENTER:
            t.x -= e.w / 2;
            t.y -= e.h / 2;
            break;
        case Wikimapia.Feature.Tooltip.position.TOP:
        default:
            t.x -= e.w / 2;
            t.y -= e.h + i;
            break
    }
    Wikimapia.Feature.Overlay.prototype.setContainerPosition.call(this, t)
};
Wikimapia.Feature.Marker = function (t) {
    var e = t.map;
    delete t.map;
    this.options = Wikimapia.Utils.extend({}, this.options, t);
    this.options.id = Wikimapia.Utils.uniqueId("marker");
    this.addEventsFromOptions(this.options);
    this.setDelegate();
    if (e) e.markersLayer.addMarker(this)
};
Wikimapia.Utils.inherits(Wikimapia.Feature.Marker, Wikimapia.Feature);
Wikimapia.Feature.Marker.prototype.options = {
    icon: null,
    offset: null,
    size: "normal",
    coords: null,
    color: "red",
    draggable: false,
    noEvents: false
};
Wikimapia.Feature.Marker.prototype.draggingApplied = false, Wikimapia.Feature.Marker.prototype.dragStartPoint = null;
Wikimapia.Feature.Marker.prototype.icon = null;
Wikimapia.Feature.Marker.defaultIcon = function (t) {
    var e = Wikimapia.defaultMarkersParams[t.size],
        i = e[t.color],
        a = new Wikimapia.Icon({
            image: Wikimapia.defaultMarkersParams.sprite,
            shadow: Wikimapia.defaultMarkersParams.sprite,
            size: new Wikimapia.Size(e.size[0], e.size[1]),
            shadowSize: new Wikimapia.Size(e.shadowSize[0], e.shadowSize[1]),
            shadowOffset: new Wikimapia.Size(e.offset[0], e.offset[1]),
            imageSpritePos: new Wikimapia.Point(i[0], i[1]),
            shadowSpritePos: new Wikimapia.Point(e.shadow[0], e.shadow[1])
        });
    return a
};
Wikimapia.Feature.Marker.prototype.create = function () {
    this.icon = this.options.icon;
    if (!this.icon) {
        this.icon = Wikimapia.Feature.Marker.defaultIcon(this.options)
    }
    if (!this.options.offset) {
        this.options.offset = new Wikimapia.Size(-this.icon.options.size.w / 2, -this.icon.options.size.h)
    }
    return this
};
Wikimapia.Feature.Marker.prototype.draw = function (t) {
    if (!this.map) this.map = app.map;
    var e = this.map.dragObject.position,
        i = this.options.offset;
    if (this.icon) {
        t = t || this.map.fromLatLngToContainerPixel(this.options.coords);
        t = t.add(i.w - e.x, i.h - e.y);
        this.icon.draw(t);
        if (!this.element) {
            this.element = this.icon.image;
            this.afterRender()
        }
    }
    return this
};
Wikimapia.Feature.Marker.prototype.moveTo = function (t) {
    this.draw(t);
    return this
};
Wikimapia.Feature.Marker.prototype.setLatLng = function (t, e) {
    this.options.coords = t;
    if (e) {
        this.draw()
    }
    return this
};
Wikimapia.Feature.Marker.prototype.setZIndex = function (t) {
    this.options.zIndex = t;
    if (this.isRendered()) {
        this.icon.oldZIndex = this.icon.image.style.zIndex;
        this.icon.image.style.zIndex = t
    }
    return this
};
Wikimapia.Feature.Marker.prototype.setMap = function (t) {
    if (t === null) {
        if (this.map) {
            this.map.markersLayer.removeMarker(this)
        }
    } else {
        Wikimapia.Feature.prototype.setMap.call(this, t)
    }
    return this
};
Wikimapia.Feature.Marker.prototype.getLatLng = function () {
    return this.options.coords.clone()
};
Wikimapia.Feature.Marker.prototype.getPosition = function () {
    var t = this.icon ? this.icon.options.position : this.map.fromLatLngToContainerPixel(this.options.coords);
    return t.subtract(this.options.offset.w, this.options.offset.h)
};
Wikimapia.Feature.Marker.prototype.getContainerPosition = function () {
    var t = this.map.dragObject.position;
    return this.getPosition()
        .add(t.x, t.y)
};
Wikimapia.Feature.Marker.prototype.destroyDom = function () {
    this.icon.destroy();
    delete this.icon;
    delete this.element
};
Wikimapia.Feature.Marker.prototype.destroy = function () {
    this.removeEvents();
    if (this.icon) this.icon.destroy();
    delete this.icon
};
Wikimapia.Feature.Marker.prototype.toElement = function () {
    return this.icon.getElement()
};
Wikimapia.Feature.Marker.prototype.show = function () {
    if (this.icon && this.hidden) {
        this.icon.show();
        this.hidden = null
    }
    return this
};
Wikimapia.Feature.Marker.prototype.hide = function () {
    if (this.icon && !this.hidden) {
        this.icon.hide();
        this.hidden = true
    }
    return this
};
Wikimapia.Feature.Marker.prototype.isRendered = function () {
    return !!this.icon
};
Wikimapia.Feature.Marker.prototype.onScreen = function (t) {
    t = t || this.layer.getBounds();
    return t.containsLatLng(this.getLatLng())
};
Wikimapia.defaultMarkersParams = {
    sprite: Wikimapia.Utils.defaultMarkersUrl + "markers-sprite.png",
    tiny: {
        size: [11, 16],
        shadowSize: [11, 10],
        offset: [6, 6],
        shadow: [-75, -6],
        red: [0, 0],
        yellow: [-25, 0],
        green: [-50, 0]
    },
    normal: {
        size: [17, 28],
        shadowSize: [18, 16],
        offset: [8, 12],
        shadow: [-75, -28],
        red: [0, -16],
        yellow: [-25, -16],
        green: [-50, -16]
    },
    large: {
        size: [25, 40],
        shadowSize: [29, 24],
        offset: [13, 16],
        shadow: [-75, -60],
        red: [0, -44],
        yellow: [-25, -44],
        green: [-50, -44]
    }
};
Wikimapia.Marker = Wikimapia.Feature.Marker;
Wikimapia.Feature.Vector = function (t) {
    var e = t.map;
    delete t.map;
    Wikimapia.Feature.prototype.constructor.call(this, t);
    this.setStyle(t.style);
    if (e) {
        e.addVectorFeature(this)
    }
    return this
};
Wikimapia.Utils.inherits(Wikimapia.Feature.Vector, Wikimapia.Feature);
Wikimapia.Feature.Vector.prototype.options = {};
Wikimapia.Feature.Vector.prototype.style = {};
Wikimapia.Feature.Vector.prototype.geometry = null;
Wikimapia.Feature.Vector.prototype.renderer = null;
Wikimapia.Feature.Vector.prototype.rendered = false;
Wikimapia.Feature.Vector.prototype.element = null;
Wikimapia.Feature.Vector.prototype.setLayer = function (t) {
    this.layer = t;
    this.renderer = this.layer.renderer
};
Wikimapia.Feature.Vector.prototype.draw = function () {
    this.rendered = false;
    if (!this.isRendered()) {
        var t = Wikimapia.Utils.extend({}, Wikimapia.Feature.Vector.defaultStyle, this.style);
        this.calculateRenderOptions(t);
        this.style.isFilled = t.isFilled;
        this.style.isStroked = t.isStroked;
        this.element = this.renderer.setStyle(this.renderer.draw(this.geometry), t, this.style);
        if (this.options.className) {
            var e = this.options.className;
            this.options.className = "";
            this.addClass(e)
        }
        if (this.element) {
            this.rendered = true;
            this.fireEvent("featureRendered", this)
        }
    }
    return this
};
Wikimapia.Feature.Vector.prototype.hasClass = function (t) {
    return new RegExp("(\\s|^)" + t + "(\\s|$)")
        .test(this.options.className)
};
Wikimapia.Feature.Vector.prototype.addClass = function (t) {
    if (!this.hasClass(t)) {
        this.options.className = this.options.className + " " + t;
        if (this.isRendered()) {
            this.renderer.setClass(this.element, this.options.className)
        }
    }
};
Wikimapia.Feature.Vector.prototype.removeClass = function (t) {
    this.options.className = this.options.className.replace(new RegExp("(\\s|^)" + t + "(\\s|$)", "g"), "$2");
    if (this.hasClass(t) && this.isRendered()) {
        this.renderer.setClass(this.element, this.options.className)
    }
};
Wikimapia.Feature.Vector.prototype.redraw = function (t, e) {
    this.geometry = t || this.geometry;
    this.rendered = false;
    this.geometry.clearCachedCoords();
    if (e) {
        this.setStyle(e)
    }
    if (this.isRendered()) {
        this.renderer.redraw(this.element, this.geometry);
        if (e) {
            this.applyStyle()
        }
    } else {
        this.draw()
    }
    return this
};
Wikimapia.Feature.Vector.prototype.setStyle = function (t) {
    var e = false,
        i;
    this.style = t = Wikimapia.Utils.extend({}, this.style, t);
    this.calculateRenderOptions(this.style);
    if (this.style.isStroked) {
        var a = +this.style.graphicOffset;
        this.style.graphicOffset = Math.floor(this.style.strokeWidth * .5);
        e = a !== this.style.graphicOffset
    }
    if (this.element) {
        if (e) {
            this.renderer.redraw(this.element, this.geometry)
        }
        this.applyStyle()
    }
    return this
};
Wikimapia.Feature.Vector.prototype.applyStyle = function () {
    this.renderer.setStyle(this.element, this.style, this.style);
    return this
};
Wikimapia.Feature.Vector.prototype.toElement = function () {
    return this.element
};
Wikimapia.Feature.Vector.prototype.isRendered = function () {
    return !!this.element
};
Wikimapia.Feature.Vector.prototype.show = function () {
    if (this.element && this.hidden) {
        this.element.style.visibility = "visible";
        this.hidden = false;
        this._omitClick = 0
    }
    return this
};
Wikimapia.Feature.Vector.prototype.hide = function () {
    if (this.element) {
        this.element.style.visibility = "hidden";
        this.hidden = true
    }
    return this
};
Wikimapia.Feature.Vector.prototype.calculateRenderOptions = function (t) {
    if (t.isFilled === undefined || typeof t.fillColor === "string") {
        t.isFilled = !!t.fillColor
    }
    if (t.isStroked === undefined || t.strokeWidth !== undefined) {
        t.isStroked = !!t.strokeWidth
    }
    return t
};
Wikimapia.Feature.Vector.prototype.setGeometry = function (t) {
    this.geometry = t;
    if (this.isRendered()) {
        this.redraw(this.geometry)
    } else {
        this.draw()
    }
    return this
};
Wikimapia.Feature.Vector.prototype.setMap = function (t) {
    if (t === null) {
        if (this.map) {
            this.layer.removeFeature(this);
            this.map = null
        }
    } else {
        Wikimapia.Feature.prototype.setMap.call(this, t)
    }
    return this
};
Wikimapia.Feature.Vector.prototype.moveVertex = function (t, e) {
    this.geometry.points[t] = e;
    this.setGeometry(this.geometry.clearBounds())
};
Wikimapia.Feature.Vector.prototype.onScreen = function (t) {
    t = t || this.layer.getBounds();
    var e = false,
        i = this.geometry.getBounds();
    for (var a = 0, o = this.geometry.getVertexCount() ; a < o; a++) {
        if (t.containsLatLng(this.geometry.getVertex(a))) {
            e = true;
            break
        }
    }
    return e || (i.intersectsBounds(t) || i.containsBounds(t))
};
Wikimapia.Feature.Vector.prototype.getBounds = function () {
    return this.geometry.getBounds()
};
Wikimapia.Feature.Vector.prototype.destroy = function () {
    this.destroyDom();
    this.fireEvent("featureDestroyed", this);
    Wikimapia.Feature.prototype.destroy.call(this)
};
Wikimapia.Feature.Vector.defaultStyle = {
    fillColor: "#ffcc00",
    fillOpacity: .4,
    strokeColor: "#ffcc00",
    strokeOpacity: 1,
    strokeWidth: 1,
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeDashstyle: "solid",
    pointerEvents: "visiblePainted",
    cursor: "pointer",
    isFilled: true,
    isStroked: true,
    visibility: "visible",
    zIndex: 501
};
Wikimapia.Feature.Polygon = function (t) {
    this.geometry = t.geometry || new Wikimapia.Geometry.Polygon(t.points);
    delete t.points;
    delete t.geometry;
    this.options.id = Wikimapia.Utils.uniqueId("polygon");
    Wikimapia.Feature.Vector.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Feature.Polygon, Wikimapia.Feature.Vector);
Wikimapia.Feature.Polygon.prototype.style = {
    fillColor: "#ffcc00",
    strokeColor: "#ffcc00"
};
Wikimapia.Polygon = Wikimapia.Feature.Polygon;
Wikimapia.Feature.Polyline = function (t) {
    this.geometry = new Wikimapia.Geometry.Polyline(t.points);
    delete t.points;
    t.id = Wikimapia.Utils.uniqueId("polyline");
    Wikimapia.Feature.Vector.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Feature.Polyline, Wikimapia.Feature.Vector);
Wikimapia.Feature.Polyline.prototype.style = {
    isFilled: false,
    fillColor: 0,
    strokeWidth: 5,
    strokeOpacity: .7
};
Wikimapia.Feature.Polyline.prototype.moveVertex = function (t, e) {
    this.geometry.points[t] = e;
    this.geometry.clearBounds();
    this.setGeometry(this.geometry);
    return this
};
Wikimapia.Polyline = Wikimapia.Feature.Polyline;
Wikimapia.Interface = function (t, e) {
    var i;
    this.handlers = {};
    if (t) {
        if (t.map) {
            this.map = t.map;
            delete t.map
        }
        i = t.el;
        delete t.el
    }
    this.options = Wikimapia.Utils.extend({}, this.options, t);
    this.addEventsFromOptions(t, this.options);
    this.div = i || Wikimapia.Utils.Dom.create(this.options.tagName, {
        id: "wm-" + Wikimapia.Utils.uniqueId(this.options.name.replace(/\s/g, "-")),
        "class": this.options.printable ? "wm-printable" : "wm-noprint",
        styles: e || {
            position: "absolute",
            display: this.options.hidden ? "none" : "block"
        }
    });
    this.isDisplayed = true;
    this.handlers.onLanguageChange = this.onLanguageChange.bind(this);
    Wikimapia.Lang.addEvent("langChanged", this.handlers.onLanguageChange)
};
Wikimapia.Utils.inherits(Wikimapia.Interface, Wikimapia.EventTarget);
Wikimapia.Interface.prototype.options = {
    name: "ui",
    position: null,
    printable: false,
    selectable: false,
    tagName: "div"
};
Wikimapia.Interface.prototype.handlers = null;
Wikimapia.Interface.prototype.div = null;
Wikimapia.Interface.prototype._isDisposed = false;
Wikimapia.Interface.prototype.isDisplayed = false;
Wikimapia.Interface.prototype.container = null;
Wikimapia.Interface.prototype.inject = function (t, e) {
    e = e || "bottom";
    this.draw();
    Wikimapia.Utils.Dom.inject(this.div, t, e);
    this.setPosition();
    return this
};
Wikimapia.Interface.prototype.getElement = function (t) {
    return t ? this.div : $(this.div)
};
Wikimapia.Interface.prototype.draw = function () { };
Wikimapia.Interface.prototype.setPosition = function () {
    if (this.options.position) {
        this.div.setStyles(this.options.position)
    }
};
Wikimapia.Interface.prototype.toElement = function () {
    return this.div
};
Wikimapia.Interface.prototype.hide = function () {
    Wikimapia.Utils.Dom.setStyle(this.div, "display", "none");
    this.isDisplayed = false;
    this.fireEvent("hidden", this);
    return this
};
Wikimapia.Interface.prototype.show = function () {
    Wikimapia.Utils.Dom.setStyle(this.div, "display", "block");
    this.isDisplayed = true;
    this.fireEvent("shown", this);
    return this
};
Wikimapia.Interface.prototype.flush = function () {
    if (this.div) this.div.innerHTML = "";
    return this
};
Wikimapia.Interface.prototype.getSize = function () {
    return this.div.getSize()
};
Wikimapia.Interface.prototype.setLoading = function (t, e) {
    e = typeof e === "string" ? e : "loading";
    e = Wikimapia.Lang.get("all." + e) || e;
    this.div.innerHTML = '<div class="interface-loading-bar">' + ("<span>" + e + "</span></div>")
        .replace(/\{\}/g, "&nbsp;");
    if (t) {
        var i = Wikimapia.Utils.Dom.getSize(this.div),
            a, o;
        a = Math.ceil(t.left + (t.getWidth() - i.x) / 2);
        o = Math.ceil(t.top + (-t.getHeight() - i.y) / 2);
        Wikimapia.Utils.Dom.setStyles(this.div, {
            top: o + "px",
            left: a + "px"
        })
    }
    var n = Wikimapia.Utils.Dom.getElement(this.div, ".interface-loading-bar");
    Wikimapia.Interface.Spinner.setLoading(n, {
        color: "#fff",
        radius: 4,
        width: 2,
        length: 3,
        lines: 9,
        left: "10px",
        top: "10px",
        speed: 2.5
    })
};
Wikimapia.Interface.prototype.onLanguageChange = function (t) { };
Wikimapia.Interface.prototype.destroy = function () {
    if (this.handlers.onLanguageChange) {
        Wikimapia.Lang.removeEvent("langChanged", this.handlers.onLanguageChange);
        delete this.handlers.onLanguageChange
    }
    if (this.div) {
        this.flush();
        Wikimapia.Utils.Dom.destroy(this.div);
        delete this.div;
        this.fireEvent("destroy", this)
    }
    this._isDisposed = true
};
Wikimapia.Interface.prototype.isDisposed = function () {
    return this._isDisposed
};
Wikimapia.Interface.onMouseMove = function (t) {
    if (t) {
        t.stop()
    }
    return false
};
(function () {
    Wikimapia.Net.Asset.image(Wikimapia.Utils.defaultControlsUrl + "button.png?2")
})();
Wikimapia.Interface.Button = function (t) {
    Wikimapia.Interface.prototype.constructor.call(this, t);
    var e = this.options.name === "wm-button" ? Wikimapia.Utils.uniqueId(this.options.name) : this.options.name,
        i = this.div;
    i.setAttribute("id", e);
    Wikimapia.Utils.Dom.addEvents(i, {
        mouseleave: this.unhighlight.bind(this),
        mouseenter: this.highlight.bind(this)
    });
    return this
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Button, Wikimapia.Interface);
Wikimapia.Interface.Button.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
    background: {
        type: "sprite",
        src: Wikimapia.Utils.defaultControlsUrl + "button.png",
        color: "",
        leftPartPosition: "0px 0px",
        rightPartPosition: "-394px 0px",
        leftPartFocus: "0px -30px",
        rightPartFocus: "-394px -30px"
    },
    padding: "7px 5px 7px 6px",
    name: "wm-button",
    icon: null,
    iconSize: {
        w: 16,
        h: 16
    },
    gap: 5,
    text: null,
    font: "font-size: 14px; line-height: 16px;",
    hoverfont: "",
    size: {
        w: 0,
        h: 30
    },
    position: null
});
Wikimapia.Interface.Button.prototype.styles = {
    text: "float: left; display: block; position: relative; cursor: pointer; overflow: hidden;",
    content: "display: block; float: left; position: relative; overflow: hidden; cursor: pointer;",
    rightPart: "display: block; float: left; width: 6px; height: 30px;"
};
Wikimapia.Interface.Button.prototype.icon = null;
Wikimapia.Interface.Button.prototype.text = null;
Wikimapia.Interface.Button.prototype.spinner = null;
Wikimapia.Interface.Button.prototype.tooltip = false;
Wikimapia.Interface.Button.prototype.content = null;
Wikimapia.Interface.Button.prototype.rightPart = null;
Wikimapia.Interface.Button.prototype.setPosition = function (t) {
    t = t || this.options.position;
    if (t) {
        if (typeof t === "string") {
            t = Wikimapia.Utils.pxStringToNumbers(t);
            if (t.length > 1) {
                this.options.position = t = new Wikimapia.Point(t[1], t[0])
            }
        }
        if (!(t instanceof Wikimapia.Point)) {
            t = this.options.position = new Wikimapia.Point(t.x || t.left, t.y || t.top)
        }
        Wikimapia.Utils.Dom.setStyles(this.div, {
            position: "absolute",
            top: t.y + "px",
            left: t.x + "px"
        })
    }
};
Wikimapia.Interface.Button.prototype.draw = function () {
    if (this.options.position) {
        this.setPosition(this.options.position)
    } else {
        Wikimapia.Utils.Dom.setStyle(this.div, "position", "relative")
    }
    this.content = Wikimapia.Utils.Dom.create("div", {
        id: this.div.id + "-content",
        style: this.styles.content
    });
    Wikimapia.Utils.Dom.inject(this.content, this.div);
    if (this.options.icon) {
        this.setIcon(this.createIcon())
    }
    if (this.options.text) {
        this.setText(this.options.text)
    }
    this.rightPart = Wikimapia.Utils.Dom.create("div", {
        id: this.div.id + "-right",
        style: this.styles.rightPart
    });
    Wikimapia.Utils.Dom.inject(this.rightPart, this.div);
    this.setBackground(this.options.background);
    this.adjust();
    this.setEvents();
    this.unhighlight()
};
Wikimapia.Interface.Button.prototype.unhighlight = function (t) {
    var e = this.options.background,
        i = Wikimapia.Utils;
    i.Dom.removeClass(this.div, "hover");
    if (i.alphaImageHackNeeded) {
        i.moveAlphaImageSprite(this.content, e.leftPartPosition);
        i.moveAlphaImageSprite(this.rightPart, e.rightPartPosition)
    } else {
        i.Dom.setStyle(this.content, "background-position", e.leftPartPosition);
        i.Dom.setStyle(this.rightPart, "background-position", e.rightPartPosition)
    }
    this.fireEvent("mouseleave", t)
};
Wikimapia.Interface.Button.prototype.highlight = function (t) {
    if (this.disabled) return;
    var e = this.options.background,
        i = Wikimapia.Utils;
    i.Dom.addClass(this.div, "hover");
    if (i.alphaImageHackNeeded) {
        i.moveAlphaImageSprite(this.content, e.leftPartFocus);
        i.moveAlphaImageSprite(this.rightPart, e.rightPartFocus)
    } else {
        i.Dom.setStyle(this.content, "background-position", e.leftPartFocus);
        i.Dom.setStyle(this.rightPart, "background-position", e.rightPartFocus)
    }
    this.fireEvent("mouseenter", t)
};
Wikimapia.Interface.Button.prototype.setEvents = function () {
    var t = ["click", "mousedown", "mouseup", "dblclick"],
        e, i, a = function (t) {
            if (!this.disabled) {
                this.fireEvent(t.type, t)
            }
            return false
        }.bind(this);
    for (i = 0, e = t.length; i < e; i++) {
        var o = t[i];
        Wikimapia.Utils.Dom.addEvent(this.content, o, a)
    }
};
Wikimapia.Interface.Button.prototype.setBackground = function (t) {
    switch (t.type) {
        case "sprite":
            Wikimapia.Utils.Dom.setStyles(this.content, {
                "background-image": "url(" + t.src + ")",
                "background-position": t.leftPartPosition,
                position: "relative"
            });
            Wikimapia.Utils.Dom.setStyles(this.rightPart, {
                "background-image": "url(" + t.src + ")",
                "background-position": t.rightPartPosition,
                position: "relative"
            });
            if (Wikimapia.Utils.alphaImageHackNeeded) {
                Wikimapia.Utils.fixAlphaImageSprite(this.content);
                Wikimapia.Utils.fixAlphaImageSprite(this.rightPart)
            }
            break;
        case "image":
            Wikimapia.Utils.Dom.setStyle(this.content, "background-image", "url(" + t.src + ")");
            Wikimapia.Utils.Dom.setStyles(this.rightPart, {
                background: "none",
                width: "0px",
                height: "0px"
            });
            if (Wikimapia.Utils.alphaImageHackNeeded) {
                Wikimapia.Utils.fixAlphaImageSprite(this.content)
            }
            break;
        case "color":
            $(this.content)
                .setStyle("background", t.color);
            break;
        default:
            break
    }
};
Wikimapia.Interface.Button.prototype.createIcon = function (t) {
    if (!t) {
        t = this.options.icon
    }
    var e = null,
        i = "0px";
    if (t instanceof Wikimapia.Icon) {
        e = t
    } else {
        if (typeOf(t) == "string") {
            var a = {
                image: t,
                size: this.options.iconSize,
                noEvents: true
            };
            e = new Wikimapia.Icon(a)
        }
    }
    Wikimapia.Utils.Dom.setStyles(e.getElement(), {
        "float": "left",
        position: "relative"
    });
    return e
};
Wikimapia.Interface.Button.prototype.setIcon = function (t) {
    if (t) {
        var e = this.icon;
        if (!(t instanceof Wikimapia.Icon)) {
            t = this.createIcon(t)
        }
        this.icon = t;
        t = t.getElement();
        if (this.text) {
            Wikimapia.Utils.Dom.inject(t, this.text, "before")
        } else {
            Wikimapia.Utils.Dom.inject(t, this.content)
        }
        if (e) {
            Wikimapia.Utils.Dom.destroy(e.getElement())
        }
        Wikimapia.Utils.Dom.setStyle(t, "margin-right", this.options.gap + "px")
    } else {
        if (t === null && this.icon) {
            this.icon.destroy();
            this.icon = null
        }
    }
    this.adjust();
    return this
};
Wikimapia.Interface.Button.prototype.setText = function (t) {
    t = Wikimapia.Lang.get("all." + t) || t;
    if (!this.text) {
        this.text = Wikimapia.Utils.Dom.create("div", {
            "class": "button-text",
            style: this.styles.text + this.options.font
        });
        Wikimapia.Utils.Dom.inject(this.text, this.content)
    }
    this.text.innerHTML = t;
    this.adjust()
};
Wikimapia.Interface.Button.prototype.setLoading = function () {
    if (!this.spinner) {
        if (this.icon) {
            Wikimapia.Utils.Dom.setStyle(this.icon.getElement(), "visibility", "hidden")
        }
        Wikimapia.Utils.Dom.addClass(this.div, "loading");
        this.spinner = Wikimapia.Interface.Spinner.setLoading(this.div, {
            color: "#fff",
            radius: 3,
            width: 2,
            length: 3,
            lines: 9,
            left: "14px"
        });
        this.disabled = true
    }
    return this
};
Wikimapia.Interface.Button.prototype.stopLoading = function () {
    if (this.spinner) {
        this.spinner.stop();
        delete this.spinner
    }
    if (this.icon) {
        Wikimapia.Utils.Dom.setStyle(this.icon.getElement(), "visibility", "")
    }
    Wikimapia.Utils.Dom.removeClass(this.div, "loading");
    delete this.disabled;
    return this
};
Wikimapia.Interface.Button.prototype.getIconSize = function () {
    var t = this.icon.image.getComputedSize({
        styles: ["padding", "border", "margin"]
    });
    return {
        w: t.totalWidth,
        h: t.totalHeight
    }
};
Wikimapia.Interface.Button.prototype.setPadding = function (t) {
    if (typeof t === "string") {
        var e = this.icon ? this.icon.image : this.text;
        t = Wikimapia.Utils.pxStringToNumbers(t);
        if (t.length > 3) {
            this.parsedPadding = t = {
                top: parseInt(t[0], 10),
                right: parseInt(t[1], 10),
                bottom: parseInt(t[2], 10),
                left: parseInt(t[3], 10)
            };
            Wikimapia.Utils.Dom.setStyle($(e), "margin-left", t.left + "px");
            var i = {
                "margin-top": t.top + "px"
            };
            if (this.icon) {
                Wikimapia.Utils.Dom.setStyles(this.icon.image, i)
            }
            if (this.text) {
                Wikimapia.Utils.Dom.setStyles(this.text, i)
            }
        }
    }
};
Wikimapia.Interface.Button.prototype.getTextWidth = function () {
    var t = 0;
    if (this.text) {
        var e = $(this.text);
        t = Wikimapia.Utils.measureText(e.getText(), e.getStyle("font-size"), e.getStyle("font-family"), e.getStyle("font-weight"))
    }
    return t
};
Wikimapia.Interface.Button.prototype.adjust = function () {
    this.setPadding(this.options.padding);
    var t, e, i, a, o, n = this.parsedPadding;
    i = a = {
        x: 0,
        y: 0
    };
    t = {
        w: 0,
        h: 0
    };
    e = this.options.gap;
    if (n) {
        a.x = parseInt(n.right, 10)
    }
    if (this.icon) {
        t = this.icon.getSize()
    }
    if (this.text) {
        i.x = this.getTextWidth()
    }
    o = {
        width: n.left + t.w + e + i.x + 5 + (this.options.text ? 0 : -14),
        height: Math.max(i.y, t.h) + n.top + n.bottom
    };
    Wikimapia.Utils.Dom.setStyles(this.content, o);
    this.options.size = new Wikimapia.Size(o.width + a.x, o.height);
    if (!Wikimapia.Utils.alphaImageHackNeeded && !this.options.text) {
        this.options.size.w -= 50
    }
    this.options.size.w = o.width + 7;
    Wikimapia.Utils.Dom.setStyles(this.div, {
        width: this.options.size.w + "px",
        height: "30px",
        overflow: "hidden"
    })
};
Wikimapia.Interface.Button.prototype.inject = function (t, e) {
    Wikimapia.Interface.prototype.inject.call(this, t, e);
    this.adjust();
    if (this.options.tooltip) {
        this.addTooltip(this.options.tooltip, this.options.tooltipPos)
    }
    return this
};
Wikimapia.Interface.Button.prototype.addTooltip = function (t, e) {
    var i = this.div.parentNode,
        a, o;
    t = this.options.tooltip = t || this.options.text;
    var n = Wikimapia.Lang.get("all." + t) || t;
    if (i) {
        a = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
            id: this.div.id + "-tooltip",
            "class": "wm-button-tooltip",
            html: ['<span class="content" l10n="', t, '">', n, '</span><span class="right"></span>'].join(""),
            styles: {
                width: Wikimapia.Utils.measureText(n, 13, "Helvetica, Arial, Verdana, sans-serif", "bold") + 14 + "px"
            }
        }), this.div, "after");
        this.addEvents({
            mouseenter: function () {
                var t = Wikimapia.Lang.get("all." + this.options.tooltip) || this.options.tooltip,
                    e = Wikimapia.Utils.measureText(t, 13, null, "bold") + 14;
                Wikimapia.Utils.Dom.getElement(this.tooltip, "span.content")
                    .innerHTML = t;
                Wikimapia.Utils.Dom.setStyles(this.tooltip, {
                    width: e,
                    display: "block"
                })
            },
            mouseleave: function () {
                this.tooltip.hide()
            }
        });
        this.tooltip = a;
        this.setTooltipPosition(e)
    }
};
Wikimapia.Interface.Button.prototype.setTooltipPosition = function (t) {
    var e = this.div;
    t = t || Wikimapia.Utils.Dom.getPosition(e);
    if (this.tooltip) {
        Wikimapia.Utils.Dom.setStyles(this.tooltip, {
            position: "absolute",
            display: "none",
            top: t.y + Wikimapia.Utils.Dom.getSize(e)
                .y,
            left: t.x
        })
    }
}, Wikimapia.Interface.Button.prototype.onLanguageChange = function (t) {
    if (this.options.text) {
        this.setText(this.options.text)
    }
}, Wikimapia.Interface.Button.prototype.destroy = function () {
    Wikimapia.Utils.Dom.destroy(document.getElementById(this.div.id + "-tooltip"));
    if (this.tooltip) {
        Wikimapia.Utils.Dom.destroy(this.tooltip)
    }
    Wikimapia.Interface.prototype.destroy.call(this)
};
Wikimapia.Button = Wikimapia.Interface.Button;
Wikimapia.Control.Geolocation = function (t) {
    Wikimapia.Control.prototype.constructor.call(this);
    this.marker = null;
    t.addControl(this)
};
Wikimapia.Utils.inherits(Wikimapia.Control.Geolocation, Wikimapia.Control);
Wikimapia.Control.Geolocation.MARKER_IMAGE = Wikimapia.Utils.appendFileVersion(Wikimapia.Utils.defaultImagesUrl + "mobile/icons/position-marker.png");
Wikimapia.Control.Geolocation.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Control.prototype.options, {
    name: "Geolocation",
    view: true,
    position: {
        left: 28,
        top: 40
    },
    locationRequestTimeout: 5e3,
    tooltip: "geoloc"
});
Wikimapia.Control.Geolocation.prototype.button = null;
Wikimapia.Control.Geolocation.prototype.render = function () {
    Wikimapia.Control.prototype.render.call(this);
    this.button = new Wikimapia.Interface.Button({
        icon: new Wikimapia.Icon({
            image: Wikimapia.Control.Geolocation.SPRITE_PATH,
            imageSpritePos: "-18px -1280px"
        }),
        tooltip: this.options.tooltip
    });
    this.bindEvents();
    this.button.inject(this.div);
    Wikimapia.Utils.Dom.addClass(this.div, "geolocation");
    this.decorate()
};
Wikimapia.Control.Geolocation.prototype.decorate = function () {
    var t = this.map.getControlByName("zoomControl");
    if (t) {
        t.setPosition({
            top: 74,
            left: t.options.position.left
        })
    }
    Wikimapia.Utils.Dom.setStyles(document.getElementById(this.button.div.id + "-tooltip"), {
        top: 30,
        left: 34
    })
};
Wikimapia.Control.Geolocation.prototype.bindEvents = function () {
    Wikimapia.Utils.bindHandlers(this, "onClick", "onMouseEnter", "onMouseLeave");
    this.button.addEvents({
        click: this.handlers.onClick,
        mouseenter: this.handlers.onMouseEnter,
        mouseleave: this.handlers.onMouseLeave
    })
};
Wikimapia.Control.Geolocation.prototype.onClick = function () {
    if (!this.button.disabled && navigator.geolocation) {
        var t = this;
        this.button.setLoading();
        Wikimapia.Utils.Logger.log("geoloc_btn");
        var e = setTimeout(function () {
            t.enableButton()
        }, this.options.locationRequestTimeout);
        navigator.geolocation.getCurrentPosition(function (i) {
            clearTimeout(e);
            t.onGeopositionReceived(i)
        }, function (i) {
            clearTimeout(e);
            t.enableButton()
        }, {
            enableHighAccuracy: true,
            timeout: this.options.locationRequestTimeout
        })
    }
};
Wikimapia.Control.Geolocation.prototype.onMouseEnter = function () {
    if (!this.button.disabled) {
        this.button.setIcon(new Wikimapia.Icon({
            image: Wikimapia.Control.Geolocation.SPRITE_PATH,
            imageSpritePos: "-18px -1296px"
        }))
    }
};
Wikimapia.Control.Geolocation.prototype.onMouseLeave = function () {
    if (!this.button.disabled) {
        this.button.setIcon(new Wikimapia.Icon({
            image: Wikimapia.Control.Geolocation.SPRITE_PATH,
            imageSpritePos: "-18px -1280px"
        }))
    }
};
Wikimapia.Control.Geolocation.prototype.onGeopositionReceived = function (t) {
    var e = new Wikimapia.LatLng(t.coords.latitude, t.coords.longitude),
        i = t.coords.accuracy * 1.5,
        a = Wikimapia.Utils.offsetLatLngByMeters(e, -i, -i),
        o = Wikimapia.Utils.offsetLatLngByMeters(e, i, i),
        n = new Wikimapia.Bounds({
            top: a.lat,
            left: a.lng,
            right: o.lng,
            bottom: o.lat
        }),
        s = this.zoomToBounds.bind(this, n),
        r = this.map.getBestZoomForBounds(n, true);
    this.map.setCenter(e);
    if (r > this.map.options.maxZoomLevel) {
        if (r - this.map.options.maxZoomLevel <= 3) {
            s()
        } else {
            this.map.addEventOnce("zoomLimitsChanged", s)
        }
    } else {
        setTimeout(s, 400)
    }
};
Wikimapia.Control.Geolocation.prototype.zoomToBounds = function (t) {
    Wikimapia.Net.Asset.image(Wikimapia.Control.Geolocation.MARKER_IMAGE, {
        onLoad: this.addMarker.bind(this, t.getCenterLatLng())
    });
    this.map.zoomToBounds(t);
    this.enableButton()
};
Wikimapia.Control.Geolocation.prototype.addMarker = function (t) {
    this.removeMarker();
    this.marker = new Wikimapia.Marker({
        map: this.map,
        coords: t,
        icon: new Wikimapia.Icon({
            size: new Wikimapia.Size(21, 21),
            image: Wikimapia.Control.Geolocation.MARKER_IMAGE
        }),
        offset: new Wikimapia.Size(-10, -10)
    });
    this.marker.addEvent("contextmenu", this.onMarkerClick.bind(this))
};
Wikimapia.Control.Geolocation.prototype.removeMarker = function () {
    if (this.marker) {
        this.marker.setMap(null);
        this.marker = null
    }
};
Wikimapia.Control.Geolocation.prototype.onMarkerClick = function (t) {
    t.stop();
    this.map.contextMenu([{
        text: "rd-delpoi",
        action: this.removeMarker.bind(this),
        icon: {
            imageSpriteClass: "spt-cancel"
        }
    }], {}, "marker-context-menu", this.marker.getContainerPosition())
};
Wikimapia.Control.Geolocation.prototype.enableButton = function () {
    if (this.button.disabled) {
        this.button.stopLoading()
    }
    this.onMouseLeave()
};
Wikimapia.Control.Geolocation.prototype.destroy = function () {
    this.removeMarker();
    this.button.removeEvents({
        click: this.handlers.onClick,
        mouseenter: this.handlers.onMouseEnter,
        mouseleave: this.handlers.onMouseLeave
    });
    this.button.destroy();
    delete this.button;
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.Control.Geolocation.SPRITE_PATH = Wikimapia.Utils.defaultImagesUrl + "menu-spt.png";
Wikimapia.Interface.Window = function (t) {
    Wikimapia.Interface.prototype.constructor.call(this, t);
    Wikimapia.Utils.bindHandlers(this, "keyboard", "resize");
    this.messenger = new Wikimapia.Interface.Window.Messenger(this);
    this.messenger.addEvent("message", this.onMessage.bind(this));
    this.draw();
    if (this.map) {
        if (this.options.initiallyClosed) {
            this.hide();
            delete this.options.initiallyClosed;
            return this
        }
        if (this.options.url) {
            this.load(this.options.url)
        } else {
            if (this.options.content) {
                this.setContent(this.options.content)
            }
        }
    }
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Window, Wikimapia.Interface);
Wikimapia.Interface.Window.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
    iframe: false,
    name: "window",
    printable: true,
    centered: true,
    backdrop: true
});
Wikimapia.Interface.Window.prototype.messenger = null;
Wikimapia.Interface.Window.prototype.request = null;
Wikimapia.Interface.Window.prototype.backButton = null;
Wikimapia.Interface.Window.prototype.forwardButton = null;
Wikimapia.Interface.Window.prototype.__created = false;
Wikimapia.Interface.Window.prototype._initialEvents = null;
Wikimapia.Interface.Window.prototype.menu = null;
Wikimapia.Interface.Window.prototype.draw = function () {
    Wikimapia.Interface.prototype.draw.call(this);
    Wikimapia.Utils.Dom.addEvent(document, "keydown", this.handlers.keyboard);
    Wikimapia.Utils.Dom.addEvent(window, "resize", this.handlers.resize);
    if (this.map) {
        this.setSize(this.options.size);
        this.createContainer();
        Wikimapia.Utils.Dom.inject(this.div, this.map.getControlsContainer());
        if (this.options.backdrop) {
            this.addBackDrop()
        }
    }
};
Wikimapia.Interface.Window.prototype.addEventsFromOptions = function (t) {
    this._events = this._events || {};
    this._initialEvents = this._initialEvents || {};
    for (var e in t) {
        if (/^on[A-Z]/.test(e) || typeof t[e] === "function") {
            var i = Wikimapia.EventTarget.cleanEventType(e);
            if (i in this._initialEvents) {
                this.removeEvent(i, this._initialEvents[i]);
                delete this._initialEvents[i]
            }
            this.addEvent(e, t[e]);
            this._initialEvents[i] = t[e];
            delete t[e]
        }
    }
};
Wikimapia.Interface.Window.prototype.addBackDrop = function () {
    this.backdrop = new Wikimapia.Interface.Window.Backdrop(this, this.map)
};
Wikimapia.Interface.Window.prototype.open = function (t) {
    var e = !!this.options.iframe;
    if (!t.menu && this.menu) {
        this.menu.destroy();
        delete this.menu;
        delete this.options.menu
    }
    if (t.content) {
        delete this.options.url
    }
    if (t.url) {
        delete this.options.content
    }
    if (!t.size) {
        delete this.options.size
    }
    this.options = t = Wikimapia.Utils.extend({}, this.options, t);
    if (this.menu) {
        this.menu.destroy();
        delete this.menu
    }
    this.fireEvent("unload", this);
    if (this.container) {
        Wikimapia.Utils.Dom.destroy(this.container)
    }
    this.setLoading();
    this.setSize(t.size);
    this.createContainer();
    if (t.url) {
        this.load(t.url)
    }
    if (t.content) {
        this.setContent(t.content)
    }
    return this
};
Wikimapia.Interface.Window.prototype.setLoading = function () {
    this.fireEvent("unload", this);
    if (!this.container) {
        return this
    } else if (this.options.iframe) {
        this.container.hide()
    } else {
        this.container.innerHTML = ""
    }
    if (!this._spinner) { }
    if (!Wikimapia.Utils.Dom.hasClass(this.div, "loading")) {
        Wikimapia.Utils.Dom.addClass(this.div, "loading")
    }
    return this
};
Wikimapia.Interface.Window.prototype.hideLoading = function () {
    if (this._spinner) {
        this._spinner.stop();
        this._spinner = null
    }
    Wikimapia.Utils.Dom.removeClass(this.div, "loading")
};
Wikimapia.Interface.Window.prototype.addMenu = function (t) {
    if (this.menu) {
        this.menu.destroy()
    }
    var e = this.getElement()
        .getElement(".wm-window-header .close");
    this.menu = new Wikimapia.Interface.Menu(t, {
        name: "window-menu nav",
        submenuMaxHeight: this.options.size.h - 60
    });
    this.menu.getElement()
        .inject(e, "before");
    return this.menu
};
Wikimapia.Interface.Window.prototype.setSize = function (t) {
    t = t || this.options.size;
    var e, i = Math.round;
    if (this.map) {
        var a = this.map.getCurrentSize(),
            o = Math.max,
            n = Math.min;
        a.w *= .9;
        a.h -= 100;
        if (t) {
            t = new Wikimapia.Size(n(a.w, t.w), n(a.h, t.h))
        } else {
            t = new Wikimapia.Size(n(a.w, a.w * .77), o(a.h, 170))
        }
        this.size = t
    }
    Wikimapia.Utils.Dom.addClass(this.div, "modal wm-window");
    e = {
        width: i(t.w),
        height: i(t.h)
    };
    if (this.options.centered) {
        e["margin-left"] = i(-t.w / 2);
        e["margin-top"] = i(-t.h / 2)
    }
    Wikimapia.Utils.Dom.setStyles(this.div, e);
    return this
};
Wikimapia.Interface.Window.prototype.scrollToElement = function (t, e, i) {
    if (this.container && this.options.iframe) {
        var a = this.getContext(),
            o = typeof t == "string" ? a.document.getElementById(t) : a.$(o);
        if (o) {
            var e = e || 100,
                i = i || 0,
                n = a.$(o)
                .position()
                .top - e;
            a.$("html, body")
                .animate({
                    scrollTop: n + "px"
                }, i)
        }
    }
};
Wikimapia.Interface.Window.prototype.createContainer = function () {
    var t = this.div.getAttribute("id"),
        e = this,
        i, a = this.map,
        o, n;
    if (a) {
        o = a.options.getApp()
    } else {
        return
    }
    var n = {
        mouseenter: function (t) {
            e.fireEvent("mouseenter", t)
        },
        mouseleave: function (t) {
            e.fireEvent("mouseleave", t)
        }
    };
    if (this.options.iframe) {
        i = "wm-" + Wikimapia.Utils.uniqueId("iframe");
        n.load = this.getIframeLoadHandler();
        this.container = Wikimapia.Utils.Dom.create("iframe", {
            id: i,
            "class": "modal-body modal-iframe",
            frameborder: "no",
            name: i
        })
    } else {
        this.container = Wikimapia.Utils.Dom.create("div", {
            id: "wm-" + Wikimapia.Utils.uniqueId("window-content"),
            "class": "modal-body window-content"
        })
    }
    this.setContainerSize();
    Wikimapia.Utils.Dom.inject(this.container, this.div);
    Wikimapia.Utils.Dom.addEvents(this.container, n);
    this.createHeader();
    if (this.options.menu) {
        this.addMenu(this.options.menu)
    } else if (this.menu) {
        this.menu.destroy()
    }
    this.fireEvent("create", this)
};
Wikimapia.Interface.Window.prototype.getIframeLoadHandler = function () {
    var t = this,
        e = this.map;
    this._iframeLoadHandler = this._iframeLoadHandler || function (i) {
        var a = /ONMOUSEOVER\=\"([!\s\w \-;:\.\,\(\)\[\]\'\"=<>\/&\?\\\{\}\+\u00A1-\uFFFF]+?)\"/,
            o;
        t.hideLoading();
        t.container.show();
        if (window.flphoar[20]) {
            o = window.flphoar[20].match(a)[1];
            if (o) {
                o = app.parseJsResponse(o, true);
                if (o) {
                    o = o.menuData;
                    e.placeOptions = {
                        mbr: o.mbr,
                        zoom: o.zoom,
                        currentLanguage: o.language
                    }
                }
            }
        }
        t.fireEvent("load");
        t.exposeToFrame()
    };
    return this._iframeLoadHandler
};
Wikimapia.Interface.Window.prototype.exposeToFrame = function () {
    var t = window.frames[this.container.id];
    if (this.container.src.indexOf(Wikimapia.Utils.getLocationOrigin(top)) === 0) {
        try {
            (t.contentWindow || t.window)
            .windowObject = this
        } catch (e) { }
    }
};
Wikimapia.Interface.Window.prototype.onMessage = function (t) {
    if (t.data === "loaded") {
        this.getIframeLoadHandler()
            .call(this)
    } else if ("fullScreen" in t.data) {
        if (t.data.fullScreen) {
            this.fullScreen(true, true)
        } else {
            this.fullScreen(false)
        }
    }
    this.fireEvent(t)
};
Wikimapia.Interface.Window.prototype.fullScreen = function (t, e) {
    var i;
    if (t) {
        this._ignoreMapResize = true;
        Wikimapia.Utils.Dom.setStyles(this.div, {
            position: "absolute",
            "z-index": 1e5,
            width: "100%",
            height: "100%"
        });
        Wikimapia.Utils.Dom.setStyles(this.container, {
            position: "absolute",
            "z-index": 1e5,
            width: "100%",
            height: "100%"
        });
        if (e) {
            i = this.getHeader();
            if (i) i.hide()
        }
        Wikimapia.Utils.Dom.addClass(this.div, "full-screen");
        if (this.options.centered) {
            Wikimapia.Utils.Dom.setStyles(this.div, {
                "margin-left": "",
                "margin-top": ""
            })
        }
    } else {
        delete this._ignoreMapResize;
        Wikimapia.Utils.Dom.setStyles(this.container, {
            "z-index": "",
            position: ""
        });
        Wikimapia.Utils.Dom.setStyles(this.div, {
            "z-index": 1805
        });
        i = this.getHeader();
        if (i) i.show();
        Wikimapia.Utils.Dom.removeClass(this.div, "full-screen");
        this.setSize()
    }
};
Wikimapia.Interface.Window.prototype.getHeader = function () {
    return Wikimapia.Utils.Dom.getElement(this.div, ".wm-window-header")
};
Wikimapia.Interface.Window.prototype.setContainerSize = function () {
    var t = this.size;
    Wikimapia.Utils.Dom.setStyles(this.container, {
        width: t.w,
        height: t.h - 15
    });
    return this.container
};
Wikimapia.Interface.Window.prototype.createHeader = function () {
    var t = Wikimapia.Utils.Dom.getElement(this.div, ".wm-" + this.options.name + "-header"),
        e = this.div.id;
    if (t) {
        Wikimapia.Utils.Dom.destroy(t)
    }
    t = Wikimapia.Utils.Dom.create("div", {
        id: e + "-header",
        "class": "modal-header wm-window-header",
        html: '<span id="jwindow_title" style="display:none;"></span><span id="jwindow"></span>'
    });
    Wikimapia.Utils.Dom.inject(t, this.div, "top");
    Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("span", {
        id: e + "-close-button",
        html: "&times;",
        "class": "close",
        events: {
            click: this.close.bind(this)
        }
    }), t, "top")
};
Wikimapia.Interface.Window.prototype.close = function () {
    if (this.div) {
        this.fireEvent("unload", this);
        Wikimapia.Utils.Dom.destroy(this.div);
        delete this.div;
        delete this.options.url;
        this.fireEvent("close");
        Wikimapia.Utils.Dom.removeEvent(document, "keydown", this.handlers.keyboard);
        Wikimapia.Utils.Dom.removeEvent(window, "resize", this.handlers.resize)
    }
    this.destroy();
    return this
};
Wikimapia.Interface.Window.prototype.cancelRequest = function () {
    if (this.request && this.request.isRunning()) {
        this.request.cancel()
    }
}, Wikimapia.Interface.Window.prototype.load = function (t) {
    var e = this.div,
        i = this,
        a = this.map;
    this.setLoading();
    this.fireEvent("loadstart", this);
    this.cancelRequest();
    if (this.options.iframe) {
        this.container.setAttribute("src", t);
        this.container.show();
        delete this.request
    } else {
        var o = a.options.getApp();
        if (!this.request) {
            this.request = new Wikimapia.Net.Xhr({
                method: "get",
                type: "html",
                evalScripts: false,
                onSuccess: this.onAjaxComplete.bind(this),
                onError: this.onAjaxError.bind(this)
            })
        }
        this.request.send({
            url: t
        })
    }
};
Wikimapia.Interface.Window.prototype.onAjaxComplete = function (t) {
    if (this.div) {
        this.setContent(t)
    }
};
Wikimapia.Interface.Window.prototype.onAjaxError = function () {
    this.fireEvent("error", this)
};
Wikimapia.Interface.Window.prototype.setContent = function (t) {
    t = Wikimapia.Net.stripCSS(t);
    var e = app.parseJsResponse(t);
    this.container.innerHTML = Wikimapia.Utils.stripScripts(t, true);
    if (e) {
        Wikimapia.Utils.Dom.fireEvent(window, "commandReceived", [null, app.parseJsResponse(t)])
    }
    t = Wikimapia.Net.execAllScriptsFromXHR(t);
    window.routeLinks(this.container);
    if (this.div) {
        this.hideLoading();
        this.fireEvent("load", this)
    }
    delete this.options.content;
    return this
};
Wikimapia.Interface.Window.prototype.getUrl = function () {
    return this.options.url || ""
};
Wikimapia.Interface.Window.prototype.getContext = function () {
    if (this.options.iframe) {
        return this.container.contentWindow || this.container.window
    } else {
        return window
    }
};
Wikimapia.Interface.Window.prototype.keyboard = function (t) {
    if (t.keyCode === Wikimapia.Utils.Event.keyCodes.ESC) {
        this.close();
        t.stop()
    }
};
Wikimapia.Interface.Window.prototype.focus = function () {
    if (this.container && this.options.iframe) {
        this.container.contentWindow.focus()
    }
};
Wikimapia.Interface.Window.prototype.resize = function () {
    this.setSize();
    this.setContainerSize()
};
Wikimapia.Interface.Window.prototype.destroy = function () {
    if (this.messenger) {
        this.messenger.destroy();
        delete this.messenger
    }
    if (this.container) {
        Wikimapia.Utils.Dom.removeEvents(this.container);
        Wikimapia.Utils.Dom.destroy(this.container);
        delete this.container
    }
    if (this.request) {
        this.cancelRequest();
        delete this.request
    }
    if (this.menu) {
        this.menu.destroy();
        delete this.menu
    }
    Wikimapia.Interface.prototype.destroy.call(this)
};
Wikimapia.Interface.Window.History = function (t, e) {
    this.window = t;
    this.storage = [];
    this.pos = 0;
    if (e) {
        delete e.map;
        this.pushState(e)
    }
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Window.History, Wikimapia.EventTarget);
Wikimapia.Interface.Window.History.prototype = {
    pos: 0,
    omitNextState: false,
    storage: null,
    pushState: function (t) {
        if (!this.omitNextState) {
            if (this.hasNextState()) {
                this.storage.splice(this.pos, this.storage.length - this.pos)
            }
            delete t.map;
            this.pos = t.index = this.storage.length - 1;
            this.storage.push(t)
        }
        this.omitNextState = false
    },
    clear: function () {
        this.storage = [];
        this.pos = 0
    },
    forward: function () {
        if (this.hasNextState()) {
            this.pos++;
            this.omitNextState = true;
            window.router.route(this.storage[this.pos].url)
        }
    },
    back: function () {
        if (this.hasPreviousState()) {
            this.pos--;
            this.omitNextState = true;
            window.router.route(this.storage[this.pos].url)
        }
    },
    setPosition: function (t) {
        this.pos = t;
        return this
    },
    hasPreviousState: function () {
        return this.pos > 0
    },
    hasState: function (t) {
        var e = false;
        for (var i = 0, a = this.storage.length; i < a; i++) {
            if (i !== this.pos && this.storage[i].url === t) {
                e = true;
                break
            }
        }
        return e
    },
    getState: function (t) {
        var e = null;
        for (var i = 0, a = this.storage.length; i < a; i++) {
            if (this.storage[i].url === t) {
                e = this.storage[i];
                break
            }
        }
        return e
    },
    hasNextState: function () {
        return this.storage.length > 1 && this.pos < this.storage.length - 1
    },
    destroy: function () {
        this.clear();
        delete this.window
    }
};
Wikimapia.Interface.Window.Messenger = function (t) {
    var e = "message";
    this.win = t;
    this.onMessage = this.onMessage.bind(this);
    if ("addEventListener" in window) {
        window.addEventListener(e, this.onMessage, false)
    } else {
        window.attachEvent("on" + e, this.onMessage)
    }
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Window.Messenger, Wikimapia.EventTarget);
Wikimapia.Interface.Window.Messenger.prototype.win = null, Wikimapia.Interface.Window.Messenger.prototype.onMessage = function (t) {
    if (this.win.container && this.win.container.contentWindow && t.source === this.win.container.contentWindow && t.origin === Wikimapia.Utils.getLocationOrigin() && t.type === "message") {
        this.fireEvent("message", t)
    }
};
Wikimapia.Interface.Window.Messenger.prototype.destroy = function () {
    var t = "message";
    if ("addEventListener" in window) {
        window.removeEventListener(t, this.onMessage, false)
    } else {
        window.detachEvent("on" + t, this.onMessage)
    }
    delete this.win
};
Wikimapia.Interface.Window.Backdrop = function (t, e) {
    Wikimapia.Interface.prototype.constructor.call(this, {
        map: e
    });
    this.win = t;
    Wikimapia.Utils.Dom.inject(this.div, this.win.div, "before");
    Wikimapia.Utils.Dom.addClass(this.div, "modal-backdrop fade in");
    Wikimapia.Utils.bindHandlers(this, "show", "hide", "destroy", "onClick");
    this.win.addEvents({
        close: this.handlers.destroy,
        shown: this.handlers.show,
        hidden: this.handlers.hide
    });
    Wikimapia.Utils.Dom.addEvent(this.div, "click", this.handlers.onClick)
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Window.Backdrop, Wikimapia.Interface);
Wikimapia.Interface.Window.Backdrop.EDIT_RE = new RegExp("^\\/((user\\/edita(ccount|vatar))" + "|(object\\/category\\/\\?type=edit)" + "|(user\\/tools\\/ban\\/\\?action=start)" + "|(user\\/tools\\/ban\\/\\?action=show&id=$))", "i");
Wikimapia.Interface.Window.Backdrop.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
    name: "window-backdrop"
});
Wikimapia.Interface.Window.Backdrop.prototype.win = null;
Wikimapia.Interface.Window.Backdrop.prototype.canCloseByOuterClick = function () {
    var t = this.win.options.url;
    if (!t) {
        return true
    }
    var e = new RegExp("^\\/user\\/messages\\/\\?sid=" + this.map.access.getUserId(), "i");
    t = t.replace(Wikimapia.Utils.photoServerURL, "")
        .replace(window.location.protocol + "//" + window.location.hostname, "");
    if (Wikimapia.Interface.Window.Backdrop.EDIT_RE.test(t)) {
        return false
    } else if (e.test(t)) {
        var i = this.win.getContext()
            .document.getElementById("message-text-field");
        if (i && i.value !== "") {
            return false
        }
    }
    return true
};
Wikimapia.Interface.Window.Backdrop.prototype.onClick = function (t) {
    t.stop();
    if (this.win && this.canCloseByOuterClick()) {
        this.win.close()
    }
};
Wikimapia.Interface.Window.Backdrop.prototype.destroy = function () {
    delete this.win;
    Wikimapia.Interface.prototype.destroy.call(this)
};
Wikimapia.Interface.Panel = function (t, e) {
    if (t.map) {
        this.map = t.map;
        delete t.map
    }
    Wikimapia.Interface.prototype.constructor.call(this, t);
    Wikimapia.Utils.bindHandlers(this, "onLanguageChange", "onMapResize", "onWindowResize", "keyboard", "onMapAnimationComplete", "onMessage", "hide", "show");
    this.messenger = new Wikimapia.Interface.Window.Messenger(this);
    this.messenger.addEvent("message", this.onMessage.bind(this));
    this.draw();
    this.isDisplayed = false;
    this.setSize();
    this.isDisplayed = false;
    this.createContainer();
    if (this.options.url) {
        this.load(this.options.url)
    } else if (this.options.content) {
        this.setContent(this.options.content)
    }
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Panel, Wikimapia.Interface.Window);
Wikimapia.Interface.Panel.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.Window.prototype.options, {
    iframe: false,
    insideheader: false,
    name: "panel",
    size: new Wikimapia.Size(360, 470),
    printable: true,
    position: "right",
    transition: "easeOut",
    panelAnimationDuration: 100,
    mapAnimationDuration: 100
});
Wikimapia.Interface.Panel.prototype._ignoreMapResize = false;
Wikimapia.Interface.Panel.prototype.created = false;
Wikimapia.Interface.Panel.prototype.animation = null;
Wikimapia.Interface.Panel.prototype.mapAnimation = null;
Wikimapia.Interface.Panel.prototype.open = function (t) {
    if (is_changed) {
        Wikimapia.Interface.Dialog.confirm(Wikimapia.Lang.get("all.exit-editor"), function (t) {
            is_changed = false;
            this.open(t)
        }.bind(this, t), function () { });
        return false
    }
    var e = !!this.options.iframe;
    if (!t.menu) {
        delete this.options.menu
    }
    this.options = t = Wikimapia.Utils.extend({}, this.options, t);
    this.fireEvent("unload", this);
    this.addEventsFromOptions(this.options, true);
    if (this.container) {
        Wikimapia.Utils.Dom.removeEvents(this.container);
        this.container.hide()
    }
    if (this.request && this.request.isRunning()) {
        this.request.cancel();
        delete this.request
    }
    this.fullScreen(false);
    this.setLoading();
    this.setSize();
    if (t.content) {
        delete this.options.url;
        delete this.options.iframe
    }
    this.createContainer();
    if (t.content) {
        delete t.url;
        this.setContent(t.content)
    }
    if (t.url) {
        this.load(t.url)
    }
    return this
};
Wikimapia.Interface.Panel.prototype.draw = function () {
    var t = this.div;
    Wikimapia.Interface.prototype.draw.call(this);
    Wikimapia.Lang.addEvent("langChanged", this.handlers.onLanguageChange);
    this.map.addEvent("mapResized", this.handlers.onMapResize);
    Wikimapia.Utils.Dom.addEvent(document, "keydown", this.handlers.keyboard);
    Wikimapia.Utils.Dom.addEvent(window, "resize", this.handlers.onWindowResize);
    t.hide();
    Wikimapia.Utils.Dom.inject(t, this.map.containerDiv, "after");
    t.innerHTML = '<span id="jwindow3_body" style="display:none;"></span>'
};
Wikimapia.Interface.Panel.prototype.setSize = function (t) {
    this.size = t || this.options.size;
    var e, t = this.size,
        i = this.map;
    if (!i) return this;
    var a = i.getCurrentSize(),
        o = Wikimapia.Utils.Dom.getSize(window),
        n = null,
        s = false,
        r, p, l;
    if (/left|right/.test(this.options.position)) {
        t.h = o.y;
        e = {
            top: "0px",
            width: t.w + "px",
            height: t.h + 2 + "px"
        };
        l = this.options.position === "right" ? "left" : "right";
        p = this.map.getPanel(l);
        if (p && p.isDisplayed) {
            o.x -= p.options.size.w
        }
        if (this.isDisplayed) {
            r = parseInt(Wikimapia.Utils.Dom.getStyle(i.getElement(), "margin-" + this.options.position));
            if (r !== t.w || a.w !== o.x) {
                n = {
                    width: o.x - t.w
                };
                if (this.options.position === "left") {
                    n["margin-" + this.options.position] = t.w
                }
                s = true
            }
        } else {
            n = {
                width: o.x
            };
            if (o.x !== a.w) {
                s = true
            }
            e["margin-" + this.options.position] = -t.w + "px"
        }
    } else {
        l = this.options.position === "top" ? "bottom" : "top";
        p = this.map.getPanel(l);
        if (p && p.isDisplayed) {
            o.y -= p.options.size.h
        }
        t.w = o.x;
        e = {
            left: "0px",
            width: t.h + "px",
            height: t.h + "px"
        };
        if (this.isDisplayed) {
            r = parseInt(Wikimapia.Utils.Dom.getStyle(i.getElement(), "margin-" + this.options.position));
            if (r !== t.h || o.y !== a.h) {
                n = {
                    height: o.y - t.h
                };
                n["margin-" + this.options.position] = t.h;
                s = true
            }
        } else {
            e["margin-" + this.options.position] = -t.h + "px"
        }
    }
    e[this.options.position] = "0px";
    e["display"] = "block";
    if (n) {
        Wikimapia.Utils.Dom.setStyles(i.getElement(true), n);
        if (s) {
            i.updateSize()
        }
    }
    Wikimapia.Utils.Dom.setStyles(this.div, e);
    Wikimapia.Utils.Dom.addClass(this.div, "wm-panel panel-" + this.options.position);
    return this
};
Wikimapia.Interface.Panel.prototype.getContainerStyles = function (t) {
    var e = {
        width: this.size.w,
        height: this.size.h
    },
        i = this.options.insideheader || this.options.menu;
    if (t) {
        if (i) {
            e.height -= 70
        } else {
            e.height -= 30
        }
    } else {
        e.overflow = "auto";
        if (i) {
            e.height -= 70
        } else {
            e.height -= 30
        }
    }
    return e
};
Wikimapia.Interface.Panel.prototype.getIframeLoadHandler = function () {
    var t = this,
        e = this.map;
    this._iframeLoadHandler = this._iframeLoadHandler || function (e) {
        var i = /ONMOUSEOVER\=\"([!\s\w \-;:\.\,\(\)\[\]\'\"=<>\/&\?\\\{\}\+\u00A1-\uFFFF]+?)\"/,
            a;
        if (t.___created || Browser.firefox) {
            if (window.flphoar[20]) {
                a = window.flphoar[20].match(i)[1];
                if (a) {
                    a = app.parseJsResponse(a, true);
                    if (a) {
                        a = a.menuData;
                        t.map.placeOptions = {
                            mbr: a.mbr,
                            zoom: a.zoom,
                            currentLanguage: a.language
                        }
                    }
                }
            }
            t.fireEvent("load");
            t.container.show();
            delete t.___created;
            delete t._iframeLoadHandler;
            t.exposeToFrame()
        } else {
            t.___created = true
        }
        t.hideLoading()
    };
    return this._iframeLoadHandler
};
Wikimapia.Interface.Panel.prototype.createContainer = function () {
    var t = this.div.getAttribute("id"),
        e = this,
        i = this.getContainerStyles(this.options.iframe),
        a = this.map,
        o = {
            mouseenter: function (t) {
                e.fireEvent("mouseenter", t)
            },
            mouseleave: function (t) {
                e.fireEvent("mouseleave", t)
            }
        };
    if (this.options.iframe) {
        this.createIframeContainer(o, i)
    } else {
        this.createDivContainer(o, i)
    }
    if (this.options.insideheader || this.options.menu) {
        this.createHeader()
    }
    if (this.options.menu) {
        this.addMenu(this.options.menu)
    } else {
        this.menu && this.menu.destroy()
    }
    this.createPanelControls();
    this.fireEvent("create", this)
};
Wikimapia.Interface.Panel.prototype.createDivContainer = function (t, e) {
    if (this.container) {
        Wikimapia.Utils.Dom.destroy(this.container);
        delete this.container
    }
    this.container = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: "wm-" + Wikimapia.Utils.uniqueId("panel-content"),
        "class": "panel-content",
        styles: e,
        events: t
    }), this.div);
    this.container.show()
};
Wikimapia.Interface.Panel.prototype.createIframeContainer = function (t, e) {
    this.cancelRequest();
    delete this.request;
    if (this.container && this.container.tagName.toLowerCase() !== "iframe") {
        Wikimapia.Utils.Dom.destroy(this.container);
        delete this.___created;
        delete this.container
    }
    t.load = this.getIframeLoadHandler();
    if (!this.container) {
        this.container = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("iframe", {
            id: "wm-" + Wikimapia.Utils.uniqueId("iframe"),
            "class": "panel-content",
            frameborder: "no",
            name: this.options.frameName || "wm-" + Wikimapia.Utils.uniqueId("iframe"),
            styles: e,
            events: t
        }), this.div)
    } else {
        Wikimapia.Utils.Dom.setStyles(this.container, e);
        Wikimapia.Utils.Dom.addEvents(this.container, t)
    }
    this.container.setAttribute("name", this.options.frameName || "wm-" + Wikimapia.Utils.uniqueId("iframe"))
};
Wikimapia.Interface.Panel.prototype.createHeader = function () {
    var t = this.div,
        e = t.id + "-insideheader",
        i = document.getElementById(e) || Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
            id: e,
            "class": "wm-panel-insideheader"
        }), t, "top");
    Wikimapia.Utils.Dom.addClass(this.container, "panel-with-header");
    return i
};
Wikimapia.Interface.Panel.prototype.createPanelControls = function () {
    var t = this.div.id,
        e = document.getElementById(t + "-header");
    if (!e) {
        e = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
            id: t + "-header",
            "class": "wm-panel-header panel-header-" + this.options.position,
            html: ['<span class="control-button close" id="' + t + "-close-button" + '"">', '<span class="icon"></span></span>', '<span class="control-button hide" id="' + t + "-hide-button" + '">', '<span class="icon"></span></span>'].join("")
        }), this.div, "top");
        Wikimapia.Utils.Dom.addEvent(e, "click", function (t) {
            var e = t.target,
                i;
            if (/icon/.test(e.className)) {
                e = e.parentNode
            }
            i = e.className;
            if (/control-button/.test(i)) {
                if (/close/.test(i)) {
                    this.close()
                } else {
                    if (/hide/.test(i)) {
                        this.hide()
                    } else {
                        this.show()
                    }
                }
            }
        }.bind(this))
    }
};
Wikimapia.Interface.Panel.prototype.show = function (t) {
    if (this.options.initiallyClosed) {
        delete this.options.initiallyClosed;
        return this
    }
    if (this.isDisplayed) {
        Wikimapia.Utils.getCallback(t)(this);
        return this
    }
    var e = this.map.getElement(true),
        i = this.map.getCurrentSize();
    if (i.w < 1e3 || this.size && i.w < this.size.w + 700) {
        this.map.closeWindow()
    }
    var a = {
        duration: this.options.mapAnimationDuration
    },
        o = {
            duration: this.options.panelAnimationDuration
        },
        n;
    if (/left|right/.test(this.options.position)) {
        a["width"] = i.w - this.size.w;
        a["margin-" + this.options.position] = this.size.w;
        o["margin-" + this.options.position] = "+=" + this.size.w + "px";
        n = this.size.w
    } else {
        a["height"] = i.h - this.size.h
    }
    o.complete = function () {
        var e = document.getElementById(this.div.getAttribute("id") + "-hide-button");
        Wikimapia.Utils.Dom.switchClass(e, "show", "hide");
        Wikimapia.Utils.Dom.removeEvents(e, "click");
        Wikimapia.Utils.Dom.addEvent(e, "click", this.handlers.hide);
        Wikimapia.Utils.Dom.setStyles(this.container, {
            top: "",
            left: "",
            position: ""
        });
        this.container.show();
        if (this.div) {
            Wikimapia.Utils.Dom.removeClass(this.div, "panel-collapse")
        }
        this.fireEvent("shown", this);
        Wikimapia.Utils.getCallback(t)()
    }.bind(this);
    a.complete = this.handlers.onMapAnimationComplete;
    Wikimapia.Utils.Dom.setStyles(this.container, {
        top: 5e3,
        left: 5e3,
        position: "absolute"
    });
    this._ignoreMapResize = true;
    this.map.setCenter(this.map.fromContainerPixelToLatLng(new Wikimapia.Point((i.w + n) / 2, i.h / 2)));
    Wikimapia.Utils.Dom.addClass(this.div, "panel-collapse");
    setTimeout(function () {
        this.animation = Wikimapia.Utils.Dom.animate(this.div, o);
        this.mapAnimation = Wikimapia.Utils.Dom.animate(e, a)
    }.bind(this), 10);
    this.isDisplayed = true;
    return this
};
Wikimapia.Interface.Panel.prototype.hide = function (t) {
    if (!this.isDisplayed) {
        Wikimapia.Utils.getCallback(t)(this);
        return this
    }
    var e = this.map.getCurrentSize(),
        i = {
            duration: this.options.mapAnimationDuration,
            transition: this.options.transition
        },
        a = {
            duration: this.options.panelAnimationDuration,
            transition: this.options.transition
        },
        o;
    if (/left|right/.test(this.options.position)) {
        i["width"] = e.w + this.size.w;
        i["margin-" + this.options.position] = 0;
        a["margin-" + this.options.position] = "-=" + this.size.w + "px";
        o = this.options.position === "left" ? -this.size.w : this.size.w
    } else {
        i["height"] = e.h + this.size.h;
        a["margin-" + this.options.position] = -this.size.h
    }
    a.complete = function () {
        var e = document.getElementById(this.div.getAttribute("id") + "-hide-button");
        Wikimapia.Utils.Dom.switchClass(e, "hide", "show");
        Wikimapia.Utils.Dom.removeEvents(e, "click");
        Wikimapia.Utils.Dom.addEvent(e, "click", this.handlers.show);
        this.container.show();
        this.fireEvent("hidden");
        this.map.fireEvent("panelClosed");
        this.map.fireEvent("moveend");
        Wikimapia.Utils.getCallback(t)(this)
    }.bind(this);
    Wikimapia.Utils.Dom.addClass(this.div, "panel-collapse");
    i.complete = this.handlers.onMapAnimationComplete;
    this.container.hide();
    this._ignoreMapResize = true;
    setTimeout(function () {
        this.animation = Wikimapia.Utils.Dom.animate(this.div, a);
        this.mapAnimation = Wikimapia.Utils.Dom.animate(this.map.getElement(true), i)
    }.bind(this), 10);
    this.isDisplayed = false;
    return this
};
Wikimapia.Interface.Panel.prototype.hideAndClose = function () {
    this.hide(this.close.bind(this))
};
Wikimapia.Interface.Panel.prototype.close = function (t) {
    if (is_changed) {
        Wikimapia.Interface.Dialog.confirm(Wikimapia.Lang.get("all.exit-editor"), function (t) {
            is_changed = false;
            this.close(t)
        }.bind(this, t), function () { });
        return false
    }
    if (this.animation && this.mapAnimation) {
        this.animation.stop(true);
        this.mapAnimation.stop(true)
    }
    if (this.div) {
        var e = this.map,
            i = e.getCurrentSize(),
            a = {},
            o = this.isDisplayed ? this.size : new Wikimapia.Size(0, 0),
            n = e.getElement(true);
        if (/left|right/.test(this.options.position)) {
            a["margin-" + this.options.position] = 0;
            a["width"] = i.w + o.w + "px"
        } else {
            a["height"] = i.h + o.h + "px"
        }
        this.fireEvent("unload", this);
        Wikimapia.Utils.Dom.destroy(this.div);
        delete this.div;
        delete this.options.url;
        Wikimapia.Utils.Dom.setStyles(n, a);
        if (this.isDisplayed) {
            this.map.setCenter(this.map.fromContainerPixelToLatLng(new Wikimapia.Point(i.w / 2, i.h / 2)))
        }
        this.isDisplayed = false;
        this.onMapAnimationComplete();
        this.resetMapView();
        this.fireEvent("close")
    }
    this.destroy();
    return this
};
Wikimapia.Interface.Panel.prototype.load = function (t) {
    var e = this.div,
        i = this;
    this.show();
    this.cancelRequest();
    this.setLoading();
    this.fireEvent("loadstart", this);
    if (this.options.iframe) {
        this.container.hide();
        this.container.setAttribute("src", t);
        this.container.show()
    } else {
        if (!this.request) {
            this.request = new Wikimapia.Net.Xhr({
                method: "get",
                type: "html",
                evalScripts: false,
                onSuccess: this.onAjaxComplete.bind(this),
                onError: this.onAjaxError.bind(this)
            })
        }
        this.request.send({
            url: t
        })
    }
};
Wikimapia.Interface.Panel.prototype.setContent = function (t) {
    Wikimapia.Interface.Window.prototype.setContent.call(this, t);
    return this.show()
};
Wikimapia.Interface.Panel.prototype.addMenu = function (t) {
    if (this.menu) {
        this.menu.destroy();
        delete this.menu
    }
    if (t) {
        var e = Wikimapia.Utils.Dom.getElement(this.div, ".wm-panel-insideheader") || this.createHeader();
        this.menu = new Wikimapia.Interface.Menu(t, {
            name: "window-menu nav",
            submenuMaxHeight: this.size.h - 100
        }, {
            "margin-top": "34px",
            "margin-bottom": "1px"
        });
        Wikimapia.Utils.Dom.inject(this.menu.getElement(true), e, "bottom")
    }
    Wikimapia.Utils.Dom[this.menu ? "addClass" : "removeClass"](this.div, "panel-with-menu");
    return this.menu
};
Wikimapia.Interface.Panel.prototype.keyboard = function (t) {
    if (t.keyCode === Wikimapia.Utils.Event.keyCodes.ESC && !this.map.getWindow()) {
        this.close();
        t.stop()
    }
};
Wikimapia.Interface.Panel.prototype.onMapResize = function () {
    if (!this._ignoreMapResize && this.div && this.map) {
        var t = this.map.getCurrentSize(),
            e;
        if (/left|right/.test(this.options.position)) {
            this.size.h = t.h;
            if (this.options.insideheader || this.options.menu) {
                e = this.size.h - 70
            } else {
                e = this.size.h - 22
            }
            Wikimapia.Utils.Dom.setStyle(this.div, "height", this.size.h);
            if (this.container) {
                Wikimapia.Utils.Dom.setStyle(this.container, "height", e)
            }
        } else {
            this.size.w = t.w;
            Wikimapia.Utils.Dom.setStyle(this.div, "width", this.size.w)
        }
    }
};
Wikimapia.Interface.Panel.prototype.onWindowResize = function () {
    if (!this._isDisposed && !this._ignoreMapResize) {
        this.setSize()
    }
}, Wikimapia.Interface.Panel.prototype.onMapAnimationComplete = function (t) {
    var e = this.map.getCurrentSize(),
        i = e.w < this.map.getSize()
        .w ? new Wikimapia.Point(e.w / 2, e.h / 2) : new Wikimapia.Point(this.map.size.w / 2, this.map.size.h / 2),
        a = this.map.containerDiv;
    this.map._cacheContainerPosition();
    this.map.options.center = this.map.fromContainerPixelToLatLng(i);
    this.map._cacheCenterPx();
    this.map.updateSize(e);
    if (e.w < 800) {
        Wikimapia.Utils.Dom.addClass(a, "map-narrow")
    } else {
        Wikimapia.Utils.Dom.removeClass(a, "map-narrow")
    }
    this._ignoreMapResize = false;
    this.animation = null;
    this.mapAnimation = null;
    var o = this.map.getWindow();
    if (o) {
        o.resize()
    }
};
Wikimapia.Interface.Panel.prototype.resetMapView = function () {
    var t = this.map.getElement(true);
    if (/left|right/.test(this.options.position)) {
        if (!this.map.getPanel(this.options.position === "left" ? "right" : "left")) {
            Wikimapia.Utils.Dom.setStyle(t, "width", "100%")
        }
    } else {
        if (!this.map.getPanel(this.options.position === "top" ? "bottom" : "top")) {
            Wikimapia.Utils.Dom.setStyle(t, "height", "100%")
        }
    }
};
Wikimapia.Interface.Panel.prototype.getHeader = function () {
    return Wikimapia.Utils.Dom.getElement(this.div, ".wm-panel-insideheader")
};
Wikimapia.Interface.Panel.prototype.destroy = function () {
    if (this.animation) {
        this.animation.stop();
        delete this.animation
    }
    this.map.removeEvent("mapResized", this.handlers.onMapResize);
    Wikimapia.Utils.Dom.removeEvent(document, "keydown", this.handlers.keyboard);
    Wikimapia.Utils.Dom.removeEvent(window, "resize", this.handlers.onWindowResize);
    Wikimapia.Interface.Window.prototype.destroy.call(this)
};
Wikimapia.Interface.AutoComplete = function (t, e) {
    Wikimapia.Interface.prototype.constructor.call(this, t, this.options.defaultStyles);
    this.items = t.items || [];
    delete t.items;
    Wikimapia.Utils.Dom.addClass(this.div, "wm-noprint wm-autocomplete");
    this.configure();
    this.div.setAttribute("autocomplete", "off");
    Wikimapia.Lang.addEvent("tagsLoaded", this.handlers.onLanguageChange);
    this.request = new Wikimapia.Net.Xhr({
        type: "json",
        method: "get",
        onSuccess: this.onComplete.bind(this)
    });
    this._request = Wikimapia.Utils._throttle(this._request.bind(this), this.options.requestTimeout)
};
Wikimapia.Utils.inherits(Wikimapia.Interface.AutoComplete, Wikimapia.Interface);
Wikimapia.Interface.AutoComplete.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
    name: "AutoComplete",
    position: null,
    url: "",
    onComplete: Wikimapia.Utils.noop,
    items: [],
    maxItems: 15,
    parseItems: null,
    requestTimeout: 250,
    defaultValue: "",
    tagName: "input",
    defaultStyles: {
        position: "relative"
    }
});
Wikimapia.Interface.AutoComplete.prototype.request = null;
Wikimapia.Interface.AutoComplete.prototype.requestTimer = null;
Wikimapia.Interface.AutoComplete.prototype._disabled = false;
Wikimapia.Interface.AutoComplete.prototype.configure = function () {
    var t = Wikimapia.Lang.get("all." + this.options.defaultValue) || "",
        e = this.div;
    e.setAttribute("value", t);
    Wikimapia.Utils.Dom.addEvents(e, {
        focus: function (e) {
            if (this.getAttribute("value") === t) {
                this.setAttribute("value", "")
            }
        },
        keyup: this.onChange.bind(this),
        keydown: function (t) {
            t.stopPropagation()
        },
        click: function (t) {
            t.stopPropagation()
        }
    })
};
Wikimapia.Interface.AutoComplete.prototype.reconfigure = function () {
    var t = this.div;
    Wikimapia.Utils.Dom.removeEvents(t, "focus");
    Wikimapia.Utils.Dom.removeEvents(t, "keyup");
    Wikimapia.Utils.Dom.removeEvents(t, "keydown");
    this.configure()
};
Wikimapia.Interface.AutoComplete.prototype.onChange = function (t) {
    if (this._disabled) return;
    t.stopPropagation();
    var e = this.div.value;
    if (e === this.previousValue) {
        return
    }
    this.previousValue = e;
    if (this.request.isRunning()) {
        this.request.cancel()
    }
    if (e === "") {
        var i = this.getItems();
        this.fireEvent("update", [i])
    } else {
        this._request(e)
    }
};
Wikimapia.Interface.AutoComplete.prototype._request = function (t) {
    this.request.send({
        url: this.options.url.substitute({
            value: t
        })
    })
};
Wikimapia.Interface.AutoComplete.prototype.enable = function () {
    this._disabled = false
};
Wikimapia.Interface.AutoComplete.prototype.disable = function () {
    this._disabled = true;
    clearTimeout(this.requestTimer);
    if (this.request && this.request.isRunning()) {
        this.request.cancel()
    }
};
Wikimapia.Interface.AutoComplete.prototype.onComplete = function (t) {
    var e;
    if (typeof this.options.parseItems === "function") {
        e = this.options.parseItems(t, this.options.maxItems)
    }
    if (e && !this._disabled) {
        this.fireEvent("update", [e])
    }
};
Wikimapia.Interface.AutoComplete.prototype.getItems = function () {
    if ((!this.items || this.items.length == 0) && this.options.getDefaultItems) {
        this.items = this.options.getDefaultItems() || []
    }
    return this.items
};
Wikimapia.Interface.AutoComplete.prototype.onLanguageChange = function () {
    this.items = null;
    this.fireEvent("update", [this.getItems()])
};
Wikimapia.Interface.AutoComplete.prototype.destroy = function () {
    Wikimapia.Lang.removeEvent("tagsLoaded", this.handlers.onLanguageChange);
    Wikimapia.Interface.prototype.destroy.call(this)
};
(function () {
    var t = Wikimapia.Utils.appendFileVersion("/img/menu-spt.png"),
        e = Wikimapia.Net.Asset.image(t);
    Wikimapia.Interface.Menu = function (t, e, i) {
        Wikimapia.Interface.prototype.constructor.call(this, Wikimapia.Utils.extend({}, this.options, e), i);
        var a = this.div;
        Wikimapia.Utils.Dom.addClass(a, "wm-" + this.options.name);
        if (this.options.isContext) {
            Wikimapia.Utils.Dom.addClass(a, "context-menu")
        }
        Wikimapia.Utils.bindHandlers(this, "resolve", "hideMenu", "showMenu", "hideAll", "hideImmediately", "onEnterContainer");
        Wikimapia.Utils.Dom.addEvents(a, {
            mousemove: Wikimapia.Interface.onMouseMove,
            click: this.handlers.resolve,
            mouseenter: this.handlers.onEnterContainer,
            mouseleave: this.handlers.hideAll
        });
        Wikimapia.Utils.Dom.inject(this.create(t, 0, null, 0), this.div);
        this.itemsHash = t;
        if (this.options.autoDestroy) {
            this.hideDelayTimer = setTimeout(this.destroy.bind(this), this.options.destroyDelay)
        }
    };
    Wikimapia.Utils.inherits(Wikimapia.Interface.Menu, Wikimapia.Interface);
    Wikimapia.Interface.Menu.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
        name: "menu",
        structure: null,
        view: true,
        depth: 0,
        collapsible: true,
        hideDelay: 1e3,
        isContext: false,
        autoDestroy: false,
        destroyDelay: 3e3,
        destroyEventDelay: 5,
        hideMenuDelay: 500,
        horizontal: false,
        topLevelClass: "nav nav-pills",
        menuClass: "",
        submenuClass: "dropdown-menu",
        submenuItemClass: "dropdown",
        submenuMaxHeight: 0,
        baseTextSize: 12,
        listItemClass: ""
    });
    Wikimapia.Interface.Menu.prototype.hideDelayTimer = null;
    Wikimapia.Interface.Menu.prototype.hideMenuTimeout = null;
    Wikimapia.Interface.Menu.prototype.itemsHash = null;
    Wikimapia.Interface.Menu.prototype.minWidth = 30;
    Wikimapia.Interface.Menu.prototype.iconWidth = 35;
    Wikimapia.Interface.Menu.prototype.onEnterContainer = function () {
        clearTimeout(this.hideDelayTimer)
    };
    Wikimapia.Interface.Menu.prototype.resolve = function (t) {
        var e = Wikimapia.Utils.Dom.getParent(t.target, "li"),
            i, a;
        if (e.length === 0) return;
        i = e[0].className.split(" ")[0];
        a = this.getItemByPath(i);
        if (a.action || a.link) {
            if (a.link) {
                if (a.action) {
                    a.action(t)
                }
            } else if (a.action) {
                try {
                    a.action(t)
                } catch (o) { }
                t.stop()
            }
            this.hideImmediately(t)
        } else {
            t.stop()
        }
    };
    Wikimapia.Interface.Menu.prototype.getItemByPath = function (t) {
        if (typeof t === "string") {
            t = t.split("-")
                .slice(2)
        }
        var e = this.itemsHash,
            i;
        while (t.length > 0) {
            i = e[parseInt(t.shift())];
            e = i.items
        }
        return i
    };
    Wikimapia.Interface.Menu.prototype.decorateList = function (t, e) {
        if (e === 0) {
            Wikimapia.Utils.Dom.addClass(t, this.options.topLevelClass)
        } else {
            Wikimapia.Utils.Dom.addClass(t, this.options.submenuClass);
            if (this.options.submenuMaxHeight) {
                Wikimapia.Utils.Dom.addClass(t, "submenu-limited-height");
                Wikimapia.Utils.Dom.setStyle(t, "max-height", this.options.submenuMaxHeight)
            }
        }
    };
    Wikimapia.Interface.Menu.prototype.create = function (t, e, i, a) {
        var o = this,
            n, s, r, p, l = i ? Wikimapia.Utils.Dom.getElement(this.div, "ul.level-" + e) : Wikimapia.Utils.Dom.create("ul", {
                "class": "level-" + e + " " + this.options.menuClass
            }),
            c = {
                maxWidth: 0
            };
        this.decorateList(l, e);
        for (var h = 0, u = t.length; h < u; h++) {
            n = t[h];
            r = Wikimapia.Utils.Dom.create("li", {
                "class": ("n-" + a + "-" + h + " item-" + h + " " + this.options.listItemClass)
                    .trim()
            });
            if (n.divider) {
                Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.addClass(r, "divider"), l);
                continue
            }
            if (n.disabled) {
                Wikimapia.Utils.Dom.addClass(r, "disabled");
                n.action = Wikimapia.Utils.noop
            }
            p = this.createLink(n, e, c, h);
            Wikimapia.Utils.Dom.inject(p, r);
            if (e === 0 && this.options.horizontal) {
                Wikimapia.Utils.Dom.setStyle(r, "width", Wikimapia.Utils.Dom.getSize(r.firstChild)
                    .x + 5)
            }
            if (n.modifier) {
                n.items = n.modifier.getItems()
            }
            if (n.items) {
                p.innerHTML += '<b class="caret"></b>';
                Wikimapia.Utils.Dom.inject(this.create(n.items, e + 1, null, a + "-" + h), r);
                Wikimapia.Utils.Dom.addEvents(r, {
                    mouseenter: this.handlers.showMenu,
                    mouseleave: this.handlers.hideMenu
                });
                Wikimapia.Utils.Dom.addClass(r, this.options.submenuItemClass);
                if (n.modifier) {
                    this.addModifier(n.modifier, r, a, h, e)
                }
            }
            Wikimapia.Utils.Dom.inject(r, l)
        }
        if (c.maxWidth && e) {
            Wikimapia.Utils.Dom.setStyle(l, "width", c.maxWidth + 11 + "px")
        }
        return l
    };
    Wikimapia.Interface.Menu.prototype.addModifier = function (t, e, i, a, o) {
        var n, s = this,
            r = Wikimapia.Utils.Dom.getElement(e, ">ul"),
            p = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("li", {
                "class": ("n-" + i + "-" + a + " item-" + a + " " + this.options.listItemClass + " modifier")
                    .trim()
            }), r, "top"),
            l = parseInt(Wikimapia.Utils.Dom.getStyle(r, "width"));
        Wikimapia.Utils.Dom.inject(t.div, p);
        n = t.div;
        Wikimapia.Utils.Dom.setStyle(n, "width", "");
        t.reconfigure();
        Wikimapia.Utils.Dom.addEvent(n, "focus", function () {
            clearTimeout(s.hideDelayTimer)
        });
        if (this.handlers.updater) {
            t.removeEvent("update", this.handlers.updater)
        }
        this.handlers.updater = function (t) {
            var e = Wikimapia.Utils.Dom.getElements(r, "li"),
                i, a, o, l, c = [],
                h = {
                    maxWidth: 0
                },
                u = p.getAttribute("class")
                .split(" ")[0];
            s.getItemByPath(u)
                .items = t;
            for (i = 1, a = e.length; i < a; i++) {
                Wikimapia.Utils.Dom.destroy(e[i])
            }
            for (i = 0, a = t.length; i < a; i++) {
                o = Wikimapia.Utils.Dom.create("li", {
                    "class": (u + "-" + i + " item-" + i + " " + s.options.listItemClass)
                        .trim()
                });
                Wikimapia.Utils.Dom.inject(s.createLink(t[i], 2, h, i), o);
                Wikimapia.Utils.Dom.inject(o, r)
            }
            l = Math.max(200, h.maxWidth + 20);
            Wikimapia.Utils.Dom.setStyle(r, "width", l);
            Wikimapia.Utils.Dom.setStyle(n, "width", l - 12)
        };
        t.addEvent("update", this.handlers.updater)
    };
    Wikimapia.Interface.Menu.prototype.inject = function (t, e) {
        var i = this.itemsHash,
            a, o;
        e = typeof e !== "undefined" ? e : i.length;
        for (a = 2, o = arguments.length; a < o; a++) {
            i = i[arguments[a]].items
        }
        for (a = 0, o = t.length; a < o; a++) {
            i.splice(e + a, 0, t[a])
        }
        this.redraw();
        return this
    };
    Wikimapia.Interface.Menu.prototype.replace = function (t, e) {
        var i = this.itemsHash,
            a = arguments.length,
            o;
        if (a < 2) {
            return this
        }
        if (a > 2) {
            for (var n = 1, s = a - 1; n < s; n++) {
                i = i.items[arguments[n]]
            }
            if (i.items) {
                i = i.items
            }
            o = arguments[a - 1]
        } else {
            o = e
        }
        i.splice(o, 1, t);
        this.redraw();
        return this
    };
    Wikimapia.Interface.Menu.prototype.remove = function (t) {
        var e = this.itemsHash,
            i, a;
        if (typeof t === "undefined") {
            return this
        }
        for (i = 1, a = arguments.length; i < a; i++) {
            e = e[arguments[i]].items
        }
        if (e.length >= t) {
            e.splice(t, 1);
            this.redraw()
        }
        return this
    };
    Wikimapia.Interface.Menu.prototype.hideMenu = function (t) {
        clearTimeout(this.hideMenuTimeout);
        this.hideMenuTimeout = setTimeout(function () {
            var e = t.target.tagName.toLowerCase() === "li" ? $(t.target) : $(t.target)
                .getParent("li"),
                i = e.getElement("ul")[0];
            if (i) {
                Wikimapia.Utils.Dom.setStyles(i, {
                    display: "none",
                    visibility: ""
                })
            }
        }, this.options.hideMenuDelay)
    };
    Wikimapia.Interface.Menu.prototype.hideAll = function (t) {
        if (this.options.collapsible) {
            if (this.options.isContext && this.options.autoDestroy) {
                this.hideDelayTimer = setTimeout(this.destroy.bind(this), this.options.hideDelay)
            } else {
                var e = Wikimapia.Utils.Dom.getElements(this.div, "ul:not(.level-0)");
                clearTimeout(this.hideDelayTimer);
                this.hideDelayTimer = setTimeout(function () {
                    Wikimapia.Utils.Dom.setStyles(e, {
                        display: "none",
                        visibility: ""
                    })
                }, this.options.hideDelay)
            }
        }
    };
    Wikimapia.Interface.Menu.prototype.hideImmediately = function (t) {
        clearTimeout(this.hideDelayTimer);
        this.options.autoDestroy = true;
        if (this.options.collapsible && this.div) {
            if (this.options.isContext && this.options.autoDestroy) {
                this.destroy()
            } else {
                var e = Wikimapia.Utils.Dom.getElements(this.div, "ul:not(.level-0)");
                Wikimapia.Utils.Dom.setStyles(e, {
                    display: "none",
                    visibility: ""
                })
            }
        }
        return false
    };
    Wikimapia.Interface.Menu.prototype.showMenu = function (t) {
        clearTimeout(this.hideMenuTimeout);
        var e = t.target.tagName.toLowerCase() == "li" ? $(t.target) : $(t.target)
            .getParent("li"),
            i = e.getElement(">ul");
        if (i.length) {
            var a = Wikimapia.Utils.Dom.getElements(this.div, "ul." + i.getProperty("class")
                .split(" ")[0]);
            a.splice(a.indexOf(i), 1);
            Wikimapia.Utils.Dom.setStyles(a, {
                display: "none",
                visibility: ""
            });
            Wikimapia.Utils.Dom.setStyles(i, {
                display: "block",
                visibility: "visible"
            });
            clearTimeout(this.hideDelayTimer)
        }
    };
    Wikimapia.Interface.Menu.prototype.createLink = function (e, i, a, o) {
        var n = Wikimapia.Lang,
            s = n.get("all." + e.text) || e.text,
            r = this,
            p = Wikimapia.Utils.Dom.create("a", {
                "class": "",
                href: e.link || "javascript:void(0);",
                html: "<span>" + s.clean() + "</span>"
            }),
            l = Wikimapia.Utils.measureText(s, this.options.baseTextSize + "px", null, "normal") + 10;
        if (e.link) {
            p.setAttribute("target", e.target || "_blank")
        }
        if (e.icon) {
            var c = new Wikimapia.Icon({
                image: typeof e.icon.image !== "undefined" ? e.icon.image : t,
                imageSpritePos: e.icon.spritePos,
                imageSpriteClass: e.icon.imageSpriteClass,
                noEvents: true
            })
                .getElement();
            if (c.length) {
                c = c[0]
            }
            c.className = "menu-icon " + c.className;
            Wikimapia.Utils.Dom.inject(c, p, "top"), l += this.iconWidth
        }
        if (this.options.horizontal) {
            l = Math.max(l, this.minWidth);
            if (!i) {
                p.style.width = l + 12 + "px"
            }
        }
        a.maxWidth = Math.max(a.maxWidth, l);
        if (typeof e.action === "function" && e.confirm) {
            var h = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("span", {
                "class": "confirmation-block",
                id: String.hyphenate(e.text) + "-confirm",
                html: '<span class="confirm btn btn-primary">' + (n.get("all.ok") || "ok") + '</span> <span class="cancel btn">' + n.get("all.cancelbut") + "</span>"
            }), p),
                u = Wikimapia.Utils.Dom.getElement(h, "span.cancel"),
                m = function (t) {
                    Wikimapia.Utils.Dom.toggleClass(p, "confirm-open");
                    if (!Wikimapia.Utils.Dom.hasClass(t.target, "confirm")) {
                        t.stop();
                        return false
                    }
                };
            Wikimapia.Utils.Dom.addEvent(p, "click", m);
            Wikimapia.Utils.Dom.addEvent(u, "click", m)
        }
        return p
    };
    Wikimapia.Interface.Menu.prototype.redraw = function () {
        if (this.div) {
            this.div.innerHTML = "";
            Wikimapia.Utils.Dom.inject(this.create(this.itemsHash, 0, null, 0), this.div)
        }
    };
    Wikimapia.Interface.Menu.prototype.onLanguageChange = function () {
        this.redraw()
    };
    Wikimapia.Interface.Menu.prototype.getItems = function () {
        return this.itemsHash
    };
    Wikimapia.Interface.Menu.prototype.destroyInternal = function () {
        this._isDisposed = true;
        clearTimeout(this.hideDelayTimer);
        if (this.div) {
            Wikimapia.Utils.Dom.removeEvents(this.div, {
                mousemove: Wikimapia.Interface.onMouseMove,
                click: this.handlers.resolve,
                mouseenter: this.handlers.onEnterContainer,
                mouseleave: this.handlers.hideAll
            })
        }
        if (this.handlers.onLanguageChange) {
            Wikimapia.Lang.removeEvent("langChanged", this.handlers.onLanguageChange);
            delete this.handlers.onLanguageChange
        }
    };
    Wikimapia.Interface.Menu.prototype.destroy = function () {
        if (!this._isDisposed) {
            this.destroyInternal();
            Wikimapia.Interface.prototype.destroy.call(this)
        }
    }
})();
Wikimapia.Interface.ContextMenu = function (t, e, i) {
    e.isContext = true;
    Wikimapia.Interface.Menu.prototype.constructor.call(this, t, e, i);
    return this
};
Wikimapia.Utils.inherits(Wikimapia.Interface.ContextMenu, Wikimapia.Interface.Menu);
Wikimapia.Interface.ContextMenu.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.Menu.prototype.options, {
    topLevelClass: "nav dropdown-menu",
    autoDestroy: true
});
Wikimapia.Interface.ContextMenu.prototype.onRendered = function (t, e) {
    var i = 10,
        a = this.div,
        o = a.offsetWidth,
        n = a.offsetHeight;
    t.x += i;
    t.y += i;
    while (t.x + o > e.w) {
        t.x -= i * 2 + o
    }
    while (t.y + n > e.h) {
        t.y -= i + n
    }
    a.style.top = t.y + "px";
    a.style.left = t.x + "px";
    this.keyboardListener = this.keyboardListener.bind(this);
    Wikimapia.Utils.Dom.addEvent(document, "keyup", this.keyboardListener)
};
Wikimapia.Interface.ContextMenu.prototype.keyboardListener = function (t) {
    if (t.keyCode === Wikimapia.Utils.Event.keyCodes.ESC) {
        this.destroy()
    }
};
Wikimapia.Interface.ContextMenu.prototype.destroy = function () {
    if (!this._isDisposed) {
        Wikimapia.Utils.Dom.removeEvent(document, "keyup", this.keyboardListener);
        this.destroyInternal();
        this.fireEvent("beforeDestroy", this);
        setTimeout(Wikimapia.Interface.prototype.destroy.bind(this), this.options.destroyEventDelay)
    }
};
Wikimapia.Interface.Collapsible = function (t, e) {
    this.container = t;
    if (e && typeof e === "string") {
        this.prefix = e + "-"
    }
    Wikimapia.EventTarget.prototype.constructor.call(this);
    this.init();
    this.bindEvents()
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Collapsible, Wikimapia.EventTarget);
Wikimapia.Interface.Collapsible.prototype.container = null;
Wikimapia.Interface.Collapsible.prototype.transitionDuration = 100;
Wikimapia.Interface.Collapsible.prototype.prefix = ".accordion-";
Wikimapia.Interface.Collapsible.prototype.bindEvents = function () {
    Wikimapia.Utils.Dom.addEvent(this.container, "click", this.prefix + "heading", this.onHeaderClick.bind(this))
};
Wikimapia.Interface.Collapsible.prototype.init = function () {
    var t = Wikimapia.Utils.Dom.getElements(this.container, this.prefix + "body"),
        e, i;
    for (var a = 0, o = t.length; a < o; a++) {
        e = t[a];
        i = parseInt(e.getAttribute("data-height") || e.scrollHeight);
        if (Wikimapia.Utils.Dom.hasClass(e, "in")) {
            var n = Wikimapia.Utils.Dom.getElement("[data-target=" + e.id + "]");
            this.showBlock(n, e)
        } else {
            i = 0;
            Wikimapia.Utils.Dom.setStyle(e, "height", i)
        }
    }
};
Wikimapia.Interface.Collapsible.prototype.onHeaderClick = function (t) {
    this.toggleBlock(t.currentTarget)
};
Wikimapia.Interface.Collapsible.prototype.update = function () {
    var t = Wikimapia.Utils.Dom.getElements(this.container, this.prefix + "body"),
        e, i;
    for (var a = 0, o = t.length; a < o; a++) {
        e = t[a];
        i = parseInt(e.getAttribute("data-height") || e.scrollHeight);
        if (Wikimapia.Utils.Dom.hasClass(e, "in")) {
            var n = Wikimapia.Utils.Dom.getElement("[data-target=" + e.id + "]");
            this.showBlock(n, e)
        } else {
            i = 0;
            Wikimapia.Utils.Dom.setStyle(e, "height", i)
        }
    }
};
Wikimapia.Interface.Collapsible.prototype.showBlock = function (t, e) {
    var i = parseInt(e.getAttribute("data-height") || e.scrollHeight);
    Wikimapia.Utils.Dom.addClass(t, "in");
    Wikimapia.Utils.Dom.addClass(e, "in");
    Wikimapia.Utils.Dom.setStyle(e, "height", i);
    this.fireEvent("show");
    setTimeout(function () {
        Wikimapia.Utils.Dom.removeClass(e, "no-scroll");
        this.fireEvent("changed");
        this.fireEvent("shown")
    }.bind(this), this.transitionDuration)
};
Wikimapia.Interface.Collapsible.prototype.hideBlock = function (t, e) {
    Wikimapia.Utils.Dom.removeClass(t, "in");
    Wikimapia.Utils.Dom.removeClass(e, "in");
    Wikimapia.Utils.Dom.addClass(e, "no-scroll");
    Wikimapia.Utils.Dom.setStyle(e, "height", 0);
    this.fireEvent("hide");
    setTimeout(function () {
        this.fireEvent("changed");
        this.fireEvent("hidden")
    }.bind(this), this.transitionDuration)
};
Wikimapia.Interface.Collapsible.prototype.toggleBlock = function (t) {
    this[Wikimapia.Utils.Dom.hasClass(t, "in") ? "hideBlock" : "showBlock"](t, document.getElementById(t.getAttribute("data-target")))
};
Wikimapia.Interface.Collapsible.prototype.destroy = function () {
    Wikimapia.Utils.Dom.removeEvents(this.container, "click");
    delete this.container;
    delete this.prefix
};
Wikimapia.Interface.Progressbar = function (t, e) {
    this.map = t;
    Wikimapia.EventTarget.prototype.constructor.call(this);
    this.render();
    this.setProgress(e || this.progress)
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Progressbar, Wikimapia.Interface);
Wikimapia.Interface.Progressbar.CSS_ID = "wm-progressbar";
Wikimapia.Interface.Progressbar.prototype.map = null;
Wikimapia.Interface.Progressbar.prototype.element = null;
Wikimapia.Interface.Progressbar.prototype.progress = 0;
Wikimapia.Interface.Progressbar.prototype.render = function () {
    this.element = Wikimapia.Utils.Dom.create("div", {
        id: Wikimapia.Utils.uniqueId(Wikimapia.Interface.Progressbar.CSS_ID),
        "class": "progressbar"
    })
};
Wikimapia.Interface.Progressbar.getProgress = function () {
    return +this.progress
};
Wikimapia.Interface.Progressbar.prototype.setProgress = function (t) {
    this.progress = Wikimapia.Utils.Math.normalize(t, 0, 100);
    this._setProgress(this.progress)
};
Wikimapia.Interface.Progressbar.prototype._setProgress = function (t) {
    this.element.style.width = t + "%";
    if (t === 0) {
        Wikimapia.Utils.Dom.addClass(this.element, "start");
        Wikimapia.Utils.Dom.removeClass(this.element, "finish")
    } else {
        if (t === 100) {
            Wikimapia.Utils.Dom.addClass(this.element, "finish")
        } else {
            Wikimapia.Utils.Dom.removeClass(this.element, "finish")
        }
    }
};
Wikimapia.Interface.Progressbar.prototype.destroy = function () {
    this.element.destroy();
    delete this.map
};
Wikimapia.Interface.Notification = function (t) {
    Wikimapia.Interface.prototype.constructor.call(this, t);
    this.hideTimer = null;
    this.onClick = this.onClick.bind(this);
    this.onNotification = this.onNotification.bind(this);
    this.hide = this.hide.bind(this);
    this.inject(document.getElementById(this.map.layersContainer))
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Notification, Wikimapia.Interface);
Wikimapia.Interface.Notification.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
    name: "notification",
    message: "",
    hidden: true,
    hideTimeout: 4e3,
    hideOnClick: true
});
Wikimapia.Interface.Notification.prototype.draw = function () {
    Wikimapia.Utils.Dom.addClass(this.div, "wm-notification notification");
    this.div.innerHTML = '<div class="notification-inner"></div>';
    this.map.addEvents({
        notification: this.onNotification
    })
};
Wikimapia.Interface.Notification.prototype.show = function (t, e, i, a) {
    var o = Wikimapia.Utils.Dom.getElement(this.div, ".notification-inner");
    o.innerHTML = this.formatMessage(t);
    Wikimapia.Interface.prototype.show.call(this);
    this.setPosition();
    if (i) {
        Wikimapia.Utils.Dom.addEvent(this.div, "click", this.onClick)
    }
    window.clearTimeout(this.hideTimer);
    if (e) {
        this.hideTimer = window.setTimeout(this.hide, e)
    }
    if (a) {
        a(this)
    }
};
Wikimapia.Interface.Notification.prototype.onNotification = function (t) {
    if (t == null) {
        this.hide()
    } else if (t.message) {
        this.show(t.message, t.timeout === undefined ? this.options.hideTimeout : t.timeout, t.hideOnClick === undefined ? this.options.hideOnClick : t.hideOnClick, t.onShow)
    }
};
Wikimapia.Interface.Notification.prototype.setPosition = function () {
    var t = Wikimapia.Utils.Dom.getSize(this.div);
    Wikimapia.Utils.Dom.setStyles(this.div, {
        "margin-top": Math.floor(-t.y / 2),
        "margin-left": Math.floor(-t.x / 2)
    })
};
Wikimapia.Interface.Notification.prototype.formatMessage = function (t) {
    return Wikimapia.Lang.get(t) || t
};
Wikimapia.Interface.Notification.prototype.onClick = function (t) {
    t.stop();
    this.hide()
};
Wikimapia.Interface.Notification.prototype.hide = function () {
    Wikimapia.Interface.prototype.hide.call(this);
    window.clearTimeout(this.hideTimer);
    Wikimapia.Utils.Dom.removeEvent(this.div, "click", this.onClick)
};
Wikimapia.Interface.Notification.prototype.destroy = function () {
    this.map.removeEvents({
        notification: this.onNotification
    })
};
if (!"Wikimapia" in this) {
    Wikimapia = {}
}
if (!"Interface" in Wikimapia) {
    Wikimapia.Interface = {}
}
Wikimapia.Interface.Dialog = function () { };
Wikimapia.Interface.Dialog.prototype = {
    _element: null,
    getElement: function () {
        return Alertify.dialog.el
    },
    setPosition: function () {
        var t = this.getElement(),
            e = Wikimapia.Utils.Dom.getSize(t),
            i = Wikimapia.Utils.Dom.getPosition(t),
            a = Math.floor(-e.y / 2);
        Wikimapia.Utils.Dom.setStyle(t, "margin-top", a)
    },
    setButtonText: function (t, e) {
        Alertify.dialog.labels.ok = Wikimapia.Lang.get(t || "") || "OK";
        Alertify.dialog.labels.cancel = Wikimapia.Lang.get(e || "all.cancelbut")
    },
    setTemplates: function (t) {
        t = t || Wikimapia.Interface.Dialog.templates;
        Wikimapia.Utils.extend(Alertify.dialog.dialogs, t)
    },
    prompt: function (t, e, i, a, o, n) {
        Wikimapia.Interface.Dialog.setButtonText(o, n);
        this.setTemplates();
        Alertify.dialog.prompt(t, e, i, a);
        this.setPosition()
    },
    confirm: function (t, e, i, a, o) {
        Wikimapia.Interface.Dialog.setButtonText(a, o);
        this.setTemplates();
        Alertify.dialog.confirm(t, e, i);
        this.setPosition()
    },
    alert: function (t, e, i, a) {
        Wikimapia.Interface.Dialog.setButtonText(i, a);
        this.setTemplates();
        Alertify.dialog.alert(t, e);
        this.setPosition()
    },
    custom: function (t, e, i) {
        i = i || {};
        var a = Wikimapia.Utils.cloneObject(Alertify.dialog.dialogs),
            o = Wikimapia.Utils.cloneObject(Wikimapia.Interface.Dialog.templates),
            n = Wikimapia.Utils.merge(o, i);
        this.setTemplates(n);
        Alertify.dialog.confirm(t, e);
        this.setPosition()
    }
};
Wikimapia.Interface.Dialog = new Wikimapia.Interface.Dialog;
Wikimapia.Interface.Dialog.templates = {
    buttons: {
        holder: '<nav class="alertify-buttons">{{buttons}}</nav>',
        submit: '<button role="button" type="submit" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</button>',
        ok: '<button role="button" type="button" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</button>',
        cancel: '<button role="button" type="button" class="alertify-button alertify-button-cancel" id="alertify-cancel">{{cancel}}</button>'
    },
    input: '<div class="alertify-text-wrapper"><input type="text" class="alertify-text" id="alertify-text"></div>',
    message: '<p class="alertify-message">{{message}}</p>',
    log: '<article class="alertify-log{{class}}">{{message}}</article>'
};
Wikimapia.Interface.Spinner = function (t, e) {
    this.container = t || Wikimapia.Utils.Dom.create("div");
    this._spinner = Wikimapia.Interface.Spinner.setLoading(this.container, e)
};
Wikimapia.Interface.Spinner.prototype.container = null;
Wikimapia.Interface.Spinner.prototype._spinner = null;
Wikimapia.Interface.Spinner.prototype.destroy = function () {
    if (this._spinner) {
        this._spinner.stop();
        delete this._spinner
    }
    delete this.container
};
Wikimapia.Interface.Spinner.defaultOptions = {
    lines: 13,
    length: 20,
    width: 10,
    radius: 30,
    rotate: 0,
    corners: 1,
    color: "#000",
    direction: 1,
    speed: 1,
    trail: 60,
    opacity: 1 / 4,
    fps: 20,
    zIndex: 2e9,
    className: "spinner",
    top: "50%",
    left: "50%",
    position: "relative"
};
Wikimapia.Interface.Spinner.setLoading = function (t, e) {
    e = Wikimapia.Utils.extend({}, Wikimapia.Interface.Spinner.defaultOptions, e || {});
    return new Spinner(e)
        .spin(t)
};
Wikimapia.Interface.Log = function () { };
Wikimapia.Interface.Log.prototype = {
    info: function (t, e) {
        return Alertify.log.info(t, e)
    },
    error: function (t, e) {
        return Alertify.log.error(t, e)
    }
};
Wikimapia.Interface.Log = new Wikimapia.Interface.Log;
Wikimapia.Interface.Select = function (t) {
    Wikimapia.Interface.prototype.constructor.call(this, t);
    if (this.options.closeButton) {
        this.addCloseButton()
    }
    if (this.options.input) {
        this.addInput(this.options.input);
        delete this.options.input
    }
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Select, Wikimapia.Interface);
Wikimapia.Interface.Select.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
    name: "select",
    input: false,
    url: null,
    onSelect: Wikimapia.Utils.noop,
    onSearch: Wikimapia.Utils.noop,
    linkTemplate: '<a href="#">{value}</a>',
    listClass: "nav dropdown-menu",
    closeButton: false,
    collapsible: false,
    timeout: 300,
    requestType: "json",
    getRequestUrl: function (t, e) {
        return t
    }
});
Wikimapia.Interface.Select.prototype.request = null;
Wikimapia.Interface.Select.prototype.shown = false;
Wikimapia.Interface.Select.prototype.current = -1;
Wikimapia.Interface.Select.prototype.addCloseButton = function () {
    Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("span", {
        "class": "close",
        html: "&times;",
        events: {
            click: this.destroy.bind(this)
        }
    }), this.div)
};
Wikimapia.Interface.Select.prototype.addInput = function (t) {
    t = t ? t : Wikimapia.Utils.Dom.create("input", {
        type: "text"
    });
    if (t.parentNode !== this.div) {
        Wikimapia.Utils.Dom.inject(t, this.div)
    }
    if (t.getAttribute("type") === "text") {
        Wikimapia.Utils.Dom.removeEvents(t, "click");
        Wikimapia.Utils.Dom.addEvents(t, {
            keyup: function (e) {
                if (this.keybordHandler(e)) {
                    this.fireEvent("search", t);
                    this.render(undefined, t.value)
                }
            }.bind(this),
            focus: function () {
                this.render()
            }.bind(this),
            blur: function () {
                setTimeout(this.hideList.bind(this), this.options.timeout)
            }.bind(this)
        })
    } else {
        Wikimapia.Utils.Dom.addEvent(t, "click", this.render.bind(this))
    }
    this.input = t
};
Wikimapia.Interface.Select.prototype.keybordHandler = function (t) {
    var e = false;
    switch (t.keyCode) {
        case Wikimapia.Utils.Event.keyCodes.ENTER:
            t.preventDefault();
            this.selectCurrent();
            break;
        case Wikimapia.Utils.Event.keyCodes.TAB:
        case Wikimapia.Utils.Event.keyCodes.ESC:
            t.preventDefault();
            this.hideList();
            break;
        case Wikimapia.Utils.Event.keyCodes.UP:
            t.preventDefault();
            this.prev();
            e = true;
            break;
        case Wikimapia.Utils.Event.keyCodes.DOWN:
            t.preventDefault();
            this.next();
            e = true;
            break;
        default:
            e = true;
            break
    }
    return e
};
Wikimapia.Interface.Select.prototype.hideList = function (t) {
    this.current = -1;
    if (this.list) {
        this.list.hide()
    }
    this.shown = false
}, Wikimapia.Interface.Select.prototype.prev = function () {
    if (this.shown && this.options.items) {
        this.current = Math.min(Math.max(0, this.current - 1), this.options._items.length)
    }
};
Wikimapia.Interface.Select.prototype.next = function () {
    if (this.shown && this.options.items) {
        this.current = Math.max(0, Math.min(this.options._items.length - 1, this.current + 1))
    }
};
Wikimapia.Interface.Select.prototype.selectCurrent = function () {
    if (this.current !== -1) {
        this.selectItem(this.current)
    }
};
Wikimapia.Interface.Select.prototype.render = function (t) {
    var e = "";
    t = t || this.options.items;
    if (this.input && this.input.type === "text") {
        e = this.input.value
    }
    if (t) {
        this.createOptions(t, e);
        this.fireEvent("render", t)
    } else {
        if (this.options.url) {
            this.requestItems(this.options.url, e)
        }
    }
};
Wikimapia.Interface.Select.prototype.requestItems = function (t, e) {
    if (!this.request) {
        this.request = new Wikimapia.Net.Xhr({
            type: this.options.requestType,
            method: "get"
        })
    }
    this.request.send({
        url: this.options.getRequestUrl(t, e),
        onSuccess: function (t) {
            this.createOptions(t, e)
        }.bind(this)
    })
};
Wikimapia.Interface.Select.prototype.createOptions = function (t, e) {
    var i = Wikimapia.Utils.Dom.getElement(this.div, "ul." + this.options.listClass.replace(" ", ".")),
        a = e ? new RegExp("(" + e + ")", "i") : null,
        o = "",
        n = true;
    if (!i) {
        i = Wikimapia.Utils.Dom.create("ul", {
            "class": this.options.listClass
        });
        if (this.input) {
            Wikimapia.Utils.Dom.inject(i, this.input, "after")
        } else {
            Wikimapia.Utils.Dom.inject(i, this.div)
        }
        Wikimapia.Utils.Dom.addEvent(i, "click", function (t) {
            var e = t.target;
            t.stop();
            if (e.tagName !== "li") {
                e = $(e)
                    .getParent("li")[0]
            }
            this.selectItem(Wikimapia.Utils.Dom.getAllPrevious(e, "li")
                .length)
        }.bind(this))
    }
    this.list = i;
    if (e) {
        t = this.sort(t.slice(), e)
    }
    this.options._items = t;
    for (var s = 0, r = t.length; s < r; s++) {
        var p = t[s],
            l = p.value.toString();
        if (l.match(a)) {
            p.value = l.replace(a, "<strong>$1</strong>");
            n = false
        }
        o += '<li class="' + (this.current === s ? "active " : "");
        if (p.disabled) o += "disabled ";
        o += '{optClass}" data-num="' + s + '">';
        o += this.options.linkTemplate + "</li>";
        o = o.substitute(p);
        p.value = l
    }
    i.innerHTML = o;
    i.show();
    this.shown = true;
    if (n) {
        this.fireEvent("newoption", e)
    }
};
Wikimapia.Interface.Select.prototype.selectItem = function (t) {
    var e = this.options._items[t];
    if (!e.disabled) {
        this.fireEvent("select", e);
        if (this.input && this.input.type === "text") {
            $(this.input)
                .setValue(e.value)
        }
        this.hideList()
    }
};
Wikimapia.Interface.Select.prototype.sort = function (t, e) {
    var i = [],
        a = [],
        o = [],
        n, s;
    while (n = t.shift()) {
        s = n.value;
        if (!s.toLowerCase()
            .indexOf(e.toLowerCase())) i.push(n);
        else if (~s.indexOf(e)) a.push(n);
        else o.push(n)
    }
    return i.concat(a, o)
};
Wikimapia.Interface.Statusbar = function (t) {
    Wikimapia.Interface.prototype.constructor.call(this, t);
    if (Wikimapia.Utils.isEmbedded()) {
        this.options.position = Wikimapia.Interface.Statusbar.positionType.BOTTOM
    }
    Wikimapia.Utils.Dom.addClass(this.div, "status-bar " + "status-bar-" + this.options.position);
    this.content = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        "class": "content"
    }), this.div, "bottom");
    this.isDisplayed = false;
    Wikimapia.Utils.Dom.inject(this.div, this.map.getControlsContainer());
    this.onMapResized = this.onMapResized.bind(this);
    this.map.addEvents({
        mapResized: this.onMapResized,
        resizeComplete: this.onMapResized
    })
};
Wikimapia.Utils.inherits(Wikimapia.Interface.Statusbar, Wikimapia.Interface);
Wikimapia.Interface.Statusbar.views = {
    BALOON: 1,
    RIBBON: 2
};
Wikimapia.Interface.Statusbar.moveDirection = {
    UP: 1,
    DOWN: 2
};
Wikimapia.Interface.Statusbar.prototype.ui = {}, Wikimapia.Interface.Statusbar.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.prototype.options, {
    name: "status-bar",
    position: "top",
    animationDuration: 100,
    animationTransition: "easeOutStrong"
});
Wikimapia.Interface.Statusbar.prototype.animation = null;
Wikimapia.Interface.Statusbar.prototype.init = function (t) {
    t = t || {};
    var e, i, a, o;
    this.clear();
    if (t.icon) {
        var n = t.icon;
        if (!Wikimapia.Utils.isElement(n)) {
            n.getElement();
            n = n.image
        }
        this.grab(Wikimapia.Utils.Dom.addClass(n, "status-icon"))
    }
    t.message = t.message || t.getStatus && t.getStatus();
    if (t.message) {
        a = Wikimapia.Utils.Dom.create("div", {
            "class": "status-text lead",
            html: t.message
        });
        this.grab(a)
    }
    if (t.onSave) {
        t.saveText = t.saveText || "savebut";
        i = Wikimapia.Utils.Dom.create("input", {
            type: "button",
            "class": "btn btn-primary" + (Wikimapia.Utils.isEmbedded() ? " btn-mini" : ""),
            id: "save-button",
            value: Wikimapia.Lang.get("all." + t.saveText),
            events: {
                click: this.getButtonPressHandler(t.onSave)
            }
        });
        if (typeof t.allowSaveByDefault == "undefined") {
            t.allowSaveByDefault = false
        }
        Wikimapia.Utils.Dom.data(i, "allowed", t.allowSaveByDefault);
        if (!t.allowSaveByDefault) {
            i.setAttribute("disabled", true)
        }
    }
    if (t.onCancel) {
        t.cancelText = t.cancelText || "cancelbut";
        e = Wikimapia.Utils.Dom.create("input", {
            type: "button",
            "class": "btn" + (Wikimapia.Utils.isEmbedded() ? " btn-mini" : ""),
            id: "cancel-polygon-button",
            value: Wikimapia.Lang.get("all." + t.cancelText),
            events: {
                click: this.getButtonPressHandler(t.onCancel)
            }
        })
    }
    if (i || e) {
        var s = Wikimapia.Utils.Dom.create("div", {
            "class": "buttons-block"
        });
        if (i) s.appendChild(i);
        if (e) s.appendChild(e);
        this.grab(s)
    }
    o = t.summary ? this.addSummaryField() : null;
    if (this.langChangeHandler) {
        Wikimapia.Lang.removeEvent("langChanged", this.langChangeHandler)
    }
    this.langChangeHandler = this.onLanguageChange.bind(this);
    Wikimapia.Lang.addEvent("langChanged", this.langChangeHandler);
    this.ui = {
        cancelButton: e,
        saveButton: i,
        statusMessage: a,
        summary: o,
        getStatus: t.getStatus
    };
    this.div.toggled = false;
    this.show();
    Wikimapia.Utils.Dom.data(this.div, "initialWidth", Wikimapia.Utils.Dom.getSize(this.div)
        .x);
    this.map.fireEvent("statusUpdated", this)
};
Wikimapia.Interface.Statusbar.prototype.getButtonPressHandler = function (t) {
    return function (e) {
        this.blur();
        return t(e)
    }
};
Wikimapia.Interface.Statusbar.prototype.calculateHeight = function (t) {
    this.height = this.content.scrollHeight;
    if (Wikimapia.Utils.isEmbedded()) this.height = 30
};
Wikimapia.Interface.Statusbar.prototype.onLanguageChange = function () {
    if (typeof this.ui.getStatus === "function") {
        this.ui.statusMessage.innerHTML = this.ui.getStatus()
    }
    this.ui.cancelButton && this.ui.cancelButton.setAttribute("value", Wikimapia.Lang.get("all.cancelbut"));
    this.ui.saveButton && this.ui.saveButton.setAttribute("value", Wikimapia.Lang.get("all.savebut"));
    this.ui.summary && Wikimapia.Lang.localize(this.ui.summary)
};
Wikimapia.Interface.Statusbar.prototype.addSummaryField = function () {
    var t = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("form", {
        id: "summary-field",
        html: ['<span id="open-summary" l10n="history-revision-comment-open"></span>', '<span id="summary-block" class="hidden">', '<input type="text" id="editsummary" name="revision_comment" ', 'l10n="history-revision-comment-title" /></span>'].join("")
    }), this.content, "top");
    Wikimapia.Utils.Dom.addEvent(document.getElementById("open-summary"), "click", this.toggleSummary.bind(this));
    Wikimapia.Lang.localize(t);
    Wikimapia.Utils.Dom.addEvents(document.getElementById("editsummary"), {
        focus: function () {
            if (this.value === Wikimapia.Lang.get("all." + this.getProperty("l10n"))) {
                this.setValue("")
            }
        },
        blur: function () {
            if (this.value === "") {
                this.setValue(Wikimapia.Lang.get("all." + this.getProperty("l10n")))
            }
        }
    });
    this.height += 34;
    return t
};
Wikimapia.Interface.Statusbar.prototype.collectSummary = function () {
    var t = document.getElementById("editsummary"),
        e = {};
    if (t && t.value && t.value !== Wikimapia.Lang.get("all." + t.getProperty("l10n"))) {
        e = {
            revision_comment: t.value.clean()
        };
        this.div.toggled = true;
        this.toggleSummary()
    }
    return e
};
Wikimapia.Interface.Statusbar.prototype.toggleSummary = function () {
    var t = !this.div.toggled,
        e = t ? "98px" : "64px",
        i = document.getElementById("summary-block");
    Wikimapia.Utils.Dom.setStyle(this.div, "height", e);
    this.div.toggled = t;
    Wikimapia.Utils.Dom.toggleClass(i, "hidden");
    Wikimapia.Utils.Dom.toggleClass(i, "shown");
    if (!t) {
        document.getElementById("editsummary")
            .value = Wikimapia.Lang.get("all." + input.getProperty("l10n"))
    }
    this.adjustSize()
};
Wikimapia.Interface.Statusbar.prototype.setStatusMessage = function (t) {
    var e = this.ui.statusMessage,
        i, a;
    if (!e) {
        this.ui.statusMessage = e = Wikimapia.Utils.Dom.create("div", {
            "class": "status-text",
            html: t
        });
        this.grab(e)
    } else {
        e.innerHTML = t
    }
    if (this.isDisplayed) {
        this.show()
    } else {
        this.adjustSize()
    }
};
Wikimapia.Interface.Statusbar.prototype.onMapResized = function () {
    if (this.isDisplayed) {
        this.show()
    } else {
        this.adjustSize()
    }
};
Wikimapia.Interface.Statusbar.prototype.adjustSize = function () {
    var t = Wikimapia.Utils.Dom.getElement(this.div, ".buttons-block"),
        e = this.map.getSize(),
        i = Wikimapia.Utils.Dom.getSize(window)
        .x,
        a;
    if (this.isDisplayed) {
        if (e.w === i && !Wikimapia.Utils.isEmbedded()) {
            Wikimapia.Utils.Dom.addClass(this.div, "baloon");
            this.calculateHeight();
            if (this.view === Wikimapia.Interface.Statusbar.views.RIBBON) {
                this.moveMapControls(Wikimapia.Interface.Statusbar.moveDirection.UP)
            }
            this.view = Wikimapia.Interface.Statusbar.views.BALOON
        } else {
            Wikimapia.Utils.Dom.removeClass(this.div, "baloon");
            this.calculateHeight();
            this.view = Wikimapia.Interface.Statusbar.views.RIBBON
        }
        if (!Wikimapia.Utils.isEmbedded()) {
            if (this.view === Wikimapia.Interface.Statusbar.views.RIBBON) {
                this.moveMapControls(Wikimapia.Interface.Statusbar.moveDirection.DOWN)
            } else {
                this.moveMapControls(Wikimapia.Interface.Statusbar.moveDirection.UP)
            }
        }
    }
    a = Wikimapia.Utils.Dom.getSize(this.div)
        .x;
    if (this.view === Wikimapia.Interface.Statusbar.views.BALOON) {
        Wikimapia.Utils.Dom.setStyle(this.div, "margin-left", -a / 2)
    } else {
        Wikimapia.Utils.Dom.setStyle(this.div, "margin-left", "")
    }
};
Wikimapia.Interface.Statusbar.prototype.addButton = function (t) {
    var e = Wikimapia.Utils.Dom.getElement(this.div, ".buttons-block");
    Wikimapia.Utils.Dom.inject(t, e);
    this.adjustSize();
    return this
};
Wikimapia.Interface.Statusbar.prototype.getText = function () {
    return this.ui.statusMessage ? this.ui.statusMessage.innerHTML : ""
};
Wikimapia.Interface.Statusbar.prototype.toggleSave = function (t) {
    var e = this.ui.saveButton;
    if (e) {
        var i = Wikimapia.Utils.Dom.data(e, "allowed");
        if (typeof t == "undefined") {
            t = !i
        }
        Wikimapia.Utils.Dom.data(e, "allowed", t);
        if (t != i) {
            if (t) {
                e.removeAttribute("disabled");
                Wikimapia.Utils.Dom.animate(e, {
                    "padding-left": "+=5",
                    "padding-right": "+=5",
                    duration: 200
                });
                Wikimapia.Utils.Dom.addClass(e, "btn-glow")
            } else {
                e.setAttribute("disabled", true);
                Wikimapia.Utils.Dom.animate(e, {
                    "padding-left": "-=5",
                    "padding-right": "-=5",
                    duration: 200
                });
                Wikimapia.Utils.Dom.removeClass(e, "btn-glow")
            }
        }
    }
};
Wikimapia.Interface.Statusbar.prototype.toggleCancel = function (t) {
    var e = this.ui.cancelButton;
    if (e) {
        e[t ? "removeAttribute" : "setAttribute"]("disabled", "disabled")
    }
};
Wikimapia.Interface.Statusbar.prototype.saveIsAllowed = function () {
    return !!Wikimapia.Utils.Dom.data(this.ui.saveButton, "allowed")
};
Wikimapia.Interface.Statusbar.prototype.setSize = function (t) {
    this.height = t.height();
    Wikimapia.Utils.Dom.setStyle(this.div, "height", this.height + "px");
    return this
};
Wikimapia.Interface.Statusbar.prototype.grab = function (t) {
    this.content.appendChild(t);
    return this
};
Wikimapia.Interface.Statusbar.prototype.clear = function () {
    var t = this.content.innerHTML = "";
    this.ui = {};
    return this
};
Wikimapia.Interface.Statusbar.prototype.movesMapControls = function () {
    return !Wikimapia.Utils.isEmbedded() && this.options.position === Wikimapia.Interface.Statusbar.positionType.TOP
};
Wikimapia.Interface.Statusbar.prototype.show = function (t) {
    this.height = typeof t === "number" ? t : this.height;
    this.isDisplayed = true;
    if (this.animation) {
        this.animation.stop()
    }
    this.adjustSize();
    if (this.view === Wikimapia.Interface.Statusbar.views.RIBBON) {
        this.onBeforeShow()
    }
    this.animation = Wikimapia.Utils.Dom.animate(this.div, {
        duration: this.options.animationDuration,
        easing: this.options.animationTransition,
        height: this.height,
        complete: this.onShow.bind(this)
    });
    return this
};
Wikimapia.Interface.Statusbar.prototype.onBeforeShow = function () {
    if (this.movesMapControls()) {
        this.moveMapControls(Wikimapia.Interface.Statusbar.moveDirection.DOWN)
    }
};
Wikimapia.Interface.Statusbar.prototype.onShow = function () {
    this.fireEvent("shown", this)
};
Wikimapia.Interface.Statusbar.prototype.hide = function () {
    if (this.isDisplayed) {
        this.isDisplayed = false;
        if (this.animation) {
            this.animation.stop()
        }
        this.adjustSize();
        if (this.view === Wikimapia.Interface.Statusbar.views.RIBBON) {
            this.onBeforeHide()
        }
        this.animation = Wikimapia.Utils.Dom.animate(this.div, {
            duration: this.options.animationDuration,
            easing: this.options.animationTransition,
            height: 0,
            complete: this.onHidden.bind(this)
        })
    }
    return this
};
Wikimapia.Interface.Statusbar.prototype.onBeforeHide = function () {
    if (this.movesMapControls()) {
        this.moveMapControls(Wikimapia.Interface.Statusbar.moveDirection.UP)
    }
};
Wikimapia.Interface.Statusbar.prototype.moveMapControls = function (t) {
    var e = this.options.animationDuration - 200;
    for (var i = 0, a = this.map.controls.length; i < a; i++) {
        var o = this.map.controls[i];
        if (o.div && o.div.style.top) {
            if (t === Wikimapia.Interface.Statusbar.moveDirection.DOWN) {
                if (!o._previousTopPosition) {
                    o._previousTopPosition = parseInt(o.div.style.top)
                }
                if (parseInt(o.div.style.top) === o._previousTopPosition + this.height) {
                    continue
                }
                Wikimapia.Utils.Dom.animate(o.div, {
                    top: o._previousTopPosition + this.height + "px",
                    duration: e
                })
            } else if (t === Wikimapia.Interface.Statusbar.moveDirection.UP) {
                if (o._previousTopPosition) {
                    Wikimapia.Utils.Dom.animate(o.div, {
                        top: o._previousTopPosition,
                        duration: e
                    })
                }
            }
        }
    }
};
Wikimapia.Interface.Statusbar.prototype.onHidden = function () {
    this.fireEvent("hidden", this)
};
Wikimapia.Interface.Statusbar.prototype.destroy = function () {
    if (this.animation) {
        this.animation.stop();
        delete this.animation
    }
    this.map.removeEvent("mapResized", this.adjustSize);
    Wikimapia.Interface.prototype.destroy.call(this)
};
Wikimapia.Interface.Statusbar.positionType = {
    TOP: "top",
    BOTTOM: "bottom"
};
Wikimapia.Geometry = function () { };
Wikimapia.Geometry.prototype = {
    constructor: Wikimapia.Geometry,
    bounds: null,
    destroy: function () {
        this.bounds = null
    },
    clone: function () { },
    setBounds: function (t) {
        if (t) {
            this.bounds = t.clone()
        }
    },
    clearBounds: function () {
        this.bounds = null;
        return this
    },
    extendBounds: function (t) {
        if (this.bounds) {
            this.bounds.extend(t)
        } else {
            this.bounds = t
        }
    },
    getBounds: function () {
        if (this.bounds === null) {
            this.calculateBounds()
        }
        return this.bounds
    },
    calculateBounds: function () { },
    distanceTo: function (t, e) { },
    atPoint: function (t, e) {
        var i = false;
        if (this.getBounds() !== null && t !== null) {
            var a = e.lng !== null ? e.lng : 0,
                o = e.lat !== null ? e.lat : 0,
                n = new Wikimapia.Bounds({
                    left: this.bounds.left - a,
                    bottom: this.bounds.bottom - o,
                    right: this.bounds.right + a,
                    top: this.bounds.top + o
                });
            i = n.containsLatLng(t)
        }
        return i
    },
    getArea: function () {
        return 0
    },
    getCentroid: function () {
        return null
    },
    toString: function () {
        return ""
    }
};
Wikimapia.Geometry.segmentsIntersect = function (t, e, i) {
    var a = i && i.point,
        o = i && i.tolerance,
        n = false;
    var s = t.x1 - e.x1,
        r = t.y1 - e.y1,
        p = t.x2 - t.x1,
        l = t.y2 - t.y1,
        c = e.y2 - e.y1,
        h = e.x2 - e.x1;
    var u = c * p - h * l,
        m = h * r - c * s,
        d = p * r - l * s;
    if (u === 0) {
        if (m === 0 && d === 0) {
            n = false
        }
    } else {
        var f = m / u,
            g = d / u;
        if (f >= 0 && f <= 1 && g >= 0 && g <= 1) {
            if (!a) {
                n = true
            } else {
                var y = t.x1 + f * p;
                var k = t.y1 + f * l;
                n = new Wikimapia.Point(y, k)
            }
        }
    }
    if (o) {
        var v;
        if (n) {
            if (a) {
                var W = [t, e],
                    b, y, k;
                t: for (var w = 0; w < 2; ++w) {
                    b = W[w];
                    for (var C = 1; C < 3; ++C) {
                        y = b["x" + C];
                        k = b["y" + C];
                        v = Math.sqrt(Math.pow(y - n.x, 2) + Math.pow(k - n.y, 2));
                        if (v < o) {
                            n.x = y;
                            n.y = k;
                            break t
                        }
                    }
                }
            }
        } else {
            var W = [t, e],
                L, S, y, k, T, E;
            t: for (var w = 0; w < 2; ++w) {
                L = W[w];
                S = W[(w + 1) % 2];
                for (var C = 1; C < 3; ++C) {
                    T = {
                        x: L["x" + C],
                        y: L["y" + C]
                    };
                    E = Math.pointToLineDistance(T.x, T.y, S.x1, S.y1, S.x2, S.y2, true);
                    if (E < o) {
                        if (a) {
                            n = new Wikimapia.Point(T.x, T.y)
                        } else {
                            n = true
                        }
                        break t
                    }
                }
            }
        }
    }
    if (n && a) {
        n = new Wikimapia.LatLng(n.y, n.x)
    }
    return n
};
Wikimapia.Geometry.fromMBR = function (t, e) {
    var i = [new Wikimapia.LatLng(t.top, t.left), new Wikimapia.LatLng(t.top, t.right), new Wikimapia.LatLng(t.bottom, t.right), new Wikimapia.LatLng(t.bottom, t.left)],
        a = "Polygon";
    if (e) {
        i.push(i[0].clone());
        a = "Polyline"
    }
    return new Wikimapia.Geometry[a](i)
};
Wikimapia.Geometry.pointToSegmentProjection = function (t, e, i) {
    var a = new Wikimapia.Size(e.x - t.x, e.y - t.y),
        o = new Wikimapia.Size(i.x - t.x, i.y - t.y),
        n = (o.w * a.w + o.h * a.h) / (a.w * a.w + a.h * a.h);
    return n < 0 || n > 1 ? null : new Wikimapia.Point(t.x + (e.x - t.x) * n, t.y + (e.y - t.y) * n)
};
Wikimapia.Geometry.coordToSegmentProjection = function (t, e, i) {
    var a = new Wikimapia.Size(e.lng - t.lng, e.lat - t.lat),
        o = new Wikimapia.Size(i.lng - t.lng, i.lat - t.lat),
        n = (o.w * a.w + o.h * a.h) / (a.w * a.w + a.h * a.h);
    return n < 0 || n > 1 ? null : new Wikimapia.LatLng(t.lat + (e.lat - t.lat) * n, t.lng + (e.lng - t.lng) * n)
};
Wikimapia.Geometry.isCollapsed = function (t) {
    var e = t.getBounds();
    return t.getVertexCount() === 4 && e.getWidth() === 0 && e.getHeight() === 0
};
Wikimapia.Geometry.segmentIntersection = function (t, e, i, a, o, n, s, r) {
    var p = (t - i) * (n - r) - (e - a) * (o - s);
    if (p === 0) {
        return null
    }
    var l = ((o - s) * (t * a - e * i) - (t - i) * (o * r - n * s)) / p;
    var c = ((n - r) * (t * a - e * i) - (e - a) * (o * r - n * s)) / p;
    if (l < Math.min(t, i) || l > Math.max(t, i)) {
        return null
    }
    if (l < Math.min(o, s) || l > Math.max(o, s)) {
        return null
    }
    return new Wikimapia.Point(l, c)
};
(function () {
    var t = Wikimapia.Geometry,
        e = Wikimapia.Bounds;
    Wikimapia.Geometry.Line = function (t) {
        Wikimapia.Geometry.call(this, t);
        this.points = [];
        if (t) {
            this.points = t
        }
        this.calculateBounds()
    };
    var i = Wikimapia.Geometry.Line;
    Wikimapia.Geometry.Line.prototype = new Wikimapia.Geometry;
    Wikimapia.Geometry.Line.prototype.constructor = Wikimapia.Geometry.Line;
    Wikimapia.Geometry.Line.prototype.typeName = "line";
    Wikimapia.Geometry.Line.prototype.points = null;
    Wikimapia.Geometry.Line.prototype.extendBounds = function (t) {
        if (this.bounds === null) {
            this.bounds = new e({
                left: t.lng,
                top: t.lat,
                bottom: t.lat,
                right: t.lng
            })
        } else {
            this.bounds.extend(t)
        }
    };
    Wikimapia.Geometry.Line.prototype.destroy = function () {
        this.points.length = 0;
        this.points = null
    };
    Wikimapia.Geometry.Line.prototype.addPoint = function (t) {
        this.points.push(t);
        this.bounds = null
    };
    Wikimapia.Geometry.Line.prototype.insertPoint = function (t, e) {
        this.points.splice(e, 0, t);
        this.clearBounds()
    };
    Wikimapia.Geometry.Line.prototype.addPoints = function (t) {
        this.points = t
    };
    Wikimapia.Geometry.Line.prototype.removePoint = function (t) {
        if (t != -1 && t < this.points.length) {
            this.points.splice(t, 1)
        }
        this.bounds = null
    };
    Wikimapia.Geometry.Line.prototype.removePoints = function () {
        for (var t = 0, e = this.points.length; t < e; t++) {
            this.removePoint(this.points[t])
        }
    };
    Wikimapia.Geometry.Line.prototype.getVertex = function (t) {
        return this.points[t]
    };
    Wikimapia.Geometry.Line.prototype.setVertex = function (t, e) {
        this.points[t] = e;
        return this.points[t]
    };
    Wikimapia.Geometry.Line.prototype.clone = function () {
        var e = [];
        for (var i = 0, a = this.points.length; i < a; i++) {
            e.push(this.points[i].clone())
        }
        return new (t[this.typeName.capitalize()])(e)
    };
    Wikimapia.Geometry.Line.prototype.getVertices = function (t) {
        return this.points.slice()
    };
    Wikimapia.Geometry.Line.prototype.calculateBounds = function () {
        this.bounds = null;
        if (this.points && this.points.length > 0) {
            for (var t = 0, e = this.points.length; t < e; t++) {
                this.extendBounds(this.points[t])
            }
        }
    };
    Wikimapia.Geometry.Line.prototype.getVertexCount = function () {
        return +this.points.length
    };
    Wikimapia.Geometry.Line.prototype.clearCachedCoords = function () {
        for (var t = 0, e = this.points.length; t < e; t++) {
            delete this.points[t].coordString
        }
        return this
    };
    Wikimapia.Geometry.Line.prototype.intersects = function (t) {
        var e = false;
        var i = t.typeName,
            a = Math.min,
            o = Math.max;
        if (i == "line" || i == "polyline" || i == "polygon") {
            var n = this.getSortedSegments();
            var s = t.getSortedSegments();
            var r, p, l, c, h, u, m, d;
            t: for (var f = 0, g = n.length; f < g; ++f) {
                r = n[f];
                p = r.x1;
                l = r.x2;
                c = r.y1;
                h = r.y2;
                for (var y = 0, k = s.length; y < k; ++y) {
                    u = s[y];
                    if (u.x1 > l) {
                        break
                    }
                    if (u.x2 < p) {
                        continue
                    }
                    m = u.y1;
                    d = u.y2;
                    if (a(m, d) > o(c, h)) {
                        continue
                    }
                    if (o(m, d) < a(c, h)) {
                        continue
                    }
                    if (t.segmentsIntersect(r, u, {
                        point: true
                    })) {
                        e = true;
                        break t
                    }
                }
            }
        }
        return e
    };
    Wikimapia.Geometry.Line.prototype.getSortedSegments = function () {
        var t = this.points.length - 1,
            e = new Array(t),
            i, a;
        for (var o = 0; o < t; ++o) {
            i = this.points[o];
            a = this.points[o + 1];
            if (i.lng < a.lng) {
                e[o] = {
                    x1: i.lng,
                    y1: i.lat,
                    x2: a.lng,
                    y2: a.lat
                }
            } else {
                e[o] = {
                    x1: a.lng,
                    y1: a.lat,
                    x2: i.lng,
                    y2: i.lat
                }
            }
        }

        function n(t, e) {
            return t.x1 - e.x1
        }
        return e.sort(n)
    };
    Wikimapia.Geometry.Line.prototype.rotate = function (t, e) {
        var i, a, o;
        t *= Math.PI / 180;
        for (var n = 0, s = this.getVertexCount() ; n < s; n++) {
            o = this.points[n];
            i = Math.sqrt(Math.pow(o.lng - e.lng, 2) + Math.pow(o.lat - e.lat, 2));
            a = t + Math.atan2(o.lat - e.lat, o.lng - e.lng);
            this.points[n] = new Wikimapia.LatLng(e.lat + i * Math.sin(a), e.lng + i * Math.cos(a))
        }
        this.clearBounds()
    }
})();
Wikimapia.Geometry.Polygon = function (t) {
    Wikimapia.Geometry.Line.call(this, t)
};
Wikimapia.Geometry.Polygon.prototype = new Wikimapia.Geometry.Line;
Wikimapia.Geometry.Polygon.prototype.constructor = Wikimapia.Geometry.Polygon;
Wikimapia.Geometry.Polygon.prototype.typeName = "polygon";
Wikimapia.Geometry.Polygon.prototype.getCentroid = function () {
    var t = this.points.slice()
        .concat(this.points[0].clone()),
        e = xc = yc = 0;
    for (var i = 0, a = this.getVertexCount() ; i < a; i++) {
        var o = t[i],
            n = t[i + 1],
            s = Math.pointsDistance(n.lng, n.lat, o.lng, o.lat),
            r = (n.lng + o.lng) * .5,
            p = (n.lat + o.lat) * .5;
        e += s;
        xc += r * s;
        yc += p * s
    }
    if (e === 0) {
        xc = yc = 0
    }
    return new Wikimapia.LatLng(yc / e, xc / e)
};
Wikimapia.Geometry.Polygon.prototype.getCoordArea = function () {
    var t = 0;
    if (this.points && this.points.length > 2) {
        var e = 0;
        for (var i = 0, a = this.points.length; i < a - 1; i++) {
            var o = this.points[i];
            var n = this.points[i + 1];
            e += (o.lng + n.lng) * (n.lat - o.lat)
        }
        t = -e / 2
    }
    return t
};
Wikimapia.Geometry.Polygon.prototype.getArea = function () {
    var t = 0;
    var e = this.points && this.points.length;
    if (e > 2) {
        var i, a;
        for (var o = 0; o < e - 1; o++) {
            i = this.points[o];
            a = this.points[o + 1];
            t += Math.degreesToRadians(a.lng - i.lng) * (2 + Math.sin(Math.degreesToRadians(i.lat)) + Math.sin(Math.degreesToRadians(a.lat)))
        }
        t = t * 6378137 * 6378137 / 2
    }
    return t
};
Wikimapia.Geometry.Polygon.prototype.containsLatLng = function (t) {
    var e = this.getBounds();
    if (e != null && !e.containsLatLng(t)) {
        return false
    } else {
        return Wikimapia.Utils.isPointInPolygon(this.points, t)
    }
};
Wikimapia.Geometry.Polygon.prototype.intersects = function (t) {
    var e = false;
    var i, a;
    if (t.typeName == "Line" || t.typeName == "Polyline") {
        for (i = 0, a = t.points.length; i < a; ++i) {
            e = this.containsLatLng(t.points[i]);
            if (e) {
                break
            }
        }
    } else {
        for (i = 0, a = t.points.length; i < a; ++i) {
            e = this.intersects(t.points[i]);
            if (e) {
                break
            }
        }
    }
    if (!e && t.typeName == "Polygon") {
        var o = this.points[0];
        for (i = 0, a = o.points.length; i < a; ++i) {
            e = t.containsPoint(o.points[i]);
            if (e) {
                break
            }
        }
    }
    return e
};
Wikimapia.Geometry.Polygon.prototype.toString = function () {
    return this.points.toString()
};
Wikimapia.Geometry.Polyline = function (t) {
    Wikimapia.Geometry.Line.call(this, t)
};
Wikimapia.Geometry.Polyline.prototype = new Wikimapia.Geometry.Line;
Wikimapia.Geometry.Polyline.prototype.constructor = Wikimapia.Geometry.Polyline;
Wikimapia.Geometry.Polyline.prototype.typeName = "polyline";
Wikimapia.Tile = function (t) {
    t = t || {};
    this.x = 0;
    this.y = 0;
    this.layer = t.layer;
    delete t.layer;
    Wikimapia.Utils.extend(this, t);
    this.id = Wikimapia.Utils.uniqueId("tile");
    this.createContainer();
    this.initialLoadAttempts = this.loadAttempts
};
Wikimapia.Tile.prototype.constructor = Wikimapia.Tile;
Wikimapia.Tile.prototype.loadAttempts = 3;
Wikimapia.Tile.prototype.createContainer = function () { };
Wikimapia.Tile.prototype.load = function () {
    this.layer.tilesMonitor("loadend", this)
};
Wikimapia.Tile.prototype.unload = function () {
    this.layer.tilesMonitor("unload", this)
};
Wikimapia.Tile.prototype.draw = function () {
    this.load()
};
Wikimapia.Tile.prototype.destroy = function () {
    delete this.layer
};
Wikimapia.Tile.Image = function (t) {
    Wikimapia.Tile.prototype.constructor.call(this, t);
    return this
};
Wikimapia.Utils.inherits(Wikimapia.Tile.Image, Wikimapia.Tile);
Wikimapia.Tile.Image.prototype.opacity = 1;
Wikimapia.Tile.Image.prototype.loadAttempts = 1;
Wikimapia.Tile.Image.prototype._complete = false;
Wikimapia.Tile.Image.prototype.createContainer = function () {
    var t = this.layer,
        e = t.tileSize,
        i = t.getTilePosition(this.x, this.y),
        a = Wikimapia.Utils.Dom.create("img", {
            id: this.id,
            "class": "wikimapia-image-tile",
            styles: {
                width: e.w,
                height: e.h,
                position: "absolute",
                top: i.y,
                left: i.x,
                "z-index": t.zIndex,
                "pointer-events": "none",
                "-webkit-transform": "translateZ(0)"
            },
            galleryImg: "no",
            width: e.w,
            height: e.h,
            src: Wikimapia.Utils.blankImage,
            unselectable: "on"
        });
    if (Wikimapia.Utils.alphaImageHackNeeded) {
        Wikimapia.Utils.Dom.setStyle(a, "filter", "alpha(opacity=0)")
    }
    a.onselectstart = a.onmousedown = Wikimapia.Utils.False;
    t.div.appendChild(a);
    this.bg = a.id
};
Wikimapia.Tile.Image.prototype.toElement = function () {
    return this.bg
};
Wikimapia.Tile.Image.prototype.clearBuffer = function () {
    var t = this.imgBuffer;
    if (t) {
        t.onload = t.onabort = t.onerror = null;
        delete this.imgBuffer
    }
};
Wikimapia.Tile.Image.prototype.load = function () {
    var t = this,
        e, i = this.layer,
        a = i.getTilePosition(this.x, this.y),
        o = i.getTileUrl(this.x, this.y, i.map.getZoom());
    this._complete = false;
    var n = document.getElementById(this.bg);
    if (!n) {
        delete this.bg;
        return
    }
    if (n.onload === null) {
        n.onload = this.onLoad.bind(this);
        n.onerror = n.onabort = this.onError.bind(this)
    }
    Wikimapia.Utils.Dom.setStyles(n, {
        display: "block",
        top: a.y,
        left: a.x,
        opacity: this._url === o ? 1 : 0
    });
    this._url = o;
    this._bg = n;
    this.setUrl(n, o)
};
Wikimapia.Tile.Image.prototype.isComplete = function () {
    return this._complete
};
Wikimapia.Tile.Image.prototype.setUrl = function (t, e) {
    t.src = e
};
if (Wikimapia.Utils.alphaImageHackNeeded) {
    Wikimapia.Tile.Image.prototype.setUrl = function (t, e) {
        Wikimapia.Utils.Dom.setStyle(t, "filter", "progid:DXImageTransform.Microsoft.AlphaImageLoader(src='" + e + "',sizingMethod='scale')");
        t.unselectable = true
    }
}
Wikimapia.Tile.Image.prototype.onLoad = function () {
    this._complete = true;
    var t = this._bg || document.getElementById(this.bg);
    this.layer.tilesMonitor("loadend", this);
    t.style.opacity = 1;
    delete this._bg
};
Wikimapia.Tile.Image.prototype.onError = function () {
    var t = this._bg || document.getElementById(this.bg);
    this.loadAttempts--;
    if (this.loadAttempts === 0) {
        this._complete = true;
        t.onload = t.onerror = t.onabort = null;
        t.setAttribute("src", Wikimapia.Utils.blankImage);
        t.style.opacity = 1;
        Wikimapia.Utils.Dom.setStyles(t, {
            display: "block",
            filter: "none"
        });
        this.layer.tilesMonitor("loadend", this);
        delete this._bg
    } else {
        this.load()
    }
};
Wikimapia.Tile.Image.prototype.unload = function () {
    var t = document.getElementById(this.bg);
    if (t) t.style.display = "none";
    this.layer.tilesMonitor("unload", this)
};
Wikimapia.Tile.Image.prototype.draw = function () {
    this.loadAttempts = +Wikimapia.Tile.Image.initialLoadAttempts;
    this.load()
};
Wikimapia.Tile.Image.prototype.destroy = function () {
    this.clearBuffer();
    var t = document.getElementById(this.id);
    if (t) {
        t.onload = t.onerror = t.onselectstart = t.onmousedown = null;
        if (t.parentNode) t.parentNode.removeChild(t)
    }
    delete this._bg;
    delete this._url;
    delete this.bg;
    Wikimapia.Tile.prototype.destroy.call(this)
};
Wikimapia.Tile.Image.initialLoadAttempts = 2;
Wikimapia.Tile.Text = function (t) {
    Wikimapia.Tile.prototype.constructor.call(this, t);
    if (this.layer) {
        this.id = this.layer.toQuadKey(this.x, this.y, this.layer.map.getZoom())
    }
    this.setRequest()
};
Wikimapia.Utils.inherits(Wikimapia.Tile.Text, Wikimapia.Tile);
Wikimapia.Tile.Text.prototype.request = null;
Wikimapia.Tile.Text.prototype._complete = false;
Wikimapia.Tile.Text.prototype.type = "itiles";
Wikimapia.Tile.Text.prototype.setRequest = function () {
    this.onRequestComplete = this.onRequestComplete.bind(this);
    this.request = new Wikimapia.Net.Xhr({
        method: "get",
        onSuccess: this.onRequestComplete
    })
};
Wikimapia.Tile.Text.prototype.onRequestComplete = function (t) {
    this._complete = true;
    this.layer.tilesMonitor("loadend", this);
    this.layer.renderTile(t, this.id, this.x, this.y, this)
};
Wikimapia.Tile.Text.prototype.draw = function () {
    var t = this.layer;
    this.id = t.toQuadKey(this.x, this.y, t.map.getZoom());
    if (t.tileLoadingAllowed(this)) {
        this.load()
    }
};
Wikimapia.Tile.Text.prototype.load = function () {
    this._complete = false;
    if (this.request && this.request.isRunning()) {
        this.request.cancel()
    }
    this.request.send({
        url: this.layer.getTileUrl(this.x, this.y, this.layer.map.getZoom())
    });
    this.layer.tilesMonitor("loadstart", this)
};
Wikimapia.Tile.Text.prototype.isComplete = function () {
    return this._complete
};
Wikimapia.Tile.Text.prototype.unload = function () {
    if (this.request && this.request.isRunning()) {
        this.request.cancel();
        this.layer.tilesMonitor("loadend", this)
    }
    Wikimapia.Tile.prototype.unload.call(this)
};
Wikimapia.Tile.Text.prototype.destroy = function () {
    if (this.request && this.request.isRunning()) {
        this.request.cancel()
    }
    delete this.request;
    this.layer.tilesMonitor("unload", this);
    Wikimapia.Tile.prototype.destroy.call(this)
};
Wikimapia.Tile.Itile = function (t) {
    return Wikimapia.Tile.Text.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Tile.Itile, Wikimapia.Tile.Text);
Wikimapia.Tile.Itile.prototype.roadsRequest = null;
Wikimapia.Tile.Itile.prototype.setRequest = function () {
    var t = Wikimapia.Layer.Interactive.TileTypes,
        e = Wikimapia.Net.usesCDN() && !Wikimapia.Utils.alphaImageHackNeeded;
    this.request = new Wikimapia.Net.XhrBase({
        method: "get",
        crossOrigin: e,
        onError: this.errorHandler.bind(this),
        withCredentials: e,
        onSuccess: this.getOnLoadHandler(t.OBJECTS)
    });
    this.roadsRequest = new Wikimapia.Net.XhrBase({
        method: "get",
        crossOrigin: e,
        onError: this.errorHandler.bind(this),
        withCredentials: e,
        onSuccess: this.getOnLoadHandler(t.ROADS)
    })
};
Wikimapia.Tile.Itile.prototype.errorHandler = function (t) {
    if (t && t.status === 404 && this.layer) {
        this.layer.tilesMonitor("loaderror", this, t.status)
    }
};
Wikimapia.Tile.Itile.prototype.getOnLoadHandler = function (t) {
    return function (e) {
        this._complete = true;
        if (this.layer) {
            var i = t === Wikimapia.Layer.Interactive.TileTypes.ROADS ? this.roadsRequest : this.request,
                a = 0,
                o = 0;
            if (i.getStatus() === 200 && this["requestStart" + t]) {
                o = parseInt(i.getHeader("Content-Length"));
                a = (new Date)
                    .getTime() - this["requestStart" + t];
                this.layer.tilesMonitor("loadend", this, o, a);
                delete this["requestStart" + t]
            }
            this.layer.renderTile(e, this.id, this.x, this.y, this, t)
        }
    }.bind(this)
};
Wikimapia.Tile.Itile.prototype.draw = function () {
    var t = this,
        e = this.layer,
        i;
    this.id = e.toQuadKey(this.x, this.y, e.map.getZoom());
    i = e.tileLoadingAllowed(this);
    if (i) {
        this.load(i)
    }
};
Wikimapia.Tile.Itile.prototype.load = function (t) {
    var e = Wikimapia.Layer.Interactive.TileTypes,
        i;
    if (t === e.OBJECTS_AND_ROADS || t === e.OBJECTS) {
        if (this.request && this.request.isRunning()) {
            this.request.cancel();
            delete this["requestStart" + e.OBJECTS]
        }
        i = this.layer.getTileUrl(this.x, this.y, this.layer.map.getZoom(), e.OBJECTS);
        this.request.send({
            url: i
        });
        this["requestStart" + e.OBJECTS] = (new Date)
            .getTime();
        this.layer.tilesMonitor("loadstart", this, e.OBJECTS)
    }
    if (t === e.OBJECTS_AND_ROADS || t === e.ROADS) {
        if (this.roadsRequest && this.roadsRequest.isRunning()) {
            this.roadsRequest.cancel();
            delete this["requestStart" + e.ROADS]
        }
        i = this.layer.getTileUrl(this.x, this.y, this.layer.map.getZoom(), e.ROADS);
        clearTimeout(this.roadsRequestSendTimer);
        this.roadsRequestSendTimer = setTimeout(function () {
            this.roadsRequest.send({
                url: i
            })
        }.bind(this), 300);
        this["requestStart" + e.ROADS] = (new Date)
            .getTime();
        this.layer.tilesMonitor("loadstart", this, e.ROADS)
    }
};
Wikimapia.Tile.Itile.prototype.unload = function () {
    if (this.roadsRequest && this.roadsRequest.isRunning()) {
        this.layer.tilesMonitor("loadend", this);
        this.roadsRequest.cancel()
    }
    Wikimapia.Tile.Text.prototype.unload.call(this)
};
Wikimapia.Tile.Itile.prototype.destroy = function () {
    clearTimeout(this.roadsRequestSendTimer);
    if (this.request && this.request.isRunning()) {
        this.request.cancel()
    }
    if (this.roadsRequest && this.roadsRequest.isRunning()) {
        this.roadsRequest.cancel()
    }
    delete this.roadsRequest;
    this.layer.tilesMonitor("unload", this);
    Wikimapia.Tile.Text.prototype.destroy.call(this)
};
Wikimapia.Parser = function (t) {
    this.layer = t;
    this.cache = new Wikimapia.Cache;
    this.pool = Wikimapia.Cache.Pool
};
Wikimapia.Parser.prototype = {
    constructor: Wikimapia.Parser,
    layer: null,
    cache: null,
    parse: function (t) { }
};
Wikimapia.Parser.Itiles = function (t) {
    Wikimapia.Parser.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Parser.Itiles, Wikimapia.Parser);
Wikimapia.Parser.Itiles.decodeTitles = function (t) {
    var e = {};
    t = t.split("");
    for (var i = 0, a = t.length; i < a; i++) {
        if (typeof t[i] === "string") {
            e[(t[i].charCodeAt(0) - 32)
                .toString()] = t[i].substring(1, t[i].length)
        }
    }
    return e
};
Wikimapia.Parser.Itiles.prototype.parse = function (t, e, i) {
    var a, o, n, s, r, p, l, c = {};
    i = i || this.layer.tileCache.objects;
    t = t.split("\n");
    a = t[0].split("|");
    c.tileId = a[0];
    c.deeperTiles = !!parseInt(a[1]);
    c.numTypes = parseInt(a[2], 10);
    c.ids = [];
    for (var h = 1, u = t.length; h < u; h++) {
        a = t[h].split("|");
        if (a.length > 1) {
            s = a[2].split(",");
            l = a[0];
            if (a[6] == "1") {
                a[7] = a.slice(7)
                    .join("|")
            }
            n = this.pool.get();
            n.id = parseInt(l, 10);
            n.area = parseFloat(a[1]);
            n.mbr = new Wikimapia.Bounds({
                bottom: parseInt(s[2], 10) / 1e7,
                left: parseInt(s[0], 10) / 1e7,
                top: parseInt(s[3], 10) / 1e7,
                right: parseInt(s[1], 10) / 1e7
            });
            n.zoom = parseInt(a[3], 10);
            n.encodingType = parseInt(a[6], 10);
            n.polygon = a[7];
            n.titles = a[5];
            n.count = 0;
            if (l in i) {
                n.count = i[l].count ? i[l].count + 1 : 2
            }
            i[l] = n;
            c.ids.push(l)
        }
    }
    return c
};
Wikimapia.Parser.Itiles.prototype.parseTileOptions = function (t) {
    var e = t.split("|");
    return {
        tileId: e[0],
        deeperTiles: !!parseInt(e[1]),
        categoryId: parseInt(e[2], 10),
        mbr: new Wikimapia.Bounds({
            left: parseInt(e[3]) / 1e7,
            top: parseInt(e[6]) / 1e7,
            bottom: parseInt(e[5]) / 1e7,
            right: parseInt(e[4]) / 1e7
        })
    }
};
Wikimapia.Parser.Itiles.prototype.parseOldStyle = function (t, e) {
    var i, a, o, n, s, r, p;
    e = e || this.layer.tileCache.objects;
    t = t.split("\n");
    p = this.parseTileOptions(t[0]);
    a = p.mbr.left;
    o = p.mbr.bottom;
    p.objects = [];
    p.ids = [];
    for (var l = 1, c = t.length; l < c; l++) {
        i = t[l].split("|");
        if (i.length > 1) {
            if (i[7] == "1") i[8] = i.slice(8).join("|");
            r = i[0];
            n = this.pool.get();
            n.id = parseInt(r, 10);
            n.mbr = new Wikimapia.Bounds({
                left: a + parseInt(i[1], 10) / 1e7,
                top: o + parseInt(i[2], 10) / 1e7,
                bottom: parseInt(i[4], 10) / 1e7,
                right: parseInt(i[3], 10) / 1e7
            });
            n.zoom = parseInt(i[5], 10);
            n.polygon = i[8];
            n.encodingType = parseInt(i[7], 10);
            n.count = 0;
            n.mbr.bottom = n.mbr.top - n.mbr.bottom;
            n.mbr.right = n.mbr.left + n.mbr.right;
            s = i[6].split("");
            n.titles = {};
            for (var h = 0; h < s.length; h++) {
                if (typeof s[h] === "string") {
                    var u = s[h].charCodeAt(0) - 32;
                    n.titles[u.toString()] = s[h].substring(1, s[h].length)
                }
            }
            if (!n.polygon) {
                n.polygon = false
            }
            if (r in e) {
                n.count = e[r].count ? e[r].count + 1 : 2
            }
            e[r] = n;
            p.ids.push(r)
        }
    }
    return p
};
Wikimapia.Parser.Itiles.prototype.parseBrands = function (t, e) {
    var i, a, o, n, s, r, p;
    e = e || this.layer.tileCache.objects;
    t = t.split("\n");
    p = this.parseTileOptions(t[0]);
    a = p.mbr.left;
    o = p.mbr.bottom;
    p.objects = [];
    p.ids = [];
    for (var l = 1, c = t.length; l < c; l++) {
        i = t[l].split("|");
        if (i.length > 1) {
            i[9] = i.slice(9)
                .join("|");
            r = i[0];
            n = this.pool.get();
            n.id = parseInt(r, 10), n.mbr = new Wikimapia.Bounds({
                left: a + parseInt(i[1], 10) / 1e7,
                top: o + parseInt(i[2], 10) / 1e7,
                bottom: parseInt(i[4], 10) / 1e7,
                right: parseInt(i[3], 10) / 1e7
            });
            n.zoom = parseInt(i[5], 10);
            n.polygon = i[9];
            n.encodingType = 1;
            n.icon = i[7];
            n.tooltipText = i[8];
            n.sponsored = true;
            n.count = 0;
            n.mbr.bottom = n.mbr.top - n.mbr.bottom;
            n.mbr.right = n.mbr.left + n.mbr.right;
            s = i[6].split("");
            n.titles = {};
            for (var h = 0; h < s.length; h++) {
                if (typeof s[h] === "string") {
                    var u = s[h].charCodeAt(0) - 32;
                    n.titles[u.toString()] = s[h].substring(1, s[h].length)
                }
            }
            if (!n.polygon) {
                n.polygon = false
            }
            if (r in e) {
                n.count = e[r].count ? e[r].count + 1 : 2
            }
            e[r] = n;
            p.ids.push(r)
        }
    }
    return p
};
Wikimapia.Parser.Itiles.prototype.decodePolygon = function (t) {
    t = t.split(";");
    var e, i, a, o = [],
        n = parseInt(t[2].substr(0, 2), 16) + 1,
        s = [],
        r = 2,
        p = Math.pow,
        l = Math.abs,
        c = Wikimapia.LatLng;
    s[0] = parseInt(t[0], 10);
    s[1] = parseInt(t[1], 10);
    var h = [new c(s[1] / 1e7, s[0] / 1e7)];
    for (e = 2, a = t[2].length; e < a; e += n * 2) {
        var u = 0;
        for (i = n; i > 0; i--) {
            u += parseInt(t[2].substr(e + i * 2 - 2, 2), 16) * (1 << l(i - n) * 8)
        }
        if (n === 1 && u > 127) {
            u -= 256
        }
        if (n === 2 && u > 32767) {
            u -= 65535
        }
        if (n === 3 && u > 8388607) {
            u -= 16777215
        }
        if (n === 4 && u > 2147483647) {
            u -= 4294967295
        }
        s[r++] = u
    }
    for (e = 2, a = s.length; e < a; e += 2) {
        if (s[e - 2] > 155e7 && s[e] < -5e8) {
            s[e] += 4294967295
        } else {
            if (s[e - 2] < -155e7 && s[e] > 5e8) {
                s[e] -= 4294967295
            }
        }
        s[e] = s[e - 2] - s[e];
        s[e + 1] = s[e - 1] - s[e + 1];
        h.push(new c(s[e + 1] / 1e7, s[e] / 1e7))
    }
    return new Wikimapia.Geometry.Polygon(h)
};
Wikimapia.Parser.Itiles.prototype.decodePolygonUncompressed = function (t, e) {
    t = t.split(";");
    var i = 1e7,
        a = 1,
        o = [],
        n = new Wikimapia.LatLng(parseInt(t[a + 1]) / i, parseInt(t[a]) / i);
    for (var s = a + 2, r = t.length; s < r; s += 2) {
        o.push(n.shift(parseInt(t[s + 1]) / i, parseInt(t[s]) / i))
    }
    return new Wikimapia.Geometry.Polyline(o)
};
Wikimapia.Parser.Itiles.prototype.decodePolygonMK2 = function (t) {
    var e = t.length,
        i = 0,
        a = [],
        o = 0,
        n = 0,
        s = false,
        r = Wikimapia.LatLng;
    while (i < e) {
        var p, l = 0,
            c = 0;
        do {
            p = t.charCodeAt(i++) - 63;
            c |= (p & 31) << l;
            l += 5
        } while (p >= 32);
        n += c & 1 ? ~(c >> 1) : c >> 1;
        if (n > 180 * 1e6 || n < -(180 * 1e6)) {
            s = true
        }
        l = 0;
        c = 0;
        do {
            p = t.charCodeAt(i++) - 63;
            c |= (p & 31) << l;
            l += 5
        } while (p >= 32);
        o += c & 1 ? ~(c >> 1) : c >> 1;
        s = o > 90 * 1e6 || o < -(90 * 1e6) ? 1e7 : 1e6;
        a.push(new r(o / s, n / s))
    }
    return new Wikimapia.Geometry.Polygon(a)
};
Wikimapia.Parser.Itiles.prototype.decodeObjectPolygon = function (t) {
    if (typeof t.polygon === "string") {
        t.polygon = this[t.encodingType === 1 ? "decodePolygonMK2" : "decodePolygon"](t.polygon)
    }
    return t.polygon
};
Wikimapia.Parser.Linear = function (t) {
    Wikimapia.Parser.prototype.constructor.call(this, t);
    this.setParseFunction(t)
};
Wikimapia.Utils.inherits(Wikimapia.Parser.Linear, Wikimapia.Parser);
Wikimapia.Parser.Linear.prototype.setParseFunction = function (t) {
    var e = t.getName()
        .split(/[\.-]/)
        .pop();
    if (/interactive/.test(t.getName())) {
        e = "iroads"
    } else {
        switch (e) {
            case "rivers":
                break;
            case "ferries":
            case "railroads":
            case "roads":
            default:
                e = "roads";
                break
        }
    }
    this.parse = this[e]
};
Wikimapia.Parser.Linear.prototype.parse = function (t, e, i) {
    return this.parserFunction(t, e, i)
};
Wikimapia.Parser.Linear.prototype.parseTileOptions = function (t) {
    t = t.split("|");
    var e = {
        id: t[0],
        deeperTiles: t[1]
    };
    if (t[2] === "9") {
        e.compressed = t[3] === "1"
    } else {
        e.mbr = new Wikimapia.Bounds({
            left: parseInt(t[3], 10) / 1e7,
            right: parseInt(t[4], 10) / 1e7,
            bottom: parseInt(t[5], 10) / 1e7,
            top: parseInt(t[6], 10) / 1e7
        })
    }
    return e
};
Wikimapia.Parser.Linear.prototype.parseGroups = function (t, e) {
    var i = (t || "")
        .split("|"),
        a = this.layer,
        o, n = [],
        s, r;
    e = e || this.layer;
    for (var p = 0, l = i.length; p < l - 1; p += 2) {
        s = i[p];
        n.push(s);
        o = e.groups[s];
        if (!(s in e.groups)) {
            o = e.groups[s] = {
                titles: i[p + 1],
                segments: []
            }
        }
    }
    return n
};
Wikimapia.Parser.Linear.decodeTitles = function (t) {
    var e = {};
    t = t.split("");
    for (var i = 0, a = t.length; i < a; i++) {
        e[t[i].charCodeAt(0) - 32] = t[i].replace(/^./, "")
    }
    return e
};
Wikimapia.Parser.Linear.prototype.roads = function (t, e, i) {
    var a, o = this.layer,
        n, s, r, p = {
            points: [],
            segments: []
        };
    if (o.needsReload) {
        return p
    }
    t = t.split("\n");
    a = this.parseTileOptions(t[0]);
    n = t[5].split("|");
    for (s = 0, r = n.length - 1; s < r; s++) {
        var l = n[s].split(","),
            c = l[0].split("_"),
            h = l[1].split("_"),
            u;
        c = new Wikimapia.LatLng(parseInt(c[1], 10) / 1e7, parseInt(c[0], 10) / 1e7);
        h = new Wikimapia.LatLng(parseInt(h[1], 10) / 1e7, parseInt(h[0], 10) / 1e7);
        var m, d, f;
        if (a.mbr.containsLatLng(c) || a.mbr.containsLatLng(h)) {
            if (c.lng > h.lng) {
                var g = h.clone();
                h = c.clone();
                c = g.clone();
                d = l[1];
                f = l[0]
            } else {
                d = l[0];
                f = l[1]
            }
            m = d + "." + f;
            if (o.segments[m] || o.deletedSegments[m]) {
                continue
            }
            var y = parseInt(l[3], 10),
                k, v = parseInt(l[4], 10),
                W = 0,
                b = 0,
                w = 0,
                C = parseInt(l[5]);
            if (y > 99) {
                k = y > 119 ? 2 : 1;
                y -= y > 119 ? 120 : 100;
                if (y > 10) {
                    y += ~~(y / 10)
                }
                if (y < 10) {
                    y += y * 10
                }
            } else {
                k = 0
            }
            W = v >> 5;
            if ((v & 28) > 0) {
                w = (v & 28) >> 2;
                if (w > 5) {
                    w -= 8
                }
            }
            u = {
                start: d,
                end: f,
                id: m,
                group: parseInt(l[2], 10),
                lanes: y,
                direction: k,
                type: W,
                surface: b,
                elevation: w,
                uid: C
            };
            if (!o.segments[u.id]) {
                p.segments.push(u.id);
                o.segments[u.id] = u
            }
            if (!o.points[d]) {
                c.connected = [];
                o.points[d] = c;
                p.points.push(d)
            }
            o.points[d].connected.push(u.id);
            if (!o.points[f]) {
                h.connected = [];
                o.points[f] = h;
                p.points.push(f)
            }
            o.points[u.end].connected.push(u.id)
        }
    }
    this.parseGroups(t[6]);
    return p
};
Wikimapia.Parser.Linear.prototype.iroads = function (t, e, i) {
    var a, o = this.layer,
        n, s, r, p = {
            points: [],
            segments: []
        },
        l, c;
    t = t.split(/\n{4}/);
    if (t.length < 2) {
        return p
    }
    a = this.parseTileOptions(t[0]);
    t = t[1].split(/\n{2}/);
    if (o.needsReload || t.length < 2) {
        return p
    }
    l = this.parseGroups(t[1].replace(/\n/g, "|"));
    this[a.compressed ? "iroadsCompressed" : "iroadsUncompressed"](t, o, p);
    return p
};
Wikimapia.Parser.Linear.prototype.iroadsUncompressed = function (t, e, i) {
    var a, o, n, s;
    n = t[0].split(/\n/g);
    for (a = 0, o = n.length; a < o; a++) {
        var r = n[a].split("|");
        r.unshift(r.pop());
        n[a] = r.join("|")
    }
    t[0] = n.join("\n");
    t = t[0].replace(/\n/g, "|");
    n = t.split("|");
    for (a = 0, o = n.length; a < o; a++) {
        var p = n[a],
            l = p.split(",");
        if (l.length === 1) {
            s = l[0];
            continue
        }
        var c, h, u, m = new Wikimapia.LatLng(parseInt(l[1]) / 1e7, parseInt(l[0]) / 1e7),
            d = new Wikimapia.LatLng(parseInt(l[3]) / 1e7, parseInt(l[2]) / 1e7);
        if (m.lng > d.lng) {
            var r = d.clone();
            d = m.clone();
            m = r.clone()
        }
        h = m.toString();
        u = d.toString();
        c = h + "." + u;
        i.segments.push(c);
        if (c in e.segments) {
            continue
        }
        p = this.pool.get();
        p.start = h;
        p.end = u;
        p.id = c;
        p.type = parseInt(l[4], 10);
        p.group = s;
        if (!(c in e.segments)) {
            e.segments[p.id] = p
        }
        if (e.groups[s]) {
            e.groups[s].segments.push(p.id)
        }
        if (!(h in e.points)) {
            m.connected = [];
            e.points[h] = m;
            i.points.push(h)
        }
        e.points[h].connected.push(p.id);
        if (!(u in e.points)) {
            d.connected = [];
            e.points[u] = d;
            i.points.push(u)
        }
        e.points[p.end].connected.push(p.id)
    }
    return i
};
Wikimapia.Parser.Linear.prototype.iroadsCompressed = function (t, e, i) {
    var a = t[0].split(/\n/g),
        o, n;
    for (o = 0, n = a.length; o < n; o++) {
        var s = a[o],
            r = s.split(":"),
            p = r[0],
            l = parseInt(r[1], 10),
            c = r[2];
        var h = c.length,
            u = 0,
            m = 0,
            d = 0,
            f = 0,
            g = [],
            y = false;
        while (u < h) {
            var k, v = 0,
                W = 0;
            do {
                k = c.charCodeAt(u++) - 63;
                W |= (k & 31) << v;
                v += 5
            } while (k >= 32);
            d += W & 1 ? ~(W >> 1) : W >> 1;
            if (d > 180 * 1e6 || d < -(180 * 1e6)) {
                y = true
            }
            v = 0;
            W = 0;
            do {
                k = c.charCodeAt(u++) - 63;
                W |= (k & 31) << v;
                v += 5
            } while (k >= 32);
            m += W & 1 ? ~(W >> 1) : W >> 1;
            if (m > 90 * 1e6 || m < -(90 * 1e6)) {
                y = true
            }
            if (y) {
                g.push(parseFloat((m * 1e-7)
                    .toFixed(6)), parseFloat((d * 1e-7)
                    .toFixed(6)))
            } else {
                g.push(parseFloat((m * 1e-6)
                    .toFixed(5)), parseFloat((d * 1e-6)
                    .toFixed(5)))
            }
            if (f % 2) {
                var b, w, C, L = new Wikimapia.LatLng(g[0], g[1]),
                    S = new Wikimapia.LatLng(g[2], g[3]);
                if (L.lng > S.lng) {
                    var T = S.clone();
                    S = L.clone();
                    L = T.clone()
                }
                w = L.toString();
                C = S.toString();
                b = w + "." + C;
                i.segments.push(b);
                if (!(b in e.segments)) {
                    s = this.pool.get();
                    s.start = w;
                    s.end = C;
                    s.id = b;
                    s.type = l;
                    s.group = p;
                    if (!(b in e.segments)) {
                        e.segments[s.id] = s
                    }
                    if (e.groups[p]) {
                        e.groups[p].segments.push(s.id)
                    }
                    if (!(w in e.points)) {
                        L.connected = [];
                        e.points[w] = L;
                        i.points.push(w)
                    }
                    e.points[w].connected.push(s.id);
                    if (!(C in e.points)) {
                        S.connected = [];
                        e.points[C] = S;
                        i.points.push(C)
                    }
                    e.points[s.end].connected.push(s.id)
                }
                g = [];
                if (c.charCodeAt(u) === 59) {
                    u++
                } else {
                    if (u + 2 < h) {
                        if (y) {
                            g.push(parseFloat((m * 1e-7)
                                .toFixed(6)), parseFloat((d * 1e-7)
                                .toFixed(6)))
                        } else {
                            g.push(parseFloat((m * 1e-6)
                                .toFixed(5)), parseFloat((d * 1e-6)
                                .toFixed(5)))
                        }
                        f++
                    }
                }
            }
            f++
        }
    }
};
Wikimapia.Parser.Linear.prototype.rivers = function (t, e, i) {
    var a, o, n, s, r = this.layer,
        p = {
            points: [],
            segments: []
        };
    if (r.needsReload) {
        return p
    }
    t = t.split("\n");
    a = this.parseTileOptions(t[0]);
    o = t[5].split("|");
    for (n = 0, s = o.length - 1; n < s; n++) {
        var l = o[n].split(","),
            c = l[0].split("_"),
            h = l[1].split("_"),
            u;
        c = new Wikimapia.LatLng(parseInt(c[1], 10) / 1e7, parseInt(c[0], 10) / 1e7);
        h = new Wikimapia.LatLng(parseInt(h[1], 10) / 1e7, parseInt(h[0], 10) / 1e7);
        var m, d, f;
        if (c.lng > h.lng) {
            var g = h.clone();
            h = c.clone();
            c = g.clone();
            d = l[1];
            f = l[0]
        } else {
            d = l[0];
            f = l[1]
        }
        m = d + "." + f;
        if (m in r.deletedSegments || m in r.segments) {
            continue
        }
        var y = parseInt(l[4], 10),
            k = parseInt(l[5]);
        m = ["t", "", "rib", "side"][y] + m;
        u = this.pool.get();
        u.start = d;
        u.end = f;
        u.id = m;
        u.group = parseInt(l[2], 10);
        u.type = y;
        u.uid = k;
        if (!(m in r.segments)) {
            p.segments.push(m);
            r.segments[u.id] = u
        }
        if (d in r.points) {
            c = r.points[d];
            if (c.connected.indexOf(m) === -1) {
                c.connected.push(m)
            }
        } else {
            r.points[d] = c;
            r.points[d].connected = [m]
        }
        c = r.points[d];
        p.points.push(d);
        if (f in r.points) {
            h = r.points[f];
            if (h.connected.indexOf(m) === -1) {
                h.connected.push(m)
            }
        } else {
            r.points[f] = h;
            r.points[f].connected = [m]
        }
        p.points.push(f)
    }
    this.parseGroups(t[6]);
    return p
};
Wikimapia.supportedLayers = {};
(function () {
    var t = Math,
        e = t.sin,
        i = t.atan,
        a = t.exp,
        o = t.log,
        n = t.round,
        s = t.ceil,
        r = t.degreesToRadians,
        p = t.radiansToDegrees,
        l = Wikimapia.Utils.normalize,
        c = Math.PI * .5;
    Wikimapia.Layer = function (t) {
        this.handlers = {};
        Wikimapia.Utils.extend(this.options, t);
        this.options.langCode = Wikimapia.Lang.lngToCode(this.options.lang);
        this.createLayerContainer();
        this.handlers.onLanguageChange = this.onLanguageChange.bind(this);
        this.handlers.updateSize = this.updateSize.bind(this);
        Wikimapia.Lang.addEvent("langChanged", this.handlers.onLanguageChange)
    };
    Wikimapia.Utils.inherits(Wikimapia.Layer, Wikimapia.EventTarget);
    Wikimapia.Layer.prototype.options = {
        center: 0,
        zoom: 0,
        type: null,
        maxZoomLevel: 21,
        minZoomLevel: 0,
        name: "layer"
    };
    Wikimapia.Layer.prototype.div = null;
    Wikimapia.Layer.prototype.map = null;
    Wikimapia.Layer.prototype.mapObject = null;
    Wikimapia.Layer.prototype.handlers = {};
    Wikimapia.Layer.prototype.tileSize = null;
    Wikimapia.Layer.prototype.resolutions = null;
    Wikimapia.Layer.prototype.maxExtent = Wikimapia.Bounds.fromArray([-180, -85.05112877980662, 180, 85.05112877980662]);
    Wikimapia.Layer.prototype.wrapDateLine = false;
    Wikimapia.Layer.prototype.createLayerContainer = function () {
        this.div = Wikimapia.Utils.Dom.create("div", {
            id: this.getName() + "-layer",
            "class": "wikimapia-layer",
            styles: {
                unselectable: "on"
            },
            events: {
                selectstart: Wikimapia.Utils.False
            }
        })
    };
    Wikimapia.Layer.prototype.setMap = function (t) {
        this.map = t;
        this.maxExtent = this.map.getMaxExtent();
        this.units = this.units || this.map.units;
        this.dragObject = t.dragObject;
        this.setTileSize();
        this.loadMapObject();
        this.onAddedToMap()
    };
    Wikimapia.Layer.prototype.updateSize = function (t) {
        if (this.map) {
            t = t || this.map.getCurrentSize();
            Wikimapia.Utils.Dom.setStyles(this.div, {
                width: t.w,
                height: t.h
            })
        }
    };
    Wikimapia.Layer.prototype.onAddedToMap = function () { };
    Wikimapia.Layer.prototype.setZIndex = function (t) {
        this.zIndex = t;
        this.div.style.zIndex = t
    };
    Wikimapia.Layer.prototype.redraw = function () {
        var t = false;
        if (this.map) {
            var e = this.getBounds();
            if (e) {
                var i = true;
                this.moveTo(e, i, false);
                this.fireEvent("moveend", {
                    zoomChanged: i
                });
                t = true
            }
        }
        return t
    };
    Wikimapia.Layer.prototype.moveTo = function (t) { };
    Wikimapia.Layer.prototype.move = function (t) { }, Wikimapia.Layer.prototype.moveBy = function (t) { };
    Wikimapia.Layer.prototype.loadMapObject = function () {
        this.updateSize();
        this.addAttribution()
    };
    Wikimapia.Layer.prototype.addAttribution = function () {
        if (typeof this.options.attribution === "string") {
            if (this.attribution) {
                Wikimapia.Utils.Dom.destroy(this.attribution)
            }
            this.attribution = Wikimapia.Utils.Dom.create("div", {
                "class": "attribution " + this.options.name.split(/[\.-]/)[0] + "-attribution",
                html: this.options.attribution
            });
            this.map.addCopyright(this.attribution, this)
        }
    };
    Wikimapia.Layer.prototype.getImageSize = function () {
        return this.imageSize || this.tileSize
    };
    Wikimapia.Layer.prototype.getBounds = function () {
        var t = this.map.getSize(),
            e = this.map.fromLatLngToPixel(this.map.getCenter()),
            i = s(t.w * .5),
            a = s(t.h * .5);
        var o = this.map.fromPixelToLatLng(e.subtract(i, a)),
            n = this.map.fromPixelToLatLng(e.add(i, a)),
            r = new Wikimapia.Bounds({
                top: o.lat,
                right: n.lng,
                bottom: n.lat,
                left: o.lng
            });
        return r
    };
    Wikimapia.Layer.prototype.getElement = function () {
        return $(this.div)
    };
    Wikimapia.Layer.prototype.getZoom = function () {
        return this.options.zoom
    };
    Wikimapia.Layer.prototype.getName = function () {
        return this.options.name
    };
    Wikimapia.Layer.prototype.setTileSize = function (t) {
        this.tileSize = t ? t : this.tileSize ? this.tileSize : this.map.getTileSize()
    };
    Wikimapia.Layer.prototype.loaded = function () { };
    Wikimapia.Layer.prototype.setMapType = function (t, e) { };
    Wikimapia.Layer.prototype.setZoom = function (t) {
        this.options.zoom = t;
        this.bounds = null;
        return this
    };
    Wikimapia.Layer.prototype.getCenter = function () {
        return this.map.getCenter()
    };
    Wikimapia.Layer.prototype.setCenter = function (t, e) {
        this.options.center = t;
        if (typeof e === "number") this.options.zoom = e
    };
    Wikimapia.Layer.prototype.onLanguageChange = function () {
        this.options.lang = Wikimapia.Lang.getCurrentLanguage();
        this.options.langCode = Wikimapia.Lang.getCurrentLanguageCode()
    };
    Wikimapia.Layer.prototype.disable = function () {
        return this
    };
    Wikimapia.Layer.prototype.enable = function () {
        this.redraw();
        return this
    };
    Wikimapia.Layer.prototype.show = function () {
        this.div.show();
        return this
    };
    Wikimapia.Layer.prototype.hide = function () {
        this.div.hide();
        return this
    };
    Wikimapia.Layer.prototype.destroy = function () {
        Wikimapia.Lang.removeEvent("langChanged", this.handlers.onLanguageChange);
        if (this.attribution) {
            Wikimapia.Utils.Dom.destroy(this.attribution);
            delete this.attribution
        }
        if (this.div) {
            Wikimapia.Utils.Dom.destroy(this.div)
        }
        this.fireEvent("layerDestroyed", this);
        this.removeEvents();
        delete this.div;
        delete this.map;
        delete this.mapObject
    }
})();
Wikimapia.Layer.BaseLayer = function () { };
Wikimapia.Layer.BaseLayer.prototype.accessMode = Wikimapia.layerAccessModes.ALL;
Wikimapia.Layer.BaseLayer.prototype.isBaseLayer = true;
Wikimapia.Layer.BaseLayer.prototype.getAccessMode = function () {
    return this.accessMode
};
Wikimapia.Layer.BaseLayer.prototype.updateAccessMode = function (t) {
    var e = this.calculateAccessMode(t),
        i = !!(e - this.accessMode);
    this.accessMode = e;
    this.map.fireEvent("accessModeChanged", [this, this.accessMode])
};
Wikimapia.Layer.BaseLayer.prototype.calculateAccessMode = function () {
    return Wikimapia.layerAccessModes.ALL
};
Wikimapia.Layer.BaseLayer.prototype.updateZoomLimits = function (t) {
    t = t || this.options.maxZoomLevel;
    this.options.maxZoomLevel = t;
    if (t !== this.map.options.maxZoomLevel) {
        this.map.options._maxZoomLevel = this.map.options.maxZoomLevel;
        this.map.options.maxZoomLevel = this.options.maxZoomLevel;
        this.map.fireEvent("zoomLimitsChanged")
    }
    if (this.map.getZoom() > t) {
        this.map.setZoom(t)
    }
};
Wikimapia.Layer.BaseLayer.prototype.restoreZoomLimits = function () {
    this.map.options.maxZoomLevel = this.map.options._maxZoomLevel;
    delete this.map.options._maxZoomLevel;
    this.map.fireEvent("zoomLimitsChanged")

};



Wikimapia.Layer.BaseLayer.prototype.onAddedToMap = function () {
    Wikimapia.Layer.prototype.onAddedToMap.call(this);
    this.updateZoomLimits()
};
Wikimapia.Layer.BaseLayer.prototype.setCursor = function (t) { };
Wikimapia.Layer.Vendor = function () { };
Wikimapia.Layer.Vendor.prototype.updateNameByType = function (t) {
    var e = this.options.name;
    this.options.name = e.replace(e.split(/[\.-]/)
        .pop(), t.split(/[\.-]/)
        .pop())
};
Wikimapia.Layer.Vendor.prototype.calculateAccessMode = function (t) {
    var e, i = Wikimapia.layerAccessModes;
    t = t || this.type.getName();
    if (/satellite/i.test(t.toLowerCase())) {
        e = i.ALL
    } else {
        e = i.VIEW | i.EDIT
    }
    return e
};
Wikimapia.Layer.Vendor.prototype.onAddedToMap = function () {
    Wikimapia.Layer.BaseLayer.prototype.onAddedToMap.call(this);
    this.updateAccessMode(this.getName())
};
Wikimapia.Layer.Vendor.prototype.addBlockingLayer = function () {
    var t = Wikimapia.Utils.Dom.create("div", {
        id: this.getName() + "-block",
        styles: {
            position: "absolute",
            top: "0px",
            left: "0px",
            width: "100%",
            height: "100%",
            "z-index": 202,
            display: "block"
        }
    });
    if (Wikimapia.Utils.alphaImageHackNeeded || Browser.ie && Browser.version < 10) {
        Wikimapia.Utils.Dom.setStyles(t, {
            background: "#ccc",
            filter: "alpha(opacity=0)",
            opacity: 0
        })
    }
    Wikimapia.Utils.Dom.inject(t, this.div)
};
Wikimapia.Layer.Features = function (t) {
    Wikimapia.Layer.prototype.constructor.call(this, t);
    this.features = [];
    this.unrenderedFeatures = {};
    this.handlers.onMoveEnd = this.onMoveEnd.bind(this)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Features, Wikimapia.Layer);
Wikimapia.Layer.Features.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.prototype.options, {
    name: "wikimapia-features"
});
Wikimapia.Layer.Features.prototype.screenBoundsTolerance = .12;
Wikimapia.Layer.Features.prototype.createLayerContainer = function () {
    Wikimapia.Layer.prototype.createLayerContainer.call(this);
    Wikimapia.Utils.Dom.setStyles(this.div, {
        position: "absolute",
        top: "0px",
        left: "0px"
    })
};
Wikimapia.Layer.Features.prototype.getFeaturesCount = function () {
    return this.features.length
};
Wikimapia.Layer.Features.prototype.getFeaturesContainer = function () {
    return this.div
};
Wikimapia.Layer.Features.prototype.onMoveEnd = function (t) {
    this.checkBounds()
};
Wikimapia.Layer.Features.prototype.checkBounds = function () {
    var t = this.map.getScreenBounds(this.screenBoundsTolerance),
        e = this.getFeaturesContainer();
    for (var i = 0, a = this.features.length; i < a; i++) {
        var o = this.features[i];
        if (!o.onScreen(t)) {
            if (o.isRendered()) {
                o.destroyDom();
                this.unrenderedFeatures[o.options.id] = o
            }
        } else {
            if (!o.isRendered()) {
                o.draw();
                Wikimapia.Utils.Dom.inject(o.element, e);
                o.afterRender();
                delete this.unrenderedFeatures[o.options.id]
            }
        }
    }
};
Wikimapia.Layer.Features.prototype.addFeature = function (t) {
    if (this.features.indexOf(t) === -1) {
        this.features.push(t);
        t.layer = this;
        t.setMap(this.map)
    }
    t.draw();
    Wikimapia.Utils.Dom.inject(t.element, this.div);
    t.afterRender();
    return t
};
Wikimapia.Layer.Features.prototype.removeFeature = function (t) {
    var e = this.features.indexOf(t);
    if (e !== -1) {
        this.features.splice(e, 1)
    }
    delete this.unrenderedFeatures[t.options.id];
    t.destroy();
    return t
};
Wikimapia.Layer.Features.prototype.setMap = function (t) {
    Wikimapia.Layer.prototype.setMap.call(this, t);
    this.map.addEvent("moveend", this.handlers.onMoveEnd)
};
Wikimapia.Layer.Features.prototype.destroy = function () {
    this.map.removeEvent("moveend", this.handlers.onMoveEnd);
    var t;
    while (t = this.features.pop()) {
        t.destroy()
    }
    this.features = [];
    Wikimapia.Layer.prototype.destroy.call(this)
};
Wikimapia.Layer.Overlays = function (t) {
    Wikimapia.Layer.Features.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Overlays, Wikimapia.Layer.Features);
Wikimapia.Layer.Overlays.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.Features.prototype.options, {
    name: "wikimapia-overlays"
});
Wikimapia.Layer.Overlays.prototype.updateSize = function () { };
Wikimapia.Layer.Overlays.prototype.checkBounds = function () { };
Wikimapia.Layer.Vector = function (t) {
    Wikimapia.Layer.Features.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Vector, Wikimapia.Layer.Features);
Wikimapia.Layer.Vector.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.Features.prototype.options, {
    name: "wikimapia-vector"
});
Wikimapia.Layer.Vector.prototype.renderer = null;
Wikimapia.Layer.Vector.prototype.featuresContainer = null;
Wikimapia.Layer.Vector.prototype.polygonEditor = null;
Wikimapia.Layer.Vector.prototype.screenBoundsTolerance = Browser.opera ? 0 : .1;
Wikimapia.Layer.Vector.prototype.createLayerContainer = function () {
    Wikimapia.Layer.Features.prototype.createLayerContainer.call(this);
    Wikimapia.Utils.Dom.setStyle(this.div, "-webkit-backface-visibility", "hidden");
    this.position = new Wikimapia.Point(0, 0)
};
Wikimapia.Layer.Vector.prototype.setMap = function (t) {
    Wikimapia.Layer.Features.prototype.setMap.call(this, t);
    this.div.id = "wikimapia-vector-layer";
    this.updateSize()
};
Wikimapia.Layer.Vector.prototype.loadMapObject = function () {
    var t = {
        map: this.map,
        layer: this
    },
        e = Wikimapia.Renderer.SVG.isSupported();
    this.featuresContainer = this.div;
    this.div.style.zIndex = this.zIndex;
    this.renderer = new Wikimapia.Renderer[e ? "SVG" : "VML"](t);
    if (e) {
        var i = this.renderer.createRoot(),
            a = this.map.getSize(),
            o = i.style;
        this.renderer.setRootBounds(i, this.map.getBounds(), {});
        o.zIndex = this.zIndex + 1;
        o.position = "absolute";
        o.pointerEvents = "none";
        o.visibility = "visible";
        i.id = "vector-root";
        this.svgViewBounds = i.getAttributeNS(null, "viewBox")
            .toString()
            .split(" ")
            .map(function (t) {
                return parseInt(t, 10)
            });
        this.div.appendChild(i);
        this.renderer.svgRoot = i;
        this.svgRoot = i;
        this.featuresContainer = this.svgRoot
    }
};
Wikimapia.Layer.Vector.prototype.addFeature = function (t) {
    this.features.push(t);
    t.setMap(this.map);
    t.setLayer(this);
    if (t.onScreen(this.map.getScreenBounds(this.screenBoundsTolerance))) {
        t.draw();
        if (t.isRendered()) {
            Wikimapia.Utils.Dom.inject(t.element, this.svgRoot || this.div);
            t.afterRender()
        }
    } else {
        this.unrenderedFeatures[t.options.id] = t
    }
    return t
};
Wikimapia.Layer.Vector.prototype.removeFeature = function (t) {
    var e = this.features.indexOf(t);
    if (e != -1) {
        this.features.splice(e, 1);
        t.destroy();
        delete t.map
    }
    return t
};
Wikimapia.Layer.Vector.prototype.getFeatureById = function (t) {
    var e = null;
    for (var i = 0, a = this.features.length; i < a; i++) {
        if (t == this.features[i].options.id) {
            e = this.features[i];
            break
        }
    }
    return e
};
Wikimapia.Layer.Vector.prototype.setZoom = function (t) {
    Wikimapia.Layer.Features.prototype.setZoom.call(this, t);
    if (this.svgRoot) {
        this.renderer.setRootBounds(this.svgRoot, this.map.getBounds(), {});
        Wikimapia.Utils.Dom.setStyles(this.svgRoot, {
            position: "absolute",
            left: "0px",
            top: "0px"
        })
    }
    this.checkBounds();
    this.redraw(true);
    this.move({
        drag: true
    });
    return this
};
Wikimapia.Layer.Vector.prototype.setCenter = function (t, e) {
    Wikimapia.Layer.Features.prototype.setCenter.call(this, t, e);
    if (typeof e === "number") {
        if (this.svgRoot) {
            this.renderer.setRootBounds(this.svgRoot, this.map.getBounds(), {});
            Wikimapia.Utils.Dom.setStyles(this.svgRoot, {
                position: "absolute",
                left: "0px",
                top: "0px"
            })
        }
        this.checkBounds();
        this.renderer.offset = this.dragObject.position
    }
    this.redraw(true);
    if (this.svgRoot) {
        this._correctSVGRoot()
    }
};
Wikimapia.Layer.Vector.prototype.redraw = function (t) {
    if (t) {
        Wikimapia.Utils.Dom.setStyle(this.div, "display", "none");
        this.renderer.offset = this.dragObject.position;
        var e = this.map.getScreenBounds(this.screenBoundsTolerance),
            i = this.getFeaturesContainer();
        for (var a = 0, o = this.features.length; a < o; a++) {
            var n = this.features[a];
            n.geometry.clearBounds()
                .clearCachedCoords();
            if (n.onScreen(e)) {
                if (n.isRendered()) {
                    n.redraw(n.geometry)
                } else {
                    n.draw();
                    if (n.isRendered()) {
                        Wikimapia.Utils.Dom.inject(n.element, i)
                    }
                }
                n.afterRender();
                if (n.options.id in this.unrenderedFeatures) {
                    delete this.unrenderedFeatures[n.options.id]
                }
            } else {
                if (n.isRendered()) {
                    Wikimapia.Utils.Dom.destroy(n.element);
                    delete n.element
                }
                this.unrenderedFeatures[n.options.id] = n
            }
        }
        Wikimapia.Utils.Dom.setStyle(this.div, "display", "block")
    }
    return this
};
Wikimapia.Layer.Vector.prototype.moveBy = function (t) {
    this.renderer.offset = this.dragObject.position;
    if (this.svgRoot) {
        this._correctSVGRoot()
    }
};
Wikimapia.Layer.Vector.prototype._correctSVGRoot = function () {
    var t = this.svgViewBounds.slice(),
        e = this.dragObject.position,
        i = this.svgRoot;
    t[0] -= e.x;
    t[1] -= e.y;
    i.setAttributeNS(null, "viewBox", t.join(" "));
    i.style.left = -this.dragObject.position.x + "px";
    i.style.top = -this.dragObject.position.y + "px";
    i.style.position = "absolute"
};
Wikimapia.Layer.Vector.prototype.move = function (t) {
    if (t.drag) {
        this.renderer.offset = this.dragObject.position;
        if (this.svgRoot) {
            this._correctSVGRoot()
        }
    }
};
Wikimapia.Layer.Vector.prototype.getFeaturesContainer = function () {
    return this.featuresContainer
};
Wikimapia.Layer.Vector.prototype.updateSize = function (t) {
    t = t || this.map.getCurrentSize();
    Wikimapia.Layer.Features.prototype.updateSize.call(this, t);
    if (this.svgRoot) {
        var e = this.svgRoot,
            i = this.dragObject.position;
        e.style.width = t.w + "px";
        e.style.height = t.h + "px";
        this.svgViewBounds[2] = t.w;
        this.svgViewBounds[3] = t.h;
        e.setAttributeNS(null, "viewBox", this.svgViewBounds.join(" "));
        e.setAttribute("width", t.w);
        e.setAttribute("height", t.h)
    }
    this.moveBy({
        x: 0,
        y: 0
    })
};
Wikimapia.Layer.Vector.prototype.destroy = function () {
    Wikimapia.Layer.Features.prototype.destroy.call(this);
    if (this.svgRoot) {
        Wikimapia.Utils.Dom.destroy(this.svgRoot);
        delete this.svgRoot
    }
    return this
};
Wikimapia.Layer.Markers = function (t) {
    this.screenBoundsTolerance = .12;
    this.iconsContainer = null;
    this.shadowsContainer = null;
    this.position = null;
    this.dragMoved = null;
    this.dragStartPoint = null;
    this.afterDragTimer = null;
    Wikimapia.Layer.Features.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Markers, Wikimapia.Layer.Features);
Wikimapia.Layer.Markers.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.Features.prototype.options, {
    name: "wikimapia-markers",
    dragStopTimeout: 1500,
    afterDragDelay: 50
});
Wikimapia.Layer.Markers.prototype.createLayerContainer = function () {
    this.div = Wikimapia.Utils.Dom.create("div", {
        id: this.getName() + "-layer",
        styles: {
            width: "100%",
            height: "100%"
        }
    });
    var t = {
        position: "absolute",
        top: "0px",
        left: "0px"
    };
    this.shadowsContainer = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: "wikimapia-marker-shadows-container",
        styles: t
    }), this.div);
    this.iconsContainer = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: "wikimapia-marker-icons-container",
        styles: t
    }), this.div);
    this.position = new Wikimapia.Point(0, 0)
};
Wikimapia.Layer.Markers.prototype.addMarker = function (t) {
    this.features.push(t);
    var e = this.features[this.features.length - 1],
        i = this.map.getScreenBounds(this.screenBoundsTolerance);
    e.setMap(this.map);
    e.layer = this;
    if (e.onScreen(i)) {
        this.grabMarker(e)
    } else {
        this.unrenderedFeatures[e.options.id] = e
    }
    if (e.options.draggable) {
        this.makeDraggable(e, true)
    }
    return e
};
Wikimapia.Layer.Markers.prototype.grabMarker = function (t) {
    t.create();
    t.icon.create();
    this.iconsContainer.appendChild(t.icon.image);
    if (t.options.zIndex) {
        t.setZIndex(t.options.zIndex)
    }
    if (t.icon.shadow) {
        this.shadowsContainer.appendChild(t.icon.shadow)
    }
    t.draw();
    t.fireEvent("rendered")
};
Wikimapia.Layer.Markers.prototype.startDragHandler = function (t) {
    var e = this.layer;
    if (!e.dragStartPoint && !Wikimapia.Map.Handler.Mouse.isRightClick(t)) {
        this._draggingStarted = true;
        t.stop();
        e.startMarkerDrag(this)
    }
};
Wikimapia.Layer.Markers.prototype.makeDraggable = function (t, e) {
    if (e && !t._draggable) {
        t._draggable = true;
        t.addEvent("mousedown", this.startDragHandler);
        t.options.draggable = true
    } else if (!e && t._draggable) {
        delete t._draggable;
        t.removeEvent("mousedown", this.startDragHandler);
        delete t.options.draggable
    }
};
Wikimapia.Layer.Markers.prototype.startMarkerDrag = function (t) {
    var e = this,
        i = this.map.getSize(),
        a;
    clearTimeout(this.afterDragTimer);
    this.markerDragHandler = function (i) {
        e.dragMarker.apply(e, [i, t])
    };
    this.markerStopDragHandler = function (i) {
        e.stopDragMarker.apply(e, [i, t])
    };
    this.dragStartPoint = this.map.getMousePosition()
        .clone();
    this.dragMoved = false;
    this.pxBounds = new Wikimapia.Bounds({
        left: 0,
        top: i.h,
        right: i.w,
        bottom: 0
    });
    a = t.icon;
    a.oldZIndex = a.image.style.zIndex || 1100;
    a.image.style.zIndex = 1200;
    Wikimapia.Utils.Dom.addEvents(document, {
        mousemove: this.markerDragHandler,
        mouseup: this.markerStopDragHandler
    });
    t.addEvent("mouseup", this.markerStopDragHandler);
    this.map.fireEvent("featureDragStart", t)
};
Wikimapia.Layer.Markers.prototype.dragMarker = function (t, e) {
    var i = this.map.getMousePosition(),
        a = i.subtract(this.dragStartPoint.x, this.dragStartPoint.y);
    clearTimeout(this.dragStopTimer);
    if (!a.x && !a.y) {
        return
    }
    if (!this.dragMoved) {
        var o = e.getContainerPosition();
        this.dragStartPoint = i.clone();
        this.dragOffset = i.subtract(o.x, o.y);
        e.fireEvent("startDrag", e);
        e._omitClick = true;
        this.dragMoved = true
    }
    var n = this.dragStartPoint,
        s = i.subtract(n.x, n.y);
    if (this.pxBounds.containsPixel(i, true)) {
        this.dragStartPoint = i.clone();
        this.draggingMarker = true;
        if (!e.snapped) {
            e.moveTo(e.getContainerPosition()
                .add(s.x, s.y));
            e.setLatLng(this.map.fromContainerPixelToLatLng(i.subtract(this.dragOffset.x, this.dragOffset.y)), false)
        }
        e.fireEvent("drag", e)
    } else {
        this.stopDragMarker(t, e)
    }
    this.dragStopTimer = setTimeout(function () {
        this.stopDragMarker(Wikimapia.Utils.Event.create("mouseup", {
            client: this.map.mouseAt
        }), e)
    }.bind(this), this.options.dragStopTimeout);
    return false
};
Wikimapia.Layer.Markers.prototype.stopDragMarker = function (t, e) {
    if (t) {
        t.stop()
    }
    this.map.omitNextClick = 1;
    this.afterDragTimer = setTimeout(this.afterMarkerDrag.bind(this), this.options.afterDragDelay);
    delete e._draggingStarted;
    e.setLatLng(e.getLatLng(), true);
    Wikimapia.Utils.Dom.removeEvents(document, {
        mousemove: this.markerDragHandler,
        mouseup: this.markerStopDragHandler
    });
    var i = e.icon;
    if (i && i.image && !!i.oldZIndex) {
        i.image.style.zIndex = i.oldZIndex;
        delete i.oldZIndex
    }
    clearTimeout(this.dragStopTimer);
    delete this.dragStartPoint;
    delete this.dragMoved;
    e.removeEvent("mouseup", this.markerStopDragHandler);
    e.fireEvent("stopDrag", e);
    return false
};
Wikimapia.Layer.Markers.prototype.afterMarkerDrag = function () {
    this.map.omitNextClick = 0
};
Wikimapia.Layer.Markers.prototype.removeMarker = function (t) {
    var e = this.features;
    for (var i = 0, a = e.length; i < a; i++) {
        if (e[i] === t) {
            e.splice(i, 1);
            t.destroy();
            delete t.map;
            break
        }
    }
    return t
};
Wikimapia.Layer.Markers.prototype.setZIndex = function (t) {
    Wikimapia.Utils.Dom.setStyle(this.div, "z-index", t);
    Wikimapia.Utils.Dom.setStyle(this.iconsContainer, "z-index", t + 2);
    Wikimapia.Utils.Dom.setStyle(this.shadowsContainer, "z-index", t + 1)
};
Wikimapia.Layer.Markers.prototype.checkBounds = function () {
    var t = this.map.getScreenBounds(this.screenBoundsTolerance);
    for (var e = 0, i = this.getFeaturesCount() ; e < i; e++) {
        var a = this.features[e];
        if (a.onScreen(t)) {
            if (a.isRendered()) {
                a.draw(this.map.fromLatLngToContainerPixel(a.getLatLng()))
            } else {
                this.grabMarker(a)
            }
            if (a.options.id in this.unrenderedFeatures) {
                delete this.unrenderedFeatures[a.options.id]
            }
        } else {
            this.unrenderedFeatures[a.options.id] = a;
            if (a.isRendered()) {
                a.destroyDom()
            }
        }
    }
};
Wikimapia.Layer.Markers.prototype.setZoom = function (t) {
    Wikimapia.Layer.Features.prototype.setZoom.call(this, t);
    this.checkBounds();
    return this
};
Wikimapia.Layer.Markers.prototype.setCenter = function (t) {
    Wikimapia.Layer.Features.prototype.setCenter.call(this, t);
    for (var e = 0, i = this.features.length; e < i; e++) {
        var a = this.features[e];
        a.moveTo(this.map.fromLatLngToContainerPixel(a.options.coords))
    }
};
Wikimapia.Layer.Markers.prototype.getFeaturesCount = function () {
    return this.features.length
};
Wikimapia.Layer.Markers.prototype.getRenderedMarkersCount = function () {
    var t = 0,
        e = this.map.getScreenBounds(this.screenBoundsTolerance);
    for (var i = 0, a = this.features.length; i < a; i++) {
        if (this.features[i].onScreen(e)) {
            t++
        }
    }
    return t
};
Wikimapia.Layer.Grid = function (t) {
    Wikimapia.Layer.prototype.constructor.call(this, t);
    this.initLanguage();
    this.removedTiles = [];
    this.grid = {};
    this.tileSize = this.options.tileSize;
    this.tileFactor = Math.log(this.tileSize.w) / Math.LN2;
    this.addEvent("tilesLoaded", Wikimapia.Utils.noop)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Grid, Wikimapia.Layer);
Wikimapia.Layer.Grid.prototype.URL_HASH_FACTOR = (Math.sqrt(5) - 1) / 2;
Wikimapia.Layer.Grid.prototype.tileSize = null;
Wikimapia.Layer.Grid.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.prototype.options, {
    name: "grid",
    buffer: 0,
    tileSize: new Wikimapia.Size(256, 256),
    offset: null,
    startTile: null,
    rows: 0,
    cols: 0,
    maxReusableTiles: 8
});
Wikimapia.Layer.Grid.prototype.dragObject = null;
Wikimapia.Layer.Grid.prototype.numLoadingTiles = 0;
Wikimapia.Layer.Grid.prototype.extent = null;
Wikimapia.Layer.Grid.prototype.tilesBounds = new Wikimapia.Bounds;
Wikimapia.Layer.Grid.prototype.initialized = false;
Wikimapia.Layer.Grid.prototype.initLanguage = function () {
    if (typeof this.options.lang === "undefined") {
        this.options.lang = Wikimapia.Lang.getCurrentLanguage()
    }
    this.options.langCode = Wikimapia.Lang.lngToCode(this.options.lang)
};
Wikimapia.Layer.Grid.prototype.clone = function (t) {
    if (!t) {
        t = new Wikimapia.Layer.Grid(this.options)
    }
    if (!this.tileSize) {
        t.tileSize = this.tileSize.clone()
    }
    t.grid = {};
    return t
};
Wikimapia.Layer.Grid.prototype.loadMapObject = function () {
    var t = this.map.getBounds() || this.getBounds();
    this.handlers.tilesMonitor = this.tilesMonitor.bind(this);
    if (t) {
        var e = this.getTilesBounds(),
            i = !this.grid.length || !e;
        if (i || !e.containsBounds(t)) {
            this.update(t)
        }
    }
    Wikimapia.Layer.prototype.loadMapObject.call(this);
    this.initialized = true
};
Wikimapia.Layer.Grid.prototype.update = function (t, e) {
    e = e || this.map.getSize();
    var i = this.map.fromLatLngToPixel(new Wikimapia.LatLng(t.top, t.left)),
        a = this.tileSize,
        o = this.options,
        n = this.dragObject.position,
        s = Math.floor,
        r = Math.ceil,
        p = new Wikimapia.Bounds({
            left: s(i.x / a.w - o.buffer),
            top: s(i.y / a.h - o.buffer),
            right: r((i.x + e.w) / a.w + o.buffer),
            bottom: r((i.y + e.h) / a.h + o.buffer)
        });
    o.startTile = new Wikimapia.Point(p.left, p.top);
    o.offset = new Wikimapia.Point(o.startTile.x * a.w - i.x - n.x, o.startTile.y * a.w - i.y - n.y);
    o.rows = p.bottom - p.top;
    o.cols = p.right - p.left;
    this.loadTiles(p);
    this.removeRedundantTiles(p)
};
Wikimapia.Layer.Grid.prototype.loadTiles = function (t) {
    var e = this.options,
        i = [],
        a, o, n, s = t.getCenterPixel();
    for (var a = t.left, r = t.right; a < r; a++) {
        for (var p = t.top, l = t.bottom; p < l; p++) {
            if (!(a + ":" + p in this.grid)) {
                n = this.grid[a + ":" + p] = this.getTile(a, p);
                i.push(n)
            }
        }
    }
    if (i.length === 0) return;
    i.sort(function (t, e) {
        return Math.pointsDistance(t.x, t.y, s.x, s.y) - Math.pointsDistance(e.x, e.y, s.x, s.y)
    });
    this.numLoadingTiles += i.length;
    this.tilesMonitor("queueStart", i.length);
    for (a = 0, o = i.length; a < o; a++) {
        i[a].draw()
    }
};
Wikimapia.Layer.Grid.prototype.getTile = function (t, e) {
    var i;
    if (this.removedTiles.length) {
        i = this.removedTiles.pop();
        i.x = t;
        i.y = e
    } else {
        i = this.addTile({
            x: t,
            y: e
        })
    }
    this.addTileObservers(i);
    return i
};
Wikimapia.Layer.Grid.prototype.removeRedundantTiles = function (t) {
    for (var e in this.grid) {
        var i = e.split(":"),
            a = parseInt(i[0]),
            o = parseInt(i[1]);
        if (a < t.left || a >= t.right || o < t.top || o >= t.bottom) {
            this.removeTile(e)
        }
    }
};
Wikimapia.Layer.Grid.prototype.removeTile = function (t) {
    var e = this.grid[t];
    this.clearTile(e);
    e.unload();
    this.removeTileObservers(e);
    if (this.removedTiles.length < this.options.maxReusableTiles) {
        this.removedTiles.push(e)
    } else {
        e.destroy()
    }
    delete this.grid[t]
};
Wikimapia.Layer.Grid.prototype.updateSize = function (t) {
    Wikimapia.Layer.prototype.updateSize.call(this, t);
    if (t) {
        this.update(this.getBounds(), t);
        for (var e in this.grid) {
            this.grid[e].draw()
        }
    }
};
Wikimapia.Layer.Grid.prototype.clearGrid = function (t) {
    var e = new Wikimapia.Bounds;
    this.removeRedundantTiles(e);
    this.grid = {};
    if (!t) {
        this.clearRemovedTiles()
    }
};
Wikimapia.Layer.Grid.prototype.clearRemovedTiles = function () {
    for (var t = 0, e = this.removedTiles.length; t < e; t++) {
        this.removedTiles[t].destroy()
    }
    this.removedTiles = []
};
Wikimapia.Layer.Grid.prototype.tilesMonitor = function (t) {
    if (t === "loadend" && this.numLoadingTiles > 0) {
        this.numLoadingTiles = Math.max(0, this.numLoadingTiles - 1);
        if (this.numLoadingTiles === 0) {
            this.fireEvent("tilesLoaded");
            this.tilesLoaded()
        } else {
            this.fireEvent("tilesProgress")
        }
    } else if (t === "queueStart") {
        this.fireEvent("tilesStart")
    }
};
Wikimapia.Layer.Grid.prototype.getTilePosition = function (t, e) {
    var i = this.options,
        a = i.offset,
        o = this.tileSize;
    return new Wikimapia.Point(a.x + o.w * (t - i.startTile.x), a.y + o.h * (e - i.startTile.y))
};
Wikimapia.Layer.Grid.prototype.getTilesBounds = function () {
    if (this.options.startTile) {
        var t = this.options,
            e = t.startTile.x,
            i = t.startTile.y;
        this.bounds = this.getTileBounds(e, i)
            .extend(this.getTileBounds(e + t.cols, i + t.rows))
    }
    return this.bounds
};
Wikimapia.Layer.Grid.prototype.getTilesPxBounds = function () {
    var t = this.tilesBounds,
        e = this.options,
        i = this.tileSize,
        a = e.offset,
        o = this.dragObject.position;
    t.left = a.x + o.x;
    t.top = a.y + o.y;
    t.right = t.left + e.cols * i.w;
    t.bottom = t.top + e.rows * i.h;
    return t
};
Wikimapia.Layer.Grid.prototype.tilesCoverViewport = function (t, e) {
    var i = t.top > 0 || t.left > 0 || t.right < e.right || t.bottom < e.bottom;
    return !i
};
Wikimapia.Layer.Grid.prototype.moveBy = function (t) {
    var e = this.getTilesPxBounds(),
        i = this.map.getSize(),
        a = this.map.getBounds();
    this.viewPort = this.viewPort || Wikimapia.Bounds.fromSize(i);
    if (!e.containsBounds(this.viewPort)) {
        this.update(a, i)
    }
};
Wikimapia.Layer.Grid.prototype.setZoom = function (t, e) {
    if (t !== this.options.zoom) {
        this.numLoadingTiles = 0;
        if (t >= this.options.minZoomLevel && t <= this.options.maxZoomLevel) {
            this.URL_HASH_FACTOR *= Math.random();
            this.bounds = null;
            this.update(this.getBounds());
            this.clearRemovedTiles()
        } else {
            this.zoomError()
        }
        this.options.zoom = t
    }
    return this
};
Wikimapia.Layer.Grid.prototype.zoomError = function () {
    this.clearGrid()
};
Wikimapia.Layer.Grid.prototype.setCenter = function (t, e) {
    Wikimapia.Layer.prototype.setCenter.call(this, t, e);
    if (typeof e === "number") {
        this.setZoom(e)
    } else if (this.initialized) {
        var i = this.getTilesPxBounds(),
            a = this.map.getSize(),
            o = this.map.getBounds();
        this.viewPort = this.viewPort || Wikimapia.Bounds.fromSize(a);
        if (!i.containsBounds(this.viewPort)) {
            this.update(o, a)
        }
    }
};
Wikimapia.Layer.Grid.prototype.addTile = function (t) {
    t.layer = this;
    return new Wikimapia.Tile.Image(t)
};
Wikimapia.Layer.Grid.prototype.clearTile = function (t) {
    return t
};
Wikimapia.Layer.Grid.prototype.getTileBounds = function (t, e) {
    var i = this.tileSize,
        a = new Wikimapia.Point(t * i.w, e * i.h),
        o = this.map.fromPixelToLatLng(a),
        n = this.map.fromPixelToLatLng(a.add(i.w, i.h)),
        s = new Wikimapia.Bounds({
            top: o.lat,
            left: o.lng,
            bottom: n.lat,
            right: n.lng
        });
    return s
};
Wikimapia.Layer.Grid.prototype.addTileObservers = function (t) {
    var e = this.handlers.tilesMonitor;
    return t
};
Wikimapia.Layer.Grid.prototype.removeTileObservers = function (t) {
    if (t) {
        var e = this.handlers.tilesMonitor;
        t.unload()
    }
};
Wikimapia.Layer.Grid.prototype.outlineTiles = function () {
    this.removeTileOutlines();
    this.tileOutlines = [];
    for (var t in this.grid) {
        var e = this.grid[t];
        this.tileOutlines.push(this.map.addVectorFeature(new Wikimapia.Polygon({
            geometry: Wikimapia.Geometry.fromMBR(this.getTileBounds(e.x, e.y), true),
            style: {
                strokeWidth: .5,
                fillOpacity: .2
            }
        })))
    }
};
Wikimapia.Layer.Grid.prototype.removeTileOutlines = function () {
    if (this.tileOutlines) {
        for (var t = 0, e = this.tileOutlines.length; t < e; t++) {
            this.map.removeVectorFeature(this.tileOutlines[t])
        }
    }
};
Wikimapia.Layer.Grid.prototype.redraw = function () {
    this.loadedTiles = [];
    this.update(this.getBounds())
};
Wikimapia.Layer.Grid.prototype.destroy = function () {
    this.clearGrid();
    this.grid = null;
    this.tileSize = null;
    Wikimapia.Layer.prototype.destroy.call(this)
};
Wikimapia.Layer.TileLayer = function (t) {
    Wikimapia.Layer.Grid.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.TileLayer, Wikimapia.Layer.Grid);
Wikimapia.Layer.TileLayer.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.Grid.prototype.options, {
    url: "",
    type: ""
});
Wikimapia.Layer.TileLayer.prototype.hash = 0;
Wikimapia.Layer.TileLayer.prototype.onLanguageChange = function (t) {
    Wikimapia.Layer.Grid.prototype.onLanguageChange.call(this, t);
    this.redraw()
};
Wikimapia.Layer.TileLayer.prototype.tilesLoaded = function () {
    this.fireEvent("tilesLoaded", this);
    Wikimapia.Layer.prototype.loaded.call(this)
};
Wikimapia.Layer.TileLayer.prototype.renderTile = function (t, e, i, a, o) { };
Wikimapia.Layer.TileLayer.prototype.selectUrl = function (t, e) {
    var i = 1;
    for (var a = 0, o = t.length; a < o; a++) {
        i *= t.charCodeAt(a) * this.URL_HASH_FACTOR;
        i -= Math.floor(i)
    }
    return e[Math.floor(i * e.length)]
};
Wikimapia.Layer.TileLayer.prototype.getTileUrl = function (t, e, i) { };
Wikimapia.Layer.TileLayer.prototype.loadMapObject = function () {
    this.initHash();
    Wikimapia.Layer.Grid.prototype.loadMapObject.call(this)
};
Wikimapia.Layer.TileLayer.prototype.redraw = function () {
    this.refreshHash();
    this.loadTilesQueue()
};
Wikimapia.Layer.TileLayer.prototype.loadTilesQueue = function () {
    var t = this.options,
        e = [],
        i, a, o, n = new Wikimapia.Point(t.startTile.x + t.cols / 2, t.startTile.y + t.rows / 2);
    this.loadedTiles = [];
    for (o in this.grid) {
        e.push(this.grid[o])
    }
    e.sort(function (t, e) {
        return Math.pointsDistance(t.x, t.y, n.x, n.y) - Math.pointsDistance(e.x, e.y, n.x, n.y)
    });
    this.numLoadingTiles += e.length;
    this.tilesMonitor("queueStart", this.numLoadingTiles);
    for (i = 0, a = e.length; i < a; i++) {
        e[i].draw()
    }
};
Wikimapia.Layer.TileLayer.prototype.initHash = function () {
    this.refreshHash()
};
Wikimapia.Layer.TileLayer.prototype.refreshHash = function () {
    this.hash = Math.round(Math.random() * 1e7);
    return this.hash
};
Wikimapia.Layer.TileLayer.prototype.toQuadKey = function (t, e, i) {
    return Wikimapia.Utils.getQuadKey(t, e, i, this.tileFactor)
};
Wikimapia.Layer.ImageTiles = function (t) {
    Wikimapia.Layer.TileLayer.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.ImageTiles, Wikimapia.Layer.TileLayer);
Wikimapia.Layer.ImageTiles.prototype.createLayerContainer = function () {
    Wikimapia.Layer.prototype.createLayerContainer.call(this);
    Wikimapia.Utils.Dom.addClass(this.div, "wikimapia-layer-imagetiles")
};
Wikimapia.Layer.ImageTiles.prototype.getTileUrl = function (t, e, i) {
    var a = this.options,
        o, n;
    i = i || this.map.getZoom();
    o = 1 << i;
    if (e < 0 || e > o) {
        return Wikimapia.Utils.blankImage
    }
    t = (t % o + o) % o;
    return this.options.url.substitute({
        picserver: Wikimapia.Utils.picServerFunction(t, e, i),
        x: t,
        y: e,
        zoom: i,
        type: a.type,
        random: this.hash,
        lng: a.langCode
    })
};
Wikimapia.Layer.ImageTiles.Map = function (t) {
    Wikimapia.Layer.ImageTiles.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.ImageTiles.Map, Wikimapia.Layer.ImageTiles);
Wikimapia.Utils.mixin(Wikimapia.Layer.ImageTiles.Map, Wikimapia.Layer.BaseLayer);
Wikimapia.Layer.ImageTiles.Map.prototype.onAddedToMap = function () {
    Wikimapia.Layer.BaseLayer.prototype.onAddedToMap.call(this);
    this.updateAccessMode(this.getName())
};
Wikimapia.Layer.ImageTiles.Map.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.ImageTiles.prototype.options, Wikimapia.Layer.BaseLayer.prototype.options, {
    name: "wikimapia.imagetiles.map",
    type: "map",
    url: window.wikimapiaTileUrlTemplate || "http://i{picserver}.wikimapia.org/?x={x}&y={y}&zoom={zoom}&r={random}&type={type}&lng={lng}"
});
Wikimapia.Layer.ImageTiles.Map.prototype.onAddedToMap = function () {
    Wikimapia.Layer.BaseLayer.prototype.onAddedToMap.call(this);
    this.updateAccessMode(this.getName())
};
Wikimapia.supportedLayers["wikimapia.imagetiles.map"] = {
    layerConstructor: Wikimapia.Layer.ImageTiles.Map,
    defaultOptions: {
        name: "wikimapia.imagetiles.map",
        type: "map",
        maxZoomLevel: 22,
        attribution: '<a onclick="router.route(\'/terms_reference.html\');return false" class="map" href="#">Wikimapia CC-BY-SA</a>',
        url: window.wikimapiaTileUrlTemplate || "http://i{picserver}.wikimapia.org/?x={x}&y={y}&zoom={zoom}&r={random}&type={type}&lng={lng}"
    }
};
Wikimapia.Layer.ImageTiles.Hybrid = function (t) {
    Wikimapia.Layer.ImageTiles.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.ImageTiles.Hybrid, Wikimapia.Layer.ImageTiles);
Wikimapia.Layer.ImageTiles.Hybrid.prototype.googleMapsMapType = null;
Wikimapia.Layer.ImageTiles.Hybrid.prototype.mapObjectCreated = false;
Wikimapia.Layer.ImageTiles.Hybrid.prototype.baseLayerReady = function () {
    return !(this.map.baseLayer && this.map.baseLayer instanceof Wikimapia.Layer.Google && this.map.baseLayer.mapObject === null)
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.needsGoogleMapsIntegration = function () {
    return this.map.baseLayer instanceof Wikimapia.Layer.Google && Math.floor(this.map.baseLayer.options.apiVersion) >= 3
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.setMap = function (t) {
    Wikimapia.Utils.bindHandlers(this, "onBaseLayerChanged", "loadMapObject");
    Wikimapia.Layer.ImageTiles.prototype.setMap.call(this, t)
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.loadMapObject = function () {
    if (this.baseLayerReady()) {
        if (this.needsGoogleMapsIntegration()) {
            this.createGoogleMapsMapType();
            this.integrateToGoogleMapsBaseLayer();
            this.addAttribution()
        } else {
            Wikimapia.Layer.ImageTiles.prototype.loadMapObject.call(this)
        }
    } else {
        this.map.baseLayer.addEventOnce("mapObjectCreated", this.handlers.loadMapObject);
        this.map.addEvent("baseLayerSet", this.handlers.onBaseLayerChanged)
    }
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.redraw = function () {
    if (this.googleMapsMapType) {
        this.refreshHash();
        this.googleMapsMapType.redraw()
    } else {
        Wikimapia.Layer.ImageTiles.prototype.redraw.call(this)
    }
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.updateSize = function (t) {
    if (this.initialized) {
        Wikimapia.Layer.ImageTiles.prototype.updateSize.call(this, t)
    }
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.integrateToGoogleMapsBaseLayer = function () {
    this.map.baseLayer.mapObject.overlayMapTypes.push(this.googleMapsMapType);
    this.clearGrid();
    this.__moveBy = this.moveBy;
    this.moveBy = Wikimapia.Utils.Empty;
    this.__setCenter = this.setCenter;
    this.setCenter = Wikimapia.Utils.Empty;
    this.__setZoom = this.setZoom;
    this.setZoom = Wikimapia.Utils.Empty;
    this.__updateSize = this.updateSize;
    this.updateSize = Wikimapia.Utils.Empty;
    this.externalTilesLoadedListener = google.maps.event.addListener(this.googleMapsMapType, "tilesloaded", this.tilesLoaded.bind(this))
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.detachFromGoogleMapsBaseLayer = function () {
    if (this.map.baseLayer.mapObject) {
        this.map.baseLayer.mapObject.overlayMapTypes.pop()
    }
    this.moveBy = this.__moveBy;
    delete this.__moveBy;
    this.setCenter = this.__setCenter;
    delete this.__setCenter;
    this.setZoom = this.__setZoom;
    delete this.__setZoom;
    this.updateSize = this.__updateSize;
    delete this.__updateSize;
    google.maps.event.removeListener(this.externalTilesLoadedListener)
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.createGoogleMapsMapType = function () {
    var t = this;
    this.googleMapsMapType = new google.maps.ImageMapType({
        getTileUrl: function (e, i) {
            return t.getTileUrl(e.x, e.y, i)
        },
        name: this.getName(),
        tileSize: new google.maps.Size(this.tileSize.w, this.tileSize.h)
    });
    (function () {
        this.___tiles = [];
        this.___getTile = this.getTile;
        this.getTile = function (t, e) {
            var i = this.___getTile.apply(this, arguments);
            if (i) {
                this.___tiles.push(i);
                i.setAttribute("data-coords", t.x + "," + t.y + "," + e)
            }
            return i
        };
        this.___releaseTile = this.releaseTile;
        this.releaseTile = function (t) {
            this.___releaseTile.apply(this, arguments);
            this.___tiles.splice(this.___tiles.indexOf(t), 1);
            return t
        };
        this.redraw = function () {
            for (var e = 0, i = this.___tiles.length; e < i; e++) {
                var a = this.___tiles[e],
                    o = a.getAttribute("data-coords")
                    .split(","),
                    n = parseInt(o[2], 10),
                    s = t.getTileUrl(parseInt(o[0], 10), parseInt(o[1], 10), n);
                a.children[0].setAttribute("src", s)
            }
        }
    })
    .call(this.googleMapsMapType)
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.onBaseLayerChanged = function () {
    var t = this.needsGoogleMapsIntegration();
    if (this.googleMapsMapType && !t) {
        this.detachFromGoogleMapsBaseLayer();
        delete this.googleMapsMapType;
        this.loadMapObject()
    } else if (t && !this.googleMapsMapType) {
        this.clearGrid();
        this.loadMapObject()
    }
};
Wikimapia.Layer.ImageTiles.Hybrid.prototype.destroy = function () {
    this.map.removeEvent("baseLayerSet", this.handlers.onBaseLayerChanged);
    this.map.baseLayer.removeEvent("mapObjectCreated", this.handlers.loadMapObject);
    if (this.googleMapsMapType) {
        this.detachFromGoogleMapsBaseLayer();
        delete this.googleMapsMapType
    }
    Wikimapia.Layer.ImageTiles.prototype.destroy.call(this)
};
Wikimapia.supportedLayers["wikimapia.imagetiles.hybrid"] = {
    layerConstructor: Wikimapia.Layer.ImageTiles.Hybrid,
    defaultOptions: {
        name: "wikimapia.imagetiles.hybrid",
        type: "hybrid",
        maxZoomLevel: 22,
        attribution: '<a onclick="router.route(\'/terms_reference.html\');return false" class="hybrid" href="#">Wikimapia CC-BY-SA</a>',
        url: window.wikimapiaTileUrlTemplate || "http://i{picserver}.wikimapia.org/?x={x}&y={y}&zoom={zoom}&r={random}&type={type}&lng={lng}"
    }
};
Wikimapia.Layer.Editor = function () { };
Wikimapia.Layer.Editor.prototype.needsSave = false;
Wikimapia.Layer.Editor.prototype.editing = false;
Wikimapia.Layer.Editor.prototype.options = {
    minSaveLevel: 14,
    minLoadLevel: 0
};
Wikimapia.Layer.Editor.prototype.cache = new Wikimapia.Cache;
Wikimapia.Layer.Editor.prototype.blocked = false;
Wikimapia.Layer.Editor.prototype.enabled = false;
Wikimapia.Layer.Editor.prototype.loadingBar = null;
Wikimapia.Layer.Editor.prototype.tooltip = null;
Wikimapia.Layer.Editor.prototype.saveStatus = {
    needed: false,
    allowedByZoom: true,
    allowedByLayerAccess: false
};


Wikimapia.Layer.Editor.prototype.initialStatusMessage = "";
Wikimapia.Layer.Editor.prototype.initialStatusIcon = null;
Wikimapia.Layer.Editor.prototype.statusHelpLink = "";
Wikimapia.Layer.Editor.prototype.initBlocks = function () {
    Wikimapia.Utils.extend(this.handlers, {
        mapWindowOpened: this.block.bind(this),
        mapWindowClosed: this.unblock.bind(this),
        moveStart: this.onMoveStart.bind(this),
        moveEnd: this.enable.bind(this),
        geometryEditFailure: this.onGeometryEditFailure.bind(this),
        keyboard: this.keyboard.bind(this)
    });
    this.map.addEvents({
        windowOpened: this.handlers.mapWindowOpened,
        windowClosed: this.handlers.mapWindowClosed,
        panelClosed: this.handlers.mapWindowClosed,
        movestart: this.handlers.moveStart,
        moveend: this.handlers.moveEnd,
        dragstart: this.handlers.moveStart,
        dragend: this.handlers.moveEnd,
        editorLaunched: this.handlers.moveStart,
        editorStopped: this.handlers.moveEnd,
        geometryEditError: this.handlers.geometryEditFailure
    });
    this.unblock()
};
Wikimapia.Layer.Editor.prototype.onMoveStart = function (t) {
    if (t && t === this) {
        return
    } else {
        this.disable()
    }
};
Wikimapia.Layer.Editor.prototype.removeBlocks = function () {
    if (this.handlers.mapWindowOpened && this.handlers.mapWindowClosed) {
        this.map.removeEvents({
            windowOpened: this.handlers.mapWindowOpened,
            windowClosed: this.handlers.mapWindowClosed,
            panelClosed: this.handlers.mapWindowClosed,
            movestart: this.handlers.moveStart,
            moveend: this.handlers.moveEnd,
            dragstart: this.handlers.moveStart,
            dragend: this.handlers.moveEnd,
            editorLaunched: this.handlers.moveStart,
            editorStopped: this.handlers.moveEnd,
            geometryEditError: this.handlers.geometryEditFailure
        })
    }
};
Wikimapia.Layer.Editor.prototype.initCache = function () { };
Wikimapia.Layer.Editor.prototype.keyboard = function (t) {
    if (t.keyCode === Wikimapia.Utils.Event.keyCodes.ESC) {
        this.clearUI()
    }
};
Wikimapia.Layer.Editor.prototype.addTooltip = function () {
    this.tooltip = this.map.addTooltip();
    return this.tooltip
};
Wikimapia.Layer.Editor.prototype.addLoadingBar = function () {
    if (this.map) {
        if (this.loadingBar) {
            this.loadingBar.destroy();
            delete this.loadingBar
        }
        this.loadingBar = new Wikimapia.Interface;
        Wikimapia.Utils.Dom.inject(this.loadingBar.div, this.map.getControlsContainer())
    }
};
Wikimapia.Layer.Editor.prototype.showLoading = function (t) {
    window.clearTimeout(this._preloaderTimer);
    this._preloaderTimer = window.setTimeout(function () {
        if (this.map) {
            this.map.showPreloader(t)
        }
    }.bind(this), 200)
};
Wikimapia.Layer.Editor.prototype.tilesLoaded = function () {
    window.clearTimeout(this._preloaderTimer);
    this.hideLoading()
};
Wikimapia.Layer.Editor.prototype.hideLoading = function () {
    this.map.hidePreloader()
};
Wikimapia.Layer.Editor.prototype.isEnabled = function () {
    return this.mode & this.modes.ENABLED
};
Wikimapia.Layer.Editor.prototype.block = function () {
    if (!this.blocked) {
        Wikimapia.Utils.Dom.removeEvent(document, "keyup", this.handlers.keyboard);
        this.map.statusbar.hide();
        this.blocked = true
    }
};
Wikimapia.Layer.Editor.prototype.unblock = function () {
    if (this.blocked) {
        Wikimapia.Utils.Dom.addEvent(document, "keyup", this.handlers.keyboard);
        this.blocked = false
    }
};
Wikimapia.Layer.Editor.prototype.initAccessMode = function () {
    this.saveStatus.allowedByLayerAccess = this.map.access.allowsFeatureSave();
    return this.map.access.getAccessMode()
};
Wikimapia.Layer.Editor.prototype.initStatusBar = function (t) {
    for (var e in this.saveStatus) {
        this.saveStatus[e] = false
    }
    if (!this.checkZoom()) {
        this.dispatchZoomErrorNotification()
    } else if (!this.map.access.allowsFeatureSave()) {
        this.dispatchBaseLayerErrorNotification()
    }
    this.map.statusbar.init({
        icon: t.icon || this.initialStatusIcon,
        message: t.message || this.getStatusMessage("ok"),
        onSave: t.onSave,
        onCancel: t.onCancel,
        summary: t.summary,
        allowSaveByDefault: t.allowSaveByDefault
    })
};
Wikimapia.Layer.Editor.prototype.dispatchZoomErrorNotification = function (t) {
    this.map.fireEvent("notification", {
        message: t || "all.zoomin-closer",
        timeout: 0,
        hideOnClick: false
    })
};
Wikimapia.Layer.Editor.prototype.dispatchLoadingNotification = function (t) {
    this.map.fireEvent("notification", {
        message: "all.loading",
        timeout: 0,
        hideOnClick: false
    })
};
Wikimapia.Layer.Editor.prototype.dispatchBaseLayerErrorNotification = function () {
    this.map.fireEvent("notification", {
        message: "all.switch-to-satellite"
    })
};
Wikimapia.Layer.Editor.prototype.dispatchClearNotification = function () {
    this.map.fireEvent("notification", null)
};
Wikimapia.Layer.Editor.prototype.refreshStatus = function (t) {
    t = t || this.saveStatus;
    t.allowedByZoom = this.checkZoom();
    var e = this.map.statusbar,
        i = this.map.access.allowsFeatureSave(),
        a = t.allowedByZoom && i,
        o = "ok";
    if (!a) {
        o = !t.allowedByZoom ? "zoom-in" : "satellite"
    } else {
        a = t.needed;
        this.dispatchClearNotification()
    }
    if (o !== this._statusMessage || !t.allowedByZoom) {
        this._statusMessage = o;
        if (this.map.editingInProgress()) {
            if (!t.allowedByZoom) {
                this.dispatchZoomErrorNotification()
            } else if (!i) {
                this.dispatchBaseLayerErrorNotification()
            }
        }
    }
    e.toggleSave(a)
};
Wikimapia.Layer.Editor.prototype.getStatusMessage = function (t) {
    var e = this.statusHelpLink ? Wikimapia.Lang.localize('&nbsp;(<a href="' + this.statusHelpLink + '" class="help" target="_blank">{help}</a>)') : "",
        i;
    switch (t) {
        case "zoom-in":
            i = Wikimapia.Lang.get("all.zoomin-closer");
            break;
        case "satellite":
            i = Wikimapia.Lang.get("all.switch-to-satellite");
            break;
        case "ok":
            i = Wikimapia.Lang.get("all." + this.initialStatusMessage) + e;
            break;
        default:
            i = Wikimapia.Lang.get("all." + t) + e;
            break
    }
    return i
};
Wikimapia.Layer.Editor.prototype.setStatusMessage = function (t) {
    if (!this.saveStatus.allowedByZoom) {
        this.dispatchZoomErrorNotification()
    }
    this.map.statusbar.setStatusMessage(this.getStatusMessage(t))
};
Wikimapia.Layer.Editor.prototype.registerChange = function (t) {
    this.saveStatus.needed = true;
    this.recalculateSaveStatus()
};
Wikimapia.Layer.Editor.prototype.resetChange = function () {
    this.saveStatus.needed = false;
    this.recalculateSaveStatus()
};
Wikimapia.Layer.Editor.prototype.recalculateSaveStatus = function () {
    this.saveStatus.allowedByLayerAccess = this.map.access.allowsFeatureSave();
    this.checkZoom();
    this.refreshStatus()
};
Wikimapia.Layer.Editor.prototype.onAccessChange = function (t, e) {
    this.accessMode = e;
    this.saveStatus.allowedByLayerAccess = this.map.access.allowsFeatureSave();
    this.refreshStatus()
};
Wikimapia.Layer.Editor.prototype.onGeometryEditFailure = function (t) {
    var e = "";
    if (t && t.point) {
        var i = this.map.fromContainerPixelToLatLng(t.point);
        if (!this.map.access.allowsFeatureSave()) {
            e = '<span class="error">' + Wikimapia.Lang.get("all.switch-to-satellite") + "</span>"
        } else if (!this.saveStatus.allowedByZoom) {
            e = Wikimapia.Lang.localize('<span class="error clickable" ' + 'onclick="app.map.setCenter(new Wikimapia.LatLng(' + i.toString() + "));app.map.setZoom(" + this.options.minSaveLevel + ');">{zoomin-closer}</span>');
            e = null
        }
        if (e) {
            var a, o = this.errorTooltip;
            if (!o) {
                o = this.map.createTooltip(null, null, null, e);
                this.map.addTooltip(o)
            }
            o.innerHTML = e;
            o.show();
            a = this.map.getTooltipPosition(t.point, o.offsetWidth, o.offsetHeight);
            Wikimapia.Utils.Dom.setStyles(o, {
                top: a.y,
                left: a.x
            });
            this.map.setTooltipAutoHide(o, 2e3, e);
            this.errorTooltip = o
        }
    }
    return e
};
Wikimapia.Layer.Editor.prototype.checkCacheOverflow = function () { };
Wikimapia.Layer.Editor.prototype.afterSave = function () {
    this.needsSave = false;
    this.hideLoading()
};
Wikimapia.Layer.Editor.prototype.clearUI = function () { };
Wikimapia.Layer.Editor.prototype.checkZoom = function () {
    var t = this.map.getZoom(),
        e = t >= this.options.minSaveLevel && t >= this.options.minLoadLevel;
    this.saveStatus.allowedByZoom = !!e;
    this.allowFeatureEdit(e);
    if (!e) {
        this.hideLoading()
    }
    return e
};
Wikimapia.Layer.Editor.prototype.allowFeatureEdit = function (t) {
    var e = Wikimapia.layerAccessModes;
    if (t) {
        this.map.access.grantAccess(e.CREATE)
            .grantAccess(e.EDIT)
    } else {
        this.map.access.restrictAccess(e.CREATE)
            .restrictAccess(e.EDIT)
    }
};
Wikimapia.Layer.Editor.prototype.getTileUrl = function (t, e, i) {
    var a = this.toQuadKey(t, e, i);
    return this.options.url.substitute({
        tileID: this.options.splitQuadTree ? a.replace(/(\d{3})(?!$)/g, "$1/") : a,
        hash: this.hash
    })
};
Wikimapia.Layer.Editor.prototype.tileIsDisplayed = function (t) {
    var e = false;
    for (var i in this.grid) {
        if (t === this.grid[i].id) {
            e = true;
            break
        }
    }
    return e
};
Wikimapia.Layer.Editor.prototype.addTile = function (t) {
    t.layer = this;
    return new Wikimapia.Tile.Text(t)
};
Wikimapia.Layer.Editor.prototype.tilesMonitor = function (t, e) {
    if (t === "loadend" || t === "loaderror") {
        this.map.fireEvent("mapDataProgress", e)
    } else if (t === "queueStart") {
        this.map.fireEvent("mapDataQueued", e)
    } else if (t === "unload") {
        this.map.fireEvent("mapDataQueued", -1)
    }
};
Wikimapia.Layer.Editor.prototype.tileLoadingAllowed = function (t) {
    var e = this.map.getZoom() >= this.options.minLoadLevel,
        i = true;
    return e && i
};
Wikimapia.Layer.Interactive = function (t) {
    Wikimapia.Layer.TileLayer.prototype.constructor.call(this, t);
    this.polygons = [];
    this.options.langCode = Wikimapia.Lang.getCurrentLanguageCode();
    this.parser = new Wikimapia.Parser.Itiles(this);
    this.initCache();
    Wikimapia.Utils.bindHandlers(this, "onPlaceClick", "onPlaceRightClick", "onPlaceMouseover", "onPlaceMouseout", "onObjectEdit", "onPanelOrWindowClosed", "onMapClick", "onMapTap", "onMapRightClick", "onMapMoveEnd", "unblock")
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Interactive, Wikimapia.Layer.TileLayer);
Wikimapia.Utils.mixin(Wikimapia.Layer.Interactive, Wikimapia.Layer.Editor);
Wikimapia.Layer.Interactive.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.TileLayer.prototype.options, Wikimapia.Layer.Editor.prototype.options, {
    tileSize: new Wikimapia.Size(1024, 1024),
    splitQuadTree: true,
    minSaveLevel: 13,
    maxCachedTiles: 10,
    permPolyColor: "#f51a1a",
    iTilesUrl: "/z1/itiles/{tileID}.xy",
    name: "wikimapia.interactive",
    scaleBoundsForEdit: 1.2,
    noTitleText: "all.click-to-prov"
});
Wikimapia.Layer.Interactive.prototype.mbrLimit = null;
Wikimapia.Layer.Interactive.prototype.polygonTraceCount = 2;
Wikimapia.Layer.Interactive.prototype.enabled = null;
Wikimapia.Layer.Interactive.prototype.highlightedObject = null;
Wikimapia.Layer.Interactive.prototype.highlightedPolygon = null;
Wikimapia.Layer.Interactive.prototype.editedPoly = null;
Wikimapia.Layer.Interactive.prototype.parser = null;
Wikimapia.Layer.Interactive.prototype.tileCache = null;
Wikimapia.Layer.Interactive.prototype.loadingTiles = {};
Wikimapia.Layer.Interactive.prototype.loadedTiles = [];
Wikimapia.Layer.Interactive.prototype.initialStatusMessage = "adding-po1";
Wikimapia.Layer.Interactive.prototype.initialStatusIcon = new Wikimapia.Icon({
    image: Wikimapia.Utils.defaultImagesUrl + "menu-spt.png",
    imageSpritePos: "0 -1470px",
    cursor: "default"
});
Wikimapia.Layer.Interactive.prototype.statusHelpLink = "/docs/Quick_start#Adding_place", Wikimapia.Layer.Interactive.prototype.initCache = function () {
    this.tileCache = {
        nonDescendant: [],
        objects: {}
    };
    this.cache.clear("interactiveSettings")
};
Wikimapia.Layer.Interactive.prototype.setMap = function (t) {
    Wikimapia.Layer.TileLayer.prototype.setMap.call(this, t);
    this.map.interactiveLayer = this
};
Wikimapia.Layer.Interactive.prototype.loadMapObject = function () {
    Wikimapia.Layer.TileLayer.prototype.loadMapObject.call(this);
    this.addTooltip();
    this.initAccessMode();
    this.initBlocks();
    Wikimapia.Utils.extend(this.handlers, {
        accessChanged: this.onAccessChange.bind(this),
        registerChange: this.registerChange.bind(this),
        resetChange: this.resetChange.bind(this),
        polygonCreateStart: function () {
            Wikimapia.Utils.Logger.logPlaceAction("polygon_create_start")
        },
        polygonCreateComplete: function () {
            Wikimapia.Utils.Logger.logPlaceAction("polygon_create_complete")
        },
        mouseMove: this.mouseMove.bind(this)
    });
    this.map.addEvents({
        accessModeChanged: this.handlers.accessChanged,
        edit: this.handlers.onObjectEdit,
        panelClosed: this.handlers.onPanelOrWindowClosed,
        editorStopped: this.handlers.unblock,
        moveend: this.handlers.onMapMoveEnd
    });
    if (Wikimapia.Utils.isTouch) {
        this.map.addEvents({
            tap: this.handlers.onMapTap
        })
    } else {
        this.map.addEvents({
            click: this.handlers.onMapClick,
            contextmenu: this.handlers.onMapRightClick
        })
    }
    Wikimapia.Utils.Dom.addEvent(document, "keyup", this.handlers.keyboard);
    this.setMBRLimit();
    this.addLoadingBar();
    this.enable()
};
Wikimapia.Layer.Interactive.prototype.initHash = function () {
    var t = Wikimapia.Net.Cookie.read("rndnum");
    this.hash = t ? parseInt(t) : this.refreshHash()
};
Wikimapia.Layer.Interactive.prototype.refreshHash = function () {
    Wikimapia.Net.Cookie.remove("rndnum");
    Wikimapia.Net.Cookie.write("rndnum", Wikimapia.Layer.TileLayer.prototype.refreshHash.call(this), undefined, undefined, Wikimapia.Utils.cookieDomain);
    return this.hash
};
Wikimapia.Layer.Interactive.prototype.setMBRLimit = function () {
    this.mbrLimit = this.getBounds()
        .scale(1.2)
        .getSize()
};
Wikimapia.Layer.Interactive.prototype.renderTile = function (t, e, i, a, o) {
    delete this.loadingTiles[e];
    var n = this.parseTile.apply(this, arguments);
    this.tileCache.nonDescendant = this.tileCache.nonDescendant || [];
    this.checkCacheOverflow();
    this.tileCache[e] = n;
    this.loadedTiles.push(e);
    if (!n.deeperTiles && this.tileCache.nonDescendant.indexOf(e) == -1) {
        this.tileCache.nonDescendant.push(e)
    }
    return n
};
Wikimapia.Layer.Interactive.prototype.renderTileFromCache = function (t, e) {
    delete this.loadingTiles[t.id];
    this.tileCache.nonDescendant = this.tileCache.nonDescendant || [];
    if (this.tileCache[e] && t.id !== e) {
        this.tileCache[t.id] = {
            deriveFrom: e,
            ids: []
        };
        this.tileCache[e].derivedTiles = !("derivedTiles" in this.tileCache[e]) ? 1 : this.tileCache[e].derivedTiles++
    }
    this.loadedTiles.push(t.id);
    this.tilesMonitor("loadend", t)
};
Wikimapia.Layer.Interactive.prototype.getCachedParentTileId = function (t) {
    var e = null,
        i = this.tileCache.nonDescendant || [];
    for (var a = 0, o = i.length; a < o; a++) {
        var n = i[a];
        if (t.length >= n.length && t.indexOf(n) === 0) {
            e = n;
            break
        }
    }
    return e
};
Wikimapia.Layer.Interactive.prototype.parseTile = function (t) { }, Wikimapia.Layer.Interactive.prototype.clearUI = function () {
    if (this.objectContextMenu) {
        this.objectContextMenu.destroy();
        delete this.objectContextMenu
    }
    this.tooltip.innerHTML = "";
    this.tooltip.hide();
    Wikimapia.Layer.Editor.prototype.clearUI.call(this)
};
Wikimapia.Layer.Interactive.prototype.setZoom = function (t) {
    Wikimapia.Layer.TileLayer.prototype.setZoom.call(this, t);
    this.clearUI();
    this.setMBRLimit();
    this.checkZoom();
    if (this.map.editingInProgress()) {
        this.refreshStatus()
    } else if (this.highlightedPolygon && this.highlightedObject) {
        this.highlightedPolygon.show()
    }
    return this
};
Wikimapia.Layer.Interactive.prototype.checkCacheOverflow = function () {
    if (this.loadedTiles.length >= this.options.maxCachedTiles) {
        for (var t = 0, e = this.loadedTiles.length; t < e; t++) {
            var i = this.loadedTiles[t];
            if (!this.tileIsDisplayed(i)) {
                delete this.tileCache[i];
                this.loadedTiles.splice(t, 1);
                for (var a = 0; a < this.tileCache.nonDescendant.length; a++) {
                    if (this.tileCache.nonDescendant[a] == i) {
                        this.tileCache.nonDescendant.splice(a, 1)
                    }
                }
                break
            }
        }
    }
};
Wikimapia.Layer.Interactive.prototype.tileLoadingAllowed = function (t) {
    var e = t.id,
        i = false;
    if (!(e in this.tileCache || e in this.loadingTiles)) {
        this.loadingTiles[e] = true;
        i = true
    }
    return i
};
Wikimapia.Layer.Interactive.prototype.clearTile = function (t, e) {
    if (t) {
        var i = this.loadedTiles.indexOf(t.id);
        if (i >= 0) {
            this.loadedTiles.splice(i, 1)
        }
    }
};
Wikimapia.Layer.Interactive.prototype.redraw = function (t) {
    for (var e in this.tileCache) {
        if (/^\d+$/.test(e)) {
            delete this.tileCache[e]
        }
    }
    this.tileCache.nonDescendant = [];
    this.loadingTiles = {};
    this.tileCache = {
        objects: {},
        nonDescendant: []
    };
    Wikimapia.Layer.TileLayer.prototype.redraw.call(this);
    if (typeof t === "undefined") {
        t = false
    }
    if (!t) {
        var i = this.map.getLayerByName("wikimapia.imagetiles.*");
        if (i) {
            i.redraw()
        }
    }
};
Wikimapia.Layer.Interactive.prototype.addTooltip = function () {
    Wikimapia.Layer.Editor.prototype.addTooltip.call(this);
    Wikimapia.Utils.Dom.addEvent(this.tooltip, "click", this.handlers.onPlaceClick)
};
Wikimapia.Layer.Interactive.prototype.tilesLoaded = function () {
    Wikimapia.Layer.TileLayer.prototype.tilesLoaded.call(this);
    Wikimapia.Layer.Editor.prototype.tilesLoaded.call(this)
};
Wikimapia.Layer.Interactive.prototype.tilesMonitor = function (t, e, i, a) {
    Wikimapia.Layer.TileLayer.prototype.tilesMonitor.call(this, t);
    Wikimapia.Layer.Editor.prototype.tilesMonitor.call(this, t, e);
    if (t === "loadend") {
        Wikimapia.Utils.Logger.logIncomingTilesBandwidth(i, a)
    }
};
Wikimapia.Layer.Interactive.prototype.mouseMove = function (t) { };
Wikimapia.Layer.Interactive.prototype.onMapTap = function (t) {
    this.mouseMove(t)
};
Wikimapia.Layer.Interactive.prototype.onMapClick = function (t) {
    if (this.isEnabled() && !this.highlightedObject && !this.map.statusGrid && !this.map.editingInProgress()) {
        t && t.stop();
        if (this.objectContextMenu) {
            this.objectContextMenu.destroy();
            delete this.objectContextMenu;
            return
        }
        var e = this.map.getMouseLatLng(),
            i = [{
                text: "add-place-here",
                icon: {
                    spritePos: "-18px -900px"
                },
                action: function () {
                    this.map.addPlace("cm")
                }.bind(this)
            }, {
                text: '<i class="icon-white icon-map-marker"></i>&nbsp;' + Wikimapia.Utils.getFormattedCoords(e, "dm"),
                action: function () {
                    this.map.fireEvent("showCoordsConverter", e)
                }.bind(this)
            }];
        this.objectContextMenu = this.map.contextMenu(i, {}, "object-context-menu", this.map.getMousePosition(), true)
    }
};
Wikimapia.Layer.Interactive.prototype.onMapMoveEnd = function (t) { };
Wikimapia.Layer.Interactive.prototype.onMapRightClick = function (t) {
    if (this.enabled) {
        t.stop();
        this.onMapClick(t)
    }
};
Wikimapia.Layer.Interactive.prototype.highlightObjectAt = function (t, e) {
    var i = this.getTileAtPosition(e),
        a;
    if (!i) {
        return
    }
    a = this.map.fromContainerPixelToLatLng(e);
    t = t || this.findObjectAtLatLng(i, a, e);
    if (t !== null) {
        if (t !== this.highlightedObject) {
            this.highlightObject(t)
        }
    } else {
        this.highlightedObject = null;
        if (this.highlightedPolygon) {
            this.highlightedPolygon.hide();
            this.tooltip.hide()
        }
        this.onPlaceMouseout()
    }
};
Wikimapia.Layer.Interactive.prototype.highlightObject = function (t) {
    this.highlightedObject = t;
    t.polygon.clearCachedCoords();
    if (this.highlightedPolygon && this.polygons.length === this.polygonTraceCount) {
        this.highlightedPolygon.hide();
        this.polygons.unshift(this.polygons.pop());
        this.highlightedPolygon = this.polygons[this.polygons.length - 1];
        this.highlightedPolygon.setGeometry(t.polygon.clone())
    } else {
        if (this.highlightedPolygon) {
            this.polygons.push(this.highlightedPolygon);
            this.highlightedPolygon.hide()
        }
        this.highlightedPolygon = new Wikimapia.Layer.Interactive.Polygon({
            map: this.map,
            geometry: t.polygon.clone(),
            styles: {
                zIndex: 200
            }
        });
        this.highlightedPolygon.onScreen = Wikimapia.Utils.True;
        this.highlightedPolygon.addEvents({
            click: this.handlers.onPlaceClick,
            contextmenu: this.handlers.onPlaceRightClick,
            rightclick: this.handlers.onPlaceRightClick
        })
    }
    this.onPlaceMouseover();
    this.setObjectTooltip(this.highlightedObject);
    this.tooltip.show()
};
Wikimapia.Layer.Interactive.prototype.findObjectAtLatLng = function (t, e) {
    return null
};
Wikimapia.Layer.Interactive.prototype.getTileAtPosition = function (t) {
    var e = this.options,
        i = this.dragObject.position,
        a = e.offset,
        o = this.tileSize,
        n = e.startTile.clone(),
        s = Math.abs;
    n = n.add(s((t.x - a.x - i.x) / o.w), s((t.y - a.y - i.y) / o.h))
        .floor();
    return this.grid[n.x + ":" + n.y]
};
Wikimapia.Layer.Interactive.prototype.getTextForTooltip = function (t) {
    var e = Wikimapia.Lang.getCurrentLanguageCode()
        .toString(),
        i = "";
    if (typeof t.titles === "string") {
        t.titles = Wikimapia.Parser.Itiles.decodeTitles(t.titles)
    }
    if (e in t.titles) {
        i = t.titles[e];
        this.highlightedObject.currentLanguage = Wikimapia.Lang.codeToLng(e)
    } else {
        var a, o, n;
        for (a = 0, o = Wikimapia.Lang.popLanguages.length; a < o; a++) {
            e = Wikimapia.Lang.popLanguages[a];
            i = t.titles[e];
            if (i) {
                break
            }
        }
        if (!i) {
            for (var n in t.titles) {
                i = t.titles[n];
                e = n;
                break
            }
        }
        this.highlightedObject.currentLanguage = Wikimapia.Lang.codeToLng(e);
        if (i && i !== "") {
            i = i + " (" + this.highlightedObject.currentLanguage + ")"
        }
    }
    if (!i) {
        i = Wikimapia.Lang.get(this.options.noTitleText) || this.options.noTitleText || "";
        this.highlightedObject.isEmpty = true
    }
    return i
};
Wikimapia.Layer.Interactive.prototype.setObjectTooltip = function (t) {
    this.tooltip.innerHTML = this.getTextForTooltip(t);
    this.highlightedPolygon && this.highlightedPolygon.show()
};
Wikimapia.Layer.Interactive.prototype.enable = function () {
    if (!this.enabled && !this.blocked && !this.map.editingInProgress(true)) {
        this.enabled = true;
        this.map.addEvent("mousemove", this.handlers.mouseMove)
    }
};
Wikimapia.Layer.Interactive.prototype.unblock = function () {
    Wikimapia.Layer.Editor.prototype.unblock.call(this);
    if (this.map.vectorLayer.polygonEditor && this.map.vectorLayer.polygonEditor.isInProgress()) {
        this.map.statusbar.show()
    }
    this.blocked = false
};
Wikimapia.Layer.Interactive.prototype.keyboard = function (t) {
    Wikimapia.Layer.Editor.prototype.keyboard.call(this, t);
    if (t.keyCode === Wikimapia.Utils.Event.keyCodes.ENTER) {
        var e = this.map.vectorLayer.polygonEditor,
            i;
        if (e && e.isInProgress()) {
            i = e.getPolygon();
            if (i && i.geometry.getVertexCount() > 2 && this.saveStatus.needed) {
                this.save()
            }
        }
    }
};
Wikimapia.Layer.Interactive.prototype.disable = function () {
    if (this.enabled) {
        this.enabled = false;
        this.map.removeEvent("mousemove", this.handlers.mouseMove);
        this.hideHighlightedPolygon()
    }
};
Wikimapia.Layer.Interactive.prototype.hideHighlightedPolygon = function (t) {
    if (this.highlightedPolygon) {
        this.highlightedPolygon.hide();
        delete this.highlightedObject
    }
    if (t) {
        for (var e = 0, i = this.polygons.length; e < i; e++) {
            this.polygons[e].setMap(null)
        }
        this.polygons = []
    }
    this.tooltip.hide()
};
Wikimapia.Layer.Interactive.prototype.isEnabled = function () {
    return !!this.enabled
};
Wikimapia.Layer.Interactive.prototype.onPlaceClick = function (t) {
    var e = new Wikimapia.Place(this.highlightedObject);
    if (e && !e.isNew() && this.enabled) {
        this.destroyPermanentPolygon();
        if (e.isEmpty && this.map.access.userIsAuthorized()) {
            this.map.fireEvent("edit", e)
        } else {
            this.highlightPermanentPolygon(e);
            this.map.fireEvent("show", e)
        }
    }
    t.stop()
};
Wikimapia.Layer.Interactive.prototype.onMoveStart = function () {
    this.disable();
    if (this.objectContextMenu) {
        this.objectContextMenu.destroy();
        delete this.objectContextMenu
    }
};
Wikimapia.Layer.Interactive.prototype.onPlaceRightClick = function (t) {
    t && t.stop();
    if (this.map.options.embedded || !this.enabled) {
        return
    }
    this.placeContextMenu(new Wikimapia.Place(this.highlightedObject))
};
Wikimapia.Layer.Interactive.prototype.onPlaceMouseover = function () {
    if (this.permanentPolygon) {
        if (this.highlightedObject.id === this.permanentPolygon.id) {
            this.permanentPolygon.hide()
        } else {
            this.permanentPolygon.show()
        }
    }
};
Wikimapia.Layer.Interactive.prototype.onPlaceMouseout = function () {
    if (this.permanentPolygon) {
        this.permanentPolygon.show()
    }
};
Wikimapia.Layer.Interactive.prototype.placeContextMenu = function (t) {
    var e = this.highlightedPolygon,
        i = this.map.options.getApp(),
        a = this.map.getControlByName("Object"),
        o = [{
            text: "show-menu-zoomin",
            icon: {
                spritePos: "-18px -72px"
            },
            action: function () {
                this.map.zoomToBounds(t.mbr)
            }.bind(this)
        }, {
            divider: true
        }, {
            text: "show-menu-edit-page",
            icon: {
                spritePos: "-18px -144px"
            },
            action: function () {
                this.edit("info", t)
            }.bind(this)
        }, {
            text: "show-menu-add-language",
            icon: {
                spritePos: "-18px -414px"
            },
            action: function () {
                a.getEditorComponent(t)
                    .addLanguage(t)
            }
        }, {
            text: t.noPolygon || t.area === 1 ? "add-outline" : "show-menu-polygon",
            icon: {
                spritePos: "0 -1470px"
            },
            action: function () {
                this.edit("polygon", t)
            }.bind(this)
        }, {
            text: "show-menu-history",
            icon: {
                spritePos: "-18px -90px"
            },
            action: function () {
                a._history.view(t)
            }
        }, {
            divider: true
        }, {
            text: "show-menu-promote",
            icon: {
                spritePos: "-18px -774px"
            },
            action: function () {
                a._ads.promote(t)
            }.bind(this)
        }];
    if (this.map.access.allowsFeatureDelete()) {
        o.push({
            text: "show-menu-delete",
            icon: {
                spritePos: "0 -1488px"
            },
            action: function () {
                this.map.fireEvent("delete", t)
            }.bind(this)
        })
    }
    this.objectContextMenu = this.map.contextMenu(o, {}, "object-context-menu", this.map.getMousePosition(), true)
};
Wikimapia.Layer.Interactive.prototype.onLanguageChange = function () {
    this.refreshStatus()
};
Wikimapia.Layer.Interactive.prototype.edit = function (t, e, i, a) {
    var o = this;
    e = e || this.highlightedObject;
    if (t === "polygon") {
        this.editPolygon(e)
    } else {
        this.map.fireEvent("edit", e)
    }
    this.destroyPermanentPolygon()
};
Wikimapia.Layer.Interactive.prototype.expandCollapsedGeometry = function (t) {
    var e = Wikimapia.Bounds.extendByPxGap(t.bounds, 15, this.map);
    return Wikimapia.Geometry.fromMBR(e)
};
Wikimapia.Layer.Interactive.prototype.editPolygon = function (t) {
    this.map.fireEvent("editPolygon");
    if (this.objectContextMenu) {
        this.objectContextMenu.destroy()
    }
    this.map.showPreloader();
    var e = function () {
        this.map.hidePreloader();
        this.enable()
    }.bind(this),
        i = function (i) {
            var a = this.map.options.getApp(),
                o, n, s;
            if (i.code || i.message) {
                e();
                this.map.fireEvent("responseError", i)
            } else {
                this.disable();
                s = this.parser.decodePolygon(i);
                if (Wikimapia.Geometry.isCollapsed(s)) {
                    s = this.expandCollapsedGeometry(s)
                }
                this.editedPoly = new Wikimapia.Feature.Polygon({
                    geometry: s
                });
                o = this.editedPoly.getBounds()
                    .scale(this.options.scaleBoundsForEdit);
                n = this.map.getBestZoomForBounds(o);
                if (n > this.map.getZoom()) {
                    this.map.zoomToBounds(o)
                } else {
                    this.map.setCenter(o.getCenterLatLng())
                }
                this.map.addPolygonEditor(function () {
                    var e = this.map.vectorLayer.polygonEditor;
                    this.disable();
                    this.map.hidePreloader();
                    this.highlightedObject = this.editedObject = t;
                    this.map.addVectorFeature(this.editedPoly);
                    e.edit(this.editedPoly);
                    this.setEditStatus()
                }.bind(this))
            }
        }.bind(this);
    this.disable();
    this.map.access.accessCheck("place_can_edit_protected&obj_id=" + t.id, function (e) {
        if (e) {
            new Wikimapia.Net.Xhr({
                type: "json",
                url: "/ajax/getPolygon/?id={id}".substitute(t),
                method: "get",
                onSuccess: i
            })
                .send()
        }
    }.bind(this), e)
};
Wikimapia.Layer.Interactive.prototype.cancelPolygonEdit = function (t, e) {
    var i = this.map,
        a = i.vectorLayer.polygonEditor;
    e = Wikimapia.Utils.getCallback(e);
    if (a) {
        var o = function () {
            Wikimapia.Utils.Logger.logPlaceAction(t ? "place_new_poly_cancel" : "place_poly_edit_cancel");
            a.cancel();
            a.removeEvents({
                changed: this.handlers.registerChange,
                resetChange: this.handlers.resetChange,
                createStart: this.handlers.polygonCreateStart,
                createComplete: this.handlers.polygonCreateComplete
            });
            i.statusbar.clear()
                .hide();
            if (this.editedPoly) {
                this.editedPoly.destroy();
                i.removeVectorFeature(this.editedPoly)
            }
            delete this.editedPoly;
            this.enable();
            this.unblock();
            this.editing = false;
            this.refreshStatus();
            this.dispatchClearNotification();
            e(true)
        }.bind(this);
        if (a.getPolygon()) {
            t = t || a.getPolygon()
                .unSaved;
            if (t && a.getPolygon()
                .geometry.points.length > 3 || this.saveStatus.needed) {
                Wikimapia.Interface.Dialog.confirm(Wikimapia.Lang.get("all.exit-editor"), o, function () {
                    e(false)
                }, undefined, t ? "all.poly-continue-drawing" : "all.poly-continue-editing")
            } else {
                o()
            }
        } else {
            o(true)
        }
    }
};
Wikimapia.Layer.Interactive.prototype.setEditStatus = function (t) {
    var e = this.map.vectorLayer.polygonEditor,
        i;
    this.editing = true;
    e.removeEvents({
        changed: this.handlers.registerChange,
        resetChange: this.handlers.resetChange,
        createStart: this.handlers.polygonCreateStart,
        createComplete: this.handlers.polygonCreateComplete
    })
        .addEvents({
            changed: this.handlers.registerChange,
            resetChange: this.handlers.resetChange,
            createStart: this.handlers.polygonCreateStart,
            createComplete: this.handlers.polygonCreateComplete
        });
    i = t ? "adding-po" : "adding-po1";
    this.initAccessMode();
    this.checkZoom();
    this.initStatusBar({
        onSave: this.save.bind(this),
        onCancel: function () {
            this.editedObject = null;
            this.cancelPolygonEdit(t)
        }.bind(this),
        summary: false,
        message: this.getStatusMessage(i)
    })
};
Wikimapia.Layer.Interactive.prototype.setStatusMessage = function (t) {
    var e = this.map.vectorLayer.polygonEditor;
    if (e && e.isInProgress()) {
        var i = e.getPolygon();
        if (t !== "zoom-in" && (!i || i.unSaved)) {
            t = "adding-po"
        }
        Wikimapia.Layer.Editor.prototype.setStatusMessage.call(this, t)
    }
};
Wikimapia.Layer.Interactive.prototype.getTileCacheByTileId = function (t) {
    var e = this.tileCache[t];
    if (e && "deriveFrom" in e) {
        e = this.tileCache[e.deriveFrom]
    }
    return e
};
Wikimapia.Layer.Interactive.prototype.findAndShowPermanentPolygon = function (t, e, i, a, o) {
    var n = this._findObjectDelayed = function () {
        var a, n, s;
        t = t.toString();
        if (this._findObjectDelayed) {
            this.removeEvent("tilesLoaded", this._findObjectDelayed);
            delete this._findObjectDelayed
        }
        if (e) {
            if (e.ids.indexOf(t) !== -1) {
                i = this.tileCache.objects[t]
            }
        } else {
            for (var r in this.tileCache) {
                e = this.getTileCacheByTileId(r);
                if (e.ids && e.ids.indexOf(t) !== -1) {
                    i = this.tileCache.objects[t];
                    break
                }
            }
        }
        if (i) {
            this.highlightPermanentPolygon(i)
        }
        if (typeof o === "function") o(i)
    }.bind(this);
    if (!e && this.numLoadingTiles > 0) {
        this.addEvent("tilesLoaded", n)
    } else {
        delete this._findObjectDelayed;
        setTimeout(n, a || 0)
    }
};
Wikimapia.Layer.Interactive.prototype.highlightPermanentPolygon = function (t) {
    if (!("polygon" in t) || t.noPolygon) return;
    if (typeof t.polygon === "string") {
        t.polygon = this.parser[t.encodingType === 1 ? "decodePolygonMK2" : "decodePolygon"](t.polygon)
    }
    if (this.permanentPolygon) this.destroyPermanentPolygon();
    var e = this.permanentPolygon = new Wikimapia.Polygon({
        map: this.map,
        geometry: t.polygon,
        style: {
            strokeColor: this.options.permPolyColor,
            fillColor: this.options.permPolyColor,
            fillOpacity: .2,
            pointerEvents: "none",
            zIndex: 2e3
        },
        obj: t
    });
    e.id = t.id;
    this.highlightedObject = t;
    this.setObjectTooltip(t);
    return t
};
Wikimapia.Layer.Interactive.prototype.stickTooltip = function (t, e) {
    var i = this.permanentTooltip || this.map.createTooltip(null, null, Wikimapia.Utils.Dom.getStyle(t, "z-index") - 1, "", true),
        a, o = 0,
        n = this.map.getSize()
        .w - 20;
    Wikimapia.Utils.Dom.inject(i, this.div);
    if (this.permanentTooltip !== i) {
        this.permanentTooltip = i;
        this.permanentTooltip.innerHTML = '<span class="close">&times;</span> ' + t.innerHTML
    }
    this.permanentTooltip.show();
    Wikimapia.Utils.Dom.addEvent(this.permanentTooltip, "click", ".close", function (t) {
        t.stop();
        this.destroyPermanentPolygon()
    }.bind(this));
    o = Math.min(i.offsetWidth, n) + 20;
    a = this.map.fromLatLngToContainerPixel(e);
    Wikimapia.Utils.Dom.setStyles(i, {
        left: a.x,
        "max-width": n
    });
    o = Math.min(i.offsetWidth, n) + 20;
    a = this.map.fromLatLngToContainerPixel(e);
    a = this.map.getTooltipPosition(a, o, i.offsetHeight);
    a = a.subtract(this.map.dragObject.position.x, this.map.dragObject.position.y);
    Wikimapia.Utils.Dom.setStyles(i, {
        top: a.y + 5,
        left: a.x,
        "max-width": n
    })
};
Wikimapia.Layer.Interactive.prototype.destroyPermanentPolygon = function () {
    if (this.permanentPolygon) {
        this.map.removeVectorFeature(this.permanentPolygon);
        delete this.permanentPolygon;
        this.map.options.poly = 0;
        if (this.permanentTooltip) Wikimapia.Utils.Dom.destroy(this.permanentTooltip);
        delete this.permanentTooltip
    }
};
Wikimapia.Layer.Interactive.prototype.checkPolyArea = function (t) {
    var e = 0,
        i = [],
        a = t.getVertexCount(),
        o = t.getBounds();
    for (var n = 0; n < a; n++) {
        i.push(this.map.projectAtZoom(t.points[n], 20, this.map.baseLayer))
    }
    for (var s = 0; s < a - 1; s++) {
        e += (i[s + 1].x + i[s].x) * (i[s + 1].y - i[s].y)
    }
    e = Math.sqrt(.5 * Math.abs(e));
    t.area = e;
    var r = this.map.projectAtZoom(new Wikimapia.LatLng(o.top, o.left), 20, this.map.baseLayer),
        p = this.map.projectAtZoom(new Wikimapia.LatLng(o.bottom, o.right), 20, this.map.baseLayer);
    if (e != 0) {
        if (Math.max(Math.abs(r.x - p.x), Math.abs(r.y - p.y)) / e > 6) {
            return false
        }
    }
    return true
};
Wikimapia.Layer.Interactive.prototype.onObjectEdit = function (t) {
    this.destroyPermanentPolygon();
    this.findAndShowPermanentPolygon(t.id, null, t)
};
Wikimapia.Layer.Interactive.prototype.onPanelOrWindowClosed = function () {
    this.destroyPermanentPolygon()
};
Wikimapia.Layer.Interactive.prototype.validatePolygon = function (t) {
    var e = false,
        i;
    if (t) {
        if (t instanceof Wikimapia.Polyline) {
            i = Wikimapia.Lang.get("all.poly-finish-polygon")
        } else if (t instanceof Wikimapia.Polygon) {
            e = true
        }
    } else {
        i = Wikimapia.Lang.get("all.poly-click-to-start")
    }
    if (!e) {
        i = '<span class="polygon-notification">' + '<span class="s16x16 menu-spt spt-polygon menu-icon"></span>' + i + "</span>";
        Wikimapia.Interface.Log.error(i, 3e3)
    }
    return e
};
Wikimapia.Layer.Interactive.prototype.getGeometryUpdateUrl = function (t) {
    var e = "/object/edit/?";
    if (t.isNew()) {
        e = e + "checkpoly=1"
    } else {
        e = e + "id=" + t.id;
        if (t.unbindAfterGeometryEdit) {
            e += "&do=unbind"
        } else {
            e += "&savepoly=1"
        }
    }
    return e
};
Wikimapia.Layer.Interactive.prototype.save = function () {
    if (!this.validatePolygon(this.map.vectorLayer.polygonEditor.getPolygon())) return;
    var t = this.map,
        e = this,
        i = false,
        a = t.vectorLayer.polygonEditor.stop();
    if (a.unSaved) {
        this.editedPoly = a;
        i = true;
        this.editedObject = new Wikimapia.Place
    }
    this.showLoading("saving");
    if (this.editedPoly.geometry) {
        var o = Wikimapia.Utils.encodePolygon(this.editedPoly.geometry),
            n, s, r, p;
        if (i) {
            o.surface = 0;
            o.zoom = t.getZoom()
        } else {
            Wikimapia.Utils.extend(o, t.statusbar.collectSummary())
        }
        n = Wikimapia.Utils.objectToQueryString(o);
        s = this.getGeometryUpdateUrl(this.editedObject);
        if (i) {
            p = function (t) {
                Wikimapia.Utils.Logger.logPlaceAction("place_new_poly_save");
                if (t.code === 0) {
                    this.hideLoading();
                    o.currentLanguage = Wikimapia.Lang.getCurrentLanguage();
                    o.id = 0;
                    o["new"] = 1;
                    this.map.fireEvent("edit", new Wikimapia.Place(o));
                    [this.map.getPanel("left"), this.map.getWindow()].forEach(function (t) {
                        if (t) {
                            t.addEvent("close", function () {
                                if (this.editedPoly) {
                                    this.map.vectorLayer.polygonEditor.edit(this.editedPoly);
                                    this.setEditStatus(true);
                                    this.map.statusbar.toggleSave(true);
                                    this.saveStatus.needed = true
                                }
                            }.bind(this))
                        }
                    }.bind(this))
                } else {
                    this.map.fireEvent("responseError", [t, this.onPolygonUpdateFailure.bind(this)])
                }
            }.bind(this)
        } else {
            p = function (t) {
                if (t) {
                    if (t.code === Wikimapia.responseCodes.PLACE_UPDATED || t.code === Wikimapia.responseCodes.UNBIND_SUCCESS) {
                        this.map.removeVectorFeature(this.editedPoly);
                        this.map.vectorLayer.polygonEditor.cancel();
                        this.map.vectorLayer.polygonEditor.removeEvents({
                            changed: this.handlers.registerChange,
                            resetChange: this.handlers.resetChange,
                            createStart: this.handlers.polygonCreateStart,
                            createComplete: this.handlers.polygonCreateComplete
                        });
                        if (t.code === Wikimapia.responseCodes.UNBIND_SUCCESS) {
                            delete this.editedObject.unbindAfterGeometryEdit;
                            this.map.fireEvent("show", this.editedObject)
                        }
                        delete this.editedPoly;
                        this.afterSave();
                        this.enable();
                        this.redraw()
                    } else {
                        this.map.fireEvent("responseError", [t, this.onPolygonUpdateFailure.bind(this)])
                    }
                }
            }.bind(this)
        }
        var l = function () {
            this.map.fireEvent("responseError", [{
                alert: Wikimapia.Lang.get("all.something-wrong")
            }, this.onPolygonUpdateFailure.bind(this)])
        }.bind(this);
        new Wikimapia.Net.Xhr({
            type: "json",
            data: Wikimapia.Net.securePost(n),
            method: "post",
            url: s,
            onSuccess: p,
            onFailure: l,
            onError: l
        })
            .send()
    } else {
        this.hideLoading()
    }
    t.statusbar.clear()
        .hide();
    return false
};




Wikimapia.Layer.Interactive.prototype.onPolygonUpdateFailure = function (t) {
    if (t) {
        this.map.vectorLayer.polygonEditor.edit(this.editedPoly);
        this.setEditStatus()
    } else {
        this.map.removeVectorFeature(this.editedPoly);
        delete this.editedPoly
    }
    this.hideLoading()
};
Wikimapia.Layer.Interactive.prototype.updateSize = function (t) {
    Wikimapia.Layer.prototype.updateSize.call(this, t);
    if (t) {
        this.update(this.getBounds(), t)
    }
};
Wikimapia.Layer.Interactive.prototype.destroy = function () {
    Wikimapia.Utils.Dom.removeEvent(this.tooltip, "click", this.handlers.onPlaceClick);
    this.dispatchClearNotification();
    this.destroyPermanentPolygon();
    this.disable();
    this.removeBlocks();
    for (var t = 0, e = this.polygons.length; t < e; t++) {
        this.polygons[t].setMap(null)
    }
    this.polygons = null;
    if (this.highlightedPolygon) {
        this.highlightedPolygon.setMap(null);
        this.highlightedPolygon = null
    }
    this.map.removeEvents({
        accessModeChanged: this.handlers.accessChanged,
        edit: this.handlers.onObjectEdit,
        panelClosed: this.handlers.onPanelOrWindowClosed,
        editorStopped: this.handlers.unblock
    });
    if (Wikimapia.Utils.isTouch) {
        this.map.removeEvents({
            tap: this.handlers.onMapTap
        })
    } else {
        this.map.removeEvents({
            click: this.handlers.onMapClick,
            contextmenu: this.handlers.onMapRightClick
        })
    }
    if (this.map.vectorLayer.polygonEditor) {
        this.map.vectorLayer.polygonEditor.removeEvents({
            changed: this.handlers.registerChange,
            resetChange: this.handlers.resetChange,
            createStart: this.handlers.polygonCreateStart,
            createComplete: this.handlers.polygonCreateComplete
        })
    }
    this.loadingBar.destroy();
    this.loadingBar = null;
    this.map.interactiveLayer = null;
    Wikimapia.Layer.TileLayer.prototype.destroy.call(this);
    this.loadingTiles = null;
    this.tileCache = null
};
Wikimapia.Layer.Interactive.Polygon = function (t) {
    Wikimapia.Feature.Polygon.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Interactive.Polygon, Wikimapia.Feature.Polygon);
Wikimapia.Layer.Interactive.Polygon.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Feature.Polygon.prototype.options, {
    className: "temporary-polygon"
});
Wikimapia.Layer.Interactive.Polygon.prototype.displayColor = "#ffcc00";
Wikimapia.Layer.Interactive.Polygon.prototype.hiddenColor = "transparent";
Wikimapia.Layer.Interactive.Polygon.prototype.show = function () {
    return this.setFillAndStroke(this.displayColor)
};
Wikimapia.Layer.Interactive.Polygon.prototype.hide = function () {
    return this.setFillAndStroke(this.hiddenColor)
};
Wikimapia.Layer.Interactive.Polygon.prototype.setFillAndStroke = function (t) {
    var e = this.renderer,
        i = this.element;
    if (i) {
        e.setFill(i, t);
        e.setStroke(i, t)
    }
    return this
};
Wikimapia.Layer.Interactive.Polygon.prototype.setGeometry = function (t) {
    this.hide();
    Wikimapia.Feature.Polygon.prototype.setGeometry.call(this, t)
};
Wikimapia.Layer.Interactive.Polyline = function (t) {
    Wikimapia.Feature.Polyline.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Interactive.Polyline, Wikimapia.Feature.Polyline);
Wikimapia.Layer.Interactive.Polyline.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Feature.Polyline.prototype.options, {
    className: "temporary-segment"
});
Wikimapia.Layer.Interactive.Polyline.prototype.displayColor = "#ffcc00";
Wikimapia.Layer.Interactive.Polyline.prototype.hiddenColor = "transparent";
Wikimapia.Layer.Interactive.Polyline.prototype.show = function () {
    return this.setStroke(this.displayColor)
};
Wikimapia.Layer.Interactive.Polyline.prototype.hide = function () {
    return this.setStroke(this.hiddenColor)
};
Wikimapia.Layer.Interactive.Polyline.prototype.setStroke = function (t) {
    this.renderer.setStroke(this.element, t);
    return this
};
Wikimapia.Layer.Interactive.Polyline.prototype.setGeometry = function (t) {
    this.hide();
    Wikimapia.Feature.Polyline.prototype.setGeometry.call(this, t)
};
Wikimapia.Layer.Interactive.Roads = function () {
    this.segmentTolerance = 2;
    this.maxSegmentThickness = new Wikimapia.Size(0, 0);
    this.iroadsParser = null;
    this.segments = {};
    this.points = {};
    this.groups = {};
    this.shownSegments = [];
    this.permanentRoad = {
        id: 0,
        segments: [],
        centralSegment: null,
        distance: 0
    };
    this.highlightedGroup = 0
};
Wikimapia.Layer.Interactive.Roads.hideTimeout = 250;
Wikimapia.Layer.Interactive.Roads.prototype.constructor = Wikimapia.Layer.Interactive.Roads;
Wikimapia.Layer.Interactive.Roads.prototype.clearCachedSegments = function () {
    this.segments = {};
    this.groups = {};
    this.points = {}
};
Wikimapia.Layer.Interactive.Roads.prototype.onGroupClick = function (t) {
    if (this.highlightedGroup) {
        var e = this.groups[this.highlightedGroup];
        this.map.fireEvent("show", new Wikimapia.Linear.Street({
            id: parseInt(this.highlightedGroup),
            currentLanguage: Wikimapia.Lang.codeToLng(e.currentLanguage),
            title: e.titles[e.currentLanguage],
            titles: e.titles
        }))
    }
    this.destroyPermanentPolygon();
    t.stop()
};
Wikimapia.Layer.Interactive.Roads.prototype.onGroupRightClick = function (t) {
    t && t.stop();
    if (this.map.options.embedded) {
        return
    }
    if (this.highlightedGroup) {
        var e = this.groups[this.highlightedGroup];
        this.streetContextMenu(new Wikimapia.Linear.Street({
            id: parseInt(this.highlightedGroup),
            currentLanguage: Wikimapia.Lang.codeToLng(e.currentLanguage),
            titles: e.titles,
            title: e.titles[e.currentLanguage]
        }))
    }
};
Wikimapia.Layer.Interactive.Roads.prototype.findAndShowPermanentRoad = function (t, e, i) {
    setTimeout(function () {
        var e, i, a, o, n = this.map.getCenter();
        if (!(t in this.groups)) return;
        this.highlightSegmentsGroup(t);
        this.permanentRoad.id = t;
        delete this.permanentRoad.centralSegment;
        this.permanentRoad.distance = this.permanentRoad.centralSegment ? this.permanentRoad.distance : Number.MAX_VALUE;
        if (this.shownSegments.length > 0) {
            this.setGroupTooltip(t);
            for (var s = 0, r = this.shownSegments.length; s < r; s++) {
                e = this.shownSegments.pop();
                if (e.options.group === t) {
                    e.removeEvent("click", this.handlers.onGroupClick);
                    o = e.geometry.getBounds()
                        .getCenterLatLng();
                    a = Math.pointsDistance(n.lng, n.lat, o.lng, o.lat);
                    if (a < this.permanentRoad.distance) {
                        this.permanentRoad.distance = a;
                        this.permanentRoad.centralSegment = e
                    }
                    e.setStyle({
                        strokeColor: this.options.permPolyColor,
                        strokeOpacity: .4
                    });
                    this.permanentRoad.segments.push(e)
                } else {
                    this.shownSegments.unshift(e)
                }
            }
        }
        this.setGroupTooltip(t);
        this.stickTooltip(this.tooltip, this.permanentRoad.centralSegment.getBounds()
            .getCenterLatLng());
        this.tooltip.hide();
        this.shownSegments.length = this.highlightedGroup = 0
    }.bind(this), i || 0)
};
Wikimapia.Layer.Interactive.Roads.prototype.streetContextMenu = function (t) {
    var e = this.map.getControlByName("Object"),
        i = [{
            text: "show-menu-edit-page",
            icon: {
                spritePos: "-18px -144px"
            },
            action: function () {
                this.map.fireEvent("edit", t)
            }.bind(this)
        }, {
            text: "show-menu-history",
            icon: {
                spritePos: "-18px -90px"
            },
            action: function () {
                e._history.view(t)
            }
        }];
    this.objectContextMenu = this.map.contextMenu(i, {}, "object-context-menu", this.map.getMousePosition(), true)
};
Wikimapia.Layer.Interactive.Roads.prototype.calculateScanOptions = function () {
    var t = Wikimapia.Utils.linearSegmentWidth(4, this.map.getZoom()) * .5,
        e = this.map.getCenter(),
        i = this.map.getSize()
        .scale(.5),
        a = e.subtract(this.map.fromContainerPixelToLatLng(new Wikimapia.Point(i.w + t, i.h))),
        o = e.subtract(this.map.fromContainerPixelToLatLng(new Wikimapia.Point(i.w, i.h + t)));
    this.maxSegmentThickness = new Wikimapia.Size(Math.abs(a.lng) * 2, Math.abs(o.lat) * 2);
    return this.maxSegmentThickness
};
Wikimapia.Layer.Interactive.Roads.prototype.scanSegments = function (t, e, i) {
    var a = this.segments,
        o = null,
        n, s, r, p = this.map.fromContainerPixelToLatLng(t),
        l = this.segmentTolerance,
        c = this.maxSegmentThickness,
        h = this.map.getZoom(),
        u = new Wikimapia.Bounds({
            left: p.lng - c.w,
            right: p.lng + c.w,
            top: p.lat + c.h,
            bottom: p.lat - c.h
        });
    for (var m = 0, d = e.length; m < d; m++) {
        r = e[m];
        n = a[r];
        if (n) {
            if (!n.geometry) {
                n.geometry = new Wikimapia.Geometry.Line([this.points[n.start], this.points[n.end]])
            }
            s = n.geometry;
            n.weight = Wikimapia.Utils.linearSegmentWidth(a[r].type, h);
            if (u.intersectsBounds(s.getBounds(), true)) {
                var f = this.map.fromLatLngToContainerPixel(s.getVertex(0)),
                    g = this.map.fromLatLngToContainerPixel(s.getVertex(1));
                var y = n.weight * .5 + l,
                    k = Math.pointToLineDistance(t.x, t.y, f.x, f.y, g.x, g.y, false);
                if (k <= y) {
                    o = n;
                    break
                }
            }
        }
    }
    return o
};
Wikimapia.Layer.Interactive.Roads.prototype.gatherGroupSequences = function (t) {
    var e = this.groups[t].segments.slice(),
        i = {},
        a = [],
        o, n, s;
    e.forEach(function (t) {
        i[t] = true
    });
    s = e.pop();
    while (s) {
        var r = [],
            p, l, c, h, u;
        c = h = l = this.segments[s];
        r.push(l);
        delete i[s];
        while (h) {
            u = this.points[h.end].connected;
            n = u.length;
            s = h.id;
            h = null;
            if (n) {
                for (o = 0; o < n; o++) {
                    p = u[o];
                    if (p in i && p !== s) {
                        delete i[p];
                        e.splice(e.indexOf(p), 1);
                        h = this.segments[p];
                        r.push(h);
                        break
                    }
                }
            }
        }
        a.push(r);
        s = e.pop()
    }
    return a
};
Wikimapia.Layer.Interactive.Roads.prototype.gatherGroupSequencesBrute = function (t) {
    var e = [],
        i = this.groups[t].segments;
    for (var a = 0, o = i.length; a < o; a++) {
        e.push([this.segments[i[a]]])
    }
    return e
};
Wikimapia.Layer.Interactive.Roads.prototype.clearHighlightedSegments = function () {
    var t = this.shownSegments.concat(),
        e = this.handlers.onGroupClick;
    this.shownSegments = [];
    this.shownSegments.length = this.highlightedGroup = 0;
    window.setTimeout(function () {
        for (var i = 0, a = t.length; i < a; i++) {
            var o = t[i];
            if (o.isRendered()) {
                o.hide()
            }
        }
        window.setTimeout(function () {
            for (var i = 0, a = t.length; i < a; i++) {
                t.pop()
                    .setMap(null)
                    .removeEvent("click", e)
            }
        }, Wikimapia.Layer.Interactive.Roads.hideTimeout)
    }, 1)
};
Wikimapia.Layer.Interactive.Roads.prototype.highlightSegmentsGroup = function (t) {
    this.highlightedGroup = t;
    var e = this.gatherGroupSequencesBrute(t),
        i = this.points,
        a, o = {
            style: {
                strokeColor: this.options.segmentColor,
                strokeOpacity: this.options.segmentOpacity
            }
        };
    for (var n = 0, s = e.length; n < s; n++) {
        var r = e[n],
            p = r[0],
            l = [i[r[0].start].clone()],
            c = 0;
        for (var h = 0, u = r.length; h < u; h++) {
            p = r[h];
            c = Math.max(c, Wikimapia.Utils.linearSegmentWidth(p.type, this.map.options.zoom));
            l.push((l[l.length - 1].equals(i[p.end]) ? i[p.start] : i[p.end])
                .clone())
        }
        o.points = l;
        o.style.strokeWidth = c;
        o.group = t;
        o.map = this.map;
        a = new Wikimapia.Layer.Interactive.Polyline(o);
        a.addEvents({
            click: this.handlers.onGroupClick,
            rightclick: this.handlers.onGroupRightClick,
            contextmenu: this.handlers.onGroupRightClick
        });
        this.shownSegments.push(a)
    }
    this.highlightedGroup = t;
    this.setGroupTooltip(t)
        .show()
};
Wikimapia.Layer.Interactive.Roads.prototype.setGroupTooltip = function (t) {
    var e = Wikimapia.Lang,
        i = "" + e.getCurrentLanguageCode(),
        a = "",
        t = this.groups[t];
    if (typeof t.titles === "string") {
        t.titles = Wikimapia.Parser.Linear.decodeTitles(t.titles)
    }
    if (i in t.titles) {
        a = t.titles[i]
    } else {
        for (var o = 0, n = e.popLanguages.length; o < n; o++) {
            i = e.popLanguages[o];
            if (i in t.titles) {
                a = t.titles[i];
                break
            }
        }
        if (a === "") {
            for (var s in t.titles) {
                a = t.titles[s];
                i = s;
                break
            }
        }
        a = a + " (" + e.codeToLng(i) + ")"
    }
    t.currentLanguage = i;
    this.tooltip.innerHTML = a;
    return this.tooltip
};
Wikimapia.Layer.Interactive.Brands = function () { };
Wikimapia.Layer.Interactive.Brands.prototype = {
    constructor: Wikimapia.Layer.Interactive.Brands,
    brands: {},
    checkZoomForBrands: function () {
        return this.map.getZoom() > Wikimapia.Layer.Interactive.Basic.MIN_BRANDS_ZOOM
    },
    loadBrands: function () {
        if (this.checkZoomForBrands()) {
            this.setupItemHandlers();
            new Wikimapia.Net.Xhr({
                method: "get",
                noCache: true,
                onSuccess: this.onBrandsLoaded.bind(this)
            })
                .send({
                    url: "/z1/ads/0.xy"
                })
        }
        return this
    },
    onBrandsLoaded: function (t) {
        var e = {};
        this.parser.parseBrands(t, e);
        this.clearBrands();
        this.brands = {};
        this.brandsRenderDelay = setTimeout(function () {
            if (this.map && this.checkZoomForBrands()) {
                for (var t in e) {
                    if (e.hasOwnProperty(t)) {
                        this.brands[t] = this.renderFeature(e[t], t)
                    }
                }
            }
        }.bind(this), 500)
    },
    getItemMarkerParams: function (t) {
        var e = t.icon ? "/p/ads/" + t.icon : this.options.itemIcon,
            i, a, o = {},
            n = {
                image: e,
                imageSpriteClass: "sponsored"
            };
        if (t.icon) {
            if (parseInt(e.toLowerCase()
                    .match(/\/(\d+).(\w{3,4})$/)[1]) < 1e3) {
                n.size = new Wikimapia.Size(32, 37);
                o.offset = new Wikimapia.Size(-16, -32)
            } else {
                n.size = new Wikimapia.Size(32, 32);
                o.offset = new Wikimapia.Size(-16, -16)
            }
        } else {
            n.size = new Wikimapia.Size(16, 16);
            o.offset = new Wikimapia.Size(-8, -8)
        }
        o.icon = new Wikimapia.Icon(n);
        o.coords = t.mbr.getCenterLatLng();
        o.obj = t;
        return o
    },
    renderFeature: function (t) {
        if (this.brands[t.id]) return this.brands[t.id];
        var e = new Wikimapia.Marker(this.getItemMarkerParams(t));
        this.map.addMarker(e);
        e.addEvents({
            mouseover: this.handlers.onItemMouseOver,
            mouseout: this.handlers.onItemMouseOut,
            mousemove: this.handlers.onItemMouseMove,
            click: this.handlers.onPlaceClick,
            contextmenu: this.handlers.onPlaceRightClick,
            rightclick: this.handlers.onPlaceRightClick
        });
        this.brands[t.id] = e;
        return e
    },
    clearBrands: function () {
        for (var t in this.brands) {
            this.map.removeMarker(this.brands[t]);
            delete this.brands[t]
        }
        return this
    },
    setupItemHandlers: function () {
        Wikimapia.Utils.bindHandlers(this, "onItemMouseOver", "onItemMouseOut", "onItemMouseMove")
    },
    onItemMouseOver: function (t) {
        var e = t.feature;
        if (this.isEnabled()) {
            clearTimeout(this.hideTooltipTimer);
            clearTimeout(this.suggestMenuTimer);
            Wikimapia.Utils.dethrottle("highlightObject", false);
            var i = this.tooltip,
                a = this.map.getMousePosition(),
                o = e.options.obj;
            if (typeof o.polygon === "string") {
                o.polygon = this.parser.decodePolygonMK2(o.polygon)
            }
            if (!o.polygon) {
                o.polygon = Wikimapia.Geometry.fromMBR(o.mbr);
                o.noPolygon = true
            }
            if (o.noPolygon) {
                this.suggestMenuTimer = setTimeout(function () {
                    this.showOutlineMenu(o)
                }.bind(this), this.options.suggestMenuDelay)
            } else if (this.map.getZoom() < this.options.minViewLevel) {
                this.suggestMenuTimer = setTimeout(function () {
                    this.showZoomMenu(o)
                }.bind(this), this.options.suggestMenuDelay)
            }
            this.highlightObjectAt(o, a);
            this.highlightedPolygon.setStyle({
                fillColor: this.options.sponsoredColor
            });
            this.addItemCustomTooltipText(o.tooltipText);
            a = this.map.getTooltipPosition(a, i.offsetWidth, i.offsetHeight);
            i.style.top = a.y + "px";
            i.style.left = a.x + "px"
        }
        t.stop()
    },
    addItemCustomTooltipText: function (t) {
        if (t) {
            this.tooltip.innerHTML += '<hr/><span class="sponsored">' + t + "</span>"
        }
    },
    onItemMouseMove: function (t) {
        t.stop();
        Wikimapia.Utils.dethrottle("highlightObject", false);
        return false
    },
    onItemMouseOut: function (t) {
        if (this.isEnabled()) {
            var e = this;
            clearTimeout(this.suggestMenuTimer);
            this.hideTooltipTimer = setTimeout(function () {
                e.highlightedObject = null;
                if (e.highlightedPolygon) {
                    e.highlightedPolygon.hide();
                    e.tooltip.hide()
                }
            }, 100);
            this.highlightedPolygon.setStyle({
                fillColor: this.options.segmentColor
            })
        }
    }
};
Wikimapia.Layer.Interactive.TileTypes = {
    OBJECTS: 2,
    ROADS: 4,
    OBJECTS_AND_ROADS: 8,
    NONE: 0
};
Wikimapia.Layer.Interactive.Basic = function (t) {
    Wikimapia.Layer.Interactive.prototype.constructor.call(this, t);
    Wikimapia.Layer.Interactive.Roads.call(this, t);
    this.iroadsParser = new Wikimapia.Parser.Linear(this);
    this.setupCDNUrl();
    this.throttledScanFunction = Wikimapia.Utils._throttle(this.highlightObjectAt.bind(this), 40, {
        leading: true,
        trailing: false
    })
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Interactive.Basic, Wikimapia.Layer.Interactive);
Wikimapia.Utils.mixin(Wikimapia.Layer.Interactive.Basic, Wikimapia.Layer.Interactive.Roads);
Wikimapia.Utils.mixin(Wikimapia.Layer.Interactive.Basic, Wikimapia.Layer.Interactive.Brands);
Wikimapia.Layer.Interactive.Basic.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.Interactive.prototype.options, Wikimapia.Layer.Interactive.Roads.prototype.options, Wikimapia.Layer.Interactive.Brands.prototype.options, {
    name: "wikimapia.interactive.basic",
    iroadsMinLoadLevel: Wikimapia.Utils.alphaImageHackNeeded ? 1e3 : 12,
    segmentColor: "#ffcc00",
    sponsoredColor: "#ff6600",
    segmentOpacity: .7,
    itemIcon: Wikimapia.Utils.appendFileVersion(Wikimapia.Utils.defaultMarkersUrl + "category-marker.png"),
    itemIconSize: new Wikimapia.Size(32, 37),
    CDNSyncTimeout: 1e4
});
Wikimapia.Layer.Interactive.Basic.prototype.loadMapObject = function () {
    this.handlers.onGroupClick = this.onGroupClick.bind(this);
    this.handlers.onGroupRightClick = this.onGroupRightClick.bind(this);
    Wikimapia.Layer.Interactive.prototype.loadMapObject.call(this);
    this.map.statusbar.hide();
    this.attachMapEvents();
    this.loadBrands()
};
Wikimapia.Layer.Interactive.Basic.prototype.initCache = function () {
    Wikimapia.Layer.Interactive.prototype.initCache.call(this);
    this.clearCachedSegments()
};
Wikimapia.Layer.Interactive.Basic.prototype.attachMapEvents = function () {
    this.handlers.recalculateScanOptions = this.calculateScanOptions.bind(this);
    this.map.addEvents({
        zoomChanged: this.handlers.recalculateScanOptions,
        moveend: this.handlers.recalculateScanOptions
    });
    this.calculateScanOptions()
};
Wikimapia.Layer.Interactive.Basic.prototype.onMoveStart = function () {
    this.tooltip.hide()
};
Wikimapia.Layer.Interactive.Basic.prototype.detachMapEvents = function () {
    this.map.removeEvents({
        zoomChanged: this.handlers.recalculateScanOptions,
        moveend: this.handlers.recalculateScanOptions
    })
};
Wikimapia.Layer.Interactive.Basic.prototype.mouseMove = function (t) {
    var e = this.tooltip,
        i = this.map.getTooltipPosition(this.map.getMousePosition(), e.offsetWidth, e.offsetHeight),
        a = e.style;
    this.throttledScanFunction(null, t.client);
    a.top = i.y + "px";
    a.left = i.x + "px"
};
Wikimapia.Layer.Interactive.Basic.prototype.disable = function () {
    Wikimapia.Layer.Interactive.prototype.disable.call(this);
    this.clearHighlightedSegments();
    Wikimapia.Utils.dethrottle("highlightObject", false)
};
Wikimapia.Layer.Interactive.Basic.prototype.addTile = function (t) {
    t.layer = this;
    return new Wikimapia.Tile.Itile(t)
};
Wikimapia.Layer.Interactive.Basic.prototype.renderTile = function (t, e, i, a, o, n) {
    if (n === Wikimapia.Layer.Interactive.TileTypes.ROADS) {
        var s = this.parseTile(t, e, i, a, o, n);
        this.tileCache["iroads" + e] = {
            segmentIds: s.segments
        };
        if (this.map.options.road && !this.permanentPolygon) {
            this.findAndShowPermanentRoad(this.map.options.road, this.tileCache[e])
        }
    } else {
        Wikimapia.Layer.Interactive.prototype.renderTile.call(this, t, e, i, a, o, n);
        if (this.map.options.poly && !this.permanentPolygon) {
            this.findAndShowPermanentPolygon(this.map.options.poly, this.tileCache[e])
        }
    }
};
Wikimapia.Layer.Interactive.Basic.prototype.parseTile = function (t, e, i, a, o, n) {
    var s = n === Wikimapia.Layer.Interactive.TileTypes.ROADS ? this.iroadsParser : this.parser;
    return s.parse(t, e)
};
Wikimapia.Layer.Interactive.Basic.prototype.getTileUrl = function (t, e, i, a) {
    var o = this.options.url;
    if (a === Wikimapia.Layer.Interactive.TileTypes.ROADS) {
        o = this.options.iroadsUrl
    }
    o = o.substitute({
        tileID: this.toQuadKey(t, e, i)
            .replace(/(\d{3})(?!$)/g, "$1/"),
        hash: this.hash
    });
    return o
};
Wikimapia.Layer.Interactive.Basic.prototype.tileLoadingAllowed = function (t) {
    var e = this.map.getZoom(),
        i = e >= this.options.minLoadLevel,
        a = true,
        o = this.getCachedParentTileId(t.id),
        n = Wikimapia.Layer.Interactive.TileTypes.NONE,
        s = e >= this.options.iroadsMinLoadLevel;
    this.requestedTiles = this.requestedTiles || [];
    if (this.requestedTiles.indexOf(t.id) === -1) {
        this.requestedTiles.push(t.id)
    }
    if (o) {
        this.renderTileFromCache(t, o);
        if (s) {
            n = Wikimapia.Layer.Interactive.TileTypes.ROADS
        }
    } else if (i) {
        n = s ? Wikimapia.Layer.Interactive.TileTypes.OBJECTS_AND_ROADS : Wikimapia.Layer.Interactive.TileTypes.OBJECTS
    }
    return n
};
Wikimapia.Layer.Interactive.Basic.prototype.highlightObjectAt = function (t, e) {
    var i = this.getTileAtPosition(e),
        a;
    if (!i) {
        return
    }
    a = this.map.fromContainerPixelToLatLng(e);
    t = t || this.findObjectAtLatLng(i, a, e);
    if (t === null) {
        this.highlightedObject = null;
        this.clearHighlightedSegments();
        if (this.highlightedPolygon) {
            this.highlightedPolygon.hide()
        }
        this.onPlaceMouseout();
        this.tooltip.hide()
    } else {
        if (t.group) {
            this.highlightedObject = null;
            this.highlightedPolygon && this.highlightedPolygon.hide();
            if (t.group !== this.highlightedGroup) {
                this.clearHighlightedSegments();
                this.highlightSegmentsGroup(t.group)
            }
        } else {
            if (t !== this.highlightedObject) {
                this.clearHighlightedSegments();
                this.highlightObject(t)
            }
        }
    }
};
Wikimapia.Layer.Interactive.Basic.prototype.findObjectAtLatLng = function (t, e, i) {
    var a = this.tileCache["iroads" + t.id],
        o = null,
        n;
    if (a) {
        n = a.segmentIds;
        o = this.scanSegments(new Wikimapia.Point(i.x, i.y), n)
    }
    if (!o) {
        a = this.getTileCacheByTileId(t.id);
        if (a) {
            var s = this.tileCache.objects,
                r, p;
            n = a.ids;
            for (var l = 0, c = n.length; l < c; l++) {
                r = s[n[l]];
                p = r.mbr;
                if (p.containsLatLng(e)) {
                    if (p.getWidth() > this.mbrLimit.w || p.getHeight() > this.mbrLimit.h) {
                        continue
                    }
                    if (typeof r.polygon === "string") {
                        r.polygon = this.parser[r.encodingType === 1 ? "decodePolygonMK2" : "decodePolygon"](r.polygon)
                    }
                    if (r.polygon.containsLatLng(e)) {
                        o = r
                    }
                }
            }
        } else {
            if (t && !t.request.isRunning()) {
                t.draw()
            }
        }
    }
    return o
};
Wikimapia.Layer.Interactive.Basic.prototype.destroyPermanentPolygon = function () {
    delete this.map.options.road;
    for (var t = 0, e = this.permanentRoad.segments.length; t < e; t++) {
        this.map.removeVectorFeature(this.permanentRoad.segments.pop())
    }
    Wikimapia.Layer.Interactive.prototype.destroyPermanentPolygon.call(this)
}, Wikimapia.Layer.Interactive.Basic.prototype.onObjectEdit = function (t) {
    if (t.type == 2 || t.object_type == 2) {
        this.destroyPermanentPolygon();
        this.findAndShowPermanentRoad(t.id, undefined, 1e3)
    } else {
        Wikimapia.Layer.Interactive.prototype.onObjectEdit.call(this, t)
    }
};
Wikimapia.Layer.Interactive.Basic.prototype.setZoom = function (t) {
    this.clearHighlightedSegments();
    this.clearGrid();
    this.clearCachedSegments();
    Wikimapia.Layer.Interactive.prototype.setZoom.call(this, t);
    this.clearBrands()
        .loadBrands()
}, Wikimapia.Layer.Interactive.Basic.prototype.clearTile = function (t, e) {
    if (t) {
        var i = t.id,
            a;
        if (typeof e === "undefined") {
            e = this.map.getZoom() === this.options.zoom
        }
        Wikimapia.Layer.Interactive.prototype.clearTile.call(this, t, e);
        if (t && i in this.tileCache) {
            this.clearTilePolygons(i, e);
            this.clearTileRoads(i, this.getTileBounds(t.x, t.y), e)
        }
    }
};
Wikimapia.Layer.Interactive.Basic.prototype.clearTilePolygons = function (t, e) {
    var i, a, o, n, s, r, p = this.tileCache[t];
    if (!p.deeperTiles && p.derivedTiles && !e) { } else {
        if (!p.deeperTiles && p.derivedTiles) {
            return
        }
        if (p.deriveFrom) {
            this.tileCache[p.deriveFrom].derivedTiles--
        }
        for (o = p.ids, i = 0, a = o.length; i < a; i++) {
            n = o[i];
            r = this.tileCache.objects[n];
            if (r) {
                if (r.count) {
                    r.count--
                }
                if (!r.count) {
                    delete this.tileCache.objects[n];
                    Wikimapia.Cache.Pool.release(r)
                }
            }
        }
        this.clearedTiles = this.clearedTiles || [];
        if (this.clearedTiles.indexOf(t) === -1) {
            this.clearedTiles.push(t)
        }
        delete this.tileCache[t];
        if (this.tileCache.nonDescendant.indexOf(t) !== -1) {
            this.tileCache.nonDescendant.splice(this.tileCache.nonDescendant.indexOf(t))
        }
    }
};
Wikimapia.Layer.Interactive.Basic.prototype.clearTileRoads = function (t, e, i) {
    var a, o, n, s, r, p = this.tileCache["iroads" + t];
    var l = 0;
    if (p) {
        for (n = p.segmentIds, a = 0, o = n.length; a < o; a++) {
            s = n[a];
            var c = this.segments[s];
            if (c) {
                r = (new Wikimapia.Bounds)
                    .extend(this.points[c.start])
                    .extend(this.points[c.end]);
                if (!i && e.containsBounds(r, true)) {
                    delete this.points[c.start];
                    delete this.points[c.end];
                    delete this.segments[s];
                    Wikimapia.Cache.Pool.release(c);
                    this.groups[c.group].segments.splice(this.groups[c.group].segments.indexOf(c.id), 1);
                    l++
                }
            }
        }
    }
    delete this.tileCache["iroads" + t]
};
Wikimapia.Layer.Interactive.Basic.prototype.tilesMonitor = function (t, e, i, a) {
    if (t === "queueStart" && this.map.getZoom() >= this.options.iroadsMinLoadLevel) {
        var o = e;
        this.numLoadingTiles += o;
        Wikimapia.Layer.Interactive.prototype.tilesMonitor.call(this, t, o * 2)
    } else {
        Wikimapia.Layer.Interactive.prototype.tilesMonitor.call(this, t, e, i, a)
    }
    if (t === "loaderror") {
        this.switchToProductionForTiles(true);
        this.numLoadingTiles--
    }
}, Wikimapia.Layer.Interactive.Basic.prototype.setupCDNUrl = function () {
    if (Wikimapia.Net.usesCDN()) {
        if (!("_url" in this.options)) {
            this.options._url = this.options.url
        }
        this.options.url = window.cdn.host + this.options._url
    }
};
Wikimapia.Layer.Interactive.Basic.prototype.switchToProductionForTiles = function (t) {
    if ("_url" in this.options) {
        this.options.url = this.options._url;
        if (!t) {
            setTimeout(this.setupCDNUrl.bind(this), this.options.CDNSyncTimeout)
        }
    }
};
Wikimapia.Layer.Interactive.Basic.prototype.redraw = function (t) {
    this.switchToProductionForTiles();
    Wikimapia.Layer.Interactive.prototype.redraw.call(this, t)
}, Wikimapia.Layer.Interactive.Basic.prototype.destroy = function () {
    this.clearBrands();
    this.clearHighlightedSegments();
    this.detachMapEvents();
    Wikimapia.Layer.Interactive.prototype.destroy.call(this)
};
Wikimapia.Layer.Interactive.Basic.MIN_BRANDS_ZOOM = 13;
Wikimapia.Utils.extend(Wikimapia.supportedLayers, {
    "wikimapia.interactive.basic": {
        layerConstructor: Wikimapia.Layer.Interactive.Basic,
        defaultOptions: {
            url: "/z1/itiles/{tileID}.xy?{hash}",
            iroadsUrl: "/z1/iroads/{tileID}.xy?{hash}"
        }
    }
});
Wikimapia.Layer.Interactive.Features = function () { };
Wikimapia.Layer.Interactive.Features.prototype.options = {
    minViewLevel: 0,
    suggestMenuDelay: 300
};
Wikimapia.Layer.Interactive.Features.prototype.suggestMenuTimer = null;
Wikimapia.Layer.Interactive.Features.prototype.features = {};
Wikimapia.Layer.Interactive.Features.prototype.mouseMove = Wikimapia.Utils.noop;
Wikimapia.Layer.Interactive.Features.prototype.setupItemHandlers = function () {
    Wikimapia.Utils.extend(this.handlers, {
        onItemMouseOver: this.onItemMouseOver.bind(this),
        onItemMouseOut: this.onItemMouseOut.bind(this),
        onItemMouseMove: this.onItemMouseMove.bind(this)
    })
};
Wikimapia.Layer.Interactive.Features.prototype.setStatusMessage = function (t) {
    var e = this.map.vectorLayer.polygonEditor;
    if (e && e.isInProgress()) {
        t = "adding-po1"
    }
    Wikimapia.Layer.Editor.prototype.setStatusMessage.call(this, t)
};
Wikimapia.Layer.Interactive.Features.prototype.clearFeatures = function () {
    this.stopRenderingFeatures();
    for (var t in this.grid) {
        this.clearTile(this.grid[t], true)
    }
    for (var e in this.features) {
        if (this.features.hasOwnProperty(e)) {
            this.removeFeature(this.features[e])
        }
    }
    this.features = {};
    this.loadedTiles = []
};
Wikimapia.Layer.Interactive.Features.prototype.renderTile = function (t, e, i, a, o) {
    var n = Wikimapia.Layer.Interactive.prototype.renderTile.apply(this, [t, e, i, a, o]);
    this.features = this.features || {};
    this.renderFeatures(n.ids, this.options.strictBounds || this.getTileBounds(i, a))
};
Wikimapia.Layer.Interactive.Features.prototype.renderFeatures = function (t, e) {
    var i = 0,
        a = [];
    for (var o = 0, n = t.length; o < n; o++) {
        var s = t[o],
            r = this.tileCache.objects[s],
            p = r.mbr;
        if (!(s in this.features) && (e.containsBounds(p) || e.intersectsBounds(p))) {
            a.push(r);
            if (a.length === this.options.maxFeaturesPerTile) break
        }
    }
    if (a.length > 0) {
        this.renderTimer = Wikimapia.Utils.timedProcessItems(a, this.renderFeature.bind(this), this.onFeaturesRendered.bind(this))
    } else {
        this.onFeaturesRendered()
    }
};
Wikimapia.Layer.Interactive.Features.prototype.onFeaturesRendered = function () {
    this.fireEvent("itemsRendered", this)
};
Wikimapia.Layer.Interactive.Features.prototype.renderFeature = function (t) { };
Wikimapia.Layer.Interactive.Features.prototype.removeFeature = function (t) { };
Wikimapia.Layer.Interactive.Features.prototype.onItemMouseOver = function (t) {
    var e = t.feature;
    if (this.isEnabled()) {
        clearTimeout(this.hideTooltipTimer);
        clearTimeout(this.suggestMenuTimer);
        Wikimapia.Utils.dethrottle("highlightObject", false);
        var i = this.tooltip,
            a = this.map.getMousePosition(),
            o = e.options.obj;
        if (o.polygon === "????") delete o.polygon;
        if (typeof o.polygon === "string") {
            o.polygon = this.parser[o.encodingType === 1 ? "decodePolygonMK2" : "decodePolygon"](o.polygon)
        }
        if (!o.polygon) {
            o.polygon = Wikimapia.Geometry.fromMBR(o.mbr);
            o.noPolygon = true
        }
        if (o.noPolygon) {
            clearTimeout(this.suggestMenuTimer);
            this.suggestMenuTimer = setTimeout(function () {
                this.showOutlineMenu(o)
            }.bind(this), this.options.suggestMenuDelay)
        } else if (this.map.getZoom() < this.options.minViewLevel) {
            clearTimeout(this.suggestMenuTimer);
            this.suggestMenuTimer = setTimeout(function () {
                this.showZoomMenu(o)
            }.bind(this), this.options.suggestMenuDelay)
        } else {
            clearTimeout(this.suggestMenuTimer);
            if (this.objectContextMenu) {
                this.objectContextMenu.destroy();
                delete this.objectContextMenu
            }
        }
        this.highlightObjectAt(o, a);
        a = this.map.getTooltipPosition(a, i.offsetWidth, i.offsetHeight);
        i.style.top = a.y + "px";
        i.style.left = a.x + "px"
    }
    t.stop()
};
Wikimapia.Layer.Interactive.Features.prototype.onItemMouseMove = function (t) {
    t.stop();
    Wikimapia.Utils.dethrottle("highlightObject", false);
    return false
};
Wikimapia.Layer.Interactive.Features.prototype.onItemMouseOut = function (t) {
    if (this.isEnabled()) {
        var e = this;
        clearTimeout(this.suggestMenuTimer);
        this.hideTooltipTimer = setTimeout(function () {
            e.highlightedObject = null;
            if (e.highlightedPolygon) {
                e.highlightedPolygon.hide();
                e.tooltip.hide()
            }
        }, 100)
    }
};
Wikimapia.Layer.Interactive.Features.prototype.showOutlineMenu = function (t) {
    if (!this.map.options.embedded && this.map.access.allowsFeatureEdit() && !/deleted$/.test(this.getName())) {
        var e = this,
            i = [{
                text: t.noPolygon ? "add-outline" : "show-menu-polygon",
                icon: {
                    spritePos: "0 -1470px"
                },
                action: function () {
                    e.edit("polygon", new Wikimapia.Place(t))
                }
            }];
        this.createSideMenu(i)
    }
};
Wikimapia.Layer.Interactive.Features.prototype.createSideMenu = function (t) {
    this.destroySideMenu();
    this.objectContextMenu = this.map.contextMenu(t, {
        autoDestroy: true,
        onDestroy: function () {
            delete this.objectContextMenu
        }.bind(this)
    }, "object-context-menu", this.map.getMousePosition()
        .add(15, -25), true)
};
Wikimapia.Layer.Interactive.Features.prototype.destroySideMenu = function () {
    clearTimeout(this.suggestMenuTimer);
    if (this.objectContextMenu) {
        this.objectContextMenu.destroy();
        delete this.objectContextMenu
    }
};
Wikimapia.Layer.Interactive.Features.prototype.stopRenderingFeatures = function () {
    clearTimeout(this.renderTimer)
};
Wikimapia.Layer.Interactive.Categories = function (t) {
    Wikimapia.Layer.Interactive.prototype.constructor.call(this, t);
    this.urlTemplate = this.options.url.toString()
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Interactive.Categories, Wikimapia.Layer.Interactive);
Wikimapia.Utils.mixin(Wikimapia.Layer.Interactive.Categories, Wikimapia.Layer.Interactive.Features);
Wikimapia.Layer.Interactive.Categories.SPECIAL_CATEGORIES = [88, 564, 949, 46520, 46531, 46532, 46533, 46534, 46535, 46707];
Wikimapia.Layer.Interactive.Categories.SPECIAL_CATEGORIES_IDS = {
    PLACE_WITHOUT_POLYGON: 46520
};
Wikimapia.Layer.Interactive.Categories.tagInfoUrl = "/ajax/get_category/?search_cat_by_id=";
Wikimapia.Layer.Interactive.Categories.noFeaturesNotificatinTimeout = 8e3;
Wikimapia.Layer.Interactive.Categories.prototype.options = Wikimapia.Utils.extend({},
    Wikimapia.Layer.Interactive.prototype.options,
    Wikimapia.Layer.Interactive.Features.prototype.options,
    {
        name: "wikimapia.interactive.categories",
        categoryIdNum: 0,
        categoryName: "",
        maxItemsPerTile: 400,
        minViewLevel: 14,
        categoriesTilesUrl: "/z1/cat/000/000/{category}/{tileID}.xy",
        categoryId: 0,
        itemIcon: Wikimapia.Utils.appendFileVersion(Wikimapia.Utils.defaultMarkersUrl + "category-marker.png"),
        itemIconSize: new Wikimapia.Size(14, 14),
        strictBounds: null
    });
Wikimapia.Layer.Interactive.Categories.prototype.initialStatusMessage = "all.showing-cat";
Wikimapia.Layer.Interactive.Categories.prototype.urlTemplate = "";
Wikimapia.Layer.Interactive.Categories.prototype.loadMapObject = function () {
    this.setupItemHandlers();
    var t = this.options.categoryIdNum,
        e = "";
    if (!e) {
        this.requestCategoryName(t);
        e = ""
    }
    this.updateCategoryStatus(t, e);
    this.onItemMouseOut();
    this.adjustTileUrl(t);
    this.map.fireEvent("tagFiltered", t);
    Wikimapia.Layer.Interactive.prototype.loadMapObject.call(this);
    this.checkViewportForFeatures = Wikimapia.Utils._throttle(this.checkViewportForFeatures.bind(this), 850, {
        leading: false
    });
    this.map.addEvents({
        zoomChanged: this.checkViewportForFeatures,
        moveend: this.checkViewportForFeatures
    });
    this.addEvent("itemsRendered", this.checkViewportForFeatures)
};
Wikimapia.Layer.Interactive.Categories.prototype.checkViewportForFeatures = function () {
    if (this.isEnabled()) {
        var t = this.map.markersLayer.features,
            e = this.map.getBounds(),
            i = false;
        for (var a = 0, o = t.length; a < o; a++) {
            if (t[a].onScreen(e)) {
                i = true;
                break
            }
        }
        if (i || this.numLoadingTiles !== 0) {
            this.dispatchClearNotification()
        } else {
            this.dispatchNoFeaturesNotification()
        }
    }
};
Wikimapia.Layer.Interactive.Categories.prototype.dispatchNoFeaturesNotification = function () {
    this.map.fireEvent("notification", {
        message: "all.category-no-objects-found",
        timeout: 0,
        hideOnClick: true,
        onShow: this.onNoFeaturesNotification.bind(this)
    })
};
Wikimapia.Layer.Interactive.Categories.prototype.onNoFeaturesNotification = function () { };
Wikimapia.Layer.Interactive.Categories.prototype.updateCategoryStatus = function (t, e) {
    if (this.map && !this.map.editingInProgress()) {
        this.map.statusbar.init({
            icon: Wikimapia.Utils.Dom.create("div", {
                "class": "menu-spt s16x16 " + (Wikimapia.Utils.getCategoryIconSprite(e) || "spt-category")
            }),
            message: this.getCategoryStatusMessage(t, e),
            onCancel: function () {
                this.map.removeLayer(this)
            }.bind(this)
        });
        this.addActivityButton(t)
    }
};
Wikimapia.Layer.Interactive.Categories.prototype.addActivityButton = function (t) {
    if (Wikimapia.Layer.Interactive.Categories.SPECIAL_CATEGORIES.indexOf(parseInt(t)) === -1) {
        this.map.statusbar.grab(Wikimapia.Utils.Dom.create("span", {
            "class": "label category-activity",
            onclick: "router.route('/user/tools/watchlist/?mode=tag&tag=" + t + "&type=999/');",
            html: '<i class="icon icon-globe"></i><span class="label text">' + Wikimapia.Lang.get("all.category-activity") + "</span>"
        }))
    }
};
Wikimapia.Layer.Interactive.Categories.prototype.onLanguageChange = function (t) {
    Wikimapia.Layer.Interactive.prototype.onLanguageChange.call(this, t);
    this.requestCategoryName(this.options.categoryIdNum)
};
Wikimapia.Layer.Interactive.Categories.prototype.refreshStatus = function (t) {
    if (this.map.editingInProgress()) {
        Wikimapia.Layer.Interactive.prototype.refreshStatus.call(this, t)
    }
};
Wikimapia.Layer.Interactive.Categories.prototype.adjustTileUrl = function (t) {
    this.options.categoryId = new Array(9 - t.length)
        .concat(t)
        .join("0")
        .replace(/(\d\d\d)(?!$)/g, "$1/");
    if (parseInt(t) > 0) {
        this.map.selectedTagId = t
    }
    this.options.url = this.urlTemplate.replace("categoryId", this.options.categoryId)
};
Wikimapia.Layer.Interactive.Categories.prototype.getCategoryStatusMessage = function (t, e) {
    var i = '<span class="mode-string">' + Wikimapia.Lang.get(this.options.statusText || this.initialStatusMessage)
        .capitalize()
        .replace(/\s/g, "&nbsp;") + "</span> ";
    if (e.id && parseInt(e.id) !== Wikimapia.Layer.Interactive.Categories.SPECIAL_CATEGORIES_IDS.PLACE_WITHOUT_POLYGON) {
        i += '&nbsp;<a class="category-link" rel="category-{id}" ' + "onclick=\"router.route('/object/category/?type=view&id={category_id}" + "&lng={lang}');\">{name}</a>";
        e.name = e.name.replace(/\s/g, "&nbsp;")
    }
    return i.substitute(e)
};
Wikimapia.Layer.Interactive.Categories.prototype.mouseMove = Wikimapia.Utils.noop;
Wikimapia.Layer.Interactive.Categories.prototype.requestCategoryName = function (t) {
    new Wikimapia.Net.Xhr({
        type: "json",
        method: "get",
        onSuccess: function (t) {
            if (!this.map) return;
            if (t && !t.code) {
                this.updateCategoryStatus(t.category_id, t);
                this.map.statusbar.show()
            } else {
                this.destroy()
            }
        }.bind(this)
    })
        .send({
            url: Wikimapia.Layer.Interactive.Categories.tagInfoUrl + t
        })
};
Wikimapia.Layer.Interactive.Categories.prototype.cancelPolygonEdit = function () {
    Wikimapia.Layer.Interactive.prototype.cancelPolygonEdit.call(this);
    this.unblock()
};
Wikimapia.Layer.Interactive.Categories.prototype.clearFeatures = function () {
    Wikimapia.Layer.Interactive.Features.prototype.clearFeatures.call(this);
    this.options.categoryIdNum = 0
};
Wikimapia.Layer.Interactive.Categories.prototype.afterSave = function () {
    this.unblock()
};
Wikimapia.Layer.Interactive.Categories.prototype.removeFeature = function (t) {
    t.removeEvents({
        mouseover: this.handlers.onItemMouseOver,
        mouseout: this.handlers.onItemMouseOut,
        mousemove: this.handlers.onItemMouseMove,
        click: this.handlers.onPlaceClick,
        rightclick: this.handlers.onPlaceRightClick,
        contextmenu: this.handlers.onPlaceRightClick
    });
    this.map.removeMarker(t)
};
Wikimapia.Layer.Interactive.Categories.prototype.renderFeature = function (t) {
    if (this.features[t.id]) return this.features[t.id];
    var e = this.map.addMarker(new Wikimapia.Marker({
        coords: t.mbr.getCenterLatLng(),
        obj: t,
        icon: new Wikimapia.Icon({
            image: this.options.itemIcon,
            size: this.options.itemIconSize
        }),
        offset: new Wikimapia.Size(-8, -8)
    }));
    e.addEvents({
        mouseover: this.handlers.onItemMouseOver,
        mouseout: this.handlers.onItemMouseOut,
        mousemove: this.handlers.onItemMouseMove,
        click: this.handlers.onPlaceClick,
        contextmenu: this.handlers.onPlaceRightClick,
        rightclick: this.handlers.onPlaceRightClick
    });
    this.features[t.id] = e;
    return e
};
Wikimapia.Layer.Interactive.Categories.prototype.parseTile = function (t) {
    return this.parser.parseOldStyle(t)
};
Wikimapia.Layer.Interactive.Categories.prototype.tileLoadingAllowed = function (t) {
    var e = t.id,
        i = false;
    if (!(e in this.loadingTiles)) {
        this.loadingTiles[e] = true;
        i = true
    }
    return i
};
Wikimapia.Layer.Interactive.Categories.prototype.clearTile = function (t, e) {
    Wikimapia.Layer.Interactive.prototype.clearTile.call(this, t, e);
    var i = t ? this.tileCache[t.id] : null;
    if (i) {
        var a = e ? i.mbr : this.getTileBounds(t.x, t.y);
        for (var o = 0, n = i.ids.length; o < n; o++) {
            var s = i.ids[o],
                r = this.tileCache.objects[s],
                p = this.features[s];
            if (r) {
                if (r.count) {
                    r.count--
                }
                if (!r.count || e) {
                    p && this.removeFeature(p);
                    delete this.features[s];
                    delete this.tileCache.objects[s];
                    Wikimapia.Cache.Pool.release(r)
                }
            }
        }
        if (e || a.equals(i.mbr)) {
            delete this.tileCache[t.id]
        }
    }
};
Wikimapia.Layer.Interactive.Categories.prototype.redraw = function (t) {
    var e = this.options.categoryIdNum;
    this.clearFeatures();
    this.options.categoryIdNum = e;
    Wikimapia.Layer.Interactive.prototype.redraw.call(this, t)
}, Wikimapia.Layer.Interactive.Categories.prototype.filterCategory = function (t, e) {
    this.clearFeatures();
    this.options.categoryIdNum = t.toString();
    this.options.categoryName = e;
    this.adjustTileUrl(t);
    this.redraw(true);
    this.requestCategoryName(t);
    this.map.fireEvent("tagFiltered", t)
};
Wikimapia.Layer.Interactive.Categories.prototype.showZoomMenu = function (t) {
    this.createSideMenu([{
        text: "show-menu-zoomin",
        icon: {
            spritePos: "-18px -72px"
        },
        action: function () {
            this.map.zoomToBounds(t.mbr)
        }.bind(this)
    }])
};
Wikimapia.Layer.Interactive.Categories.prototype.unblock = function () {
    this.requestCategoryName(this.options.categoryIdNum);
    this.map.statusbar.show();
    this.blocked = false
};
Wikimapia.Layer.Interactive.Categories.prototype.destroy = function () {
    this.map.removeEvents({
        zoomChanged: this.checkViewportForFeatures,
        moveend: this.checkViewportForFeatures
    });
    this.removeEvent("itemsRendered", this.checkViewportForFeatures);
    this.disable();
    this.clearFeatures();
    this.map.statusbar.hide();
    delete this.options.strictBounds;
    delete this.map.selectedTagId;
    this.map.fireEvent("tagFiltered");
    Wikimapia.Layer.Interactive.prototype.destroy.call(this)
};
Wikimapia.Utils.extend(Wikimapia.supportedLayers, {
    "wikimapia.interactive.categories": {
        layerConstructor: Wikimapia.Layer.Interactive.Categories,
        defaultOptions: {
            url: "/z1/cat/categoryId/{tileID}.xy?{hash}"
        }
    },
    "wikimapia.interactive.categories.rectangles": {
        layerConstructor: Wikimapia.Layer.Interactive.Categories,
        defaultOptions: {
            url: "/z1/cat/categoryId/{tileID}.xy?{hash}",
            statusText: "all.old-places"
        }
    }
});
Wikimapia.Layer.Interactive.Categories.Deleted = function (t) {
    Wikimapia.Layer.Interactive.Categories.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Interactive.Categories.Deleted, Wikimapia.Layer.Interactive.Categories);
Wikimapia.Layer.Interactive.Categories.Deleted.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.Interactive.Categories.prototype.options);
Wikimapia.Layer.Interactive.Categories.Deleted.prototype.addActivityButton = function (t) { };
Wikimapia.Layer.Interactive.Categories.Deleted.prototype.getCategoryStatusMessage = function (t, e) {
    return Wikimapia.Lang.get(this.options.statusText)
};
Wikimapia.Layer.Interactive.Categories.Deleted.prototype.requestCategoryName = function () {
    this.updateCategoryStatus(-1, {});
    this.map.statusbar.show()
};
Wikimapia.supportedLayers["wikimapia.interactive.categories.deleted"] = {
    layerConstructor: Wikimapia.Layer.Interactive.Categories.Deleted,
    defaultOptions: {
        url: "/z1/del/{tileID}.xy?{hash}",
        noTitleText: "",
        statusText: "all.del-pl"
    }
};
Wikimapia.Layer.Google = function (t) {
    Wikimapia.Layer.prototype.constructor.call(this, t)
};
Wikimapia.Utils.inherits(Wikimapia.Layer.Google, Wikimapia.Layer);
Wikimapia.Utils.mixin(Wikimapia.Layer.Google, Wikimapia.Layer.BaseLayer);
Wikimapia.Utils.mixin(Wikimapia.Layer.Google, Wikimapia.Layer.Vendor);
Wikimapia.Layer.Google.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Layer.prototype.options, Wikimapia.Layer.BaseLayer.prototype.options, Wikimapia.Layer.Vendor.prototype.options, {
    type: null,
    apiVersion: 3,
    minZoomLevel: 0,
    maxZoomLevel: 20,
    baseOnly: true,
    maxZoomLimitRequestTimeout: 1500,
    backgroundColor: "#888"
});
Wikimapia.Layer.Google.prototype.type = null;
Wikimapia.Layer.Google.prototype.types = null;
Wikimapia.Layer.Google.prototype.maxZoomServiceInstance = null;
Wikimapia.Layer.Google.prototype.checkZoomLimitsTimer = null;
Wikimapia.Layer.Google.prototype.tiltCorrectionListener = null;
Wikimapia.Layer.Google.prototype.correctionListener = null;
Wikimapia.Layer.Google.prototype.contextMenuDispatcher = null;
Wikimapia.Layer.Google.prototype.tilesLoadedListener = null;
Wikimapia.Layer.Google.prototype.updateSize = function (t) {
    Wikimapia.Layer.prototype.updateSize.call(this, t);
    if (this.mapObject) {
        if (this.correctionListener) {
            google.maps.event.removeListener(this.correctionListener);
            delete this.correctionListener
        }
        google.maps.event.trigger(this.mapObject, "resize");
        clearTimeout(this.resizeRedrawTimer);
        this.resizeRedrawTimer = setTimeout(function () {
            if (this.mapObject) {
                this.correctionListener = google.maps.event.addListener(this.mapObject, "idle", this.correctionHandler);
                if (this.overlayContainer) {
                    this.overlayContainer.correct()
                }
            }
        }.bind(this), 20)
    }
};
Wikimapia.Layer.Google.prototype.constructMap = function () {
    this.mapObject = new google.maps.Map(this.div, {
        center: this.map.getCenter() ? Wikimapia.LatLng.toGLatLng(this.map.getCenter()) : new google.maps.LatLng(0, 0),
        animatedZoom: false,
        zoom: this.map.getZoom() || 0,
        mapTypeId: this.options.type,
        disableDefaultUI: true,
        keyboardShortcuts: false,
        draggable: false,
        draggableCursor: "default",
        disableDoubleClickZoom: true,
        scrollwheel: false,
        streetViewControl: false,
        scaleControl: true,
        tilt: 0,
        backgroundColor: this.options.backgroundColor,
        maxZoom: this.map.options.maxZoomLevel,
        minZoom: this.map.options.minZoomLevel
    });
    this.setMapType(this.options.type);
    this.setCenter(this.map.getCenter());
    this.addMapObjectHandlers();
    this.checkMaxZoomAtLatLng(this.map.getCenter());
    this.updateAccessMode(this.options.type);
    this.fireEvent("mapObjectCreated")
};
Wikimapia.Layer.Google.prototype.addMapObjectHandlers = function () {
    this.correctionHandler = this.correctionHandler.bind(this);
    google.maps.event.addListenerOnce(this.mapObject, "bounds_changed", this.addOverlayContainer.bind(this));
    this.tiltCorrectionListener = google.maps.event.addListener(this.mapObject, "zoom_changed", this.onTiltChanged.bind(this));
    this.correctionListener = google.maps.event.addListener(this.mapObject, "idle", this.correctionHandler);
    this.tilesLoadedListener = google.maps.event.addListener(this.mapObject, "tilesloaded", this.loaded.bind(this));
    this.handleMaxZoomError();
    this.contextMenuDispatcher = google.maps.event.addDomListener(this.mapObject, "rightclick", this.contextMenuHandler.bind(this))
};
Wikimapia.Layer.Google.prototype.contextMenuHandler = function (t) {
    var e = "contextmenu",
        i = window.event && window.event.type === e ? window.event : {
            clientX: t.pixel.x,
            clientY: t.pixel.y,
            type: e,
            rightClick: true,
            which: 3
        };
    this.map._mouseHandler._delegate(Wikimapia.Utils.Event.fix(i))
};
Wikimapia.Layer.Google.prototype.onTiltChanged = function () {
    this.mapObject.setTilt(0)
};
Wikimapia.Layer.Google.prototype.handleMaxZoomError = function () {
    google.maps.event.addListenerOnce(this.mapObject, "idle", function () {
        var t = this.mapObject.getZoom();
        if (t !== this.map.getZoom()) {
            this.zoomCorrectionHandler({
                status: "OK",
                zoom: t
            });
            this.map.setZoom(t)
        }
    }.bind(this))
};
Wikimapia.Layer.Google.prototype.getZoom = function () {
    return this.mapObject ? this.mapObject.getZoom() : this.parent()
};
Wikimapia.Layer.Google.prototype.correctionHandler = function () {
    var t = this.map,
        e = this.getMapObjectCenter(),
        i = t.getCenter();
    if (!e.equals(i)) {
        var a = t.fromLatLngToPixel(e),
            o = t.fromLatLngToPixel(i)
            .subtract(a.x, a.y),
            n = t.layers;
        t.options.center = e;
        for (var s = 0, r = n.length; s < r; s++) {
            n[s].options.center = e
        }
        t.dragObject.position = t.dragObject.position.add(o.x, o.y);
        t.vectorLayer.renderer.offset = t.dragObject.position.clone();
        t._cacheCenterPx()
    }
    this.overlayContainer && this.overlayContainer.correct();
    if (this.mapObject.getMapTypeId() !== "roadmap") {
        this.checkMaxZoomLimit()
    }
};
Wikimapia.Layer.Google.prototype.checkMaxZoomLimit = function (t) {
    clearTimeout(this.checkZoomLimitsTimer);
    this.checkZoomLimitsTimer = setTimeout(function () {
        Wikimapia.Layer.Google.maxZoomServiceInstance.getMaxZoomAtLatLng(this.mapObject.getCenter(), this.zoomCorrectionHandler.bind(this))
    }.bind(this), t ? 0 : this.options.maxZoomLimitRequestTimeout)
};
Wikimapia.Layer.Google.prototype.checkMaxZoomAtLatLng = function (t, e) {
    e = Wikimapia.Utils.getCallback(e);
    Wikimapia.Layer.Google.maxZoomServiceInstance.getMaxZoomAtLatLng(Wikimapia.LatLng.toGLatLng(t), function (t) {
        if (this.map) {
            if (t.status !== "OK") {
                t.zoom = this.map.options.maxZoomLevel
            }
            e(t.zoom);
            this.zoomCorrectionHandler(t)
        }
    }.bind(this))
};
Wikimapia.Layer.Google.prototype.addOverlayContainer = function () {
    if (!this.overlayContainer) {
        this.overlayContainer = new Wikimapia.Layer.Google.Overlay(this.map);
        this.overlayContainer.setMap(this.mapObject);
        if (this.mapObject.getMapTypeId() !== "roadmap") {
            this.checkMaxZoomLimit(true)
        }
    }
    return this.overlayContainer
};
Wikimapia.Layer.Google.prototype.zoomCorrectionHandler = function (t) {
    if (t.status === "OK") {
        if (this.type === "terrain" && this.mapObject.mapTypes[this.type]) {
            t.zoom = this.mapObject.mapTypes[this.type].maxZoom
        }
        this.mapObject.setOptions({
            maxZoom: t.zoom
        });
        this.updateZoomLimits(t.zoom)
    }
};
Wikimapia.Layer.Google.prototype.getOverlayContainer = function () {
    if (this.overlayContainer) {
        return this.overlayContainer.getContainer()
    } else {
        return null
    }
};
Wikimapia.Layer.Google.prototype.tryLoadGMaps = function () {
    if (typeof google.maps != "undefined") {
        if (google.maps.wmLayerReady) {
            clearInterval(this.tryLoadMap);
            this.constructMap()
        }
    }
};
Wikimapia.Layer.Google.prototype.loadMapObject = function () {
    this.updateSize();
    Wikimapia.Utils.Dom.inject(this.div, this.map.dragObject, "before");
    this.div.style.zIndex = 0;
    this.tryLoadMap = setInterval(this.tryLoadGMaps.bind(this), 250)
};
Wikimapia.Layer.Google.prototype.setMap = function (t) {
    Wikimapia.Layer.prototype.setMap.call(this, t);
    Wikimapia.Utils.extend(this.handlers, {
        overlayHack: this.grabOverlayHack.bind(this),
        moveEndOverlayRedraw: this.overlayHackRedraw.bind(this),
        draggableChange: this.onDraggableChange.bind(this)
    });
    this.map.layers.forEach(this.handlers.overlayHack);
    this.map.addEvents({
        layerPreregister: this.handlers.overlayHack,
        draggableChanged: this.handlers.draggableChange
    })
};
Wikimapia.Layer.Google.prototype.onDraggableChange = function (t) {
    this.mapObject && this.mapObject.setOptions({
        draggable: t
    })
};
Wikimapia.Layer.Google.prototype.getMapContainer = function () {
    return this.mapObject.getDiv()
};
Wikimapia.Layer.Google.prototype.addAttribution = function () {
    this.vendorAttributionTimer = setInterval(function () {
        var t = this.div.firstChild,
            e = this.div.style.display,
            i = t ? t.children : null;
        if (i && i.length > 1) {
            clearTimeout(this.vendorAttributionTimer);
            var a = t.removeChild(i[2]);
            this.map.addCopyright(a, this);
            a.style.display = e;
            a.className = "GoogleLayerCopyright copyright";
            this.termsOfUse = a;
            var o = t.removeChild(i[1]);
            this.map.addCopyright(o, this);
            o.style.display = e;
            o.className = "GoogleLayerPoweredBy gmnoprint copyright";
            this.poweredBy = o;
            var n = t.removeChild(i[i.length - 1]);
            this.scaleControl = n;
            this.map.addCopyright(n, this);
            this.map.fireEvent("attributionSet", this.getName())
        }
    }.bind(this), 200)
};
Wikimapia.Layer.Google.prototype.setMapType = function (t) {
    if (t in this.types) {
        this.type = this.types[t];
        if (this.mapObject.mapTypes[this.type]) {
            this.options.maxZoomLevel = this.mapObject.mapTypes[this.type].maxZoom
        }
        this.mapObject.setMapTypeId(this.type);
        this.handleMaxZoomError();
        this.updateNameByType(t);
        this.updateAccessMode(t);
        this.checkMaxZoomLimit(true);
        return true
    } else {
        return false
    }
};
Wikimapia.Layer.Google.prototype.getMapObjectCenter = function () {
    return google.maps.LatLng.toWLatLng(this.mapObject.getCenter())
};
Wikimapia.Layer.Google.prototype.moveBy = Wikimapia.Utils.isTouch ? function (t) {
    Wikimapia.Layer.prototype.moveBy.call(this, t);
    this.mapObject.panBy(-t.x, -t.y)
} : function (t) {
    Wikimapia.Layer.prototype.moveBy.call(this, t);
    this.mapObject.setCenter(Wikimapia.LatLng.toGLatLng(this.map.options.center))
};
Wikimapia.Layer.Google.prototype.setZoom = function (t) {
    if (t <= this.map.options.maxZoomLevel && t >= this.map.options.minZoomLevel) {
        this.options.zoom = t;
        if (this.mapObject) {
            this.mapObject.setOptions({
                zoom: this.map.getZoom(),
                center: Wikimapia.LatLng.toGLatLng(this.map.getCenter()),
                tilt: 0
            })
        }
        this.overlayHackRedraw()
    }
    return this
};
Wikimapia.Layer.Google.prototype.setCenter = function (t, e) {
    Wikimapia.Layer.prototype.setCenter.call(this, t, e);
    if (this.mapObject) {
        this.mapObject.setOptions({
            center: new google.maps.LatLng(t.lat, t.lng),
            zoom: e || this.options.zoom,
            tilt: 0
        })
    }
};
Wikimapia.Layer.Google.prototype.setCursor = function (t) {
    if (this.mapObject) {
        this.mapObject.setOptions({
            draggableCursor: t
        })
    }
};
Wikimapia.Layer.Google.prototype.grabOverlayHack = function (t) {
    var e = t.getName();
    if (/wikimapia-((imagetiles-hybrid)|interactive|linear|markers|vector|statusgrid|overlays)/.test(e)) {
        if (this.getOverlayContainer()) {
            this.overlayHackRedraw();
            Wikimapia.Utils.Dom.inject(t.div, this.getOverlayContainer(), "top");
            Wikimapia.Utils.Dom.setStyles(t.div, {
                position: "absolute",
                top: 0,
                left: 0,
                width: "100%",
                height: "100%"
            })
        } else {
            var i = "recombineLayer" + e + "Timer";
            this[i] = setInterval(function () {
                var e = this.getOverlayContainer();
                if (e) {
                    clearInterval(this[i]);
                    delete this[i];
                    this.overlayHackRedraw();
                    if (t.div) {
                        Wikimapia.Utils.Dom.inject(t.div, e, "top")
                    }
                }
            }.bind(this), 100)
        }
    }
};
Wikimapia.Layer.Google.prototype.overlayHackRedraw = function () {
    if (this.overlayContainer) {
        this.overlayContainer.correct()
    }
};
Wikimapia.Layer.Google.prototype.putOverlaysBack = function () {
    var t = null;
    if (this.getOverlayContainer()) {
        t = this.getOverlayContainer()
            .childNodes
    }
    if (t.length) {
        t = Wikimapia.Utils.Dom.nodeListToArray(t);
        for (var e = 0, i = t.length; e < i; e++) {
            Wikimapia.Utils.Dom.inject(t[e], this.map.dragObject, "top")
        }
    }
    return t
};
Wikimapia.Layer.Google.prototype.destroy = function () {
    this.putOverlaysBack();
    this.map.removeEvents({
        layerPreregister: this.handlers.overlayHack,
        draggableChanged: this.handlers.draggableChange
    });
    google.maps.event.removeListener(this.correctionListener);
    google.maps.event.removeListener(this.tiltCorrectionListener);
    google.maps.event.removeListener(this.contextMenuDispatcher);
    google.maps.event.removeListener(this.tilesLoadedListener);
    delete this.tiltCorrectionListener;
    delete this.correctionListener;
    delete this.contextMenuDispatcher;
    delete this.tilesLoadedListener;
    clearTimeout(this.vendorAttributionTimer);
    clearTimeout(this.checkZoomLimitsTimer);
    this.termsOfUse && Wikimapia.Utils.Dom.destroy(this.termsOfUse);
    this.poweredBy && Wikimapia.Utils.Dom.destroy(this.poweredBy);
    this.scaleControl && Wikimapia.Utils.Dom.destroy(this.scaleControl);
    this.restoreZoomLimits();
    Wikimapia.Layer.prototype.destroy.call(this)
};
Wikimapia.Layer.Google.maxZoomServiceInstance = null;
(function (t, e) {
    ["google.satellite", "google.hybrid", "google.map", "google.terrain"].forEach(function (i) {
        t[i] = {
            layerConstructor: e,
            defaultOptions: {
                type: i
            }
        }
    })
})(Wikimapia.supportedLayers, Wikimapia.Layer.Google);
(function (t) {
    t.initGoogleMaps = function e() {
        Wikimapia.Layer.Google.prototype.types = {
            "google.map": google.maps.MapTypeId.ROADMAP,
            "google.satellite": google.maps.MapTypeId.SATELLITE,
            "google.hybrid": google.maps.MapTypeId.HYBRID,
            "google.terrain": google.maps.MapTypeId.TERRAIN
        };
        Wikimapia.LatLng.toGLatLng = function (t) {
            return new google.maps.LatLng(t.lat, t.lng)
        };
        Wikimapia.Point.toGPoint = function (t) {
            return new google.maps.Point(t.x, t.y)
        };
        Wikimapia.Bounds.toGLatLngBounds = function (t) {
            return new google.maps.LatLngBounds(new google.maps.LatLng(t.bottom, t.left), new google.maps.LatLng(t.top, t.right))
        };
        google.maps.LatLng.toWLatLng = function (t) {
            return new Wikimapia.LatLng(t.lat(), t.lng())
        };
        google.maps.Point.toWPoint = function (t) {
            return new Wikimapia.Point(t.x, t.y)
        };
        Wikimapia.Layer.Google.Overlay = function (t) {
            this.wmMap = t
        };
        Wikimapia.Utils.inherits(Wikimapia.Layer.Google.Overlay, google.maps.OverlayView);
        Wikimapia.Layer.Google.Overlay.prototype.bounds_ = null;
        Wikimapia.Layer.Google.Overlay.prototype.div_ = null;
        Wikimapia.Layer.Google.Overlay.prototype.onAdd = function () {
            var t = this.getPanes()
                .overlayLayer;
            this.div_ = Wikimapia.Utils.Dom.create("div", {
                id: "google-hack-overlay-container",
                styles: {
                    border: "none",
                    position: "absolute"
                }
            });
            t.appendChild(this.div_);
            t.parentNode.style.zIndex = 501;
            var e = t.parentNode.nextSibling;
            if (e && e.style.width === "100%") {
                e.style.display = "none"
            }
        };
        Wikimapia.Layer.Google.Overlay.prototype.draw = Wikimapia.Utils.noop;
        Wikimapia.Layer.Google.Overlay.prototype.correct = function () {
            var t = this.getProjection();
            if (Wikimapia && t && this.div_) {
                var e = this.map.getBounds(),
                    i = new Wikimapia.Point(t.fromLatLngToDivPixel(e.getSouthWest())
                        .x, t.fromLatLngToDivPixel(e.getNorthEast())
                        .y)
                    .offset(this.wmMap.dragObject.position);
                this.bounds_ = e;
                this.setContainerPos(i)
            }
        };
        Wikimapia.Layer.Google.Overlay.prototype.setContainerPos = function (t) {
            this.div_.style.left = Math.round(t.x) + "px";
            this.div_.style.top = Math.round(t.y) + "px"
        };
        Wikimapia.Layer.Google.Overlay.prototype.onRemove = function () {
            this.div_.parentNode.removeChild(this.div_);
            delete this.div_
        };
        Wikimapia.Layer.Google.Overlay.prototype.hide = function () {
            if (this.div_) {
                this.div_.style.visibility = "hidden"
            }
        };
        Wikimapia.Layer.Google.Overlay.prototype.show = function () {
            if (this.div_) {
                this.div_.style.visibility = "visible"
            }
        };
        Wikimapia.Layer.Google.Overlay.prototype.getContainer = function () {
            return this.div_
        };
        Wikimapia.Layer.Google.maxZoomServiceInstance = new google.maps.MaxZoomService;
        google.maps.wmLayerReady = true
    };
    if (typeof google !== "undefined") {
        if (typeof google.load === "function") {
            if (typeof google.__asyncLoader === "function") {
                $(document)
                    .removeEvent("ready", google.__asyncLoader)
            }
            google.__asyncLoader = function () {
                google.load("maps", 3, {});
                google.setOnLoadCallback(t.initGoogleMaps)
            };
            $(document)
                .addEvent("ready", google.__asyncLoader)
        } else if (typeof google.maps !== "undefined") {
            initGoogleMaps()
        }
    }
})(window);
Wikimapia.Map = function (t, e, i) {
    this.options = Wikimapia.Utils.extend({}, this.options, e);
    this.containerDiv = document.getElementById(t);
    this.projection = new Wikimapia.Map.Projection(this);
    this.initOptions(this.options);
    this.initHandlers();
    this.createContainers();
    this.addStatusBar();
    this.addCross();
    this.tileSize = new Wikimapia.Size(Wikimapia.Map.TILE_WIDTH, Wikimapia.Map.TILE_HEIGHT);
    this.size = this.getCurrentSize();
    this.createControls(e.controls);
    this.createLayers(this.parseLayers(i));
    Wikimapia.Utils.Dom.addEvents(window, {
        resize: this.handlers.onWindowResize,
        beforeunload: this.handlers.unload
    });
    this.handlers.onLanguageChange = this.onLanguageChange.bind(this);
    Wikimapia.Lang.addEvent("langChanged", this.handlers.onLanguageChange)
};
Wikimapia.Utils.inherits(Wikimapia.Map, Wikimapia.EventTarget);
Wikimapia.Map.ABS_MAX_ZOOM = 22;
Wikimapia.Map.TILE_WIDTH = 256;
Wikimapia.Map.TILE_HEIGHT = 256;
Wikimapia.Map.prototype.options = {
    size: null,
    zoom: 0,
    center: null,
    controls: ["zoomControl", "pan"],
    lang: "en",
    dragging: true,
    maxZoomLevel: 21,
    minZoomLevel: 3,
    numZoomLevels: 18,
    embedded: false,
    dragStartDelay: 10
};
Wikimapia.Map.prototype.layers = [];
Wikimapia.Map.prototype.controls = [];
Wikimapia.Map.prototype.baseLayer = null, Wikimapia.Map.prototype.markersLayer = null;
Wikimapia.Map.prototype.overlaysLayer = null;
Wikimapia.Map.prototype.vectorLayer = null;
Wikimapia.Map.prototype.layerTypes = Wikimapia.supportedLayers;
Wikimapia.Map.prototype.containerDiv = null;
Wikimapia.Map.prototype.layersContainer = "wikimapia-layers";
Wikimapia.Map.prototype.controlsContainer = "wikimapia-controls";
Wikimapia.Map.prototype.copyrightsContainer = "wikimapia-copyrights";
Wikimapia.Map.prototype.zIndexBase = {
    base: 10,
    layers: 200,
    features: 600,
    controls: 800,
    copyrights: 900,
    app: 1e3
};
Wikimapia.Map.prototype.units = "degrees";
Wikimapia.Map.prototype.maxExtent = Wikimapia.Bounds.fromArray([-180, -Wikimapia.Utils.MaxMercatorLat, 180, Wikimapia.Utils.MaxMercatorLat]);
Wikimapia.Map.prototype.dragging = true;
Wikimapia.Map.prototype.locked = false;
Wikimapia.Map.prototype.handlers = {};
Wikimapia.Map.prototype._mouseHandler = null;
Wikimapia.Map.prototype.mouseAt = new Wikimapia.Point(0, 0);
Wikimapia.Map.prototype.size = null;
Wikimapia.Map.prototype.isDisposed = false;
Wikimapia.Map.prototype._cacheCenterPx = function () {
    this._centerPx = this.fromLatLngToPixel(this.getCenter())
};
Wikimapia.Map.prototype.initOptions = function (t) {
    if (t.bounds) {
        t.center = t.bounds.getCenterLatLng();
        t.zoom = this.getBestZoomForBounds(t.bounds);
        delete t.bounds
    }
    t.zoom = Wikimapia.Utils.Math.normalize(t.zoom, this.options.minZoomLevel, this.options.maxZoomLevel);
    t.center = t.center.wrapDateLine(this.maxExtent);
    this.options = t
};
Wikimapia.Map.prototype.initHandlers = function () {
    this.handlers = {
        updateSize: Wikimapia.Utils._throttle(this.updateSize.bind(this), 10),
        onWindowResize: Wikimapia.Utils._throttle(this.onWindowResize.bind(this), 10),
        unload: this.destroy.bind(this),
        idle: this.idle.bind(this)
    };
    this._mouseHandler = new Wikimapia.Map.Handler.Mouse(this, false);
    if (Wikimapia.Map.Handler.Touch.isTouchDevice()) {
        this._touchHandler = new Wikimapia.Map.Handler.Touch(this, false)
    }
};
Wikimapia.Map.prototype.getMousePositionFromEvent = function (t) {
    var e = this._containerPosition;
    t.client = new Wikimapia.Point(t.clientX - e.x, t.clientY - e.y);
    return t.client
};
Wikimapia.Map.prototype.getMousePosition = function () {
    return this.mouseAt
};
Wikimapia.Map.prototype.getCenterForZoomAndMousePosition = function (t, e, i) {
    var a = this.getSize()
        .scale(.5),
        o = t.subtract(a.w, a.h),
        n = this.projectAtZoom(e, i)
        .subtract(o.x, o.y);
    return this.imProjectAtZoom(n, i)
};
Wikimapia.Map.prototype.getMouseLatLng = function () {
    return this.fromContainerPixelToLatLng(this.mouseAt)
};
Wikimapia.Map.prototype.createLayers = function (t) {
    if (t) {
        this.addBaseLayer(t[0])
    } else {
        this.addBaseLayer()
    }
    this.addOverlaysLayer();
    this.addVectorLayer();
    this.addMarkersLayer();
    if (t && t.length > 1) {
        for (var e = 1, i = t.length; e < i; e++) {
            this.addLayer(t[e])
        }
    }
};
Wikimapia.Map.prototype.parseLayers = function (t) {
    var e = [],
        i, a;
    t = t || "google.satellite";
    if (typeof t === "string") {
        if (!(t in Wikimapia.supportedLayers)) {
            t = this.defaultBaseLayer
        }
        t = [t]
    }
    for (i = 0, a = t.length; i < a; i++) {
        var o = this.parseLayer(t[i]);
        if (o) {
            e.push(o)
        }
    }
    return e
};
Wikimapia.Map.prototype.parseLayer = function (t, e) {
    var i = null,
        a;
    e = e || {};
    if (t in Wikimapia.supportedLayers) {
        e = Wikimapia.Utils.extend({}, Wikimapia.supportedLayers[t].defaultOptions, e, Wikimapia.Utils.objectSubset(this.options, ["zoom", "center", "lang", "categoryIdNum", "selectedCategory"]));
        e.name = t.replace(/\./g, "-");
        a = Wikimapia.supportedLayers[t].layerConstructor;
        try {
            i = new a(e)
        } catch (o) {
            Wikimapia.Console.error("Layer ", t, " is supported, but it suddenly failed to construct.", o, e)
        }
    }
    return i
};
Wikimapia.Map.prototype.createContainers = function () {
    var t = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: this.layersContainer,
        styles: {
            width: "100%",
            height: "100%",
            "z-index": this.zIndexBase.app
        }
    }), this.containerDiv, "bottom");
    this.dragObject = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: "wm-map-dragobject",
        styles: {
            left: "0px",
            top: "0px",
            position: "absolute",
            "z-index": 0
        }
    }), t, "top");
    this.dragObject.position = new Wikimapia.Point(0, 0);
    this._cacheContainerPosition();
    if (this.options.dragging) {
        this.enableDragging()
    }
    var e = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: this.controlsContainer,
        styles: {
            "z-index": this.zIndexBase.controls
        }
    }), this.containerDiv),
        i = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
            id: this.copyrightsContainer,
            styles: {
                "z-index": this.zIndexBase.copyrights
            }
        }), this.containerDiv),
        a = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
            id: "wm-dump",
            styles: {
                "z-index": -9999,
                display: "none"
            }
        }), this.containerDiv, "top")
};
Wikimapia.Map.prototype.getElement = function () {
    return $(this.containerDiv)
};
Wikimapia.Map.prototype.getControlsContainer = function () {
    return document.getElementById(this.controlsContainer)
};
Wikimapia.Map.prototype._cacheContainerPosition = function () {
    this._containerPosition = Wikimapia.Utils.Dom.getPosition(this.containerDiv)
};
Wikimapia.Map.prototype.createControls = function () {
    var t, e, i;
    if (this.options.controls !== null && this.options.controls != "none") {
        if (typeof this.options.controls == "string") {
            this.options.controls = [this.options.controls]
        }
        for (t = 0, e = this.options.controls.length; t < e; t++) {
            if (typeof Wikimapia.Control[this.options.controls[t].capitalize()] == "function") {
                try {
                    this.addControl(new (Wikimapia.Control[this.options.controls[t].capitalize()]))
                } catch (a) {
                    Wikimapia.Console.error(a, this.options.controls[t].capitalize())
                }
            }
        }
    }
};
Wikimapia.Map.prototype.addBaseLayer = function (t, e) {
    if (t) {
        var i = t.getName();
        this.baseLayer = t;
        this.addLayer(t, 0);
        this.fireEvent("attributionSet", i);
        this.fireEvent("baseLayerSet", i)
    } else {
        var a = {
            type: "google.satellite",
            center: this.options.center,
            zoom: this.options.zoom
        };
        this.addLayer(new Wikimapia.Layer.Google(a), 0)
    }
    this._cacheCenterPx()
};
Wikimapia.Map.prototype.addMarkersLayer = function () {
    if (this.markersLayer === null) {
        this.addLayer(new Wikimapia.Layer.Markers({
            center: this.options.center,
            zoom: this.options.zoom
        }))
    }
};
Wikimapia.Map.prototype.addVectorLayer = function () {
    if (this.vectorLayer === null) {
        var t = {
            center: this.options.center,
            zoom: this.options.zoom
        };
        this.addLayer(new Wikimapia.Layer.Vector(t))
    }
};
Wikimapia.Map.prototype.addOverlaysLayer = function () {
    if (this.overlaysLayer === null) {
        this.overlaysLayer = this.addLayer(new Wikimapia.Layer.Overlays({
            center: this.options.center,
            zoom: this.options.zoom
        }))
    }
};
Wikimapia.Map.prototype.addLayer = function (t, e) {
    if (this.isDisposed) return null;
    var i, a = this.layers.length,
        o = this.zIndexBase.layers,
        n = null,
        a = e >= 0 ? e : this.layers.length,
        s = a == this.layers.length;
    if (t instanceof Wikimapia.Layer) {
        if (s && this.overlaysLayer) {
            a--;
            n = this.overlaysLayer
        }
        if (s && this.markersLayer) {
            a--;
            n = this.markersLayer
        }
        if (s && this.vectorLayer) {
            a--;
            n = this.vectorLayer
        }
        this.layers.splice(a, 0, t);
        i = this.layers[a];
        if (!n && this.layers.length > a + 1) {
            n = this.layers[a + 1]
        }
        if (n) {
            Wikimapia.Utils.Dom.inject(i.div, n.div, "before")
        } else {
            Wikimapia.Utils.Dom.inject(i.div, this.dragObject)
        }
        o += a;
        if (i instanceof Wikimapia.Layer.Markers) {
            o = this.zIndexBase.layers + 301;
            this.markersLayer = i
        }
        if (i instanceof Wikimapia.Layer.Vector) {
            o = this.zIndexBase.layers + 300;
            this.vectorLayer = i
        }
        if (i instanceof Wikimapia.Layer.Overlays) {
            o = this.zIndexBase.layers + 302;
            this.overlaysLayer = i
        }
        i.setZIndex(o);
        this.fireEvent("layerPreregister", i);
        i.setMap(this);
        this.fireEvent("layerAdded", i)
    }
    return i
};
Wikimapia.Map.prototype.getLayerByName = function (t) {
    var e = null;
    t = t.replace(/\./g, "-");
    var i = /\*$/.test(t) ? function (e) {
        return e.indexOf(t.replace("*", "")) === 0
    } : function (e) {
        return e === t
    };
    for (var a = 0, o = this.layers.length; a < o; a++) {
        if (i(this.layers[a].options.name)) {
            e = this.layers[a];
            break
        }
    }
    return e
};
Wikimapia.Map.prototype.getLayersByName = function (t) {
    var e = [];
    t = t.replace(/\./g, "-")
        .replace("*", "");
    for (var i = 0, a = this.layers.length; i < a; i++) {
        if (this.layers[i].getName()
            .indexOf(t) === 0) {
            e.push(this.layers[i])
        }
    }
    return e
};
Wikimapia.Map.prototype.removeLayer = function (t) {
    var e = this.layers.indexOf(t);
    if (e >= 0) {
        this.layers.splice(e, 1);
        t.destroy();
        if (t.isBaseLayer) {
            this.baseLayer = this.layers.length > 0 ? this.layers[0] : null
        }
    }
    this.fireEvent("layerRemoved", t);
    return t
};
Wikimapia.Map.prototype.addLayerByName = function (t, e) {
    var i = function () {
        var i = this.addLayer(this.parseLayer(t));
        Wikimapia.Utils.getCallback(e)(i)
    }.bind(this),
        a;
    if (t in Wikimapia.supportedLayers) {
        i()
    } else {
        a = Wikimapia.Utils.resolveLayerPath(t);
        Wikimapia.Net.loadModule(a, i)
    }
};
Wikimapia.Map.prototype.addCross = function () {
    var t = Wikimapia.Utils.Dom.create("img", {
        id: "map-center-cross",
        src: Wikimapia.Utils.defaultImagesUrl + "center-cross.gif"
    });
    Wikimapia.Utils.Dom.inject(t, document.getElementById(this.layersContainer), "before")
};
Wikimapia.Map.prototype.getBounds = function () {
    var t = null;
    if (this.baseLayer) {
        t = this.baseLayer.getBounds()
    }
    return t
};
Wikimapia.Map.prototype.getScreenBounds = function (t) {
    t = t || 0;
    var e;
    if (t === 0) {
        e = this.getBounds()
    } else {
        var i = this.getSize(),
            a = this.fromContainerPixelToLatLng(new Wikimapia.Point(-i.w * t, -i.h * t)),
            o = this.fromContainerPixelToLatLng(new Wikimapia.Point(i.w * (1 + t), i.h * (1 + t)));
        e = new Wikimapia.Bounds({
            top: a.lat,
            right: o.lng,
            bottom: o.lat,
            left: a.lng
        })
    }
    return e
}, Wikimapia.Map.prototype.getMaxExtent = function () {
    return Wikimapia.Bounds.fromArray([-180, -85.05112877980662, 180, 85.05112877980662])
};
Wikimapia.Map.prototype.getSize = function () {
    if (this.size === null) {
        this.size = this.getCurrentSize()
    }
    return this.size.clone()
};
Wikimapia.Map.prototype.getCurrentSize = function (t) {
    var e = Wikimapia.Utils.Dom.getSize(this.containerDiv);
    return new Wikimapia.Size(e.x, e.y)
};
Wikimapia.Map.prototype.onWindowResize = function (t) {
    this.updateSize()
};
Wikimapia.Map.prototype.updateSize = function (t) {
    var e = this.size,
        i;
    t = t || this.getCurrentSize();
    if (!t.equals(e)) {
        this.size = t;
        i = this.fromContainerPixelToLatLng(new Wikimapia.Point(t.w / 2, t.h / 2));
        for (var a = 0, o = this.layers.length; a < o; a++) {
            this.layers[a].updateSize(t)
        }
        this.fireEvent("mapResized", t);
        this.setCenter(i);
        clearTimeout(this.afterResize);
        this.afterResize = setTimeout(this.onResizeComplete.bind(this), 100)
    }
    this._cacheContainerPosition()
};
Wikimapia.Map.prototype.onResizeComplete = function () {
    if (this.size.w < 800) {
        Wikimapia.Utils.Dom.addClass(this.containerDiv, "map-narrow")
    } else {
        Wikimapia.Utils.Dom.removeClass(this.containerDiv, "map-narrow")
    }
    this.fireEvent("resizeComplete", this)
};
Wikimapia.Map.prototype.getZoom = function () {
    return +this.options.zoom
};
Wikimapia.Map.prototype.getCenter = function () {
    return this.options.center.clone()
};
Wikimapia.Map.prototype._setDragObjectPosition = Browser.Features.transform ? function (t) {
    var e = this.dragObject;
    e.position = t;
    e.style[Browser.transformProperty] = "translate3d(" + t.x + "px," + t.y + "px" + ",0)"
} : function (t) {
    var e = this.dragObject;
    e.position = t;
    e.style.top = t.y + "px";
    e.style.left = t.x + "px"
};
Wikimapia.Map.prototype.setCursor = function (t) {
    this.baseLayer.setCursor(t);
    Wikimapia.Utils.Dom.setStyle(document.getElementById(this.layersContainer), "cursor", t)
};
Wikimapia.Map.prototype.setCenter = function (t, e) {
    this.fireEvent("movestart");
    this.options.center = t;
    var i = this.fromLatLngToPixel(t),
        a = this._centerPx.clone()
        .subtract(i.x, i.y),
        o;
    if (Math.abs(a.x) > 5e3 || Math.abs(a.y) > 5e3) {
        o = new Wikimapia.Point(0, 0)
    } else {
        o = this.dragObject.position.add(a.x, a.y)
    }
    this._setDragObjectPosition(o);
    for (var n = 0, s = this.layers.length; n < s; n++) {
        this.layers[n].setCenter(this.options.center)
    }
    this._cacheCenterPx();
    this.fireEvent("moveend")
};
Wikimapia.Map.prototype.getTileSize = function () {
    return this.tileSize.clone()
};
Wikimapia.Map.prototype.enableDragging = function () {
    var t = this.getControlByName("pan");
    this._mouseHandler.enable();
    if (this._touchHandler) {
        this._touchHandler.enable()
    }
    if (t) {
        t.enable()
    }
    this.options.dragging = true;
    this.fireEvent("draggableChanged", this.options.dragging)
};
Wikimapia.Map.prototype.disableDragging = function () {
    var t = this.getControlByName("pan");
    this._mouseHandler.disable();
    if (this._touchHandler) {
        this._touchHandler.disable()
    }
    if (t) {
        t.disable()
    }
    this.options.dragging = false;
    this.fireEvent("draggableChanged", this.options.dragging)
};
Wikimapia.Map.prototype.moveEnd = function (t) { };
Wikimapia.Map.prototype.idle = function () { };
Wikimapia.Map.prototype.moveBy = function (t) {
    var e = t.x,
        i = t.y;
    this._centerPx.x -= e;
    this._centerPx.y -= i;
    this.options.center = this.fromPixelToLatLng(this._centerPx);
    this._setDragObjectPosition(this.dragObject.position.add(e, i));
    for (var a = 0, o = this.layers.length; a < o; a++) {
        this.layers[a].moveBy(t)
    }
};
Wikimapia.Map.prototype.limitBounds = function (t) {
    if (t) {
        this.options.maxBounds = t;
        this._moveBy = this.moveBy;
        this.moveBy = this._moveWithinBounds;
        this._setCenter = this.setCenter;
        this.setCenter = this._setCenterWithinBounds
    } else {
        delete this.options.maxBounds;
        this.moveBy = this._moveBy;
        this.setCenter = this._setCenter
    }
};
Wikimapia.Map.prototype._moveWithinBounds = function (t) {
    var e = t.x,
        i = t.y,
        a = this.limitCenterPx(this._centerPx.subtract(e, i));
    t.x = e = this._centerPx.x - a.x;
    t.y = i = this._centerPx.y - a.y;
    this._centerPx = a;
    this.options.center = this.fromPixelToLatLng(this._centerPx);
    this._setDragObjectPosition(this.dragObject.position.add(e, i));
    for (var o = 0, n = this.layers.length; o < n; o++) {
        this.layers[o].moveBy(t)
    }
};
Wikimapia.Map.prototype._setCenterWithinBounds = function (t) {
    this._setCenter(this.limitCenter(t, this.options.maxBounds, this.options.zoom))
};
Wikimapia.Map.prototype.limitCenter = function (t, e, i) {
    return e ? this.fromPixelToLatLng(this.limitCenterPx(this.fromLatLngToPixel(t))) : t
};
Wikimapia.Map.prototype.limitCenterPx = function (t) {
    var e = this.getSize()
        .scale(.5),
        i = this.fromLatLngToPixel(new Wikimapia.LatLng(this.options.maxBounds.top, this.options.maxBounds.left))
        .add(e.w, e.h),
        a = this.fromLatLngToPixel(new Wikimapia.LatLng(this.options.maxBounds.bottom, this.options.maxBounds.right))
        .subtract(e.w, e.h);
    t.x = t.x < i.x ? i.x : t.x > a.x ? a.x : t.x;
    t.y = t.y < i.y ? i.y : t.y > a.y ? a.y : t.y;
    return t
};
Wikimapia.Map.prototype.addCopyright = function (t, e) {
    Wikimapia.Utils.Dom.inject(t, document.getElementById(this.copyrightsContainer), "top");
    Wikimapia.Utils.Dom.setStyle(t, "zIndex", this.zIndexBase.copyrights + 1);
    this.fireEvent("attributionSet", e.options.name)
};
Wikimapia.Map.prototype.addControl = function (t) {
    this.controls.push(t);
    if (t.options.view) {
        this.getControlsContainer()
            .appendChild(t.getElement(true))
    }
    t.setMap(this);
    return t
};
Wikimapia.Map.prototype.removeControl = function (t) {
    var e = this.controls.indexOf(t);
    if (e !== -1) {
        this.controls.splice(e, 1)
    }
    return t.destroy()
};
Wikimapia.Map.prototype.getControlByName = function (t) {
    var e = null;
    for (var i = 0, a = this.controls.length; i < a; i++) {
        var o = this.controls[i];
        if (o.options.name === t) {
            e = o;
            break
        }
    }
    return e
};
Wikimapia.Map.prototype.zoomIn = function () {
    this.setZoom(this.getZoom() + 1)
};
Wikimapia.Map.prototype.zoomOut = function () {
    this.setZoom(this.getZoom() - 1)
};
Wikimapia.Map.prototype.projectAtZoom = function (t, e) {
    return this.projection.projectAtZoom(t, e)
};
Wikimapia.Map.prototype.imProjectAtZoom = function (t, e) {
    return this.projection.imProjectAtZoom(t, e)
};
Wikimapia.Map.prototype.getBoundsForZoom = function (t) {
    var e = this.getSize()
        .scale(.5),
        i = this.projectAtZoom(this.getCenter(), t),
        a = (new Wikimapia.Bounds)
        .extend(this.imProjectAtZoom(i.subtract(e.w, -e.h), t))
        .extend(this.imProjectAtZoom(i.add(e.w, -e.h), t, this.baseLayer));
    return a
};
Wikimapia.Map.prototype.getBestZoomForBounds = function (t, e) {
    var i, a, o;
    if (this.baseLayer) {
        i = e ? Wikimapia.Map.ABS_MAX_ZOOM : this.baseLayer.options.maxZoomLevel;
        a = this.baseLayer.options.minZoomLevel
    } else {
        i = this.options.maxZoomLevel;
        a = this.options.minZoomLevel
    }
    o = this.getBoundsForZoom(i);
    while (o.getWidth() <= t.getWidth() || o.getHeight() <= t.getHeight() || i < a) {
        i--;
        o = this.getBoundsForZoom(i)
    }
    return i
};
Wikimapia.Map.prototype.redraw = function (t, e) {
    e = this.limitZoom(e || this.options.zoom);
    t = t || this.options.center;
    var i = this.options.zoom !== e,
        a = !this.options.center.equals(t);
    this.options.zoom = e;
    this.options.center = t;
    for (var o = 0, n = this.layers.length; o < n; o++) {
        var s = this.layers[o];
        s.options.center = t;
        if (!i && a) {
            s.setCenter(t)
        }
        i && s.setZoom(e)
    }
    this._cacheCenterPx();
    if (i) {
        this.fireEvent("zoomChanged", this.options.zoom)
    }
    if (a) {
        this.fireEvent("moveend")
    }
    return this
};
Wikimapia.Map.prototype.redrawOverlays = function () {
    for (var t = 0, e = this.layers.length; t < e; t++) {
        var i = this.layers[t];
        if (/wikimapia/.test(i.options.name)) {
            i.redraw()
        }
    }
    return this
};
Wikimapia.Map.prototype.zoomToBounds = function (t) {
    var e = this.fromLatLngToPixel(this.getCenter()),
        i = this.fromLatLngToPixel(t.getCenterLatLng()),
        a = this.getBestZoomForBounds(t),
        o = e.x - i.x && e.y - i.y,
        n = a !== this.getZoom();
    if (n) {
        this.redraw(t.getCenterLatLng(), a)
    } else {
        this.panBy(e.x - i.x, e.y - i.y)
    }
    return this
};
Wikimapia.Map.prototype.setZoom = function (t) {
    t = this.limitZoom(Math.round(t));
    var e, i = +this.options.zoom;
    this.options.zoom = t;
    if (this.options.maxBounds) {
        this.options.center = this.limitCenter(this.options.center, this.options.maxBounds)
    }
    this._setDragObjectPosition(new Wikimapia.Point(0, 0));
    for (var a = 0, o = this.layers.length; a < o; a++) {
        this.layers[a].setZoom(t)
    }
    this._cacheCenterPx();
    this.fireEvent("zoomChanged", this.options.zoom);
    return this
};
Wikimapia.Map.prototype.limitZoom = function (t) {
    return Wikimapia.Utils.Math.normalize(t, this.options.minZoomLevel, this.options.maxZoomLevel)
};
Wikimapia.Map.prototype.onLanguageChange = function () {
    var t = Wikimapia.Lang.getCurrentLanguage();
    this.options.lang = t;
    this.fireEvent("langChanged", t)
};
Wikimapia.Map.prototype.panBy = function (t, e) {
    this.locked = true;
    this.fireEvent("movestart");
    this.moveBy({
        x: t,
        y: e
    });
    this.locked = false;
    this._cacheCenterPx();
    this.fireEvent("moveend");
    return this
};
Wikimapia.Map.prototype.addMarker = function (t) {
    return this.markersLayer.addMarker(t)
};
Wikimapia.Map.prototype.removeMarker = function (t) {
    return this.markersLayer.removeMarker(t)
};
Wikimapia.Map.prototype.addVectorFeature = function (t) {
    return this.vectorLayer.addFeature(t)
};
Wikimapia.Map.prototype.removeVectorFeature = function (t) {
    return this.vectorLayer.removeFeature(t)
}, Wikimapia.Map.prototype.getFeaturesCount = function () {
    return this.markersLayer.getFeaturesCount()
};
Wikimapia.Map.prototype.fromLatLngToPixel = function (t) {
    return this.projection.fromLatLngToPixel(t)
};
Wikimapia.Map.prototype.fromPixelToLatLng = function (t) {
    return this.projection.fromPixelToLatLng(t)
};
Wikimapia.Map.prototype.fromLatLngToContainerPixel = function (t) {
    var e = this.fromLatLngToPixel(t),
        i = this.getSize(),
        a = this.fromLatLngToPixel(this.getCenter());
    e.x -= a.x - i.w * .5;
    e.y -= a.y - i.h * .5;
    return e
};
Wikimapia.Map.prototype.fromContainerPixelToLatLng = function (t) {
    var e = this.getSize(),
        i = this.fromLatLngToPixel(this.getCenter());
    i.x += t.x - e.w * .5;
    i.y += t.y - e.h * .5;
    return this.fromPixelToLatLng(i)
};
Wikimapia.Map.prototype.destroy = function () {
    var t, e, i, a = this.layers,
        o = this.controls,
        n;
    this.disableDragging();
    this._mouseHandler.destroy();
    this._mouseHandler = null;
    if (this._touchHandler) {
        this._touchHandler.destroy();
        this._touchHandler = null
    }
    Wikimapia.Utils.Dom.removeEvents(window, {
        resize: this.handlers.onWindowResize,
        beforeunload: this.handlers.unload
    });
    this.isDisposed = true;
    for (t = 0, e = o.length; t < e; t++) {
        o[t].destroy()
    }
    this.controls = [];
    for (t = 0, e = a.length; t < e; t++) {
        try {
            a[t].destroy()
        } catch (s) {
            Wikimapia.Console.error(s, a[t].getName())
        }
    }
    this.layers = [];
    delete this.markersLayer;
    delete this.vectorLayer;
    delete this.layers;
    [$(this.controlsContainer), $(this.layersContainer), $(this.copyrightsContainer), $(this.containerDiv)].forEach(function (t) {
        if (t) {
            Wikimapia.Utils.Dom.destroy(t)
        }
    });
    (new Wikimapia.Cache)
    .clear();
    this.fireEvent("mapDestroyed")
};
Wikimapia.Map.Projection = function (t) {
    this.map = t;
    this.zoomLevels = 23;
    this.pixelsPerLngDegree = [];
    this.pixelsPerLngRadian = [];
    this.origins = [];
    this.sizes = [];
    this.maxExtent = new Wikimapia.Bounds({
        left: -180,
        bottom: -Wikimapia.Utils.MaxMercatorLat,
        right: 180,
        top: Wikimapia.Utils.MaxMercatorLat
    });
    this.calculate()
};
Wikimapia.Map.Projection.BASE_TILE_SIZE = 256;
Wikimapia.Map.Projection.prototype.calculate = function () {
    var t = 2 * Math.PI;
    for (var e = Wikimapia.Map.Projection.BASE_TILE_SIZE, i = 0; i < this.zoomLevels; i++) {
        var a = e / 2;
        this.pixelsPerLngDegree.push(e / 360);
        this.pixelsPerLngRadian.push(e / t);
        this.origins.push(new Wikimapia.Point(a, a));
        this.sizes.push(new Wikimapia.Size(e, e));
        e *= 2
    }
};
Wikimapia.Map.Projection.prototype.fromLatLngToPixel = function (t) {
    var e = this.map.getZoom(),
        i = this.origins[e],
        a = Math.round(i.x + t.lng * this.pixelsPerLngDegree[e]),
        o = Math.sin(t.lat * (Math.PI / 180)),
        n = Math.round(i.y + .5 * Math.log((1 + o) / (1 - o)) * -this.pixelsPerLngRadian[e]);
    return new Wikimapia.Point(a, n)
};
Wikimapia.Map.Projection.prototype.fromPixelToLatLng = function (t) {
    var e = this.map.getZoom(),
        i = this.origins[e],
        a = (t.x - i.x) / this.pixelsPerLngDegree[e],
        o = (2 * Math.atan(Math.exp((t.y - i.y) / -this.pixelsPerLngRadian[e])) - Math.PI * .5) / (Math.PI / 180);
    return new Wikimapia.LatLng(o, a)
        .wrapDateLine(this.map.maxExtent)
};
Wikimapia.Map.Projection.prototype.projectAtZoom = function (t, e) {
    var i = this.origins[e],
        a = Math.round(i.x + t.lng * this.pixelsPerLngDegree[e]),
        o = Wikimapia.Utils.Math.normalize(Math.sin(Math.degreesToRadians(t.lat)), -.9999, .9999),
        n = Math.round(i.y + .5 * Math.log((1 + o) / (1 - o)) * -this.pixelsPerLngRadian[e]);
    return new Wikimapia.Point(a, n)
};
Wikimapia.Map.Projection.prototype.imProjectAtZoom = function (t, e) {
    var i = this.origins[e],
        a = (t.x - i.x) / this.pixelsPerLngDegree[e],
        o = Math.radiansToDegrees(2 * Math.atan(Math.exp((t.y - i.y) / -this.pixelsPerLngRadian[e])) - Math.PI / 2);
    return new Wikimapia.LatLng(o, a)
};
Wikimapia.Map.Projection.prototype.destroy = function () {
    this.origins = null;
    this.sizes = null;
    this.pixelsPerLngDegree = null;
    this.pixelsPerLngRadian = null
};
Wikimapia.Map.Handler = function (t, e) {
    if (t) {
        this.map = t;
        this.initializeInternal();
        if (e || typeof e === "undefined") {
            this.enable()
        }
    }
};
Wikimapia.Map.Handler.pointerPosition = new Wikimapia.Point(0, 0);
Wikimapia.Map.Handler.prototype = {
    constructor: Wikimapia.Map.Handler,
    map: null,
    enabled: false,
    initializeInternal: function () { },
    _getTarget: function () {
        if (!this._target) {
            this._target = document.getElementById(this.map.layersContainer)
        }
        return this._target
    },
    getMousePositionFromEvent: function (t) {
        var e = this.map._containerPosition,
            i = Wikimapia.Map.Handler.pointerPosition;
        i.x = t.clientX - e.x;
        i.y = t.clientY - e.y;
        t.client = i;
        return t.client
    },
    disable: function () {
        this.enabled = false
    },
    enable: function () {
        this.enabled = true
    },
    destroy: function () {
        this.disable();
        delete this.map
    }
};
Wikimapia.Map.Handler.Mouse = function (t, e) {
    Wikimapia.Map.Handler.prototype.constructor.apply(this, arguments)
};
Wikimapia.Utils.inherits(Wikimapia.Map.Handler.Mouse, Wikimapia.Map.Handler);
Wikimapia.Map.Handler.Mouse.getCenterForZoomAndMousePosition = function (t, e, i, a) {
    var o = t.getSize()
        .scale(.5),
        n = e.subtract(o.w, o.h),
        s = t.projectAtZoom(i, a)
        .subtract(n.x, n.y);
    return t.imProjectAtZoom(s, a)
};
Wikimapia.Map.Handler.Mouse.isRightClick = function (t) {
    return t.which == 3 || t.button == 2
};
Wikimapia.Map.Handler.Mouse.prototype._dragHandler = null;
Wikimapia.Map.Handler.Mouse.prototype._mouseWheelHandler = null;
Wikimapia.Map.Handler.Mouse.prototype.initializeInternal = function () {
    this._delegate = this.delegate.bind(this);
    this._onMouseMove = this.onMouseMove.bind(this);
    this._onDoubleClick = this.onDoubleClick.bind(this);
    this._onClick = this._delegate;
    this._onContextMenu = this._delegate;
    this._onDragStart = this.onDragStart.bind(this);
    this._onDragEnd = this.onDragEnd.bind(this)
};
Wikimapia.Map.Handler.Mouse.prototype.delegate = function (t) {
    var e = t.type,
        i = this.map,
        a = !(Wikimapia.Map.Handler.Mouse.isRightClick(t) || t.type == "contextmenu");
    i.mouseAt = this.getMousePositionFromEvent(t);
    if (i.dragDelay && e === "mouseup") {
        clearTimeout(i.dragDelay);
        delete i.dragDelay
    }
    if (e !== "mousedown" && i.locked) {
        i.omitNextClick = 1
    }
    if (e === "click" && i.omitNextClick || i.lastClickEvent) {
        i.omitNextClick = 0;
        delete i.lastClickEvent;
        t.stop();
        return
    }
    if (e === "contextmenu") {
        t.stop()
    }
    i.fireEvent(e, t);
    if (!a) {
        t.stop()
    }
    return a
};
Wikimapia.Map.Handler.Mouse.prototype.onMouseMove = function (t) {
    var e = this.map;
    e.mouseAt = this.getMousePositionFromEvent(t);
    e.fireEvent("mousemove", t)
};
Wikimapia.Map.Handler.Mouse.prototype.onDoubleClick = function (t) {
    var e = this.map,
        i = e.getZoom() + 1,
        a;
    if (i <= e.options.maxZoomLevel) {
        this.map.mouseAt = new Wikimapia.Point(t.clientX, t.clientY);
        a = Wikimapia.Map.Handler.Mouse.getCenterForZoomAndMousePosition(e, e.getMousePosition(), e.getMouseLatLng(), i);
        e.redraw(a, e.getZoom() + 1)
    }
    this.map.fireEvent(t.type, t)
};
Wikimapia.Map.Handler.Mouse.prototype.enable = function () {
    var t = this.map;
    Wikimapia.Utils.Dom.addEvents(this._getTarget(), {
        mousemove: this._onMouseMove,
        mouseup: this._delegate,
        contextmenu: this._delegate,
        mousedown: this._delegate,
        dblclick: this._onDoubleClick,
        click: this._delegate,
        rightclick: this._delegate
    });
    if (this._dragHandler) {
        this._dragHandler.enable()
    } else {
        this._dragHandler = new Wikimapia.Map.Handler.Drag(t, this)
    }
    if (!t.options.embedded) {
        if (this._mouseWheelHandler) {
            this._mouseWheelHandler.enable()
        } else {
            this._mouseWheelHandler = new Wikimapia.Map.Handler.Mousewheel(t, this)
        }
    }
    this.map.addEvent("dragstart", this._onDragStart);
    this.map.addEvent("dragend", this._onDragEnd)
};
Wikimapia.Map.Handler.Mouse.prototype.onDragStart = function (t) {
    Wikimapia.Utils.Dom.removeEvent(this._getTarget(), "mousemove", this._onMouseMove)
};
Wikimapia.Map.Handler.Mouse.prototype.onDragEnd = function (t) {
    Wikimapia.Utils.Dom.addEvent(this._getTarget(), "mousemove", this._onMouseMove)
};
Wikimapia.Map.Handler.Mouse.prototype.disable = function () {
    var t = this.map;
    Wikimapia.Utils.Dom.removeEvents(this._getTarget(), {
        mousemove: this._onMouseMove,
        mouseup: this._delegate,
        contextmenu: this._delegate,
        mousedown: this._delegate,
        dblclick: this._onDoubleClick,
        click: this._delegate,
        rightclick: this._delegate
    });
    if (this._dragHandler) {
        this._dragHandler.disable()
    }
    if (this._mouseWheelHandler) {
        this._mouseWheelHandler.disable()
    }
};
Wikimapia.Map.Handler.Mouse.prototype.destroy = function () {
    Wikimapia.Map.Handler.prototype.destroy.call(this);
    if (this._dragHandler) {
        this._dragHandler.destroy();
        delete this._dragHandler
    }
    if (this._mouseWheelHandler) {
        this._mouseWheelHandler.destroy();
        delete this._mouseWheelHandler
    }
};
Wikimapia.Map.Handler.Drag = function (t, e) {
    Wikimapia.Map.Handler.prototype.constructor.apply(this, arguments)
};
Wikimapia.Utils.inherits(Wikimapia.Map.Handler.Drag, Wikimapia.Map.Handler);
Wikimapia.Map.Handler.Drag.moveTolerance = 12;
Wikimapia.Map.Handler.Drag.prototype._selectStart = null;
Wikimapia.Map.Handler.Drag.prototype.dragStartDelay;
Wikimapia.Map.Handler.Drag._dragStartPoint = null;
Wikimapia.Map.Handler.Drag.prototype.initializeInternal = function () {
    this._onDragStart = this.onDragStart.bind(this);
    this._onDrag = this.onDrag.bind(this);
    this._onDragEnd = this.onDragEnd.bind(this)
};
Wikimapia.Map.Handler.Drag.prototype.enable = function () {
    Wikimapia.Utils.Dom.addEvent(this._getTarget(), "mousedown", this._onDragStart);
    Wikimapia.Map.Handler.prototype.enable.call(this)
};
Wikimapia.Map.Handler.Drag.prototype.disable = function () {
    Wikimapia.Utils.Dom.removeEvent(this._getTarget(), "mousedown", this._onDragStart);
    Wikimapia.Map.Handler.prototype.disable.call(this)
};
Wikimapia.Map.Handler.Drag.prototype.onDragStart = function (t) {
    clearTimeout(this.dragDelay);
    if (this.enabled && !Wikimapia.Map.Handler.Mouse.isRightClick(t)) {
        var e = document;
        if (!this._selectStart) {
            this._selectStart = e.onselectstart ? e.onselectstart : Wikimapia.Utils.False;
            e.onselectstart = Wikimapia.Utils.False
        }
        this.dragStartPoint = this.map.mouseAt.clone();
        this.dragStart = this.dragStartPoint.clone();
        this._dragMoved = false;
        Wikimapia.Utils.Dom.addEvent(e, "mouseup", this._onDragEnd);
        Wikimapia.Utils.Dom.addEvent(e, "mousemove", this._onDrag)
    }
};
Wikimapia.Map.Handler.Drag.prototype.onDrag = function (t) {
    t.stop();
    var e = this.getMousePositionFromEvent(t),
        i = this.map;
    if (!this._dragMoved) {
        if (this.dragStartPoint.equals(e)) return;
        this._dragMoved = true;
        this._dragStartPoint = i.mouseAt.clone();
        this.map.setCursor("move");
        i.locked = true;
        i.fireEvent("movestart");
        i.fireEvent("dragstart")
    }
    i.mouseAt = e;
    var a = this._dragStartPoint,
        o = i.mouseAt.subtract(a.x, a.y);
    this._dragStartPoint = a.add(o.x, o.y);
    if (o.x || o.y) {
        i.fireEvent("drag", t);
        i.moveBy(o)
    }
};
Wikimapia.Map.Handler.Drag.prototype.onDragEnd = function (t) {
    var e = document,
        i = this.map,
        a = Math.abs,
        o = a(i.mouseAt.x - this.dragStart.x),
        n = a(i.mouseAt.y - this.dragStart.y),
        s = Wikimapia.Map.Handler.Drag.moveTolerance;
    t.stopPropagation();
    Wikimapia.Utils.Dom.removeEvents(e, {
        mousemove: this._onDrag,
        mouseup: this._onDragEnd
    });
    e.onselectstart = this._selectStart;
    this._selectStart = null;
    i.moveEnd(t);
    i.setCursor("default");
    if ((o || n) && o < s && n < s) {
        i.locked = false;
        i.omitNextClick = 0;
        t.type = "click";
        i.lastClickEvent = t;
        i.fireEvent("click", t)
    } else {
        setTimeout(function () {
            this.locked = false;
            this.omitNextClick = 0
        }.bind(i), 100)
    }
    i._cacheCenterPx();
    if (n || o) {
        i.fireEvent("dragend", t);
        i.fireEvent("moveend", t)
    }
    delete this._dragStartPoint;
    return false
};
Wikimapia.Map.Handler.Mousewheel = function (t, e) {
    Wikimapia.Map.Handler.prototype.constructor.apply(this, arguments)
};
Wikimapia.Utils.inherits(Wikimapia.Map.Handler.Mousewheel, Wikimapia.Map.Handler);
Wikimapia.Map.Handler.Mousewheel.EVENT_NAME = Browser.firefox ? "DOMMouseScroll" : "mousewheel";
Wikimapia.Map.Handler.Mousewheel.prototype.delta = 0;
Wikimapia.Map.Handler.Mousewheel.prototype.wheelTimeout = null;
Wikimapia.Map.Handler.Mousewheel.prototype.initializeInternal = function () {
    this.onMouseWheel = this.onMousewheel.bind(this)
};
Wikimapia.Map.Handler.Mousewheel.prototype.fixWheelEvent = function (t) {
    var e = t.originalEvent;
    if (!e.wheelDelta) {
        t.clientX = t.originalEvent.clientX;
        t.clientY = t.originalEvent.clientY;
        t.type = "mousewheel"
    }
    t.wheel = e.wheelDelta ? e.wheelDelta / 120 : -(e.detail || 0) / 3;
    return t
};
Wikimapia.Map.Handler.Mousewheel.prototype.onMousewheel = function (t) {
    t = this.fixWheelEvent(t);
    var e = t.wheel,
        i = this.map;
    i.mouseAt = this.getMousePositionFromEvent(t);
    i.zooming = true;
    this.delta += e;
    clearTimeout(this.performTimer);
    this.performTimer = setTimeout(this.perform.bind(this), 50);
    t.stop();
    return false
};
Wikimapia.Map.Handler.Mousewheel.prototype.perform = function () {
    var t = Math.round(this.delta),
        e = this.map,
        i = e.getZoom();
    t = Wikimapia.Utils.Math.normalize(i + Wikimapia.Utils.Math.normalize(t, -2, 2), e.options.minZoomLevel, e.options.maxZoomLevel) - i;
    this.delta = 0;
    if (t) {
        var a = i + t,
            o = Wikimapia.Map.Handler.Mouse.getCenterForZoomAndMousePosition(e, e.getMousePosition(), e.getMouseLatLng(), a);
        e.redraw(o, a);
        clearTimeout(this.wheelTimeout);
        this.wheelTimeout = setTimeout(function () {
            this.map.zooming = false
        }.bind(this), 500)
    }
};
Wikimapia.Map.Handler.Mousewheel.prototype.enable = function () {
    Wikimapia.Utils.Dom.addEvent(this._getTarget(), Wikimapia.Map.Handler.Mousewheel.EVENT_NAME, this.onMouseWheel);
    Wikimapia.Map.Handler.prototype.enable.call(this)
};
Wikimapia.Map.Handler.Mousewheel.prototype.disable = function () {
    Wikimapia.Utils.Dom.removeEvent(this._getTarget(), Wikimapia.Map.Handler.Mousewheel.EVENT_NAME, this.onMouseWheel);
    Wikimapia.Map.Handler.prototype.enable.call(this)
};
Wikimapia.Map.Handler.Touch = function (t, e) {
    Wikimapia.Map.Handler.prototype.constructor.apply(this, arguments);
    this.maxTapTime = 250;
    this.maxTapDistance = 30;
    this.maxDoubleTapDelay = 350;
    this.locations = {};
    this.taps = [];
    this.wasPinching = false;
    this.lastPinchCenter = null;
    this.startDistance = null
};
Wikimapia.Utils.inherits(Wikimapia.Map.Handler.Touch, Wikimapia.Map.Handler);
Wikimapia.Map.Handler.Touch.isTouchDevice = function () {
    return Wikimapia.Utils.isTouch
};
Wikimapia.Map.Handler.Touch.isSameTouch = function (t, e) {
    return t && t.touch && e.identifier == t.touch.identifier
};
Wikimapia.Map.Handler.Touch.prototype.initializeInternal = function () {
    if (Wikimapia.Map.Handler.Touch.isTouchDevice()) {
        this._onTouchStart = this.onTouchStart.bind(this);
        this._onTouchMove = this.onTouchMove.bind(this);
        this._onTouchEnd = this.onTouchEnd.bind(this);
        this.options = {
            snapToZoom: true
        }
    }
};
Wikimapia.Map.Handler.Touch.prototype.enable = function () {
    Wikimapia.Utils.Dom.addEvents(this._getTarget(), {
        touchstart: this._onTouchStart,
        touchmove: this._onTouchMove,
        touchend: this._onTouchEnd
    });
    Wikimapia.Map.Handler.prototype.enable.call(this)
};
Wikimapia.Map.Handler.Touch.prototype.disable = function () {
    Wikimapia.Utils.Dom.removeEvents(this._getTarget(), {
        touchstart: this._onTouchStart,
        touchmove: this._onTouchMove,
        touchend: this._onTouchEnd
    });
    Wikimapia.Map.Handler.prototype.disable.call(this)
};
Wikimapia.Map.Handler.Touch.prototype.updateTouches = function (t) {
    for (var e = 0, i = t.touches.length; e < i; e++) {
        var a = t.touches[e];
        if (a.identifier in this.locations) {
            var o = this.locations[a.identifier];
            o.x = a.screenX;
            o.y = a.screenY;
            o.scale = t.scale
        } else {
            this.locations[a.identifier] = {
                scale: t.scale,
                startPos: {
                    x: a.screenX,
                    y: a.screenY
                },
                x: a.screenX,
                y: a.screenY,
                time: (new Date)
                    .getTime()
            }
        }
    }
};
Wikimapia.Map.Handler.Touch.prototype.onTouchStart = function (t) {
    t.stop();
    t = t.originalEvent;
    this.fixEventScale(t);
    this.updateTouches(t);
    this.initGesture(t)
};
Wikimapia.Map.Handler.Touch.prototype.initGesture = function (t) {
    if (t.touches.length === 2) {
        this.startDistance = Math.pointsDistance(t.touches[0].screenX, t.touches[0].screenY, t.touches[1].screenX, t.touches[1].screenY)
    } else {
        this.startDistance = null
    }
};
Wikimapia.Map.Handler.Touch.prototype.onTouchMove = function (t) {
    t.stop();
    t = t.originalEvent;
    this.fixEventScale(t);
    switch (t.touches.length) {
        case 1:
            this.onPanning(t);
            break;
        case 2:
            this.onPinching(t);
            break;
        default:
            break
    }
    this.updateTouches(t)
};
Wikimapia.Map.Handler.Touch.prototype.onTouchEnd = function (t) {
    var e = (new Date)
        .getTime(),
        i, a, o = t;
    t = t.originalEvent;
    if (t.touches.length === 0 && this.wasPinching) {
        this.onPinchEnd(this.lastPinchCenter)
    }
    if (this.wasPanning) {
        this.onPanEnd(t)
    }
    for (i = 0, a = t.changedTouches.length; i < a; i++) {
        var n = t.changedTouches[i],
            s = this.locations[n.identifier];
        if (!s || s.wasPinch) {
            continue
        }
        var r = {
            x: n.screenX,
            y: n.screenY
        },
            p = e - s.time,
            l = Math.pointsDistance(r.x, r.y, s.startPos.x, s.startPos.y);
        if (l > this.maxTapDistance) { } else if (p > this.maxTapTime) {
            r.end = e;
            r.duration = p;
            this.onHold(r)
        } else {
            r.time = e;
            this.onTap(r, t)
        }
    }
    this.checkLostTouches(t);
    o.stop()
};
Wikimapia.Map.Handler.Touch.prototype.checkLostTouches = function (t) {
    var e = {};
    for (i = 0, len = t.touches.length; i < len; i++) {
        e[t.touches[i].identifier] = true
    }
    for (var a in this.locations) {
        if (!(a in e)) {
            delete this.locations[a]
        }
    }
};
Wikimapia.Map.Handler.Touch.prototype.onHold = function (t) { };
Wikimapia.Map.Handler.Touch.prototype.onTap = function (t, e) {
    if (this.taps.length && t.time - this.taps[0].time < this.maxDoubleTapDelay) {
        this.onDoubleTap(t);
        this.taps = []
    } else {
        this.taps = [t];
        e.clientX = t.x;
        e.clientY = t.y;
        this.map.mouseAt = this.getMousePositionFromEvent(e);
        this.map.fireEvent("tap", e)
    }
};
Wikimapia.Map.Handler.Touch.prototype.onDoubleTap = function (t, e) {
    e.clientX = t.x;
    e.clientY = t.y;
    this.map.mouseAt = this.getMousePositionFromEvent(e);
    this.map.redraw(this.map.fromContainerPixelToLatLng(this.map.mouseAt), this.map.getZoom() + 1)
};
Wikimapia.Map.Handler.Touch.prototype.onPanning = function (t) {
    var e = t.touches[0],
        i = this.locations[e.identifier];
    if (!this.wasPanning) {
        this.wasPanning = true;
        this.map.fireEvent("movestart", t);
        this.map.fireEvent("dragstart", t)
    } else {
        this.map.fireEvent("drag", t)
    }
    this.map.moveBy(new Wikimapia.Point(e.screenX - i.x, e.screenY - i.y))
};
Wikimapia.Map.Handler.Touch.prototype.onPanEnd = function (t) {
    this.map.fireEvent("dragend", t);
    this.map.fireEvent("moveend", t);
    this.wasPanning = false
};
Wikimapia.Map.Handler.Touch.prototype.fixEventScale = function (t) {
    if (t.scale === undefined) {
        if (this.startDistance && t.touches.length === 2) {
            var e = t.touches[0],
                i = t.touches[1],
                a = Math.pointsDistance(e.screenX, e.screenY, i.screenX, i.screenY);
            t.scale = a / this.startDistance
        } else {
            t.scale = 1
        }
    }
};
Wikimapia.Map.Handler.Touch.prototype.onPinching = function (t) {
    var e = t.touches[0],
        i = t.touches[1],
        a = new Wikimapia.Point(e.screenX, e.screenY),
        o = new Wikimapia.Point(i.screenX, i.screenY),
        n = this.locations[e.identifier],
        s = this.locations[i.identifier],
        r = this.map.getZoom(),
        p, l, c;
    n.wasPinch = true;
    s.wasPinch = true;
    p = new Wikimapia.Point(a.x + (o.x - a.x) * .5, a.y + (o.y - a.y) * .5);
    c = Math.round(r + Math.log(t.scale) / Math.LN2);
    if (c !== r) {
        var h = Wikimapia.Map.Handler.Mouse.getCenterForZoomAndMousePosition(this.map, p, this.map.fromContainerPixelToLatLng(p), c);
        this.map.redraw(h, c)
    }
    this.wasPinching = true;
    this.lastPinchCenter = p
};
Wikimapia.Map.Handler.Touch.prototype.onPinchEnd = function (t) {
    this.wasPinching = false
};
(function (t, e) {
    Wikimapia.Net.Asset.image(Wikimapia.Utils.defaultImagesUrl + "sprite.png")
})();
Wikimapia.App = function (t) {
    this.initOptions(t);
    this.createContainers();
    this.createMap()
};
Wikimapia.Utils.inherits(Wikimapia.App, Wikimapia.EventTarget);
Wikimapia.App.prototype.options = {
    lang: "en",
    center: null,
    zoom: 0,
    layers: ["google.satellite", "wikimapia.imagetiles.hybrid", "wikimapia.interactive.basic"],
    controls: ["pan", "zoomControl", "mapSwitcher", "coords", "objectCount", "access"],
    statusRequestPeriod: 120 * 1e3
};
Wikimapia.App.prototype.containers = {
    app: "wikimapia",
    map: "map"
};
Wikimapia.App.prototype.handlers = {};
Wikimapia.App.prototype.defaultBaseLayer = "google.satellite";
Wikimapia.App.prototype.map = null;
Wikimapia.App.prototype._search = null;
Wikimapia.App.prototype._windowManager = null;
Wikimapia.App.prototype.onMapCreated = function (t) {
    var e = this;
    this.map = t;
    this.addHistoryObserver();
    this.map.initEditorBlocks();
    this.router = this.map.router = new Wikimapia.Router(this.map, this);
    Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("section", {
        id: "alertify-logs-container",
        "class": "alertify-logs"
    }), document.getElementById(t.copyrightsContainer));
    this.addTopPanel();
    if (!this.options.iframe) {
        this.socket = this.map.socket = new Wikimapia.Socket(window.socketParams.host, window.socketParams.port, this);
        this.map.addStatusBar();
        this.map.addNotification();
        this.addShortcuts();
        if (this.options.user) {
            this.applyUserStartupSettings(this.options.user, window.stats);
            delete this.options.user
        } else {
            this.requestStatus()
        }
        this.statusRequestTimer = setInterval(this.requestStatus.bind(this), this.options.statusRequestPeriod)
    }
    Wikimapia.Utils.extend(window.compat, {
        getMap: function () {
            return t
        },
        getApp: function () {
            return e
        }
    });
    this.initHandlers();
    this.map.addEvents({
        responseError: this.processResponseError.bind(this),
        userError: this.showErrorDialog.bind(this),
        accessError: this.showAccessDenied.bind(this)
    });
    this.addObjectHandlers();
    this.onStartUp()
};
Wikimapia.App.prototype.initOptions = function (t) {
    t.lang = t.lang || "en";
    if (t.localization) {
        Wikimapia.Lang.defineLocalization(t.localization);
        delete t.localization
    }
    Wikimapia.Lang.setLanguage(t.lang, t.iframe);
    this.setTitle();
    if (t.o) {
        delete t.o;
        t.view = "o"
    }
    if (typeof t.show !== "string" || t.show == "") {
        delete t.show
    }
    t.iframe = Wikimapia.Utils.isEmbedded();
    if (t.iframe) {
        t.controls = ["zoom", "access"];
        delete t.view;
        delete t.show;
        delete t.stgr;
        delete t.gz;
        Wikimapia.Utils.Logger.log("app_init_main")
    } else {
        Wikimapia.Utils.Logger.log("app_init_embedded")
    }
    if (t.tag && (parseInt(t.tag) < 0 || t.view)) {
        delete t.tag
    }
    t.layers = Wikimapia.Control.MapSwitcher.getLayerSet(t.base, t.view, t.tag);
    if (t.stgr) {
        var e = t.stgr.toString(),
            i;
        if (e.length > 1) {
            t.bounds = Wikimapia.Utils.quadKeyToBounds(e)
        }
    }
    if (t.gz) {
        t.route = (new Wikimapia.Parser.Itiles)
            .decodePolygonUncompressed(t.gz);
        t.bounds = t.route.getBounds();
        delete t.gz
    }
    Wikimapia.Utils.extend(this.options, t)
};
Wikimapia.App.prototype.onStartUp = function () {
    if (this.options.action) {
        this.handleStartUpHook(this.options.action);
        delete this.options.action;
        delete this.options.show
    }
    if (this.options.route) {
        this.map.launchDistanceMeasurer(this.options.route);
        delete this.options.route
    }
    if (!this.options.iframe) {
        if (this.options.show) {
            var t = this.options.show;
            setTimeout(function () {
                this.router.route(t)
            }.bind(this), 500);
            delete this.options.show
        }
        if (this.options.stgr) {
            this.map.addStatusGrid(this.options.stgr);
            delete this.options.stgr
        }
        setTimeout(this.map.addPolygonEditor.bind(this.map), 300)
    }
};
Wikimapia.App.prototype.showNewYearContest = function () {
    Wikimapia.Utils.Logger.log("ny_contest");
    Wikimapia.Net.Cookie.write("ny_notified", "yes", {
        duration: 1
    });
    this.map.createWindow({
        url: "/user/ny/",
        iframe: true,
        size: new Wikimapia.Size(900, this.map.getSize()
            .h)
    })
};
Wikimapia.App.prototype.handleStartUpHook = function (t) {
    switch (t) {
        case "addplace":
            Wikimapia.Utils.Logger.setEntryPoint("place_page");
            this.helpPanel("/object/start/", function () {
                var t = document.getElementById("help-add-place-button");
                if (t) {
                    Wikimapia.Utils.Dom.addEvent(t, "click", function () {
                        var t = this.map.getPanel("left");
                        if (t) {
                            t.hideAndClose()
                        }
                        this.map.addPlace("start_help")
                    }.bind(this))
                }
            }.bind(this));
            break;
        default:
            break
    }
};
Wikimapia.App.prototype.createContainers = function () {
    var t = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: this.containers.app
    }), document.body, "top"),
        e = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
            id: this.containers.map
        }), t, "top")
};
Wikimapia.App.prototype.createMap = function () {
    var t = [];
    for (var e = 0, i = this.options.layers.length; e < i; e++) {
        var a = this.options.layers[e];
        if (!(a in Wikimapia.supportedLayers)) {
            t.push(Wikimapia.Utils.resolveLayerPath(a))
        }
    }
    if (t.length === 0) {
        this.createMapInternal()
    } else {
        Wikimapia.Net.loadModules(t, this.createMapInternal.bind(this))
    }
};
Wikimapia.App.prototype.createMapInternal = function () {
    var t = this,
        e = this.options,
        i = {
            center: e.center,
            bounds: e.bounds,
            zoom: e.zoom,
            lang: e.lang,
            scrollWheelZoom: e.scrollWheelZoom || true,
            app: this,
            getApp: function () {
                return t
            },
            view: this.options.view,
            base: this.options.base,
            iframe: e.iframe,
            embedded: Wikimapia.Utils.isEmbedded(),
            poly: e.poly || 0,
            road: e.road || 0
        };
    if (this.options.controls) {
        i.controls = this.options.controls
    }
    if (e.iframe) {
        Wikimapia.Utils.Dom.addClass(document.getElementById(this.containers.map), "embedded")
    }
    this.map = new Wikimapia.Map(this.containers.map, i, this.options.layers);
    if (this.options.tag) {
        this.map.filterCategory({
            id: this.options.tag
        })
    }
    switch (parseInt(this.options.view)) {
        case 4:
            this.map.showDeletedPlaces();
            break;
        case 8:
            this.map.showOldPlaces();
            break;
        default:
            break
    } ["center", "zoom", "lang", "scrollWheelZoom", "poly", "controls", "tag", "bounds", "lat", "lon", "z", "layers", "view", "base"].forEach(function (t) {
        delete e[t]
    });
    this.onMapCreated(this.map);
    this.options = e
};
Wikimapia.App.prototype.initHandlers = function () {
    var t = this,
        e = this.map;
    Wikimapia.Utils.bindHandlers(this, "setLanguage", "processCommand", "destroy");
    Wikimapia.Utils.Dom.addEvent(window, "commandReceived", this.handlers.processCommand);
    Wikimapia.Lang.addEvent("langChange", this.handlers.langChange);
    Wikimapia.Utils.Dom.removeEvent(window, "beforeunload");
    window.onbeforeunload = this.handlers.destroy
};
Wikimapia.App.prototype.processCommand = function (t, e, i) {
    i = i || this.parseJsResponse(e, true);
    var a = this.map.getControlByName("Object");
    if (i) {
        if (i.url) {
            if (i.sidePanel) {
                this.openPanel(i.url)
            } else {
                this.router.route(i.url)
            }
            return
        }
        if (i.updateMap) {
            if (i.center && i.zoom) {
                this.map.redraw(i.center, i.zoom)
            } else {
                i.center && this.map.setCenter(i.center);
                i.zoom && this.map.setZoom(i.zoom)
            }
            return
        }
        if (i.menuData && a && a.objectWindow && a.objectWindow.options.url) {
            obj = a.currentObject;
            Wikimapia.Object.applyInternalData(obj, i.menuData, this.map.placeAvaliableLngs);
            delete this.map.placeAvaliableLngs;
            a.objectWindow.addMenu(a.getMenuForObject(obj, obj.type))
        }
    }
};
Wikimapia.App.prototype.getMap = function () {
    return this["map"]
};
Wikimapia.App.prototype.performShow = function (t) {
    this.router.route(t)
};
Wikimapia.App.prototype.openPanel = function (t, e) {
    var i = this.map.getWindow(),
        a = this.map;
    if (i) {
        if (/polygon/.test(t)) {
            i.hide()
        } else {
            this.map.closeWindow()
        }
    }
    if (t[0] !== "/") {
        t = "/" + t
    }
    if (/watchlist/.test(t)) {
        this.openWatchlist(t)
    } else {
        this.map.createPanel({
            url: t,
            position: e || "right",
            iframe: false,
            onClose: function () {
                var t = a.getWindow();
                if (t) {
                    t.show()
                }
                if (a.tempPolygon) {
                    a.removeVectorFeature(a.tempPolygon);
                    delete a.tempPolygon
                }
            }
        })
    }
};
Wikimapia.App.prototype.openWatchlist = function (t) {
    if (this.watchlist) {
        t = t || "/user/tools/watchlist/";
        this.map.updateShowHash(t, true);
        this.map.createPanel({
            url: t,
            position: "right",
            iframe: false,
            onClose: function () {
                this.map.updateShowHash("", true)
            }.bind(this)
        })
    } else {
        this.initWatchlist(function () {
            this.openWatchlist(t)
        }.bind(this))
    }
};
Wikimapia.App.prototype.openMapShift = function (t) {
    var e = function () {
        var e = this.map.getControlByName("mapshift");
        if (!e) {
            e = this.map.addControl(new Wikimapia.Control.Mapshift)
        }
        e.load(t);
        this.map.updateShowHash(t, true);
        this.map.closeWindow()
    }.bind(this);
    if (!window.MapShift) {
        Wikimapia.Net.loadModule(Wikimapia.Utils.defaultControlsDir + "Mapshift.js", e)
    } else {
        e()
    }
};
Wikimapia.App.prototype.openLinearRevision = function (t, e) {
    if (this.watchlist) {
        try {
            this.watchlist.showLinearRevision(t, e)
        } catch (i) {
            Wikimapia.Console.error(i)
        }
    } else {
        this.initWatchlist(function () {
            this.openLinearRevision(t, e)
        }.bind(this))
    }
};
Wikimapia.App.prototype.initWatchlist = function (t) {
    if (this.watchListLoading) {
        return
    }
    this.watchListLoading = true;
    t = typeof t == "function" ? t : Wikimapia.Utils.noop;
    var e = function () {
        delete this.watchListLoading;
        if (!this.watchlist) {
            this.watchlist = new Wikimapia.Interface.Watchlist({
                map: this.map
            });
            this.map.addControl(new Wikimapia.Control.WatchlistEditor);
            this.addEvent("editorLaunched", this.watchlist.flush.bind(this.watchlist))
        }
        t()
    }.bind(this);
    if (Wikimapia.Interface.Watchlist && !this.watchlist) {
        e()
    } else {
        Wikimapia.Net.loadModules([Wikimapia.Utils.defaultInterfacesDir + "Watchlist.js", Wikimapia.Utils.defaultControlsDir + "RectangleEditor.js", Wikimapia.Utils.defaultControlsDir + "WatchlistEditor.js"], e)
    }
};
Wikimapia.App.prototype.addWatchlist = function () {
    if (this.watchlist) {
        var t = this.map.getControlByName("WatchlistEditor");
        t.addEventOnce("created", function () {
            this.openWatchlist("/user/tools/watchlist/")
        }.bind(this));
        t.create()
    }
};
Wikimapia.App.prototype.editWatchlist = function (t) {
    if (this.watchlist) {
        var e = this.map.getControlByName("WatchlistEditor");
        e.addEventOnce("edited", function () {
            this.openWatchlist("/user/tools/watchlist/")
        }.bind(this));
        e.edit(t)
    }
};
Wikimapia.App.prototype.addObjectHandlers = function () {
    if (top !== self) {
        this.map.addEvent("show", function (t) {
            Wikimapia.Utils.Logger.log("get_out_of_frame");
            this.getOutOfFrame(t.getUrl())
        }.bind(this))
    } else {
        this.map.addControl(new Wikimapia.Control.Object);
        this.map.addControl(new Wikimapia.Control.Category)
    }
};
Wikimapia.App.prototype.getOutOfFrame = function (t) {
    t = t ? "&show=" + t : "";
    top.location = self.location.href.replace("index_wjsl.php", "") + t
};
Wikimapia.App.prototype.processResponseError = function (t, e) {
    if (typeof e !== "undefined") {
        var i = function (t) {
            this.removeEvent("close", this.closeAlertHandler);
            this.close();
            if (e) {
                e(t)
            }
            return t
        }
    }
    switch (parseInt(t.code)) {
        case 403:
            if (t.action && t.action.access_denied) {
                this.showAccessDenied(t.action.access_denied, t.action.backurl)
            } else {
                this.showErrorDialog(t.message, i)
            }
            break;
        case 503:
            this.maintenance();
            break;
        default:
            if (t.alert) {
                Wikimapia.Interface.Dialog.alert(t.alert, i)
            } else {
                this.showErrorDialog(t.message, i)
            }
            break
    }
};
Wikimapia.App.prototype.maintenance = function () {
    this.router.route("/maintenance/")
}, Wikimapia.App.prototype.addHistoryObserver = function () {
    var t = this.urlObserver = new Wikimapia.Control.URLHash({
        map: this.map
    });
    t.listen({
        moveend: this.map,
        zoomChanged: this.map,
        langChanged: Wikimapia.Lang,
        contentChanged: this.map,
        search: this.map,
        tagFiltered: this.map,
        baseLayerChanged: this.map
    });
    t.addEvents({
        centerChanged: this.map.setCenter.bind(this.map),
        zoomChanged: this.map.setZoom.bind(this.map),
        langChanged: Wikimapia.Lang.setLanguage.bind(Wikimapia.Lang),
        contentChanged: function () {
            this.router.route.apply(this.router, arguments)
        }.bind(this),
        tagChanged: this.map.filterCategory.bind(this.map)
    })
};
Wikimapia.App.prototype.addTopPanel = function () {
    this.topPanel = new Wikimapia.App.TopPanel(document.getElementById(this.containers.app), this, this.map, this.options.iframe, this.options.search)
};
Wikimapia.App.prototype.setLanguage = function (t) {
    if (t !== "" && /[a-z]{2}/.test(t) && t !== Wikimapia.Lang.getCurrentLanguage()) {
        Wikimapia.Lang.setLanguage(t);
        this.setTitle()
    }
};
Wikimapia.App.prototype.setTitle = function (t, e) {
    var i = t || Wikimapia.Lang.get("all.motto");
    if (e) {
        i = "(" + e + ") " + i
    }
    document.title = i
};
Wikimapia.App.prototype.addShortcuts = function () {
    if ("geolocation" in navigator) {
        this._geolocation = new Wikimapia.Control.Geolocation(this.map)
    }
    this._addPlace = new Wikimapia.Control.Object.AddButton(this.map);
    this._distanceMeasureButton = new Wikimapia.Control.DistanceMeasurerButton(this.map)
};
Wikimapia.App.prototype.validateAjaxResponse = function (t, e) {
    var i = true,
        a = t.match(/(<\!\-\- \[(infowin|infoalert)\]([\w \,\.\-\'\(\)\u00A1-\uFFFF]+)\-\->)|(\/user\/denied\?type\=\d)/i);
    if (a) {
        var o = function (t) {
            this.removeEvent("close", this.closeAlertHandler);
            this.close();
            if (e) {
                e(t)
            }
            return t
        };
        if (a[0].contains("denied")) {
            this.router.route(a[0])
        }
        if (a.indexOf("infowin") !== -1) {
            this.showErrorDialog(a, o)
        }
        i = false
    }
    return i
};
Wikimapia.App.prototype.showErrorDialog = function (t, e) {
    var i = this.map.getPanel("left");
    t = t || "";
    i && i.hide();
    var a = typeof t === "string" ? t : t[t.indexOf("infowin") + 1],
        o = ['<div><fieldset class="confirm-dialog inner-page">', '<p class="lead error">', a, '</p><p class="buttons">', '<input type="button" id="ok-button" class="btn" value="Ok" />'];
    if (typeof e === "function") {
        o.push('<input type="button" class="btn" id="cancel-button" value="' + Wikimapia.Lang.get("all.cancelbut") + '" />')
    }
    o.push("</p></fieldset><div>");
    e = e || Wikimapia.Utils.noop;
    var n, s = Wikimapia.Utils.executeOnce(function (t) {
        try {
            e.call(n, t)
        } catch (i) {
            console.error(i)
        } finally {
            n.close()
        }
    }),
        r = function () {
            s(true)
        },
        p = function () {
            s(false)
        };
    n = this.map.createWindow({
        iframe: false,
        name: "alert",
        size: new Wikimapia.Size(400, 300),
        history: false,
        content: o.join(""),
        onLoad: function () {
            var t = Wikimapia.Utils.Dom.getElements(this.container, "input");
            if (t.length) {
                if (typeof e === "function") {
                    Wikimapia.Utils.Dom.addEvent(t[0], "click", r);
                    if (t.length > 1) {
                        Wikimapia.Utils.Dom.addEvent(t[1], "click", p)
                    }
                } else {
                    Wikimapia.Utils.Dom.addEvent(t[0], "click", this.close.bind(this))
                }
            }
        }
    }, true);
    n.addEvent("close", p)
};
Wikimapia.App.prototype.showAccessDenied = function (t, e) {
    var i = this.map.getPanel("left"),
        a, o, n, s = true;
    if (t) {
        switch (t.state) {
            case Wikimapia.Control.Access.states.BANNED:
                a = "&bantype=" + t.banType;
                break;
            case Wikimapia.Control.Access.states.TIMEOUT:
                a = "&timeout=" + t.timeout;
                break;
            case Wikimapia.Control.Access.states.PENDING_ACTIVATION:
                break;
            case Wikimapia.Control.Access.states.LOW_EXP:
                break;
            default:
                s = false;
                break
        }
    } else {
        t = {
            state: Wikimapia.Control.Access.states.DENIED
        }
    }
    o = "/user/denied?type=" + parseInt(t.state) + e;
    if (e) {
        o = Wikimapia.Utils.Url.append(o, "backurl", e)
    }
    setTimeout(function () {
        if (i) {
            if (s) {
                this.map.createPanel({
                    position: "left",
                    url: o,
                    iframe: true
                })
            } else {
                i.hide(function () {
                    this.map.createWindow({
                        position: "left",
                        url: o,
                        iframe: true,
                        size: new Wikimapia.Size(550, 400)
                    })
                }.bind(this))
            }
        } else {
            this.map.createWindow({
                position: "left",
                url: o,
                iframe: true,
                size: new Wikimapia.Size(550, 400)
            })
        }
    }.bind(this), 800)
};
Wikimapia.App.prototype.helpPanel = function (t, e) {
    this.map.createPanel({
        iframe: false,
        url: t,
        position: "left",
        onLoad: Wikimapia.Utils.getCallback(e)
    })
};
Wikimapia.App.prototype.trackAnalytics = function (t) {
    if (window.pageTracker && t) {
        window.pageTracker._trackPageview(t)
    }
};
Wikimapia.App.prototype.parseJsResponse = function (t, e) {
    return window.compat.parseJSResponse(t, e)
};
Wikimapia.App.prototype.versionChanged = function (t) {
    if (Wikimapia.Utils.isEmbedded()) {
        window.location.reload()
    } else {
        if (t % 10 === 0 && !this.map.editingInProgress()) {
            this.map.createWindow({
                url: "/user/update/",
                size: new Wikimapia.Size(470, 380),
                iframe: false,
                onLoad: this.onVersionChangedScreenLoaded.bind(this)
            })
        }
    }
};
Wikimapia.App.prototype.onVersionChangedScreenLoaded = function () {
    var t = Browser.chrome || Browser.firefox ? "ffgc" : Browser.opera || Browser.safari ? "safari-opera" : "ie";
    Wikimapia.Utils.Dom.addClass(document.getElementById("reload-shortcuts"), Browser.Platform.mac ? "mac" : "pc");
    Wikimapia.Utils.Dom.setStyle(document.getElementById("sc-" + t), "display", "inline")
};
Wikimapia.App.prototype.destroy = function () {
    if (this.map.editingInProgress()) {
        return Wikimapia.Lang.get("all.edit-unfinished-exit")
    }
    var t = this,
        e = Wikimapia.Control.URLHash.getHash();
    Wikimapia.Utils.Dom.removeEvent(window, "beforeunload", this.handlers.unload);
    this.urlObserver.removeEvents();
    ["_search", "_windowManager", "topPanel", "urlObserver"].forEach(function (e) {
        if (t[e]) {
            t[e].destroy();
            delete t[e]
        }
    });
    if (this.statusRequest) {
        this.statusRequest.cancel();
        delete this.statusRequest
    }
    this.map.closeWindow();
    this.map.closePanel();
    try {
        this.map.destroy()
    } catch (i) { }
    delete this.map;
    window.location.hash = e;
    clearTimeout(this.statusRequestTimer);
    clearTimeout(window.commandFlow);
    delete window.compat.getMap;
    delete window.compat.getApp;
    Wikimapia.Cache.Pool.clear();
    (new Wikimapia.Cache)
    .clear();
    Wikimapia.Utils.Logger.logTotalXYTilesBandwidth()
};
Wikimapia.objectStates = {
    EXISTS: -2,
    CHILD_OBJECT_EXISTS: 9,
    LINEAR_EXISTS: 18,
    CHILD_OBJECT_CANT_UNBIND: 0,
    IN_UNDELETION_QUEUE: 1,
    DELETED: 2,
    IN_DELETION_QUEUE: 3,
    PARENT_EXISTS: 8,
    EXISTS_FROM_MAP: -1
};
Wikimapia.objectProtectionStatuses = {
    PROTECTED: -1,
    NON_PROTECTED: 1
};
Wikimapia.objectTypes = {
    prefixes: ["", "", "street", "road", "railroad", "ferry", "river"]
};
Wikimapia.Map.prototype.addPolygonEditor = function (t) {
    var e = this.vectorLayer.polygonEditor;
    t = Wikimapia.Utils.getCallback(t);
    if (e) {
        t(this.vectorLayer.polygonEditor)
    } else {
        if (this._polygonEditorIsLoading) return;
        this.addEvent("polygonEditorLoaded", t);
        this.showPreloader();
        var i = Wikimapia.Utils.defaultControlsDir,
            a = [i + "Polygon.js"];
        if (Wikimapia.Utils.debug) {
            a.unshift(i + "Polygon/Utils.js", i + "Polygon/Mode.js", i + "Polygon/Move.js", i + "Polygon/Bounds.js", i + "Polygon/Create.js", i + "Polygon/Edit.js", i + "Polygon/Rotate.js", i + "Polygon/Scale.js", i + "Polygon/Orthogonalize.js", i + "Polygon/Circularize.js")
        }
        this._polygonEditorIsLoading = true;
        Wikimapia.Utils.Logger.log("polygon_editor_load_start");
        Wikimapia.Net.loadModules(a, function () {
            this.hidePreloader();
            delete this._polygonEditorIsLoading;
            Wikimapia.Utils.Logger.log("polygon_editor_load_success");
            this.vectorLayer.polygonEditor = new Wikimapia.Control.Polygon({
                maxPoints: this.access.getUserPolygonPointsLimit()
            });
            this.addControl(this.vectorLayer.polygonEditor);
            this.vectorLayer.polygonEditor.addEvents({
                start: this.onPolygonEditStart
            });
            this.fireEvent("polygonEditorLoaded", this.vectorLayer.polygonEditor)
        }.bind(this))
    }
};
Wikimapia.Map.prototype.onPolygonEditStart = function () {
    this.map.fireEvent("editorLaunched");
    if (!this.map.access.userIsAuthorized()) {
        this.addFirstPointHint()
    }
};
Wikimapia.Map.prototype.addPlace = function (t, e) {
    var i = false;
    e = Wikimapia.Utils.getCallback(e);
    t = t || "other";
    this.fireEvent("create");
    Wikimapia.Utils.Logger.logPlaceAction("add_place_attempt", t);
    this.disableInteractiveLayer();
    this.addPolygonEditor(function () {
        if (this.getWindow()) {
            this.closeWindow()
        }
        var t = function () {
            this.access.accessCheck("place_add", function () {
                var t = this.getLayerByName("wikimapia.interactive.*"),
                    a = this.vectorLayer.polygonEditor;
                t.setEditStatus(true);
                a.create({
                    finalizeAfterTwoPoints: i
                });
                this.disableInteractiveLayer();
                Wikimapia.Utils.Logger.logPlaceAction("polygon_create_init");
                e(true)
            }.bind(this), function () {
                Wikimapia.Utils.Logger.logPlaceAction("add_place_denied_access");
                this.enableInteractiveLayer();
                e(false)
            }.bind(this))
        }.bind(this),
            a = function () {
                Wikimapia.Utils.Logger.logPlaceAction("add_place_denied_in_progress");
                this.enableInteractiveLayer();
                e(false)
            }.bind(this);
        if (!this.editingInProgress()) {
            t()
        } else {
            var o = this.getLayerByName("wikimapia.linear.*");
            if (o) {
                o.onCancel(function (e) {
                    if (e) {
                        t()
                    } else {
                        a()
                    }
                })
            } else {
                a()
            }
        }
    }.bind(this))
};
Wikimapia.Map.prototype.addMultiplePolygonsEditor = function (t) {
    if (this.access.userIsAdvanced()) {
        var e = this.getControlByName("Polygons");
        t = Wikimapia.Utils.getCallback(t);
        if (e) {
            t(e)
        } else {
            Wikimapia.Net.loadModule(Wikimapia.Utils.defaultControlsDir + "Polygons.js", function () {
                e = new Wikimapia.Control.Polygons;
                this.addControl(e);
                t(e)
            }.bind(this))
        }
    }
};
Wikimapia.Map.prototype.openCategory = function (t, e, i, a, o, n) {
    var s = "/object/category/?type=" + (t || "view") + "&id=" + i + "&lng=" + (a || "en") + "&tab=" + (e || "main");
    if (o) s += "&rev=" + o;
    if (n) s += "&rev2=" + n;
    this.createWindow({
        url: s,
        iframe: true
    })
};
Wikimapia.Map.prototype.showStats = function () {
    var t = new Date;
    this.createWindow({
        url: "/stats/action_stats/?fstat={fstat}&period={period}&year={year}&month={month}".substitute({
            fstat: window.stats_fstat || 101,
            month: window.stats_month || t.getMonth() + 1,
            year: window.stats_year || t.getFullYear(),
            period: window.stats_period || 1
        }),
        iframe: true,
        size: new Wikimapia.Size(1090, 475),
        onClose: function () {
            Wikimapia.Utils.extend(window, {
                stats_fstat: 0,
                stats_period: 0,
                stats_year: 0,
                stats_month: 0
            })
        }
    })
};
Wikimapia.Map.prototype.launchDistanceMeasurer = function (t, e) {
    e = Wikimapia.Utils.getCallback(e);
    var i = function () {
        var i = this.getControlByName("distanceMeasurer");
        if (i) {
            i = i.launch(t)
        }
        e()
    }.bind(this);
    if (typeof Wikimapia.Control.DistanceMeasurer === "undefined") {
        this.editingIsLoading = true;
        Wikimapia.Net.loadModule(Wikimapia.Utils.defaultControlsDir + "DistanceMeasurer.js", function () {
            this.editingIsLoading = false;
            this.addControl(new Wikimapia.Control.DistanceMeasurer);
            i(t)
        }.bind(this), undefined, undefined, function () {
            this.editingIsLoading = false
        }.bind(this))
    } else {
        i(t)
    }
};
Wikimapia.Map.prototype.launchMapEmbed = function () {
    var t = function () {
        var t = this.getControlByName("MapEmbed");
        if (!t) {
            t = this.addControl(new Wikimapia.Control.MapEmbed);
            t.create();
            t.addEvent("stop", function () {
                this.removeControl(t)
            }.bind(this))
        }
    }.bind(this);
    if (typeof Wikimapia.Control.MapEmbed === "function") {
        t()
    } else {
        Wikimapia.Net.loadModules([Wikimapia.Utils.defaultControlsDir + "RectangleEditor.js", Wikimapia.Utils.defaultControlsDir + "MapEmbed.js"], t)
    }
};
Wikimapia.Map.prototype._contextMenu = null;
Wikimapia.Map.prototype.contextMenu = function (t, e, i, a, o) {
    if (this.options.embedded) {
        return
    }
    o = typeof o == "undefined" ? true : o;
    if (o && this._contextMenu) {
        this._destroyContextMenu()
    }
    this._contextMenu = new Wikimapia.Interface.ContextMenu(t, e);
    this._contextMenu.addEvent("beforeDestroy", this._onContextMenuDestroyed.bind(this));
    this._contextMenu.div.setAttribute("id", i || Wikimapia.Utils.uniqueId("context-menu"));
    Wikimapia.Utils.Dom.setStyle(this._contextMenu.div, "z-index", 800);
    Wikimapia.Utils.Dom.inject(this._contextMenu.div, this.getControlsContainer());
    this._contextMenu.onRendered(a.clone(), this.getSize());
    this.handlers._destroyContextMenu = this._destroyContextMenu.bind(this);
    this.addEventOnce("movestart", this.handlers._destroyContextMenu);
    this.addEventOnce("featureDragStart", this.handlers._destroyContextMenu);
    return this._contextMenu
};
Wikimapia.Map.prototype._destroyContextMenu = function () {
    if (this._contextMenu) {
        this._contextMenu.destroy()
    }
};
Wikimapia.Map.prototype._onContextMenuDestroyed = function () {
    this.removeEvent("movestart", this.handlers._destroyContextMenu);
    this.removeEvent("featureDragStart", this.handlers._destroyContextMenu);
    this._contextMenu = null
};
Wikimapia.Map.prototype.statusbar = null;
Wikimapia.Map.prototype.addStatusBar = function () {
    if (!this.statusbar) {
        var t = new Wikimapia.Interface.Statusbar({
            map: this
        });
        this.statusbar = t
    }
    return this.statusbar
};
Wikimapia.Map.prototype._preloader = null;
Wikimapia.Map.prototype.showPreloader = function (t, e) {
    if (!this._preloader) {
        this._preloader = new Wikimapia.Interface;
        Wikimapia.Utils.Dom.inject(this._preloader.div, this.getControlsContainer());
        Wikimapia.Utils.Dom.setStyle(this._preloader.div, "z-index", 800)
    }
    this._preloader.setLoading(e || this.getPreloaderPosition(), t)
};
Wikimapia.Map.prototype.getPreloaderPosition = function () {
    return Wikimapia.Bounds.fromSize(this.getSize())
};
Wikimapia.Map.prototype.hidePreloader = function () {
    this._preloader && this._preloader.flush()
};
Wikimapia.Map.prototype._notification = null;
Wikimapia.Map.prototype.addNotification = function () {
    this._notification = new Wikimapia.Interface.Notification({
        map: this
    })
};
Wikimapia.Map.prototype.tooltipHideDelay = 2e3;
Wikimapia.Map.prototype.addTooltip = function (t) {
    if (t) {
        return Wikimapia.Utils.Dom.inject(t, this.getControlsContainer(), "top")
    } else {
        return document.getElementById("wm-tooltip") || Wikimapia.Utils.Dom.inject(this.createTooltip("wm-tooltip"), this.getControlsContainer(), "top")
    }
};
Wikimapia.Map.prototype.createTooltip = function (t, e, i, a, o) {
    return Wikimapia.Utils.Dom.create("span", {
        "class": e || "map-tooltip",
        id: t || Wikimapia.Utils.uniqueId("tooltip"),
        html: a || "",
        styles: {
            "z-index": i || 570
        },
        events: o ? undefined : {
            mouseleave: function () {
                this.hide()
            },
            mouseenter: function () {
                if (this.tooltipTimeout) clearTimeout(this.tooltipTimeout)
            }
        }
    })
};
Wikimapia.Map.prototype.setTooltipAutoHide = function (t, e, i) {
    e = e || this.tooltipHideDelay;
    clearTimeout(t.tooltipTimeout);
    t.tooltipTimeout = setTimeout(function () {
        if (t.innerHTML === i) {
            t.innerHTML = "";
            t.hide()
        }
    }, e)
};
Wikimapia.Map.prototype.getTooltipPosition = function (t, e, i) {
    var a = 15,
        o = t.add(a, a),
        n = this.getSize();
    if (o.x + e > n.w) {
        o.x -= a * 2 + e
    }
    if (o.y + i > n.h) {
        o.y -= a + i
    }
    return new Wikimapia.Point(Math.max(o.x, 0), o.y)
};
Wikimapia.Map.prototype.windowObject = null;
Wikimapia.Map.prototype.createWindow = function (t, e, i) {
    e = typeof e === "undefined" ? true : e;
    i = typeof i === "undefined" ? true : i;
    var a = t,
        o = this,
        n = o.getLayerByName("wikimapia.interactive.*"),
        s = o.getLayerByName("wikimapia.linear.*"),
        r = false;
    a.map = this;
    var p = function () {
        var t = o.getWindow()
    };
    if (this.windowObject && i) {
        this.windowObject.open(a);
        this.fireEvent("contentChanged", t.url);
        setTimeout(p, 1e3)
    } else {
        var l = this.getCurrentSize(),
            c = this.getPanel();
        if (c && (l.w < 800 || t.size && l.w < t.size.w + 400)) {
            r = true
        }
        this.windowObject = new Wikimapia.Interface.Window(a);
        this.windowObject.addEvents({
            close: this.onWindowClosed.bind(this),
            load: this.onWindowLoad.bind(this)
        });
        setTimeout(p, 1e3);
        if (!t.content) {
            this.fireEvent("contentChanged", t.url)
        }
    }
    if (e) {
        o.disableDragging();
        if (n) {
            n.disable();
            n.block()
        }
        if (s) {
            s.disable();
            s.block()
        }
        this.fireEvent("windowOpened")
    }
    if (r) {
        var h = [];
        if (c.left) {
            h.push(c.left)
        }
        if (c.right) {
            h.push(c.right)
        }
        Wikimapia.Utils.processQueue(h, function (t, e) {
            t.hide(e)
        }, function () {
            if (this.windowObject) {
                this.windowObject.setSize();
                this.windowObject.setContainerSize();
                this.windowObject.show()
            }
        }.bind(this))
    }
    return this.windowObject
};
Wikimapia.Map.prototype.onWindowClosed = function () {
    this.enableDragging();
    var t = this.getLayerByName("wikimapia.interactive.*"),
        e = this.getLayerByName("wikimapia.linear.*"),
        i = this.vectorLayer.polygonEditor;
    if (t && !this.editingInProgress()) {
        t.unblock();
        t.enable()
    }
    if (e) {
        e.unblock();
        e.enable()
    }
    this.locked = false;
    this.fireEvent("windowClosed");
    this.fireEvent("contentChanged", null);
    delete this.windowObject
};
Wikimapia.Map.prototype.onWindowLoad = function () {
    var t = this.windowObject;
    if (t.options.iframe && t.container.src.indexOf(Wikimapia.Utils.getLocationOrigin()) === 0) {
        var e = t.getContext(),
            i = e.location;
        i = i.pathname + i.search;
        if (i && t.options.url && t.options.url !== i) {
            var a = this.router.checkObjectPageRedirect(t.options.url, i);
            t.options.url = i;
            this.fireEvent("contentChanged", i)
        }
    }
};
Wikimapia.Map.prototype.getWindow = function () {
    var t = null;
    if (this.windowObject) {
        t = this.windowObject
    }
    return t
};
Wikimapia.Map.prototype.closeWindow = function () {
    var t = this.getWindow();
    if (t) {
        t.close()
    }
    delete this.windowObject
};
Wikimapia.Map.prototype.panel = null;
Wikimapia.Map.prototype.createPanel = function (t) {
    var e = this;
    t.map = e;
    if (!t.position) {
        t.position = "right"
    }
    if (this.panel && this.panel[t.position]) {
        this.panel[t.position].open(t)
    } else {
        var i = this.getCurrentSize(),
            a = this.panel,
            o = t.position;
        if (a) {
            var n = t.size ? t.size.w : Wikimapia.Interface.Panel.prototype.options.size.w;
            if (i.w - n < 700 || i.w < n + 400) {
                var s = t.position === "left" ? "right" : "left";
                if (a[s] && a[s].isDisplayed) {
                    t.initiallyClosed = true;
                    a[s].hide(function () {
                        this.panel[t.position].show()
                    }.bind(this))
                }
            }
        } else {
            this.panel = {}
        }
        this.panel[o] = new Wikimapia.Interface.Panel(t);
        this.panel[o].addEvent("close", function () {
            this.fireEvent("panelClosed");
            delete this.panel[o];
            if (!("left" in this.panel) && !("right" in this.panel)) {
                Wikimapia.Utils.Dom.setStyle(this.div, "width", "100%")
            }
            if (!("top" in this.panel) && !("bottom" in this.panel)) {
                Wikimapia.Utils.Dom.setStyle(this.div, "height", "100%")
            }
        }.bind(this))
    }
    this.fireEvent("panelOpened");
    return this.panel[t.position]
};
Wikimapia.Map.prototype.getPanel = function (t) {
    if (this.panel && (this.panel.right || this.panel.left)) {
        if (t) {
            return this.panel[t] || null
        } else return this.panel
    } else {
        return null
    }
};
Wikimapia.Map.prototype.closePanel = function (t) {
    var e = this.getPanel(t);
    if (e) {
        if (t) {
            e.close();
            delete this.panel[t]
        } else {
            for (var t in this.panel) {
                this.panel[t].close();
                delete this.panel[t]
            }
        }
    }
    if (!this.panel) {
        delete this.panel
    }
};
Wikimapia.Map.prototype.updateShowHash = function (t, e, i) {
    if (e) this.panelUrl = t;
    this.fireEvent("contentChanged", [t, i])
};
Wikimapia.Map.prototype.filterCategory = function (t, e, i, a) {
    if (this.editingInProgress()) {
        return
    }
    i = typeof i === "undefined" ? true : i;
    var o = this.getLayerByName("wikimapia.interactive.*"),
        n = this.getLayerByName("wikimapia.linear.*"),
        s = new Wikimapia.Cache,
        r = isNaN(t) ? t.id.toString() : t.toString(),
        p = Wikimapia.Utils.arrayPick([t.name, s.retrieve("categoriesCache", r.toString()), t.name]),
        l = {
            categoryIdNum: r,
            categoryName: p
        },
        c = "wikimapia.interactive.categories";
    if (a) {
        l.strictBounds = a
    }
    if (e) {
        c += "." + e
    }
    if (parseInt(r) === 50) {
        this.showHotelsSearch()
    } else {
        this.closeHotelsSearch()
    }
    if (o) {
        if (e !== "deleted" && /categories$/.test(o.options.name)) {
            o.filterCategory(r, p);
            return
        } else {
            if (i) {
                this.removeLayer(o)
            }
            o = null
        }
    } else {
        if (n) {
            (new Wikimapia.Cache)
            .store("interactiveSettings", {
                type: c,
                options: l
            });
            this.removeLayer(n);
            return
        }
    }
    if (!o) {
        o = this.parseLayer(c, l);
        this.addLayer(o);
        o.addEvent("layerDestroyed", this.onCategoryFilterOff.bind(this))
    }
};
Wikimapia.Map.prototype.showHotelsSearch = function () {
    var t = this.getCenter(),
        e = encodeURIComponent("lat: " + t.lat + " long: " + t.lng);
    return this.createPanel({
        url: "/booking_search/?aid=320572&tmpl=searchbox&width=300&bgcolor=ffffff&ss=" + e,
        iframe: true
    })
};
Wikimapia.Map.prototype.closeHotelsSearch = function () {
    var t = this.getPanel("right");
    if (t && /booking\.com/.test(t.options.url)) {
        this.closePanel()
    }
};
Wikimapia.Map.prototype.showDeletedPlaces = function () {
    this.options.view = 4;
    this.filterCategory({
        id: "-1",
        name: Wikimapia.Lang.get("all.del-pl")
    }, "deleted");
    this.fireEvent("tagFiltered")
};
Wikimapia.Map.prototype.showOldPlaces = function () {
    this.options.view = 8;
    this.filterCategory({
        id: "46520",
        name: Wikimapia.Lang.get("all.old-places")
    }, "rectangles", false);
    this.fireEvent("tagFiltered")
}, Wikimapia.Map.prototype.onCategoryFilterOff = function () {
    this.options.view = 0;
    var t = this.getLayerByName("wikimapia.interactive.*");
    if (!t) {
        t = this.parseLayer("wikimapia.interactive.basic");
        this.addLayer(t)
    }
    this.closeHotelsSearch();
    this.fireEvent("tagFiltered")
};
Wikimapia.Map.prototype.addStatusGrid = function (t) {
    var e = function () {
        this.closeWindow();
        this.cancelEditors(function () {
            if (!this.getLayerByName("wikimapia.statusgrid")) {
                this.addLayer(this.parseLayer("wikimapia.statusgrid", {
                    currentTile: t
                }))
            }
        }.bind(this))
    }.bind(this);
    if (!("wikimapia.statusgrid" in Wikimapia.supportedLayers)) {
        Wikimapia.Net.loadModules(Wikimapia.Utils.defaultScriptsDir + "Tile/JSON.js", Wikimapia.Utils.defaultScriptsDir + "Tile/StatusGrid.js", Wikimapia.Utils.defaultLayersDir + "StatusGrid.js", e)
    } else {
        e()
    }
};
Wikimapia.Map.prototype.editLinear = function (t) {
    this.fireEvent("editLinear", t);
    var e = this,
        i = this.options.getApp(),
        a = "wikimapia.linear." + t,
        o = function (e) {
            if (e !== false) {
                this.editLinear(t)
            }
        }.bind(this);
    if (this.editingInProgress()) {
        var n = e.getLayerByName("wikimapia.linear.*");
        if (this.getLayerByName(a)) { } else if (this.vectorLayer.polygonEditor && this.vectorLayer.polygonEditor.isInProgress()) {
            this.getLayerByName("wikimapia.interactive.*")
                .cancelPolygonEdit(undefined, o)
        } else if (n) {
            n.onCancel(function (t, e) {
                if (e) {
                    this.editLinear(t)
                }
            }.bind(this, t))
        }
        return
    }
    var s = function () {
        var t = e.getLayerByName("wikimapia.interactive.*"),
            i;
        if (t) {
            e.removeLayer(t)
        }
        i = e.addLayer(e.parseLayer(a));
        i.addEvent("layerDestroyed", e.onLinearEditingStop.bind(e));
        e.fireEvent("editorLaunched", i);
        e.hidePreloader()
    },
        r = function () {
            if (!(a in Wikimapia.supportedLayers)) {
                var t = [];
                Wikimapia.Net.loadCss(Wikimapia.Utils.defaultStylesheetsDir + "roads.css");
                if (typeof Wikimapia.Layer.Linear === "undefined") {
                    t.push(Wikimapia.Utils.defaultLayersDir + "Linear.js");
                    if (Browser.firefox) {
                        t.push(Wikimapia.Utils.defaultLayersDir + "Linear.ff.js")
                    }
                }
                t.push([Wikimapia.Utils.defaultLayersDir, "Linear/", a.split(/[-.]/)
                    .pop()
                    .capitalize(), ".js"
                ].join(""), Wikimapia.Utils.defaultInterfacesDir + "LinearOptions.js");
                e.showPreloader();
                Wikimapia.Net.loadModules(t, s)
            } else {
                s()
            }
        }.bind(this);
    this.access.accessCheck("road_edit", r);
    return false
};
Wikimapia.Map.prototype.onLinearEditingStop = function () {
    var t = this.getLayerByName("wikimapia.interactive.*");
    if (t) {
        t.unblock();
        t.enable()
    } else {
        var e = new Wikimapia.Cache,
            i = e.retrieve("interactiveSettings") || {},
            a = this.parseLayer(i.type || "wikimapia.interactive.basic", i.options || {});
        e.clear("interactiveSettings");
        this.addLayer(a)
    }
};
Wikimapia.Map.prototype.disableInteractiveLayer = function () {
    var t = this.getLayerByName("wikimapia.interactive.*");
    if (t) {
        t.disable();
        t.hideHighlightedPolygon(true)
    }
};
Wikimapia.Map.prototype.enableInteractiveLayer = function () {
    var t = this.getLayerByName("wikimapia.interactive.*");
    if (t) {
        t.enable()
    }
};
Wikimapia.Map.prototype.activeEditorsCount = 0;
Wikimapia.Map.prototype.activeEditors = [];
Wikimapia.Map.prototype.initEditorBlocks = function () {
    Wikimapia.Utils.bindHandlers(this, "onEditorStarted", "onEditorStopped");
    this.addEvents({
        editorStart: this.handlers.onEditorStarted,
        editorStopped: this.handlers.onEditorStopped
    });
    this.activeEditors = []
};
Wikimapia.Map.prototype.onEditorStarted = function (t) {
    if (this.activeEditors.indexOf(t) === -1) {
        this.activeEditorsCount++;
        this.activeEditors.push(t)
    }
};
Wikimapia.Map.prototype.onEditorStopped = function (t) {
    var e = this.activeEditors.indexOf(t);
    if (e !== -1) {
        this.activeEditors.splice(e, 1);
        this.activeEditorsCount = Math.max(0, this.activeEditorsCount - 1)
    }
};
Wikimapia.Map.prototype.cancelEditors = function (t) {
    var e, i, a, o = this.vectorLayer.polygonEditor;
    this.closeWindow();
    t = Wikimapia.Utils.getCallback(t);
    if (o && o.isInProgress()) {
        e = this.getLayerByName("wikimapia.interactive.*");
        return e.cancelPolygonEdit(undefined, t)
    } else {
        i = this.getLayerByName("wikimapia.linear.*");
        if (i) {
            return i.onCancel(t)
        }
    }
    if (this.editingInProgress()) {
        t(false);
        return false
    } else {
        t(true);
        return true
    }
};
Wikimapia.Map.prototype.editingInProgress = function (t) {
    if (t) {
        return this.vectorLayer.polygonEditor && this.vectorLayer.polygonEditor.isInProgress()
    } else {
        return !!this.activeEditorsCount
    }
};
Wikimapia.App.TopPanel = function (t, e, i, a, o) {
    this.map = i;
    this.app = e;
    this.render(t, a);
    this.progressbar = new Wikimapia.App.TopPanel.Progressbar(this.element, e, i);
    if (!a) {
        var n = Wikimapia.Utils.Dom.getElement(this.element, ".container");
        this.menu = new Wikimapia.App.TopPanel.Menu(this.app, this.map, n);
        Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.setStyle(this.menu.div, "left", Wikimapia.App.TopPanel.MENU_POS), n);
        this.search = new Wikimapia.App.TopPanel.Search(this.app, this.map, n, o);
        if (i.getSize()
            .w > 1e3) {
            this.facebookButton = new Wikimapia.App.TopPanel.FacebookButton(window.facebookParams.appId, n)
        }
    }
};
Wikimapia.App.TopPanel.MENU_POS = 178;
Wikimapia.App.TopPanel.prototype = {
    map: null,
    element: null,
    search: null,
    menu: null,
    progressbar: null,
    render: function (t, e) {
        this.element = Wikimapia.Utils.Dom.create("div", {
            id: "wikimapia-top-panel",
            "class": "navbar navbar-fixed-top",
            html: '<div class="navbar-inner"><div class="container"></div></div>'
        });
        Wikimapia.Utils.Dom.inject(this.element, t);
        var i = this.map,
            a = Wikimapia.Utils.Dom.getElement(this.element, ".container"),
            o = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("a", {
                href: "/",
                id: "wikimapia-main-logo",
                html: '<div id="wikimapia-logo-icon"></div><div id="wikimapia-logo-text"></div>'
            }), a);
        if (e) {
            Wikimapia.Utils.Dom.addClass(this.element, "embedded");
            o.setAttribute("target", "_parent");
            Wikimapia.Utils.Dom.addEvent(o, "click", this.onEmbeddedLogoClick.bind(this))
        }
    },
    onEmbeddedLogoClick: function (t) {
        t.stop();
        this.app.getOutOfFrame()
    },
    toElement: function () {
        return this.element
    },
    destroy: function () {
        ["menu", "search", "facebookButton", "vkontakteButton"].forEach(function (t) {
            if (this[t]) {
                this[t].destroy();
                delete this[t]
            }
        }.bind(this));
        Wikimapia.Utils.Dom.destroy(this.element);
        delete this.element;
        delete this.map;
        delete this.app
    }
};
Wikimapia.App.TopPanel.Search = function (t, e, i, a) {
    this.app = t;
    this.container = i;
    Wikimapia.Control.prototype.constructor.call(this, {
        element: document.getElementById("search-form")
    });
    this.setMap(e);
    this.monitor = new Wikimapia.App.TopPanel.Search.Monitor(this);
    if (a) {
        a = decodeURIComponent(a);
        setTimeout(function () {
            this.search(a);
            this.fireEvent("searchStart")
        }.bind(this), 100)
    }
};
Wikimapia.Utils.inherits(Wikimapia.App.TopPanel.Search, Wikimapia.Control);
Wikimapia.App.TopPanel.Search.prototype.app = null;
Wikimapia.App.TopPanel.Search.prototype.query = null;
Wikimapia.App.TopPanel.Search.prototype.locationMarker = null;
Wikimapia.App.TopPanel.Search.prototype.monitor = null;
Wikimapia.App.TopPanel.Search.prototype.categories = null;
Wikimapia.App.TopPanel.Search.prototype.setMap = function (t) {
    Wikimapia.Control.prototype.setMap.call(this, t);
    Wikimapia.Utils.bindHandlers(this, "onSearchExternal", "onSearchResultSelect", "onSearchResultHighlight", "onSearchResultBlur", "onSearchChangeMode", "onSearchPagination");
    this.map.addEvents({
        search_external: this.handlers.onSearchExternal,
        search_change_mode: this.handlers.onSearchChangeMode,
        search_pagination: this.handlers.onSearchPagination,
        search_result_select: this.handlers.onSearchResultSelect,
        search_result_highlight: this.handlers.onSearchResultHighlight,
        search_result_blur: this.handlers.onSearchResultBlur
    })
};
Wikimapia.App.TopPanel.Search.prototype.render = function () {
    var t = this.div,
        e = function () {
            this.focus()
        },
        i = Wikimapia.Utils.Dom.getElement(t, "#search-input"),
        a = Wikimapia.Utils.Dom.getElement(t, "#search-submit"),
        o = Wikimapia.Lang.get("all.search") || "Search";
    this.input = i;
    this.categories = new Wikimapia.App.TopPanel.Search.Categories(this);
    Wikimapia.Utils.bindHandlers(this, "onSubmit", "onKeyUp");
    i.setAttribute("value", "");
    Wikimapia.Utils.Dom.addEvents(i, {
        focus: e,
        click: e,
        keydown: function (t) {
            t.stopPropagation()
        },
        keyup: this.handlers.onKeyUp
    });
    a.setAttribute("value", o);
    Wikimapia.Utils.Dom.inject(t, this.container);
    Wikimapia.Utils.Dom.addEvent(t, "submit", this.handlers.onSubmit);
    return t
};
Wikimapia.App.TopPanel.Search.prototype.onLanguageChange = function (t) {
    Wikimapia.Utils.Dom.getElement(this.div, "#search-submit")
        .setAttribute("value", Wikimapia.Lang.get("all.search") || "Search")
};
Wikimapia.App.TopPanel.Search.prototype.onSearchResultSelect = function (t) {
    this.fireEvent("searchResultSelect");
    var e = new Wikimapia.LatLng(t.lat, t.lng);
    if (!this.map.getCenter()
        .equals(e)) {
        this.map.setCenter(e)
    }
    if (t.zoom !== this.map.getZoom()) {
        this.map.setZoom(t.zoom)
    }
};
Wikimapia.App.TopPanel.Search.prototype.onSearchResultHighlight = function (t) {
    var e = new Wikimapia.LatLng(t.lat, t.lng),
        i = this.map.getBounds(),
        a = this.map;
    if (i.containsLatLng(e)) {
        if (this.locationMarker) {
            if (!this.locationMarker.getLatLng()
                .equals(e)) {
                this.locationMarker.setLatLng(e, true)
            }
        } else {
            this.locationMarker = new Wikimapia.Marker({
                coords: e
            });
            this.map.addMarker(this.locationMarker);
            this.locationMarker.setVisible = function () {
                a.removeMarker(this)
            }
        }
    }
};
Wikimapia.App.TopPanel.Search.prototype.onSearchResultBlur = function () {
    if (this.locationMarker) {
        this.map.removeMarker(this.locationMarker);
        this.locationMarker = null
    }
};
Wikimapia.App.TopPanel.Search.prototype.onSearchChangeMode = function (t, e) {
    this.fireEvent("modeChange", e);
    this.search(t, e)
}, Wikimapia.App.TopPanel.Search.prototype.onSearchPagination = function (t, e, i) {
    this.fireEvent("pagination");
    this.search(t, e, i)
};
Wikimapia.App.TopPanel.Search.prototype.onSearchExternal = function (t, e, i) {
    this.search(t, e, i)
};
Wikimapia.App.TopPanel.Search.prototype.onKeyUp = function () {
    this.query = this.div["q"].value
};
Wikimapia.App.TopPanel.Search.prototype.onSubmit = function (t) {
    t.stop();
    if (!this.categories.selectedItem) {
        this.searchStart()
    }
    return false
};
Wikimapia.App.TopPanel.Search.prototype.searchStart = function () {
    this.search();
    this.fireEvent("searchStart")
};
Wikimapia.App.TopPanel.Search.prototype.onFrameLoad = function () {
    this.map.searchString = encodeURIComponent(this.query);
    this.map.fireEvent("search", this.map.searchString)
};
Wikimapia.App.TopPanel.Search.prototype.onFrameHidden = function () {
    this.fireEvent("hidden")
};
Wikimapia.App.TopPanel.Search.prototype.onFrameClosed = function () {
    if (!this.isDisposed()) {
        var t = document.getElementById("hiddenSearchForm");
        if (t) {
            Wikimapia.Utils.Dom.destroy(t)
        }
        document.getElementById("search-input")
            .value = this.map.searchString.replace(/[<>]/gi, " ") = "";
        this.map.fireEvent("search", this.map.searchString);
        this.fireEvent("searchStop");
        if (Wikimapia.Utils._throttledFunctions["searchingFailNoClick"]) {
            Wikimapia.Utils.dethrottle("searchingFailNoClick", false);
            Wikimapia.Utils.Logger.log("search_fail_no_click")
        }
    }
};
Wikimapia.App.TopPanel.Search.prototype.replaceFrame = function () {
    var t = this.map.getPanel("right"),
        e = t.container,
        i;
    if (t.options.iframe) {
        i = Wikimapia.Utils.Dom.clone(e, true)
    } else {
        i = Wikimapia.Utils.Dom.create("iframe")
    }
    Wikimapia.Utils.Dom.setProperties(i, {
        name: Wikimapia.Utils.uniqueId("searchFrame"),
        id: "searchFrame",
        "class": "panel-content",
        src: "about:blank",
        frameborder: "no",
        styles: {
            width: e.style.width,
            height: e.style.height,
            "margin-top": e.style.marginTop
        }
    });
    Wikimapia.Utils.Dom.inject(i, e, "before");
    Wikimapia.Utils.Dom.destroy(e);
    t.container = i;
    t.fireEvent("unload", t);
    return i
};
Wikimapia.App.TopPanel.Search.prototype.createHiddenForm = function (t, e, i) {
    var a = Wikimapia.Utils.Dom.create("form", {
        target: this.map.getPanel("right")
            .container.name,
        id: "hiddenSearchForm",
        method: "post",
        styles: {
            display: "none"
        }
    });
    this.setHiddenFormFields(a, t, e, i);
    return a
};
Wikimapia.App.TopPanel.Search.prototype.setHiddenFormFields = function (t, e, i, a) {
    var o = this.map.getCenter(),
        n = {
            y: Math.round(o.lat * 1e7),
            x: Math.round(o.lng * 1e7),
            z: this.map.getZoom(),
            qu: this.query,
            jtype: i,
            start: a || 0,
            "try": 0
        },
        s = "";
    for (var r in n) {
        s += '<input type="hidden" name="' + r + '" value="' + n[r] + '" />'
    }
    t.innerHTML = s;
    t.setAttribute("action", "/search/?q=" + encodeURIComponent(this.query.toLowerCase()));
    return t
};
Wikimapia.App.TopPanel.Search.prototype.search = function (t, e, i) {
    var a = document.getElementById("search-form"),
        o = document.getElementById("hiddenSearchForm"),
        n = document.getElementById("search-input"),
        s = this.map,
        r, p;
    e = e ? e === "_" ? "simple" : e : "simple";
    if (typeof t !== "string") {
        t = "" || n.value
    }
    t = t.replace(/[<>]/gi, " ");
    n.setAttribute("value", t);
    this.query = t;
    r = s.getPanel("right") || s.createPanel({
        url: "about:blank",
        frameName: "searchFrame",
        position: "right",
        iframe: true,
        initiallyClosed: this.initiallyClosed,
        onLoad: this.onFrameLoad.bind(this),
        onClose: this.onFrameClosed.bind(this),
        onHidden: this.onFrameHidden.bind(this)
    });
    delete this.initiallyClosed;
    s.searchString = encodeURIComponent(t);
    s.fireEvent("search", s.searchString);
    p = this.replaceFrame();
    if (o) {
        Wikimapia.Utils.Dom.destroy(o);
        o = null
    }
    if (!o) {
        o = this.createHiddenForm(t, e, i);
        Wikimapia.Utils.Dom.inject(o, r.container, "before")
    } else {
        this.setHiddenFormFields(o, t, e, i)
    }
    o.submit()
};
Wikimapia.App.TopPanel.Search.prototype.destroy = function () {
    this.monitor.destroy();
    this.monitor = null;
    this.categories.destroy();
    this.categories = null;
    this.app = null;
    delete this.container;
    this.map.removeEvents({
        search_external: this.handlers.onSearchExternal,
        search_change_mode: this.handlers.onSearchChangeMode,
        search_pagination: this.handlers.onSearchPagination,
        search_result_select: this.handlers.onSearchResultSelect,
        search_result_highlight: this.handlers.onSearchResultHighlight,
        search_result_blur: this.handlers.onSearchResultBlur
    });
    Wikimapia.Control.prototype.destroy.call(this)
};
Wikimapia.App.TopPanel.Search.Categories = function (t) {
    var e = Wikimapia.Lang.getCurrentLanguageCode(),
        i;
    this.control = t;
    this.cache = new Wikimapia.Cache;
    i = {
        el: this.control.input,
        url: "/ajax/get_category/?search_tcat={value}&format=json&fs=1&lng=" + e,
        getDefaultItems: function () {
            return this.parseItems(this.cache.retrieve("categoriesCache"), 15)
        }.bind(this),
        parseItems: this.parseItems.bind(this),
        onUpdate: this.onUpdate.bind(this)
    };
    Wikimapia.Interface.AutoComplete.prototype.constructor.call(this, i);
    Wikimapia.Utils.bindHandlers(this, "onSearchStart", "onSearchStop", "onSelectOption", "onContainerSearchOption", "keyboard", "onMapMovestart", "onInputClick", "hideContainer");
    Wikimapia.Utils.Dom.addEvents(this.control.input, {
        click: this.handlers.onInputClick,
        keyup: this.handlers.keyboard
    });
    this.createListContainer();
    this.render(this.options.getDefaultItems(), this.container, "");
    this.container.hide();
    this.control.addEvents({
        searchStart: this.handlers.onSearchStart,
        searchStop: this.handlers.onSearchStop
    });
    this.control.map.addEvent("movestart", this.handlers.onMapMovestart)
};
Wikimapia.Utils.inherits(Wikimapia.App.TopPanel.Search.Categories, Wikimapia.Interface.AutoComplete);
Wikimapia.App.TopPanel.Search.Categories.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.AutoComplete.prototype.options, {
    defaultValue: "default-search"
});
Wikimapia.App.TopPanel.Search.Categories.prototype.control = null;
Wikimapia.App.TopPanel.Search.Categories.prototype.cache = null;
Wikimapia.App.TopPanel.Search.Categories.prototype.container = null;
Wikimapia.App.TopPanel.Search.Categories.prototype.categoriesLimit = 15;
Wikimapia.App.TopPanel.Search.Categories.prototype.selectedItemIndex = -1;
Wikimapia.App.TopPanel.Search.Categories.prototype.selectedItem = null;
Wikimapia.App.TopPanel.Search.Categories.prototype.keyboard = function (t) {
    var e = false;
    switch (t.keyCode) {
        case Wikimapia.Utils.Event.keyCodes.ENTER:
            this.select();
            return false;
            break;
        case Wikimapia.Utils.Event.keyCodes.TAB:
        case Wikimapia.Utils.Event.keyCodes.ESC:
            t.preventDefault();
            this.hideContainer();
            break;
        case Wikimapia.Utils.Event.keyCodes.UP:
            t.stop();
            this.selectPrevious();
            this.div.value = this.div.value;
            break;
        case Wikimapia.Utils.Event.keyCodes.DOWN:
            t.preventDefault();
            this.selectNext();
            break;
        default:
            e = true;
            break
    }
    return e
};
Wikimapia.App.TopPanel.Search.Categories.prototype.selectPrevious = function () {
    var t;
    if (this.selectedItem) {
        Wikimapia.Utils.Dom.removeClass(this.selectedItem, "active")
    }
    if (this.selectedItemIndex > 0) {
        this.selectedItemIndex--
    }
    t = this.container.children[this.selectedItemIndex];
    if (t) {
        if (/divider|nav-header/.test(t.className)) {
            return this.selectPrevious()
        }
        this.selectedItem = t
    }
    if (this.selectedItem) {
        Wikimapia.Utils.Dom.addClass(this.selectedItem, "active")
    }
};
Wikimapia.App.TopPanel.Search.Categories.prototype.selectNext = function () {
    var t;
    if (this.selectedItem) {
        Wikimapia.Utils.Dom.removeClass(this.selectedItem, "active")
    }
    if (this.container.children.length > this.selectedItemIndex + 1) {
        this.selectedItemIndex++
    }
    t = this.container.children[this.selectedItemIndex];
    if (t) {
        if (/divider|nav-header/.test(t.className)) {
            return this.selectNext()
        }
        this.selectedItem = t
    }
    if (this.selectedItem) {
        Wikimapia.Utils.Dom.addClass(this.selectedItem, "active")
    }
};
Wikimapia.App.TopPanel.Search.Categories.prototype.select = function () {
    if (this.selectedItem) {
        if (Wikimapia.Utils.Dom.hasClass(this.selectedItem, "search")) {
            this.onContainerSearchOption()
        } else {
            this.onSelectOption(null, this.selectedItem)
        }
    }
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onSearchStart = function () {
    this.disable();
    this.hideContainer()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onSearchStop = function () {
    this.enable()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onMapMovestart = function () {
    this.handlers.hideContainer();
    this.div.blur()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onInputClick = function () {
    this.render(this.getItems(), this.container, this.div.value);
    this.container.show()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.parseItems = function (t, e) {
    if (typeof t === "string") t = JSON.parse(t);
    return t || {}
};
Wikimapia.App.TopPanel.Search.Categories.prototype.createListContainer = function () {
    this.container = Wikimapia.Utils.Dom.create("ul", {
        "class": "dropdown-menu pull-right",
        id: "categories-suggest"
    });
    Wikimapia.Utils.Dom.inject(this.container, this.div, "after");
    Wikimapia.Utils.Dom.addEvent(this.container, "click", "li.search", this.handlers.onContainerSearchOption);
    Wikimapia.Utils.Dom.addEvent(this.container, "click", "li.category", this.handlers.onSelectOption)
};
Wikimapia.App.TopPanel.Search.Categories.prototype.hideContainer = function (t) {
    this.selectedItemIndex = -1;
    this.selectedItem = null;
    this.container.innerHTML = "";
    this.container.hide()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onSelectOption = function (t) {
    var e = t.currentTarget,
        i = e.getAttribute("data-id");
    this.control.map.filterCategory(i);
    this.hideContainer();
    Wikimapia.Utils.Logger.addGoogleAnalyticsEvent("Top search", "Category selected");
    Wikimapia.Utils.Logger.log("ts_category_selected");
    this.div.value = "";
    this.div.blur()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onContainerSearchOption = function () {
    this.control.searchStart();
    this.hideContainer()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onLanguageChange = function () {
    var t = Wikimapia.Lang.getCurrentLanguageCode();
    this.options.url = "/ajax/get_category/?search_tcat={value}&format=json&fs=1&lng=" + t;
    this.items = null;
    this.hideContainer()
};
Wikimapia.App.TopPanel.Search.Categories.prototype.render = function (t, e, i) {
    var a = "",
        o = t.categories || {},
        n = i ? Wikimapia.Utils.getObjectKeys(o) : this.cache.retrieve("categoriesCache", "topFilter"),
        s = Wikimapia.Lang.getCurrentLanguage();
    i = i.replace(/[<>]/gi, " ");
    if (i !== "") {
        a += '<li class="search"><em>' + Wikimapia.Lang.get("all.search-for")
            .replace("%1", "<strong>" + i + "</strong>") + "&nbsp;&rarr;</em></li>"
    }
    if (n && n.length !== 0) {
        var r, p, l, c, h = i ? new RegExp("(" + i + ")", "i") : null;
        if (i !== "") {
            a += '<li class="divider"></li>'
        }
        a += '<li class="nav-header">' + Wikimapia.Lang.get("all.cats") + "</li>";
        for (var u = 0, m = Math.min(n.length, this.categoriesLimit) ; u < m; u++) {
            p = n[u];
            l = o[p];
            if (l) {
                a += '<li class="category" data-id="' + l.category_id + '">';
                r = Wikimapia.Utils.formatCategoryTitle(l, s);
                if (h) r = r.replace(h, "<strong>$1</strong>");
                a += r + "</li>"
            }
        }
    }
    if (a === "") {
        this.hideContainer()
    } else {
        this.selectedItemIndex = -1;
        this.selectedItem = null;
        e.innerHTML = a;
        e.show()
    }
};
Wikimapia.App.TopPanel.Search.Categories.prototype.onUpdate = function (t) {
    this.cache.store("categoriesCache", Wikimapia.Utils.extend({}, this.cache.retrieve("categoriesCache"), t));
    if ("" !== this.div.value) {
        this.render(t, this.container, this.div.value)
    }
};
Wikimapia.App.TopPanel.Search.Categories.prototype.destroy = function () {
    Wikimapia.Utils.Dom.destroy(this.container);
    delete this.container;
    this.control.map.removeEvent("movestart", this.handlers.onMapMovestart);
    this.control.removeEvents({
        searchStart: this.handlers.onSearchStart,
        searchStop: this.handlers.onSearchStop
    });
    delete this.control;
    Wikimapia.Interface.AutoComplete.prototype.destroy.call(this)
};
Wikimapia.App.TopPanel.Search.Monitor = function (t) {
    this.control = t;
    this.setHandlers()
};
Wikimapia.App.TopPanel.Search.Monitor.prototype = {
    control: null,
    timers: {
        fail: null,
        success: null,
        nextPage: null
    },
    timeouts: {
        FAIL: 15e3,
        SUCCESS: 1e4
    },
    resultClicks: 0,
    setHandlers: function () {
        Wikimapia.Utils.bindHandlers(this, "onSearchStart", "onSearchStop", "onSearchResultSelect", "onModeChange", "onPagination");
        this.control.addEvents({
            searchStart: this.handlers.onSearchStart,
            searchStop: this.handlers.onSearchStop,
            searchResultSelect: this.handlers.onSearchResultSelect,
            modeChange: this.handlers.onModeChange,
            pagination: this.handlers.onPagination
        })
    },
    log: function (t) {
        Wikimapia.Utils.Logger.log(t)
    },
    onSearchStart: function () {
        if (this.timers.fail) {
            clearTimeout(this.timers.fail);
            this.log("search_fail_research")
        } else {
            this.log("search_start")
        }
        this.timers.fail = setTimeout(this.onFailNoClick.bind(this), this.timeouts.FAIL);
        this.timers.nextPage = false
    },
    onSearchStop: function () {
        if (this.resultClicks === 0 && this.timers.fail) {
            clearTimeout(this.timers.fail);
            this.onFailNoClick()
        }
        clearTimeout(this.timers.success);
        this.resultClicks = 0;
        this.timers.nextPage = null
    },
    onSearchResultSelect: function () {
        clearTimeout(this.timers.fail);
        this.resultClicks++;
        clearTimeout(this.timers.success);
        if (this.resultClicks < 4) {
            this.timers.success = setTimeout(this.onResultSelectSuccess.bind(this), this.timeouts.SUCCESS)
        } else {
            this.log("search_fail_many_click")
        }
    },
    onResultSelectSuccess: function () {
        this.log("search_success_" + this.resultClicks)
    },
    onPagination: function () {
        if (!this.timers.nextPage) {
            this.log("search_page2");
            this.timers.nextPage = true
        }
    },
    onModeChange: function (t) {
        this.log("search_" + t)
    },
    onFailNoClick: function () {
        this.log("search_fail_no_click");
        this.timers.fail = null;
        this.timers.nextPage = null;
        this.resultClicks = 0
    },
    destroy: function () {
        for (var t in this.timers) {
            clearTimeout(this.timers[t])
        }
        this.control.removeEvents({
            searchStart: this.handlers.onSearchStart,
            searchStop: this.handlers.onSearchStop,
            searchResultSelect: this.handlers.onSearchResultSelect,
            modeChange: this.handlers.onModeChange,
            pagination: this.handlers.onPagination
        })
    }
};
Wikimapia.App.TopPanel.Menu = function (t, e, i) {
    this.app = t;
    this.map = e;
    var a = this.parseCategoriesItems.bind(this),
        e = this.map,
        o = new Wikimapia.Interface.AutoComplete({
            url: "/ajax/get_category/?search_tcat={value}&format=json&lng=" + Wikimapia.Lang.getCurrentLanguageCode(),
            getDefaultItems: function () {
                return a((new Wikimapia.Cache)
                    .retrieve("categoriesCache"), 15)
            }.bind(this),
            parseItems: a,
            defaultValue: "default-search"
        });
    Wikimapia.Interface.Menu.prototype.constructor.call(this, [this.getEditItems(), {
        text: "cats",
        icon: {
            spritePos: "-18px -702px"
        },
        action: function () {
            Wikimapia.Utils.Logger.log("categories_catalog_mm_click");
            this.map.createWindow({
                iframe: true,
                url: "/user/tools/categories_catalog/"
            })
        }.bind(this),
        modifier: o,
        items: true
    }, this.getUserItems(false), this.getLanguageItems()], {
        horizontal: true
    });
    Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.setStyle(this.div, "left", 178), i);
    this.setHandlers()
};
Wikimapia.Utils.inherits(Wikimapia.App.TopPanel.Menu, Wikimapia.Interface.Menu);
Wikimapia.App.TopPanel.Menu.prototype.options = Wikimapia.Utils.extend({}, Wikimapia.Interface.Menu.prototype.options, {
    baseTextSize: 14
});
Wikimapia.App.TopPanel.Menu.MAX_USERNAME_LENGTH = 14;
Wikimapia.App.TopPanel.Menu.prototype.app = null;
Wikimapia.App.TopPanel.Menu.prototype.languageSelect = null;
Wikimapia.App.TopPanel.Menu.prototype.setHandlers = function () {
    Wikimapia.Utils.bindHandlers(this, "onUserLogout", "onUserStatusChanged");
    this.app.addEvents({
        userLoggedOut: this.handlers.onUserLogout,
        userStatusChanged: this.handlers.onUserStatusChanged
    })
};
Wikimapia.App.TopPanel.Menu.prototype.onUserStatusChanged = function () {
    var t = this.app.newMessages;
    this.replace(this.getUserItems(this.map.access.userIsAuthorized(), this.map.access.getUserName(), t), 2);
    this.updateNewMessagesIndicator(t)
};
Wikimapia.App.TopPanel.Menu.prototype.updateNewMessagesIndicator = function (t) {
    if (t) {
        var e = {
            text: '<span class="new-message-indicator">' + '<span class="s16x16 menu-spt spt-newmsg menu-icon">' + "</span>" + t + "</span>",
            action: function () {
                router.route("/user/messages/?uid=" + this.map.access.getUserId())
            }.bind(this)
        };
        if (this.getItems()
            .length === 5) {
            this.replace(e, 4)
        } else {
            this.inject([e], 4)
        }
    } else {
        if (this.getItems()
            .length === 5) {
            this.remove(4)
        }
    }
};
Wikimapia.App.TopPanel.Menu.prototype.onUserLogout = function () {
    this.replace(this.getUserItems(false), 2)
};
Wikimapia.App.TopPanel.Menu.prototype.onLanguageChange = function (t) {
    Wikimapia.Interface.Menu.prototype.onLanguageChange.call(this, t);
    this.replace(this.getUserItems(this.map.access.userIsAuthorized(), this.map.access.getUserName(), this.app.newMessages), 2);
    this.replace(this.getLanguageItems(), 3)
};
Wikimapia.App.TopPanel.Menu.prototype.showMenu = function (t) {
    if (!this.map.locked) {
        Wikimapia.Interface.Menu.prototype.showMenu.call(this, t)
    }
};
Wikimapia.App.TopPanel.Menu.prototype.onUserLogin = function () { };
Wikimapia.App.TopPanel.Menu.prototype.parseCategoriesItems = function (t, e) {
    if (t === null) return;
    if (typeof t === "string") t = JSON.parse(t);
    var i = [],
        a = this.map,
        o = Wikimapia.Lang.getCurrentLanguage(),
        n, s;
    t.categories = t.categories || {};
    for (var r in t.categories) {
        n = t.categories[r];
        n.text = Wikimapia.Utils.formatCategoryTitle(n, o);
        n.tag = r;
        n.id = n.category_id;
        n.action = function () {
            Wikimapia.Utils.Logger.log("category_mm_id_" + this.category_id.toString());
            a.filterCategory(this)
        };
        s = Wikimapia.Utils.getCategoryIconSprite(n);
        if (s) {
            n.icon = {
                imageSpriteClass: "menu-spt s16x16 " + s
            }
        } else {
            delete n.icon
        }
        i.push(n);
        if (i.length == e) {
            break
        }
    }
    return i
};
Wikimapia.App.TopPanel.Menu.prototype.getEditItems = function () {
    return {
        text: "editmap",
        icon: {
            spritePos: "-18px -684px"
        },
        items: [{
            text: "add-place",
            icon: {
                spritePos: "-18px -900px"
            },
            action: function () {
                this.map.addPlace("mm")
            }.bind(this)
        }, {
            divider: true
        }, {
            text: "road",
            icon: {
                spritePos: "-18px -918px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("road_edit_mm_start");
                this.map.editLinear("roads")
            }.bind(this)
        }, {
            text: "railroad",
            icon: {
                spritePos: "-18px -954px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("railroad_edit_mm_start");
                this.map.editLinear("railroads")
            }.bind(this)
        }, {
            text: "ferry",
            icon: {
                spritePos: "-18px -972px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("ferry_edit_mm_start");
                this.map.editLinear("ferries")
            }.bind(this)
        }, {
            text: "river",
            icon: {
                spritePos: "-18px -1008px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("river_edit_mm_start");
                this.map.editLinear("rivers")
            }.bind(this)
        }]
    }
};
Wikimapia.App.TopPanel.Menu.prototype.getLanguageItems = function () {
    var t = this.app,
        e = [];
    for (var i in window.languagesNative) {
        e.push(function (e, i) {
            return {
                text: '<span class="lang-iso-name">' + e.toUpperCase() + "</span>" + i,
                action: function (i) {
                    i.stop();
                    Wikimapia.Utils.Logger.log("choose_lng_mm_id_" + Wikimapia.Lang.lngToCode(e));
                    t.setLanguage(e)
                }
            }
        }(i, window.languagesNative[i]))
    }
    e.push({
        divider: true
    }, {
        text: "more-lngs",
        icon: {
            spritePos: "-0px -1398px"
        },
        action: this.openLanguageSelect.bind(this)
    });
    return {
        text: '<span id="current-language">' + Wikimapia.Lang.getCurrentLanguage()
            .toUpperCase() + "</span>",
        items: e
    }
};
Wikimapia.App.TopPanel.Menu.prototype.openLanguageSelect = function (t) {
    if (this.languageSelect) {
        return
    }
    var e = function () {
        var e = this.app,
            i = new Wikimapia.Interface.Select({
                url: "/ajax/languages/",
                linkTemplate: '<a href="#" data-exists="{exists}" data-current="{current}">' + '<span class="lang-iso">{iso}</span>' + '<span class="lang-name">{value}</span></a>',
                onSelect: function (t) {
                    Wikimapia.Utils.Logger.log("choose_lng_mm_id_" + t.id);
                    e.setLanguage(t.iso);
                    this.destroy()
                },
                onRender: function () {
                    Wikimapia.Utils.Dom.getElements(this.div, "a[data-exists=true]")
                        .removeProperty("data-exists")
                        .addClass("translation-exists");
                    Wikimapia.Utils.Dom.getElement(this.div, "a[data-current=true]")
                        .removeProperty("data-current")
                        .getParent()
                        .addClass("active")
                },
                onDestroy: function () {
                    this.map.removeEvent("mousedown", this.destroyLanguageSelector);
                    delete this.destroyLanguageSelector;
                    delete this.languageSelect
                }.bind(this),
                closeButton: true
            });
        Wikimapia.Utils.Logger.log("choose_lng_mm_more");
        i.div.setAttribute("id", "language-select");
        Wikimapia.Utils.Dom.setStyles(Wikimapia.Utils.Dom.addClass(i.div, "nav"), {
            left: $(t.target)
                .getParent("li.dropdown")
                .getPosition()
                .x,
            top: 40
        });
        Wikimapia.Utils.Dom.inject(i.div, this.map.getControlsContainer());
        this.destroyLanguageSelector = i.destroy.bind(i);
        this.map.addEvent("mousedown", this.destroyLanguageSelector);
        i.render();
        this.languageSelect = i
    }.bind(this);
    Wikimapia.Net.loadModule(Wikimapia.Utils.defaultInterfacesDir + "Select.js", e)
};
Wikimapia.App.TopPanel.Menu.prototype.fixUserNameLength = function (t) {
    var e = Wikimapia.App.TopPanel.Menu.MAX_USERNAME_LENGTH;
    if (t.length > e) {
        t = t.split(" ")
            .shift();
        if (t.length > e) {
            t = t.substring(0, e) + "&hellip;"
        }
    }
    return t
};
Wikimapia.App.TopPanel.Menu.prototype.getUserItems = function (t, e, i) {
    var a = this,
        o = {
            text: t ? this.fixUserNameLength(e) : "login",
            icon: {
                spritePos: t ? "-18px -1206px" : "0 -1362px"
            },
            action: t ? function () {
                Wikimapia.Utils.Logger.log("profile_bar");
                this.app.profile()
            }.bind(this) : function () {
                Wikimapia.Utils.Logger.log("login_bar");
                this.app.login()
            }.bind(this)
        },
        n = [];
    this.app.newMessages = this.app.newMessages || i || 0;
    if (t) {
        n = n.concat({
            text: "profile",
            icon: {
                spritePos: "-18px -1206px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("profile_mm");
                this.app.profile()
            }.bind(this)
        }, {
            text: Wikimapia.Lang.get("all.newmsg")
                .replace("%1", this.app.newMessages),
            icon: {
                spritePos: "0 -1974px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("messages_mm");
                router.route("/user/messages/?uid=" + this.map.access.getUserId())
            }.bind(this)
        })
    } else {
        n = n.concat({
            text: "login",
            icon: {
                spritePos: "0 -1362px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("login_mm");
                this.app.login()
            }.bind(this)
        }, {
            text: "join-us",
            icon: {
                spritePos: "-18px -1206px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("register_mm");
                this.app.register()
            }.bind(this)
        })
    }
    n.push({
        text: "special-pages",
        icon: {
            image: false,
            imageSpriteClass: "spt-wand"
        },
        action: function () {
            Wikimapia.Utils.Logger.log("tools_mm");
            router.route("/user/tools/")
        }.bind(this),
        items: [{
            text: "watchlist-countries",
            action: function () {
                Wikimapia.Utils.Logger.log("watchlist_countries_mm");
                router.route("/user/tools/watchlist/?country=999&type=999&mode=country")
            }
        }, {
            text: "watchlist",
            action: function () {
                Wikimapia.Utils.Logger.log("watchlist_mm");
                this.app.openWatchlist()
            }.bind(this)
        }, {
            divider: true
        }, {
            text: "dismeas",
            icon: {
                spritePos: "-18px -36px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("mm_measure_tool");
                this.map.launchDistanceMeasurer()
            }.bind(this)
        }, {
            text: "all-tools",
            action: function () {
                Wikimapia.Utils.Logger.log("tools_mm");
                router.route("/user/tools/")
            }
        }]
    }, {
        divider: true
    }, {
        text: "menu-about",
        link: "/about/",
        action: function () {
            Wikimapia.Utils.Logger.log("about_wm_mm")
        },
        icon: {
            spritePos: "-18px -540px"
        }
    }, {
        text: "hotel-booking",
        action: function () {
            Wikimapia.Utils.Logger.log("hotels_mm");
            this.map.addLayerByName("wikimapia.interactive.hotels")
        }.bind(this),
        icon: {
            spritePos: "-18px -540px"
        }
    }, {
        divider: true
    }, {
        text: "menu-map-on-your-page",
        action: function () {
            Wikimapia.Utils.Logger.log("map_your_page_mm");
            this.map.launchMapEmbed()
        }.bind(this),
        icon: {
            spritePos: "-18px -486px"
        }
    }, {
        text: "wiki-guidelines",
        action: function () {
            Wikimapia.Utils.Logger.log("guidelines_mm");
            router.route("/user/tools/guidelines/")
        }.bind(this),
        icon: {
            spritePos: "-18px -540px"
        }
    }, {
        text: "menu-docs",
        link: "/docs/Main_Page",
        action: function () {
            Wikimapia.Utils.Logger.log("docs_mm")
        },
        icon: {
            spritePos: "-18px -576px"
        }
    }, {
        text: "menu-forum",
        link: "/forum/",
        icon: {
            spritePos: "-18px -612px"
        },
        action: function () {
            Wikimapia.Utils.Logger.log("forum_mm")
        }.bind(this)
    }, {
        text: "menu-report",
        icon: {
            spritePos: "-18px -1312px"
        },
        action: function () {
            Wikimapia.Utils.Logger.log("user_reports_mm");
            window.location = "/user/tools/user_reports/?action=edit&link=" + encodeURIComponent(window.location.href) + "&wm_type=1"
        }
    }, {
        text: "wikimapia-extras",
        icon: {
            spritePos: "0 -14px"
        },
        items: [{
            text: "del-pl",
            action: function () {
                Wikimapia.Utils.Logger.log("del_places_mm");
                this.map.showDeletedPlaces()
            }.bind(this),
            icon: {
                spritePos: "-18px -1330px"
            }
        }, {
            text: "old-places",
            action: function () {
                Wikimapia.Utils.Logger.log("old_places_mm");
                this.map.showOldPlaces()
            }.bind(this),
            icon: {
                spritePos: "-18px -774px"
            }
        }, {
            divider: true
        }, {
            text: "wikimapia-old",
            action: function () {
                Wikimapia.Utils.Logger.log("old_wikimapia_mm");
                window.location = window.location.toString()
                    .replace(window.location.host, "old." + window.location.host)
            },
            icon: {
                spritePos: "-18px -774px"
            }
        }, {
            text: "hotel-booking",
            action: function () {
                Wikimapia.Utils.Logger.log("hotels_mm");
                this.map.addLayerByName("wikimapia.interactive.hotels")
            }.bind(this),
            icon: {
                spritePos: "0px -1326px"
            }
        }, {
            text: "wikimapia-classic",
            action: function () {
                Wikimapia.Utils.Logger.log("map_type_classic");
                this.map.getControlByName("MapSwitcher")
                    .changeMapType("wikimapia.interactive.classic")
            }.bind(this),
            icon: {
                spritePos: "-18px -774px"
            }
        }, {
            text: "g-ter",
            action: function () {
                Wikimapia.Utils.Logger.log("map_type_google_terrain");
                this.map.getControlByName("MapSwitcher")
                    .changeMapType("google.terrain")
            }.bind(this),
            icon: {
                spritePos: "-18px -882px"
            }
        }]
    });
    if (t) {
        n.push({
            text: "logout-but",
            icon: {
                spritePos: "0px -1380px"
            },
            action: function () {
                Wikimapia.Utils.Logger.log("logout_mm");
                this.app.logout()
            }.bind(this)
        })
    }
    o.items = n;
    return o
};
Wikimapia.App.TopPanel.VkontakteButton = function (t, e) {
    Wikimapia.Utils.bindHandlers(this, "onClick", "onMouseenter", "onMouseleave", "onApiLoaded", "hidePopup");
    this.element = Wikimapia.Utils.Dom.create("span", {
        id: Wikimapia.App.TopPanel.VkontakteButton.CSS_ID,
        "class": "top-panel-social-button",
        html: '<span class="vk-logo"></span>'
    })
        .inject(e);
    this.element.addEvents({
        click: this.handlers.onClick,
        mouseenter: this.handlers.onMouseenter,
        mouseleave: this.handlers.onMouseleave
    })
};
Wikimapia.App.TopPanel.VkontakteButton.CSS_ID = "top-panel-vkontakte-button";
Wikimapia.App.TopPanel.VkontakteButton.WIDGET_CSS_ID = "wikimapia-vk-group-widget";
Wikimapia.App.TopPanel.VkontakteButton.API_URL = "//vk.com/js/api/openapi.js";
Wikimapia.App.TopPanel.VkontakteButton.showTimeout = 700;
Wikimapia.App.TopPanel.VkontakteButton.hideTimeout = 1e3;
Wikimapia.App.TopPanel.VkontakteButton.prototype.element = null;
Wikimapia.App.TopPanel.VkontakteButton.prototype.popup = null;
Wikimapia.App.TopPanel.VkontakteButton.prototype.spinner = null;
Wikimapia.App.TopPanel.VkontakteButton.prototype.widgetLoaded = false;
Wikimapia.App.TopPanel.VkontakteButton.prototype.popupTimer = 0;
Wikimapia.App.TopPanel.VkontakteButton.prototype.hideTimer = 0;
Wikimapia.App.TopPanel.VkontakteButton.prototype.onClick = function () {
    Wikimapia.Utils.Logger.log("vk_top_click");
    clearTimeout(this.popupTimer);
    clearTimeout(this.hideTimer);
    this.showPopup()
};
Wikimapia.App.TopPanel.VkontakteButton.prototype.onMouseenter = function () {
    clearTimeout(this.popupTimer);
    clearTimeout(this.hideTimer);
    this.popupTimer = setTimeout(this.showPopup.bind(this), Wikimapia.App.TopPanel.VkontakteButton.showTimeout)
};
Wikimapia.App.TopPanel.VkontakteButton.prototype.onMouseleave = function () {
    clearTimeout(this.popupTimer);
    clearTimeout(this.hideTimer);
    this.hideTimer = setTimeout(this.handlers.hidePopup, Wikimapia.App.TopPanel.VkontakteButton.hideTimeout)
};
Wikimapia.App.TopPanel.VkontakteButton.prototype.showPopup = function () {
    if (!this.popup) {
        this.popup = Wikimapia.Utils.Dom.create("div", {
            id: Wikimapia.App.TopPanel.VkontakteButton.WIDGET_CSS_ID + "-container",
            html: '<div id="' + Wikimapia.App.TopPanel.VkontakteButton.WIDGET_CSS_ID + '"></div>'
        })
            .inject(this.element);
        if (!this.widgetLoaded) {
            this.spinner = Wikimapia.Interface.Spinner.setLoading(this.popup, {
                color: "#5B7FA6",
                radius: 5,
                width: 3,
                length: 6,
                lines: 11
            });
            Wikimapia.Net.loadModule(Wikimapia.App.TopPanel.VkontakteButton.API_URL, this.handlers.onApiLoaded)
        }
    } else {
        this.popup.show()
    }
};
Wikimapia.App.TopPanel.VkontakteButton.prototype.hidePopup = function () {
    if (this.popup) {
        this.popup.hide()
    }
};
Wikimapia.App.TopPanel.VkontakteButton.prototype.onApiLoaded = function () {
    this.spinner.stop();
    delete this.spinner;
    VK.Widgets.Group(Wikimapia.App.TopPanel.VkontakteButton.WIDGET_CSS_ID, {
        mode: 1,
        width: "220",
        height: "400",
        color1: "FFFFFF",
        color2: "2B587A",
        color3: "5B7FA6"
    }, 12909704);
    this.widgetLoaded = true
};
Wikimapia.App.TopPanel.VkontakteButton.prototype.destroy = function () {
    this.hidePopup();
    clearTimeout(this.popupTimeout);
    clearTimeout(this.hideTimeout);
    this.element.removeEvents();
    this.element.destroy();
    delete this.element;
    if (this.popup) {
        this.popup.destroy()
    }
    delete this.popup
};
Wikimapia.App.TopPanel.FacebookButton = function (t, e) {
    var i = Wikimapia.Utils.Dom.inject(Wikimapia.Utils.Dom.create("div", {
        id: Wikimapia.App.TopPanel.FacebookButton.CSS_ID,
        "class": "top-panel-social-button",
        html: '<div class="fb-like" data-href="http://www.facebook.com/wikimapia" ' + 'data-width="' + this.width + '" data-colorscheme="light" ' + 'data-layout="button_count" data-show-faces="false"></div>'
    }), e)
};
Wikimapia.App.TopPanel.FacebookButton.CSS_ID = "top-panel-facebook-button";
Wikimapia.App.TopPanel.FacebookButton.prototype.width = 88;
Wikimapia.App.TopPanel.FacebookButton.prototype.annotation = "none";
Wikimapia.App.TopPanel.FacebookButton.prototype.show = function () {
    Wikimapia.Utils.Dom.addClass(this.getElement, "hide");
    return this
};
Wikimapia.App.TopPanel.FacebookButton.prototype.hide = function () {
    Wikimapia.Utils.Dom.removeClass(this.getElement, "hide");
    return this
};
Wikimapia.App.TopPanel.FacebookButton.prototype.getElement = function () {
    return document.getElementById(Wikimapia.App.TopPanel.FacebookButton.CSS_ID)
};
Wikimapia.App.TopPanel.FacebookButton.prototype.destroy = function () {
    Wikimapia.Utils.Dom.destroy(this.getElement())
};
Wikimapia.App.TopPanel.Progressbar = function (t, e, i) {
    this.app = e;
    Wikimapia.Interface.Progressbar.prototype.constructor.call(this, i);
    Wikimapia.Utils.Dom.inject(this.element, t);
    this.init();
    this.bindEvents()
};
Wikimapia.Utils.inherits(Wikimapia.App.TopPanel.Progressbar, Wikimapia.Interface.Progressbar);
Wikimapia.App.TopPanel.Progressbar.resetTimeout = 700;
Wikimapia.App.TopPanel.Progressbar.failResetTimeout = 1e4;
Wikimapia.App.TopPanel.Progressbar.dataChunksToLoad = 0;
Wikimapia.App.TopPanel.Progressbar.dataChunksLoaded = 0;
Wikimapia.App.TopPanel.Progressbar.prototype.resetTimer = 0;
Wikimapia.App.TopPanel.Progressbar.prototype.app = null;
Wikimapia.App.TopPanel.Progressbar.prototype.init = function () {
    var t = this.map.getLayersByName("wikimapia.interactive.*");
    for (var e = 0, i = t.length; e < i; e++) {
        Wikimapia.App.TopPanel.Progressbar.dataChunksToLoad += t[e].numLoadingTiles
    }
};
Wikimapia.App.TopPanel.Progressbar.prototype.bindEvents = function () {
    Wikimapia.Utils.bindHandlers(this, "onMapDataQueued", "onMapDataProgress");
    this.map.addEvents({
        mapDataQueued: this.handlers.onMapDataQueued,
        mapDataProgress: this.handlers.onMapDataProgress
    })
};
Wikimapia.App.TopPanel.Progressbar.prototype.onMapDataQueued = function (t) {
    Wikimapia.App.TopPanel.Progressbar.dataChunksToLoad += t
};
Wikimapia.App.TopPanel.Progressbar.prototype.onMapDataProgress = function () {
    var t = Wikimapia.App.TopPanel.Progressbar.failResetTimeout;
    Wikimapia.App.TopPanel.Progressbar.resetTimeout;
    Wikimapia.App.TopPanel.Progressbar.dataChunksLoaded++;
    clearTimeout(this.resetTimer);
    this.setProgress(100 * (Wikimapia.App.TopPanel.Progressbar.dataChunksLoaded / Wikimapia.App.TopPanel.Progressbar.dataChunksToLoad));
    if (Wikimapia.App.TopPanel.Progressbar.dataChunksLoaded >= Wikimapia.App.TopPanel.Progressbar.dataChunksToLoad) {
        Wikimapia.App.TopPanel.Progressbar.dataChunksLoaded = Wikimapia.App.TopPanel.Progressbar.dataChunksToLoad = 0;
        t = Wikimapia.App.TopPanel.Progressbar.resetTimeout
    }
    this.resetTimer = setTimeout(function () {
        this.setProgress(0)
    }.bind(this), t)
};
Wikimapia.App.TopPanel.Progressbar.prototype._setProgress = function (t) {
    Wikimapia.Interface.Progressbar.prototype._setProgress.call(this, t);
    this.element.style.height = t === 0 ? 0 : "";
    this.element.title = t + " %"
};
Wikimapia.App.TopPanel.Progressbar.prototype.destroy = function () {
    this.map.removeEvents({
        mapDataQueued: this.handlers.onMapDataQueued,
        mapDataProgress: this.handlers.onMapDataProgress
    });
    Wikimapia.Interface.Progressbar.prototype.destroy.call(this);
    delete this.app
};
(function (t) {
    var e = function () { };
    e.prototype = {
        load: function (e) {
            t.jwindow3(e)
        },
        viewMy: function () {
            t.jwindow3("/user/tools/watchlist/")
        },
        viewCountries: function () {
            t.jwindow3("/user/tools/watchlist/?country=999&type=999&mode=country")
        },
        viewCategories: function () {
            t.jwindow3("/user/tools/watchlist/?mode=categories")
        },
        viewTag: function (e) {
            t.tagfilter = 0;
            t.vtype = 1;
            this.load("/user/tools/watchlist/?mode=tag&tag=" + e + "&type=999")
        },
        "goto": function (t, e, i, a, o, n, s) {
            RoadRev.clear();
            var r = compat.getMap();
            if (t === i && e === a) {
                r.setCenter(new Wikimapia.LatLng(e, t));
                if (!n && o != r.getZoom()) {
                    r.setZoom(o)
                }
            } else {
                r.zoomToBounds(new Wikimapia.Bounds({
                    left: t,
                    top: e,
                    right: i,
                    bottom: a
                }))
            }
            return true
        }
    };
    this.Watchlist = Wikimapia.App.Watchlist = new e
})(window);
(function () {
    Wikimapia.App.prototype.newMessages = 0;
    Wikimapia.App.prototype.userForm = null;
    Wikimapia.App.prototype.userFormWindow = null;
    Wikimapia.App.prototype.login = function (t, e) {
        var i = this,
            a = "/user/login/";
        if (this.map.access.userIsAuthorized()) {
            return
        }
        if (t) {
            a = Wikimapia.Utils.Url.append(a, "backurl", t)
        }
        i.userFormWindow = this.map.createWindow({
            iframe: true,
            url: a,
            size: new Wikimapia.Size(720, 520)
        });
        return false
    };
    Wikimapia.App.prototype.logout = function () {
        this.map.cancelEditors(function (t) {
            if (t) {
                this.map.createWindow({
                    iframe: true,
                    size: Wikimapia.Size(340, 220),
                    url: "/user/logout/",
                    history: false
                })
                    .addEventOnce("load", function () {
                        Wikimapia.Utils.Logger.log("logout");
                        if (Browser.ie) window.location.reload();
                        this.fireEvent("userLoggedOut");
                        this.map.access.setUser(0);
                        this.requestStatus()
                    }.bind(this))
            }
        }.bind(this));
        return false
    };
    Wikimapia.App.prototype.profile = function () {
        this.map.createWindow({
            iframe: true,
            url: "/user/profile/",
            size: null
        });
        return false
    };
    Wikimapia.App.prototype.initFaceBookConnect = function (t, e) {
        var i = e ? e.$("#facebook-login") : $("#facebook-login");
        i.addEvent("click", function (e) {
            Wikimapia.Utils.Logger.logAuth(t ? "registration_attempt" : "login_attempt", Social.providerNames.FACEBOOK);
            e.stop();
            Social.Facebook.login()
        })
    };
    Wikimapia.App.prototype.initTwitterConnect = function (t, e) {
        var i = e ? e.$("#twitter-login") : $("#twitter-login");
        i.addEvent("click", function (e) {
            Wikimapia.Utils.Logger.logAuth(t ? "registration_attempt" : "login_attempt", Social.providerNames.TWITTER);
            e.stop();
            Social.Twitter.login()
        })
    };
    Wikimapia.App.prototype.initGoogleConnect = function (t, e) {
        var i = e ? e.$("#google-login") : $("#google-login");
        i.addEvent("click", function (e) {
            Wikimapia.Utils.Logger.logAuth(t ? "registration_attempt" : "login_attempt", Social.providerNames.GOOGLE);
            e.stop();
            Social.Google.login()
        })
    };
    Wikimapia.App.prototype.initVkontakteConnect = function (t, e) {
        var i = e ? e.$("#vkontakte-login") : $("#vkontakte-login");
        i.addEvent("click", function (e) {
            Wikimapia.Utils.Logger.logAuth(t ? "registration_attempt" : "login_attempt", Social.providerNames.VKONTAKTE);
            e.stop();
            Social.Vkontakte.login()
        })
    };
    Wikimapia.App.prototype.register = function (t) {
        this.map.createWindow({
            url: "/user/register/" + (t ? "?backurl=" + t : ""),
            iframe: true,
            history: false,
            size: new Wikimapia.Size(720, 520),
            onLoad: function () {
                Wikimapia.Utils.Logger.log("registration_load");
                this.trackAnalytics("/registration")
            }.bind(this)
        })
    };
    Wikimapia.App.prototype.forgot = function (t, e) {
        var i = "/user/forgot/";
        if (t && e) {
            i += "?uid=" + t + "&code=" + e
        }
        this.map.createWindow({
            url: i,
            iframe: true,
            history: false,
            size: new Wikimapia.Size(720, 450),
            onLoad: t && e ? function () {
                var t = document.getElementById("reguser");
                Wikimapia.Utils.Dom.addEvent(t, "submit", function (e) {
                    e.preventDefault();
                    new Wikimapia.Net.Xhr({
                        method: "post",
                        data: Wikimapia.Net.securePost(Wikimapia.Utils.Dom.toQueryString(t)),
                        onSuccess: function () {
                            app.requestStatus();
                            app.profile()
                        }
                    })
                        .send({
                            url: i
                        })
                })
            } : Wikimapia.Utils.noop
        })
    };
    Wikimapia.App.prototype.onAuthorizationComplete = function (t, e) {
        this.requestStatus();
        var i = function () {
            if (e) {
                if (t.code === 200) {
                    this.map.closeWindow();
                    router.route(e)
                }
            } else if (this.map.access.userIsAuthorized() && (t.code === 200 || t.code === 201)) {
                this.profile()
            } else {
                this.map.closeWindow()
            }
        }.bind(this);
        if (this.map.access.userIsAuthorized()) {
            i()
        } else {
            this.addEventOnce("userLogin", i)
        }
    };
    Wikimapia.App.prototype.editAccount = function () {
        this.map.createWindow({
            iframe: false,
            url: "/user/editaccount/"
        });
        return false
    };
    Wikimapia.App.prototype.editUserLocation = function () {
        this.map.closeWindow();
        UserLocation.init()
    };
    Wikimapia.App.prototype.userStatusHandler = function (t, e, i, a, o, n) {
        if (arguments.length === 0) {
            return
        }
        if (arguments.length === 3 || typeof t === "string" && arguments.length === 1) {
            var s = t.split("|");
            t = parseInt(s[0]);
            e = parseInt(s[1]);
            i = s[2];
            a = parseInt(s[3]);
            o = parseInt(s[4]);
            n = parseInt(s[5]) || 0
        }
        n = n || 0;
        this.setUser(t, e, i, a);
        if (o !== window.cssJsVersion) {
            this.versionChanged(o)
        }
        if (Wikimapia.Net.usesCDN() && !n) {
            var r = this.map.getLayerByName("wikimapia.interactive.basic");
            if (r) {
                r.switchToProductionForTiles(true)
            }
        }
    };
    Wikimapia.App.prototype.requestStatus = function (t, e) {
        if (t) {
            if (typeof t === "function") {
                e = t;
                t = null
            } else {
                this.userStatusHandler(t)
            }
        }
        if (this.statusRequest && this.statusRequest.isRunning()) {
            this.statusRequest.cancel()
        } else {
            this.statusRequest = new Wikimapia.Net.Xhr({
                noCache: true,
                method: "post",
                onSuccess: this.userStatusHandler.bind(this)
            })
        }
        this.statusRequest.send({
            url: "/infu/"
        })
    };
    Wikimapia.App.prototype.dispatchUserAuthorization = function (t) {
        if (this.map.access.userIsAuthorized()) {
            if (t === 0) this.fireEvent("userLogin")
        } else {
            if (t !== 0) this.fireEvent("userLogout")
        }
    };
    Wikimapia.App.prototype.setUser = function (t, e, i, a) {
        var o = this.map.access.getUserId(),
            n = this.map.access.getUserName(),
            s = +this.newMessages,
            r = this;
        this.newMessages = parseInt(e);
        this.map.access.setUser(parseInt(Wikimapia.Net.Cookie.read("uid")) || 0, i, a);
        this.dispatchUserAuthorization(o);
        Wikimapia.Utils.Dom.fireEvent(window, "updatePlaceCount", t);
        if (o !== this.map.access.getUserId() || i !== n || (this.newMessages || this.newMessages !== s)) {
            this.fireEvent("userStatusChanged");
            this.setTitle(null, this.newMessages)
        }
        if (parseInt(e)) {
            if (this.newMessages && this.newMessages !== s) {
                this.onNewMessagesReceived(this.newMessages)
            }
        }
    };
    Wikimapia.App.prototype.applyUserStartupSettings = function (t, e) {
        var i = 0;
        if (t.id !== 0) {
            Wikimapia.Net.Cookie.write("uid", t.id, 60 * 24 * 365)
        }
        if (e) {
            i = e.objectsCount
        }
        this.setUser(i, t.newMessages, t.name, t.level)
    };
    Wikimapia.App.prototype.onNewMessagesReceived = function (t) {
        if (Wikimapia.Utils.isEmbedded()) return;
        var e = this.map.access.getUserId();
        Wikimapia.Interface.Log.info("<span onclick=\"router.route('/user/messages/?uid=" + e + '\')"><span class="s16x16 menu-spt spt-newmsg menu-icon"></span>&nbsp;' + Wikimapia.Lang.get("all.newmsg")
            .replace(/\%1/, t) + "</span>", 8e3)
    };
    Wikimapia.App.prototype.userExperienceChanged = function (t) {
        if (Wikimapia.Utils.isEmbedded()) return;
        var e = '<div class="exprience-notification">',
            i = this.map.access.getUserId();
        if (parseInt(t.exp) <= 0) return;
        e += "<h4 onclick=\"router.route('/user/stats/?uid=" + i + "');\">";
        e += (Wikimapia.Lang.get("all.experience-points-count") || "%1 experience points")
            .replace("%1", '<span class="exp-overall-gain">' + t.exp + "</span>");
        e += '</h4><ul class="actions">';
        for (var a = 0, o = t.actions.length; a < o; a++) {
            var n = t.actions[a];
            if (n.translation && parseInt(n.code) !== 51) {
                e += "<li onclick=\"router.route('/user/tools/watchlist/?mode=history&uid=" + i + "&type=" + n.code + "');\">" + n.translation + "</li>"
            }
        }
        e += "</ul></div>";
        Wikimapia.Interface.Log.info(e, t.actions.length > 3 ? 12e3 : 8e3)
    };
    Wikimapia.App.prototype.userAwardAssigned = function (t) {
        alert(t.message)
    }
})();
(function () {
    var t = this.Social = {
        actionType: {
            AWARD_GAIN: "wikimapia-org:gain"
        },
        responseCodes: {
            SUCCESS: 200,
            SUCCESS_CREATED: 201,
            CHANGE_NAME: 111,
            WRONG_PASSWORD: 403,
            SERVER_ERROR: 500,
            NAME_EXISTS: 406,
            ALREADY_CONNECTED: 500
        },
        providerNames: {
            TWITTER: "twitter",
            GOOGLE: "google",
            FACEBOOK: "facebook",
            VKONTAKTE: "vkontakte"
        },
        nameChange: function (e) {
            var i = $("#social-change-name-form");
            i["name"].focus();
            i.addEvent("submit", function (a) {
                a.stop();
                var o = i.toQueryString();
                new Wikimapia.Net.Xhr({
                    method: "post",
                    data: o,
                    onSuccess: function (e) {
                        var i = $("status-message");
                        if (e.code === t.responseCodes.SUCCESS || e.code === t.responseCodes.SUCCESS_CREATED) {
                            app.profile()
                        } else if (e.code === t.responseCodes.NAME_EXISTS) {
                            i.innerHTML = e.message;
                            i.removeClass("hide")
                        }
                    }
                })
                    .send({
                        url: "/user/social/?" + Wikimapia.Utils.objectToQueryString(e)
                    });
                return false
            })
        },
        _connect: function (e, i) {
            new Wikimapia.Net.Xhr({
                type: "json",
                method: "post",
                onSuccess: function (e) {
                    if (e.code === t.responseCodes.SUCCESS || e.code === t.responseCodes.SUCCESS_CREATED) {
                        Wikimapia.Utils.Logger.logAuth("connect_success", i);
                        app.requestStatus();
                        app.editAccount()
                    } else if (e.code === t.responseCodes.ALREADY_CONNECTED) {
                        Wikimapia.Interface.Dialog.alert(e.message)
                    }
                }
            })
                .send({
                    url: "/user/social/?" + Wikimapia.Utils.objectToQueryString(e)
                })
        },
        _login: function (e, i) {
            if (app.map.getWindow()) {
                app.map.getWindow()
                    .setLoading()
            }
            new Wikimapia.Net.Xhr({
                type: "json",
                method: "post",
                onSuccess: function (e) {
                    if (e.code === t.responseCodes.SUCCESS || e.code === t.responseCodes.SUCCESS_CREATED) {
                        Wikimapia.Utils.Logger.logAuth(e.code === t.responseCodes.SUCCESS ? "login_success" : "registration_success", i);
                        app.requestStatus();
                        app.profile()
                    } else if (e.code === t.responseCodes.HAS_ACCOUNT || e.code === t.responseCodes.CHANGE_NAME) {
                        app.map.createWindow({
                            url: "/user/social/?" + Wikimapia.Utils.objectToQueryString(e),
                            iframe: false
                        })
                    }
                }
            })
                .send({
                    url: "/user/social/?" + Wikimapia.Utils.objectToQueryString(e)
                })
        },
        _disconnect: function (e) {
            new Wikimapia.Net.Xhr({
                type: "json",
                onSuccess: function (i) {
                    if (i.code === t.responseCodes.SUCCESS) {
                        Wikimapia.Utils.Logger.logAuth("disconnect", e);
                        app.editAccount()
                    }
                }
            })
                .send({
                    url: "/user/social/?doAction=disconnect&social=" + e
                })
        },
        _share: function (t, e, i) {
            var a = Wikimapia.Utils.Dom.getSize(window),
                o = 500,
                n = 400,
                s, r, p;
            s = (a.y - n) / 2;
            r = (a.x - o) / 2;
            t = t + Wikimapia.Utils.objectToQueryString(e);
            if (Wikimapia.Social.shareWnd) {
                Wikimapia.Social.shareWnd.close()
            }
            Wikimapia.Utils.Logger.log("social_share");
            Wikimapia.Social.shareWnd = window.open(t, "share", "menubar=no,location=no,resizable=no,scrollbars=yes,status=no,height=" + n + ",width=" + o + ",top=" + s + ",left=" + r);
            window.clearTimeout(Wikimapia.Social.shareWndTimer);
            Wikimapia.Social.shareWndTimer = window.setInterval(function () {
                Wikimapia.Social._shareWindowChecker(i)
            }, 100)
        },
        _shareWindowChecker: function (t) {
            if (!Wikimapia.Social.shareWnd || Wikimapia.Social.shareWnd.closed) {
                window.clearTimeout(Wikimapia.Social.shareWndTimer);
                if (typeof t === "function") {
                    t()
                }
            }
        },
        Vkontakte: {
            shareUrl: "http://vk.com/share.php?",
            sdkUrl: "//vk.com/js/api/openapi.js",
            auth: function (e) {
                var i = window.open("/user/" + t.providerNames.VKONTAKTE, "Vkontakte", "width=607,height=280,resizable=yes,scrollbars=yes,status=yes");
                window["loginVk"] = function (t) {
                    e(t);
                    window["loginVk"] = undefined
                }
            },
            login: function (e) {
                if (!e) {
                    t.Vkontakte.auth(t.Vkontakte.login)
                } else {
                    var i = {
                        social: t.providerNames.VKONTAKTE,
                        accessToken: e
                    };
                    t._login(i, t.providerNames.VKONTAKTE)
                }
            },
            connect: function () {
                t.Vkontakte.auth(function (e) {
                    var i = {
                        social: t.providerNames.VKONTAKTE,
                        accessToken: e
                    };
                    t._connect(i, t.providerNames.VKONTAKTE)
                })
            },
            disconnect: function () {
                t._disconnect(t.providerNames.VKONTAKTE)
            },
            load: function (t) {
                Wikimapia.Net.loadModule(Wikimapia.Social.Vkontakte.sdkUrl, t)
            },
            share: function (t, e, i, a, o) {
                var n = {
                    url: i,
                    title: t,
                    description: e,
                    image: Array.isArray(a) ? a[0] : a
                };
                Wikimapia.Social._share(Wikimapia.Social.Vkontakte.shareUrl, n, o)
            },
            shareAward: function (t, e, i, a, o) {
                Wikimapia.Social.Vkontakte.share(t, e, i, a, o)
            }
        },
        Facebook: {
            shareUrl: "//www.facebook.com/sharer/sharer.php?",
            load: function (t) {
                Wikimapia.Net.loadModule("//connect.facebook.net/en_US/all.js#xfbml=1&appId=" + window.facebookParams.appId, t, "facebook-jssdk", true)
            },
            testAPI: function () {
                console.log("Welcome!  Fetching your information.... ");
                FB.api("/me", function (t) {
                    console.log("Good to see you, " + t.name + ".", t)
                })
            },
            postMessage: function (t) {
                FB.api("/me/feed", "post", {
                    message: t
                }, function (t) {
                    if (!t || t.error) {
                        console.log("Error occured")
                    } else {
                        console.log("Post ID: " + t.id)
                    }
                })
            },
            init: function () {
                if (!FB.__wm__) {
                    FB.init({
                        appId: window.facebookParams.appId,
                        channelUrl: "/facebook_channel.html",
                        status: true,
                        cookie: true,
                        xfbml: true,
                        fbml5: true
                    })
                }
                FB.getLoginStatus(function (t) {
                    FB.__wm__ = true;
                    if (t.status === "connected") { } else if (t.status === "not_authorized") { } else { }
                }, true);
                var e = Wikimapia.Utils.Dom.getElement(".wm-window");
                if (e) {
                    FB.XFBML.parse(e)
                }
                var i = document.getElementById("facebook-login");
                if (i) {
                    Wikimapia.Utils.Dom.addEvent(i, "click", function (e) {
                        e.stop();
                        t.Facebook.login()
                    })
                }
            },
            auth: function (e) {
                FB.login(function (i) {
                    if (i.authResponse) {
                        window.fbAccessToken = i.authResponse.accessToken;
                        FB.api({
                            method: "fql.query",
                            query: "SELECT uid, name, email FROM user WHERE uid=" + i.authResponse.userID
                        }, function (i) {
                            i = i[0];
                            var a = {
                                social: t.providerNames.FACEBOOK,
                                accessToken: window.fbAccessToken
                            };
                            e(a, i)
                        })
                    } else {
                        console.log("Facebook error. API request has been canceled.")
                    }
                }, {
                    scope: window.facebookParams.scope
                })
            },
            login: function () {
                t.Facebook.auth(function (e, i) {
                    t._login(e, t.providerNames.FACEBOOK)
                })
            },
            connect: function () {
                t.Facebook.auth(function (e, i) {
                    t._connect(e, t.providerNames.FACEBOOK)
                })
            },
            disconnect: function () {
                t._disconnect(t.providerNames.FACEBOOK)
            },
            share: function (t, e, i, a, o) {
                var n = {
                    s: 100,
                    p: {
                        title: t,
                        summary: e,
                        url: i,
                        images: Array.isArray(a) ? a : [a]
                    }
                };
                Wikimapia.Social._share(Wikimapia.Social.Facebook.shareUrl, n, o)
            },
            shareAward: function (t, e, i, a, o) {
                if (window.FB) {
                    FB.ui({
                        method: "share_open_graph",
                        action_type: Wikimapia.Social.actionType.AWARD_GAIN,
                        display: "popup",
                        action_properties: {
                            award: i
                        }
                    }, o)
                } else {
                    var n = Array.prototype.slice.call(arguments);
                    Wikimapia.Social.Facebook.load(function () {
                        Wikimapia.Social.Facebook.shareAward.apply(n)
                    })
                }
            }
        },
        Twitter: {
            accountName: "Wikimapia",
            shareUrl: "//twitter.com/intent/tweet?",
            login: function () {
                window.location.href = "/user/twitter"
            },
            connect: function (t) {
                window.location.href = t
            },
            disconnect: function () {
                t._disconnect(t.providerNames.TWITTER)
            },
            share: function (t, e, i, a, o) {
                var n = {
                    via: Wikimapia.Social.Twitter.accountName,
                    text: e,
                    url: i
                };
                Wikimapia.Social._share(Wikimapia.Social.Twitter.shareUrl, n, o)
            },
            shareAward: function (t, e, i, a, o) {
                Wikimapia.Social.Twitter.share(t, e, i, a, o)
            }
        },
        Google: {
            shareUrl: "//plus.google.com/share?",
            login: function () {
                window.location.href = "/user/google"
            },
            connect: function (t) {
                window.location.href = t
            },
            disconnect: function () {
                t._disconnect(t.providerNames.TWITTER)
            },
            share: function (t, e, i, a) {
                var o = {
                    url: i
                };
                Wikimapia.Social._share(Wikimapia.Social.Google.shareUrl, o)
            },
            shareAward: function (t, e, i, a, o) {
                Wikimapia.Social.Google.share(t, e, i, a, o)
            }
        }
    };
    if (Wikimapia) {
        Wikimapia.Social = t
    }
    Wikimapia.Utils.Dom.addEvent(document, "ready", function () {
        if (!window.FB) t.Facebook.load(t.Facebook.init)
    })
})();
(function (t) {
    this.UserLocation = {
        init: function (t, e) {
            new Wikimapia.Net.Xhr({
                method: "get",
                url: "/user/editlocation/",
                evalScripts: true,
                onSuccess: function (t) {
                    var e = app.map,
                        i = e.createPanel({
                            content: t
                        });
                    i.addEvent("close", function () {
                        if (e.userhome) {
                            e.removeMarker(e.userhome);
                            delete e.userhome
                        }
                    })
                }
            })
                .send();
            var i, a = compat.getMap(),
                o = false;
            if (isNaN(t) && isNaN(e)) {
                i = a.getCenter()
            } else {
                i = new Wikimapia.LatLng(t, e);
                o = i
            }
            if (a.userhome) {
                a.removeMarker(a.userhome)
            }
            a.userhome = new Wikimapia.Marker({
                coords: i,
                draggable: true,
                bouncy: false
            });
            a.addMarker(a.userhome);
            if (o) {
                a.setCenter(o)
            }
        },
        clear: function (t) {
            t = t || 0;
            setTimeout(function () {
                map = app.map;
                if (map.userhome) {
                    map.removeMarker(map.userhome);
                    delete map.userhome
                }
            }, t)
        },
        putToCenter: function () {
            var t = compat.getMap();
            if (t.userhome) {
                t.removeMarker(t.userhome)
            }
            t.userhome = new Wikimapia.Marker({
                coords: t.getCenter(),
                draggable: true
            });
            t.addMarker(t.userhome)
        },
        save: function () {
            var t = compat.getMap(),
                e = t.userhome.getLatLng();
            new Wikimapia.Net.Xhr({
                method: "get",
                url: "/user/editlocation/?saveloc=(" + (e.lat.toFixed(6) + ", " + e.lng.toFixed(6)) + ")&z=" + t.getZoom(),
                evalScripts: true,
                onSuccess: function () {
                    jwindow3_hide_x();
                    jwindow("/user/profile/", 1)
                }
            })
                .send()
        },
        show: function (t, e, i) {
            var a = compat.getMap(),
                o = new Wikimapia.LatLng(t, e);
            if (a.userhome) {
                a.removeMarker(a.userhome)
            }
            a.setZoom(i);
            a.setCenter(o);
            a.userhome = new Wikimapia.Marker({
                coords: o,
                draggable: true,
                bouncy: false
            });
            a.addMarker(a.userhome)
        },
        deleteCurrent: function () {
            new Wikimapia.Net.Xhr({
                method: "get",
                url: "/user/editlocation/?delloc=1",
                evalScripts: true,
                onSuccess: t.j3_put
            })
                .send()
        }
    }
})(window);
! function (global) {
    var compat = global.compat = {
        parseJSResponse: function (t, e) {
            var i = null,
                a;
            if (e) {
                a = [null, t]
            } else {
                var o = /<\!\-\- js([\w\W\u00A1-\uFFFF]+?)\-\->/g,
                    n = "";
                a = t.match(o);
                if (a) {
                    for (var s = 0; s < a.length; s++) {
                        n += a[s].replace(/(<\!\-\- js)|(\-\->)/g, "")
                    }
                    a = [0, n]
                }
            }
            if (a && a[1] && !/printex/.test(a[1])) {
                a = a[1].clean();
                i = {};
                var r = compat.getMap(),
                    p = compat.getApp();
                var l = {
                    fast: function () {
                        global.fast.apply(global, arguments)
                    },
                    "WatchList\\.load": function (t) {
                        i.url = t.replace("WatchList.load(", "");
                        i.sidePanel = true
                    },
                    jwindow: function (t) {
                        var t = h[0],
                            e, a, o;
                        i.url = t;
                        if (/^\/\d+(\/\w+)?/.test(t)) {
                            e = t.replace(/^\/|\/$/g, "")
                                .split("/");
                            a = parseInt(e[0], 10);
                            i.objectId = a;
                            if (e.length > 1) {
                                o = Wikimapia.Lang.lngToCode(e[1]);
                                if (o !== -1) {
                                    i.language = o
                                }
                            }
                        }
                    },
                    trackPageview: function (t) {
                        i.trackAction = t
                    },
                    cc1: function () {
                        i.updateMap = true;
                        i.redrawOverlays = true
                    },
                    mmenuprep: function (t, e, a, o) {
                        i.menuData = {
                            id: e,
                            deletionState: t - 52,
                            mbr: Wikimapia.Bounds.fromArray([a.x1, a.y1, a.x2, a.y2]),
                            zoom: parseInt(a.zoom),
                            currentLanguage: parseInt(a.lng),
                            quickDel: o,
                            protectionStatus: parseInt(arguments[6]) || 0,
                            custom: !!arguments[7]
                        }
                    },
                    jwindow3: function (t) {
                        i.url = t;
                        i.sidePanel = true
                    },
                    jwindow3_dosearch5: function (t) {
                        global.jwindow3_dosearch5(t)
                    },
                    GDownloadUrl: function (t) {
                        i.url = t;
                        if (/user\/editlocation/.test(i.url)) {
                            i.sidePanel = true
                        }
                    },
                    loadAndTurnOnStatusgrid: function () {
                        r.addStatusGrid()
                    },
                    update_stats: function () {
                        global.update_stats()
                    },
                    jwindow_close: function () {
                        global.jwindow_close()
                    }
                };
                for (var c in l) {
                    var h = compat.extractFunctionArguments(a, c);
                    if (h) {
                        l[c].apply(global, h)
                    }
                }
            }
            return i
        },
        extractFunctionArguments: function (str, fname) {
            var test = new RegExp(fname + "\\((([^\\)]+,?)?\\)?)", "g"),
                match = str.match(test),
                result = null,
                argset;
            if (match) {
                for (var i = 0, len = match.length; i < len; i++) {
                    argset = match[i].replace(fname + "(", "")
                        .replace(/\)$/, "");
                    try {
                        result = eval("[" + argset + "]")
                    } catch (e) { }
                }
            }
            return result
        },
        showPolygonRevision: function (t) {
            var e = t.getAttribute("href");
            historyWindow = app.map.getWindow();
            if (historyWindow) {
                historyWindow.hide()
            }
            app.openPanel(e, "right");
            return false
        },
        closePolygonRevision: function () {
            var t = app.map;
            t.closePanel("right");
            historyWindow = t.getWindow();
            historyPanel = t.getPanel();
            if (historyPanel && historyPanel.left) {
                historyPanel.left.show()
            } else if (historyWindow) {
                historyWindow.show()
            }
            return false
        }
    };
    Wikimapia.Utils.extend(global, {
        wm_vers: 4,
        flphoar: [],
        jevals: "",
        doafterxmlget: "",
        _ge: $,
        ar_tcats_cur: [],
        is_changed: 0,
        is_t_changed: 0,
        iframeLoaded: function () {
            var t = app.map.getPanel(),
                e = app.map.getWindow();
            if (t) {
                if (t instanceof Wikimapia.Interface.Panel) {
                    t = [t]
                } else {
                    var i = [];
                    for (var a in t) {
                        i.push(t[a])
                    }
                    t = i
                }
                for (var o = 0, n = t.length; o < n; o++) {
                    t[o].hideLoading()
                }
            }
            if (e) {
                e.hideLoading()
            }
        },
        checklng: function () {
            var t = $("#wikiedit")[0],
                e = t.langid,
                i = t.title.value.split(""),
                a = $("#lngwrn"),
                o = $("#content-warning");
            if (e.type == "hidden") {
                if (e.value !== "0") {
                    return
                }
            } else {
                if (e.options[e.selectedIndex].value !== "0") {
                    return
                }
            }
            for (var n = 0, s = i.length; n < s; n++) {
                if (i[n].charCodeAt(0) > 126) {
                    a.html('<strong class="err">' + Wikimapia.Lang.get("all.changelng-propose") + "</strong>")
                        .show();
                    if (o) o.hide();
                    return
                }
            }
            a.html("")
                .hide();
            if (o) o.show();
            return true
        },
        leoff: Wikimapia.Utils.noop,
        jwindow3_m_bgon: Wikimapia.Utils.noop,
        jwindow3_m_bgoff: Wikimapia.Utils.noop,
        jwindow3_dosearch5: function (t) {
            var e = compat.getApp();
            switch (t) {
                case "geo":
                    Wikimapia.Utils.Logger.log("search_city");
                    break;
                case "coord":
                    Wikimapia.Utils.Logger.log("search_coords");
                    break;
                case "_":
                default:
                    Wikimapia.Utils.Logger.log("search_all");
                    break
            }
            e.performSearch(document.getElementById("search-form")["q"].value || "", t)
        },
        over: Wikimapia.Utils.noop,
        loadjs: function (filename, callback) {
            switch (typeof callback) {
                case "string":
                    eval(callback);
                    break;
                case "function":
                    callback();
                    break;
                default:
                    break
            }
        },
        _bk: "block",
        _bl: "block",
        _no: "none",
        jwindow: function (t) {
            var e = compat.getApp();
            if (e) {
                e.performShow(t)
            }
            return false
        },
        jwindow3: function (t) {
            app.openPanel(t, "right");
            return false
        },
        jwindow3_add_watchlist: function () {
            var t = compat.getApp();
            t.addWatchlist();
            return false
        },
        pre_block_edit1: function (t) {
            var e = compat.getApp();
            e.editWatchlist(t)
        },
        jwindow3_hide_x: function () {
            var t = compat.getMap();
            t && t.closePanel();
            return false
        },
        GDownloadUrl: function (t, e) {
            global.fast(t, e)
        },
        j3_put: function (t) {
            compat.getMap()
                .createPanel({
                    content: t
                })
        },
        loadXML: function (t, e, i) {
            var a = new Wikimapia.Net.Xhr({
                method: "post",
                onSuccess: function (e) {
                    var a = app.map,
                        o = a.getWindow(),
                        n = /^\/user\/editaccount\//.test(t) ? {
                            url: "/user/profile/",
                            iframe: true
                        } : {
                            content: e
                        };
                    if (o) {
                        o.open(n)
                    }
                    if (typeof i === "function") {
                        i(e)
                    }
                }
            });
            if (e) {
                if (typeof e === "string") {
                    e = document.getElementById(e)
                }
                var o = Wikimapia.Utils.isElement(e) ? Wikimapia.Utils.Dom.toQueryString(e) : Wikimapia.Utils.objectToQueryString(e);
                a.send({
                    url: t,
                    data: Wikimapia.Net.securePost(o)
                })
            }
        },
        fast: function (url, callback) {
            callback = callback || Wikimapia.Utils.noop;
            var app = compat.getApp();
            new Wikimapia.Net.Xhr({
                method: "get",
                url: url,
                onSuccess: function (response) {
                    if (compat.getApp()
                        .validateAjaxResponse(response)) {
                        if (global.doafterxmlget !== "") {
                            eval(global.doafterxmlget);
                            global.doafterxmlget = ""
                        }
                        responseCheck = response.match(/<\!\-\- js([!\s\w \-;:\.\,\(\)\[\]\'\"=<>\/&\?\\\{\}\+\u00A1-\uFFFF]+?)\-\->/);
                        if (responseCheck) {
                            if (responseCheck[1]) {
                                eval(responseCheck[1])
                            }
                        }
                        callback(response)
                    }
                }
            })
                .send()
        },
        RoadRev: Wikimapia.Utils.extend(global.RoadRev || {}, {
            clear: function () {
                var t = compat.getApp(),
                    e = t.watchlist;
                if (e) {
                    e.clear()
                }
            },
            load: function (t, e) {
                compat.getApp()
                    .openLinearRevision(t, e)
            },
            show: Wikimapia.Utils.noop
        }),
        test_zoom: function (t, e, i, a, o, n, s) {
            RoadRev.clear();
            var r = compat.getMap();
            if (t === i && e === a) {
                r.setCenter(new Wikimapia.LatLng(e, t));
                if (!n && o != r.getZoom()) {
                    r.setZoom(o)
                }
            } else {
                r.zoomToBounds(new Wikimapia.Bounds({
                    left: t,
                    top: e,
                    right: i,
                    bottom: a
                }))
            }
            return true
        },
        prepolyone: function (t, e, i) {
            var a = new Wikimapia.Parser.Itiles,
                o = compat.getMap(),
                n = o.tempPolygon,
                s = a.decodePolygon(t);
            if (s.getVertexCount() > 1) {
                if (n) {
                    n.setGeometry(s)
                } else {
                    n = new Wikimapia.Feature.Polygon({
                        geometry: s
                    });
                    o.addVectorFeature(n);
                    o.tempPolygon = n
                }
            } else {
                if (n) {
                    o.removeVectorFeature(n);
                    delete o.tempPolygon
                }
            }
            return false
        },
        jwindow_close: function () {
            var t = app.map.getWindow();
            if (t) {
                t.fireEvent("cancel");
                app.map.closeWindow()
            }
            return false
        },
        jwindow3_rcookie: Wikimapia.Net.Cookie.read,
        tcats_init: Wikimapia.Utils.noop,
        localization: {},
        tcats_search: function () {
            if (!global.previousSearchValue) {
                global.searchInput = document.getElementById("searchtcatsnew");
                global.previousSearchValue = global.searchInput.value
            }
            var t = global.searchInput.value;
            if (t !== global.previousSearchValue) {
                if (t !== "") {
                    global.previousSearchValue = t;
                    new Request({
                        url: "/ajax/get_category/?search_tcat=" + t + "&fs=1&format=json",
                        method: "get",
                        onSuccess: function (t) {
                            var e = {};
                            t = JSON.parse(t);
                            t.categories = t.categories || {};
                            compat.initCategories(t.categories, null, t.allowCreate)
                        }
                    })
                        .send()
                } else {
                    compat.initCategories(window.defaultCategories)
                }
            }
            return true
        },
        checkEnter: function (t, e) {
            t = new Event(t);
            if (t.code == 13) {
                return e ? true : false
            }
            return true
        },
        change_but: function (t, e, i, a) {
            if (e != 1) {
                e = ""
            }
            if (i) {
                var a = 1;
                for (var o in i) {
                    if (!i[o]) {
                        a = 0;
                        break
                    }
                }
            }
            var n = document.getElementById(t);
            if (a) {
                n.className = "btn";
                n.disabled = 0
            } else {
                n.className = "btn disabled"
            }
        },
        revRadioHide: function (t, e, i, a) {
            var o = e == "oldrev[]",
                n = document.getElementById("selected_rev" + (o ? "2" : ""));
            if (n) {
                n.value = a
            }
            for (var s = 0; s < t[e].length; s++) {
                var r = t[e][s];
                if (o) {
                    r.disabled = s > i ? "" : "disabled"
                } else {
                    r.disabled = s < i ? "" : "disabled"
                }
            }
        },
        compareRevs: function (t, e, i) {
            var a = document.getElementById("selected_rev")
                .value,
                o = document.getElementById("selected_rev2")
                .value,
                n = compat.getApp(),
                s;
            s = ["/object/history/show/?object_type=" + i + "&id=", t, "&lng=", e, "&rev=", a, "&rev2=", o].join("");
            n.performShow(s)
        },
        approveRevision: function (t) {
            if (t !== null && t != "null" && t.length > 0) {
                var e = JSON.parse(t);
                if (e.approved.id > 0) {
                    document.getElementById("revision_approve_button")
                        .style.display = "none";
                    var i = document.getElementById("revision_inspection_approved");
                    if (i) {
                        i.innerHTML += '<span class="likelink" onclick="jwindow(\'/user/' + e.approved.id + "',1);return false;\">" + e.approved.name + "</span>"
                    } else {
                        document.getElementById("revision_inspection_list")
                            .innerHTML = '<i class="icon-ok"></i> ' + localization["history_rev_approved_by"].replace("%1", '<span class="likelink" onclick="parent.jevals=\'jwindow(\\\'/user/' + e.approved.id + "\\',1);';return false;\">" + e.approved.name + "</span>")
                    }
                }
                parent.jevals = "clear_cache();cc1();"
            }
        },
        displayByFields: function () {
            $("#byFieldsLinkHide")
                .setStyle("display", "inline");
            $("#byFieldsLinkShow")
                .setStyle("display", "none");
            $("#byFieldsHelpBlock,#byFieldsButtonBlock")
                .setStyle("display", "block");
            var t = $(["#photos_revert_1", "#photos_revert_2", "#title_revert_1", "#title_revert_2", "#description_revert_1", "#description_revert_2", "#wikipedia_revert_1", "#wikipedia_revert_2", "#building_revert_1", "#building_revert_2", "#protect_revert_1", "#protect_revert_2", "#categories_revert_1", "#categories_revert_2", "#address_revert_1", "#address_revert_2", "#polygon_revert_1", "#polygon_revert_2"].join(","));
            if (t) {
                t.setStyle("display", "table-cell")
            }
        },
        displayNormal: function () {
            $("#byFieldsLinkHide,#byFieldsHelpBlock,#byFieldsButtonBlock")
                .setStyle("display", "none");
            $("#byFieldsLinkShow")
                .setStyle("display", "inline");
            var t = $(["#photos_revert_1", "#photos_revert_2", "#title_revert_1", "#title_revert_2", "#description_revert_1", "#description_revert_2", "#wikipedia_revert_1", "#wikipedia_revert_2", "#building_revert_1", "#building_revert_2", "#protect_revert_1", "#protect_revert_2", "#categories_revert_1", "#categories_revert_2", "#address_revert_1", "#address_revert_2", "#polygon_revert_1", "#polygon_revert_2"].join(","));
            if (t) {
                t.setStyle("display", "none")
            }
        },
        serialize: function (t) {
            var e = "",
                i;
            for (var a = 0, o = t.length; a < o; a++) {
                i = t[a];
                e += "s:" + String(a)
                    .length + ':"' + a + '";s:' + i.length + ':"' + i + '";'
            }
            e = "a:" + t.length + ":{" + e + "}";
            return e
        },
        createEncodedArrayFromCheckboxes: function (t, e, i) {
            var a = Wikimapia.Utils.Dom.getElements(document.forms["form1"] || document.getElementById("history-table"), "input[type=checkbox]"),
                o = [],
                n, s, r = compat.getApp();
            for (var p = 0, l = a.length; p < l; p++) {
                n = a[p];
                if (n.checked) {
                    o.push(n.id)
                }
            }
            o = escape(global.serialize(o));
            s = ["/object/history/list/?id=", t, "&revert=", e, "&byfields=", o, "&revision_comment=", i].join("");
            r.performShow(s);
            return false
        },
        showByFieldsLikeAfterApply: function () {
            var t = Wikimapia.Utils.Dom.getElements("ins"),
                e = Wikimapia.Utils.Dom.getElements("del"),
                i, a, o;
            Wikimapia.Utils.Dom.setStyle(t, {
                "background-color": "inherit",
                color: "#333333"
            });
            Wikimapia.Utils.Dom.setStyle(e, "display", "none")
        },
        showByFieldsNormally: function () {
            var t = Wikimapia.Utils.Dom.getElements("ins"),
                e = Wikimapia.Utils.Dom.getElements("del"),
                i, a;
            Wikimapia.Utils.Dom.setStyles(t, {
                "background-color": "#DFF0D8",
                "border-color": "#468847",
                color: "#468847"
            });
            Wikimapia.Utils.Dom.setStyle(e, "display", "inline")
        },
        realconfirm: function (t, e) {
            if (typeof e === "function") {
                if (confirm(t || Wikimapia.Lang.get("all.ask-sure"))) {
                    e(true)
                }
                return null
            } else {
                return confirm(t || Wikimapia.Lang.get("all.ask-sure"))
            }
        },
        promptDialog: function (t, e, i) {
            var a = prompt(t, e || "");
            if (a) {
                i(a)
            }
        },
        stats_fstat: 0,
        stats_period: 0,
        stats_year: 0,
        stats_month: 0,
        update_stats: function () {
            var t = compat.getMap();
            t && t.showStats()
        }
    });
    var previousJevals = global.jevals = "",
        flowCount = 0;
    window.commandFlow = setInterval(function () {
        var t = null,
            e = null;
        if (global.jevals !== previousJevals) {
            t = "commandReceived";
            e = global.jevals.toString();
            previousJevals = global.jevals = ""
        }
        if (!t && flowCount % 8 == 0) {
            t = "updatePlaceCount"
        }
        if (flowCount === 240) {
            flowCount = 0
        }
        if (t) {
            Wikimapia.Utils.Dom.fireEvent(window, t, e)
        }
        flowCount++
    }, 500)
}(window);
//# sourceMappingURL=/js/application.js.map
